<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>crossoverJie&#39;s Blog</title>
  
  <subtitle>baller</subtitle>
  <link href="http://crossoverjie.top/atom.xml" rel="self"/>
  
  <link href="http://crossoverjie.top/"/>
  <updated>2024-07-01T01:29:40.460Z</updated>
  <id>http://crossoverjie.top/</id>
  
  <author>
    <name>crossoverJie</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å¦‚ä½•æ‰¾åˆ°å¹¶å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®</title>
    <link href="http://crossoverjie.top/2024/07/01/ob/how-to-involve-OpenSource/"/>
    <id>http://crossoverjie.top/2024/07/01/ob/how-to-involve-OpenSource/</id>
    <published>2024-07-01T02:55:00.000Z</published>
    <updated>2024-07-01T01:29:40.460Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥å‰æœ‰å†™è¿‡ä¸¤ç¯‡æ–‡ç« æ¥ç®€å•èŠè¿‡å¦‚ä½•åšå¼€æºçš„äº‹æƒ…ï¼Œæœ€è¿‘æˆ‘è‡ªå·±ç»„äº†ä¸€ä¸ªç¤¾åŒºé‡Œé¢ä¹Ÿæœ‰ä¸å°‘æœ‹å‹å¯¹å¼€æºæ„Ÿå…´è¶£ï¼Œäºæ˜¯æˆ‘ä¾¿æ ¹æ®è‡ªå·±çš„ç»éªŒç³»ç»Ÿçš„æ¢³ç†äº†ä¸€äº›å…³äºå¼€æºçš„äº‹æƒ…ã€‚</p><ul><li><a href="https://crossoverjie.top/2023/08/05/ob/novice-contribute-open-source/">æ–°æ‰‹å¦‚ä½•å¿«é€Ÿå‚ä¸å¼€æºé¡¹ç›®</a></li><li><a href="https://crossoverjie.top/2024/01/25/ob/create-a-plugin-for-cprobe/">æ‰‹æŠŠæ‰‹æ•™ä½ ä¸ºå¼€æºé¡¹ç›®è´¡çŒ®ä»£ç </a></li></ul><blockquote><p>æœ‰å…´è¶£çš„å¯ä»¥å…ˆçœ‹çœ‹ä¹‹å‰è¿™ä¸¤ç¯‡ã€‚</p></blockquote><span id="more"></span><h1 id="ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®"><a href="#ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®" class="headerlink" title="ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®"></a>ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®</h1><p>é¦–å…ˆç¬¬ä¸€æ­¥å…ˆæƒ³æ¸…æ¥šè‡ªå·±æå¼€æºçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼š</p><ul><li>å‚è€ƒç¤¾åŒºå¤§ä½¬çš„ä»£ç ï¼Œæå‡æŠ€æœ¯</li><li>ä¸°å¯Œä¸ªäººå±¥å†ï¼Œæé«˜é¢è¯•é€šè¿‡ç‡<ul><li>æ›´åŠŸåˆ©ä¸€ç‚¹å°±æ˜¯æƒ³æˆä¸ºæŸä¸ªé¡¹ç›®çš„ <code>Committer</code>&#x2F;<code>PMC</code></li></ul></li><li>å•çº¯å–œæ¬¢åˆ†äº«ï¼Œçƒ­çˆ±å¼€æºï¼Œè®¤å¯å¼€æºæ”¹å˜ä¸–ç•ŒğŸ’ªã€‚</li></ul><p>æˆ‘äººä¸ºå‰é¢ä¸‰ç§éƒ½æ˜¯ä¸€ä¸ªç›®çš„ï¼Œæå‡è‡ªå·±è·å¾—åç»­çš„å¥½å¤„ï¼›æœ€åä¸€ç§åˆ™æ˜¯å¦¥å¦¥çš„çº¯çƒ­çˆ±ã€‚</p><p>ä»¥æˆ‘ä¸ªäººæ¥è¯´ï¼Œæˆ‘ä¸¤è€…éƒ½æ²¾ä¸€ç‚¹ï¼›æˆ‘ç›¸ä¿¡å¤§éƒ¨åˆ†äººéƒ½æ˜¯å‰é¢ä¸‰ç±»çš„ç›®çš„ï¼Œåˆ°è¿™é‡Œæˆ‘å¯èƒ½è¦å…ˆæµ‡ç‚¹å†·æ°´ã€‚</p><blockquote><p>å¾€å¾€ä¸€ä¸ªå¼€æºé¡¹ç›®ä»ä½ ç†Ÿæ‚‰å®ƒå¼€å§‹åˆ°æç¬¬ä¸€ä¸ª PR ç„¶ååˆ°åˆå¹¶ä¸­é—´ç»å†çš„æ—¶é—´å¯èƒ½æ˜¯å¤§å¤§è¶…å‡ºä½ çš„é¢„æœŸçš„ã€‚</p></blockquote><p>ç‰¹åˆ«æ˜¯è¶Šå¤§å‹è¶Šä¸“ä¸šçš„é¡¹ç›®ï¼ˆæˆ‘ç›¸ä¿¡ä½ ä¹Ÿæ˜¯æƒ³åŠ å…¥è¿™ç±»æœ‰ä¸€å®šçŸ¥ååº¦çš„é¡¹ç›®ï¼‰ã€‚</p><p>å› ä¸ºå¼€æºç¤¾åŒºå¤§éƒ¨åˆ†éƒ½æ˜¯æ‰§è¡Œå¼‚æ­¥æ²Ÿé€šï¼Œä¸å³æ—¶é€šè®¯çš„å¿«é€Ÿåé¦ˆä¸åŒï¼Œç”šè‡³è¿˜æœ‰ä¸å°‘ reviewer å¤„äºä¸åŒçš„æ—¶åŒºã€‚</p><p>æ‰€ä»¥ä¸€å¼€å§‹å°±æƒ³åšå¥½å¿ƒç†é¢„æœŸï¼Œä¸è¦æŒ‡æœ›ç€æˆ‘ç»™æŸä¸ªé¡¹ç›®æäº¤ä¸€ä¸ªå¾ˆç‰›é€¼çš„åŠŸèƒ½ï¼Œç„¶åä»–ä»¬å¿«é€Ÿ review åˆå¹¶ï¼Œç„¶åç»™ä½  commit æƒé™ã€‚</p><p>è€Œä¸”æœ‰ä¸å°‘å¼€æºé¡¹ç›®æ˜¯ç”±æŸä¸€ä¸ªå…¬å¸ä¸»å¯¼çš„ï¼Œæ¯”å¦‚ï¼ˆPulsarã€Golangã€Kafkaï¼‰ï¼Œä»–ä»¬å¯èƒ½å¯¹äºå¤–éƒ¨ç¤¾åŒºæ¥çš„æ–°æ‰‹å¹¶ä¸é‚£ä¹ˆä¸Šå¿ƒï¼Œä¸€ä¸ª PR æ™¾åœ¨é‚£é‡Œå‡ ä¸ªæœˆæ²¡äººç†éƒ½æ˜¯å¾ˆæ­£å¸¸çš„ã€‚</p><p>æ‰€ä»¥æˆ‘å»ºè®®ä¸€å¼€å§‹é€‰æ‹©çš„é¡¹ç›®æœ‰ä»¥ä¸‹å‡ ä¸ªç­›é€‰æ ‡å‡†ï¼š</p><ul><li>å°½é‡æ˜¯è‡ªå·±æ—¥å¸¸åœ¨ç”¨ï¼Œç†Ÿæ‚‰çš„é¡¹ç›®ã€‚</li><li>æœ€è¿‘æœ‰åœ¨åŠæ—¶æ›´æ–°ç»´æŠ¤çš„é¡¹ç›®ã€‚</li><li>å¯¹ç¤¾åŒºæ–°äººçš„æ¥çº³ç¨‹åº¦æ˜¯å¦è¶³å¤ŸåŒ…å®¹ã€‚<ul><li>è¿™ç‚¹å¯ä»¥åœ¨ Github é‡ŒæŸ¥æ‰¾æ ‡ç­¾ä¸º <code>help want/contribution welcome</code> çš„ issue æˆ–è€…æ˜¯ PRã€‚</li><li>æŸ¥çœ‹è¿™äº› issue&#x2F; PR æœ€è¿‘çš„æ´»è·ƒæ—¶é—´ï¼Œè´¡çŒ®è€…æ˜¯å¦ä¸ºæ–°äººã€‚</li><li>å¾€å¾€ä¸€ä¸ªåŒ…å®¹åº¦è¾ƒé«˜çš„é¡¹ç›®ä»¥ä¸Šä¿¡æ¯éƒ½æ˜¯å¾ˆæ´»è·ƒçš„ã€‚</li></ul></li><li>é¡¹ç›®ä¸»è¦ç»´æŠ¤è€…æ˜¯å¦æ¥ç€ä¸åŒçš„å…¬å¸ï¼Œæ˜¯å¦è¶³å¤Ÿæ´»è·ƒã€‚</li></ul><p><img src="https://s2.loli.net/2024/05/25/PIL8a5CoMbxRiwJ.png"><br><img src="https://s2.loli.net/2024/05/25/7CQaVFiAR4tyMbs.png"></p><p>æ¨èå‡ ä¸ªæˆ‘è®¤ä¸ºæ¯”è¾ƒç¬¦åˆæˆ‘åˆšæ‰æåˆ°çš„æ¡ä»¶çš„é¡¹ç›®ï¼š</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/7195">https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/7195</a></li><li><a href="https://github.com/apache/pulsar-client-go/issues?q=is:open+label:type/feature+sort:updated-desc">https://github.com/apache/pulsar-client-go/issues?q=is%3Aopen+label%3Atype%2Ffeature+sort%3Aupdated-desc</a></li><li><a href="https://github.com/apache/hertzbeat/">https://github.com/apache/hertzbeat/</a></li></ul><h1 id="ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®"><a href="#ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®" class="headerlink" title="ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®"></a>ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®</h1><p>å¦‚æœæ‰¾åˆ°äº†è‡ªå·±æƒ³è´¡çŒ®çš„é¡¹ç›®ï¼Œå¦‚æœè‡ªå·±è¿˜ä¸å¤ªç†Ÿæ‚‰çš„è¯ï¼Œé‚£å°±å¯ä»¥å°è¯•ä»¥ä¸‹æ­¥éª¤æ¥å¿«é€Ÿä¸Šæ‰‹å®ƒã€‚</p><h2 id="âœ…å•å…ƒæµ‹è¯•"><a href="#âœ…å•å…ƒæµ‹è¯•" class="headerlink" title="âœ…å•å…ƒæµ‹è¯•"></a>âœ…å•å…ƒæµ‹è¯•</h2><p>é¦–å…ˆç¬¬ä¸€ä¸ªå°±æ˜¯å•å…ƒæµ‹è¯•ï¼Œå•å…ƒæµ‹è¯•æ˜¯ä¸€ä¸ªéå¸¸ä¸é”™çš„æ–¹å¼æ¥ä¸Šæ‰‹ä¸€ä¸ªæ–°çš„å¼€æºé¡¹ç›®ï¼Œ<strong>ä½†é‡ç‚¹ä¸æ˜¯å»çœ‹ç°æœ‰çš„å•æµ‹ï¼Œè€Œæ˜¯è‡ªå·±å»å†™âœï¸</strong>ã€‚</p><p>å†™è¿‡å•å…ƒæµ‹è¯•çš„å°ä¼™ä¼´å°±çŸ¥é“ï¼Œå¦‚æœè¦è¾¾åˆ° 90% ä»¥ä¸Šçš„è¦†ç›–ç‡æ—¶éœ€è¦å¯¹è‡ªå·±å†™çš„æ¯ä¸€è¡Œä»£ç éƒ½å¾—äº†è§£ï¼Œç”šè‡³åœ¨å†™çš„è¿‡ç¨‹ä¸­ä¼šå‘ç°éƒ¨åˆ†ä»£ç æ˜¯ä¸æ˜¯æ²¡æœ‰å¿…è¦ï¼Œä»è€Œå†å¸®åŠ©è‡ªå·±æ¢³ç†ä¸€éä¸šåŠ¡ã€‚</p><p>æ‰€ä»¥å†™å•æµ‹ç¡®å®æ˜¯å¿«é€Ÿç†Ÿæ‚‰æŸä¸ªé¡¹ç›®çš„æ–¹æ³•ï¼Œä½†è¿™é’ˆå¯¹äºä¸€äº›é€»è¾‘ç®€å•çš„é¡¹ç›®ï¼›å¯¹äºä¸€äº›ä¸šåŠ¡å¤æ‚çš„é¡¹ç›®å»ºè®®è¿˜æ˜¯å¿«é€Ÿè·‘é€šå®˜æ–¹æ¨èä¸€ä¸ªåŠŸèƒ½ã€‚</p><h2 id="ğŸŒŸä»¥-Pulsar-ä¸ºä¾‹"><a href="#ğŸŒŸä»¥-Pulsar-ä¸ºä¾‹" class="headerlink" title="ğŸŒŸä»¥ Pulsar ä¸ºä¾‹"></a>ğŸŒŸä»¥ Pulsar ä¸ºä¾‹</h2><p>ä»¥ <a href="https://pulsar.apache.org/">Apache Pulsar</a>ä¸ºä¾‹ï¼Œé‚£å°±å…ˆè·‘ä¸€ä¸ªæ¶ˆæ¯çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€… demoï¼›è·‘é€šäº†ä¹‹åå†å°è¯•çœ‹çœ‹å®ƒå®¢æˆ·ç«¯å·²æœ‰çš„å•æµ‹ä»£ç ï¼Œç„¶åå°è¯•æ”¹ä¸€äº›æ–­è¨€ï¼Œæ­¤æ—¶å°±ä¼šå‘ç°é¢„æœŸå€¼ä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆå®šä¹‰ã€‚<br><a href="https://github.com/apache/pulsar/blob/631b13ad23d7e48c6e82d38f97c23d129062cb7c/pulsar-broker/src/test/java/org/apache/pulsar/client/impl/BrokerClientIntegrationTest.java#L1077">https://github.com/apache/pulsar/blob/631b13ad23d7e48c6e82d38f97c23d129062cb7c/pulsar-broker/src/test/java/org/apache/pulsar/client/impl/BrokerClientIntegrationTest.java#L1077</a><br><img src="https://s2.loli.net/2024/05/17/CrITHSWeY1sP8dL.png"></p><p><img src="https://s2.loli.net/2024/05/17/J6DmLxQMZvuAqW7.png"></p><p>æ¯”å¦‚è¿™é‡Œçš„ä¸€ä¸ª consumer å–æ¶ˆè®¢é˜…ä¸¤æ¬¡æ—¶å€™å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å¼‚å¸¸çš„åœ°æ–¹æ‰¾åˆ°æºç é‡Œå¯¹è¿æ¥çŠ¶æ€çš„åˆ¤æ–­æ¡ä»¶ã€‚</p><p>å°±å¯ä»¥å¾—çŸ¥ï¼šå½“å®¢æˆ·ç«¯å–æ¶ˆè®¢é˜…æ—¶ä¼šä¿®æ”¹è¿æ¥çŠ¶æ€ã€‚</p><h2 id="ğŸ’“HertzBeat"><a href="#ğŸ’“HertzBeat" class="headerlink" title="ğŸ’“HertzBeat"></a>ğŸ’“HertzBeat</h2><p>ä¸‹é¢ä»¥ <a href="https://hertzbeat.apache.org/">Apache HertzBeat</a>ä¸ºä¾‹æ¥çœ‹çœ‹å½“æ—¶æˆ‘æ˜¯å¦‚ä½•è´¡çŒ®å•å…ƒæµ‹è¯•çš„ã€‚</p><p><img src="https://s2.loli.net/2024/05/17/dixDGIQO2sZfh98.png"><br>é€šè¿‡å®˜æ–¹çš„æ¶æ„å›¾å¯ä»¥å¾—çŸ¥ HertzBeat æ˜¯é€šè¿‡ä¸€ä¸ª collector å»ç›´è¿ç›®æ ‡é‡‡é›†æ•°æ®çš„ã€‚</p><p>æ¯”å¦‚é€šè¿‡ Redis çš„å®¢æˆ·ç«¯å»è·å–ç›‘æ§æ•°æ®ï¼Œç„¶åå†å­˜æ”¾åˆ°è‡ªå·±çš„æ—¶åºæ•°æ®åº“ä¸­è¿›è¡Œå±•ç¤ºã€‚</p><p>æ‰€ä»¥è¿™ä¸ªé‡‡é›†çš„è¿‡ç¨‹å°±æ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä»–çš„æ¥å£å®šä¹‰ã€‚</p><p><img src="https://s2.loli.net/2024/05/17/3quVop5vSr6KzPY.png"><br>ä¸€å…±å°±ä¸‰ä¸ªæ¥å£ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>collecté‡‡é›†æ¥å£ï¼šåœ¨ Metrics ä¸­å®šä¹‰äº†é‡‡é›†çš„ç›®æ ‡ä¿¡æ¯ï¼ˆåœ°å€ã€ç«¯å£ç­‰ï¼‰<ul><li>é‡‡é›†å®Œåçš„æ•°æ®å†™å…¥åˆ° Builder ä¾›åç»­çš„å†™å…¥å­˜å‚¨</li></ul></li><li>preCheckï¼šæå‰åšä¸€äº›å‚æ•°æ ¡éªŒ</li><li>supportProtocolï¼šè¿”å›å®šä¹‰çš„åè®®ç±»å‹ï¼Œé€šè¿‡è¿™ä¸ªç±»å‹æ‰¾åˆ°å¯¹åº”é‡‡é›†å™¨</li></ul><p><img src="https://s2.loli.net/2024/05/17/hQZaFV2qo3176uf.png"></p><p>ç„¶åå°±äº¤ç”±ä¸åŒçš„å®ç°ç±»å»é‡‡é›†ä¸åŒçš„æŒ‡æ ‡ã€‚</p><p>è¿™é‡Œæˆ‘ä»¥ <code>RedisCommonCollectImpl</code>ä¸ºä¾‹ï¼Œä¸»è¦çš„å•æµ‹é€»è¾‘å°±æ˜¯æ¨¡æ‹Ÿ Redis å®¢æˆ·ç«¯çš„è¿”å›æ•°æ®ï¼Œç„¶ååœ¨ Collect çš„ä»£ç é‡ŒæŸ¥çœ‹ä¸åŒçš„å¤„ç†é€»è¾‘ï¼Œå…¶å®å°±æ˜¯è¦è¦†ç›–å„ç§åˆ†æ”¯ä»¥åŠå¼‚å¸¸çš„æƒ…å†µã€‚</p><p>æœ€åå†æ–­è¨€é‡‡é›†åˆ°çš„æ•°æ®ä¸é¢„æœŸæ˜¯å¦åŒ¹é…å³å¯ï¼Œè´´ä¸€æ®µæ ¸å¿ƒé€»è¾‘ï¼š<br><img src="https://s2.loli.net/2024/05/17/EnrZxdDR5kLtMIG.png"></p><p>è‡³äºåº”è¯¥è¿”å›ä»€ä¹ˆé¢„æœŸç»“æœï¼Œæœ‰äº› collector å¯èƒ½ä¼šåœ¨ä»£ç æ³¨é‡Šé‡Œå†™æ¸…æ¥šï¼Œä½†è¿™ä¸ª Redis æ²¡æœ‰å†™ã€‚</p><p>ä¸è¿‡ä¹Ÿæœ‰åŠæ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»£ç åœ¨æœ¬åœ°è·‘èµ·æ¥ä¹‹åè¿›å…¥ç®¡ç†å°æŸ¥çœ‹å†…ç½®çš„ç›‘æ§æ¨¡ç‰ˆã€‚</p><p><img src="https://s2.loli.net/2024/05/17/g4EL7AdGfbrpXKU.png"><br>è¿™é‡Œæ˜¯ç”¨äºå®šä¹‰ä¼šç›‘æ§å“ªäº›å­—æ®µçš„åœ°æ–¹ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä»£ç é¢„å…ˆç”Ÿæˆå¥½é¢„æœŸè¿”å›å€¼äº†ã€‚</p><p><img src="https://s2.loli.net/2024/05/17/OCEYUZHscP6waI3.png"></p><p>å…·ä½“çš„å•æµ‹ä»£ç è¯·çœ‹è¿™é‡Œï¼š<br><a href="https://github.com/apache/hertzbeat/blob/master/collector/src/test/java/org/apache/hertzbeat/collector/collect/redis/RedisClusterCollectImplTest.java#L46">https://github.com/apache/hertzbeat/blob/master/collector/src/test/java/org/apache/hertzbeat/collector/collect/redis/RedisClusterCollectImplTest.java#L46</a></p><h1 id="ğŸ“æ€»ç»“"><a href="#ğŸ“æ€»ç»“" class="headerlink" title="ğŸ“æ€»ç»“"></a>ğŸ“æ€»ç»“</h1><p>å‚ä¸ä¸€ä¸ªæˆç†Ÿç¤¾åŒºçš„å¼€æºæœ‰ä¸€ç‚¹ä¸€å®šè¦è®°ä½ï¼Œ<strong>å°±æ˜¯è¦ä»”ç»†é˜…è¯»<a href="https://hertzbeat.apache.org/zh-cn/docs/community/contribution">è´¡çŒ®è€…æ–‡æ¡£</a>ã€‚</strong></p><p>é‡Œé¢å¾€å¾€ä¼šå†™æ¸…æ¥šå¦‚ä½•æ„å»ºä»£ç ã€ä»£ç è§„èŒƒã€æäº¤è§„èŒƒç­‰ä¿¡æ¯ï¼Œè¿™äº›éƒ½æ‹æ¸…æ¥šåæäº¤çš„ PR æ‰æ›´å®¹æ˜“è¢«ç¤¾åŒºæ¥å—ã€‚</p><p>åé¢ä¼šç»§ç»­æ›´æ–°é›†æˆæµ‹è¯•ä¸ <code>e2e</code> æµ‹è¯•ç­‰å†…å®¹ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»¥å‰æœ‰å†™è¿‡ä¸¤ç¯‡æ–‡ç« æ¥ç®€å•èŠè¿‡å¦‚ä½•åšå¼€æºçš„äº‹æƒ…ï¼Œæœ€è¿‘æˆ‘è‡ªå·±ç»„äº†ä¸€ä¸ªç¤¾åŒºé‡Œé¢ä¹Ÿæœ‰ä¸å°‘æœ‹å‹å¯¹å¼€æºæ„Ÿå…´è¶£ï¼Œäºæ˜¯æˆ‘ä¾¿æ ¹æ®è‡ªå·±çš„ç»éªŒç³»ç»Ÿçš„æ¢³ç†äº†ä¸€äº›å…³äºå¼€æºçš„äº‹æƒ…ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://crossoverjie.top/2023/08/05/ob/novice-contribute-open-source/&quot;&gt;æ–°æ‰‹å¦‚ä½•å¿«é€Ÿå‚ä¸å¼€æºé¡¹ç›®&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://crossoverjie.top/2024/01/25/ob/create-a-plugin-for-cprobe/&quot;&gt;æ‰‹æŠŠæ‰‹æ•™ä½ ä¸ºå¼€æºé¡¹ç›®è´¡çŒ®ä»£ç &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ‰å…´è¶£çš„å¯ä»¥å…ˆçœ‹çœ‹ä¹‹å‰è¿™ä¸¤ç¯‡ã€‚&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
  </entry>
  
  <entry>
    <title>OpenTelemetry æ·±åº¦å®šåˆ¶ï¼šè·¨æœåŠ¡è¿½è¸ªçš„å®æˆ˜æŠ€å·§</title>
    <link href="http://crossoverjie.top/2024/06/26/ob/OpenTelemetry-custom-instrument/"/>
    <id>http://crossoverjie.top/2024/06/26/ob/OpenTelemetry-custom-instrument/</id>
    <published>2024-06-26T11:58:03.000Z</published>
    <updated>2024-06-26T10:39:04.807Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p><img src="https://s2.loli.net/2024/05/19/7CnOFegSu4TLbhd.png"></p><p>åœ¨ä¸Šä¸€ç¯‡<a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">ã€Šä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…ã€‹</a>ä¸­åœ¨æœ€åæåˆ°åœ¨åšä¸€äº› Trace çš„å®šåˆ¶å¼€å‘ã€‚</p><p>åˆ°ç°åœ¨å·®ä¸å¤šç®—æ˜¯å®Œæˆäº†ï¼Œå¯ä»¥å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚</p><p>æˆ‘ä»¬çš„éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://s2.loli.net/2024/05/19/qex6IFcOnQ591gT.png"><br>å‡è®¾ç°åœ¨æœ‰ä¸‰ä¸ªæœåŠ¡ï¼šServiceAã€ServiceBã€ServiceC</p><p><code>ServiceA</code> å¯¹å¤–æä¾›äº†ä¸€ä¸ª http æ¥å£ <code>request</code>ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¼šè°ƒç”¨ <code>ServiceB</code> çš„ <code>order</code> è®¢å•æ¥å£åˆ›å»ºè®¢å•ï¼ŒåŒæ—¶ <code>serviceB</code> è°ƒç”¨ <code>serviceC</code> çš„ pay æ¥å£ã€‚</p><p><img src="https://s2.loli.net/2024/05/19/GtljX3BLVcePWFn.png"><br>æ•´ä¸ªè°ƒç”¨å…³ç³»å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ span ä¸­çš„ attribute ä¼šè®°å½•å½“å‰ span çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š<br><img src="https://s2.loli.net/2024/05/19/tvgdT1Mke7OjPGp.png"><br>è¿™äº›éƒ½æ˜¯å½“å‰ä¸€äº›å½“å‰ span å†…ç½®çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å½“å‰ gRPC æ¥å£çš„ä¸€äº›åŸºæœ¬æ•°æ®ï¼šæœåŠ¡åã€ipã€ç«¯å£ç­‰ä¿¡æ¯ã€‚</p><p>ä½†è¿™é‡Œå¹¶æ²¡æœ‰ä¸Šæ¸¸çš„ä¸€äº›ä¿¡æ¯ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ Jaeger çš„æ ‘çŠ¶å›¾å¾—çŸ¥ä¸Šæ¸¸æ˜¯å“ªä¸ªåº”ç”¨è°ƒç”¨è¿‡æ¥çš„ï¼Œä½†æ˜¯ä¸€æ—¦æŸä¸ª span ä¸‹æœ‰å¤šä¸ªå­ span çš„è°ƒç”¨ï¼Œå°±æ²¡åŠæ³•å¾ˆç›´è§‚çŸ¥é“è¿™ä¸ªå­ span çš„ä¸Šæ¸¸æ˜¯ç”±è°å‘èµ·çš„è°ƒç”¨ã€‚</p><p>æ¯”å¦‚å¦‚ä¸‹è¿™ä¸ªé“¾è·¯ï¼š<br><img src="https://s2.loli.net/2024/05/19/3rOdKfBmhSjz1GF.png"><br>å½“ä¸€ä¸ªè°ƒç”¨é“¾éå¸¸é•¿ï¼ŒåŒæ—¶ä¹Ÿéå¸¸å¤æ‚æ—¶ï¼Œæ²¡åŠæ³•ç¬¬ä¸€æ—¶é—´çŸ¥é“æŸä¸€ä¸ª span çš„ä¸Šæ¸¸åˆ°åº•æ˜¯è°å‘èµ·çš„ï¼Œéœ€è¦æ‰‹åŠ¨ä¸€å±‚å±‚çš„å»æŠ˜å ï¼Œæˆ–è€…å…¨é çœ¼ç›å»æ‰¾ã€‚</p><h2 id="é¢„æœŸæ•ˆæœ"><a href="#é¢„æœŸæ•ˆæœ" class="headerlink" title="é¢„æœŸæ•ˆæœ"></a>é¢„æœŸæ•ˆæœ</h2><p><img src="https://s2.loli.net/2024/05/19/9v3cGMrez8XA2ZH.png"></p><p>ä¸ºæ­¤æˆ‘ä»¬å¸Œæœ›çš„æ•ˆæœæ˜¯å¯ä»¥é€šè¿‡ç»™æ¯ä¸€ä¸ªå­ span ä¸­åŠ å…¥ä¸¤ä¸ª attributeï¼Œæ¥æ ‡æ˜å®ƒçš„çˆ¶è°ƒç”¨æ¥æºã€‚</p><p>æ¯”å¦‚åœ¨ serviceB ä¸­çš„æ‰€æœ‰ span ä¸­éƒ½ä¼šåŠ ä¸Šä¸¤ä¸ªæ ‡ç­¾ï¼šæ¥æºæ˜¯ serviceAï¼ŒåŒæ—¶æ˜¯ serviceA çš„ request æ¥å£å‘èµ·çš„è¯·æ±‚ã€‚</p><p>è€Œåœ¨ serviceC ä¸­åŒæ ·å¯ä»¥çŸ¥é“æ¥æºæ˜¯ serviceB çš„ Order æ¥å£å‘èµ·çš„è°ƒç”¨ã€‚</p><p>æˆ‘å¯åŠ¨äº†ä¸‰ä¸ª demo åº”ç”¨ï¼Œåˆ†åˆ«æ˜¯ create1ï¼Œcreate2ï¼Œcreate3.</p><p>create1 ä¸­ä¼šæä¾›ä¸€ä¸ª <code>request</code> æ¥å£ï¼Œåœ¨è¿™é‡Œé¢è°ƒç”¨ create2 çš„ <code>create2</code> æ¥å£ï¼Œ<code>create2</code> çš„æ¥å£é‡Œæ¥ç€è°ƒç”¨ create3 çš„ <code>create3</code> æ¥å£ã€‚</p><p>create1ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line">   <span class="type">HelloRequest</span> <span class="variable">request</span> <span class="operator">=</span> HelloRequest.newBuilder()  </span><br><span class="line">         .setName(name)  </span><br><span class="line">         .build();  </span><br><span class="line">   log.info(<span class="string">&quot;request: &#123;&#125;&quot;</span>, request);  </span><br><span class="line">   <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> myServiceStub.create2(request).getMessage();  </span><br><span class="line">   Executors.newFixedThreadPool(<span class="number">1</span>).execute(() -&gt; &#123;  </span><br><span class="line">      myServiceStub.create2(request).getMessage();  </span><br><span class="line">   &#125;);       <span class="keyword">return</span> message;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>create2:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create2</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> &#123;  </span><br><span class="line">    <span class="type">HelloReply</span> <span class="variable">reply</span> <span class="operator">=</span> HelloReply.newBuilder()  </span><br><span class="line">            .setMessage(<span class="string">&quot;Create2 ==&gt; &quot;</span> + request.getName())  </span><br><span class="line">            .build();  </span><br><span class="line">    log.info(<span class="string">&quot;Create2: &#123;&#125;&quot;</span>, reply.getMessage());  </span><br><span class="line">    myMethod(request.getName());  </span><br><span class="line">    myServiceStub.create3(request);</span><br><span class="line">    responseObserver.onNext(reply);  </span><br><span class="line">    responseObserver.onCompleted();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>create3:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create3</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> &#123;  </span><br><span class="line">    <span class="type">HelloReply</span> <span class="variable">reply</span> <span class="operator">=</span> HelloReply.newBuilder()  </span><br><span class="line">            .setMessage(<span class="string">&quot;Create3 ==&gt; &quot;</span> + request.getName())  </span><br><span class="line">            .build();  </span><br><span class="line">    log.info(<span class="string">&quot;Create3: &#123;&#125;&quot;</span>, reply.getMessage());  </span><br><span class="line">    myMethod(request.getName());  </span><br><span class="line">    responseObserver.onNext(reply);  </span><br><span class="line">    responseObserver.onCompleted();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.javaagent.extensions=otel-extensions-custom-context-1.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.traces.exporter=otlp \</span><br><span class="line">-Dotel.logs.exporter=none \</span><br><span class="line">-Dotel.service.name=create2 \</span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \</span><br><span class="line">-Dotel.propagators=tracecontext,baggage,demo \</span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar --spring.application.name=create2 --server.port=9191 --grpc.server.port=9292 --grpc.client.myService.address=static://127.0.0.1:9393</span><br></pre></td></tr></table></figure><p>åªæ˜¯æ¯ä¸ªåº”ç”¨éƒ½éœ€è¦ä½¿ç”¨æˆ‘è¿™è¾¹å•ç‹¬æ‰“çš„ agent åŒ…ä»¥åŠä¸€ä¸ª <code>extension</code>(tel-extensions-custom-context-1.0-SNAPSHOT.jar) æ‰èƒ½ç”Ÿæ•ˆã€‚</p><p>æœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/05/19/4o5mEhjnMbZWL62.png"></p><h1 id="Baggage"><a href="#Baggage" class="headerlink" title="Baggage"></a>Baggage</h1><p>åœ¨è®²å…·ä½“çš„å®ç°ä¹‹å‰éœ€è¦å…ˆäº†è§£å‡ ä¸ª Trace ä¸­çš„æ¦‚å¿µï¼Œåœ¨è¿™é‡Œä¸»è¦ç”¨åˆ°çš„æ˜¯ä¸€ä¸ªç§°ä¸º Baggage çš„å¯¹è±¡ã€‚</p><p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å…¶å®æåˆ°è¿‡å®ƒçš„åŸç†ä»¥åŠä½¿ç”¨åœºæ™¯ï¼š<br><a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/?highlight=%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E6%97%85#Baggage">ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</a></p><p><img src="https://s2.loli.net/2024/05/19/gv2YEoO6LkiGIF9.png"></p><p>Baggage çš„ä¸­æ–‡ç¿»è¯‘æ˜¯ï¼šåŒ…è£¹ğŸ“¦ï¼›ç®€å•æ¥è¯´å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ baggage å¯ä»¥å°†æˆ‘ä»¬æƒ³è¦çš„æ•°æ®å­˜æ”¾åœ¨å…¶ä¸­ï¼Œè¿™æ ·å†æ•´ä¸ª Trace çš„ä»»æ„ä¸€ä¸ª Span ä¸­éƒ½å¯ä»¥è¯»å–åˆ°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line"><span class="comment">// å†™å…¥</span></span><br><span class="line">    Baggage.current().toBuilder().  </span><br><span class="line">          put(<span class="string">&quot;request.name&quot;</span>, name).build()  </span><br><span class="line">          .storeInContext(Context.current()).makeCurrent();</span><br><span class="line">&#125;         </span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–</span></span><br><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> Baggage.current().getEntryValue(<span class="string">&quot;request.name&quot;</span>);  </span><br><span class="line">log.info(<span class="string">&quot;request.name: &#123;&#125;&quot;</span>, value);</span><br></pre></td></tr></table></figure><p>ç†è§£äº†è¿™ä¸ªä¹‹åï¼Œæˆ‘ä»¬è¦å®ç°çš„å°†ä¸Šæ¸¸çš„ä¿¡æ¯ä¼ é€’åˆ°ä¸‹æ¸¸å°±å¯ä»¥é€šè¿‡è¿™ä¸ªç»„ä»¶å®ç°äº†ã€‚</p><p>åªéœ€è¦åœ¨ä¸Šæ¸¸åˆ›å»º span æ—¶å°†å®ƒè‡ªèº«æ•°æ®å†™å…¥åˆ° Baggage ä¸­ï¼Œå†åˆ°ä¸‹æ¸¸ span å–å‡ºæ¥å†™å…¥åˆ° attribute ä¸­å³å¯ã€‚</p><h1 id="ContextCustomizer"><a href="#ContextCustomizer" class="headerlink" title="ContextCustomizer"></a>ContextCustomizer</h1><p>è¿™é‡Œçš„å…³é”®å°±æ˜¯åœ¨å“ªé‡Œå†™å…¥è¿™ä¸ª Baggageï¼Œå› ä¸ºå¯¹ç¬¬ä¸‰æ–¹ç»„ä»¶çš„ Instrumentation çš„å®ç°éƒ½æ˜¯åœ¨ <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation">opentelemetry-java-instrumentation</a>é¡¹ç›®ä¸­ã€‚</p><blockquote><p>javaagent.jar åŒ…ä¹Ÿæ˜¯é€šè¿‡è¯¥é¡¹ç›®æ‰“åŒ…å‡ºæ¥çš„ã€‚</p></blockquote><p>æ‰€ä»¥åœ¨è¯¥é¡¹ç›®çš„ <code>io.opentelemetry.instrumentation.api.instrumenter.Instrumenter#doStart</code> è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å‘ç°ä¸€æ®µé€»è¾‘ï¼š</p><p><img src="https://s2.loli.net/2024/05/20/FYiAnq2G3voIyR4.png"></p><hr><blockquote><p>è¿™ä¸ªå‡½æ•°æ˜¯åœ¨åˆ›å»ºä¸€ä¸ª span çš„æ—¶å€™è°ƒç”¨çš„ï¼Œé€šå¸¸è¿™ä¸ªåˆ›å»ºå‡½æ•°æ˜¯åœ¨è¿™äº›ç¬¬ä¸‰æ–¹åº“çš„æ‹¦æˆªå™¨ä¸­åˆ›å»ºçš„ã€‚</p></blockquote><p><img src="https://s2.loli.net/2024/05/20/b3cxYekiUGaSlO9.png"><br>æ¯”å¦‚è¿™æ˜¯åœ¨ grpc çš„æ‹¦æˆªå™¨ä¸­è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context customizers run before span start, so that they can have access to the parent span  </span></span><br><span class="line"><span class="comment">// context, and so that their additions to the context will be visible to span processors  </span></span><br><span class="line"><span class="keyword">for</span> (ContextCustomizer&lt;? <span class="built_in">super</span> REQUEST&gt; contextCustomizer : contextCustomizers) &#123;  </span><br><span class="line">  context = contextCustomizer.onStart(context, request, attributes);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ContextCustomizer</code> æ˜¯ä¸€ä¸ªæ¥å£åªæä¾›äº†ä¸€ä¸ªå‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ContextCustomizer</span>&lt;REQUEST&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** Allows to customize the operation &#123;<span class="doctag">@link</span> Context&#125;. */</span>  </span><br><span class="line">  Context <span class="title function_">onStart</span><span class="params">(Context parentContext, REQUEST request, Attributes startAttributes)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>Context</code> æ˜¯ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯ä»¥åœ¨è‡ªå®šä¹‰çš„ ContextCustomizer ç»§ç»­å¾€ä¸Šä¸‹æ–‡ä¸­è¿½åŠ ä¿¡æ¯ã€‚</li><li><code>REQUEST</code> æ˜¯ä¸€ä¸ªæ³›å‹ï¼šä¸€èˆ¬æ˜¯å½“å‰ç¬¬ä¸‰æ–¹ç»„ä»¶çš„è¯·æ±‚ä¿¡æ¯ï¼š<ul><li>æ¯”å¦‚æ˜¯ <code>HTTP</code> æ—¶ï¼Œè¿™ä¸ª <code>request</code> å°±æ˜¯ HTTP çš„è¯·æ±‚ä¿¡æ¯ã€‚</li><li>è€Œå¦‚æœæ˜¯ <code>gRPC</code> ï¼Œåˆ™æ˜¯ <code>gRPC</code> çš„è¯·æ±‚ä¿¡æ¯ã€‚</li><li>å…¶ä»–çš„è¯·æ±‚ç±»å‹åŒç†ã€‚</li></ul></li><li><code>startAttributes</code> åˆ™æ˜¯é¢„å…ˆå†™å…¥çš„ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚åœ¨ä¸Šå›¾ä¸­çœ‹åˆ°çš„ä¸€äº› <code>rpc.service/rpc.method</code>ç­‰å­—æ®µã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context customizers run before span start, so that they can have access to the parent span  </span></span><br><span class="line"><span class="comment">// context, and so that their additions to the context will be visible to span processors</span></span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸ªæ¥å£çš„è°ƒç”¨æ³¨é‡Šå¯ä»¥çœ‹å‡ºï¼š<br>è¿™ä¸ªè‡ªå®šä¹‰çš„ context ä¼šåœ¨ span å¼€å§‹ä¹‹å‰è°ƒç”¨ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæ˜¯å¯ä»¥è®¿é—®åˆ°å½“å‰åˆ›å»ºçš„ span çš„çˆ¶ contextï¼ŒåŒæ—¶åœ¨è¿™é‡Œçš„ context ä¸­æ–°å¢çš„æ•°æ®å¯ä»¥åœ¨ <code>SpanProcessor</code> è®¿é—®åˆ°ã€‚</p><h1 id="SpanProcessor"><a href="#SpanProcessor" class="headerlink" title="SpanProcessor"></a>SpanProcessor</h1><p>è€Œ SpanProcessor åˆæ˜¯ä¸€ä¸ªéå¸¸çš„é‡è¦çš„ç»„ä»¶ï¼Œæˆ‘ä»¬æ¥ç€åˆšæ‰çš„ <code>contextCustomizer</code> å¤„å¾€åè·Ÿè¸ªä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">context = contextCustomizer.onStart(context, request, attributes);</span><br><span class="line">---&gt;<span class="type">Span</span> <span class="variable">span</span> <span class="operator">=</span> spanBuilder.setParent(context).startSpan();</span><br><span class="line">---&gt;io.opentelemetry.sdk.trace.SdkSpanBuilder#startSpan</span><br><span class="line">---&gt;io.opentelemetry.sdk.trace.SdkSpan#startSpan</span><br><span class="line">---&gt;spanProcessor.onStart(parentContext, span);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>spanProcessor.onStart</code> è¿™ä¸ªå‡½æ•°ä¼šåœ¨ contextCustomizer ä¹‹åè°ƒç”¨ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/vpxHt34TUbgfShz.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * SpanProcessor is the interface &#123;<span class="doctag">@link</span> SdkTracer&#125; uses to allow synchronous hooks for when a  </span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> Span&#125; is started or when a &#123;<span class="doctag">@code</span> Span&#125; is ended.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//==========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Called when a &#123;<span class="doctag">@link</span> io.opentelemetry.api.trace.Span&#125; is started, if the &#123;<span class="doctag">@link</span>  </span></span><br><span class="line"><span class="comment"> * Span#isRecording()&#125; returns true.  </span></span><br><span class="line"><span class="comment"> * * &lt;p&gt;This method is called synchronously on the execution thread, should not throw or block the  </span></span><br><span class="line"><span class="comment"> * execution thread. * * <span class="doctag">@param</span> parentContext the parent &#123;<span class="doctag">@code</span> Context&#125; of the span that just started.  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> span the &#123;<span class="doctag">@code</span> Span&#125; that just started.  </span></span><br><span class="line"><span class="comment"> */</span><span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(Context parentContext, ReadWriteSpan span)</span>;</span><br></pre></td></tr></table></figure><p>ä»æ³¨é‡Šä¸­å¯ä»¥çŸ¥é“ SpanProcessor æ˜¯ä½œä¸ºä¸€ä¸ª span çš„ç”Ÿå‘½å‘¨æœŸä¸­çš„å…³é”®èŠ‚ç‚¹çš„ hook å‡½æ•°ã€‚</p><p>åœ¨è¿™äº›å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€äº› span çš„æ•°æ®ï¼Œæ¯”å¦‚åœ¨ <code>onStart</code> è¿˜å¯ä»¥å¾€ span ä¸­å†™å…¥ä¸€äº›è‡ªå®šä¹‰çš„ attributeã€‚</p><p>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¿™æ¬¡ä¼šç”¨åˆ°çš„ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯ï¼š</p><p>åœ¨ gRPC æ„å»º Instrument æ—¶è‡ªå®šä¹‰ä¸€ä¸ª <code>GrpcServerContextCustomizer</code> ï¼Œåœ¨è¿™ä¸ªè‡ªå®šä¹‰çš„ <code>ContextCustomizer</code> ä¸­å†™å…¥ä¸€ä¸ª <code>Baggage</code>ã€‚</p><p>ç„¶ååœ¨ <code>io.opentelemetry.sdk.trace.SpanProcessor#onStart</code> æ¥å£ä¸­å–å‡ºè¿™ä¸ª <code>Baggage</code> å†™å…¥åˆ°å½“å‰ span çš„ attribute ä¸­ã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ä¹‹å‰æåˆ°çš„é‚£äº›æ•°æ®ä¸Šæ¸¸ä¿¡æ¯äº†ã€‚<br><img src="https://s2.loli.net/2024/05/19/4o5mEhjnMbZWL62.png"></p><h1 id="ä¸º-gRPC-æ·»åŠ ä¸Šä¸‹æ–‡"><a href="#ä¸º-gRPC-æ·»åŠ ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸º gRPC æ·»åŠ ä¸Šä¸‹æ–‡"></a>ä¸º gRPC æ·»åŠ ä¸Šä¸‹æ–‡</h1><p>å…ˆæ¥çœ‹çœ‹å¦‚ä½•ä¸º gRPC æ·»åŠ  <code>Baggage</code>ï¼š</p><p>æˆ‘ä»¬å…ˆè‡ªå®šä¹‰ä¸€ä¸ª <code>GrpcServerContextCustomizer</code> å®ç°ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcServerContextCustomizer</span> <span class="keyword">implements</span> <span class="title class_">ContextCustomizer</span>&lt;GrpcRequest&gt; &#123;  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String currentServiceName;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARENT_RPC_KEY</span> <span class="operator">=</span> <span class="string">&quot;parent_rpc&quot;</span>;  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CURRENT_RPC_KEY</span> <span class="operator">=</span> <span class="string">&quot;current_rpc&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CURRENT_HTTP_URL_PATH</span> <span class="operator">=</span> <span class="string">&quot;current_http_url_path&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">GrpcServerContextCustomizer</span><span class="params">(String serviceName)</span> &#123;  </span><br><span class="line">    <span class="built_in">this</span>.currentServiceName = serviceName;  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> Context <span class="title function_">onStart</span><span class="params">(Context parentContext, GrpcRequest grpcRequest,  </span></span><br><span class="line"><span class="params">      Attributes startAttributeds)</span> &#123;  </span><br><span class="line">    <span class="type">BaggageBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Baggage.fromContext(parentContext).toBuilder();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">currentRpc</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(CURRENT_RPC_KEY);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">fullMethodName</span> <span class="operator">=</span> startAttributeds.get(AttributeKey.stringKey(<span class="string">&quot;rpc.method&quot;</span>));  </span><br><span class="line">    <span class="type">String</span> <span class="variable">rpcService</span> <span class="operator">=</span> startAttributeds.get(AttributeKey.stringKey(<span class="string">&quot;rpc.service&quot;</span>));  </span><br><span class="line">    <span class="comment">// call from grpc  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> rpcService + <span class="string">&quot;:&quot;</span> + fullMethodName;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">baggageInfo</span> <span class="operator">=</span> getBaggageInfo(currentServiceName, method);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">httpUrlPath</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(CURRENT_HTTP_URL_PATH);  </span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(httpUrlPath)) &#123;  </span><br><span class="line">      <span class="comment">// call from http  </span></span><br><span class="line">      <span class="comment">// currentRpc = currentRpc;  currentRpc = create1|GET:/request      // clear current_http_url_path      builder.put(CURRENT_HTTP_URL_PATH, &quot;&quot;);  </span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="type">Baggage</span> <span class="variable">baggage</span> <span class="operator">=</span> builder  </span><br><span class="line">        .put(PARENT_RPC_KEY, currentRpc)  </span><br><span class="line">        .put(CURRENT_RPC_KEY, baggageInfo)  </span><br><span class="line">        .build();  </span><br><span class="line">    <span class="keyword">return</span> parentContext.with(baggage);  </span><br><span class="line">  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getBaggageInfo</span><span class="params">(String serviceName, String method)</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNullOrEmpty(serviceName)) &#123;  </span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">    &#125;    <span class="keyword">return</span> serviceName + <span class="string">&quot;|&quot;</span> + method;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸ªä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬éœ€è¦å…ˆä»ä¸Šä¸‹æ–‡ä¸­è·å– <code>CURRENT_RPC_KEY</code> ï¼Œä»è€Œå¾—çŸ¥å½“å‰çš„ span æ˜¯ä¸æ˜¯ root spanã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å…¶å®æ˜¯æŠŠå½“å‰çš„ span ä¿¡æ¯ä½œä¸ºä¸€ä¸ª <code>PARENT_RPC_KEY</code> å†™å…¥åˆ° Baggage ä¸­ã€‚</p><p>è¿™æ ·åœ¨ <code>SpanProcessor</code> ä¸­ä¾¿å¯ä»¥ç›´æ¥å–å‡º <code>PARENT_RPC_KEY</code> ä½œä¸ºä¸Šæ¸¸çš„ä¿¡æ¯å†™å…¥ span çš„ attribute ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(Context parentContext, ReadWriteSpan span)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">parentRpc</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(<span class="string">&quot;parent_rpc&quot;</span>);  </span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(parentRpc)) &#123;  </span><br><span class="line">        String[] split = parentRpc.split(<span class="string">&quot;\\|&quot;</span>);  </span><br><span class="line">        span.setAttribute(<span class="string">&quot;parent_rpc&quot;</span>, parentRpc);  </span><br><span class="line">        span.setAttribute(<span class="string">&quot;parent_service_name&quot;</span>, split[<span class="number">0</span>]);  </span><br><span class="line">        span.setAttribute(<span class="string">&quot;parent_service_method&quot;</span>, split[<span class="number">1</span>]); </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ Baggage éœ€è¦ä½¿ç”¨ <code>Baggage.fromContext(parentContext)</code> æ‰èƒ½æ‹¿åˆ°åˆšæ‰å†™å…¥ Baggage ä¿¡æ¯ã€‚</p></blockquote><p>ä¹‹åæˆ‘ä»¬æ‰¾åˆ°æ„å»º <a href="https://github.com/crossoverjie/opentelemetry-java-instrumentation/blob/715220c8d5e52001f9af9afbeb00bb87b4db0197/instrumentation/grpc-1.6/library/src/main/java/io/opentelemetry/instrumentation/grpc/v1_6/GrpcTelemetryBuilder.java#L31">gRPCServerInstrumenterBuilder</a> çš„åœ°æ–¹ï¼Œå†™å…¥æˆ‘ä»¬åˆšæ‰è‡ªå®šä¹‰çš„ <code>GrpcServerContextCustomizer</code> å³å¯ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/rwSc8HmvqKL9ZQl.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.addContextCustomizer(<span class="keyword">new</span> <span class="title class_">GrpcServerContextCustomizer</span>(serviceName))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©å†™å…¥åˆ°æ˜¯ <code>serverInstrumenterBuilder</code> è€Œä¸æ˜¯<code>clientInstrumenterBuilder</code>ï¼Œå› ä¸ºåœ¨æœåŠ¡ç«¯çš„å…¥å£å°±çŸ¥é“æ˜¯ä»å“ªä¸ªæ¥å£è¿›æ¥çš„è¯·æ±‚ã€‚</p><h1 id="ä¸º-spring-boot-çš„-http-æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡"><a href="#ä¸º-spring-boot-çš„-http-æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸º spring boot çš„ http æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡"></a>ä¸º spring boot çš„ http æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡</h1><p>å¦‚æœåªå­˜åœ¨ gRPC è°ƒç”¨æ—¶åªæ·»åŠ  <code>gRPC</code> çš„ä¸Šä¸‹æ–‡ä¹Ÿå¤Ÿç”¨äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿä¸æ’é™¤ç”±å¤–éƒ¨æ¥å£æ˜¯é€šè¿‡ HTTP è®¿é—®è¿›æ¥çš„ï¼Œç„¶åå†è°ƒç”¨å†…éƒ¨çš„ <code>gRPC</code> æ¥å£ï¼›è¿™ä¹Ÿæ˜¯éå¸¸å¸¸è§çš„æ¶æ„æ¨¡å¼ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åœ¨ HTTP ä¸­å¢åŠ  <code>ContextCustomizer</code> å°†è‡ªèº«çš„æ•°æ®å†™å…¥åˆ° <code>Baggage</code> ä¸­ã€‚</p><p>å¥½åœ¨ <code>HttpServerRouteBuilder</code> è‡ªèº«æ˜¯å®ç°äº† <code>ContextCustomizer</code> æ¥å£çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å¾€é‡Œé¢å†™å…¥ <code>Baggage</code> æ•°æ®å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ContextCustomizer&lt;REQUEST&gt; <span class="title function_">build</span><span class="params">()</span> &#123;  </span><br><span class="line">  Set&lt;String&gt; knownMethods = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(<span class="built_in">this</span>.knownMethods);  </span><br><span class="line">  <span class="keyword">return</span> (context, request, startAttributes) -&gt; &#123;  </span><br><span class="line">    <span class="keyword">if</span> (HttpRouteState.fromContextOrNull(context) != <span class="literal">null</span>) &#123;  </span><br><span class="line">      <span class="keyword">return</span> context;  </span><br><span class="line">    &#125;    <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> getter.getHttpRequestMethod(request);  </span><br><span class="line">    <span class="keyword">if</span> (method == <span class="literal">null</span> || !knownMethods.contains(method)) &#123;  </span><br><span class="line">      method = <span class="string">&quot;HTTP&quot;</span>;  </span><br><span class="line">    &#125;    <span class="type">String</span> <span class="variable">urlPath</span> <span class="operator">=</span> getter.getUrlPath(request);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">methodPath</span> <span class="operator">=</span> method + <span class="string">&quot;:&quot;</span> + urlPath;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">currentRpc</span> <span class="operator">=</span> Baggage.fromContext(context).getEntryValue(CURRENT_RPC_KEY);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">baggageInfo</span> <span class="operator">=</span> getBaggageInfo(serviceName, methodPath);  </span><br><span class="line">    <span class="type">Baggage</span> <span class="variable">baggage</span> <span class="operator">=</span> Baggage.fromContext(context).toBuilder()  </span><br><span class="line">        .put(PARENT_RPC_KEY, currentRpc)  </span><br><span class="line">        .put(CURRENT_RPC_KEY, baggageInfo)  </span><br><span class="line">        .put(CURRENT_HTTP_URL_PATH, methodPath)  </span><br><span class="line">        .build();   </span><br><span class="line">    <span class="keyword">return</span> context.with(HttpRouteState.create(method, <span class="literal">null</span>, <span class="number">0</span>))  </span><br><span class="line">        .with(baggage);  </span><br><span class="line">  &#125;;&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ–°å¢äº† <code>CURRENT_HTTP_URL_PATH</code> ç”¨äºæ ‡è®°å½“å‰çš„è¯·æ±‚æ¥æºæ˜¯ HTTPï¼Œåœ¨ grpc çš„ <code>ContextCustomizer</code> è§£ææ—¶ä¼šåˆ¤æ–­è¿™ä¸ªå€¼æ˜¯å¦ä¸ºç©ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">httpUrlPath</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(CURRENT_HTTP_URL_PATH);  </span><br><span class="line"><span class="keyword">if</span> (!StringUtils.isNullOrEmpty(httpUrlPath)) &#123;  </span><br><span class="line">  <span class="comment">// call from http  </span></span><br><span class="line">  <span class="comment">// currentRpc = currentRpc;  currentRpc = create1|GET:/request  // clear current_http_url_path  builder.put(CURRENT_HTTP_URL_PATH, &quot;&quot;);  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p><img src="https://s2.loli.net/2024/05/20/ionwTD9EAr3CROL.png"></p><p>è¿™æ ·å°±å¯ä»¥åœ¨ grpc çš„ä¸‹æ¸¸æ¥å£æ‹¿åˆ°å…¥å£çš„ HTTP æ¥å£æ•°æ®äº†ã€‚</p><hr><p>å½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯åœ¨ grpc æ¥å£ä¸­è°ƒç”¨ HTTP çš„æ¥å£çš„åœºæ™¯ï¼Œåªæ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡ä¸­æ²¡æœ‰è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥å°±æ²¡æœ‰é€‚é…è¿™ç±»çš„åœºæ™¯ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><code>ContextCustomizer</code> æ¥å£æ²¡æœ‰æä¾›å¯¹åº”çš„æ‰©å±•ï¼Œä½†æ˜¯ <code>SpanProcessor</code> æ˜¯æä¾›äº†æ‰©å±•æ¥å£çš„ã€‚</p><blockquote><p>åŸæœ¬æ˜¯æƒ³å°½é‡åˆ«ç»´æŠ¤è‡ªå·±çš„ javaagentï¼Œä½†ä¹Ÿå¥½åœ¨ OpenTelemetry æ˜¯æä¾›çš„æ¥å£ï¼Œæ‰€ä»¥ä¹Ÿå¹¶ä¸ä¼šå»ä¿®æ”¹åŸæœ¬çš„ä»£ç ã€‚</p></blockquote><p>æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ª extensions çš„é¡¹ç›®åœ¨å®ç° <code>SpanProcessor</code>ï¼Œè¿™ä¸ªåœ¨ä¹‹å‰çš„ <a href="https://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/">ã€Šå®æˆ˜ï¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª OpenTelemetry Extensionsã€‹</a>æœ‰è¯¦ç»†è®²åˆ°ã€‚</p><p>æ‰€ä»¥æœ€åçš„åº”ç”¨å¯åŠ¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.javaagent.extensions=otel-extensions-custom-context-1.0-SNAPSHOT.jar \</span><br></pre></td></tr></table></figure><p>éœ€è¦ä½¿ç”¨æˆ‘ä»¬æ‰‹åŠ¨æ‰“åŒ…çš„ javaagent ä»¥åŠä¸€ä¸ªè‡ªå®šä¹‰æ‰©å±•åŒ…ã€‚</p><p>æ‰“åŒ…æ–¹å¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew assemble</span><br></pre></td></tr></table></figure><blockquote><p><code>opentelemetry-java-instrumentation</code> é¡¹ç›®æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥æ‰“åŒ…è¿‡ç¨‹å¯èƒ½æ¯”è¾ƒä¹…ã€‚</p></blockquote><p>å› ä¸ºè¿™å…¶å®æ˜¯ä¸€äº›å®šåˆ¶éœ€æ±‚ï¼Œæ‰€ä»¥å°±æ²¡æäº¤åˆ°ä¸Šæ¸¸ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œåˆå¹¶ä»£ç æµ‹è¯•ã€‚</p><p>æœ€åå¯ä»¥è¿™ä¸ªåˆ†æ”¯ä¸­æŸ¥çœ‹åˆ°ä¿®æ”¹çš„éƒ¨åˆ†ï¼š<br><a href="https://github.com/crossoverJie/opentelemetry-java-instrumentation/compare/main...add-grpc-context">https://github.com/crossoverJie/opentelemetry-java-instrumentation/compare/main...add-grpc-context</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/05/19/7CnOFegSu4TLbhd.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;</summary>
      
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>ä» Prometheus åˆ° OpenTelemetryï¼šæŒ‡æ ‡ç›‘æ§çš„æ¼”è¿›ä¸å®è·µ</title>
    <link href="http://crossoverjie.top/2024/06/13/ob/OpenTelemetry-metrics-concept/"/>
    <id>http://crossoverjie.top/2024/06/13/ob/OpenTelemetry-metrics-concept/</id>
    <published>2024-06-13T10:22:48.000Z</published>
    <updated>2024-06-13T09:18:05.873Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡ï¼š<a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</a>æˆ‘ä»¬è®²è§£äº† Trace çš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µï¼š</p><ul><li>Trace</li><li>Span</li><li>Context</li><li>Baggage ç­‰</li></ul><p>è¿™æ¬¡æˆ‘ä»¬æ¥è®²å¦ä¸€ä¸ªè¯é¢˜ <code>Metrics</code>ã€‚</p><span id="more"></span><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å…³äº metrics æˆ‘æœ€æ—©æ¥è§¦ç›¸å…³æ¦‚å¿µçš„å°±æ˜¯ prometheusï¼Œå®ƒæ˜¯ç¬¬äºŒä¸ªåŠ å…¥ CNCFï¼ˆäº‘åŸç”Ÿï¼‰ç¤¾åŒºçš„é¡¹ç›®ï¼ˆç¬¬ä¸€ä¸ªæ˜¯ kubernetesï¼‰ï¼Œå¯è§åœ¨äº‘åŸç”Ÿé¢†åŸŸ Metrics æŒ‡æ ‡ç›‘æ§ä»è¯ç”Ÿä¹‹åˆå°±æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ã€‚</p><p>ç°å®ä¹Ÿç¡®å®å¦‚æ­¤ï¼Œå¦‚ä»Šåªè¦ä½¿ç”¨åˆ°äº† kubernetes ç›¸å…³çš„é¡¹ç›®ï¼Œå¯¹å…¶ç›‘æ§å°±æ˜¯å¿…ä¸å¯å°‘çš„ã€‚</p><p>å½“ç„¶ä¹Ÿä¸æ­¢æ˜¯äº‘åŸç”Ÿçš„é¡¹ç›®æ‰éœ€è¦ Metrics æŒ‡æ ‡ç›‘æ§ï¼Œæˆ‘ä»¬ä»»ä½•ä¸€ä¸ªä¸šåŠ¡éƒ½æ˜¯éœ€è¦çš„ï¼Œä¸ç„¶æˆ‘ä»¬çš„æœåŠ¡è¿è¡Œå¯¹å¼€å‘è¿ç»´æ¥è¯´éƒ½æ˜¯ä¸€ä¸ªé»‘ç›’ï¼Œæ— æ³•çŸ¥é“æ­¤æ—¶ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µï¼Œå› æ­¤æ‰éœ€è¦æˆ‘ä»¬çš„ä¸šåŠ¡ç³»ç»Ÿå°†ä¸€äº›å…³é”®è¿è¡ŒæŒ‡æ ‡æš´éœ²å‡ºæ¥ã€‚</p><p><img src="https://s2.loli.net/2024/05/12/1QWEAdFHqYzhl4g.png"></p><p>ä¸šåŠ¡æ•°æ®ï¼šæ¯”å¦‚è®¢å•çš„å¢é•¿ç‡ã€é”€å”®é‡‘é¢ç­‰ä¸šåŠ¡æ•°æ®ï¼›åŒæ—¶è¿˜æœ‰åº”ç”¨è‡ªèº«çš„èµ„æºå ç”¨æƒ…å†µï¼š</p><ul><li>QPS</li><li>Latency</li><li>å†…å­˜</li><li>CPU ç­‰ä¿¡æ¯ã€‚</li></ul><p> åœ¨ä½¿ç”¨ OpenTelemetry ä¹‹å‰ï¼Œå› ä¸º prometheus æ˜¯è¿™éƒ¨åˆ†çš„ç»å¯¹æ ‡å‡†ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šå¸¸éƒ½ä¼šä½¿ç”¨ prometheus çš„åŒ…æ¥æš´éœ²è¿™äº›æŒ‡æ ‡ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- The client --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Hotspot JVM metrics--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient_hotspot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æš´éœ²ä¸€ä¸ªè‡ªå®šä¹‰çš„æŒ‡æ ‡ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.prometheus.client.Counter;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">YourClass</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">requests</span> <span class="operator">=</span> Counter.build()</span><br><span class="line">     .name(<span class="string">&quot;requests_total&quot;</span>).help(<span class="string">&quot;Total requests.&quot;</span>).register();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">processRequest</span><span class="params">()</span> &#123;</span><br><span class="line">    requests.inc();</span><br><span class="line">    <span class="comment">// Your code here.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ˜¯æš´éœ²ä¸€ä¸ªå•è°ƒé€’å¢çš„æŒ‡æ ‡ï¼Œprometheus è¿˜æä¾›äº†å…¶ä»–å‡ ç§æŒ‡æ ‡ç±»å‹ï¼š</p></blockquote><ul><li>Counter</li><li>Gauge</li><li>Histogram</li></ul><p>ä¹‹åæˆ‘ä»¬åªéœ€è¦åœ¨ prometheus ä¸­é…ç½®ä¸€äº›æŠ“å–è§„åˆ™å³å¯ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;springboot&#x27;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8080&#x27;</span>] <span class="comment"># Spring Boot ip+port</span></span><br></pre></td></tr></table></figure><blockquote><p>å½“ç„¶å¦‚æœæ˜¯è¿è¡Œåœ¨ kubernetes ç¯å¢ƒï¼Œprometheus ä¹Ÿå¯ä»¥åŸºäºæœåŠ¡å‘ç°é…ç½®ä¸€äº›è§„åˆ™ï¼Œè‡ªåŠ¨æŠ“å–æˆ‘ä»¬çš„ Pod çš„æ•°æ®ï¼Œç”±äºä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹å°±ä¸è¿‡å¤šä»‹ç»ã€‚</p></blockquote><h1 id="åŸºæœ¬ç»„ä»¶"><a href="#åŸºæœ¬ç»„ä»¶" class="headerlink" title="åŸºæœ¬ç»„ä»¶"></a>åŸºæœ¬ç»„ä»¶</h1><p>åœ¨ OpenTelemetry ä¸­è‡ªç„¶ä¹Ÿæä¾›äº† Metrics è¿™ä¸ªç»„ä»¶ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯å®Œå…¨å…¼å®¹ Prometheusï¼Œæ‰€ä»¥æˆ‘ä»¬ç†è§£å’Œä½¿ç”¨èµ·æ¥å¹¶ä¸å¤æ‚ã€‚</p><h2 id="MeterProvider"><a href="#MeterProvider" class="headerlink" title="MeterProvider"></a>MeterProvider</h2><p>ä¸åŒäº prometheus å®¢æˆ·ç«¯ä¸­ç›´æ¥æä¾›äº† Counter å°±å¯ä»¥åˆ›å»ºæŒ‡æ ‡äº†ï¼Œåœ¨ OpenTelemetry ä¸­ä¼šæä¾›ä¸€ä¸ª <code>MeterProvider</code> çš„æ¥å£ï¼Œä½¿ç”¨è¿™ä¸ªæ¥å£å¯ä»¥è·å– Meterï¼Œå†ä½¿ç”¨ Meter æ‰å¯ä»¥åˆ›å»º Counterã€Gaugeã€Histogram ç­‰æ•°æ®ã€‚</p><p>ä¸‹é¢æ¥çœ‹çœ‹å…·ä½“å¦‚ä½•ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¥ Pulsar æºç çš„ä»£ç è¿›è¡Œæ¼”ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InstrumentProvider</span><span class="params">(OpenTelemetry otel)</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (otel == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="comment">// By default, metrics are disabled, unless the OTel java agent is configured.  </span></span><br><span class="line">        <span class="comment">// This allows to enable metrics without any code change.        otel = GlobalOpenTelemetry.get();  </span></span><br><span class="line">    &#125;    <span class="built_in">this</span>.meter = otel.getMeterProvider()  </span><br><span class="line">            .meterBuilder(<span class="string">&quot;org.apache.pulsar.client&quot;</span>)  </span><br><span class="line">            .setInstrumentationVersion(PulsarVersion.getVersion())  </span><br><span class="line">            .build();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">LongCounterBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> meter.counterBuilder(name)  </span><br><span class="line">        .setDescription(description)  </span><br><span class="line">        .setUnit(unit.toString());</span><br></pre></td></tr></table></figure><h2 id="Meter-Exporter"><a href="#Meter-Exporter" class="headerlink" title="Meter Exporter"></a>Meter Exporter</h2><p>Meter Exporter åˆ™æ˜¯ä¸€ä¸ª OpenTelemetry ç‹¬æœ‰çš„æ¦‚å¿µï¼Œä¸æˆ‘ä»¬ä¹‹å‰è®²åˆ°çš„ä¸€æ ·ï¼šOpenTelemetry ä½œä¸ºå‚å•†æ— å…³çš„å¹³å°ï¼Œå…è®¸æˆ‘ä»¬å°†æ•°æ®å†™å…¥åˆ°ä»»ä½•å…¼å®¹çš„äº§å“é‡Œã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨ Metrics æ—¶éœ€è¦æŒ‡å®šä¸€ä¸ª exporterï¼š</p><table><thead><tr><th>Exporter ç±»å‹</th><th>ä½œç”¨</th><th>å¤‡æ³¨</th><th>å‚æ•°</th></tr></thead><tbody><tr><td>OTLP Exporter</td><td>é€šè¿‡ OpenTelemetry Protocolï¼ˆOTLPï¼‰ å‘é€æŒ‡æ ‡æ•°æ®åˆ° collectã€‚</td><td>é»˜è®¤ç”Ÿäº§ç¯å¢ƒä¸­æ¨èä½¿ç”¨ï¼Œéœ€è¦å°†æ•°æ®å‘é€åˆ°æ”¯æŒ OTLP çš„åç«¯ï¼Œå¦‚ OpenTelemetry Collectorã€‚</td><td>-Dotel.metrics.exporter&#x3D;otlp (default)</td></tr><tr><td>Console Exporter</td><td>å°†æŒ‡æ ‡æ•°æ®æ‰“å°åˆ°æ§åˆ¶å°çš„å¯¼å‡ºå™¨ã€‚</td><td>å¼€å‘å’Œè°ƒè¯•ï¼Œå¿«é€ŸæŸ¥çœ‹æŒ‡æ ‡æ•°æ®ã€‚</td><td>-Dotel.metrics.exporter&#x3D;console</td></tr><tr><td>Prometheus Exporter</td><td>å°†æŒ‡æ ‡æ•°æ®ä»¥ Prometheus æŠ“å–çš„æ ¼å¼æš´éœ²ç»™ Prometheus æœåŠ¡ã€‚</td><td>ä¸ Prometheus é›†æˆï¼Œé€‚ç”¨äºéœ€è¦ Prometheus ç›‘æ§çš„åœºæ™¯ï¼Œè¿™ä¸ªå¯ä»¥æ— ç¼å’Œä»¥å¾€ä½¿ç”¨ prometheus çš„åœºæ™¯å…¼å®¹</td><td>-Dotel.metrics.exporter&#x3D;prometheus</td></tr></tbody></table><h2 id="Metric-Instruments"><a href="#Metric-Instruments" class="headerlink" title="Metric Instruments"></a>Metric Instruments</h2><p>ä¸ prometheus ç±»ä¼¼ï¼ŒOpenTelemetry ä¹Ÿæä¾›äº†ä»¥ä¸‹å‡ ç§æŒ‡æ ‡ç±»å‹ï¼š</p><ul><li><strong>Counter</strong>ï¼šå•è°ƒé€’å¢è®¡æ•°å™¨ï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥è®°å½•è®¢å•æ•°ã€æ€»çš„è¯·æ±‚æ•°ã€‚</li><li><strong>UpDownCounter</strong>ï¼šä¸ Counter ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒå¯ä»¥é€’å‡ã€‚</li><li><strong>Gauge</strong>ï¼šç”¨äºè®°å½•éšæ—¶åœ¨å˜åŒ–çš„å€¼ï¼Œæ¯”å¦‚å†…å­˜ä½¿ç”¨é‡ã€CPU ä½¿ç”¨é‡ç­‰ã€‚</li><li><strong>Histogram</strong>ï¼šé€šå¸¸ç”¨äºè®°å½•è¯·æ±‚å»¶è¿Ÿã€å“åº”æ—¶é—´ç­‰ã€‚</li></ul><p>åŒæ—¶æ¯ä¸ªæŒ‡æ ‡è¿˜æœ‰ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š</p><ul><li>Nameï¼šåç§°ï¼Œå¿…å¡«ã€‚</li><li>Kindï¼šç±»å‹ï¼Œå¿…å¡«ã€‚</li><li>Unitï¼šå•ä½ï¼Œå¯é€‰ã€‚</li><li>Descriptionï¼šæè¿°ï¼Œå¯é€‰ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">messageInCounter = meter  </span><br><span class="line">        .counterBuilder(MESSAGE_IN_COUNTER)  </span><br><span class="line">        .setUnit(<span class="string">&quot;&#123;message&#125;&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;The total number of messages received for this topic.&quot;</span>)  </span><br><span class="line">        .buildObserver();</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯ä»¥ Pulsar çš„ä¸ºä¾‹ï¼Œ<code>messageInCounter</code> æ˜¯ä¸€ä¸ªè®°å½•æ€»çš„æ¶ˆæ¯æ¥æ”¶æ•°é‡çš„ Counter ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">subscriptionCounter = meter  </span><br><span class="line">        .upDownCounterBuilder(SUBSCRIPTION_COUNTER)  </span><br><span class="line">        .setUnit(<span class="string">&quot;&#123;subscription&#125;&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;The number of Pulsar subscriptions of the topic served by this broker.&quot;</span>)  </span><br><span class="line">        .buildObserver();</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯è®°å½•ä¸€ä¸ªè®¢é˜…è€…æ•°é‡çš„æŒ‡æ ‡ï¼Œç±»å‹æ˜¯ UpDownCounterï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¢åŠ å‡å°‘çš„æŒ‡æ ‡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Double&gt; latencyHistogramBuckets =  </span><br><span class="line">        Lists.newArrayList(<span class="number">.0005</span>, <span class="number">.001</span>, <span class="number">.0025</span>, <span class="number">.005</span>, <span class="number">.01</span>, <span class="number">.025</span>, <span class="number">.05</span>, <span class="number">.1</span>, <span class="number">.25</span>, <span class="number">.5</span>, <span class="number">1.0</span>, <span class="number">2.5</span>, <span class="number">5.0</span>, <span class="number">10.0</span>, <span class="number">30.0</span>, <span class="number">60.0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">DoubleHistogramBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> meter.histogramBuilder(<span class="string">&quot;pulsar.client.producer.message.send.duration&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;Publish latency experienced by the application, includes client batching time&quot;</span>)  </span><br><span class="line">        .setUnit(Unit.Seconds.toString())  </span><br><span class="line">        .setExplicitBucketBoundariesAdvice(latencyHistogramBuckets);</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªè®°å½• Pulsar producer å‘é€å»¶è¿Ÿçš„æŒ‡æ ‡ï¼Œç±»å‹æ˜¯ <code>Histogram</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">backlogQuotaAge = meter  </span><br><span class="line">        .gaugeBuilder(BACKLOG_QUOTA_AGE)  </span><br><span class="line">        .ofLongs()  </span><br><span class="line">        .setUnit(<span class="string">&quot;s&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;The age of the oldest unacknowledged message (backlog).&quot;</span>)  </span><br><span class="line">        .buildObserver();</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªè®°å½•æœ€å¤§ unack ä¹Ÿå°±æ˜¯ backlog æ—¶é—´çš„æŒ‡æ ‡ï¼Œç±»å‹æ˜¯ <code>Gauge</code>ã€‚</p><h1 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h1><p>åœ¨ä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/">å®æˆ˜ï¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª OpenTelemetry Extensions</a>ä¸­è®²è¿‡å¦‚ä½•å¼€å‘ä¸€ä¸ª OpenTelemetry çš„ extensionï¼Œå…¶å®å½“æ—¶æˆ‘å°±æ˜¯å¼€å‘äº†ä¸€ä¸ªç”¨äºåœ¨ Pulsar å®¢æˆ·ç«¯ä¸­æš´éœ²æŒ‡æ ‡çš„ä¸€ä¸ªæ’ä»¶ã€‚</p><blockquote><p>ä¸è¿‡ç›®å‰ Pulsar ç¤¾åŒºå·²ç»é›†æˆäº†è¯¥åŠŸèƒ½ã€‚</p></blockquote><p>å…¶ä¸­çš„æ ¸å¿ƒä»£ç ä¸ä¸Šé¢è®²åˆ°çš„ç±»ä¼¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerObservers</span><span class="params">()</span> &#123;    </span><br><span class="line">    <span class="type">Meter</span> <span class="variable">meter</span> <span class="operator">=</span> MetricsRegistration.getMeter();    </span><br><span class="line">    </span><br><span class="line">    meter.gaugeBuilder(<span class="string">&quot;pulsar_producer_num_msg_send&quot;</span>)    </span><br><span class="line">            .setDescription(<span class="string">&quot;The number of messages published in the last interval&quot;</span>)    </span><br><span class="line">            .ofLongs()    </span><br><span class="line">            .buildWithCallback(    </span><br><span class="line">                    r -&gt; recordProducerMetrics(r, ProducerStats::getNumMsgsSent));</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recordProducerMetrics</span><span class="params">(ObservableLongMeasurement observableLongMeasurement, Function&lt;ProducerStats, Long&gt; getter)</span> &#123;    </span><br><span class="line">    <span class="keyword">for</span> (Producer producer : CollectionHelper.PRODUCER_COLLECTION.list()) &#123;    </span><br><span class="line">        <span class="type">ProducerStats</span> <span class="variable">stats</span> <span class="operator">=</span> producer.getStats();    </span><br><span class="line">        <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> producer.getTopic();    </span><br><span class="line">        <span class="keyword">if</span> (topic.endsWith(RetryMessageUtil.RETRY_GROUP_TOPIC_SUFFIX)) &#123;    </span><br><span class="line">            <span class="keyword">continue</span>;    </span><br><span class="line">        &#125;        observableLongMeasurement.record(getter.apply(stats),    </span><br><span class="line">                Attributes.of(PRODUCER_NAME, producer.getProducerName(), TOPIC, topic));    </span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure><p>åªæ˜¯è¿™é‡Œä½¿ç”¨äº† <code>buildWithCallback</code> å›è°ƒå‡½æ•°ï¼ŒOpenTelemetry ä¼šæ¯éš” 30s è°ƒç”¨ä¸€æ¬¡è¿™ä¸ªå‡½æ•°ï¼Œé€šå¸¸é€‚ç”¨äº Gauge ç±»å‹çš„æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent.jar \  </span><br><span class="line">     -Dotel.javaagent.extensions=ext.jar  \</span><br><span class="line">     -Dotel.metrics.exporter=prometheus \</span><br><span class="line">     -Dotel.exporter.prometheus.port=<span class="number">18180</span> \</span><br><span class="line">     -jar myapp.jar</span><br></pre></td></tr></table></figure><p>é…åˆä¸Š Prometheus çš„ä¸¤ä¸ªå¯åŠ¨å‚æ•°å°±å¯ä»¥åœ¨æœ¬åœ° 18180 ä¸­è·å–åˆ°æŒ‡æ ‡æ•°æ®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:18180/metrics</span><br></pre></td></tr></table></figure><p>å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å‘å¾€ OpenTelemetry-Collector ä¸­ï¼Œå†ç”±å®ƒå‘å¾€ prometheusï¼Œåªæ˜¯è¿™æ ·éœ€è¦é¢å¤–åœ¨ collector ä¸­é…ç½®ä¸€ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">debug:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">otlphttp:</span></span><br><span class="line">    <span class="attr">metrics_endpoint:</span> <span class="string">http://promethus:8480/insert/0/opentelemetry/api/v1/push</span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">exporters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlphttp</span></span><br><span class="line">      <span class="attr">processors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">k8sattributes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">      <span class="attr">receivers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlp</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/05/12/4iMpax5Ptod2Nws.png"></p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ Grafana ä¸­é€šè¿‡ prometheus æŸ¥è¯¢åˆ°æ•°æ®äº†ã€‚</p><p>æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰çš„æŒ‡æ ‡æœ€å¥½æ˜¯å‚è€ƒå®˜æ–¹çš„<a href="https://opentelemetry.io/docs/specs/semconv/general/metrics/">è¯­ä¹‰å’Œå‘½åè§„èŒƒ</a>æ¥å®šä¹‰è¿™äº›æŒ‡æ ‡åç§°ã€‚</p><p><img src="https://s2.loli.net/2024/05/12/vCDZY3ygX7MrzGH.png"></p><p>æ¯”å¦‚ OpenTelemetry çš„è§„èŒƒä¸­åç§°æ˜¯ç”¨ <strong>.</strong> æ¥è¿›è¡Œåˆ†éš”çš„ã€‚</p><blockquote><p>åˆ‡æ¢ä¸º OpenTelemetry ä¹‹åè‡ªç„¶å°±ä¸éœ€è¦ä¾èµ– prometheus çš„åŒ…ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ OTel çš„åŒ…ï¼š</p></blockquote><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compileOnly <span class="string">&#x27;io.opentelemetry:opentelemetry-sdk-extension-autoconfigure-spi:1.34.1&#x27;</span>  </span><br><span class="line">compileOnly <span class="string">&#x27;io.opentelemetry.instrumentation:opentelemetry-instrumentation-api:1.32.0&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç›¸å¯¹æ¥è¯´ Metrics çš„ä½¿ç”¨æ¯” Trace ç®€å•çš„å¤šï¼ŒåŒæ—¶ Metrics å…¶å®ä¹Ÿå¯ä»¥å’Œ Trace è¿›è¡Œå…³è”ï¼Œä¹Ÿå°±æ˜¯ <a href="https://opentelemetry.io/docs/specs/otel/metrics/data-model/#exemplars">Exemplars</a>ï¼Œé™äºç¯‡å¹…å°±ä¸åœ¨æœ¬æ–‡å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/apache/pulsar/blob/master/pulsar-client/src/main/java/org/apache/pulsar/client/impl/metrics/InstrumentProvider.java">https://github.com/apache/pulsar/blob/master/pulsar-client/src/main/java/org/apache/pulsar/client/impl/metrics/InstrumentProvider.java</a></li><li><a href="https://opentelemetry.io/docs/specs/semconv/general/metrics/">https://opentelemetry.io/docs/specs/semconv/general/metrics/</a></li><li><a href="https://opentelemetry.io/docs/specs/otel/metrics/data-model/#exemplars">https://opentelemetry.io/docs/specs/otel/metrics/data-model/#exemplars</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡ï¼š&lt;a href=&quot;https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/&quot;&gt;ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…&lt;/a&gt;æˆ‘ä»¬è®²è§£äº† Trace çš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Trace&lt;/li&gt;
&lt;li&gt;Span&lt;/li&gt;
&lt;li&gt;Context&lt;/li&gt;
&lt;li&gt;Baggage ç­‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™æ¬¡æˆ‘ä»¬æ¥è®²å¦ä¸€ä¸ªè¯é¢˜ &lt;code&gt;Metrics&lt;/code&gt;ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
  </entry>
  
  <entry>
    <title>ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</title>
    <link href="http://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/"/>
    <id>http://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/</id>
    <published>2024-06-05T16:55:16.000Z</published>
    <updated>2024-06-06T13:00:48.174Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¹‹å‰å†™è¿‡ä¸¤ç¯‡æ¯”è¾ƒç³»ç»Ÿçš„å…³äº OpenTelemetry çš„æ–‡ç« ï¼š</p><ul><li><a href="https://juejin.cn/post/7358450927110357026">OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ</a></li><li><a href="https://juejin.cn/post/7360216766373068837">å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯</a></li></ul><p>ä»åŸºæœ¬æ¦‚å¿µåˆ°å¦‚ä½•éƒ¨ç½² demo å®æˆ˜äº†è§£ OpenTelemetryï¼Œä»é‚£ä¸ª demo ä¸­ä¹Ÿå¯ä»¥å¾—çŸ¥æ•´ä¸ª OpenTelemetry ä½“ç³»çš„å¤æ‚æ€§ï¼ŒåŒ…å«äº†å¤ªå¤šçš„ç»„ä»¶å’Œæ¦‚å¿µã€‚</p><p>ä¸ºäº†èƒ½æ›´æ¸…æ™°çš„äº†è§£æ¯ä¸ªå…³é”®ç»„ä»¶çš„ä½œç”¨ä»¥åŠåŸç†ï¼Œæˆ‘æ‰“ç®—åˆ†ä¸ºå‡ æœŸæ¥è®²è§£ OpenTelemetry çš„ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p><ul><li>Trace</li><li>Metrics</li><li>Logs</li></ul><p>é¦–å…ˆä»¥ Trace è®²èµ·ã€‚</p><span id="more"></span><h1 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h1><p>å¼€å§‹ä¹‹å‰è¿˜æ˜¯å…ˆå¤ä¹ ä¸€ä¸‹ Trace çš„å†å²èƒŒæ™¯ã€‚</p><p>å¦‚ä»Šç°ä»£çš„åˆ†å¸ƒå¼è¿½è¸ªçš„èµ·æºæºè‡ªäº Google åœ¨ 2010 å¹´å‘å¸ƒçš„ä¸€ç¯‡è®ºæ–‡ï¼š</p><ul><li><a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/papers/dapper-2010-1.pdf">Dapper, a Large-Scale Distributed Systems Tracing Infrastructure</a></li></ul><p>åœ¨è¿™ç¯‡è®ºæ–‡ä¸­æå‡ºäº†åˆ†å¸ƒå¼è¿½è¸ªçš„å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š</p><ul><li>Trace</li><li>Span<ul><li>Span çš„ä¸€äº›åŸºç¡€æ•°æ®ç»“æ„</li></ul></li><li>å¯è§†åŒ–è¿½è¸ªä»¥åŠå±•ç¤º</li></ul><p>ä¹‹å Twitter å—åˆ°äº† Dapper çš„å¯å‘å¼€æºäº†ç°åœ¨æˆ‘ä»¬ç†ŸçŸ¥çš„ <a href="https://zipkin.io/">Zipkin</a>ï¼ŒåŒ…å«äº†å­˜å‚¨å’Œå¯è§†åŒ– UI å±•ç¤ºæˆ‘ä»¬çš„è¿½è¸ªé“¾è·¯ã€‚</p><p>Uber ä¹Ÿåœ¨ 2015 å¹´å¼€æºäº† <a href="https://www.jaegertracing.io/">Jaeger</a> é¡¹ç›®ï¼Œå®ƒçš„åŠŸèƒ½å’Œ Zipkin ç±»ä¼¼ï¼Œä½†ç›®å‰æˆ‘ä»¬ç”¨çš„è¾ƒå¤šçš„è¿˜æ˜¯ Jaegerï¼›ç°åœ¨å·²ç»æˆä¸º CNCF çš„æ‰˜ç®¡é¡¹ç›®ã€‚</p><p>ä¹‹åé™†ç»­å‡ºç°è¿‡ <strong>OpenTracing</strong> å’Œ <strong>OpenCensus</strong> é¡¹ç›®ï¼Œä»–ä»¬éƒ½ä¼å›¾ç»Ÿä¸€åˆ†å¸ƒå¼è¿½è¸ªè¿™ä¸€é¢†åŸŸã€‚</p><p>ç›´åˆ° <code>OpenTelemetry</code> çš„å‡ºç°æ•´åˆäº†ä»¥ä¸Šä¸¤ä¸ªé¡¹ç›®ï¼Œå¹¶ä¸”é€æ¸æˆä¸ºå¯è§‚æµ‹é¢†åŸŸçš„æ ‡å‡†ã€‚</p><blockquote><p>æ›´å¤šå†å²èƒŒæ™¯å¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://juejin.cn/post/7358450927110357026">OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ</a></p></blockquote><p><img src="https://s2.loli.net/2024/05/05/ljQ6yNhKzn3b1c9.png"></p><p><img src="https://s2.loli.net/2024/05/05/NOEbTamR67x83nS.png"></p><p>è¿™é‡Œæˆ‘ä»¬ç»“åˆ Dapper è®ºæ–‡ä¸­çš„èµ„æ–™è¿›è¡Œåˆ†æï¼Œåœ¨è¿™ä¸ªè°ƒç”¨ä¸­ç”¨æˆ·å‘èµ·äº†ä¸€æ¬¡è¯·æ±‚ï¼Œå†…éƒ¨ç³»ç»Ÿç»å†äº† 4 æ¬¡ RPC è°ƒç”¨ã€‚</p><p>ä»ç¬¬äºŒå¼ å›¾ä¼šçœ‹åˆ°ä¸€äº›å…³é”®ä¿¡æ¯ï¼š</p><ul><li>spanName</li><li>parentId</li><li>spanId</li></ul><p>parentId å¾ˆå¥½ç†è§£ï¼Œä¸»è¦æ˜¯å®šä¹‰è°ƒç”¨çš„ä¸»æ¬¡å…³ç³»ï¼›è¦æ³¨æ„çš„æ˜¯å¹¶è¡Œè°ƒç”¨æ—¶ parentId æ˜¯åŒä¸€ä¸ªã€‚</p><p>spanId åœ¨å¯ä»¥ç†è§£ä¸ºæ¯ä¸€ä¸ªç‹¬ç«‹çš„æ“ä½œï¼Œåœ¨è¿™é‡Œå°±æ˜¯ä¸€æ¬¡ RPC è°ƒç”¨ï¼›åŒç†ä¸€æ¬¡æ•°æ®åº“æ“ä½œã€æ¶ˆæ¯çš„æ”¶å‘éƒ½æ˜¯ä¸€ä¸ª spanã€‚</p><blockquote><p>span çš„æ›´å¤šå†…å®¹åœ¨åæ–‡ç»§ç»­è®²è§£ã€‚</p></blockquote><h1 id="Span"><a href="#Span" class="headerlink" title="Span"></a>Span</h1><p><img src="https://s2.loli.net/2024/05/05/wyzLpbhYkjOUFav.png"><br>å½“æˆ‘ä»¬æŠŠæŸä¸€ä¸ªå…·ä½“çš„ span æ”¾å¤§ä¼šçœ‹åˆ°æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯ï¼Œå…¶ä¸­æœ€å…³é”®çš„å¦‚ä¸‹ï¼š</p><ul><li>traceId</li><li>spanName</li><li>spanId</li><li>parentId</li><li>å¼€å§‹æ—¶é—´</li><li>ç»“æŸæ—¶é—´</li></ul><p>ç”±äºä¸€ä¸ªå®Œæ•´çš„ trace é“¾è·¯ç”± N ä¸ª span ç»„æˆï¼Œæ‰€ä»¥è¿™ä¸ªé“¾è·¯å¿…é¡»å¾—æœ‰ä¸€ä¸ªå”¯ä¸€çš„ traceId å°†è¿™äº› span ä¸²è”èµ·æ¥ã€‚<br>è¿™æ ·æ‰å¯ä»¥åœ¨å¯è§†åŒ–çš„æ—¶å€™æ›´å¥½çš„å±•ç¤ºé“¾è·¯ä¿¡æ¯ã€‚</p><p>ä»¥ä¸Šçš„è¿™äº›å­—æ®µå¾ˆå®¹æ˜“ç†è§£ï¼Œéƒ½æ˜¯ä¸€äº›å¿…é¡»çš„ä¿¡æ¯ã€‚</p><p>åœ¨ Dapper è®ºæ–‡ä¸­ä½¿ç”¨ Annotations æ¥å­˜æ”¾ span çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯åˆšæ‰é‚£äº›å­—æ®µï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å­˜æ”¾ä¸€äº›æ•°æ®ï¼Œæ¯”å¦‚å›¾ä¸­çš„ <code>&quot;foo&quot;</code>ã€‚</p><h2 id="OpenTelemetry-ä¸­çš„-Span"><a href="#OpenTelemetry-ä¸­çš„-Span" class="headerlink" title="OpenTelemetry ä¸­çš„ Span"></a>OpenTelemetry ä¸­çš„ Span</h2><p>OpenTelemetry çš„ trace è‡ªç„¶ä¹Ÿæ˜¯åŸºäº Dapper çš„ï¼Œåªæ˜¯é¢å¤–åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚åœ¨åˆšæ‰é‚£äº›å­—æ®µçš„åŸºç¡€ä¸Šæ–°å¢äº†ä¸€äº›æ¦‚å¿µï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/v1/sys/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;context&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;trace_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7bba9f33312b3dbb8b2c2c62bb7abe2d&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;span_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;086e83747d0e381e&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;parent_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-10-22 16:04:01.209458162 +0000 UTC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;end_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-10-22 16:04:01.209514132 +0000 UTC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status_code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;STATUS_CODE_OK&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status_message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;net.transport&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IP.TCP&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.peer.ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.17.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.peer.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;51820&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.host.ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.177.2.152&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.host.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;26040&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/v1/sys/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.server_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mortar-gateway&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.route&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/v1/sys/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.user_agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Consul Health Check&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.scheme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.177.2.152:26040&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.flavor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;OK&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-10-22 16:04:01.209512872 +0000 UTC&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä»¥è¿™ä¸ª JSON ä¸ºä¾‹ï¼Œæ–°å¢äº†ï¼š</p><ul><li><input disabled="" type="checkbox"> <code>Span Context</code><ul><li><code>Span</code> çš„ä¸Šä¸‹æ–‡ï¼Œå­˜æ”¾çš„éƒ½æ˜¯ä¸å¯å˜çš„æ•°æ®ï¼Œå› ä¸ºæ¯ä¸ª Span ä¹‹é—´æ˜¯å­˜åœ¨å…³è”å…³ç³»çš„ï¼Œè¿™äº›å…³è”å…³ç³»éƒ½æ˜¯å­˜æ”¾åœ¨ context ä¸­ï¼Œä¸»è¦å°±æ˜¯ trace_id, span_id.</li></ul></li><li><code>Attributes</code>: å¯ä»¥ç†è§£ä¸º Dapper ä¸­çš„ Annotationsï¼Œå­˜æ”¾çš„æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„é”®å€¼å¯¹ï¼Œé€šå¸¸æ˜¯ç”±æˆ‘ä»¬å¸¸ç”¨ç¬¬ä¸‰æ–¹å¼€æº Instrumentation å†…ç½®çš„ä¸€äº›å±æ€§ã€‚</li><li><code>Span Events</code>: Span çš„ä¸€äº›å…³é”®äº‹ä»¶ã€‚</li></ul><p><img src="https://s2.loli.net/2024/05/05/3C49thIJOZTuf82.png"><br>æ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„ Redis å®¢æˆ·ç«¯ lettuceï¼Œå®ƒå°±ä¼šè‡ªå·±è®°å½•ä¸€äº› Attributesã€‚</p><hr><p>å¦‚æœæœ‰å¤šä¸ª span å­˜åœ¨ä¾èµ–å…³ç³»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">       [Span A]  â†â†â†(the root span)</span><br><span class="line">           |</span><br><span class="line">    +------+------+</span><br><span class="line">    |             |</span><br><span class="line">[Span B]      [Span C] â†â†â†(Span C is a `child` of Span A)</span><br><span class="line">    |             |</span><br><span class="line">[Span D]      +---+-------+</span><br><span class="line">              |           |</span><br><span class="line">          [Span E]    [Span F]</span><br></pre></td></tr></table></figure><p>å¤§éƒ¨åˆ†çš„å¯è§†åŒ–å·¥å…·éƒ½æ˜¯ä»¥æ—¶é—´çº¿çš„æ–¹å¼è¿›è¡Œå±•ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“&gt; time</span><br><span class="line"></span><br><span class="line"> [Span AÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">   [Span BÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">      [Span DÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">    [Span CÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">         [Span EÂ·Â·Â·Â·Â·Â·Â·]        [Span FÂ·Â·]</span><br></pre></td></tr></table></figure><p>è¿™äº›å’Œ Dapper ä¸­æè¿°çš„æ¦‚å¿µæ²¡æœ‰æœ¬è´¨åŒºåˆ«ã€‚</p><hr><h3 id="Span-Status"><a href="#Span-Status" class="headerlink" title="Span Status"></a>Span Status</h3><p>Span è¿˜å†…ç½®äº†ä¸€äº› Statusï¼š</p><ul><li><code>Unset</code></li><li><code>Error</code></li><li><code>Ok</code></li></ul><p>é»˜è®¤æƒ…å†µä¸‹æ˜¯ Unsetï¼Œå‡ºç°é”™è¯¯æ—¶åˆ™æ˜¯ Errorï¼Œä¸€åˆ‡æ­£å¸¸æ—¶åˆ™æ˜¯ Okã€‚</p><p><img src="https://s2.loli.net/2024/05/05/glkIuxbFDBcai36.png"><br>é€šè¿‡å¯è§†åŒ–é¡µé¢å¾ˆå®¹æ˜“å¾—çŸ¥æŸä¸ª trace ä¸­ span çš„å¼‚å¸¸æƒ…å†µï¼Œç‚¹è¿›å»åå¯ä»¥çœ‹åˆ°å…·ä½“çš„å¼‚å¸¸ span ä»¥åŠå®ƒçš„é”™è¯¯æ—¥å¿—ã€‚</p><h3 id="Span-Kind"><a href="#Span-Kind" class="headerlink" title="Span Kind"></a>Span Kind</h3><p>æœ€åæ˜¯ Span çš„ç±»å‹ï¼š</p><ul><li>Client</li><li>Server</li><li>Internal</li><li>Producer</li><li>Consumer</li></ul><p><img src="https://s2.loli.net/2024/05/05/rMjV9qsveNEKORW.png"></p><p>Client å’Œ Server éå¸¸å¥½ç†è§£ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª gRPC æ¥å£ï¼Œè°ƒç”¨æ–¹çš„ Span æ˜¯ clientï¼Œè€ŒæœåŠ¡ç«¯çš„ Span è‡ªç„¶å°±æ˜¯ Serverã€‚</p><p>Internal åˆ™æ˜¯å†…éƒ¨ç»„ä»¶è°ƒç”¨äº§ç”Ÿçš„ Spanï¼Œè¿™ç±» Span ç›¸å¯¹ä¼šå°‘ä¸€äº›ã€‚</p><p>Producer å’Œ Consumer ä¸€èˆ¬æŒ‡çš„æ˜¯å‘èµ·å¼‚æ­¥è°ƒç”¨æ—¶çš„ Spanï¼Œæˆ‘ä»¬å¸¸è§çš„å°±æ˜¯å¾€æ¶ˆæ¯é˜Ÿåˆ—é‡Œç”Ÿäº§å’Œæ¶ˆè´¹æ¶ˆæ¯ã€‚</p><p>é€šè¿‡è¿™å‡ ç§ç±»å‹çš„ Span ä¹Ÿå¯ä»¥äº†è§£åˆ°ä»€ä¹ˆæƒ…å†µä¸‹ä¼šåˆ›å»º Spanï¼Œé€šå¸¸æ˜¯ä»¥ä¸‹å‡ ç§åœºæ™¯ï¼š</p><ul><li>RPC è°ƒç”¨</li><li>æ•°æ®åº“ï¼ˆRedisã€MySQLã€Mongo ç­‰ç­‰ï¼‰æ“ä½œ</li><li>ç”Ÿäº§å’Œæ¶ˆè´¹æ¶ˆæ¯</li><li>æœ‰æ„ä¹‰çš„å†…éƒ¨è°ƒç”¨</li></ul><p>é€šå¸¸åœ¨ä¸€ä¸ªå‡½æ•°å†…éƒ¨å†è°ƒç”¨å…¶ä»–çš„æœ¬åœ°å‡½æ•°æ˜¯ä¸ç”¨åˆ›å»º span çš„ï¼Œä¸ç„¶è¿™ä¸ªé“¾è·¯ä¼šéå¸¸çš„é•¿ã€‚</p><h2 id="Annotations"><a href="#Annotations" class="headerlink" title="Annotations"></a>Annotations</h2><p>å½“ç„¶ä¹Ÿæœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚æˆ‘çš„æŸä¸ªå†…éƒ¨å‡½æ•°éå¸¸é‡è¦ï¼Œéœ€è¦å•ç‹¬å…³å¿ƒå®ƒçš„è°ƒç”¨æ—¶é•¿ã€‚</p><p>æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Annotations æ¥å•ç‹¬åˆ›å»ºè‡ªå·±çš„ Spanã€‚</p><blockquote><p>è¿™ä¸ª Annotations å’Œ Dapper ä¸­çš„ä¸æ˜¯åŒä¸€ä¸ªï¼Œåªæ˜¯ Java ä¸­çš„æ³¨è§£ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> &#123;  </span><br><span class="line">    Executors.newFixedThreadPool(<span class="number">1</span>).execute(() -&gt; &#123;  </span><br><span class="line">        myMethod(request.getName());  </span><br><span class="line">    &#125;);    </span><br><span class="line">    </span><br><span class="line">    <span class="type">HelloReply</span> <span class="variable">reply</span> <span class="operator">=</span> HelloReply.newBuilder()  </span><br><span class="line">            .setMessage(<span class="string">&quot;Hello ==&gt; &quot;</span> + request.getName())  </span><br><span class="line">            .build();  </span><br><span class="line">    responseObserver.onNext(reply);  </span><br><span class="line">    responseObserver.onCompleted();  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@SneakyThrows</span>  </span><br><span class="line"><span class="meta">@WithSpan</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myMethod</span><span class="params">(<span class="meta">@SpanAttribute(&quot;request.name&quot;)</span> String name)</span> &#123;  </span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>);  </span><br><span class="line">    log.info(<span class="string">&quot;myMethod:&#123;&#125;&quot;</span>, name);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥è¿™æ®µä»£ç ä¸ºä¾‹ï¼Œè¿™æ˜¯ä¸€ä¸ª gRPC çš„æœåŠ¡ç«¯æ¥å£ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¸­è°ƒç”¨äº†ä¸€ä¸ªå‡½æ•° <code>myMethod</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹å¹¶ä¸ä¼šä¸ºå®ƒå•ç‹¬åˆ›å»ºä¸€ä¸ª Spanã€‚</p><p>ä½†å¦‚æœæˆ‘ä»¬æƒ³å•ç‹¬è®°å½•å®ƒï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>@WithSpan</code> è¿™ä¸ªæ³¨è§£ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨  <code>@SpanAttribute</code> æ¥è‡ªå®šä¹‰ attributeã€‚</p><p>æœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/05/05/aBd1ubsS2kxMzGf.png"><br>æ­¤æ—¶å°±ä¼šå•ç‹¬ä¸ºè¿™ä¸ªå‡½æ•°åˆ›å»ºä¸€ä¸ª Spanã€‚</p><blockquote><p>éœ€è¦å•ç‹¬å¼•å…¥ä¸€ä¸ªä¾èµ–:</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry.instrumentation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-instrumentation-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="Context-Propagation"><a href="#Context-Propagation" class="headerlink" title="Context Propagation"></a>Context Propagation</h1><p>ä¸Šä¸‹æ–‡ä¼ æ’­ä¹Ÿæ˜¯ Trace ä¸­éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œåˆšæ‰æåˆ°äº†æ¯ä¸ª Span éƒ½æœ‰è‡ªå·±ä¸å¯å˜çš„ä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆåç»­çš„ Span å¦‚ä½•å’Œä¸Šæ¸¸çš„ Span è¿›è¡Œå…³è”å‘¢ï¼Ÿ</p><p>è¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>åŒä¸€è¿›ç¨‹</li><li>å®è¿›ç¨‹</li></ul><h2 id="åŒä¸€è¿›ç¨‹"><a href="#åŒä¸€è¿›ç¨‹" class="headerlink" title="åŒä¸€è¿›ç¨‹"></a>åŒä¸€è¿›ç¨‹</h2><p>åŒä¸€ä¸ªè¿›ç¨‹ä¹Ÿåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ul><li>å•çº¿ç¨‹</li><li>å¤šçº¿ç¨‹</li></ul><p>å•çº¿ç¨‹çš„æ¯”è¾ƒå¥½å¤„ç†ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠæ•°æ®å†™å…¥ <code>ThreadLocal</code> ä¸­å°±å¯ä»¥åšåˆ°çº¿ç¨‹éš”ç¦»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Context&gt; THREAD_LOCAL_STORAGE = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="meta">@Nullable</span>  </span><br><span class="line"><span class="keyword">public</span> Context <span class="title function_">current</span><span class="params">()</span> &#123;  </span><br><span class="line">  <span class="keyword">return</span> THREAD_LOCAL_STORAGE.get();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç‚¹æˆ‘ä»¬å¯ä»¥é€šè¿‡æºç  <code>io.opentelemetry.context.ThreadLocalContextStorage</code>çœ‹åˆ°å…·ä½“çš„å®ç°è¿‡ç¨‹ã€‚</p><p>è€Œå¦‚æœæ˜¯å¤šçº¿ç¨‹æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Executors.newFixedThreadPool(<span class="number">1</span>).execute(() -&gt; &#123;  </span><br><span class="line">    myMethod(request.getName());  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>åˆ™éœ€è¦å¯¹ä½¿ç”¨çš„çº¿ç¨‹æ± è¿›è¡Œå•ç‹¬å¤„ç†ï¼Œå°†çˆ¶çº¿ç¨‹ä¸­ threadlocal ä¸­çš„æ•°æ®æ‹·è´å‡ºæ¥è¿›è¡Œä¼ é€’ï¼Œæ¯”å¦‚æœ‰é˜¿é‡Œæä¾›çš„ <code>TransmittableThreadLocal</code>ï¼Œå¯ä»¥æä¾›å¯¹çº¿ç¨‹æ± çš„æ”¯æŒã€‚</p><h2 id="è·¨è¿›ç¨‹"><a href="#è·¨è¿›ç¨‹" class="headerlink" title="è·¨è¿›ç¨‹"></a>è·¨è¿›ç¨‹</h2><p>è€Œå¦‚æœæ˜¯å®è¿›ç¨‹çš„åœºæ™¯ï¼Œå°±éœ€è¦å°† context çš„ä¿¡æ¯è¿›è¡Œåºåˆ—åŒ–ä¼ é€’ã€‚</p><p>å¦‚æœæ˜¯ gRPC è°ƒç”¨ä¼šå°†ä¿¡æ¯å­˜æ”¾åˆ° metadata ä¸­ã€‚</p><p>HTTP è°ƒç”¨åˆ™æ˜¯å­˜æ”¾åœ¨ header ä¸­ã€‚</p><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯”å¦‚ Pulsar ä¹Ÿå¯ä»¥å°†æ•°æ®å­˜æ”¾åœ¨æ¶ˆæ¯ä¸­çš„ header ä¸­è¿›è¡Œä¼ é€’ã€‚</p><p>æ•°æ®ä¸€æ—¦è·¨è¿›ç¨‹ä¼ è¾“æˆåŠŸåï¼Œå°±å’Œå•è¿›ç¨‹ä¸€æ ·çš„å¤„ç†æ–¹å¼äº†ã€‚</p><h2 id="Baggage"><a href="#Baggage" class="headerlink" title="Baggage"></a>Baggage</h2><p><img src="https://s2.loli.net/2024/05/05/3c6LNtIbSkpQlRU.png"></p><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦é€šè¿‡å® Span ä¼ é€’ä¿¡æ¯ï¼Œæ¯”å¦‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š<br>æˆ‘ä»¬éœ€è¦åœ¨ serverB ä¸­æ‹¿åˆ° serverA ä¸­æ”¶åˆ°çš„ä¸€ä¸ªè¯·æ±‚å‚æ•°ï¼š <code>http://127.0.0.1:8181/request\?name\=1232</code></p><p><img src="https://s2.loli.net/2024/05/05/hISQNv91KP85WFC.png"></p><p>è¿™ä¸ªæ•°æ®é»˜è®¤ä¼šä½œä¸º span çš„ attribute ï¼Œä½†åªä¼šå­˜åœ¨äºç¬¬ä¸€ä¸ª spanã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨åç»­çš„ span ä¸­ä¹Ÿèƒ½æ‹¿åˆ°è¿™ä¸ªæ•°æ®ï¼Œç”šè‡³æ˜¯å®è¿›ç¨‹ä¹Ÿèƒ½è·å–åˆ°ã€‚</p><p>é‚£å°±éœ€è¦ä½¿ç”¨ <code>Baggage</code> è¿™ä¸ªå¯¹è±¡äº†ã€‚</p><p>å®ƒçš„ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line"><span class="comment">// å†™å…¥</span></span><br><span class="line">    Baggage.current().toBuilder().  </span><br><span class="line">          put(<span class="string">&quot;request.name&quot;</span>, name).build()  </span><br><span class="line">          .storeInContext(Context.current()).makeCurrent();</span><br><span class="line">&#125;         </span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–</span></span><br><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> Baggage.current().getEntryValue(<span class="string">&quot;request.name&quot;</span>);  </span><br><span class="line">log.info(<span class="string">&quot;request.name: &#123;&#125;&quot;</span>, value);</span><br></pre></td></tr></table></figure><p>åªè¦æ˜¯å±äºåŒä¸€ä¸ª trace çš„è°ƒç”¨å°±å¯ä»¥ç›´æ¥è·å–åˆ°æ•°æ®ã€‚<br><img src="https://s2.loli.net/2024/05/05/Lz1hY8pflRebANx.png"></p><blockquote><p>traceId ä¹Ÿæ˜¯å® Span ä¼ é€’çš„ã€‚</p></blockquote><p>è€Œå®ƒçš„åŸç†ä¹Ÿæ˜¯é€šè¿‡å¾€ context ä¸­å†™å…¥æ•°æ®å®ç°çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Immutable</span>  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaggageContextKey</span> &#123;  </span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> ContextKey&lt;Baggage&gt; KEY = ContextKey.named(<span class="string">&quot;opentelemetry-baggage-key&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">BaggageContextKey</span><span class="params">()</span> &#123;&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/05/05/vIHtBxGATKOg13l.png"><br>è€Œè¿™ä¸ª context æ˜¯é€šè¿‡ä¸€ä¸ª entries æ•°æ®å­˜å‚¨æ•°æ®çš„ï¼Œä¸ç®¡æ˜¯åœ¨å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨çš„è·¨è¿›ç¨‹è°ƒç”¨ï¼ŒOpenTelemetry éƒ½ä¼šå°† context é€šè¿‡ <code>Context Propagation</code> ä¼ é€’å‡ºå»ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>Trace è¿™éƒ¨åˆ†çš„å†…å®¹æˆ‘è§‰å¾—æ¯” Metrics å’Œ Logs æ›´åŠ å¤æ‚ä¸€äº›ï¼Œæ¯•ç«Ÿå¤šäº†ä¸€äº›æ•°æ®ç»“æ„ï¼›ç°åœ¨çš„å†…å®¹ä¹Ÿåªæ˜¯å†°å±±ä¸€è§’ï¼Œç°åœ¨ä¹Ÿåœ¨åš trace çš„ä¸€äº›å®šåˆ¶åŒ–å¼€å‘ï¼Œåç»­æœ‰æ–°çš„è¿›å±•ä¼šæ¥ç€æ›´æ–°ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/papers/dapper-2010-1.pdf">https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/papers/dapper-2010-1.pdf</a></li><li><a href="https://opentelemetry.io/docs/languages/java/automatic/annotations/">https://opentelemetry.io/docs/languages/java/automatic/annotations/</a></li><li><a href="https://opentelemetry.io/docs/specs/otel/overview/#tracing-signal">https://opentelemetry.io/docs/specs/otel/overview/#tracing-signal</a></li><li><a href="https://opentelemetry.io/docs/concepts/context-propagation/">https://opentelemetry.io/docs/concepts/context-propagation/</a></li><li><a href="https://opentelemetry.io/docs/concepts/observability-primer/#distributed-traces">https://opentelemetry.io/docs/concepts/observability-primer/#distributed-traces</a></li><li><a href="https://tech.meituan.com/2023/04/20/traceid-google-dapper-mtrace.html">https://tech.meituan.com/2023/04/20/traceid-google-dapper-mtrace.html</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨ä¹‹å‰å†™è¿‡ä¸¤ç¯‡æ¯”è¾ƒç³»ç»Ÿçš„å…³äº OpenTelemetry çš„æ–‡ç« ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7358450927110357026&quot;&gt;OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7360216766373068837&quot;&gt;å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»åŸºæœ¬æ¦‚å¿µåˆ°å¦‚ä½•éƒ¨ç½² demo å®æˆ˜äº†è§£ OpenTelemetryï¼Œä»é‚£ä¸ª demo ä¸­ä¹Ÿå¯ä»¥å¾—çŸ¥æ•´ä¸ª OpenTelemetry ä½“ç³»çš„å¤æ‚æ€§ï¼ŒåŒ…å«äº†å¤ªå¤šçš„ç»„ä»¶å’Œæ¦‚å¿µã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†èƒ½æ›´æ¸…æ™°çš„äº†è§£æ¯ä¸ªå…³é”®ç»„ä»¶çš„ä½œç”¨ä»¥åŠåŸç†ï¼Œæˆ‘æ‰“ç®—åˆ†ä¸ºå‡ æœŸæ¥è®²è§£ OpenTelemetry çš„ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Trace&lt;/li&gt;
&lt;li&gt;Metrics&lt;/li&gt;
&lt;li&gt;Logs&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é¦–å…ˆä»¥ Trace è®²èµ·ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>ã€è¯‘ã€‘å‡ ä¸ªä½ æˆ–è®¸å¹¶ä¸çŸ¥é“ kubernetes æŠ€å·§</title>
    <link href="http://crossoverjie.top/2024/06/03/ob/Kubernetes-tricks/"/>
    <id>http://crossoverjie.top/2024/06/03/ob/Kubernetes-tricks/</id>
    <published>2024-06-03T10:05:25.000Z</published>
    <updated>2024-06-03T13:10:27.508Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2024/06/03/AoNyHhS4sl96tFx.png"></p><p>åŸæ–‡é“¾æ¥: <a href="https://overcast.blog/13-kubernetes-tricks-you-didnt-know-647de6364472">https://overcast.blog/13-kubernetes-tricks-you-didnt-know-647de6364472</a></p><h1 id="ä½¿ç”¨-PreStop-ä¼˜é›…å…³é—­-Pod"><a href="#ä½¿ç”¨-PreStop-ä¼˜é›…å…³é—­-Pod" class="headerlink" title="ä½¿ç”¨ PreStop ä¼˜é›…å…³é—­ Pod"></a>ä½¿ç”¨ PreStop ä¼˜é›…å…³é—­ Pod</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">graceful-shutdown-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sample-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 30 &amp;&amp; nginx -s quit&quot;</span>]</span><br></pre></td></tr></table></figure><p>PreStop å…è®¸ Pod åœ¨ç»ˆæ­¢å‰æ‰§è¡Œä¸€ä¸ªå‘½ä»¤æˆ–è€…æ˜¯è„šæœ¬ï¼Œä½¿ç”¨å®ƒå°±å¯ä»¥åœ¨åº”ç”¨é€€å‡ºå‰é‡Šæ”¾ä¸€äº›èµ„æºï¼Œç¡®ä¿åº”ç”¨å¯ä»¥ä¼˜é›…é€€å‡ºã€‚</p><p>æ¯”å¦‚å¯ä»¥åœ¨ Nginx çš„ Pod é€€å‡ºå‰å°†å½“å‰çš„è¯·æ±‚æ‰§è¡Œå®Œæ¯•ã€‚</p><span id="more"></span><h1 id="ä½¿ç”¨ä¸´æ—¶å®¹å™¨è°ƒè¯•-Pod"><a href="#ä½¿ç”¨ä¸´æ—¶å®¹å™¨è°ƒè¯•-Pod" class="headerlink" title="ä½¿ç”¨ä¸´æ—¶å®¹å™¨è°ƒè¯• Pod"></a>ä½¿ç”¨ä¸´æ—¶å®¹å™¨è°ƒè¯• Pod</h1><p>ä¸´æ—¶å®¹å™¨å¯ä»¥ä¸ä¿®æ”¹ä¸€ä¸ªè¿è¡Œçš„å®¹å™¨çš„å‰æä¸‹è°ƒè¯•å®¹å™¨ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è°ƒè¯•ä¸€äº›ç”Ÿäº§ç¯å¢ƒçš„ bugï¼Œå¯ä»¥é¿å…é‡å¯åº”ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl alpha debug -it podname --image=busybox --target=containername</span><br></pre></td></tr></table></figure><p>ç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨ï¼Œåªæœ‰åœ¨å½“å‰ç¯å¢ƒä¸‹æ— æ³•æ’æŸ¥é—®é¢˜çš„æ—¶å€™æ‰ä½¿ç”¨ã€‚</p><h1 id="åŸºäºè‡ªå®šä¹‰çš„-Metrics-è‡ªåŠ¨æ‰©å®¹Pod"><a href="#åŸºäºè‡ªå®šä¹‰çš„-Metrics-è‡ªåŠ¨æ‰©å®¹Pod" class="headerlink" title="åŸºäºè‡ªå®šä¹‰çš„  Metrics è‡ªåŠ¨æ‰©å®¹Pod"></a>åŸºäºè‡ªå®šä¹‰çš„  Metrics è‡ªåŠ¨æ‰©å®¹Pod</h1><p>kubernetes æ˜¯æä¾›äº† HPA æœºåˆ¶å¯ä»¥è·Ÿè¿› CPU å†…å­˜ç­‰æ ‡å‡†æ•°æ®è¿›è¡Œè‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬éœ€è¦æ ¹æ®è‡ªå®šä¹‰çš„æ•°æ®è¿›è¡Œæ‰©ç¼©å®¹ã€‚</p><p>æ¯”å¦‚æŸä¸ªæ¥å£çš„å»¶è¿Ÿã€é˜Ÿåˆ—å¤§å°ç­‰ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">custom-metric-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">your-application</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span></span><br><span class="line">    <span class="attr">pods:</span></span><br><span class="line">      <span class="attr">metric:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">your_custom_metric</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">AverageValue</span></span><br><span class="line">        <span class="attr">averageValue:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><h1 id="ç”¨-Init-Containers-é…ç½®å¯åŠ¨è„šæœ¬"><a href="#ç”¨-Init-Containers-é…ç½®å¯åŠ¨è„šæœ¬" class="headerlink" title="ç”¨ Init Containers é…ç½®å¯åŠ¨è„šæœ¬"></a>ç”¨ Init Containers é…ç½®å¯åŠ¨è„šæœ¬</h1><p>åˆå§‹åŒ–å®¹å™¨å¯ä»¥åœ¨åº”ç”¨å®¹å™¨å¯åŠ¨å‰è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥åˆå§‹åŒ–åº”ç”¨éœ€è¦çš„é…ç½®ã€ç­‰å¾…ä¾èµ–çš„æœåŠ¡å¯åŠ¨å®Œæˆç­‰å·¥ä½œï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-myservice</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until nslookup myservice; do echo waiting for myservice; sleep 2; done;&#x27;</span>]</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™ä¸ªåˆå§‹åŒ–å®¹å™¨ä¼šç­‰å¾… myservice å¯ç”¨åæ‰ä¼šå¯åŠ¨åº”ç”¨ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœåˆå§‹åŒ–å®¹å™¨ä¼šé˜»å¡åº”ç”¨å¯åŠ¨ï¼Œæ‰€ä»¥è¦é¿å…åœ¨åˆå§‹åŒ–å®¹å™¨é‡Œæ‰§è¡Œè€—æ—¶æ“ä½œã€‚</p><h1 id="Node-äº²å’Œæ€§è°ƒåº¦"><a href="#Node-äº²å’Œæ€§è°ƒåº¦" class="headerlink" title="Node äº²å’Œæ€§è°ƒåº¦"></a>Node äº²å’Œæ€§è°ƒåº¦</h1><p>å½“æˆ‘ä»¬éœ€è¦å°†æŸäº›åº”ç”¨éƒ¨ç½²åˆ°ç¡¬ä»¶é…ç½®è¾ƒé«˜çš„èŠ‚ç‚¹æ—¶ï¼ˆæ¯”å¦‚éœ€è¦ SSD ç¡¬ç›˜ï¼‰ï¼Œå°±å¯ä»¥ä½¿ç”¨èŠ‚ç‚¹äº²å’Œæ€§æ¥éƒ¨ç½²åº”ç”¨ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">disktype</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ª Pod ä¼šè¢«éƒ¨ç½²åˆ°æœ‰è¿™ä¸ª <code>disktype=ssd</code> æ ‡ç­¾çš„ èŠ‚ç‚¹ä¸Šã€‚</p><h1 id="åŠ¨æ€é…ç½®ï¼šConfigMap-å’Œ-Secrets"><a href="#åŠ¨æ€é…ç½®ï¼šConfigMap-å’Œ-Secrets" class="headerlink" title="åŠ¨æ€é…ç½®ï¼šConfigMap å’Œ Secrets"></a>åŠ¨æ€é…ç½®ï¼šConfigMap å’Œ Secrets</h1><p>ConfigMap å’Œ Secretså¯ä»¥åŠ¨æ€æ³¨å…¥åˆ° Pod ä¸­ï¼Œé¿å…å¯¹è¿™äº›é…ç½®ç¡¬ç¼–ç ã€‚</p><p>ConfigMap é€‚åˆéæ•æ„Ÿçš„æ•°æ®ï¼ŒSecrets é€‚åˆæ•æ„Ÿçš„æ•°æ®ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ConfigMap Example</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;key&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">      &quot;databaseURL&quot;: &quot;http://mydatabase.example.com&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="comment"># Pod Spec using ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">app-config</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·åœ¨åº”ç”¨ä¸­å°±å¯ä»¥é€šè¿‡è¿™è·¯å¾„ <code>/etc/config/config.json</code> è¯»å–æ•°æ®äº†ã€‚</p><blockquote><p>å½“ç„¶ä¹Ÿå¯ä»¥æŠŠè¿™äº›æ•°æ®å†™å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­ã€‚</p></blockquote><p>ä»¥ä¸Šè¿™äº›ä¸ªäººæŠ€å·§ç”¨çš„æœ€å¤šçš„æ˜¯ï¼š</p><ul><li>ä¸´æ—¶å®¹å™¨è°ƒè¯• Podï¼Œç‰¹åˆ«æ˜¯ä¸šåŠ¡å®¹å™¨ç¼ºå°‘ä¸€äº›å‘½ä»¤æ—¶ã€‚</li><li>Init Container ç­‰å¾…ä¾èµ–çš„æœåŠ¡å¯åŠ¨å®Œæˆã€‚</li><li>Node äº²å’Œæ€§è°ƒåº¦ã€‚</li><li>ConfigMap æ˜¯åŸºç¡€æ“ä½œäº†ã€‚</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/06/03/AoNyHhS4sl96tFx.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;åŸæ–‡é“¾æ¥: &lt;a href=&quot;https://overcast.blog/13-kubernetes-tricks-you-didnt-know-647de6364472&quot;&gt;https://overcast.blog/13-kubernetes-tricks-you-didnt-know-647de6364472&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;ä½¿ç”¨-PreStop-ä¼˜é›…å…³é—­-Pod&quot;&gt;&lt;a href=&quot;#ä½¿ç”¨-PreStop-ä¼˜é›…å…³é—­-Pod&quot; class=&quot;headerlink&quot; title=&quot;ä½¿ç”¨ PreStop ä¼˜é›…å…³é—­ Pod&quot;&gt;&lt;/a&gt;ä½¿ç”¨ PreStop ä¼˜é›…å…³é—­ Pod&lt;/h1&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;graceful-shutdown-example&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;sample-container&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;image:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;nginx&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;lifecycle:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attr&quot;&gt;preStop:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;exec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attr&quot;&gt;command:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&amp;quot;/bin/sh&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;-c&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;sleep 30 &amp;amp;&amp;amp; nginx -s quit&amp;quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;PreStop å…è®¸ Pod åœ¨ç»ˆæ­¢å‰æ‰§è¡Œä¸€ä¸ªå‘½ä»¤æˆ–è€…æ˜¯è„šæœ¬ï¼Œä½¿ç”¨å®ƒå°±å¯ä»¥åœ¨åº”ç”¨é€€å‡ºå‰é‡Šæ”¾ä¸€äº›èµ„æºï¼Œç¡®ä¿åº”ç”¨å¯ä»¥ä¼˜é›…é€€å‡ºã€‚&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚å¯ä»¥åœ¨ Nginx çš„ Pod é€€å‡ºå‰å°†å½“å‰çš„è¯·æ±‚æ‰§è¡Œå®Œæ¯•ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/"/>
    
    <category term="kubernetes" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="http://crossoverjie.top/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯</title>
    <link href="http://crossoverjie.top/2024/05/26/ob/OTel-demo/"/>
    <id>http://crossoverjie.top/2024/05/26/ob/OTel-demo/</id>
    <published>2024-05-26T02:49:02.000Z</published>
    <updated>2024-05-26T11:35:45.037Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://crossoverjie.top/2024/05/21/ob/OpenTelemetry-getstart/">OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ</a>ä¸­å›é¡¾äº†å¯è§‚æµ‹æ€§çš„å†å²ä»¥åŠä»‹ç»äº†ä¸€äº› OpenTelemetry çš„åŸºç¡€æ¦‚å¿µï¼ŒåŒæ—¶ä¹Ÿä»‹ç»äº† OpenTelemetry ç¤¾åŒºå¸¸ç”¨çš„å¼€æºé¡¹ç›®ã€‚</p><p>åŸºç¡€èƒŒæ™¯çŸ¥è¯†äº†è§£åï¼Œè¿™ç¯‡å°±æ¥ä»‹ç»ä¸€ä¸‹ä½¿ç”¨ OpenTelemetry å¦‚ä½•å®æˆ˜éƒ¨ç½²åº”ç”¨ï¼ŒåŒæ—¶åœ¨ä¸€ä¸ªå¯è§†åŒ–é¡µé¢æŸ¥çœ‹ traceã€metric ç­‰ä¿¡æ¯ã€‚</p><span id="more"></span><h1 id="é¡¹ç›®ä»‹ç»"><a href="#é¡¹ç›®ä»‹ç»" class="headerlink" title="é¡¹ç›®ä»‹ç»"></a>é¡¹ç›®ä»‹ç»</h1><p>æˆ‘ä»¬å‚è€ƒå®˜æ–¹æ–‡æ¡£æ„å»ºå‡ ä¸ª spring boot ã€Golang é¡¹ç›®å†é…åˆ Agent å…¶å®ä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿çš„é›†æˆ OpenTelemetryã€‚</p><p>ä½†æ˜¯è¦å®Œæ•´çš„ä½“éªŒ OpenTelemetry çš„æ‰€æœ‰åŠŸèƒ½ï¼ŒåŒ…å« traceã€logsã€metricsï¼Œè¿˜æœ‰ç¤¾åŒºè¿™ä¹ˆå¤šè¯­è¨€çš„æ”¯æŒå…¶å®è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚</p><p>æˆ‘ä»¬è¿˜éœ€è¦å•ç‹¬éƒ¨ç½² collectorã€å­˜å‚¨çš„ backend service ç­‰ç»„ä»¶ã€åŒ…æ‹¬ trace UI å±•ç¤ºæ‰€éœ€è¦çš„ Jaegerï¼Œmetric æ‰€éœ€è¦çš„ grafana ç­‰ã€‚</p><p>è¿™äº›æ‰€æœ‰ä¸œè¥¿éƒ½è‡ªå·±ä»å¤´å¼„çš„è¯è¿˜æ˜¯æ¯”è¾ƒè´¹æ—¶ï¼Œä¸è¿‡å¥½åœ¨ç¤¾åŒºå·²ç»å°†è¿™äº›æ­¥éª¤éƒ½è€ƒè™‘åˆ°äº†ã€‚</p><p>ç‰¹åœ°ä¸ºå¤§å®¶å†™äº†ä¸€ä¸ª <a href="https://github.com/open-telemetry/opentelemetry-demo">opentelemetry-demo</a>ã€‚</p><p>è¿™ä¸ªé¡¹ç›®æ¨¡æ‹Ÿäº†ä¸€ä¸ªå¾®æœåŠ¡ç‰ˆæœ¬çš„ç”µå­å•†åŸï¼Œä¸»è¦åŒ…å«äº†ä»¥ä¸‹ä¸€äº›é¡¹ç›®ï¼š</p><table><thead><tr><th>Service</th><th>Language</th><th>Description</th></tr></thead><tbody><tr><td><a href="accounting/">accountingservice</a></td><td>Go</td><td>å¤„ç†å’Œè®¡ç®—è®¢å•æ•°æ®</td></tr><tr><td><a href="ad/">adservice</a></td><td>Java</td><td>å¹¿å‘ŠæœåŠ¡</td></tr><tr><td><a href="cart/">cartservice</a></td><td>.NET</td><td>è´­ç‰©è½¦æœåŠ¡ï¼Œä¸»è¦ä¼šä¾èµ– Redis</td></tr><tr><td><a href="checkout/">checkoutservice</a></td><td>Go</td><td>checkout</td></tr><tr><td><a href="currency/">currencyservice</a></td><td>C++</td><td>è´§å¸è½¬æ¢æœåŠ¡ï¼Œæä¾›äº†è¾ƒé«˜çš„ QPS èƒ½åŠ›ã€‚</td></tr><tr><td><a href="email/">emailservice</a></td><td>Ruby</td><td>é‚®ä»¶æœåŠ¡</td></tr><tr><td><a href="fraud-detection/">frauddetectionservice</a></td><td>Kotlin</td><td>é£æ§æœåŠ¡</td></tr><tr><td><a href="frontend/">frontend</a></td><td>JavaScript</td><td>å‰ç«¯åº”ç”¨</td></tr><tr><td><a href="load-generator/">loadgenerator</a></td><td>Python&#x2F;Locust</td><td>æ¨¡æ‹Ÿå‹æµ‹æœåŠ¡</td></tr><tr><td><a href="payment/">paymentservice</a></td><td>JavaScript</td><td>æ”¯ä»˜æœåŠ¡</td></tr><tr><td><a href="product-catalog/">productcatalogservice</a></td><td>Go</td><td>å•†å“æœåŠ¡</td></tr><tr><td><a href="quote/">quoteservice</a></td><td>PHP</td><td>æˆæœ¬æœåŠ¡</td></tr><tr><td><a href="recommendation/">recommendationservice</a></td><td>Python</td><td>æ¨èæœåŠ¡</td></tr><tr><td><a href="shipping/">shippingservice</a></td><td>Rust</td><td>shipping service</td></tr><tr><td>å¯ä»¥å‘ç°åœ¨è¿™ä¸ª demo ä¸­æä¾›äº†è®¸å¤šçš„æœåŠ¡ï¼Œè€Œä¸”åŒ…å«äº†å‡ ä¹æ‰€æœ‰ä¸»æµçš„è¯­è¨€ï¼Œå¯ä»¥å¾ˆå¥½çš„æ¨¡æ‹Ÿæˆ‘ä»¬å®é™…çš„ä½¿ç”¨åœºæ™¯äº†ã€‚</td><td></td><td></td></tr></tbody></table><p><img src="https://s2.loli.net/2024/04/20/NahleoLGbv9tSuE.png"></p><p>é€šè¿‡è¿™å¼ å›¾å¯ä»¥æ›´ç›´è§‚çš„æŸ¥çœ‹å„ä¸ªæœåŠ¡ä¹‹é—´çš„å…³ç³»ã€‚</p><p>æ•´ä½“æ¥è¯´å‰ç«¯æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šé€šè¿‡ <code>front-end-proxy</code> è¿™ä¸ªç»„ä»¶ä»£ç†ï¼Œæœ€ç»ˆå†ç”± front è¿™ä¸ªæœåŠ¡è¿›è¡Œè½¬å‘åˆ°ä¸åŒçš„åç«¯æœåŠ¡ä¸­ã€‚</p><hr><p><img src="https://s2.loli.net/2024/04/20/wLVI1mSzYKjt2Fo.png"><br>é™¤äº†ä¸€ä¸ªé¡¹ç›®çš„æ¶æ„å›¾ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå…³äº OpenTelemetry çš„æ•°æ®æµè½¬å›¾ã€‚</p><p>åœ¨ OpenTelemetry ä¸­æ•°æ®æµè½¬æ˜¯å®ƒçš„ç‰¹ç‚¹ä¹Ÿæ˜¯éå¸¸é‡è¦çš„æ ¸å¿ƒï¼Œè¿™ç‚¹åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è®²è¿‡ï¼Œç”¨æˆ·å¯ä»¥è‡ªç”±å®šåˆ¶æ•°æ®çš„æµè½¬ä»¥åŠä»»æ„çš„å¤„ç†æ•°æ®ï¼Œåœ¨è¿™ä¸ªå›¾ä¸­å°±å°†æ•°æ®æµè½¬å¯è§†åŒ–äº†ã€‚</p><ul><li>å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ OTLP åè®®æˆ–è€…æ˜¯ HTTP å°†æ•°æ®ä¸Šä¼ åˆ° OTel Collector ä¸­ã€‚</li><li>åœ¨ collector ä¸­ä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„ Process pipeline å¤„ç†æ•°æ®ã€‚</li><li>Metric æ•°æ®é€šè¿‡  OTLP HTTP exporter å°†æ•°æ®å¯¼å…¥åˆ° Prometheus ä¸­ã€‚<ul><li><a href="https://github.com/prometheus/prometheus/pull/12571">Prometheus</a> å·²ç»äº 23 å¹´ä¸ƒæœˆä»½æ”¯æŒ OTLP æ ¼å¼çš„ metric æ•°æ®å¯¼å…¥äº†ã€‚</li></ul></li><li>Trace æ•°æ®åˆ™æ˜¯é€šè¿‡ OTLP Exporter å†™å…¥åˆ° Jaeger ä¸­è¿›è¡Œå­˜å‚¨ï¼Œæœ€åé€šè¿‡ Jaeger çš„ UI è¿›è¡ŒæŸ¥è¯¢å±•ç¤ºã€‚</li><li>è€Œå­˜å…¥ Prometheus ä¸­çš„ metric æ•°æ®åˆ™æ˜¯æœ‰ grafana è¿›è¡ŒæŸ¥è¯¢ã€‚</li></ul><blockquote><p>å…³äº collector çš„é…ç½®ä¼šåœ¨åæ–‡è®²è§£ã€‚</p></blockquote><h1 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h1><p>æ¥ä¸‹æ¥ä¾¿æ˜¯å®‰è£… Demo äº†ï¼Œæˆ‘æ›´æ¨èä½¿ç”¨ helm å®‰è£…ã€‚</p><p>è¿™é‡Œçš„ç‰ˆæœ¬è¦æ±‚æ˜¯ï¼š</p><ul><li>Kubernetes 1.24+</li><li>Helm 3.9+</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts</span><br><span class="line">helm repo update</span><br><span class="line">helm install my-otel-demo open-telemetry/opentelemetry-demo</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥å¾ˆç®€å•çš„å°† demo æ‰€æ¶‰åŠåˆ°çš„æ‰€æœ‰ç»„ä»¶å’ŒæœåŠ¡éƒ½å®‰è£…åˆ° default å‘½åç©ºé—´ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm show values open-telemetry/opentelemetry-demo &gt; demo.yaml</span><br></pre></td></tr></table></figure><p>ä¸è¿‡åœ¨å®‰è£…å‰è¿˜æ˜¯å»ºè®®å…ˆå¯¼å‡ºä¸€ä»½ value.yamlï¼Œä¹‹åå¯ä»¥ä½¿ç”¨è¿™ä¸ª yaml å®šåˆ¶éœ€è¦å®‰è£…çš„ç»„ä»¶ã€‚</p><p>åœ¨è¿™ä¸ª yaml ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰å“ªäº›ç»„ä»¶å’ŒæœåŠ¡å¯ä»¥å®šåˆ¶ï¼š<br><img src="https://s2.loli.net/2024/04/20/oe2S1fr3xPcypB4.png"><br>å¯ä»¥çœ‹åˆ°è¿™é‡ŒåŒ…å«äº†æˆ‘ä»¬åˆšæ‰æåˆ°çš„æ‰€æœ‰æœåŠ¡ï¼Œä»¥åŠè¿™äº›æœåŠ¡æ‰€ä¾èµ–çš„ Kafkaã€redisã€Prometheus ç­‰ä¸­é—´ä»¶ï¼Œéƒ½å¯ä»¥è‡ªå·±è¿›è¡Œå®šåˆ¶ä¿®æ”¹ã€‚</p><p><img src="https://s2.loli.net/2024/04/20/VP5GvtszWolSBnf.png"><br>å½“æ‰€æœ‰çš„ Pod éƒ½æˆåŠŸè¿è¡Œä¹‹åè¡¨ç¤ºå®‰è£…æˆåŠŸã€‚</p><blockquote><p>æ­£å¸¸æƒ…å†µä¸‹å®‰è£…ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæœ€å¤§å¯èƒ½çš„é—®é¢˜å°±æ˜¯é•œåƒæ‹‰å–å¤±è´¥ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å…ˆåœ¨æœ¬åœ°æ‰‹åŠ¨ docker pull ä¸‹æ¥é•œåƒåå†ä¸Šä¼ åˆ°ç§æœï¼Œç„¶åä¿®æ”¹ deployment ä¸­çš„é•œåƒåœ°å€å³å¯ã€‚</p></blockquote><h2 id="æš´éœ²æœåŠ¡"><a href="#æš´éœ²æœåŠ¡" class="headerlink" title="æš´éœ²æœåŠ¡"></a>æš´éœ²æœåŠ¡</h2><p>ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ª demo è¿›è¡Œæµ‹è¯•ï¼Œè¿˜éœ€è¦å°† front-proxy çš„æœåŠ¡æš´éœ²å‡ºæ¥å¯ä»¥åœ¨æœ¬åœ°è®¿é—®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl port-forward svc/my-otel-demo-frontendproxy 8080:8080</span><br></pre></td></tr></table></figure><table><thead><tr><th>Component</th><th>Path</th></tr></thead><tbody><tr><td>Shop é¦–é¡µ</td><td><a href="http://localhost:8080/">http://localhost:8080</a></td></tr><tr><td>Grafana</td><td><a href="http://localhost:8080/grafana">http://localhost:8080/grafana</a></td></tr><tr><td>å‹æµ‹é¡µé¢</td><td><a href="http://localhost:8080/loadgen">http://localhost:8080/loadgen</a></td></tr><tr><td>Jaeger UI</td><td><a href="http://localhost:8080/jaeger/ui">http://localhost:8080/jaeger/ui</a></td></tr><tr><td>æ­£å¸¸æƒ…å†µä¸‹å°±å¯ä»¥æ‰“å¼€è¿™äº›é¡µé¢è¿›è¡Œè®¿é—®äº†ã€‚</td><td></td></tr></tbody></table><p>ä¸è¿‡ä½¿ç”¨ port-forward è½¬å‘çš„æ–¹å¼åªæ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼Œä½¿ç”¨ ctrl+c å°±ä¼šåœæ­¢æš´éœ²æœåŠ¡ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦ä¸€ä¸ªç¨³å®šçš„è®¿é—®é“¾æ¥æ—¶ä¾¿å¯ä»¥é…ç½®ä¸€ä¸ª ingressã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">components:</span></span><br><span class="line">  <span class="attr">frontendProxy:</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">annotations:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">otel-demo.my-domain.com</span></span><br><span class="line">          <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨ä¹‹å‰çš„ helm çš„ value.yaml ä¸­é…ç½®å³å¯ï¼Œæœ¬åœ°æµ‹è¯•çš„è¯éœ€è¦å°†è¿™ä¸ª host å’Œ ingress æš´éœ²å‡ºæ¥çš„ IP è¿›è¡Œç»‘å®šæ‰å¯ä»¥ä½¿ç”¨è¿™ä¸ªåŸŸåæœºè¿›è¡Œè®¿é—®ã€‚</p><p>æ›´å¤šå…³äº ingress çš„ä½¿ç”¨å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« ï¼š</p><ul><li><a href="https://crossoverjie.top/2023/09/15/ob/k8s-Ingress/">k8så…¥é—¨åˆ°å®æˆ˜-ä½¿ç”¨Ingress</a></li></ul><p>å½“ç„¶ç®€å•èµ·è§ä¹Ÿå¯ä»¥ç›´æ¥å°† front-proxy çš„ service ç±»å‹æ”¹ä¸º LoadBalancerã€‚ï¼ˆé»˜è®¤æ˜¯ ClusterIP åªå¯ä»¥åœ¨é›†ç¾¤å†…è®¿é—®ï¼‰</p><p>è¿™æ ·å°±å¯ä»¥ç›´æ¥é€šè¿‡è¿™ä¸ª service çš„ IP è¿›è¡Œè®¿é—®äº†ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">components:</span></span><br><span class="line">  <span class="attr">frontendProxy:</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœ demo å®‰è£…å®Œæˆä¹‹åæ˜¯ä¸å¯ä»¥å†æ¬¡ä¿®æ”¹ service çš„ç±»å‹çš„ï¼Œéœ€è¦æ‰‹åŠ¨è¿™ä¸ª service åˆ æ‰ä¹‹åå†æ¬¡æ–°å»ºæ‰å¯ä»¥ã€‚</p></blockquote><p> ä¸´æ—¶æµ‹è¯•ä½¿ç”¨çš„è¯è¿˜æ˜¯æ¨èç›´æ¥ä½¿ç”¨ port-forward è¿›è¡Œè½¬å‘ã€‚</p><h1 id="æŸ¥çœ‹-Trace"><a href="#æŸ¥çœ‹-Trace" class="headerlink" title="æŸ¥çœ‹ Trace"></a>æŸ¥çœ‹ Trace</h1><p>é€šè¿‡ä¹‹å‰çš„é¡¹ç›®æ¶æ„å›¾å¯ä»¥å¾—çŸ¥ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®é¦–é¡µåˆ·æ–°ä¼šç›´æ¥è¯·æ±‚ AdService æ¥è·å–å¹¿å‘Šã€‚</p><p>ä¸ºäº†ç®€å•èµ·è§æˆ‘ä»¬åªæŸ¥è¯¢è¿™ä¸€é“¾è·¯çš„è°ƒç”¨æƒ…å†µï¼š<br><img src="https://s2.loli.net/2024/04/21/t6a4KvOhSne9yfu.png"></p><p>æ‰“å¼€ <a href="http://localhost:8080/jaeger/ui/search">http://localhost:8080/jaeger/ui/search</a> Jeager çš„ UI é¡µé¢ä¾¿å¯ä»¥ç­›é€‰æœåŠ¡ï¼Œä¹‹åç‚¹å‡»æŸ¥æ‰¾ Traces å°±å¯ä»¥åˆ—å‡ºä¸€æ®µæ—¶é—´å†…çš„è®¿é—® traceã€‚</p><p><img src="https://s2.loli.net/2024/04/21/v8nVLxweyCO9NMm.png"><br>å¯ä»¥çœ‹åˆ°è¿™ä¸ªè¯·æ±‚é“¾è·¯æ˜¯ä»å‰ç«¯è®¿é—®åˆ° adService ä¸­çš„ <code>getAds()</code>æ¥å£ï¼Œç„¶ååœ¨è¿™ä¸ªæ¥å£ä¸­å†è®¿é—®äº† <code>getAdsByCategory</code> å‡½æ•°ã€‚<br><img src="https://s2.loli.net/2024/04/21/3UXmHsCSLFguRZK.png"></p><p>æœ€ç»ˆåœ¨æºç ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ç¬¦åˆé“¾è·¯çš„è°ƒç”¨ä»£ç ã€‚</p><blockquote><p>åœ¨åˆšæ‰çš„é“¾è·¯å›¾çš„å³ä¸‹è§’æœ‰ä¸€ä¸ª spanIDï¼Œæ•´ä¸ª trace æ˜¯ç”±è¿™äº›å°çš„ span ç»„æˆï¼Œæ¯ä¸€ä¸ª span ä¹Ÿä¼šæœ‰å”¯ä¸€ spanIDï¼› trace ä¹Ÿä¼šæœ‰ä¸€ä¸ª traceID å°†è¿™äº› span ä¸²è”èµ·æ¥ï¼›æ›´å¤šå…³äº trace çš„å†…å®¹ä¼šåœ¨åé¢çš„æ–‡ç« è¿›è¡Œåˆ†æã€‚</p></blockquote><h2 id="æŸ¥çœ‹-Metrics"><a href="#æŸ¥çœ‹-Metrics" class="headerlink" title="æŸ¥çœ‹ Metrics"></a>æŸ¥çœ‹ Metrics</h2><p>æˆ‘ä»¬å†æ‰“å¼€ grafana ä¾¿å¯ä»¥çœ‹åˆ°åˆšæ‰è®¿é—®çš„ adService çš„å»¶è¿Ÿå’Œæ¥å£çš„ QPS æƒ…å†µï¼š<br><img src="https://s2.loli.net/2024/04/21/29BlRATOnpkCQwS.png"></p><hr><p>åœ¨opentelemetry-collector-data-flow é¢æ¿ä¸­è¿˜å¯ä»¥çœ‹åˆ° OpenTelemetry çš„æ•°æ®æµè½¬ã€‚<br><img src="https://s2.loli.net/2024/04/21/Tbtiv3gzY5xZIH1.png"></p><blockquote><p>æ›´å¤šç›‘æ§ä¿¡æ¯å¯ä»¥æŸ¥çœ‹å…¶å®ƒçš„é¢æ¿ã€‚</p></blockquote><p>è€Œåˆšæ‰é¢æ¿ä¸­çš„æ•°æ®æµè½¬è§„åˆ™åˆ™æ˜¯åœ¨æˆ‘ä»¬çš„ <a href="https://github.com/open-telemetry/opentelemetry-demo/blob/main/src/otelcollector/otelcol-config.yml">collector</a> ä¸­è¿›è¡Œé…ç½®çš„ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">protocols:</span></span><br><span class="line">      <span class="attr">grpc:</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">cors:</span></span><br><span class="line">          <span class="attr">allowed_origins:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;http://*&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;https://*&quot;</span></span><br><span class="line">  <span class="attr">httpcheck/frontendproxy:</span></span><br><span class="line">    <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">endpoint:</span> <span class="string">http://frontendproxy:$&#123;env:ENVOY_PORT&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">debug:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">&quot;jaeger:4317&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">otlphttp/prometheus:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">&quot;http://prometheus:9090/api/v1/otlp&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">opensearch:</span></span><br><span class="line">    <span class="attr">logs_index:</span> <span class="string">otel</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">endpoint:</span> <span class="string">&quot;http://opensearch:9200&quot;</span></span><br><span class="line">      <span class="attr">tls:</span></span><br><span class="line">        <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="attr">batch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">connectors:</span></span><br><span class="line">  <span class="attr">spanmetrics:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">traces:</span></span><br><span class="line">      <span class="attr">receivers:</span> [<span class="string">otlp</span>]</span><br><span class="line">      <span class="attr">processors:</span> [<span class="string">batch</span>]</span><br><span class="line">      <span class="attr">exporters:</span> [<span class="string">otlp</span>, <span class="string">debug</span>, <span class="string">spanmetrics</span>]</span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">receivers:</span> [<span class="string">httpcheck/frontendproxy</span>, <span class="string">otlp</span>, <span class="string">spanmetrics</span>]</span><br><span class="line">      <span class="attr">processors:</span> [<span class="string">batch</span>]</span><br><span class="line">      <span class="attr">exporters:</span> [<span class="string">otlphttp/prometheus</span>, <span class="string">debug</span>]</span><br><span class="line">    <span class="attr">logs:</span></span><br><span class="line">      <span class="attr">receivers:</span> [<span class="string">otlp</span>]</span><br><span class="line">      <span class="attr">processors:</span> [<span class="string">batch</span>]</span><br><span class="line">      <span class="attr">exporters:</span> [<span class="string">opensearch</span>, <span class="string">debug</span>]</span><br></pre></td></tr></table></figure><p>é‡ç‚¹çš„å°±æ˜¯è¿™é‡Œçš„ <code>service.piplines</code>ï¼Œå¯ä»¥è¿›è¡Œä»»æ„çš„ç»„è£…ã€‚</p><p>æ›´å¤šå…³äº collector çš„é…ç½®ä¹Ÿä¼šåœ¨åç»­æ–‡ç« ä¸­ç»§ç»­è®²è§£ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»§ç»­è®¿é—®è¿™ä¸ª demo ç½‘ç«™ï¼Œæ¨¡æ‹ŸåŠ å…¥è´­ç‰©è½¦ã€ä¸‹å•ç­‰è¡Œä¸ºï¼Œå†ç»“åˆ trace å’Œ metric è§‚å¯Ÿç³»ç»Ÿçš„å˜åŒ–ã€‚</p><p>è¿™æ ·ä¸€ä¸ªå®Œæ•´çš„ OpenTelemetry-Demo å°±æ­å»ºå®Œæ¯•äº†ï¼Œæˆ‘ä»¬å®é™…åœ¨ç”Ÿäº§ç¯å¢ƒä½¿æ—¶å®Œå…¨å¯ä»¥å‚è€ƒè¿™ä¸ª demo è¿›è¡Œé…ç½®ï¼Œå¯ä»¥å°‘è¸©å¾ˆå¤šå‘ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-demo/blob/main/src/adservice/Dockerfile">https://github.com/open-telemetry/opentelemetry-demo/blob/main/src/adservice/Dockerfile</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-demo">https://github.com/open-telemetry/opentelemetry-demo</a></li><li><a href="https://github.com/prometheus/prometheus/pull/12571">https://github.com/prometheus/prometheus/pull/12571</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-demo/blob/main/src/otelcollector/otelcol-config.yml">https://github.com/open-telemetry/opentelemetry-demo/blob/main/src/otelcollector/otelcol-config.yml</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç«  &lt;a href=&quot;https://crossoverjie.top/2024/05/21/ob/OpenTelemetry-getstart/&quot;&gt;OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ&lt;/a&gt;ä¸­å›é¡¾äº†å¯è§‚æµ‹æ€§çš„å†å²ä»¥åŠä»‹ç»äº†ä¸€äº› OpenTelemetry çš„åŸºç¡€æ¦‚å¿µï¼ŒåŒæ—¶ä¹Ÿä»‹ç»äº† OpenTelemetry ç¤¾åŒºå¸¸ç”¨çš„å¼€æºé¡¹ç›®ã€‚&lt;/p&gt;
&lt;p&gt;åŸºç¡€èƒŒæ™¯çŸ¥è¯†äº†è§£åï¼Œè¿™ç¯‡å°±æ¥ä»‹ç»ä¸€ä¸‹ä½¿ç”¨ OpenTelemetry å¦‚ä½•å®æˆ˜éƒ¨ç½²åº”ç”¨ï¼ŒåŒæ—¶åœ¨ä¸€ä¸ªå¯è§†åŒ–é¡µé¢æŸ¥çœ‹ traceã€metric ç­‰ä¿¡æ¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ</title>
    <link href="http://crossoverjie.top/2024/05/21/ob/OpenTelemetry-getstart/"/>
    <id>http://crossoverjie.top/2024/05/21/ob/OpenTelemetry-getstart/</id>
    <published>2024-05-21T13:46:00.000Z</published>
    <updated>2024-05-20T13:14:03.156Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ä¹‹å‰é™†ç»­å†™è¿‡ä¸€äº›å’Œ OpenTelemetry ç›¸å…³çš„æ–‡ç« ï¼š</p><ul><li><a href="https://crossoverjie.top/2024/04/07/ob/otel-replace-sw/">å®æˆ˜ï¼šå¦‚ä½•ä¼˜é›…çš„ä» Skywalking åˆ‡æ¢åˆ° OpenTelemetry</a></li><li><a href="https://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/">å®æˆ˜ï¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª OpenTelemetry Extensions</a></li><li><a href="https://juejin.cn/post/7356138322367266854">ä»ä¸€ä¸ª JDK21+OpenTelemetry ä¸å…¼å®¹çš„é—®é¢˜è®²èµ·</a></li></ul><p>è¿™äº›å†…å®¹çš„å‰ææ˜¯æœ€å¥½æœ‰ä¸€äº› OpenTelemetry çš„èƒŒæ™¯çŸ¥è¯†ï¼Œçœ‹èµ·æ¥å°±ä¸ä¼šé‚£ä¹ˆæ¯ç‡¥ï¼Œä¸ºæ­¤è¿™ç¯‡æ–‡ç« å°±æ¥åšä¸€ä¸ªå…¥é—¨ç§‘æ™®ï¼Œæ–¹ä¾¿ä¸€äº›å¯¹ OpenTelemetry ä¸æ˜¯é‚£ä¹ˆç†Ÿçš„æœ‹å‹å¿«é€ŸæŒæ¡ä¸€äº› OpenTelemetry çš„åŸºæœ¬æ¦‚å¿µã€‚</p><span id="more"></span><hr><h2 id="å†å²å‘å±•"><a href="#å†å²å‘å±•" class="headerlink" title="å†å²å‘å±•"></a>å†å²å‘å±•</h2><p>æ—©åœ¨ <code>OpenTelemetry</code> è¯ç”Ÿä¹‹å‰å¯è§‚æµ‹æ€§è¿™ä¸ªæ¦‚å¿µå°±ä¸€ç›´å­˜åœ¨äº†ï¼Œæˆ‘è®°å¾—æˆ‘æœ€æ—©æ¥è§¦åˆ°è¿™ä¸ªæ¦‚å¿µæ˜¯åœ¨ 16 å¹´å½“æ—¶çš„å…¬å¸æ‰€ä½¿ç”¨çš„ä¸€ä¸ªäº§å“ï¼š<a href="https://github.com/pinpoint-apm/pinpoint">pinpoint</a></p><blockquote><p>ç°å¦‚ä»Šè¿™ä¸ªé¡¹ç›®ä¾ç„¶æ¯”è¾ƒæ´»è·ƒã€‚</p></blockquote><p><img src="https://s2.loli.net/2024/04/15/VMLhpCWUGJmqn9z.png"><br>ä¾ç„¶è¿˜è®°å¾—å½“æ—¶é€šè¿‡å®ƒå¯ä»¥ç›´æ¥çœ‹åˆ°é¡¹ç›®è°ƒç”¨çš„æ‹“æ‰‘å›¾ï¼Œåœ¨æ—¶é—´åæ ‡ä¸Šæ¡†å‡ºé«˜å»¶è¿Ÿçš„ç‚¹å°±èƒ½åˆ—å‡ºè¿™äº›è¯·æ±‚ï¼ŒåŒæ—¶è¿˜èƒ½æŸ¥çœ‹æ­¤æ—¶çš„è¿è¡Œæ—¥å¿—ã€‚</p><p>è¿™æ ·å¼ºå¤§çš„åŠŸèƒ½å¯¹äºä¸€ä¸ªåˆšå·¥ä½œä¸€å¹´çš„å°ç™½æ¥è¯´å†²å‡»åŠ›å®å±å¤ªå¤§äº†ä¸€ç‚¹ã€‚</p><p>åæ¥æ‰äº†è§£åˆ° pinpoint å±äº APM è¿™ç±»äº§å“ï¼Œç±»ä¼¼çš„äº§å“è¿˜æœ‰ï¼š</p><ul><li>Apache SkyWalking</li><li>ç¾å›¢çš„ CAT ç­‰</li></ul><p>ä»–ä»¬éƒ½æ˜¯å¯ä»¥ç”¨äºæ€§èƒ½åˆ†æå’Œé“¾è·¯è¿½è¸ªçš„äº§å“ï¼Œåˆ°åæ¥å…¬å¸çš„è¿ç»´å±‚é¢ä¹Ÿæ¥å…¥è¿‡ Zabbixã€open-falcon ä¹‹ç±»çš„äº§å“ï¼š<br><img src="https://s2.loli.net/2024/04/16/RwsCUSM4fxTaBj6.png"></p><p>17ä¹‹åå…¨é¢åˆ‡æ¢åˆ° spring boot æ—¶ï¼Œä¹Ÿç”¨è¿‡ç¤¾åŒºæä¾›çš„ <a href="https://github.com/codecentric/spring-boot-admin">spring-boot-admin</a> é¡¹ç›®ï¼š</p><p><img src="https://s2.loli.net/2024/04/16/Y5vprI1fsVNwjPC.png"><br>è¿™å°±æ˜¯ä¸€ä¸ªç®€å•çš„å¯ä»¥ç›‘æ§ spring boot åº”ç”¨çš„äº§å“ï¼Œç”¨äºå±•ç¤º JVM æŒ‡æ ‡ï¼Œæˆ–è€…è‡ªå·±ä¹Ÿå¯ä»¥å®šä¹‰ä¸€äº›å¥åº·æŒ‡æ ‡ã€‚</p><hr><p>å†ä¹‹åè¿›å…¥äº‘åŸç”Ÿä½“ç³»åå¯è§‚æµ‹æ€§çš„æŠ€æœ¯æ ˆç¨æœ‰å˜åŒ–ã€‚</p><p><img src="https://s2.loli.net/2024/04/16/3MsXIo7lEgnhyUZ.png"></p><p>æ—¥å¿—ä½¿ç”¨ Sidecar ä»£ç†çš„æ–¹å¼é€šè¿‡ Agent å°†æ•°æ®å†™å…¥ ElasticSearch ä¸­ã€‚<br>å…·ä½“æ—¥å¿—é‡‡é›†æ–¹å¼å¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š</p><ul><li><a href="https://juejin.cn/post/7347000319983419411">åœ¨ kubernetes ç¯å¢ƒä¸‹å¦‚ä½•é‡‡é›†æ—¥å¿—</a></li></ul><p>è€Œé“¾è·¯è¿½è¸ªåˆ™æ˜¯ä½¿ç”¨çš„ <code>skywalking</code>ï¼Œåœ¨ trace è¿™ä¸ªé¢†åŸŸ skywalking è¿˜æ˜¯éå¸¸å—å¤§å®¶å–œçˆ±çš„ã€‚</p><p>ä¸è¿‡æœ€è¿‘ä¹Ÿä» skywalking åˆ‡æ¢åˆ°äº†æˆ‘ä»¬æœ¬æ–‡æ‰€è®²åˆ°çš„ OpenTelemetryï¼Œå…·ä½“å¯ä»¥çœ‹ä¹‹å‰çš„æ–‡ç« ï¼š</p><ul><li><a href="https://crossoverjie.top/2024/04/07/ob/otel-replace-sw/">å®æˆ˜ï¼šå¦‚ä½•ä¼˜é›…çš„ä» Skywalking åˆ‡æ¢åˆ° OpenTelemetry</a></li></ul><p>æŒ‡æ ‡é‡‡é›†ä½¿ç”¨çš„æ˜¯è‡ªç„¶ä¹Ÿæ˜¯ Prometheus çš„é‚£ä¸€å¥—æŠ€æœ¯æ ˆï¼Œåªæ˜¯ Prometheus æ¢ä¸ºäº†ä¸å®ƒå®Œå…¨å…¼å®¹çš„ VictoriaMetric ç›®å‰æ˜¯ä¸ºäº†æ›´çœèµ„æºã€‚</p><p>å®¢æˆ·ç«¯ä½¿ç”¨åˆ™æ˜¯ç›´æ¥ä½¿ç”¨ Prometheus çš„åº“è¿›è¡ŒæŒ‡æ ‡æš´éœ²ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>prometheus-metrics-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>prometheus-metrics-instrumentation-jvm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>prometheus-metrics-exporter-httpserver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆé€šè¿‡é…ç½®æŠ“å–ç­–ç•¥ï¼Œç”± VictoriaMetrics çš„ <code>scrape</code> ç¨‹åºæ¥æŠ“å–æŒ‡æ ‡æœ€ç»ˆå†™å…¥åˆ°å®ƒè‡ªå·±çš„å­˜å‚¨ä¸­ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMPodScrape</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-pod-scrape</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">podMetricsEndpoints:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">scheme:</span> <span class="string">http</span>  </span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">&quot;30s&quot;</span>  </span><br><span class="line">      <span class="attr">path:</span> <span class="string">/metrics</span>  </span><br><span class="line">      <span class="attr">relabelConfigs:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]  </span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">keep</span>  </span><br><span class="line">        <span class="comment"># ç«¯å£ç›¸åŒ  </span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">keep_if_equal</span>  </span><br><span class="line">          <span class="attr">source_labels:</span> [ <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>, <span class="string">__meta_kubernetes_pod_container_port_number</span> ]  </span><br><span class="line">        <span class="comment"># è¿‡æ»¤INITå®¹å™¨  </span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">drop</span>  </span><br><span class="line">          <span class="attr">source_labels:</span> [ <span class="string">__meta_kubernetes_pod_container_init</span> ]  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]  </span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.+)</span>  </span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__metrics_path__</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]  </span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span>  </span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__address__</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1:$2</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">labelmap</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]  </span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.*)</span>  </span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]  </span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.*)</span>  </span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span>  </span><br><span class="line">      <span class="attr">vm_scrape_params:</span>  </span><br><span class="line">        <span class="attr">stream_parse:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="attr">namespaceSelector:</span>  </span><br><span class="line">    <span class="attr">any:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><blockquote><p>ä»¥ä¸Šæ˜¯ VM æä¾›çš„ CRD</p></blockquote><h1 id="OpenTelemetry-è¯ç”Ÿ"><a href="#OpenTelemetry-è¯ç”Ÿ" class="headerlink" title="OpenTelemetry è¯ç”Ÿ"></a>OpenTelemetry è¯ç”Ÿ</h1><p>åˆ°æ­¤é“ºå«å®Œæˆï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰å‘ç°åœ¨å¯è§‚æµ‹æ€§ä¸­å…³é”®çš„ä¸‰ä¸ªéƒ¨åˆ†ï¼šæ—¥å¿—ã€æŒ‡æ ‡ã€trace éƒ½æ˜¯ä½¿ç”¨ä¸åŒçš„å¼€æºäº§å“ï¼Œä»è€Œä¼šå¯¼è‡´æŠ€æœ¯æ ˆè¾ƒå¤šï¼Œç»´æŠ¤èµ·æ¥è‡ªç„¶ä¹Ÿæ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚</p><p>è¿™ä¹ˆä¸€ä¸ªè½¯ä»¶é¢†åŸŸçš„æ ¸å¿ƒèƒ½åŠ›è‡ªç„¶éœ€è¦æä¾›ä¸€ä¸ªå®Œæ•´æ–¹æ¡ˆçš„ï¼Œå°†ä»¥ä¸Šçš„ä¸åŒæŠ€æœ¯æ ˆéƒ½æ•´åˆåœ¨ä¸€èµ·ï¼Œæ›´åŠ çš„æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ã€‚</p><p>åœ¨è¿™ä¹‹å‰ä¹Ÿæœ‰ä¸¤ä¸ªç¤¾åŒºæƒ³è¦åšç±»ä¼¼çš„äº‹æƒ…ï¼š</p><ul><li>OpenTracing</li><li>OpenCensus</li></ul><p>ä¸è¿‡ä»–ä»¬å¹¶æ²¡æœ‰ç»Ÿä¸€æ•´ä¸ªå¯è§‚æµ‹é¢†åŸŸï¼Œç›´åˆ° 2019 å¹´ CNCF ç¤¾åŒºå®£å¸ƒæˆç«‹ OpenTelemetryï¼Œå¹¶ä¸”å°†ä¸Šè¿°ä¸¤ä¸ªç¤¾åŒºè¿›è¡Œåˆå¹¶å…±åŒå¼€å‘ OpenTelemetryã€‚</p><blockquote><p>èƒŒé  CNCF äº‘åŸç”Ÿç¤¾åŒºåŠ ä¸Šè®¸å¤šçŸ¥åå‚å•†çš„æ”¯æŒï¼ˆGoogleã€Amazonã€Redhat ç­‰ï¼‰ï¼Œç°åœ¨å·²ç»æ­£å¼æˆä¸º CNCF çš„é¡¶çº§é¡¹ç›®äº†ã€‚</p></blockquote><h1 id="OpenTelemetry-æ¶æ„ä»‹ç»"><a href="#OpenTelemetry-æ¶æ„ä»‹ç»" class="headerlink" title="OpenTelemetry æ¶æ„ä»‹ç»"></a>OpenTelemetry æ¶æ„ä»‹ç»</h1><p><img src="https://s2.loli.net/2024/04/16/LMUtyG2ZqRbwYr8.png"></p><p>ä½†æˆ‘ä»¬æ‰“å¼€ OpenTelemetry ç¤¾åŒºçš„ GitHub é¦–é¡µæ—¶ï¼Œä¼šçœ‹åˆ°æœ‰è®¸å¤šé¡¹ç›®ï¼›ç¬¬ä¸€ååº”åº”è¯¥æ˜¯æ¯”è¾ƒè’™çš„ï¼Œä¸‹é¢æˆ‘ä¼šç€é‡ä»‹ç»ä¸€äº›æ¯”è¾ƒé‡è¦çš„é¡¹ç›®ã€‚</p><p>åœ¨å¼€å§‹ä¹‹å‰è¿˜æ˜¯å…ˆç®€å•ä»‹ç»ä¸‹ OpenTelemetry çš„ä¸€äº›åŸºç¡€ç»„ä»¶å’Œæ¦‚å¿µï¼š<br><img src="https://s2.loli.net/2024/04/16/pHON6Z3eun4IiJv.png"></p><p>æ•´ä¸ª OpenTelemetry ç³»ç»Ÿå…¶å®å¯ä»¥ç®€å•åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>å®¢æˆ·ç«¯</li><li>OTel collector</li><li>æ•°æ®å­˜å‚¨</li></ul><p>ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å¾ˆå¥½ç†è§£ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡åº”ç”¨ï¼›å¦‚æœæ˜¯ Java åº”ç”¨åªéœ€è¦æŒ‚è½½ä¸€ä¸ª agent å°±å¯ä»¥è‡ªåŠ¨é‡‡é›†ç³»ç»Ÿçš„æŒ‡æ ‡ã€é“¾è·¯ä¿¡æ¯ã€æ—¥å¿—ç­‰ä¸Šä¼ åˆ° Collector ä¸­ã€‚</p><p>ä¹Ÿå°±æ˜¯ä¸Šå›¾çš„å·¦è¾¹éƒ¨åˆ†ã€‚</p><p>ä¹‹åå°±æ˜¯éå¸¸å…³é”®çš„ç»„ä»¶ collectorï¼Œå®ƒå¯ä»¥é€šè¿‡ OTLP åè®®æ¥æ”¶åˆšæ‰æåˆ°çš„å®¢æˆ·ç«¯ä¸Šä¼ çš„æ•°æ®ï¼Œç„¶åå†å†…éƒ¨è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆè¾“å‡ºåˆ°åç»­çš„å­˜å‚¨ç³»ç»Ÿä¸­ã€‚</p><h2 id="Collector"><a href="#Collector" class="headerlink" title="Collector"></a>Collector</h2><p><img src="https://s2.loli.net/2024/04/16/l8Jfcak9bsUCwTZ.png"></p><blockquote><p>ä¸Šå›¾æ˜¯ collector çš„æ¶æ„å›¾</p></blockquote><p>ç”±äº OpenTelemetry è®¾è®¡ä¹‹åˆå°±æ˜¯è¦åšåˆ°å‚å•†æ— å…³ï¼Œæ‰€ä»¥å®ƒå°±å¾—åšå‡ºæ›´é«˜å±‚çº§çš„è®¾è®¡ã€‚</p><p>å…³é”®ç‚¹å°±æ˜¯è¿™é‡Œçš„ Receiver å’Œ Exporter éƒ½æ˜¯æ¨¡å—åŒ–çš„è®¾è®¡ï¼Œç¬¬ä¸‰æ–¹å¼€å‘è€…å¯ä»¥åŸºäºå®ƒçš„æ ‡å‡†å¼€å‘ä¸åŒç»„ä»¶ä»è€Œå…¼å®¹ä¸åŒçš„äº§å“ã€‚</p><p>Receiverï¼šç”¨äºæ¥æ”¶å®¢æˆ·ç«¯ä¸ŠæŠ¥çš„æ•°æ®ï¼Œä¸æ­¢æ˜¯è‡ªå·± agent ä¸ŠæŠ¥çš„æ•°æ®ï¼Œä¹Ÿå¯èƒ½ä¼šæ¥è‡ªä¸åŒçš„å‚å•†ï¼Œæ¯”å¦‚ kubernetesã€Kafka ç­‰ã€‚</p><p>Exporterï¼šåŒç†ï¼Œå¯ä»¥å°† receiver æ”¶åˆ°çš„æ•°æ®è¿›è¡Œå¤„ç†ä¹‹åè¾“å‡ºåˆ°ä¸åŒçš„ç»„ä»¶ä¸­ï¼›æ¯”å¦‚ Kafka&#x2F;Pulsar&#x2F;Promethus&#x2F;Jaeger ç­‰ã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/nginxreceiver">Nginx Receiver</a>æ¥æ”¶æ¥ç€ Nginx ä¸ŠæŠ¥çš„æ•°æ®ã€‚</p><p>ä½¿ç”¨ <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/mysqlreceiver">MySQL Receiver</a>æ¥æ”¶æ¥è‡ª MySQL çš„æ•°æ®ã€‚</p><p>å½“ç„¶é€šå¸¸æˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„è¿˜æ˜¯ <a href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/receiver/otlpreceiver">OTLP Receiver</a>ï¼Œè¿™æ˜¯å®˜æ–¹çš„ OTLP åè®®çš„æ¥æ”¶å™¨ï¼Œå¯ä»¥æ¥å—å®˜æ–¹çš„ä¸€äº›æŒ‡æ ‡ï¼Œæ¯”å¦‚æˆ‘ä»¬åªä½¿ç”¨äº† Java Agent è¿›è¡Œæ•°æ®ä¸ŠæŠ¥æ—¶ã€‚<br><img src="https://s2.loli.net/2024/04/16/WP46czTSAdYqKgb.png"><br><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver">https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver</a></p><p>åœ¨è¿™é‡Œæ˜¯å¯ä»¥çœ‹åˆ°ç›®å‰æ”¯æŒçš„æ‰€æœ‰ç¬¬ä¸‰æ–¹çš„ Receiverã€‚</p><hr><p><img src="https://s2.loli.net/2024/04/16/JxyICv8wHb7paZW.png"></p><p>OpenTelemetry æ‰€æ”¯æŒçš„ Exporter ä¹Ÿå¾ˆå¤šï¼Œæ¯”å¦‚ä¸€äº›å¸¸è§çš„å­˜å‚¨ï¼š</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/clickhouseexporter">clickhouse exporter</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/elasticsearchexporter">elasticsearch exporter</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/pulsarexporter">pulsar exporter</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/prometheusexporter">prometheus exporter</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/exporter/otlphttpexporter">otlp http exporter</a></li></ul><p>Exporter çš„ä½¿ç”¨åœºæ™¯å¾ˆå¤šï¼šå¦‚æœæ˜¯æŒ‡æ ‡ç›¸å…³çš„æ•°æ®å¯ä»¥ç›´æ¥å†™å…¥ Prometheusï¼Œå¦‚æœæ˜¯æ—¥å¿—æ•°æ®ä¹Ÿå¯ä»¥ç›´æ¥å†™å…¥ ElasticSearchã€‚</p><p>å¦‚æœè¿˜æœ‰å…¶ä»–çš„ç‰¹æ®Šéœ€æ±‚ï¼ˆåˆ å‡å±æ€§ç­‰ï¼‰åˆ™å¯ä»¥å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‡ªè¡Œå¤„ç†å®Œä¹‹åå†å‘å¾€ collector è¿›è¡Œåç»­çš„å¤„ç†ã€‚</p><p>å¯èƒ½ä½ å·²ç»å‘ç°äº†ï¼Œç”±äº collector éå¸¸çš„çµæ´»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åƒæ­ç§¯æœ¨ä¸€æ ·ç»„è£…æˆ‘ä»¬çš„ receiver å’Œ exporterï¼Œå®ƒä¼šä»¥æˆ‘ä»¬é…ç½®çš„æµæ°´çº¿çš„æ–¹å¼è¿›è¡Œè°ƒç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®ç°ä»»æ„å¯å®šåˆ¶çš„å¤„ç†é€»è¾‘ã€‚</p><p>è€Œè¿™äº›æµæ°´çº¿çš„ç»„è£…å¯¹äºå®¢æˆ·ç«¯æ¥è¯´éƒ½æ˜¯é€æ˜çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ collector çš„æ›´æ”¹å®Œå…¨ä¸ä¼šå½±å“åˆ°ä¸šåŠ¡ï¼›ä¸šåŠ¡åªéœ€è¦æŒ‰ç…§ OTLP çš„æ ¼å¼ä¸ŠæŠ¥æ•°æ®å³å¯ã€‚</p><p>åœ¨ä¹‹å‰çš„ä» Skywalking åˆ‡æ¢åˆ° OpenTelemetry çš„æ–‡ç« ä¸­æœ‰äººé—®ä¸ºä»€ä¹ˆè¦åˆ‡æ¢åˆ° OpenTelemetryï¼Ÿ</p><p>ä»è¿™é‡Œä¹Ÿèƒ½çœ‹å¾—å‡ºæ¥ï¼ŒOpenTelemetry çš„çµæ´»åº¦éå¸¸é«˜ï¼Œå€ŸåŠ©äº Exporter å¯ä»¥ä»»æ„çš„æ›´æ¢åç«¯å­˜å‚¨ï¼Œæˆ–è€…å¢åŠ &#x2F;åˆ å‡ä¸€äº›ä¸éœ€è¦çš„æŒ‡æ ‡æ•°æ®ç­‰ã€‚</p><hr><p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»Ÿä¸€çš„åœ¨è¿™é‡Œè¿›è¡Œæœç´¢ï¼Œå¯ä»¥åˆ—å‡ºæ‰€æœ‰çš„ç¬¬ä¸‰æ–¹é›†æˆçš„ç»„ä»¶ï¼š<br><a href="https://opentelemetry.io/ecosystem/registry/">https://opentelemetry.io/ecosystem/registry/</a></p><p><img src="https://s2.loli.net/2024/04/16/XvOx5i9LImhDTe4.png"></p><h1 id="OpenTelemetry-é¡¹ç›®ä»‹ç»"><a href="#OpenTelemetry-é¡¹ç›®ä»‹ç»" class="headerlink" title="OpenTelemetry é¡¹ç›®ä»‹ç»"></a>OpenTelemetry é¡¹ç›®ä»‹ç»</h1><h2 id="opentelemetry-java"><a href="#opentelemetry-java" class="headerlink" title="opentelemetry-java"></a>opentelemetry-java</h2><p>ä»‹ç»å®ŒåŸºæœ¬çš„æ¦‚å¿µåï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹  OTel ç¤¾åŒºçš„ä¸€äº›ä¸»è¦å¼€æºé¡¹ç›®ã€‚<br><img src="https://s2.loli.net/2024/04/16/t3rWKEuHpTRjL7I.png"></p><p>è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä»¥åˆšæ‰çš„é‚£ä¸ªæ¶æ„å›¾ä»ä½œå¾€å³è®²èµ·ï¼Œä¹Ÿå°±æ˜¯ä¸»è¦åˆ†ä¸ºå®¢æˆ·ç«¯å’Œ collector ç«¯ã€‚</p><p><img src="https://s2.loli.net/2024/04/16/zWAVoHaZORI83js.png"><br>ç›®å‰å®˜æ–¹æ”¯æŒçš„å®¢æˆ·ç«¯è¯­è¨€å·²ç»éå¸¸é½å…¨äº†ï¼Œå¤§éƒ¨åˆ†çš„ç‰ˆæœ¬éƒ½å·²ç»æ˜¯ Stable ç¨³å®šç‰ˆï¼Œæ„å‘³ç€å¯ä»¥è¿›å…¥ç”Ÿäº§ç¯å¢ƒã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä»¥ Java å®¢æˆ·ç«¯ä¸ºä¾‹ï¼š<br><img src="https://s2.loli.net/2024/04/16/Oea2KwgZYVS8qPf.png"><br>å…¶ä¸­æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸‹ opentelemetry-java å’Œ opentelemetry-java-instrumentation è¿™ä¸¤ä¸ªé¡¹ç›®ã€‚</p><p>æˆ‘ä»¬ç”¨çš„æœ€å¤šçš„ä¼šæ˜¯ <code>opentelemetry-java-instrumentation</code>ï¼Œå®ƒä¼šç»™æˆ‘ä»¬æä¾›ä¸€ä¸ª java agent çš„ JAR åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:path/to/opentelemetry-javaagent.jar \</span><br><span class="line">     -jar myapp.jar</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åªéœ€è¦åœ¨ Java åº”ç”¨ä¸­åŠ ä¸Šè¯¥  agent å°±å¯ä»¥å®ç°æ—¥å¿—ã€æŒ‡æ ‡ã€trace çš„è‡ªåŠ¨ä¸ŠæŠ¥ã€‚</p><p>è€Œä¸”å®ƒè¿˜å®ç°äº†ä¸åŒæ¡†æ¶ã€åº“çš„æŒ‡æ ‡é‡‡é›†ä¸ traceã€‚</p><p>åœ¨è¿™é‡Œå¯ä»¥æŸ¥åˆ°æ”¯æŒçš„åº“ä¸æ¡†æ¶åˆ—è¡¨ï¼š<br><img src="https://s2.loli.net/2024/04/17/kMDcrPwxJy4oZYe.png"></p><p><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md#libraries--frameworks">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md#libraries--frameworks</a></p><blockquote><p>æ€»ä¹‹å‡ ä¹å°±æ˜¯ä½ èƒ½æƒ³åˆ°å’Œä¸èƒ½æƒ³åˆ°çš„éƒ½æ”¯æŒäº†ã€‚</p></blockquote><p>è€Œ opentelemetry-java æˆ‘ä»¬ç›´æ¥ä½¿ç”¨çš„å‡ ç‡ä¼šå°ä¸€äº›ï¼Œopentelemetry-java-instrumentation æœ¬èº«ä¹Ÿæ˜¯åŸºäºå®ƒåˆ›å»ºçš„ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ Java ç‰ˆæœ¬çš„æ ¸å¿ƒåŸºç¡€åº“ï¼Œä¸€äº›ç¤¾åŒºæ”¯æŒçš„ç»„ä»¶å°±å¯ä»¥ç§»åŠ¨åˆ° <code>instrumentation</code> è¿™ä¸ªåº“ä¸­ã€‚</p><p>æ¯”å¦‚æˆ‘åœ¨ä¸Šç¯‡æ–‡ç« ï¼š<a href="https://juejin.cn/post/7356138322367266854">ä»ä¸€ä¸ª JDK21+OpenTelemetry ä¸å…¼å®¹çš„é—®é¢˜è®²èµ·</a>ä¸­æ¶‰åŠåˆ°çš„ <code>HostResourceProvider</code> èµ„æºåŠ è½½å°±æ˜¯ä» <code>opentelemetry-java</code> ä¸­ç§»åŠ¨åˆ°äº† <code>opentelemetry-java-instrumentation</code>ã€‚</p><p>å…·ä½“å¯ä»¥å‚è€ƒï¼š<a href="https://github.com/open-telemetry/opentelemetry-java/issues/4701">https://github.com/open-telemetry/opentelemetry-java/issues/4701</a></p><h2 id="collector"><a href="#collector" class="headerlink" title="collector"></a>collector</h2><p><img src="https://s2.loli.net/2024/04/16/2MaF7IwWvg9f1TS.png"></p><p>ä¹‹åå°±æ˜¯ collector çš„ç»„ä»¶äº†ï¼Œå®ƒåŒæ ·çš„ä¹Ÿæœ‰ä¸¤ä¸ªåº“ï¼š<br><strong>OpenTelemetry Collector</strong> å’Œ <strong>OpenTelemetry Collector Contrib</strong></p><p>å…¶å®é€šè¿‡ä»–ä»¬çš„åå­—ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œä»–ä»¬çš„ä½œç”¨ä¸åˆšæ‰çš„ Java åº“ç±»ä¼¼ï¼š</p><ul><li>opentelemetry-collectorï¼šç”±å®˜æ–¹ç¤¾åŒºç»´æŠ¤ï¼Œæä¾›äº†ä¸€äº›æ ¸å¿ƒèƒ½åŠ›ï¼›æ¯”å¦‚åªåŒ…å«äº†æœ€åŸºæœ¬çš„ otlp çš„ receiver å’Œ exporterã€‚</li><li>opentelemetry-collector-contribï¼šåŒ…å«äº†å®˜æ–¹çš„ collectorï¼ŒåŒæ—¶æ›´å¤šçš„ç»´æŠ¤äº†ç¤¾åŒºæä¾›çš„å„ç§ receiver å’Œ exporterï¼›å°±å¦‚ä¸Šæ–‡æåˆ°çš„ï¼Œä¸€äº›ç¤¾åŒºç»„ä»¶ï¼ˆpulsarã€MySQLã€Kafkaï¼‰ç­‰éƒ½ç»´æŠ¤åœ¨è¿™ä¸ªä»“åº“ã€‚</li></ul><p>è€Œæˆ‘ä»¬ç”Ÿäº§ä½¿ç”¨æ—¶é€šå¸¸ä¹Ÿæ˜¯ç›´æ¥ä½¿ç”¨ opentelemetry-collector-contribï¼Œæ¯•ç«Ÿå®ƒæ‰€æ”¯æŒçš„ç¤¾åŒºç»„ä»¶æ›´å¤šã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å› ä¸º OpenTelemetry æƒ³è¦è§£å†³çš„æ˜¯æ•´ä¸ªå¯è§‚æµ‹é¢†åŸŸçš„æ‰€æœ‰éœ€æ±‚ï¼Œæ‰€ä»¥ä»“åº“éå¸¸å¤šï¼Œç¤¾åŒºä¹Ÿå¾ˆå¼€æ”¾ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ç›´æ¥å‚ä¸è´¡çŒ®ï¼Œè¿™ä¹ˆå¤š repo æ€»æœ‰ä¸€ä¸ªé€‚åˆä½ çš„ã€‚</p><p>åç»­ä¼šç»§ç»­è®²è§£å¦‚ä½•å®‰è£…ä»¥åŠé…ç½®æˆ‘ä»¬çš„ OpenTelemetryã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/pinpoint-apm/pinpoint">https://github.com/pinpoint-apm/pinpoint</a></li><li><a href="https://github.com/codecentric/spring-boot-admin">https://github.com/codecentric/spring-boot-admin</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java">https://github.com/open-telemetry/opentelemetry-java</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation">https://github.com/open-telemetry/opentelemetry-java-instrumentation</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java/issues/4701">https://github.com/open-telemetry/opentelemetry-java/issues/4701</a></li></ul><p>#Blog #OpenTelemetry </p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;ä¹‹å‰é™†ç»­å†™è¿‡ä¸€äº›å’Œ OpenTelemetry ç›¸å…³çš„æ–‡ç« ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://crossoverjie.top/2024/04/07/ob/otel-replace-sw/&quot;&gt;å®æˆ˜ï¼šå¦‚ä½•ä¼˜é›…çš„ä» Skywalking åˆ‡æ¢åˆ° OpenTelemetry&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/&quot;&gt;å®æˆ˜ï¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª OpenTelemetry Extensions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7356138322367266854&quot;&gt;ä»ä¸€ä¸ª JDK21+OpenTelemetry ä¸å…¼å®¹çš„é—®é¢˜è®²èµ·&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™äº›å†…å®¹çš„å‰ææ˜¯æœ€å¥½æœ‰ä¸€äº› OpenTelemetry çš„èƒŒæ™¯çŸ¥è¯†ï¼Œçœ‹èµ·æ¥å°±ä¸ä¼šé‚£ä¹ˆæ¯ç‡¥ï¼Œä¸ºæ­¤è¿™ç¯‡æ–‡ç« å°±æ¥åšä¸€ä¸ªå…¥é—¨ç§‘æ™®ï¼Œæ–¹ä¾¿ä¸€äº›å¯¹ OpenTelemetry ä¸æ˜¯é‚£ä¹ˆç†Ÿçš„æœ‹å‹å¿«é€ŸæŒæ¡ä¸€äº› OpenTelemetry çš„åŸºæœ¬æ¦‚å¿µã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>ä»ä¸€ä¸ª JDK21+OpenTelemetry ä¸å…¼å®¹çš„é—®é¢˜è®²èµ·</title>
    <link href="http://crossoverjie.top/2024/05/13/ob/jdk21+springboot+OTel+SPI/"/>
    <id>http://crossoverjie.top/2024/05/13/ob/jdk21+springboot+OTel+SPI/</id>
    <published>2024-05-13T15:31:40.000Z</published>
    <updated>2024-05-13T07:57:01.419Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å‰æ®µæ—¶é—´å…¬å¸é¢†å¯¼è®©æˆ‘æ’æŸ¥ä¸€ä¸ªå…³äºåœ¨ JDK21 ç¯å¢ƒä¸­ä½¿ç”¨ Spring Boot é…åˆä¸€ä¸ª JDK18 æ–°å¢çš„ä¸€ä¸ª SPI(<code>java.net.spi.InetAddressResolverProvider</code>) ä¸ç”Ÿæ•ˆçš„é—®é¢˜ã€‚</p><p>ä½†è¿™ä¸ªä¸ç”Ÿæ•ˆçš„å‰ç½®æ¡ä»¶æœ‰ç‚¹å¤šï¼š</p><ul><li>JDK çš„ç‰ˆæœ¬å¾—åœ¨ 18+</li><li>SpringBoot3.x</li><li>è¿˜åœ¨é¢å¤–å†é…åˆä½¿ç”¨ <code>-javaagent:opentelemetry-javaagent.jar</code> ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯ OpenTelemetry æä¾›çš„ agentã€‚</li></ul><p>æ‰ä¼šå¯¼è‡´è‡ªå®šä¹‰çš„ <code>InetAddressResolverProvider</code> æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p><span id="more"></span><hr><p>åœ¨å¤ç°è¿™ä¸ªé—®é¢˜ä¹‹å‰å…ˆç®€å•ä»‹ç»ä¸‹ <code>java.net.spi.InetAddressResolverProvider</code> è¿™ä¸ª SPIï¼›å®ƒæ˜¯åœ¨ JDK18 ä¹‹åæ‰æä¾›çš„ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨ <code>InetAddress</code> çš„å†…ç½®è§£æå™¨æ¥è§£æä¸»æœºåå’Œ IP åœ°å€ï¼Œä½†è¿™ä¸ªè§£æå™¨ä¹‹å‰æ˜¯ä¸å¯ä»¥è‡ªå®šä¹‰çš„ã€‚</p><p>åœ¨æŸäº›åœºæ™¯ä¸‹ä¼šä¸å¤ªæ–¹ä¾¿ï¼Œæ¯”å¦‚æˆ‘ä»¬éœ€è¦è¯·æ±‚ <code>order.service</code> è¿™ä¸ªåŸŸåæ—¶å¸Œæœ›å¯ä»¥è¯·æ±‚åˆ°æŸä¸€ä¸ªå…·ä½“ IP åœ°å€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±é…ç½® host ï¼Œæˆ–è€…ä½¿ç”¨æœåŠ¡å‘ç°æœºåˆ¶æ¥å®ç°ã€‚</p><p>ä½†ç°åœ¨é€šè¿‡ <code>InetAddressResolverProvider</code> å°±å¯ä»¥å®šä¹‰åœ¨è¯·æ±‚è¿™ä¸ªåŸŸåçš„æ—¶å€™è¿”å›ä¸€ä¸ªæˆ‘ä»¬é¢„æœŸçš„ IP åœ°å€ã€‚</p><p>åŒæ—¶ç”±äºå®ƒæ˜¯ä¸€ä¸ª SPIï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç¼–å†™ä¸€ä¸ªç¬¬ä¸‰æ–¹åŒ…ï¼Œä»»ä½•é¡¹ç›®ä¾èµ–å®ƒä¹‹ååœ¨å‘èµ·ç½‘ç»œè¯·æ±‚æ—¶éƒ½ä¼šæŒ‰ç…§æˆ‘ä»¬é¢„æœŸçš„ IP è¿›è¡Œè¯·æ±‚ã€‚</p><h1 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h1><p>è¦ä½¿ç”¨å®ƒä¹Ÿå¾ˆç®€å•ï¼Œä¸»è¦æ˜¯ä¸¤ä¸ªç±»ï¼š</p><ul><li><code>InetAddressResolverProvider</code>ï¼šè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿å®ƒä¹‹åé‡å†™å®ƒçš„ get å‡½æ•°è¿”å›ä¸€ä¸ª <code>InetAddressResolver</code> å¯¹è±¡</li><li><code>InetAddressResolver</code>ï¼šä¸€ä¸ªæ¥å£ï¼Œä¸»è¦æä¾›äº†ä¸¤ä¸ªå‡½æ•°ï¼›ä¸€ä¸ªç”¨äºä¼ å…¥åŸŸåè¿”å› IP åœ°å€ï¼Œå¦ä¸€ä¸ªåä¹‹ï¼šä¼ å…¥ IP åœ°å€è¿”å›åŸŸåã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAddressResolverProvider</span> <span class="keyword">extends</span> <span class="title class_">InetAddressResolverProvider</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InetAddressResolver <span class="title function_">get</span><span class="params">(Configuration configuration)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyAddressResolver</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">name</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;MyAddressResolverProvider Internet Address Resolver Provider&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAddressResolver</span> <span class="keyword">implements</span> <span class="title class_">InetAddressResolver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyAddressResolver</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=====MyAddressResolver&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Stream&lt;InetAddress&gt; <span class="title function_">lookupByName</span><span class="params">(String host, LookupPolicy lookupPolicy)</span></span><br><span class="line">            <span class="keyword">throws</span> UnknownHostException &#123;</span><br><span class="line">        <span class="keyword">if</span> (host.equals(<span class="string">&quot;fedora&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Stream.of(InetAddress.getByAddress(<span class="keyword">new</span> <span class="title class_">byte</span>[] &#123;<span class="number">127</span>, <span class="number">127</span>, <span class="number">10</span>, <span class="number">1</span>&#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Stream.of(InetAddress.getByAddress(<span class="keyword">new</span> <span class="title class_">byte</span>[] &#123;<span class="number">127</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">lookupByAddress</span><span class="params">(<span class="type">byte</span>[] addr)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;++++++&quot;</span> + addr[<span class="number">0</span>] + <span class="string">&quot; &quot;</span> + addr[<span class="number">1</span>] + <span class="string">&quot; &quot;</span> + addr[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + addr[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">return</span>  <span class="string">&quot;fedora&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">```<span class="type">java</span></span><br><span class="line"><span class="variable">addresses</span> <span class="operator">=</span> InetAddress.getAllByName(<span class="string">&quot;fedora&quot;</span>);</span><br><span class="line"><span class="comment">// output: 127 127 10 1</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ç®€å•å®ç°äº†ä¸€ä¸ªå¯¹åŸŸå fedora çš„è§£æï¼Œä¼šç›´æ¥è¿”å› <code>127.127.10.1</code>ã€‚</p><p>å¦‚æœä½¿ç”¨ IP åœ°å€è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InetAddress</span> <span class="variable">byAddress</span> <span class="operator">=</span> InetAddress.getByAddress(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">127</span>, <span class="number">127</span>, <span class="number">10</span>, <span class="number">1</span>&#125;);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;+++++&quot;</span> + byAddress.getHostName());</span><br><span class="line"><span class="comment">// output: fedora</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶è¦è¦ä½¿å¾—è¿™ä¸ª SPI ç”Ÿæ•ˆçš„å‰ææ¡ä»¶æ˜¯æˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼š<br><code>META-INF/services/java.net.spi.InetAddressResolverProvider</code><br>é‡Œé¢çš„å†…å®¹æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰ç±»çš„å…¨é™å®šåç§°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.example.demo.MyAddressResolverProvider</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¸€ä¸ªå®Œæ•´çš„ SPI å°±å®ç°å®Œæˆäº†ã€‚</p><hr><p>æ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬å°†åº”ç”¨æ‰“åŒ…ä¸ºä¸€ä¸ª jar ä¹‹åè¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar target/demo-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p>æ˜¯å¯ä»¥çœ‹åˆ°è¾“å‡ºç»“æœæ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚</p><p>ä¸€æ—¦æˆ‘ä»¬ä½¿ç”¨é…åˆä¸Š spring boot æ‰“åŒ…ä¹‹åï¼Œä¹Ÿå°±æ˜¯åŠ ä¸Šä»¥ä¸‹çš„ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œå…¶å®ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œä¹Ÿèƒ½æŒ‰ç…§é¢„æœŸè¾“å‡ºç»“æœã€‚</p><p>ä½†æˆ‘ä»¬åŠ ä¸Š OpenTelemetry çš„ agent æ—¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java  -javaagent:opentelemetry-javaagent.jar \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p>å°±ä¼šå‘ç°åœ¨æ‰§è¡Œè§£æçš„æ—¶å€™æŠ›å‡ºäº† <code>java.net.UnknownHostException</code>å¼‚å¸¸ã€‚</p><p><img src="https://s2.loli.net/2024/04/08/owZLIF7yzUpSdjn.png"><br>ä»ç»“æœæ¥çœ‹å°±æ˜¯æ²¡æœ‰è¿›å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„è§£æå™¨ã€‚</p><h1 id="SPI-åŸç†"><a href="#SPI-åŸç†" class="headerlink" title="SPI åŸç†"></a>SPI åŸç†</h1><p>åœ¨è®²æ’æŸ¥è¿‡ç¨‹ä¹‹å‰è¿˜æ˜¯è¦å…ˆé¢„ä¹ ä¸‹å…³äº Java SPI çš„åŸç†ä»¥åŠåº”ç”¨åœºæ™¯ã€‚</p><p>ä»¥å‰å†™è¿‡ä¸€ä¸ª http æ¡†æ¶ <a href="https://github.com/TogetherOS/cicada">cicada</a>ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå¯æ‹”æ’ IOC å®¹å™¨çš„åŠŸèƒ½ï¼š</p><blockquote><p>å°±æ˜¯å¯ä»¥è‡ªå®šä¹‰å®ç°è‡ªå·±çš„ IOC å®¹å™¨ï¼Œå°†è‡ªå·±å®ç°çš„ IOC å®¹å™¨æ‰“åŒ…ä¸ºä¸€ä¸ªç¬¬ä¸‰æ–¹åŒ…åŠ å…¥åˆ°ä¾èµ–ä¸­ï¼Œcicada æ¡†æ¶å°±ä¼šè‡ªåŠ¨ä½¿ç”¨è‡ªå®šä¹‰çš„ IOC å®ç°ã€‚</p></blockquote><p>è¦å®ç°è¿™ä¸ªåŠŸèƒ½æœ¬è´¨ä¸Šå°±æ˜¯è¦å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œç„¶åæ ¹æ®ä¾èµ–çš„ä¸åŒå®ç°åˆ›å»ºæ¥å£çš„å®ä¾‹å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CicadaBeanFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register into bean Factory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Object object)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get bean from bean Factory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object <span class="title function_">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get bean by class type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(Class&lt;T&gt; clazz)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * release all beans</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">releaseBean</span><span class="params">()</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–å…·ä½“çš„ç¤ºä¾‹ä»£ç æ—¶å°±åªéœ€è¦ä½¿ç”¨ JDK å†…ç½®çš„ <code>ServiceLoader</code> è¿›è¡ŒåŠ è½½å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CicadaBeanFactory <span class="title function_">getCicadaBeanFactory</span><span class="params">()</span> &#123;  </span><br><span class="line">    ServiceLoader&lt;CicadaBeanFactory&gt; cicadaBeanFactories = ServiceLoader.load(CicadaBeanFactory.class);  </span><br><span class="line">    <span class="keyword">if</span> (cicadaBeanFactories.iterator().hasNext())&#123;  </span><br><span class="line">        <span class="keyword">return</span> cicadaBeanFactories.iterator().next() ;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CicadaDefaultBean</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä¹Ÿéå¸¸çš„ç®€æ´ï¼Œå’Œåˆšæ‰æåˆ°çš„ <code>InetAddressResolverProvider</code> ä¸€æ ·æˆ‘ä»¬éœ€è¦æ–°å¢ä¸€ä¸ª <code>META-INF/services/top.crossoverjie.cicada.base.bean.CicadaBeanFactory</code> æ–‡ä»¶æ¥é…ç½®æˆ‘ä»¬çš„ç±»åç§°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasNextService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextName != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// PREFIX = META-INF/services/</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fullName</span> <span class="operator">=</span> PREFIX + service.getName();</span><br><span class="line">            <span class="keyword">if</span> (loader == <span class="literal">null</span>)</span><br><span class="line">                configs = ClassLoader.getSystemResources(fullName);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                configs = loader.getResources(fullName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">            fail(service, <span class="string">&quot;Error locating configuration files&quot;</span>, x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ((pending == <span class="literal">null</span>) || !pending.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!configs.hasMoreElements()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pending = parse(service, configs.nextElement());</span><br><span class="line">    &#125;</span><br><span class="line">    nextName = pending.next();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ ServiceLoader ç±»ä¸­ä¼šä¼šå»æŸ¥æ‰¾ <code>META-INF/services</code> çš„æ–‡ä»¶ï¼Œç„¶åè§£æå…¶ä¸­çš„å†…å®¹ä»è€Œåå°„ç”Ÿæˆå¯¹åº”çš„æ¥å£å¯¹è±¡ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå…³é”®æ˜¯é€šå¸¸æˆ‘ä»¬çš„ä»£ç éƒ½ä¼šæ‰“åŒ…ä¸ºä¸€ä¸ª JAR åŒ…ï¼Œç±»åŠ è½½å™¨éœ€è¦åŠ è½½è¿™ä¸ª  JAR åŒ…ï¼ŒåŒæ—¶éœ€è¦åœ¨è¿™ä¸ª JAR åŒ…é‡Œæ‰¾åˆ°æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„é‚£ä¸ª spi æ–‡ä»¶ï¼Œå¦‚æœè¿™é‡ŒæŸ¥ä¸åˆ°æ–‡ä»¶é‚£å°±è®¤ä¸ºæ²¡æœ‰å®šä¹‰ SPIã€‚</p><p>è¿™ä¸ªæ˜¯æœ¬æ¬¡é—®é¢˜çš„é‡ç‚¹ï¼Œä¼šåœ¨åæ–‡åˆ†æåŸå› çš„æ—¶å€™ç”¨åˆ°ã€‚</p><h1 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h1><p>å› ä¸ºé—®é¢˜å°±å‡ºç°åœ¨æ˜¯å¦ä½¿ç”¨ opentelemetry-javaagent.jar ä¸Šï¼Œæ‰€ä»¥æˆ‘éœ€è¦çŸ¥é“åœ¨ä½¿ç”¨äº† agent ä¹‹åæœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p><p>ä»åˆšæ‰çš„å¯¹ SPI çš„åŸç†åˆ†æï¼ŒåŠ ä¸Š agent å‡ºç°å¼‚å¸¸ï¼Œè¯´æ˜ç†è®ºä¸Šå°±æ˜¯æ²¡æœ‰è¯»å–åˆ°æˆ‘ä»¬é…ç½®çš„æ–‡ä»¶: <code>java.net.spi.InetAddressResolverProvider</code>ã€‚</p><p>äºæ˜¯æˆ‘ä¾¿å¼€å§‹ debugï¼Œåœ¨ ServiceLoader åŠ è½½ jar åŒ…çš„æ—¶å€™æ˜¯å¯ä»¥çœ‹åˆ°å…·ä½“ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆ <code>classLoader</code> ã€‚</p><p>è¿™æ˜¯ä¸é…ç½® agent çš„æ—¶å€™ä½¿ç”¨çš„ classLoaderï¼š<br><img src="https://s2.loli.net/2024/04/10/kgR1hOzKbnGMJUA.png"><br>ä½¿ç”¨è¿™ä¸ª loader æ˜¯å¯ä»¥é€šè¿‡æ–‡ä»¶è·¯å¾„åœ¨ jar åŒ…ä¸­æŸ¥æ‰¾åˆ°æˆ‘ä»¬é…ç½®çš„æ–‡ä»¶ã€‚</p><p>è€Œé…ç½®ä¸Š agent ä¹‹åä½¿ç”¨çš„ classLoader:<br><img src="https://s2.loli.net/2024/04/10/45sUKGr6xeVPNXA.png"><br>å´æ˜¯ä¸€ä¸ª JarLoaderï¼Œè¿™æ ·æ˜¯æ— æ³•åŠ è½½åˆ°åœ¨ springboot æ ¼å¼ä¸‹çš„é…ç½®æ–‡ä»¶çš„ï¼Œè‡³äºä¸ºä»€ä¹ˆåŠ è½½ä¸åˆ°ï¼Œé‚£å°±è¦æä¸€ä¸‹ maven æ‰“åŒ…åçš„æ–‡ä»¶ç›®å½•å’Œ spring boot æ‰“åŒ…åçš„æ–‡ä»¶ç›®å½•çš„åŒºåˆ«äº†ã€‚</p><p><img src="https://s2.loli.net/2024/04/10/ZtDCc7SvXFHmL9J.png"><br>è¿™é‡Œæˆ‘æˆªå›¾äº†åŒæ ·çš„ä¸€ä»½ä»£ç ä¸åŒçš„æ‰“åŒ…æ–¹å¼ï¼š<br>ä¸Šé¢çš„æ˜¯ä¼ ç»Ÿ mavenï¼Œä¸‹å›¾æ˜¯ spring bootï¼›å…¶å®ä¸»è¦çš„åŒºåˆ«å°±æ˜¯åœ¨ pom ä¸­ä½¿ç”¨äº†ä¸€ä¸ªæ„å»ºæ’ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>æˆ–è€…ä½¿ç”¨ <code>spring-boot</code> å‘½ä»¤å†æ¬¡æ‰“åŒ…çš„æ•ˆæœä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p></blockquote><p>ä¼šå‘ç° spring boot æ‰“åŒ…åä¼šå¤šå‡ºä¸€å±‚ <code>BOOT-INF</code> çš„æ–‡ä»¶å¤¹ï¼Œç„¶åä¼šåœ¨ <code>MANIFIST.MF</code> æ–‡ä»¶ä¸­å®šä¹‰ <code>Main-Class</code> å’Œ <code>Start-Class</code>.</p><hr><p>é€šè¿‡ä¸Šé¢çš„ debug å…¶å®ä¼šå‘ç° JarLoader åªèƒ½åœ¨åŠ è½½ maven æ‰“åŒ…åçš„æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´æ— æ³•è¯†åˆ« BOOT-INF è¿™ä¸ªç›®å½•ã€‚</p><p>æ­£å¸¸æƒ…å†µä¸‹ spring boot ä¸­ä¼šæœ‰ä¸€ä¸ªé¢å¤–çš„ <code>java.nio.file.spi.FileSystemProvider</code> å®ç°:<br><img src="https://s2.loli.net/2024/04/10/iFus4tA1KXEMYkq.png"><br>é€šè¿‡è¿™ä¸ªç±»çš„å®ç°å¯ä»¥ç›´æ¥ä» JAR åŒ…ä¸­åŠ è½½èµ„æºï¼Œæ¯”å¦‚æˆ‘ä»¬è‡ªå®šä¹‰çš„ SPI èµ„æºç­‰ã€‚</p><p>åˆæ­¥åˆ¤æ–­ä½¿ç”¨ <code>opentelemetry-javaagent.jar</code>çš„ agent ä¹‹åï¼Œå®ƒçš„ç±»åŠ è½½å™¨ä¼˜å…ˆäºäº† spring boot ï¼Œä»è€Œå¯¼è‡´åç»­çš„åŠ è½½å¤±è´¥ã€‚</p><h2 id="è¿œç¨‹-debug"><a href="#è¿œç¨‹-debug" class="headerlink" title="è¿œç¨‹ debug"></a>è¿œç¨‹ debug</h2><p>è¿™é‡Œç©¿æ’å‡ ä¸ª debug å°æŠ€å·§ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯è¿œç¨‹ debugï¼Œå› ä¸ºè¿™é‡Œæˆ‘æ˜¯éœ€è¦è°ƒè¯• javaagentï¼Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯æ— æ³•ç›´æ¥ debug çš„ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨åº”ç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -agentlib:jdwp=&quot;transport=dt_socket,server=y,suspend=y,address=5000&quot; -javaagent:opentelemetry-javaagent.jar \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/04/10/D2z4krNyHAanSlC.png"></p><p>ç„¶ååœ¨ idea ä¸­é…ç½®ä¸€ä¸ª remote å¯åŠ¨ã€‚</p><blockquote><p>æ³¨æ„è¿™é‡Œçš„ç«¯å£å¾—å’Œå‘½ä»¤è¡Œä¸­çš„ä¿æŒä¸€è‡´ã€‚</p></blockquote><p>å½“åº”ç”¨å¯åŠ¨ä¹‹åä¾¿å¯ä»¥åœ¨ idea ä¸­å¯åŠ¨è¿™ä¸ª remote äº†ï¼Œè¿™æ ·ä¾¿å¯ä»¥æ­£å¸¸ debug äº†ã€‚</p><h2 id="æ¡ä»¶æ–­ç‚¹"><a href="#æ¡ä»¶æ–­ç‚¹" class="headerlink" title="æ¡ä»¶æ–­ç‚¹"></a>æ¡ä»¶æ–­ç‚¹</h2><p>ç¬¬äºŒä¸ªæ˜¯æ¡ä»¶æ–­ç‚¹ä¹Ÿéå¸¸æœ‰ç”¨ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦è°ƒè¯•ä¸€ä¸ªå…¬å…±å‡½æ•°ï¼Œè°ƒç”¨çš„åœ°æ–¹éå¸¸å¤šã€‚</p><p>è€Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒæŸä¸€ç±»è¡Œä¸ºçš„è°ƒç”¨ï¼Œæ­¤æ—¶å°±å¯ä»¥å¯¹è¿™ä¸ªå‡½æ•°ä¸­çš„å˜é‡è¿›è¡Œåˆ¤æ–­ï¼Œå½“ä»–ä»¬æ»¡è¶³æŸäº›æ¡ä»¶æ—¶å†è¿›å…¥æ–­ç‚¹ï¼Œè¿™æ ·å¯ä»¥æå¤§çš„æé«˜æˆ‘ä»¬çš„è°ƒè¯•æ•ˆç‡ï¼š<br><img src="https://s2.loli.net/2024/04/10/L9PkNyZprCql6Wd.png"></p><p>é…ç½®ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨æ–­ç‚¹ä¸Šå³é”®å°±å¯ä»¥ç¼–è¾‘æ¡ä»¶äº†ã€‚</p><h1 id="ç¤¾åŒºå’¨è¯¢"><a href="#ç¤¾åŒºå’¨è¯¢" class="headerlink" title="ç¤¾åŒºå’¨è¯¢"></a>ç¤¾åŒºå’¨è¯¢</h1><p>è™½ç„¶æˆ‘æ ¹æ®ç°è±¡åˆæ­¥å¯ä»¥çŒœæµ‹ä¸‹åŸå› ï¼Œä½†ä¾ç„¶ä¸ç¡®å®šå¦‚ä½•è°ƒæ•´æ‰èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œäºæ˜¯ä¾¿å»ç¤¾åŒºæäº†ä¸€ä¸ª <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/10921">issue</a>ã€‚</p><p><img src="https://s2.loli.net/2024/04/10/YHiIOfvxu1EUMpj.png"><br>æœ€ååœ¨ç¤¾åŒºå¤§ä½¬çš„å¸®åŠ©ä¸‹å‘ç°æˆ‘ä»¬éœ€è¦ç¦ç”¨æ‰ OpenTelemetry agent ä¸­çš„ä¸€ä¸ª resource å°±å¯ä»¥äº†ã€‚</p><p><img src="https://s2.loli.net/2024/04/10/EiX3mD9k6cwjMUf.png"><br>è¿™ä¸ª resource æ˜¯ç”± agent è§¦å‘çš„ï¼Œå®ƒä¼˜å…ˆäº spring boot ä¹‹å‰è¿›è¡Œ SPI çš„åŠ è½½ã€‚<br>ç›®çš„æ˜¯ä¸ºäº†ç»™ metric å’Œ trace æ–°å¢ä¸¤ä¸ªå±æ€§ï¼š<br><img src="https://s2.loli.net/2024/04/10/I39iXt4JfdwVn8S.png"></p><p><img src="https://s2.loli.net/2024/04/10/bH3wfUeCk4K9PJ5.png"><br>åŠ è½½çš„æ ¸å¿ƒä»£ç åœ¨è¿™é‡Œï¼Œåªè¦ç¦ç”¨æ‰ä¹‹åå°±ä¸ä¼šå†åŠ è½½äº†ã€‚</p><p>ç¦ç”¨å‰ï¼š<br><img src="https://s2.loli.net/2024/04/10/7ZIo2VaqesFXL53.png"></p><p>ç¦ç”¨åï¼š<br><img src="https://s2.loli.net/2024/04/10/k2yQBPxzMHFENjd.png"></p><p>å½“æˆ‘ä»¬ç¦ç”¨æ‰ä¹‹åå°±ä¸ä¼šå­˜åœ¨è¿™ä¸¤ä¸ªå±æ€§äº†ï¼Œä¸è¿‡æˆ‘ä»¬ç›®å‰å¹¶æ²¡æœ‰ä½¿ç”¨è¿™ä¸¤ä¸ªå±æ€§ï¼Œæ‰€ä»¥ä¸ºäº†ä½¿å¾— SPI ç”Ÿæ•ˆå°±åªæœ‰å…ˆç¦ç”¨æ‰äº†ï¼Œåç»­å†çœ‹çœ‹ç¤¾åŒºè¿˜æœ‰æ²¡æœ‰å…¶ä»–çš„æ–¹æ¡ˆã€‚</p><p>æƒ³è¦å¤ç° debug çš„å¯ä»¥åœ¨è¿™é‡Œå°è¯•ï¼š<br><a href="https://github.com/crossoverJie/demo">https://github.com/crossoverJie/demo</a></p><p>å‚è€ƒè¿æ¥ï¼š</p><ul><li><a href="https://github.com/TogetherOS/cicada">https://github.com/TogetherOS/cicada</a></li><li><a href="https://docs.spring.io/spring-boot/docs/current/maven-plugin/reference/htmlsingle/#packaging.repackage-goal">https://docs.spring.io/spring-boot/docs/current/maven-plugin/reference/htmlsingle/#packaging.repackage-goal</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/10921">https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/10921</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/instrumentation/resources/library/README.md#host">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/instrumentation/resources/library/README.md#host</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;å‰æ®µæ—¶é—´å…¬å¸é¢†å¯¼è®©æˆ‘æ’æŸ¥ä¸€ä¸ªå…³äºåœ¨ JDK21 ç¯å¢ƒä¸­ä½¿ç”¨ Spring Boot é…åˆä¸€ä¸ª JDK18 æ–°å¢çš„ä¸€ä¸ª SPI(&lt;code&gt;java.net.spi.InetAddressResolverProvider&lt;/code&gt;) ä¸ç”Ÿæ•ˆçš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;ä½†è¿™ä¸ªä¸ç”Ÿæ•ˆçš„å‰ç½®æ¡ä»¶æœ‰ç‚¹å¤šï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;JDK çš„ç‰ˆæœ¬å¾—åœ¨ 18+&lt;/li&gt;
&lt;li&gt;SpringBoot3.x&lt;/li&gt;
&lt;li&gt;è¿˜åœ¨é¢å¤–å†é…åˆä½¿ç”¨ &lt;code&gt;-javaagent:opentelemetry-javaagent.jar&lt;/code&gt; ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯ OpenTelemetry æä¾›çš„ agentã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ‰ä¼šå¯¼è‡´è‡ªå®šä¹‰çš„ &lt;code&gt;InetAddressResolverProvider&lt;/code&gt; æ— æ³•æ­£å¸¸å·¥ä½œã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•å¯¹ kubernetes åº”ç”¨åš e2e(ç«¯åˆ°ç«¯) æµ‹è¯•</title>
    <link href="http://crossoverjie.top/2024/05/05/ob/operator-e2e-test/"/>
    <id>http://crossoverjie.top/2024/05/05/ob/operator-e2e-test/</id>
    <published>2024-05-05T07:18:05.000Z</published>
    <updated>2024-05-05T13:13:35.451Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æœ€è¿‘åœ¨ç»™ <a href="https://github.com/open-telemetry/opentelemetry-operator/pull/2778">opentelemetry-operator</a>æäº¤ä¸€ä¸ªæ ‡ç­¾é€‰æ‹©å™¨çš„åŠŸèƒ½æ—¶ï¼Œå› ä¸ºå½“æ—¶ä¿®æ”¹çš„å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œæ— æ³•æ·»åŠ å•æµ‹å‡½æ•°ï¼Œæ‰€ä»¥ç¤¾åŒºå»ºè®®æˆ‘è¡¥å……ä¸€ä¸ª <code>e2e test</code>.</p><blockquote><p>å› ä¸ºåœ¨å½“å‰çš„ç‰ˆæœ¬ä¸‹ï¼Œåªè¦ç»™ deployment æ‰“ä¸Šäº† <code>instrumentation.opentelemetry.io/inject-java: &quot;true&quot;</code> è¿™ç±»æ³¨è§£å°±ä¼šç»™è¯¥ deployment æ³¨å…¥ agentã€‚<br>ä½†æ²¡åŠæ³•æŒ‡å®šä¸åŒçš„ agent ç‰ˆæœ¬ï¼ˆæˆ–è€…ä¸åŒçš„ç¯å¢ƒå˜é‡ï¼‰ï¼Œæ‰€ä»¥å¸Œæœ›å¯ä»¥æ–°å¢ä¸€ä¸ªé€‰æ‹©å™¨ï¼ŒåŒæ—¶å¯ä»¥é’ˆå¯¹ä¸åŒçš„ deployment ç»´æŠ¤ä¸åŒç‰ˆæœ¬çš„ <code>Instrumentation</code>(æ˜¯ç”¨äºæ§åˆ¶éœ€è¦æ³¨å…¥ deployment çš„èµ„æº)ï¼›è¿™æ ·å°±å¯ä»¥çµæ´»æ§åˆ¶äº†ã€‚</p></blockquote><span id="more"></span><p><img src="https://s2.loli.net/2024/03/26/8QEaeXC9YwJp56m.png"></p><p>åœ¨è¿™ä¹‹å‰æˆ‘å…¶å®ä¹Ÿå¾ˆå°‘åš kubernetes çš„ operator å¼€å‘ï¼Œå¯¹å¦‚ä½•åš kubernetes çš„ e2e æµ‹è¯•ä¹Ÿæ¯”è¾ƒé™Œç”Ÿï¼Œå¥½åœ¨ç¤¾åŒºæä¾›äº†è¯¦ç»†çš„è´¡çŒ®æ–‡æ¡£ã€‚</p><p><img src="https://s2.loli.net/2024/03/26/Fv6SCofEtubZjcH.png"></p><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>ç®€å•æ¥è¯´éœ€è¦ä¸¤ä¸ªå…³é”®ç»„ä»¶ï¼š</p><ul><li><a href="https://kind.sigs.k8s.io/">kind</a>: kubernetes in dockerï¼Œæ˜¯å¯ä»¥åœ¨æœ¬åœ°åˆ©ç”¨ docker å¯åŠ¨ä¸€ä¸ª kubernetes é›†ç¾¤çš„å·¥å…·ï¼Œé€šå¸¸ç”¨äºåœ¨æœ¬åœ°è¿›è¡Œå¼€å‘ã€æµ‹è¯•å…³äº kubernetes ç›¸å…³çš„åŠŸèƒ½ã€‚<ul><li>å®‰è£… kind çš„å‰ææ˜¯æœ¬åœ°å·²ç»å®‰è£…å¥½äº† dockerã€‚</li></ul></li><li><a href="https://kyverno.github.io/chainsaw/latest/">chainsaw</a>: ä¸€ä¸ª e2e æµ‹è¯•æ¡†æ¶ï¼Œæä¾›äº†å£°æ˜å¼çš„æ–¹å¼å®šä¹‰æµ‹è¯•ç”¨ä¾‹ï¼Œä¹Ÿæœ‰ç€ä¸°å¯Œæ–­è¨€åŠŸèƒ½ã€‚</li></ul><p>ä»–ä»¬çš„å®‰è£…éƒ½å¾ˆç®€å•ï¼Œåªè¦æœ¬åœ°å®‰è£…å¥½äº† golangï¼Œç›´æ¥ä½¿ç”¨ go install å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go install sigs.k8s.io/kind@v0.22.0</span><br><span class="line">go install github.com/kyverno/chainsaw@latest</span><br></pre></td></tr></table></figure><h2 id="kind-ä½¿ç”¨"><a href="#kind-ä½¿ç”¨" class="headerlink" title="kind ä½¿ç”¨"></a>kind ä½¿ç”¨</h2><p>åœ¨å¼€å§‹å‰è¿˜æ˜¯å…ˆé¢„ä¹ ä¸‹ kind çš„åŸºæœ¬ä½¿ç”¨ã€‚</p><p>å®‰è£…å¥½ kind ä¹‹åï¼Œä½¿ç”¨ create cluster å‘½ä»¤å¯ä»¥åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ª <code>kubernetes</code> é›†ç¾¤ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kind create cluster -h</span><br><span class="line">Creates a local Kubernetes cluster using Docker container &#x27;nodes&#x27;</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  kind create cluster [flags]</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/03/27/znDfd3m5HeyrXi4.png"><br>ä¹‹ååªéœ€è¦ç­‰å¾…é›†ç¾¤å®‰è£…æˆåŠŸå³å¯ï¼Œå®ƒä¼šåœ¨æˆ‘ä»¬çš„ <code>cat ~/.kube/config</code> æ–‡ä»¶ä¸­è¿½åŠ åˆšæ‰æ–°å»ºé›†ç¾¤çš„è¿æ¥ä¿¡æ¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k config get-contexts</span><br><span class="line">k config use-context xxx</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹å’Œåˆ‡æ¢ä¸åŒçš„é›†ç¾¤äº†ï¼Œè™½è¯´æ˜¯ä¸€ä¸ªæœ¬åœ°æ¨¡æ‹Ÿçš„ kubernetes é›†ç¾¤ï¼Œä½†ä»–çš„æ ¸å¿ƒåŠŸèƒ½å’Œä¸€ä¸ªæ ‡å‡†çš„é›†ç¾¤æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kind delete clusters --all</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å®Œæˆä¹‹åå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤å°†æ‰€æœ‰é›†ç¾¤éƒ½åˆ é™¤æ‰ã€‚</p><h1 id="å‡†å¤‡é›†ç¾¤æ•°æ®"><a href="#å‡†å¤‡é›†ç¾¤æ•°æ®" class="headerlink" title="å‡†å¤‡é›†ç¾¤æ•°æ®"></a>å‡†å¤‡é›†ç¾¤æ•°æ®</h1><p>åœ¨ <code>opentelemetry-operator</code> ä¸­æœ‰ç»™æˆ‘ä»¬å‡†å¤‡å¥½ä¸€ä¸ª make å‘½ä»¤: <code>make prepare-e2e</code> ï¼›ä½¿ç”¨å®ƒä¼šå¸®æˆ‘ä»¬å°† operator çš„æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å¥½ã€‚</p><p>å¤§æ¦‚åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p><ul><li>å®‰è£… chainsaw</li><li>ä¿®æ”¹ controller çš„é•œåƒä¸ºæˆ‘ä»¬æœ¬åœ°æ„å»ºçš„é•œåƒåç§°</li><li>æœ¬åœ° docker é•œåƒæ‰“åŒ…</li><li>å®‰è£… cert-manager</li><li>å®‰è£… Operator éœ€è¦çš„ CRD</li><li>éƒ¨ç½² Operator deployment</li><li>ç­‰å¾… Operator å¯åŠ¨æˆåŠŸ</li></ul><p>ä¸è¿‡è¿™é‡Œçš„å®‰è£…è¿‡ç¨‹å¯èƒ½ä¼šé‡åˆ°é—®é¢˜ï¼ˆæœ¬è´¨ä¸Šéƒ½æ˜¯æˆ‘ä»¬çš„ç½‘ç»œé—®é¢˜ï¼‰ï¼š<br><img src="https://s2.loli.net/2024/03/25/bYWdfOv9B27c8RE.png"><br><img src="https://s2.loli.net/2024/03/25/kH4b7I3UlngzENA.png"><br>è¿™ç§æƒ…å†µå¯ä»¥æƒ³åŠæ³•ï¼ˆç§‘å­¦ä¸Šç½‘ï¼‰æ‰‹åŠ¨å…ˆæŠŠé•œåƒæ‹‰å–åˆ°æœ¬åœ°ï¼Œç„¶å kubernetes å°±ä¼šä»æœ¬åœ°ä»“åº“è·å–åˆ°è¿™ä¸ªé•œåƒã€‚</p><h1 id="e2e-test"><a href="#e2e-test" class="headerlink" title="e2e test"></a>e2e test</h1><p>é€šå¸¸æˆ‘ä»¬éœ€è¦å°†åŒä¸€ç±»çš„æµ‹è¯•åŠŸèƒ½æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œï¼Œæ¯”å¦‚è¿™æ ·ï¼š<br><img src="https://s2.loli.net/2024/03/27/eh8Rk4uFfWTHtna.png"><br>é»˜è®¤æƒ…å†µä¸‹ Chainsaw ä¼šæŸ¥æ‰¾ç›®å½•ä¸‹åä¸º <code>chainsaw-test.yaml</code> ä½œä¸ºå¼•å¯¼æ–‡ä»¶ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">chainsaw.kyverno.io/v1alpha1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Test</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">instrumentation-java</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">steps:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">step-00</span>  </span><br><span class="line">    <span class="attr">try:</span>   </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">command:</span>  </span><br><span class="line">        <span class="attr">entrypoint:</span> <span class="string">kubectl</span>  </span><br><span class="line">        <span class="attr">args:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">annotate</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">namespace</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">$&#123;NAMESPACE&#125;</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">openshift.io/sa.scc.uid-range=1000/1000</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">--overwrite</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">command:</span>  </span><br><span class="line">        <span class="attr">entrypoint:</span> <span class="string">kubectl</span>  </span><br><span class="line">        <span class="attr">args:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">annotate</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">namespace</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">$&#123;NAMESPACE&#125;</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">openshift.io/sa.scc.supplemental-groups=3000/3000</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">--overwrite</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apply:</span>  </span><br><span class="line">        <span class="attr">file:</span> <span class="number">00</span><span class="string">-install-collector.yaml</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apply:</span>  </span><br><span class="line">        <span class="attr">file:</span> <span class="number">00</span><span class="string">-install-instrumentation-select.yaml</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">step-01</span>  </span><br><span class="line">    <span class="attr">try:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apply:</span>  </span><br><span class="line">        <span class="attr">file:</span> <span class="number">01</span><span class="string">-install-app-select.yaml</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">assert:</span>  </span><br><span class="line">        <span class="attr">file:</span> <span class="number">01</span><span class="string">-assert*.yaml</span>  </span><br><span class="line">    <span class="attr">catch:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">podLogs:</span>  </span><br><span class="line">          <span class="attr">selector:</span> <span class="string">app=my-java-select</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tests/e2e-instrumentation/instrumentation-select</span><br><span class="line">â”œâ”€â”€ 00-install-collector.yaml</span><br><span class="line">â”œâ”€â”€ 00-install-instrumentation-select.yaml</span><br><span class="line">â”œâ”€â”€ 01-assert-select.yaml</span><br><span class="line">â”œâ”€â”€ 01-assert-without-select.yaml</span><br><span class="line">â”œâ”€â”€ 01-install-app-select.yaml</span><br><span class="line">â””â”€â”€ chainsaw-test.yaml</span><br></pre></td></tr></table></figure><p>ä»¥æˆ‘è¿™é‡Œçš„è¿™ä»½æ–‡ä»¶ä¸ºä¾‹ï¼Œåœ¨å…¶ä¸­å®šä¹‰äº†å‡ ä¸ªæ­¥éª¤ï¼š</p><ul><li>åˆå§‹åŒ–ç¯å¢ƒä¿¡æ¯ï¼ŒåŒ…å«åˆ›å»º namespace</li><li>å®‰è£…æˆ‘ä»¬æµ‹è¯•æ‰€éœ€è¦çš„èµ„æº<ul><li>00-install-collector.yamlï¼šè¿™é‡Œä¸»è¦æ˜¯å®‰è£…ä¸€ä¸ª OpenTelemetry çš„ collector</li><li>00-install-instrumentation-select.yamlï¼šå®‰è£… Instrumentation æ³¨å…¥èµ„æº</li><li>01-install-app-select.yamlï¼šåº”ç”¨ä¸€ä¸ªæˆ‘ä»¬éœ€è¦æµ‹è¯•çš„ deployment èµ„æº</li><li><code>01-assert*.yaml</code>ï¼šæœ€åå¯¹æœ€ç»ˆç”Ÿæˆçš„ yaml èµ„æºä¸ assert*.yaml çš„è¿›è¡Œæ–­è¨€åŒ¹é…ï¼Œåªæœ‰åŒ¹é…æˆåŠŸåæ‰èƒ½æµ‹è¯•æˆåŠŸã€‚</li></ul></li></ul><blockquote><p>è¿™é‡Œçš„æµ‹è¯•ç›®çš„ä¸»è¦æ˜¯å®Œæˆä¸€ä¸ªå®Œæ•´çš„ Java åº”ç”¨çš„ deployment æ³¨å…¥ OpenTelemetry çš„ agent è¿‡ç¨‹è¿˜æœ‰ä¸€äº›ä¸ OpenTelemetry ç›¸å…³çš„ç¯å¢ƒå˜é‡ã€‚</p></blockquote><p>ä»¥ <code>00-install-instrumentation-select.yaml</code> æ–‡ä»¶ä¸ºä¾‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Instrumentation</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-select</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">matchLabels:</span>  </span><br><span class="line">      <span class="attr">app:</span> <span class="string">my-java-select</span>  </span><br><span class="line">  <span class="attr">env:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_EXPORTER</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">otlp</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">http://localhost:4317</span>  </span><br><span class="line">  <span class="attr">exporter:</span>  </span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">http://localhost:4317</span>  </span><br><span class="line">  <span class="attr">propagators:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="string">jaeger</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="string">b3</span>  </span><br><span class="line">  <span class="attr">sampler:</span>  </span><br><span class="line">    <span class="attr">type:</span> <span class="string">parentbased_traceidratio</span>  </span><br><span class="line">    <span class="attr">argument:</span> <span class="string">&quot;0.25&quot;</span>  </span><br><span class="line">  <span class="attr">java:</span>  </span><br><span class="line">    <span class="attr">env:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_JAVAAGENT_DEBUG</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;true&quot;</span>  </span><br></pre></td></tr></table></figure><p>å®ƒçš„é¢„æœŸæ•ˆæœæ˜¯é€‰æ‹© <code>app: my-java-select</code> çš„ deployment å°†è¿™äº›ç¯å¢ƒå˜é‡éƒ½æ³¨å…¥è¿›å»ï¼ŒåŒæ—¶é»˜è®¤ä¹Ÿä¼šåœ¨ deployment çš„å®¹å™¨ä¸­æŒ‚è½½ä¸€ä¸ª <code>javaagent.jar</code>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /otel-auto-instrumentation-java/</span><br><span class="line">javaagent.jar</span><br></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬çš„ <code>01-assert-select.yaml</code>:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">annotations:</span>  </span><br><span class="line">    <span class="attr">instrumentation.opentelemetry.io/inject-java:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">    <span class="attr">sidecar.opentelemetry.io/inject:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-java-select</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">containers:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">env:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_JAVAAGENT_DEBUG</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_TOOL_OPTIONS</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">&#x27; -javaagent:/otel-auto-instrumentation-java/javaagent.jar&#x27;</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_EXPORTER</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">otlp</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">http://localhost:4317</span>    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_SAMPLER</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">parentbased_traceidratio</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_SERVICE_NAME</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">my-java-select</span>   </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_PROPAGATORS</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">jaeger,b3</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_RESOURCE_ATTRIBUTES</span>  </span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="string">--config=env:OTEL_CONFIG</span>  </span><br><span class="line">    <span class="attr">name:</span> <span class="string">otc-container</span>  </span><br><span class="line">  <span class="attr">initContainers:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opentelemetry-auto-instrumentation-java</span>  </span><br><span class="line"><span class="attr">status:</span>  </span><br><span class="line">  <span class="attr">containerStatuses:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span>  </span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span>  </span><br><span class="line">    <span class="attr">started:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="attr">initContainerStatuses:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opentelemetry-auto-instrumentation-java</span>  </span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Running</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå°±æ˜¯æŠŠå®é™…çš„ <code>deployment</code> çš„ yaml å†…å®¹å’Œè¿™ä»½æ–‡ä»¶è¿›è¡Œå¯¹æ¯”ã€‚</p><p>æ‰€ä»¥è¿™ä¸ª e2e æµ‹è¯•å°±æœ‰ç‚¹ç±»ä¼¼äºé›†æˆæµ‹è¯•ï¼Œä¸ä¼šæµ‹è¯•å…·ä½“çš„åŠŸèƒ½å‡½æ•°ï¼Œåªéœ€è¦æœ€ç»ˆç»“æœèƒ½åŒ¹é…å°±å¯ä»¥ã€‚</p><blockquote><p>å½“ç„¶è¿™ä¸ªå’Œå•å…ƒæµ‹è¯•ä¹Ÿæ˜¯ç›¸è¾…ç›¸æˆçš„ï¼Œç¼ºä¸€ä¸å¯ï¼Œä¸èƒ½å®Œå…¨åªä¾èµ– e2e æµ‹è¯•ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ¦‚ç‡åŸå› å¯¼è‡´æœ€ç»ˆç”Ÿæˆçš„èµ„æºç›¸åŒï¼›å•å…ƒæµ‹è¯•å¯ä»¥ä¿è¯å‡½æ•°åŠŸèƒ½ä¸é¢„æœŸç›¸åŒã€‚</p></blockquote><hr><p>éƒ½å‡†å¤‡å¥½ä¹‹åä¾¿å¯ä»¥è¿›è¡Œæµ‹è¯•äº†ï¼Œæµ‹è¯•çš„æ—¶å€™ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chainsaw test --test-dir ./tests/e2e-multi-instrumentation</span><br></pre></td></tr></table></figure><p>è¿™æ ·å®ƒå°±ä¼šéå†è¯¥ç›®å½•ä¸‹çš„ <code>chainsaw-test.yaml</code>æ–‡ä»¶è¿›è¡Œæµ‹è¯•ï¼Œæ‰§è¡Œæˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„é‚£äº›æ­¥éª¤ï¼Œæœ€ç»ˆè¾“å‡ºæµ‹è¯•ç»“æœï¼š</p><p><img src="https://s2.loli.net/2024/03/27/VBwbKLdGjIXODrF.png"></p><p>åŒæ—¶ Chainsaw ä¹Ÿæä¾›äº† Github actionï¼Œå¯ä»¥æ–¹ä¾¿çš„è®©æˆ‘ä»¬å’Œ github CI è¿›è¡Œé›†æˆã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">example:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">permissions:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Chainsaw</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Chainsaw</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">kyverno/action-install-chainsaw@v0.1.0</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">release:</span> <span class="string">v0.0.9</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">install</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">chainsaw</span> <span class="string">version</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ github ä¸­æŸ¥çœ‹æˆ‘ä»¬çš„æµ‹è¯•ç»“æœäº†ï¼š<br><img src="https://s2.loli.net/2024/03/27/MaoL7EBmOZfsHd9.png"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ€åä¸å¾—ä¸æ„Ÿå¹ä½œä¸º CNCF ä¸‹é¢çš„é¡¹ç›® OpenTelemetry çš„å¼€å‘è€…ä½“éªŒçœŸå¥½ï¼Œåªè¦æˆ‘ä»¬è·Ÿç€<a href="https://github.com/open-telemetry/opentelemetry-operator/blob/main/CONTRIBUTING.md">è´¡çŒ®è€…æ–‡æ¡£</a>ä¸€æ­¥æ­¥æ“ä½œéƒ½èƒ½é¡ºåˆ©é€šè¿‡ CI æµ‹è¯•ï¼ŒåŒæ—¶è¿˜èƒ½é¿å…ä¸€äº› Code Review è¿‡ç¨‹ä¸­çš„ä½çº§é”™è¯¯ã€‚</p><p><img src="https://s2.loli.net/2024/03/27/kQGfWAhYHiyNXUq.png"><br>æ¯”å¦‚æˆ‘ç¬¬ä¸€æ¬¡æ PR çš„æ—¶å€™æ²¡æœ‰æ·»åŠ  changlog æ–‡ä»¶ï¼Œåé¢åœ¨è´¡çŒ®è€…æ‰‹å†Œé‡Œå‘ç°åªéœ€è¦æ‰§è¡Œ <code>make chlog-new</code> å°±ä¼šåŸºäºå½“å‰åˆ†æ”¯ä¿¡æ¯å¸®æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ª changelog æ–‡ä»¶æ¨¡æ¿ï¼Œç„¶ååªéœ€è¦å¾€é‡Œé¢å¡«å†™å†…å®¹å³å¯ã€‚</p><p>è¿™äº›å·¥å…·é“¾è®©ä¸åŒå¼€å‘è€…æäº¤çš„ä»£ç å’Œæµç¨‹éƒ½ç¬¦åˆè§„èŒƒï¼ŒåŒæ—¶ä¹Ÿé™ä½äº†è´¡çŒ®éš¾åº¦ã€‚</p><p>ä»¥ä¸Šæ‰€æœ‰çš„ç›¸å…³æºç éƒ½å¯ä»¥åœ¨ <a href="https://github.com/open-telemetry/opentelemetry-operator">https://github.com/open-telemetry/opentelemetry-operator</a> ä¸­è¿›è¡ŒæŸ¥çœ‹ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-operator/pull/2778">https://github.com/open-telemetry/opentelemetry-operator/pull/2778</a></li><li><a href="https://kind.sigs.k8s.io/">https://kind.sigs.k8s.io/</a></li><li><a href="https://kyverno.github.io/chainsaw/latest/">https://kyverno.github.io/chainsaw/latest/</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-operator/blob/main/CONTRIBUTING.md">https://github.com/open-telemetry/opentelemetry-operator/blob/main/CONTRIBUTING.md</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;æœ€è¿‘åœ¨ç»™ &lt;a href=&quot;https://github.com/open-telemetry/opentelemetry-operator/pull/2778&quot;&gt;opentelemetry-operator&lt;/a&gt;æäº¤ä¸€ä¸ªæ ‡ç­¾é€‰æ‹©å™¨çš„åŠŸèƒ½æ—¶ï¼Œå› ä¸ºå½“æ—¶ä¿®æ”¹çš„å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œæ— æ³•æ·»åŠ å•æµ‹å‡½æ•°ï¼Œæ‰€ä»¥ç¤¾åŒºå»ºè®®æˆ‘è¡¥å……ä¸€ä¸ª &lt;code&gt;e2e test&lt;/code&gt;.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å› ä¸ºåœ¨å½“å‰çš„ç‰ˆæœ¬ä¸‹ï¼Œåªè¦ç»™ deployment æ‰“ä¸Šäº† &lt;code&gt;instrumentation.opentelemetry.io/inject-java: &amp;quot;true&amp;quot;&lt;/code&gt; è¿™ç±»æ³¨è§£å°±ä¼šç»™è¯¥ deployment æ³¨å…¥ agentã€‚&lt;br&gt;ä½†æ²¡åŠæ³•æŒ‡å®šä¸åŒçš„ agent ç‰ˆæœ¬ï¼ˆæˆ–è€…ä¸åŒçš„ç¯å¢ƒå˜é‡ï¼‰ï¼Œæ‰€ä»¥å¸Œæœ›å¯ä»¥æ–°å¢ä¸€ä¸ªé€‰æ‹©å™¨ï¼ŒåŒæ—¶å¯ä»¥é’ˆå¯¹ä¸åŒçš„ deployment ç»´æŠ¤ä¸åŒç‰ˆæœ¬çš„ &lt;code&gt;Instrumentation&lt;/code&gt;(æ˜¯ç”¨äºæ§åˆ¶éœ€è¦æ³¨å…¥ deployment çš„èµ„æº)ï¼›è¿™æ ·å°±å¯ä»¥çµæ´»æ§åˆ¶äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="k8s" scheme="http://crossoverjie.top/tags/k8s/"/>
    
    <category term="operator" scheme="http://crossoverjie.top/tags/operator/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ¬¡æ¶ˆæ¯é˜Ÿåˆ—å¼‚å¸¸å †ç§¯çš„æ’æŸ¥</title>
    <link href="http://crossoverjie.top/2024/04/29/ob/pulsar-slow-consume/"/>
    <id>http://crossoverjie.top/2024/04/29/ob/pulsar-slow-consume/</id>
    <published>2024-04-29T07:47:10.000Z</published>
    <updated>2024-04-29T02:24:24.167Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å‰ä¸¤å¤©æ”¶åˆ°ä¸šåŠ¡åé¦ˆæœ‰ä¸€ä¸ª topic çš„åˆ†åŒºæ¶ˆæ¯å †ç§¯äº†ï¼š<br><img src="https://s2.loli.net/2024/03/24/Ckb3MRswVAvjXfn.png"><br>æ ¹æ®ä¹‹å‰çš„ç»éªŒæ¥çœ‹ï¼Œè¦ä¹ˆæ˜¯ä¸šåŠ¡æ¶ˆè´¹é€»è¾‘å‡ºç°é—®é¢˜å¯¼è‡´æ¶ˆè´¹è¿‡æ…¢ï¼Œå½“ç„¶ä¹Ÿæœ‰å°æ¦‚ç‡æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ Bugï¼ˆæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ pulsarï¼‰ã€‚</p><span id="more"></span><h1 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h1><p><img src="https://s2.loli.net/2024/03/24/6TBk2Jo9sWZpRGe.png"><br>é€šè¿‡æ’æŸ¥ï¼Œå‘ç°ç¡®å®æ˜¯åœ¨ä¸€ç‚¹å¤šçš„æ—¶å€™æ¶ˆæ¯å †ç§¯äº†ï¼ˆåé¢æ˜¯ä¿®å¤ä¹‹åå †ç§¯å¼€å§‹ä¸‹é™ï¼‰ã€‚</p><p>äºæ˜¯æˆ‘åœ¨åˆšæ‰å †ç§¯å¤„æŸ¥çœ‹äº†ä¸€æ¡å †ç§¯æ¶ˆæ¯çš„åˆ—è¡¨ï¼š<br><img src="https://s2.loli.net/2024/03/24/UeizjIc3brVfnNy.png"></p><p>è·å–åˆ°å…¶ä¸­ä¸€æ¡æ¶ˆæ¯çš„ <code>messageId</code>.</p><blockquote><p>è¿™é‡Œæœ¬è´¨ä¸Šä½¿ç”¨çš„æ˜¯ pulsar-admin çš„ APIã€‚<br><a href="https://pulsar.apache.org/docs/3.2.x/admin-api-topics/#peek-messages"><code>org.apache.pulsar.client.admin.Topics#peekMessages</code></a></p></blockquote><p><img src="https://s2.loli.net/2024/03/24/IEGwRWphsFf6xk2.png"><br>å†é€šè¿‡è¿™æ¡æ¶ˆæ¯çš„ id ï¼ˆä¸ºäº†æ¼”ç¤ºï¼Œè¿™é‡Œçš„ messageId å¯èƒ½ä¸ä¸€æ ·ï¼‰åœ¨æˆ‘ä»¬çš„ pulsar æ¶ˆæ¯é“¾è·¯ç³»ç»Ÿä¸­æ‰¾åˆ°äº†æ¶ˆæ¯çš„å‘é€é“¾è·¯ï¼š<br><img src="https://s2.loli.net/2024/03/24/CwQRAWXMu8Hxq5y.png"><br>é€šè¿‡è¿™ä¸ªé“¾è·¯ä¼šå‘ç°æ¶ˆæ¯ä¸€ç›´åœ¨æ¨é€ï¼Œä½†å°±æ˜¯æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯çš„ ACK å“åº”ã€‚</p><blockquote><p>ç›¸å…³çš„æ¶ˆæ¯é“¾è·¯åŸ‹ç‚¹å¯ä»¥å‚è€ƒè¿™é‡Œï¼š<a href="https://crossoverjie.top/2023/12/11/ob/Pulsar-Broker-Interceptor/">å¦‚ä½•ç¼–å†™ä¸€ä¸ª Pulsar Broker Interceptor æ’ä»¶</a></p></blockquote><p>ç®€å•æ¥è¯´å°±æ˜¯åœ¨ä»¥ä¸‹å‡ ä¸ª broker æä¾›çš„æ‹¦æˆªå™¨æ¥å£åŠ ä¸ŠåŸ‹ç‚¹æ•°æ®å³å¯ï¼š</p><ul><li>messageProduced</li><li>messageDispatched</li><li>messageAcked</li></ul><p>æ—¢ç„¶çŸ¥é“äº†æ˜¯å®¢æˆ·ç«¯æ²¡æœ‰å“åº” ACKï¼Œé‚£å°±å¾—çŸ¥é“å®¢æˆ·ç«¯æ­¤æ—¶åœ¨å¹²ä»€ä¹ˆã€‚</p><p>é¦–å…ˆæ’æŸ¥äº† JVM å†…å­˜ã€CPU ç­‰ç›‘æ§æƒ…å†µï¼Œå‘ç°ä¸€åˆ‡éƒ½æŒºæ­£å¸¸çš„ï¼Œè¿™æ®µæ—¶é—´æ²¡æœ‰æ˜æ˜¾çš„å°–åˆºã€‚</p><h2 id="Arthas-æ’æŸ¥"><a href="#Arthas-æ’æŸ¥" class="headerlink" title="Arthas æ’æŸ¥"></a>Arthas æ’æŸ¥</h2><p>äºæ˜¯ä¾¿å‡†å¤‡ä½¿ç”¨ arthas æŸ¥çœ‹ä¸‹çº¿ç¨‹çš„è¿è¡Œæƒ…å†µã€‚</p><p>æˆ‘ä»¬è¿›å…¥åˆ°å¯¹åº” Pod çš„å®¹å™¨ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar</span><br></pre></td></tr></table></figure><p>å› ä¸º JVM å†…å­˜éƒ½æ²¡æœ‰å•¥å¼‚å¸¸ï¼Œæ‰€ä»¥å…ˆçœ‹çœ‹ thread çš„è¿è¡Œå †æ ˆï¼Œè€ƒè™‘åˆ°æ˜¯ pulsar æ¶ˆè´¹çº¿ç¨‹å¡ä½äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ ä¸Šçº¿ç¨‹çŠ¶æ€å·²ç»è¿‡æ»¤ä¸‹çº¿ç¨‹çš„åç§°ï¼š<br><img src="https://s2.loli.net/2024/03/24/brPcepjMFKaC9d8.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread --state WAITING | grep pulsar</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±ä¼šåˆ—å‡ºå½“å‰ Java è¿›ç¨‹ä¸­çŠ¶æ€ä¸º WATING å¹¶ä¸”çº¿ç¨‹åç§°ä»¥ pulsar å¼€å¤´çš„çº¿ç¨‹ã€‚</p><blockquote><p>æˆ‘åœ¨ä¹‹å‰çš„æ–‡ç«  <a href="https://crossoverjie.top/2023/08/03/ob/Pulsar-Client/">ä» Pulsar Client çš„åŸç†åˆ°å®ƒçš„ç›‘æ§é¢æ¿</a> ä¸­åˆ†æè¿‡å®¢æˆ·ç«¯çš„åŸç†ã€‚</p></blockquote><p><img src="https://s2.loli.net/2023/08/02/vweWVR8fkJgrSMI.png" alt="20230802224400.png"><br><img src="https://s2.loli.net/2024/03/24/h7KQXueLySHYotW.png"></p><p>å¯ä»¥çŸ¥é“ pulsar å®¢æˆ·ç«¯åœ¨å…¶ä¸­ä½¿ç”¨çš„æ˜¯ <code>pulsar-</code>æ‰“å¤´çš„çº¿ç¨‹åç§°ï¼Œæ‰€ä»¥è¿™æ ·å°±åˆ—å‡ºäº†æˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„çº¿ç¨‹ã€‚</p><p>æˆ‘ä»¬ä»¥å›¾ä¸­åˆ—å‡ºçš„çº¿ç¨‹ Idï¼š320 ä¸ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread 320</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/03/24/cT1Eylp6aXd5QeZ.png"><br>æ­¤æ—¶ä¾¿ä¼šæ‰“å°å½“å‰çº¿ç¨‹çš„å †æ ˆã€‚</p><p>ä»ä¸Šè¿°å †æ ˆä¸­ä¼šå‘ç°çº¿ç¨‹ä¸€ç›´å¤„äº IO æ“ä½œä¸­ï¼Œçœ‹èµ·æ¥æ˜¯åœ¨æ“ä½œæ•°æ®åº“ã€‚</p><p>æˆ‘ä»¬å†å¾€ä¸‹ç¿»ä¸€ç¿»ï¼Œä¼šå‘ç°ä¸Šå±‚è°ƒç”¨çš„ä¸šåŠ¡ä»£ç ï¼š<br><img src="https://s2.loli.net/2024/03/24/BhFGeJ7X6DLbC1s.png"><br>æŸ¥é˜…ä»£ç å¾—çŸ¥è¿™æ˜¯ä¸€ä¸ªæ•°æ®åº“çš„å†™å…¥æ“ä½œï¼Œçœ‹èµ·æ¥æ˜¯åœ¨è¿™ä¸ªç¯èŠ‚æ•°æ®åº“å“åº”è¿‡æ…¢å¯¼è‡´çš„ pulsar çº¿ç¨‹è¢«é˜»å¡äº†ï¼›ä»è€Œå¯¼è‡´æ¶ˆæ¯æ²¡æœ‰åŠæ—¶ ACKã€‚</p><p>ä¸ºäº†æœ€ç»ˆç¡®è®¤æ˜¯å¦ç”±æ•°æ®åº“å¼•èµ·çš„ï¼Œäºæ˜¯ç»§ç»­æŸ¥è¯¢äº†å½“å‰åº”ç”¨çš„æ…¢ SQL æƒ…å†µï¼š<br><img src="https://s2.loli.net/2024/03/24/vcYDGapUVms82Jl.png"></p><p>å‘ç°å…¶ä¸­æœ‰ä¸€ä¸ªæŸ¥è¯¢è¯­å¥è°ƒç”¨é¢‘æ¬¡å’Œå¹³å‡è€—æ—¶éƒ½æ¯”è¾ƒé«˜ï¼Œè€Œä¸”æ­£å¥½è¿™ä¸ªè¡¨ä¹Ÿæ˜¯åˆšæ‰åœ¨å †æ ˆé‡Œæ“ä½œçš„é‚£å¼ è¡¨ã€‚</p><p>ç»è¿‡ä¸šåŠ¡æ’æŸ¥å‘ç°è¿™ä¸ªæ…¢ SQL æ˜¯ç”±ä¸€ä¸ªå®šæ—¶ä»»åŠ¡è§¦å‘çš„ï¼Œè€Œè¿™ä¸ªå®šæ—¶ä»»åŠ¡ç”±äºæŸäº›åŸå› ä¸€ç›´ä¹Ÿæ²¡æœ‰åœæ­¢ï¼Œæ‰€ä»¥ä¸ºäº†å¿«é€Ÿè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆå°è¯•å°†è¿™ä¸ªå®šæ—¶ä»»åŠ¡åœæ‰ã€‚</p><p>æœç„¶åœæ‰æ²¡å¤šä¹…åæ¶ˆæ¯å°±å¼€å§‹å¿«é€Ÿæ¶ˆè´¹äº†ï¼š<br><img src="https://s2.loli.net/2024/03/24/wlDtCeBZL6IjkRM.png"><br>ä»è¿™ä¸ªæ—¶é—´çº¿ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥äº†ï¼Œåœ¨æœåŠ¡ç«¯æ¨é€äº†å¤šæ¬¡ä¹‹åç»ˆäºæ”¶åˆ°äº† ACKã€‚</p><p>ä¿®å¤ä¹‹åä¸šåŠ¡å†å»æ’æŸ¥ä¼˜åŒ–è¿™ä¸ªæ…¢ SQLï¼Œè¿™æ ·è¿™ä¸ªé—®é¢˜å°±å¾—åˆ°æ ¹æœ¬çš„è§£å†³äº†ã€‚</p><h1 id="æ›´å¤šå¥½ç”¨æŠ€å·§"><a href="#æ›´å¤šå¥½ç”¨æŠ€å·§" class="headerlink" title="æ›´å¤šå¥½ç”¨æŠ€å·§"></a>æ›´å¤šå¥½ç”¨æŠ€å·§</h1><p>å½“ç„¶ arthas å¥½ç”¨çš„åŠŸèƒ½è¿˜è¿œä¸æ­¢æ­¤ï¼Œæˆ‘è§‰å¾—è¿˜æœ‰ä»¥ä¸‹åŠŸèƒ½æ¯”è¾ƒå¥½ç”¨ï¼š</p><h2 id="ç«ç„°å›¾"><a href="#ç«ç„°å›¾" class="headerlink" title="ç«ç„°å›¾"></a>ç«ç„°å›¾</h2><p>profileï¼šå¯ä»¥è¾“å‡ºç«ç„°å›¾ï¼Œåœ¨åšæ€§èƒ½åˆ†æçš„æ—¶å€™éå¸¸æœ‰ç”¨ã€‚<br><img src="https://s2.loli.net/2024/03/24/2qsjgQMCRhtxNdm.png"></p><h2 id="åŠ¨æ€ä¿®æ”¹å†…å­˜æ•°æ®"><a href="#åŠ¨æ€ä¿®æ”¹å†…å­˜æ•°æ®" class="headerlink" title="åŠ¨æ€ä¿®æ”¹å†…å­˜æ•°æ®"></a>åŠ¨æ€ä¿®æ”¹å†…å­˜æ•°æ®</h2><p>è¿˜è®°å¾—ä¹‹å‰æˆ‘ä»¬ç¢°åˆ°è¿‡ä¸€ä¸ª pulsar <a href="https://crossoverjie.top/2024/01/09/ob/Pulsar-Delete-Topic/">åˆ é™¤ topic çš„ Bug</a>ï¼Œè™½ç„¶æœ€ç»ˆä¿®å¤äº†é—®é¢˜ï¼Œä½†æ˜¯åœ¨å‘å¸ƒä¿®å¤ç‰ˆæœ¬çš„æ—¶å€™ä¸ºäº†é¿å…å†æ¬¡è§¦å‘è€ç‰ˆæœ¬çš„ bugï¼Œéœ€è¦åœ¨å†…å­˜ä¸­å°†æŸä¸ªå…³é”®å­—æ®µçš„å€¼ä¿®æ”¹æ‰ã€‚</p><p>è€Œä¸”æ˜¯ä¸èƒ½é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹ä¿®æ”¹ï¼Œæ­¤æ—¶ä½¿ç”¨ arthas å°±éå¸¸çš„æ–¹ä¾¿ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://arthas.aliyun.com/arthas-boot.jar &amp;&amp; java -jar arthas-boot.jar 1 -c &quot;vmtool -x 3 --action getInstances --className org.apache.pulsar.broker.ServiceConfiguration  --express &#x27;instances[0].setTopicLevelPoliciesEnabled(false)&#x27;&quot;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>vmtool</code> è¿™ä¸ªå­å‘½ä»¤æ¥è·å–å¯¹è±¡ï¼Œæœ€ç»ˆå†ä½¿ç”¨ <code>express</code> è¡¨è¾¾å¼å°†å…¶ä¸­çš„å€¼æ”¹ä¸ºäº† falseã€‚</p><p>å½“ç„¶è¿™æ˜¯ä¸€ä¸ªé«˜å±æ“ä½œï¼Œä¸åˆ°ä¸‡ä¸å¾—å·²ä¸æ¨èè¿™ä¹ˆä½¿ç”¨ã€‚</p><h2 id="Arthas-Tunnel-amp-Web-Console"><a href="#Arthas-Tunnel-amp-Web-Console" class="headerlink" title="Arthas Tunnel &amp; Web Console"></a>Arthas Tunnel &amp; Web Console</h2><p>è¿™æ˜¯ä¸€ä¸ªæ–¹ä¾¿å¼€å‘è€…é€šè¿‡ç½‘é¡µå°±å¯ä»¥è¿æ¥åˆ° arthas çš„åŠŸèƒ½ï¼Œé¿å…ç›´æ¥ç™»å½•åˆ°æœåŠ¡å™¨è¿›è¡Œæ“ä½œã€‚<br><img src="https://s2.loli.net/2024/03/24/d38vNUbylAhSKxP.png"><br><img src="https://s2.loli.net/2024/03/24/w8RomB4UVOyErvf.png"></p><p>æˆ‘ä»¬åœ¨ç ”æ•ˆæ™®é€šä¹Ÿå†…ç½®äº†è¯¥åŠŸèƒ½ï¼Œè®©å¼€å‘æ’æŸ¥é—®é¢˜æ›´åŠ æ–¹ä¾¿ã€‚</p><h2 id="CPU-ä½¿ç”¨è¿‡å¤š"><a href="#CPU-ä½¿ç”¨è¿‡å¤š" class="headerlink" title="CPU ä½¿ç”¨è¿‡å¤š"></a>CPU ä½¿ç”¨è¿‡å¤š</h2><p>cpu å¼‚å¸¸ä½¿ç”¨æ’æŸ¥ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›‘æ§å¾—çŸ¥ JVM çš„ cpu ä½¿ç”¨æƒ…å†µï¼Œä½†æ˜¯æ²¡æ³•çŸ¥é“å…·ä½“æ˜¯å“ªä¸ªçº¿ç¨‹ä»¥åŠå“ªè¡Œä»£ç é€ æˆçš„ cpu è¿‡é«˜ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -n 3</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/03/24/SGTLjp8uBOHtJea.png"></p><p>ä½¿ç”¨ä»¥ä¸Šå‘½ä»¤å°±å¯ä»¥å°† cpu æ’åå‰ä¸‰çš„çº¿ç¨‹æ‰“å°å‡ºæ¥ï¼Œå¹¶ä¸”åˆ—å‡ºä»–çš„å †æ ˆæƒ…å†µï¼Œè¿™æ ·å¯ä»¥å¾ˆç›´è§‚çš„å¾—çŸ¥ cpu æ¶ˆè€—äº†åœ¨å“ªäº›åœ°æ–¹äº†ã€‚</p><p>å½“ç„¶è¿˜æœ‰ä¸€äº› trace æŸ¥è¯¢ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace demo.MathGame run &#x27;#cost &gt; 10&#x27;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™æ˜¯å°†è°ƒç”¨è¶…è¿‡ 10ms çš„å‡½æ•°æ‰“å°å‡ºæ¥ï¼Œä¸è¿‡å¦‚æœæˆ‘ä»¬æ¥å…¥äº†å¯è§‚æµ‹ç³»ç»Ÿï¼ˆOpenTelemetryã€skywalkingç­‰ï¼‰è¿™ä¸ªåŠŸèƒ½å°±ç”¨ä¸å¤ªä¸Šäº†ã€‚</p><hr><p> è¿˜å¯ä»¥åœ¨è¿è¡Œçš„æ—¶å€™ä¸åœæœºä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Œè¿™ç§åœ¨çº¿ä¸Šæ’æŸ¥ä¸€äº›ç–‘éš¾æ‚ç—‡çš„æ—¶å€™éå¸¸å¥½ç”¨ï¼ˆé€šå¸¸æƒ…å†µä¸‹ debug æ—¥å¿—æ˜¯ä¸æ‰“å°çš„ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ—¥å¿—çº§åˆ«è°ƒæ•´ä¸º debug æ‰“å°å‡ºæ›´åŠ è¯¦ç»†çš„ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[arthas@2062]$ </span><span class="language-bash">logger --name ROOT --level debug</span></span><br><span class="line">update logger level success.</span><br></pre></td></tr></table></figure><hr><p>å¦‚æœæ˜¯åœ¨ kubernetes ç¯å¢ƒä¸­æ‰§è¡Œä¹Ÿæœ‰å¯èƒ½ç¢°åˆ° Java è¿›ç¨‹å¯åŠ¨åæ²¡æœ‰åœ¨ç£ç›˜ä¸­å†™å…¥ PID çš„æƒ…å†µï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java -jar arthas-boot.jar</span>  </span><br><span class="line">[INFO] arthas-boot version: 3.6.7  </span><br><span class="line">[INFO] Can not find java process. Try to pass &lt;pid&gt; in command line.  </span><br><span class="line">Please select an available pid.</span><br></pre></td></tr></table></figure><p>å¯¼è‡´ç›´æ¥è¿è¡Œçš„æ—¶å€™æ— æ³•æ‰¾åˆ° Java è¿›ç¨‹ï¼›æ­¤æ—¶å°±éœ€è¦å…ˆ ps æ‹¿åˆ° PID ä¹‹åå†ä¼ å…¥ PID è¿å…¥ arthasï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java -jar arthas-boot.jar 1</span></span><br></pre></td></tr></table></figure><p>æ›´å¤šå…³äº arthas çš„ç”¨æ³•å¯ä»¥å‚è€ƒå®˜ç½‘ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://pulsar.apache.org/docs/3.2.x/admin-api-topics/#peek-messages">https://pulsar.apache.org/docs/3.2.x/admin-api-topics/#peek-messages</a></li><li><a href="https://crossoverjie.top/2023/12/11/ob/Pulsar-Broker-Interceptor/">https://crossoverjie.top/2023/12/11/ob/Pulsar-Broker-Interceptor/</a></li><li><a href="https://arthas.aliyun.com/">https://arthas.aliyun.com/</a></li><li><a href="https://crossoverjie.top/2024/01/09/ob/Pulsar-Delete-Topic/">https://crossoverjie.top/2024/01/09/ob/Pulsar-Delete-Topic/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;å‰ä¸¤å¤©æ”¶åˆ°ä¸šåŠ¡åé¦ˆæœ‰ä¸€ä¸ª topic çš„åˆ†åŒºæ¶ˆæ¯å †ç§¯äº†ï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/03/24/Ckb3MRswVAvjXfn.png&quot;&gt;&lt;br&gt;æ ¹æ®ä¹‹å‰çš„ç»éªŒæ¥çœ‹ï¼Œè¦ä¹ˆæ˜¯ä¸šåŠ¡æ¶ˆè´¹é€»è¾‘å‡ºç°é—®é¢˜å¯¼è‡´æ¶ˆè´¹è¿‡æ…¢ï¼Œå½“ç„¶ä¹Ÿæœ‰å°æ¦‚ç‡æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ Bugï¼ˆæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ pulsarï¼‰ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/tags/Pulsar/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨ kubernetes ç¯å¢ƒä¸‹å¦‚ä½•é‡‡é›†æ—¥å¿—</title>
    <link href="http://crossoverjie.top/2024/04/21/ob/k8s-log-collect/"/>
    <id>http://crossoverjie.top/2024/04/21/ob/k8s-log-collect/</id>
    <published>2024-04-21T05:07:07.000Z</published>
    <updated>2024-04-21T11:49:07.604Z</updated>
    
    <content type="html"><![CDATA[<p>å½“æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨äº‘åŸç”Ÿæ–¹æ¡ˆéƒ¨ç½²åº”ç”¨æ—¶é‡‡ç”¨çš„æ—¥å¿—æ–¹æ¡ˆå¾€å¾€æ˜¯ ELK æŠ€æœ¯æ ˆã€‚<br><img src="https://s2.loli.net/2024/03/16/5pNYcOuxgXzsG1F.png"></p><p>è¿™å¥—æŠ€æœ¯æ–¹æ¡ˆæ¯”è¾ƒæˆç†Ÿï¼Œç¨³å®šæ€§ä¹Ÿå¾ˆé«˜ï¼Œæ‰€ä»¥å‡ ä¹æˆä¸ºäº†å½“æ—¶çš„æ ‡é…ã€‚</p><p>å¯æ˜¯éšç€æˆ‘ä»¬ä½¿ç”¨ kubernetes æ­¥å…¥äº‘åŸç”Ÿçš„æ—¶ä»£åï¼Œ kubernetes æŠŠä»¥å¾€çš„æ“ä½œç³»ç»Ÿä¸Šçš„è®¸å¤šåº•å±‚éƒ½å±è”½ï¼Œå†ç”±ä»–æä¾›äº†ä¸€äº›æ ‡å‡†æ¥å£ã€‚</p><p>åŒæ—¶åœ¨ kubernetes ä¸­çš„æ—¥å¿—æ¥æºä¹Ÿæ¯”ä¼ ç»Ÿè™šæ‹Ÿæœºå¤šï¼Œæ¯”å¦‚å¯èƒ½æœ‰å®¹å™¨ã€kubernetes è‡ªèº«çš„äº‹ä»¶ã€æ—¥å¿—ç­‰ã€‚</p><span id="more"></span><p>æˆ‘ä»¬çš„æ—¥å¿—é‡‡é›†æ–¹æ¡ˆä¹Ÿå¾—ä¸æ—¶ä¿±è¿›ï¼Œkubernetes çš„å®˜æ–¹åšå®¢æœ‰ä»‹ç»æä¾›ä¸€ä¸‹å‡ ç§æ–¹æ¡ˆï¼š</p><h1 id="èŠ‚ç‚¹é‡‡é›†"><a href="#èŠ‚ç‚¹é‡‡é›†" class="headerlink" title="èŠ‚ç‚¹é‡‡é›†"></a>èŠ‚ç‚¹é‡‡é›†</h1><p><img src="https://s2.loli.net/2024/03/18/EWB1PFJku6x8On3.png"></p><p>ç¬¬ä¸€ç§æ–¹æ¡ˆæ˜¯åœ¨èŠ‚ç‚¹ä¸­é‡‡é›†æ—¥å¿—ï¼Œæˆ‘ä»¬çŸ¥é“ kubernetes æ˜¯åˆ†ä¸º master è°ƒåº¦èŠ‚ç‚¹ä»¥åŠ worker å·¥ä½œèŠ‚ç‚¹ï¼›æˆ‘ä»¬çš„åº”ç”¨éƒ½æ˜¯è¿è¡Œåœ¨ worker èŠ‚ç‚¹ä¸­çš„ã€‚</p><blockquote><p>åœ¨ kubernetes ç¯å¢ƒä¸­æ›´æ¨èä½¿ç”¨æ ‡å‡†çš„ stdout&#x2F;stderr ä½œä¸ºæ—¥å¿—è¾“å‡ºï¼Œè¿™æ · kubernetes æ›´æ–¹ä¾¿åšç»Ÿä¸€å¤„ç†ã€‚</p></blockquote><p><img src="https://s2.loli.net/2024/03/16/iUXB3YQdEAgJmpT.png"></p><p>ä»¥æˆ‘ä»¬çš„ docker è¿è¡Œæ—¶ä¸ºä¾‹ï¼Œé»˜è®¤æƒ…å†µä¸‹æˆ‘ä»¬çš„æ ‡å‡†è¾“å…¥æ–‡ä»¶ä¼šå†™å…¥åˆ° <code>/var/log</code> ç›®å½•ä¸­ã€‚</p><p><img src="https://s2.loli.net/2024/03/16/48NxKOuQmB5oer1.png"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼šæˆ‘ä»¬å¯ä»¥åœ¨ kubernetes çš„æ¯ä¸€ä¸ª worker èŠ‚ç‚¹ä¸­éƒ¨ç½²ä¸€ä¸ª <code>DaemonSet</code> ç±»å‹çš„é‡‡é›†å™¨ï¼ˆfilebeat ç­‰ï¼‰ï¼Œå†ç”±ä»–å»é‡‡é›†è¯¥èŠ‚ç‚¹ä¸‹ <code>/var/log</code> çš„æ—¥å¿—ï¼Œæœ€ç»ˆç”±ä»–å°†æ—¥å¿—é‡‡é›†åå‘å¾€æ—¥å¿—å¤„ç†çš„åç«¯ï¼Œæ¯”å¦‚ elasticsearch ç­‰ç»„ä»¶ä¸­ã€‚</p><p>è¿™ç§æ–¹æ¡ˆçš„å¥½å¤„æ˜¯èµ„æºå ç”¨è¾ƒä½ï¼Œå¾€å¾€æ˜¯æœ‰å¤šå°‘ä¸ª worker èŠ‚ç‚¹å°±å¯ä»¥éƒ¨ç½²å¤šå°‘ä¸ªé‡‡é›†å™¨ã€‚</p><p>è€Œä¸”å’Œä¸šåŠ¡çš„è€¦åˆåº¦ä½ï¼Œä¸šåŠ¡å’Œé‡‡é›†å™¨ä¸ç®¡è°è¿›è¡Œé‡å¯æˆ–å‡çº§äº’ç›¸éƒ½ä¸ä¼šäº§ç”Ÿå½±å“ã€‚</p><p>ä½†ç¼ºç‚¹ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼Œæ•´ä¸ªèŠ‚ç‚¹çš„æ—¥å¿—é‡‡é›†ç“¶é¢ˆéƒ½åœ¨è¿™ä¸ªé‡‡é›†å™¨è¿™é‡Œäº†ï¼Œå¦‚æœæŸäº› worker èŠ‚ç‚¹çš„ Pod æ•°é‡ä¸å‡è¡¡ï¼Œæˆ–è€…æ˜¯æœ¬èº«æ—¥å¿—äº§ç”Ÿä¹Ÿä¸å¹³å‡æ—¶å°±ä¼šå‡ºç°æ˜æ˜¾çš„è´Ÿå€ºä¸å¹³è¡¡ã€‚</p><p>è€Œä¸”ä¹Ÿæ— æ³•é’ˆå¯¹æŸäº›æ—¥å¿—é«˜å³°åœºæ™¯è¿›è¡Œè°ƒä¼˜ï¼ˆæ¯•ç«Ÿæ‰€æœ‰çš„ Pod éƒ½æ˜¯ä½¿ç”¨çš„ä¸€ä¸ªæ—¥å¿—é‡‡é›†å™¨ï¼‰ã€‚</p><p>æ‰€ä»¥èŠ‚ç‚¹çº§çš„æ—¥å¿—é‡‡é›†æ›´é€‚ç”¨ä¸è¯¥ worker èŠ‚ç‚¹è´Ÿå€ºè¾ƒä½çš„æ—¶å€™ä½¿ç”¨ï¼Œä¹Ÿæ›´å®¹æ˜“ç»´æŠ¤ã€‚</p><h1 id="Sidecar-ä»£ç†æ¨¡å¼"><a href="#Sidecar-ä»£ç†æ¨¡å¼" class="headerlink" title="Sidecar ä»£ç†æ¨¡å¼"></a>Sidecar ä»£ç†æ¨¡å¼</h1><p><img src="https://s2.loli.net/2024/03/16/Xo23G568BevhWKc.png"><br>ç¬¬äºŒç§ç›¸å¯¹äºç¬¬ä¸€ç§å¯ä»¥ç†è§£ä¸ºç”±é›†ä¸­å¼çš„æ—¥å¿—é‡‡é›†åˆ†æ•£åˆ°å„ä¸ªåº”ç”¨ Pod ä¸­è‡ªè¡Œé‡‡é›†ã€‚</p><p>éœ€è¦ä¸ºæ¯ä¸€ä¸ªä¸šåŠ¡ Pod æŒ‚è½½ä¸€ä¸ªè¾¹è½¦ï¼ˆsidecarï¼‰è¿›è¡Œæ—¥å¿—é‡‡é›†ï¼Œç”±äºè¾¹è½¦å’Œä¸šåŠ¡ Pod å…±äº«çš„æ˜¯ä¸€ä¸ªå­˜å‚¨ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆæ–¹ä¾¿çš„è¯»å–åˆ°æ—¥å¿—ã€‚</p><p>ç”±äºå®ƒæ˜¯å’Œåº”ç”¨æŒ‚è½½åœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥èµ„æºå ç”¨è‡ªç„¶ä¼šæ¯”èŠ‚ç‚¹é‡‡é›†æ›´å¤šï¼ŒåŒç†è€¦åˆåº¦ä¹Ÿå¢åŠ äº†ï¼Œé‡‡é›†ç»„ä»¶çš„å‡çº§å¯èƒ½è¿˜ä¼šå½±å“çš„ä¸šåŠ¡ Podã€‚</p><p>ä½†åŒæ ·çš„å¸¦æ¥å¥½å¤„å°±æ˜¯å¯ä»¥é’ˆå¯¹å•ä¸ª Pod æ›´ç²¾ç»†çš„æ§åˆ¶é‡‡é›†æ–¹æ¡ˆã€‚</p><p>æ¯”å¦‚å¯¹äºä¸€äº›æ—¥å¿—å†™å…¥é¢‘ç¹çš„åº”ç”¨ï¼Œå¯ä»¥å°† filebeat çš„é…ç½®æé«˜ï¼Œç”šè‡³è¿˜å¯ä»¥å°†è¿™ç§é«˜è´Ÿè½½çš„æ—¥å¿—å•ç‹¬å†™å…¥ä¸€ä¸ª elasticsearch ä¸­ï¼Œè¿™æ ·å¯ä»¥ä¸æ™®é€šè´Ÿè½½çš„æ—¥å¿—è¿›è¡Œèµ„æºéš”ç¦»ã€‚</p><p>è¿™ä¸ªæ–¹æ¡ˆæ›´é€‚ç”¨ä¸é›†ç¾¤è§„æ¨¡è¾ƒå¤§çš„åœºæ™¯ï¼Œéœ€è¦åšä¸€äº›ç²¾ç»†åŒ–é…ç½®ã€‚</p><hr><p>æˆ‘ä»¬å…¶å®ä¹Ÿæ˜¯é‡‡ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªæ–¹æ¡ˆï¼Œä¸è¿‡å…·ä½“ç»†èŠ‚ç¨æœ‰ä¸åŒã€‚</p><p>æˆ‘ä»¬æ²¡æœ‰ç›´æ¥ä½¿ç”¨æ ‡å‡†è¾“å…¥å’Œè¾“å‡ºï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><p>æ—¥å¿—æ ¼å¼æ²¡æ³•ç»Ÿä¸€ï¼Œå¯¼è‡´æœ€ç»ˆæŸ¥è¯¢çš„æ—¶å€™æ— æ³•åšä¸€äº›æ ‡å‡†åŒ–çš„é™åˆ¶ï¼ˆæ¯”å¦‚æˆ‘ä»¬è¦æ±‚æ¯ä¸ªæ—¥å¿—éƒ½éœ€è¦å¸¦ä¸šåŠ¡ idã€traceId ç­‰ï¼ŒæŸ¥è¯¢æ—¶å€™æœ‰è¿™äº›ä¸šåŠ¡æŒ‡æ ‡å°±å¾ˆå®¹æ˜“æ²‰æ·€ä¸€äº›æ ‡å‡†çš„æŸ¥è¯¢è¯­å¥ã€‚ï¼‰</p><p>æœ€ç»ˆæˆ‘ä»¬è¿˜æ˜¯é‡‡ç”¨äº† Java çš„è€æœ‹å‹ï¼Œlogback é…ç½®äº†è‡ªå·±çš„æ—¥å¿—æ ¼å¼ï¼Œæ‰€æœ‰çš„åº”ç”¨éƒ½ä¼šæ ¹æ®è¿™ä¸ªæ¨¡ç‰ˆè¿›è¡Œæ—¥å¿—è¾“å‡ºã€‚</p><p>åŒæ—¶åˆ©ç”¨æ—¥å¿—æ¡†æ¶çš„æ‰¹é‡å†™å…¥ã€ç¼“å†²ç­‰ç‰¹æ€§è¿˜æ›´å®¹æ˜“è¿›è¡Œæ—¥å¿—çš„æ€§èƒ½è°ƒä¼˜ã€‚ï¼ˆåªä½¿ç”¨æ ‡å‡†è¾“å‡ºæ—¶å¯¹åº”ç”¨æ¥è¯´æ˜¯é»‘ç›’ã€‚ï¼‰</p><p>æœ€ç»ˆæˆ‘ä»¬çš„æŠ€æœ¯æ–¹æ¡ˆæ˜¯ï¼š<br><img src="https://s2.loli.net/2024/03/16/V1mf7MBpodq5eRU.png"></p><h1 id="ç›´æ¥å†™å…¥"><a href="#ç›´æ¥å†™å…¥" class="headerlink" title="ç›´æ¥å†™å…¥"></a>ç›´æ¥å†™å…¥</h1><p>è¿˜æœ‰ä¸€ç§æ–¹æ¡ˆæ˜¯ç›´æ¥å†™å…¥ï¼Œè¿™ä¸ªå…¶å®å’Œ kubernetes æœ¬èº«å°±æ²¡æœ‰å¤ªå¤šå…³ç³»äº†ã€‚</p><p>ç”±ä¸šåŠ¡è‡ªå·±è°ƒç”¨ elasticsearch æˆ–è€…å…¶ä»–çš„å­˜å‚¨ç»„ä»¶çš„ API è¿›è¡Œå†™å…¥ï¼Œè¿™ç§é€šå¸¸é€‚ç”¨äºå¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œç•¥è¿‡äº†ä¸­é—´çš„é‡‡é›†æ­¥éª¤ï¼Œç›´æ¥å†™å…¥å­˜å‚¨ç«¯ã€‚</p><p>è¿™ä¸ªæˆ‘åœ¨ <a href="https://crossoverjie.top/2023/08/23/ob/VictoriaLogs-Intro/">VictoriaLogsï¼šä¸€æ¬¾è¶…ä½å ç”¨çš„ ElasticSearch æ›¿ä»£æ–¹æ¡ˆ</a>ä¸­ä»‹ç»è¿‡ï¼Œæˆ‘éœ€è¦åœ¨ broker çš„æ‹¦æˆªå™¨ä¸­åŸ‹ç‚¹æ¶ˆæ¯ä¿¡æ¯ï¼Œä»è€Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªæ¶ˆæ¯ğŸ†”çš„é“¾è·¯ä¿¡æ¯ã€‚</p><p><img src="https://s2.loli.net/2023/08/02/H7pjinzQ5EWR2tF.png"></p><p>å› ä¸ºéœ€è¦æ‹¦æˆªæ¶ˆæ¯çš„å‘é€ã€æ¶ˆè´¹çš„å„ä¸ªé˜¶æ®µï¼ŒåŠ ä¸Šå¹¶å‘å‹åŠ›è¾ƒé«˜ï¼Œæ‰€ä»¥å¯¹æ—¥å¿—çš„å†™å…¥æ€§èƒ½è¦æ±‚è¿˜æ˜¯è›®é«˜çš„ã€‚</p><p>å› æ­¤å°±éœ€è¦åœ¨æ‹¦æˆªå™¨ä¸­ç›´æ¥å¯¹å†™å…¥åˆ°æ—¥å¿—å­˜å‚¨ã€‚</p><blockquote><p>è¿™é‡Œè€ƒè™‘åˆ°æˆ‘è¿™é‡Œçš„ä½†ä¸€åœºæ™¯ï¼Œä»¥åŠå¯¹èµ„æºçš„æ¶ˆè€—ï¼Œæœ€ç»ˆé€‰å–äº† <code>victoriaLog</code> è¿™ä¸ªæ—¥å¿—å­˜å‚¨ã€‚</p></blockquote><p>è€Œåœ¨å‘é€æ—¥å¿—çš„æ—¶å€™ä¹Ÿå¾—ç”¨äº†é«˜æ€§èƒ½çš„æ—¥å¿—å‘ç”Ÿæ¡†æ¶ï¼Œè¿™é‡Œé€‰å–äº†<a href="https://github.com/aliyun/aliyun-log-java-producer">aliyun-log-java-producer</a>ç„¶ååšäº†ä¸€äº›å®šåˆ¶ã€‚</p><p>è¿™ä¸ªåº“æ”¯æŒä»¥ä¸‹ä¸€äº›åŠŸèƒ½ï¼š</p><ul><li>é«˜æ€§èƒ½ï¼šæ‰¹é‡å‘é€ã€å¤šçº¿ç¨‹ç­‰</li><li>è‡ªåŠ¨é‡è¯•</li><li>å¼‚æ­¥éé˜»å¡</li><li>èµ„æºæ§åˆ¶ï¼ˆå¯ä»¥å¯¹å†…å­˜ã€æ•°é‡è¿›è¡Œæ§åˆ¶ï¼‰</li></ul><p>å› ä¸ºè¿™æ˜¯ä¸ºé˜¿é‡Œäº‘æ—¥å¿—æœåŠ¡çš„ä¸€ä¸ªç»„ä»¶ï¼Œä»£ç é‡Œç¡¬ç¼–ç äº†åªèƒ½å†™å…¥é˜¿é‡Œçš„æ—¥å¿—æœåŠ¡ã€‚</p><p>æ‰€ä»¥æ‹¿æ¥ç¨åŠ æ”¹é€ åï¼Œç°åœ¨å¯ä»¥æ”¯æŒè‡ªå®šä¹‰å‘é€åˆ°ä»»æ„åç«¯ï¼Œåªéœ€è¦åœ¨åˆå§‹åŒ–æ—¶è‡ªå®šä¹‰å®ç°å‘é€å›è°ƒæ¥å£å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProducerConfig</span> <span class="variable">producerConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProducerConfig</span>();</span><br><span class="line">producerConfig.setSenderArgs(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;vlogUrl, client&#125;);</span><br><span class="line">producerConfig.setSender((batch, args) -&gt; &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">body</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">for</span> (String s : batch.getLogItemsString()) &#123;</span><br><span class="line">        body.append(<span class="string">&quot;&#123;\&quot;create\&quot;:&#123;&#125;&#125;&quot;</span>);</span><br><span class="line">        body.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        body.append(s);</span><br><span class="line">        body.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">RequestBody</span> <span class="variable">requestBody</span> <span class="operator">=</span></span><br><span class="line">            RequestBody.create(MediaType.parse(<span class="string">&quot;application/json&quot;</span>), body.toString());</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                    .url(String.format(<span class="string">&quot;%s/insert/elasticsearch/_bulk&quot;</span>, args[<span class="number">0</span>]))</span><br><span class="line">                    .post(requestBody)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> (OkHttpClient) args[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> okHttpClient.newCall(request).execute()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (response.isSuccessful()) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Request failed with error code: &quot;</span> + response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;Send vlogs failed&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">logProducer = <span class="keyword">new</span> <span class="title class_">LogProducer</span>(producerConfig);</span><br></pre></td></tr></table></figure><blockquote><p>è€ƒè™‘åˆ°è¿™ä¸ªåº“åªæ˜¯å¯¹é˜¿é‡Œäº‘æ—¥å¿—æœåŠ¡çš„ä¸€ä¸ªç»„ä»¶ï¼ŒåŠ ä¸Šä»£ç å·²ç»å¾ˆä¹…æ²¡ç»´æŠ¤äº†ï¼Œæ‰€ä»¥å°±æ²¡æœ‰å°†è¿™éƒ¨åˆ†ä»£ç æäº¤åˆ°ç¤¾åŒºï¼Œæ„Ÿå…´è¶£çš„è¯„è®ºåŒºç•™è¨€ã€‚</p></blockquote><h1 id="æ—¥å¿—å®‰å…¨"><a href="#æ—¥å¿—å®‰å…¨" class="headerlink" title="æ—¥å¿—å®‰å…¨"></a>æ—¥å¿—å®‰å…¨</h1><p>æ—¥å¿—æ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€ä½†åˆå¾ˆæ•æ„Ÿçš„åŠŸèƒ½ï¼Œé¦–å…ˆæ˜¯ç¼–ç è§„èŒƒä¸Šè¦é¿å…æ‰“å°ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼›æ¯”å¦‚èº«ä»½è¯ã€å¯†ç ç­‰ï¼›åŒæ—¶å¯¹æ—¥å¿—çš„è®¿é—®ä¹Ÿè¦æœ€å¥½æƒé™æ§åˆ¶ã€‚</p><p>åœ¨æˆ‘ä»¬å†…éƒ¨çš„ç ”æ•ˆå¹³å°ä¸­ï¼Œå¯¹äºæ—¥å¿—ã€ç›‘æ§ç­‰åŠŸèƒ½éƒ½æ˜¯å’Œåº”ç”¨æƒé™æŒ‚é’©çš„ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯å…³é—­äº†ç»Ÿä¸€æŸ¥è¯¢ ES çš„å…¥å£ï¼Œåªåœ¨åº”ç”¨å±‚çº§æä¾›æŸ¥è¯¢ï¼Œç±»ä¼¼äºï¼š</p><p><img src="https://s2.loli.net/2024/03/18/ogBTPu47CifOrnp.png"></p><blockquote><p>å›¾æ¥è‡ªäº orbit äº§å“ã€‚</p></blockquote><h1 id="OpenTelemetry"><a href="#OpenTelemetry" class="headerlink" title="OpenTelemetry"></a>OpenTelemetry</h1><p>å½“ç„¶è®²åˆ°æ—¥å¿—ç›®å‰è‡ªç„¶ä¹Ÿé€ƒä¸è¿‡ OpenTelemetryï¼Œä½œä¸ºå½“å‰äº‘åŸç”Ÿå¯è§‚æµ‹æ€§çš„æ ‡å‡†ä¹Ÿæä¾›äº†å¯¹åº”çš„æ—¥å¿—ç»„ä»¶ã€‚</p><p><img src="https://s2.loli.net/2024/03/18/VdvhIbzRWxlc79Q.png"><br>OpenTelemetry ä¹Ÿå®šä¹‰äº†ç»“æ„åŒ–çš„æ—¥å¿—æ ¼å¼ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;resourceLogs&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;resource-attr&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;stringValue&quot;</span><span class="punctuation">:</span><span class="string">&quot;resource-attr-val-1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;scopeLogs&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;scope&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;logRecords&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;timeUnixNano&quot;</span><span class="punctuation">:</span><span class="string">&quot;1581452773000000789&quot;</span><span class="punctuation">,</span><span class="attr">&quot;severityNumber&quot;</span><span class="punctuation">:</span><span class="number">9</span><span class="punctuation">,</span><span class="attr">&quot;severityText&quot;</span><span class="punctuation">:</span><span class="string">&quot;Info&quot;</span><span class="attr">&quot;body&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;stringValue&quot;</span><span class="punctuation">:</span><span class="string">&quot;This is a log message&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;app&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;stringValue&quot;</span><span class="punctuation">:</span><span class="string">&quot;server&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;instance_num&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;intValue&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;droppedAttributesCount&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;traceId&quot;</span><span class="punctuation">:</span><span class="string">&quot;08040201000000000000000000000000&quot;</span><span class="punctuation">,</span><span class="attr">&quot;spanId&quot;</span><span class="punctuation">:</span><span class="string">&quot;0102040800000000&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;timeUnixNano&quot;</span><span class="punctuation">:</span><span class="string">&quot;1581452773000000789&quot;</span><span class="punctuation">,</span><span class="attr">&quot;severityNumber&quot;</span><span class="punctuation">:</span><span class="number">9</span><span class="punctuation">,</span><span class="attr">&quot;severityText&quot;</span><span class="punctuation">:</span><span class="string">&quot;Info&quot;</span><span class="punctuation">,</span><span class="attr">&quot;body&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;stringValue&quot;</span><span class="punctuation">:</span><span class="string">&quot;something happened&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;customer&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;stringValue&quot;</span><span class="punctuation">:</span><span class="string">&quot;acme&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;env&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;stringValue&quot;</span><span class="punctuation">:</span><span class="string">&quot;dev&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;droppedAttributesCount&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;traceId&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span><span class="attr">&quot;spanId&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é…ç½® <code>otel.logs.exporter=otlp (default)</code> å¯ä»¥å°†æ—¥å¿—è¾“å‡ºåˆ° <code>oetl-collector</code> ä¸­ï¼Œå†ç”±ä»–è¾“å‡ºåˆ°åç«¯å­˜å‚¨ä¸­ã€‚</p><p>è™½ç„¶è¿™æ · <code>otel-collectoer</code> å°±æˆä¸ºç“¶é¢ˆäº†ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥éƒ¨ç½²å¤šä¸ªå‰¯æœ¬æ¥é™ä½å‹åŠ›ã€‚</p><p>åŒæ—¶ä¹Ÿå¯ä»¥åœ¨åº”ç”¨ä¸­æŒ‡å®šä¸åŒçš„ <code>endpoint(otel.exporter.otlp.endpoint=http://127.0.0.1:4317)</code> æ¥åŒºåˆ†æ—¥å¿—çš„ collectorï¼Œä¸å…¶ä»–ç±»å‹çš„ collector åšåˆ°èµ„æºéš”ç¦»ã€‚</p><p>ä¸è¿‡ç›®å‰ç¤¾åŒºå…³äºæ—¥å¿—çš„å®è·µè¿˜æ¯”è¾ƒå°‘ï¼Œè€Œä¸”ç”±äºç‰ˆæœ¬ 1.0 ç‰ˆæœ¬ release çš„æ—¶é—´ä¹Ÿä¸ç®—é•¿ï¼Œç¨³å®šæ€§å’Œä¹‹å‰çš„ filebeat ç›¸æ¯”è¿˜å¾—éœ€è¦æ—¶é—´æ£€éªŒã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å°†å¯è§‚æµ‹æ€§çš„ä¸‰ä¸ªé‡è¦ç»„ä»¶éƒ½å…³è”èµ·æ¥æ‰èƒ½æ›´å¥½çš„æ’æŸ¥å®šä½é—®é¢˜ã€‚</p><p>æ¯”å¦‚å½“æ”¶åˆ°ç›‘æ§ç³»ç»Ÿé€šè¿‡æŒ‡æ ‡å˜åŒ–å‘å‡ºçš„æŠ¥è­¦æ—¶ï¼Œå¯ä»¥é€šè¿‡é“¾è·¯è¿½è¸ªå®šä½å…·ä½“æ˜¯å“ªä¸ªç³»ç»Ÿè§¦å‘çš„é—®é¢˜ã€‚</p><p>ä¹‹åé€šè¿‡ traceID å®šä½åˆ°å…·ä½“çš„æ—¥å¿—ï¼Œå†é€šè¿‡æ—¥å¿—çš„ä¸Šä¸‹æ–‡åˆ—å‡ºæ›´å¤šæ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ ·æ•´ä¸ªé“¾æ¡å°±å¯ä»¥ä¸²è”èµ·æ¥ï¼Œå¯ä»¥æå¤§çš„æé«˜æ•ˆç‡ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/aliyun/aliyun-log-java-producer">https://github.com/aliyun/aliyun-log-java-producer</a></li><li><a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/">https://kubernetes.io/docs/concepts/cluster-administration/logging/</a></li><li><a href="https://coding.net/help/docs/orbit/env/logs-event/intro.html">https://coding.net/help/docs/orbit/env/logs-event/intro.html</a></li><li><a href="https://opentelemetry.io/docs/concepts/signals/logs/">https://opentelemetry.io/docs/concepts/signals/logs/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å½“æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨äº‘åŸç”Ÿæ–¹æ¡ˆéƒ¨ç½²åº”ç”¨æ—¶é‡‡ç”¨çš„æ—¥å¿—æ–¹æ¡ˆå¾€å¾€æ˜¯ ELK æŠ€æœ¯æ ˆã€‚&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/03/16/5pNYcOuxgXzsG1F.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™å¥—æŠ€æœ¯æ–¹æ¡ˆæ¯”è¾ƒæˆç†Ÿï¼Œç¨³å®šæ€§ä¹Ÿå¾ˆé«˜ï¼Œæ‰€ä»¥å‡ ä¹æˆä¸ºäº†å½“æ—¶çš„æ ‡é…ã€‚&lt;/p&gt;
&lt;p&gt;å¯æ˜¯éšç€æˆ‘ä»¬ä½¿ç”¨ kubernetes æ­¥å…¥äº‘åŸç”Ÿçš„æ—¶ä»£åï¼Œ kubernetes æŠŠä»¥å¾€çš„æ“ä½œç³»ç»Ÿä¸Šçš„è®¸å¤šåº•å±‚éƒ½å±è”½ï¼Œå†ç”±ä»–æä¾›äº†ä¸€äº›æ ‡å‡†æ¥å£ã€‚&lt;/p&gt;
&lt;p&gt;åŒæ—¶åœ¨ kubernetes ä¸­çš„æ—¥å¿—æ¥æºä¹Ÿæ¯”ä¼ ç»Ÿè™šæ‹Ÿæœºå¤šï¼Œæ¯”å¦‚å¯èƒ½æœ‰å®¹å™¨ã€kubernetes è‡ªèº«çš„äº‹ä»¶ã€æ—¥å¿—ç­‰ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="æ—¥å¿—" scheme="http://crossoverjie.top/tags/%E6%97%A5%E5%BF%97/"/>
    
    <category term="kubernetes" scheme="http://crossoverjie.top/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>å®æˆ˜ï¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª OpenTelemetry Extensions</title>
    <link href="http://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/"/>
    <id>http://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/</id>
    <published>2024-04-15T06:14:54.000Z</published>
    <updated>2024-04-15T13:27:35.103Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰æ®µæ—¶é—´æˆ‘ä»¬ä» <code>SkyWalking</code> åˆ‡æ¢åˆ°äº† <code>OpenTelemetry</code> ï¼Œä¸æ­¤åŒæ—¶ä¹‹å‰ä½¿ç”¨ SkyWalking ç¼–å†™çš„æ’ä»¶ä¹Ÿå¾—è½¬ç§»åˆ° OpenTelemetry ä½“ç³»ä¸‹ã€‚</p><p>æˆ‘ä¹Ÿå†™äº†ç›¸å…³ä»‹ç»æ–‡ç« ï¼š<br>å®æˆ˜ï¼š<a href="https://juejin.cn/post/7341669201010262053">å¦‚ä½•ä¼˜é›…çš„ä» SkyWalking åˆ‡æ¢åˆ° OpenTelemetry</a></p><p>å¥½åœ¨ OpenTelemetry ç¤¾åŒºä¹Ÿæä¾›äº† Extensions çš„æ‰©å±•å¼€å‘ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨å»ä¿®æ”¹ç¤¾åŒºå‘è¡Œç‰ˆï¼š<code>opentelemetry-javaagent.jar</code> çš„æºç ä¹Ÿå¯ä»¥æ‰©å±•å…¶ä¸­çš„èƒ½åŠ›ã€‚</p><p>æ¯”å¦‚å¯ä»¥ï¼š</p><ul><li>ä¿®æ”¹ä¸€äº› traceï¼ŒæŸäº› span ä¸æƒ³è®°å½•ç­‰ã€‚</li><li>æ–°å¢ metrics</li></ul><span id="more"></span><p>è¿™æ¬¡æˆ‘å‡†å¤‡ç¼–å†™çš„æ’ä»¶ä¹Ÿæ˜¯å’Œ metrics æœ‰å…³çš„ï¼Œå› ä¸º pulsar çš„ Java sdk ä¸­å¹¶æ²¡æœ‰æš´éœ²å®¢æˆ·ç«¯çš„ä¸€äº›ç›‘æ§æŒ‡æ ‡ï¼Œæ‰€ä»¥æˆ‘éœ€è¦åœ¨æ’ä»¶ä¸­æ‹¦æˆªåˆ°ä¸€äº›å…³é”®å‡½æ•°ï¼Œç„¶åæ‰§è¡Œæš´éœ²å‡ºæŒ‡æ ‡ã€‚</p><p>æˆªæ­¢åˆ°æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ï¼Œ Pulsar ç¤¾åŒºä¹Ÿå·²ç»å°† <code>Java-client</code> <a href="https://github.com/apache/pulsar/pull/22178">é›†æˆ</a>äº† OpenTelemetryï¼Œåç»­æ­£å¼å‘ç‰ˆåæˆ‘è¿™ä¸ªæ’ä»¶ä¹Ÿå¯ä»¥å…‰è£é€€ä¼‘äº†ã€‚</p><hr><p>ç”±äº OpenTelemetry ç¤¾åŒºè¿˜å¤„äºé«˜é€Ÿå‘å±•é˜¶æ®µï¼Œæˆ‘åœ¨ä¸­æ–‡ç¤¾åŒºæ²¡æœ‰æ‰¾åˆ°ç±»ä¼¼çš„å‚è€ƒæ–‡ç« ï¼ˆç”šè‡³è‹±æ–‡ç¤¾åŒºä¹Ÿæ²¡æœ‰ï¼Œåªæœ‰ä¸€äº› example ä»£ç ï¼Œæˆ–è€…æ˜¯åªæœ‰å»ç¤¾åŒºæˆç†Ÿæ’ä»¶é‡Œå»å‚è€ƒä»£ç ï¼‰</p><p>å…¶ä¸­ä¹Ÿè¸©äº†ä¸å°‘å‘ï¼Œæ‰€ä»¥è§‰å¾—éå¸¸æœ‰å¿…è¦åˆ†äº«å‡ºæ¥å¸®åŠ©å¤§å®¶å‡å°‘é‡åˆ°åŒç±»é—®é¢˜çš„æœºä¼šã€‚</p><h1 id="å¼€å‘æµç¨‹"><a href="#å¼€å‘æµç¨‹" class="headerlink" title="å¼€å‘æµç¨‹"></a>å¼€å‘æµç¨‹</h1><p>OpenTelemetry extension çš„å†™æ³•å…¶å®å’Œ <code>skywalking</code> ç›¸ä¼¼ï¼Œéƒ½æ˜¯ç”¨çš„ <a href="https://bytebuddy.net/#/">bytebuddy</a>è¿™ä¸ªå­—èŠ‚ç å¢å¼ºåº“ï¼Œåªæ˜¯åœ¨ä¸€äº› API ä¸Šæœ‰ä¸€äº›åŒºåˆ«ã€‚</p><h2 id="åˆ›å»ºé¡¹ç›®"><a href="#åˆ›å»ºé¡¹ç›®" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h2><p>é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ª Java é¡¹ç›®ï¼Œè¿™é‡Œæˆ‘ç›´æ¥å‚è€ƒäº†å®˜æ–¹çš„ç¤ºä¾‹ï¼Œä½¿ç”¨äº† gradle è¿›è¡Œç®¡ç†ï¼ˆç†è®ºä¸Š maven ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œåªæ˜¯è¦æ‰¾åˆ°åœ¨ gradle ä½¿ç”¨çš„ maven æ’ä»¶ï¼‰ã€‚</p><p>è¿™é‡Œè´´ä¸€ä¸‹ç®€åŒ–ç‰ˆçš„ <code>build.gradle</code> æ–‡ä»¶ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">    id <span class="string">&quot;com.github.johnrengelman.shadow&quot;</span> version <span class="string">&quot;8.1.1&quot;</span></span><br><span class="line">    id <span class="string">&quot;com.diffplug.spotless&quot;</span> version <span class="string">&quot;6.24.0&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">group</span> = <span class="string">&#x27;com.xx.otel.extensions&#x27;</span></span><br><span class="line">version = <span class="string">&#x27;1.0.0&#x27;</span></span><br><span class="line"></span><br><span class="line">ext &#123;</span><br><span class="line">    versions = [</span><br><span class="line">            <span class="comment">// this line is managed by .github/scripts/update-sdk-version.sh</span></span><br><span class="line">            opentelemetrySdk           : <span class="string">&quot;1.34.1&quot;</span>,</span><br><span class="line"></span><br><span class="line">            <span class="comment">// these lines are managed by .github/scripts/update-version.sh</span></span><br><span class="line">            opentelemetryJavaagent     : <span class="string">&quot;2.1.0-SNAPSHOT&quot;</span>,</span><br><span class="line">            opentelemetryJavaagentAlpha: <span class="string">&quot;2.1.0-alpha-SNAPSHOT&quot;</span>,</span><br><span class="line"></span><br><span class="line">            junit                      : <span class="string">&quot;5.10.1&quot;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    deps = [</span><br><span class="line">    <span class="comment">// è‡ªåŠ¨ç”ŸæˆæœåŠ¡å‘ç° service æ–‡ä»¶</span></span><br><span class="line">            autoservice: <span class="keyword">dependencies</span>.create(<span class="keyword">group</span>: <span class="string">&#x27;com.google.auto.service&#x27;</span>, name: <span class="string">&#x27;auto-service&#x27;</span>, version: <span class="string">&#x27;1.1.1&#x27;</span>)</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">repositories</span> &#123;</span><br><span class="line">    mavenLocal()</span><br><span class="line">    maven &#123; url <span class="string">&quot;https://maven.aliyun.com/repository/public&quot;</span> &#125;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">configurations</span> &#123;</span><br><span class="line">    otel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line"></span><br><span class="line">    implementation(platform(<span class="string">&quot;io.opentelemetry:opentelemetry-bom:$&#123;versions.opentelemetrySdk&#125;&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Interfaces and SPIs that we implement. We use `compileOnly` dependency because during</span></span><br><span class="line"><span class="comment">    runtime all necessary classes are provided by javaagent itself.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    compileOnly <span class="string">&#x27;io.opentelemetry:opentelemetry-sdk-extension-autoconfigure-spi:1.34.1&#x27;</span></span><br><span class="line">    compileOnly <span class="string">&#x27;io.opentelemetry.instrumentation:opentelemetry-instrumentation-api:1.32.0&#x27;</span></span><br><span class="line">    compileOnly <span class="string">&#x27;io.opentelemetry.javaagent:opentelemetry-javaagent-extension-api:1.32.0-alpha&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Provides @AutoService annotation that makes registration of our SPI implementations much easier</span></span><br><span class="line">    compileOnly deps.autoservice</span><br><span class="line">    annotationProcessor deps.autoservice</span><br><span class="line"></span><br><span class="line">    <span class="comment">// https://mvnrepository.com/artifact/org.apache.pulsar/pulsar-client</span></span><br><span class="line">    compileOnly <span class="string">&#x27;org.apache.pulsar:pulsar-client:2.8.0&#x27;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">    useJUnitPlatform()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä¾¿æ˜¯è¦åˆ›å»º  javaagent çš„ä¸€ä¸ªæ ¸å¿ƒç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoService(InstrumentationModule.class)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PulsarInstrumentationModule</span> <span class="keyword">extends</span> <span class="title class_">InstrumentationModule</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PulsarInstrumentationModule</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="string">&quot;pulsar-client-metrics&quot;</span>, <span class="string">&quot;pulsar-client-metrics-2.8.0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç±»ä¸­å®šä¹‰æˆ‘ä»¬æ’ä»¶çš„åç§°ï¼ŒåŒæ—¶ä½¿ç”¨ <code>@AutoService</code> æ³¨è§£å¯ä»¥åœ¨æ‰“åŒ…çš„æ—¶å€™å¸®æˆ‘ä»¬åœ¨ <code>META-INF/services/</code>ç›®å½•ä¸‹ç”Ÿæˆ SPI æœåŠ¡å‘ç°çš„æ–‡ä»¶ï¼š<br><img src="https://s2.loli.net/2024/03/10/krqEn7lsIQbKJh6.png"></p><blockquote><p>è¿™æ˜¯ä¸€ä¸ª Google çš„æ’ä»¶ï¼Œæœ¬è´¨æ˜¯æ’ä»¶æ˜¯ä½¿ç”¨ SPI çš„æ–¹å¼è¿›è¡Œå¼€å‘çš„ã€‚</p></blockquote><p>å…³äº SPI ä»¥å‰ä¹Ÿå†™è¿‡ä¸€ç¯‡æ–‡ç« ï¼Œä¸ç†Ÿçš„æœ‹å‹å¯ä»¥ç”¨ä½œå‚è€ƒï¼š</p><ul><li><a href="https://crossoverjie.top/2020/02/24/wheel/cicada8-spi/">Java SPI çš„åŸç†ä¸åº”ç”¨</a></li></ul><h2 id="åˆ›å»º-Instrumentation"><a href="#åˆ›å»º-Instrumentation" class="headerlink" title="åˆ›å»º Instrumentation"></a>åˆ›å»º Instrumentation</h2><p>ä¹‹åå°±éœ€è¦åˆ›å»ºè‡ªå·±çš„ Instrumentationï¼Œè¿™é‡Œå¯ä»¥æŠŠå®ƒç†è§£ä¸ºè‡ªå·±çš„æ‹¦æˆªå™¨ï¼Œéœ€è¦é…ç½®å¯¹å“ªä¸ªç±»çš„å“ªä¸ªå‡½æ•°è¿›è¡Œæ‹¦æˆªï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerCreateImplInstrumentation</span> <span class="keyword">implements</span> <span class="title class_">TypeInstrumentation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ElementMatcher&lt;TypeDescription&gt; <span class="title function_">typeMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> named(<span class="string">&quot;org.apache.pulsar.client.impl.ProducerBuilderImpl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(TypeTransformer transformer)</span> &#123;</span><br><span class="line">        transformer.applyAdviceToMethod(</span><br><span class="line">                isMethod()</span><br><span class="line">                        .and(named(<span class="string">&quot;createAsync&quot;</span>)),</span><br><span class="line">                ProducerCreateImplInstrumentation.class.getName() + <span class="string">&quot;$ProducerCreateImplConstructorAdvice&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™å°±æ˜¯å¯¹ <code>ProducerBuilderImpl</code> ç±»çš„ createAsync åˆ›å»ºå‡½æ•°è¿›è¡Œæ‹¦æˆªï¼Œæ‹¦æˆªä¹‹åçš„é€»è¾‘å†™åœ¨äº† <code>ProducerCreateImplConstructorAdvice</code> ç±»ä¸­ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯å¯¹ä¸€äº›ç»§æ‰¿å’Œå®ç°ç±»çš„æ‹¦æˆªæ–¹å¼æ˜¯ä¸ç›¸åŒçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> ElementMatcher&lt;TypeDescription&gt; <span class="title function_">typeMatcher</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> extendsClass(named(ENHANCE_CLASS));  </span><br><span class="line">    <span class="comment">// return implementsInterface(named(ENHANCE_CLASS));</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸¤ä¸ªå‡½æ•°åç§°å°±èƒ½çœ‹å‡ºï¼Œåˆ†åˆ«æ˜¯é’ˆå¯¹ç»§æ‰¿å’Œå®ç°ç±»è¿›è¡Œæ‹¦æˆªçš„ã€‚</p><blockquote><p>è¿™é‡Œçš„ API æ¯” SkyWalking çš„æ›´æ˜“è¯»ä¸€äº›ã€‚</p></blockquote><p>ä¹‹åéœ€è¦æŠŠæˆ‘ä»¬è‡ªå®šä¹‰çš„ Instrumentation æ³¨å†Œåˆ°åˆšæ‰çš„ PulsarInstrumentationModule ç±»ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;TypeInstrumentation&gt; <span class="title function_">typeInstrumentations</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ProducerCreateImplInstrumentation</span>(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ProducerCloseImplInstrumentation</span>(),</span><br><span class="line">            );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœ‰å¤šä¸ªçš„è¯ä¹Ÿéƒ½å¾—è¿›è¡Œæ³¨å†Œã€‚</p><h2 id="ç¼–å†™åˆ‡é¢ä»£ç "><a href="#ç¼–å†™åˆ‡é¢ä»£ç " class="headerlink" title="ç¼–å†™åˆ‡é¢ä»£ç "></a>ç¼–å†™åˆ‡é¢ä»£ç </h2><p>ä¹‹åä¾¿æ˜¯ç¼–å†™æˆ‘ä»¬è‡ªå®šä¹‰çš„åˆ‡é¢é€»è¾‘äº†ï¼Œä¹Ÿå°±æ˜¯åˆšæ‰è‡ªå®šä¹‰çš„ <code>ProducerCreateImplConstructorAdvice</code> ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ProducerCreateImplConstructorAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Advice</span>.OnMethodEnter(suppress = Throwable.class)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">onEnter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// inert your code</span></span><br><span class="line">        MetricsRegistration.registerProducer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Advice</span>.OnMethodExit(suppress = Throwable.class)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@Advice</span>.Return CompletableFuture&lt;Producer&gt; completableFuture)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Producer</span> <span class="variable">producer</span> <span class="operator">=</span> completableFuture.get();</span><br><span class="line">            CollectionHelper.PRODUCER_COLLECTION.addObject(producer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            System.err.println(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å¾—å‡ºæ¥å…¶å®å°±æ˜¯ä¸¤ä¸ªæ ¸å¿ƒçš„æ³¨è§£ï¼š</p><ul><li><code>@Advice.OnMethodEnter</code> åˆ‡é¢å‡½æ•°è°ƒç”¨ä¹‹å‰</li><li><code>@Advice.OnMethodExit</code> åˆ‡é¢å‡½æ•°è°ƒç”¨ä¹‹å</li></ul><p>è¿˜å¯ä»¥åœ¨ <code>@Advice.OnMethodExit</code>çš„å‡½æ•°ä¸­ä½¿ç”¨ <code>@Advice.Return</code>è·å¾—å‡½æ•°è°ƒç”¨çš„è¿”å›å€¼ã€‚</p><p>å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>@Advice.This</code> æ¥è·å–åˆ‡é¢çš„è°ƒç”¨å¯¹è±¡ã€‚</p><h2 id="ç¼–å†™è‡ªå®šä¹‰-metrics"><a href="#ç¼–å†™è‡ªå®šä¹‰-metrics" class="headerlink" title="ç¼–å†™è‡ªå®šä¹‰ metrics"></a>ç¼–å†™è‡ªå®šä¹‰ metrics</h2><p>å› ä¸ºæˆ‘è¿™ä¸ªæ’ä»¶çš„ä¸»è¦ç›®çš„æ˜¯æš´éœ²ä¸€äº›è‡ªå®šä¹‰çš„ metricsï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åˆ° <code>io.opentelemetry.api.metrics</code> è¿™ä¸ªåŒ…ï¼š</p><p>è¿™é‡Œä»¥ Producer ç”Ÿäº§è€…ä¸ºä¾‹ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åˆ›å»ºç”Ÿäº§è€…çš„æ—¶å€™å°†ç”Ÿäº§è€…å¯¹è±¡å­˜å‚¨èµ·æ¥</li><li>OpenTelemetry æ¡†æ¶ä¼šæ¯éš”ä¸€æ®µæ—¶é—´å›è°ƒä¸€ä¸ªè‡ªå®šä¹‰çš„å‡½æ•°</li><li>åœ¨è¿™ä¸ªå‡½æ•°ä¸­éå†æ‰€æœ‰çš„ producer è·å–å®ƒçš„ç›‘æ§æŒ‡æ ‡ï¼Œç„¶åæš´éœ²å‡ºå»ã€‚</li></ul><p>æ³¨å†Œå‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerObservers</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">Meter</span> <span class="variable">meter</span> <span class="operator">=</span> MetricsRegistration.getMeter();  </span><br><span class="line">  </span><br><span class="line">    meter.gaugeBuilder(<span class="string">&quot;pulsar_producer_num_msg_send&quot;</span>)  </span><br><span class="line">            .setDescription(<span class="string">&quot;The number of messages published in the last interval&quot;</span>)  </span><br><span class="line">            .ofLongs()  </span><br><span class="line">            .buildWithCallback(  </span><br><span class="line">                    r -&gt; recordProducerMetrics(r, ProducerStats::getNumMsgsSent));</span><br></pre></td></tr></table></figure><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recordProducerMetrics</span><span class="params">(ObservableLongMeasurement observableLongMeasurement, Function&lt;ProducerStats, Long&gt; getter)</span> &#123;  </span><br><span class="line">    <span class="keyword">for</span> (Producer producer : CollectionHelper.PRODUCER_COLLECTION.list()) &#123;  </span><br><span class="line">        <span class="type">ProducerStats</span> <span class="variable">stats</span> <span class="operator">=</span> producer.getStats();  </span><br><span class="line">        <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> producer.getTopic();  </span><br><span class="line">        <span class="keyword">if</span> (topic.endsWith(RetryMessageUtil.RETRY_GROUP_TOPIC_SUFFIX)) &#123;  </span><br><span class="line">            <span class="keyword">continue</span>;  </span><br><span class="line">        &#125;        observableLongMeasurement.record(getter.apply(stats),  </span><br><span class="line">                Attributes.of(PRODUCER_NAME, producer.getProducerName(), TOPIC, topic));  </span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure><p>å›è°ƒå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­éå†æ‰€æœ‰çš„ç”Ÿäº§è€…ï¼Œç„¶åè¯»å–å®ƒçš„ç›‘æ§æŒ‡æ ‡ã€‚</p><p>è¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ªè‡ªå®šä¹‰æŒ‡æ ‡çš„æš´éœ²ï¼Œä½¿ç”¨çš„æ—¶å€™åªéœ€è¦åŠ è½½è¿™ä¸ªæ’ä»¶å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent.jar \</span><br><span class="line">     -Dotel.javaagent.extensions=ext.jar</span><br><span class="line">     -jar myapp.jar</span><br></pre></td></tr></table></figure><p><code>-Dotel.javaagent.extensions=/extensions</code><br>å½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹æ‰€æœ‰çš„ jar éƒ½ä¼šè¢«ä½œä¸º extensions è¢«åŠ å…¥è¿›æ¥ã€‚</p><h2 id="æ‰“åŒ…"><a href="#æ‰“åŒ…" class="headerlink" title="æ‰“åŒ…"></a>æ‰“åŒ…</h2><p>ä½¿ç”¨ <code>./gradlew build</code> æ‰“åŒ…ï¼Œä¹‹åå¯ä»¥åœ¨<code>build/libs/</code>ç›®å½•ä¸‹æ‰¾åˆ°ç”Ÿæˆç‰©ã€‚</p><p>å½“ç„¶ä¹Ÿå¯ä»¥å°† extension ç›´æ¥æ‰“åŒ…åˆ° <code>opentelemetry-javaagent.jar</code>ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨æŒ‡å®š <code>-Dotel.javaagent.extensions</code>å‚æ•°äº†ã€‚</p><p>å…·ä½“å¯ä»¥åœ¨ gradle ä¸­åŠ å…¥ä»¥ä¸‹ taskï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">task <span class="title function_">extendedAgent</span><span class="params">(type: Jar)</span> &#123;</span><br><span class="line">  dependsOn(configurations.otel)</span><br><span class="line">  archiveFileName = <span class="string">&quot;opentelemetry-javaagent.jar&quot;</span></span><br><span class="line">  from <span class="title function_">zipTree</span><span class="params">(configurations.otel.singleFile)</span></span><br><span class="line">  from(tasks.shadowJar.archiveFile) &#123;</span><br><span class="line">    into <span class="string">&quot;extensions&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//Preserve MANIFEST.MF file from the upstream javaagent</span></span><br><span class="line">  doFirst &#123;</span><br><span class="line">    manifest.from(</span><br><span class="line">      zipTree(configurations.otel.singleFile).matching &#123;</span><br><span class="line">        include <span class="string">&#x27;META-INF/MANIFEST.MF&#x27;</span></span><br><span class="line">      &#125;.singleFile</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“å¯ä»¥å‚è€ƒè¿™é‡Œçš„é…ç½®ï¼š<br><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/examples/extension/build.gradle#L125">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/examples/extension/build.gradle#L125</a></p><h1 id="è¸©å‘"><a href="#è¸©å‘" class="headerlink" title="è¸©å‘"></a>è¸©å‘</h1><p>çœ‹èµ·æ¥è¿™ä¸ªå¼€å‘è¿‡ç¨‹æŒºç®€å•çš„ï¼Œä½†å…¶ä¸­çš„å‘è¿˜æ˜¯ä¸å°‘ã€‚</p><h2 id="NoClassDefFoundError"><a href="#NoClassDefFoundError" class="headerlink" title="NoClassDefFoundError"></a>NoClassDefFoundError</h2><p>é¦–å…ˆç¬¬ä¸€ä¸ªå°±æ˜¯æˆ‘åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­å‡ºç° <code>NoClassDefFoundError</code> çš„å¼‚å¸¸ã€‚</p><p>ä½†æˆ‘æŠŠæ‰“åŒ…å¥½çš„ extension è§£å‹åæ˜æ˜æ˜¯å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»çš„ã€‚</p><p><img src="https://s2.loli.net/2024/03/10/oyfEm27Tz5IJCnF.png"></p><p>æ’æŸ¥ä¸€æ®µæ—¶é—´åæ²¡å•¥å¤´ç»ªï¼Œæˆ‘å°±ä»å¤´ä»”ç»†é˜…è¯»äº†å¼€å‘æ–‡æ¡£ï¼š<br><img src="https://s2.loli.net/2024/03/10/sLbS7Hum5TUz1VD.png"></p><p>å‘ç°æˆ‘ä»¬éœ€è¦é‡å†™ <code>getAdditionalHelperClassNames</code>å‡½æ•°ï¼Œç”¨äºå°†æˆ‘ä»¬å¤–éƒ¨çš„ä¸€äº›å·¥å…·ç±»åŠ å…¥åˆ°åº”ç”¨çš„ class loader ä¸­ï¼Œä¸ç„¶åœ¨åº”ç”¨åœ¨è¿è¡Œçš„æ—¶å€™å°±ä¼šæŠ¥ <code>NoClassDefFoundError</code> çš„é”™è¯¯ã€‚</p><p>å› ä¸ºæ˜¯å­—èŠ‚ç å¢å¼ºçš„å…³ç³»ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¥å¸¸å¼€å‘è§‰å¾—å¾ˆå¸¸è§çš„åœ°æ–¹éƒ½ä¸è¡Œäº†ï¼Œæ¯”å¦‚ï¼š</p><ul><li>å¦‚æœåˆ‡é¢ç±»æ˜¯ä¸€ä¸ªå†…éƒ¨ç±»çš„æ—¶å€™ï¼Œå¿…é¡»ä½¿ç”¨é™æ€å‡½æ•°</li><li>åªèƒ½åŒ…å«é™æ€å‡½æ•°</li><li>ä¸èƒ½åŒ…å«ä»»ä½•å­—æ®µï¼Œå¸¸é‡ã€‚</li><li>ä¸èƒ½ä½¿ç”¨ä»»ä½•å¤–éƒ¨ç±»ï¼Œå¦‚æœè¦ä½¿ç”¨å°±å¾—ä½¿ç”¨ <code>getAdditionalHelperClassNames</code> é¢å¤–åŠ å…¥åˆ° class loader ä¸­ï¼ˆè¿™ä¸€æ¡å°±æ˜¯æˆ‘é‡åˆ°çš„é—®é¢˜ï¼‰</li><li>æ‰€æœ‰çš„å‡½æ•°å¿…é¡»ä½¿ç”¨ <code>@Advice</code> æ³¨è§£</li></ul><p>ä»¥ä¸Šçš„å†…å®¹å…¶å®åœ¨æ–‡æ¡£ä¸­éƒ½æœ‰å†™ï¼š<br><img src="https://s2.loli.net/2024/03/10/1bXg6CMZYaUmdsu.png"></p><p>æ‰€ä»¥è¿˜æ˜¯å¾—ä»”ç»†é˜…è¯»æ–‡æ¡£ã€‚</p><h2 id="ç¼ºå°‘å¼‚å¸¸æ—¥å¿—"><a href="#ç¼ºå°‘å¼‚å¸¸æ—¥å¿—" class="headerlink" title="ç¼ºå°‘å¼‚å¸¸æ—¥å¿—"></a>ç¼ºå°‘å¼‚å¸¸æ—¥å¿—</h2><p>å…¶å®ä¸Šè¿°çš„å¼‚å¸¸åˆšå¼€å§‹éƒ½æ²¡æœ‰æ‰“å°å‡ºæ¥ï¼Œåªæœ‰ä¸€ä¸ªç°è±¡å°±æ˜¯ç¨‹åºæ²¡æœ‰æ­£å¸¸è¿è¡Œã€‚</p><p>å› ä¸ºæ²¡æœ‰æ—¥å¿—ä¹Ÿä¸çŸ¥é“å¦‚ä½•æ’æŸ¥ï¼Œä¹Ÿæ€€ç–‘æ˜¯ä¸æ˜¯è¿è¡Œè¿‡ç¨‹ä¸­æŠ¥é”™äº†ï¼Œæ‰€ä»¥å°±å°è¯•æŠŠ<code>@Advice</code> æ³¨è§£çš„å‡½æ•°å…¨éƒ¨ try catch ï¼Œæœç„¶æ‰“å°äº†ä¸Šè¿°çš„å¼‚å¸¸æ—¥å¿—ã€‚</p><p><img src="https://s2.loli.net/2024/03/10/RMZbpyvkVc9qmJL.png"></p><p>ä¹‹åæˆ‘æ³¨æ„åˆ°äº†æ³¨è§£çš„è¿™ä¸ªå‚æ•°ï¼ŒåŸæ¥åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸ä¼šæ‰“å°ä»»ä½•æ—¥å¿—çš„ï¼Œéœ€è¦æ‰‹åŠ¨æ‰“å¼€ã€‚</p><p>æ¯”å¦‚è¿™æ ·ï¼š<code>@Advice.OnMethodExit(suppress = Throwable.class)</code></p><h2 id="è°ƒè¯•æ—¥å¿—"><a href="#è°ƒè¯•æ—¥å¿—" class="headerlink" title="è°ƒè¯•æ—¥å¿—"></a>è°ƒè¯•æ—¥å¿—</h2><p>æœ€åå°±æ˜¯è°ƒè¯•åŠŸèƒ½äº†ï¼Œå› ä¸ºæˆ‘è¿™ä¸ªæ’ä»¶çš„æ˜¯æŠŠæŒ‡æ ‡å‘é€åˆ° OpenTelemetry-collector ï¼Œå†ç”±å®ƒå‘å¾€ <code>VictoriaMetrics/Prometheus</code>ï¼›ç”±äºæ•´ä¸ªé“¾è·¯æ¯”è¾ƒé•¿ï¼Œæˆ‘æƒ³çœ‹åˆ°æœ€ç»ˆç”Ÿæˆçš„æŒ‡æ ‡æ˜¯å¦æ­£å¸¸çš„å¹²æ‰°æ¡ä»¶å¤ªå¤šäº†ã€‚</p><p>å¥½åœ¨ OpenTelemetry æä¾›äº†å¤šç§ metrics.exporter çš„è¾“å‡ºæ–¹å¼ï¼š</p><ul><li>-Dotel.metrics.exporter&#x3D;otlp (default)ï¼Œé»˜è®¤é€šè¿‡ otlp åè®®è¾“å‡ºåˆ° collector ä¸­ã€‚</li><li>-Dotel.metrics.exporter&#x3D;loggingï¼Œä»¥ stdout çš„æ–¹å¼è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œä¸»è¦ç”¨äºè°ƒè¯•</li><li>-Dotel.metrics.exporter&#x3D;logging-otlp</li><li>-Dotel.metrics.exporter&#x3D;prometheusï¼Œä»¥ Prometheus çš„æ–¹å¼è¾“å‡ºï¼Œè¿˜å¯ä»¥é…ç½®ç«¯å£ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥è®© Prometheus è¿›è¡Œè¿œç¨‹é‡‡é›†ï¼ŒåŒæ ·çš„ä¹Ÿå¯ä»¥åœ¨æœ¬åœ°è°ƒè¯•ã€‚</li></ul><p>é‡‡ç”¨å“ªç§æ–¹å¼å¯ä»¥æ ¹æ®ç¯å¢ƒæƒ…å†µè‡ªè¡Œé€‰æ‹©ã€‚</p><h1 id="Opentelemetry-operator-é…ç½®-extension"><a href="#Opentelemetry-operator-é…ç½®-extension" class="headerlink" title="Opentelemetry-operator é…ç½® extension"></a>Opentelemetry-operator é…ç½® extension</h1><p>æœ€è¿‘åœ¨ä½¿ç”¨ <code>opentelemetry-operator</code>æ³¨å…¥ agent çš„æ—¶å€™å‘ç° operator ç›®å‰å¹¶ä¸æ”¯æŒé…ç½® extensionï¼Œæ‰€ä»¥åœ¨ç¤¾åŒºä¹Ÿæäº¤äº†ä¸€ä¸ª<a href="https://github.com/open-telemetry/opentelemetry-operator/issues/1758#issuecomment-1982159356">è‰æ¡ˆ</a>ï¼Œä¸‹å‘¨ä¼šå°è¯•æäº¤ä¸€ä¸ª PR æ¥æ–°å¢è¿™ä¸ªç‰¹æ€§ã€‚</p><blockquote><p>è¿™ä¸ªéœ€æ±‚æˆ‘åœ¨ issue åˆ—è¡¨ä¸­æ‰¾åˆ°äº†å¥½å‡ ä¸ªï¼Œæ—¶é—´ä¹ŸæŒºä¹…è¿œäº†ï¼Œä¸å¤ªç¡®å®šä¸ºä»€ä¹ˆç¤¾åŒºè¿˜ä¸ºå®ç°ã€‚</p></blockquote><p>ç›®å‰ operator åªæ”¯æŒåœ¨è‡ªå®šä¹‰é•œåƒä¸­é…ç½® <code>javaagent.jar</code>ï¼Œæ— æ³•é…ç½® extensionï¼š</p><blockquote><p>è¿™ä¸ªåŸç†åœ¨ä¹‹å‰çš„<a href="https://juejin.cn/post/7341669201010262053#heading-9">æ–‡ç« </a>ä¸­æœ‰æåˆ°ã€‚</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Instrumentation</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-instrumentation</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">java:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">your-customized-auto-instrumentation-image:java</span></span><br></pre></td></tr></table></figure><p>æˆ‘çš„ç›®çš„æ˜¯å¯ä»¥åœ¨è‡ªå®šä¹‰é•œåƒä¸­æŠŠ extension ä¹Ÿå¤åˆ¶è¿›å»ï¼Œç±»ä¼¼äºè¿™æ ·ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> busybox</span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> open-telemetry/opentelemetry-javaagent.jar /javaagent.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy extensions to specify a path.</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> open-telemetry/ext-1.0.0.jar /ext-1.0.0.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> -R go+r /javaagent.jar</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> -R go+r /ext-1.0.0.jar</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ CRD ä¸­é…ç½®è¿™ä¸ª <code>extension</code> çš„è·¯å¾„ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Instrumentation</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-instrumentation</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">java:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">custom-image:1.0.0</span></span><br><span class="line">    <span class="attr">extensions:</span> <span class="string">/ext-1.0.0.jar</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="comment"># If extension.jar already exists in the container, you can only specify a specific path with this environment variable.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXTENSIONS_DIR</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">/custom-dir</span></span><br></pre></td></tr></table></figure><p>è¿™æ · operator åœ¨æ‹¿åˆ° extension çš„è·¯å¾„æ—¶ï¼Œå°±å¯ä»¥åœ¨ç¯å¢ƒå˜é‡ä¸­åŠ å…¥ <code>-Dotel.javaagent.extensions=$&#123;java.extensions&#125;</code> å‚æ•°ï¼Œä»è€Œå®ç°è‡ªå®šä¹‰ extension çš„ç›®çš„ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ•´ä¸ªè¿‡ç¨‹å…¶å®å¹¶ä¸å¤æ‚ï¼Œåªæ˜¯ç”±äºç›®å‰ç”¨çš„äººè¿˜ä¸ç®—å¤šï¼Œæ‰€ä»¥ä¹Ÿå¾ˆå°‘æœ‰äººå†™æ•™ç¨‹æˆ–è€…æ–‡ç« ï¼Œç›¸ä¿¡ç”¨ä¸äº†å¤šä¹…å°±ä¼šæ…¢æ…¢æ™®åŠã€‚</p><p>è¿™é‡Œæœ‰ä¸€äº›å®˜æ–¹çš„ <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/tree/main/examples/extension#extensions-examples">example</a>å¯ä»¥å‚è€ƒã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/apache/pulsar/pull/22178">https://github.com/apache/pulsar/pull/22178</a></li><li><a href="https://opentelemetry.io/docs/languages/java/automatic/extensions/">https://opentelemetry.io/docs/languages/java/automatic/extensions/</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/tree/main/examples/extension#extensions-examples">https://github.com/open-telemetry/opentelemetry-java-instrumentation/tree/main/examples/extension#extensions-examples</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-operator/issues/1758#issuecomment-1982159356">https://github.com/open-telemetry/opentelemetry-operator/issues/1758#issuecomment-1982159356</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å‰æ®µæ—¶é—´æˆ‘ä»¬ä» &lt;code&gt;SkyWalking&lt;/code&gt; åˆ‡æ¢åˆ°äº† &lt;code&gt;OpenTelemetry&lt;/code&gt; ï¼Œä¸æ­¤åŒæ—¶ä¹‹å‰ä½¿ç”¨ SkyWalking ç¼–å†™çš„æ’ä»¶ä¹Ÿå¾—è½¬ç§»åˆ° OpenTelemetry ä½“ç³»ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä¹Ÿå†™äº†ç›¸å…³ä»‹ç»æ–‡ç« ï¼š&lt;br&gt;å®æˆ˜ï¼š&lt;a href=&quot;https://juejin.cn/post/7341669201010262053&quot;&gt;å¦‚ä½•ä¼˜é›…çš„ä» SkyWalking åˆ‡æ¢åˆ° OpenTelemetry&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å¥½åœ¨ OpenTelemetry ç¤¾åŒºä¹Ÿæä¾›äº† Extensions çš„æ‰©å±•å¼€å‘ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨å»ä¿®æ”¹ç¤¾åŒºå‘è¡Œç‰ˆï¼š&lt;code&gt;opentelemetry-javaagent.jar&lt;/code&gt; çš„æºç ä¹Ÿå¯ä»¥æ‰©å±•å…¶ä¸­çš„èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚å¯ä»¥ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¿®æ”¹ä¸€äº› traceï¼ŒæŸäº› span ä¸æƒ³è®°å½•ç­‰ã€‚&lt;/li&gt;
&lt;li&gt;æ–°å¢ metrics&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>2024å¹´çš„äº‘åŸç”Ÿæ¶æ„éœ€è¦å“ªäº›æŠ€æœ¯æ ˆ</title>
    <link href="http://crossoverjie.top/2024/04/11/ob/2024-cloud-native/"/>
    <id>http://crossoverjie.top/2024/04/11/ob/2024-cloud-native/</id>
    <published>2024-04-11T02:22:21.000Z</published>
    <updated>2024-04-10T13:34:24.356Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æ—¶é—´è¿‡å¾—å¾ˆå¿«å•Šï¼Œä¸€è½¬çœ¼å·²ç»åˆ°äº† 2024 å¹´ï¼Œè¿˜è®°å¾— 15 å¹´åˆšå·¥ä½œé‚£ä¼šæŒæ¡ä¸ª <code>SSM/H(Spring/Struts2/Mybatis/Hibernate)</code> æ¡†æ¶å°±èƒ½åº”ä»˜å¤§éƒ¨åˆ†é¢è¯•äº†ã€‚</p><blockquote><p>ç°åœ¨ CS ä¸“ä¸šçš„æ–°åŒå­¦ä¼°è®¡éƒ½æ²¡å¬è¯´è¿‡ SSMğŸ˜¢</p></blockquote><p>æ°å¥½ä»æˆ‘åˆšå¼€å§‹å·¥ä½œæ—¶çš„ç§»åŠ¨äº’è”ç½‘çƒ­æ½®åˆ°ç”µå•†-&gt;å…±äº«ç»æµ-&gt;toB å¤§çƒ­-&gt;å¦‚ä»Šæˆ‘éƒ½ç»å†äº†ä¸€éï¼ŒæŠ€æœ¯æ ˆä¹Ÿæœ‰ç”±æœ€å¼€å§‹çš„å•ä½“åº”ç”¨+ç‰©ç†æœºå‘å±•åˆ°ç°åœ¨çš„ kubernetes äº‘åŸç”Ÿæ¶æ„ã€‚</p><p>å½“ç„¶ä¸­é€”ä¹Ÿç»å†äº†å‡ ä¸ªå¤§çš„é˜¶æ®µï¼š<br>SOAæœåŠ¡åŒ–-&gt; å¾®æœåŠ¡-&gt; äº‘åŸç”Ÿ-&gt; æœåŠ¡ç½‘æ ¼-&gt; æ— æœåŠ¡ç­‰å‡ ä¸ªé˜¶æ®µã€‚</p><p>æœ€è¿‘ä¸€ä»½å·¥ä½œåˆä¸»è¦æ˜¯åœ¨åšåŸºç¡€æ¶æ„ï¼Œæˆ‘è®¤ä¸ºäº†è§£çš„è¿˜ç®—æ˜¯æ¯”è¾ƒå…¨é¢çš„ï¼Œæ‰€ä»¥æœ¬æ–‡æˆ‘å°±ä»¥æˆ‘çš„è§†è§’åˆ†äº«ä¸‹æˆ‘ä»¬åœ¨ 2024 å¹´åº”å½“ä½¿ç”¨å“ªäº›äº‘åŸç”ŸæŠ€æœ¯æ ˆï¼Œå› ä¸ºæ¶‰åŠåˆ°çš„æŠ€æœ¯ç»„ä»¶æ¯”è¾ƒå¤šï¼Œå°±ä¸è¿‡å¤šè®¨è®ºç»†èŠ‚äº†ã€‚</p><p>ä½†å¯ä»¥ä¿è¯çš„æ˜¯æåˆ°çš„æŠ€æœ¯æ ˆéƒ½æ˜¯æˆ‘æ‰€ç”¨è¿‡çš„ï¼Œä¼˜ç¼ºç‚¹éƒ½ä¼šæåˆ°ï¼Œä¸»æ‰“ä¸€ä¸ªçœŸå®ä½“éªŒã€‚</p><span id="more"></span><h1 id="æ“ä½œç³»ç»Ÿ"><a href="#æ“ä½œç³»ç»Ÿ" class="headerlink" title="æ“ä½œç³»ç»Ÿ"></a>æ“ä½œç³»ç»Ÿ</h1><p> é¦–å…ˆæ˜¯æ“ä½œç³»ç»Ÿï¼Œè¿™é‡Œæœ‰åˆ«äºä»¥å¾€æˆ‘ä»¬ä¼ ç»Ÿçš„æ“ä½œç³»ç»Ÿ(Linux&#x2F;Windows Server&#x2F;MacOS)ï¼Œä¸»è¦æŒ‡çš„æ˜¯äº‘åŸç”Ÿçš„æ“ä½œç³»ç»Ÿï¼Œæ²¡æœ‰å¤ªå¤šå¯ä»¥é€‰æ‹©çš„ä½™åœ°ï¼Œé‚£å°±æ˜¯ <code>kubernetes</code>ã€‚</p><p>ä¸è¿‡æ€ä¹ˆç»´æŠ¤å¥½ kubernetes æ˜¯ä¸€ä¸ªéš¾ç‚¹é—®é¢˜ï¼Œè¿˜è®°å¾—å»å¹´ä¸‹åŠå¹´æ»´æ»´å‡ºè¿‡ä¸€æ¬¡äº‹æ•…ï¼Œç½‘ä¼ å°±æ˜¯ kubernetes å‡çº§å‡ºç°çš„é—®é¢˜ã€‚</p><p>æ ¹æ®æˆ‘ä»¬çš„ç»éªŒæ¥çœ‹ï¼Œå¯¹äºå°å›¢é˜Ÿæ›´å»ºè®®ç›´æ¥æ‰˜ç®¡ç»™äº‘å‚å•†ï¼Œç»´æŠ¤ kubernetes æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„å·¥ä½œï¼Œå°å›¢é˜Ÿé€šå¸¸éƒ½æ˜¯ä¸€èŒå¤šèƒ½ï¼Œè‡ªå·±ç»´æŠ¤æ›´å®¹æ˜“å‡ºé—®é¢˜ã€‚</p><p>å½“ç„¶å¤§å›¢é˜Ÿæœ‰ä¸“äººç»´æŠ¤æœ€å¥½ï¼Œå³ä¾¿æ˜¯å‡ºé—®é¢˜ä¹Ÿèƒ½å¿«é€Ÿå“åº”ï¼Œå‰ææ˜¯è‡ªå·±èƒ½ cover ä½è¿™ä¸ªé£é™©ã€‚</p><blockquote><p>å› ä¸ºæˆ‘ä»¬æ˜¯å°å›¢é˜Ÿï¼Œæ‰€ä»¥è€ƒè™‘åˆ°æˆæœ¬å’Œç¨³å®šæ€§ï¼Œæˆ‘ä»¬ä¹Ÿåªä½¿ç”¨äº†äº‘å‚å•†çš„ kubernetes èƒ½åŠ›ï¼Œå…¶ä½™çš„éƒ¨åˆ†å¯æ§ç»„ä»¶ç”±æˆ‘ä»¬è‡ªå·±ç»´æŠ¤ï¼ˆå…·ä½“çš„åæ–‡ä¼šè®²åˆ°ï¼‰</p></blockquote><h2 id="å¤šäº‘çš„ä¼˜åŠ¿ä¸å¥½å¤„"><a href="#å¤šäº‘çš„ä¼˜åŠ¿ä¸å¥½å¤„" class="headerlink" title="å¤šäº‘çš„ä¼˜åŠ¿ä¸å¥½å¤„"></a>å¤šäº‘çš„ä¼˜åŠ¿ä¸å¥½å¤„</h2><p>æ—¢ç„¶éƒ½ç”¨äº†äº‘å‚å•†çš„å®¹å™¨æœåŠ¡ï¼Œé‚£ä¹Ÿè¦è€ƒè™‘åˆ°äº‘å‚å•†æ•…éšœå¯èƒ½å¸¦æ¥çš„é—®é¢˜ï¼›æ¯”å¦‚å»å¹´çš„é˜¿é‡Œäº‘æ•…éšœã€‚</p><p>æ‰€ä»¥ç°åœ¨ä¸€äº›ä¸­å¤§å‚ä¹Ÿä¼šé€‰æ‹©å¤šäº‘æ–¹æ¡ˆï¼Œå°†åŒä¸€ä»½ä»£ç éƒ¨ç½²å†å¤šä¸ªäº‘æœåŠ¡å•†ï¼Œä¸€æ—¦å…¶ä¸­ä¸€ä¸ªå‡ºç°é—®é¢˜å¯ä»¥å¿«é€Ÿåˆ‡æ¢ã€‚</p><p>ä½†å…·ä½“çš„å®æ–½è¿‡ç¨‹ä¸­ä¹Ÿæœ‰è®¸å¤šæŒ‘æˆ˜ï¼Œæ¯”å¦‚æœ€æ£˜æ‰‹ä¹Ÿæ˜¯æœ€å…³é”®çš„æ•°æ®ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ</p><p>å½“ç„¶æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸€äº›æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²çš„æ•°æ®åº“æˆ–ä¸­é—´ä»¶ï¼Œä»–ä»¬æœ¬èº«æ˜¯æ”¯æŒæ•°æ®åŒæ­¥çš„ï¼›æ¯”å¦‚æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ Pulsarï¼Œå®ƒå°±å¯ä»¥è·¨çº§ç¾¤éƒ¨ç½²ä»¥åŠæ¶ˆæ¯åŒæ­¥ã€‚</p><p>åŒæ—¶å¤šäº‘éƒ¨ç½²å¯¹åº”çš„æˆæœ¬ä¹Ÿä¼šæå‡ï¼Œåœ¨è¿™ä¸ªâ€œé™æœ¬å¢æ•ˆâ€çš„å¤§èƒŒæ™¯ä¸‹ä¹Ÿå¾—æ…é‡è€ƒè™‘ï¼›æ‰€ä»¥å¯¹æ­¤è¿˜æœ‰ä¸€ä¸ªæŠ˜ä¸­æ–¹æ¡ˆï¼š</p><blockquote><p>æˆ‘ä»¬çš„æŠ€æœ¯æ¶æ„éœ€è¦å…·å¤‡å¿«é€Ÿè¿ç§»åˆ°å…¶ä»–äº‘æœåŠ¡çš„èƒ½åŠ›ï¼Œæ¯”å¦‚æˆ‘ä»¬å†…éƒ¨æœ‰ä¸€äº›å·¥å…·å¯ä»¥å®šæœŸå¤‡ä»½èµ„æºï¼Œæ¯”å¦‚ MySQL çš„ binlogï¼Œä¸€äº›ä¸­é—´ä»¶çš„å…ƒæ•°æ®ï¼ŒåŒæ—¶å¯ä»¥åŸºäºè¿™äº›å…ƒæ•°æ®å¿«é€Ÿæ¢å¤ä¸šåŠ¡ã€‚</p></blockquote><p>ä¸€èˆ¬é‡åˆ°éœ€è¦åˆ‡æ¢äº‘æœåŠ¡æ—¶éƒ½æ˜¯ä¸€äº›æç«¯æƒ…å†µï¼Œæ‰€ä»¥å…è®¸éƒ¨åˆ†è¿è¡Œæ—¶çš„æ•°æ®ä¸¢å¤±ä¹Ÿæ˜¯èƒ½æ¥å—çš„ï¼Œæˆ‘ä»¬åªè¦ä¿è¯æœ€æ ¸å¿ƒçš„æ•°æ®ä¸ä¼šä¸¢å¤±ä»è€Œä¸å½±å“ä¸šåŠ¡å³å¯ã€‚</p><p>è¿™ä¸ªè¯´èµ·æ¥ç®€å•ï¼Œä½†ä¹Ÿéœ€è¦æˆ‘ä»¬èŠ±æ—¶é—´è¿›è¡Œæ¨¡æ‹Ÿæ¼”ç»ƒï¼›å…·ä½“æ˜¯å¦å®æ–½å°±å¾—çœ‹å…¬å¸æ˜¯å¦æ¥å—äº‘æœåŠ¡å®•æœºå¸¦æ¥çš„æŸå¤±ä»¥åŠæ¼”ç»ƒæ‰€èŠ±çš„æˆæœ¬äº†ã€‚</p><blockquote><p>æˆ‘ä»¬æ˜¯å…·å¤‡æ¢å¤å…ƒæ•°æ®èƒ½åŠ›çš„ï¼Œä½†ä¼šä¸¢å¤±éƒ¨åˆ†è¿è¡Œæ—¶çš„æ•°æ®ã€‚</p></blockquote><h1 id="DevOps"><a href="#DevOps" class="headerlink" title="DevOps"></a>DevOps</h1><p>æ—¢ç„¶æˆ‘ä»¬å·²ç»é€‰æ‹© kubernetes ä½œä¸ºæˆ‘ä»¬äº‘åŸç”Ÿçš„æ“ä½œç³»ç»Ÿï¼Œé‚£æˆ‘ä»¬çš„æŒç»­é›†æˆä¸å‘å¸ƒä¹Ÿå¾—å›´ç»•ç€ kubernetes æ¥åšã€‚</p><p><img src="https://s2.loli.net/2024/03/05/P2ducxQtqSCGnDb.png"></p><p>ä¸Šå›¾æ˜¯ä¸€å¼ ä½¿ç”¨ Git é…åˆ gitlab+ArgoCD çš„æµç¨‹å›¾ï¼Œæˆ‘ä»¬ä½¿ç”¨ gitlab æ¥ç®¡ç†æºç ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åˆ©ç”¨ä»–çš„ Pipline å¸®æˆ‘ä»¬åšæŒç»­é›†æˆï¼Œæœ€ç»ˆä½¿ç”¨ Argo å¸®æˆ‘ä»¬æ‰“é€š kubernetes çš„æµç¨‹ã€‚</p><blockquote><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ <code>GitOps</code></p></blockquote><p>åŒæ—¶æˆ‘ä»¬çš„å›æ»šå†å²ç‰ˆæœ¬ï¼Œæ‰©ç¼©å®¹éƒ½ç”± kubernetes æä¾›èƒ½åŠ›ï¼Œæˆ‘ä»¬çš„ DevOps å¹³å°åªéœ€è¦è°ƒç”¨ kubernetes çš„ API å³å¯ã€‚</p><p>å½“ç„¶è¿˜æœ‰ç°åœ¨æµè¡Œ FinOpsï¼Œæˆ‘çš„ç†è§£ä¸»è¦æ˜¯åšäº‘æˆæœ¬çš„ç®¡ç†å’Œä¼˜åŒ–ï¼Œå¯¹åº”åˆ°æˆ‘çš„å·¥ä½œå°±æ˜¯å›æ”¶ä¸€äº›ä¸ç”¨çš„èµ„æºï¼Œåœ¨ä¸å½±å“ä¸šåŠ¡çš„æƒ…å†µä¸‹é€‚å½“çš„é™ä½ä¸€äº›é…ç½®ğŸ˜³ã€‚</p><h1 id="Service-Mesh"><a href="#Service-Mesh" class="headerlink" title="Service Mesh"></a>Service Mesh</h1><p><img src="https://s2.loli.net/2024/03/06/mlzdFAHNM6bDGvr.png"></p><p>æ¥ä¸‹æ¥ä¾¿æ˜¯æˆ‘è®¤ä¸ºæœ€é‡è¦çš„ Service Mesh ç¯èŠ‚äº†ï¼Œè¿™ä¸ªçš„èƒŒæ™¯æ•…äº‹å°±å¤šäº†ï¼Œæœ¬è´¨ä¸Šæˆ‘è§‰å¾—è¿™éƒ½æ˜¯ç”± RPC(Remote Process Call) å¼•èµ·çš„ä¹Ÿæ˜¯åˆ†å¸ƒå¼æ‰€å¸¦æ¥çš„ã€‚</p><p>ç”±æœ€å¼€å§‹çš„å•æœºçš„æœ¬åœ°å‡½æ•°è°ƒç”¨å¼€å§‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">local+------&gt;remote +------&gt; micro-service+-----&gt;service-mesh</span><br><span class="line">               +                  |                    +</span><br><span class="line">               v                  v                    v</span><br><span class="line">           +---+----+       +-----+------+        +----+----+</span><br><span class="line">           | motan  |       | SpringCloud|        | Istio   |</span><br><span class="line">           | dubbo  |       | Dubbo3.0   |        | Linkerd |</span><br><span class="line">           | gRPC   |       | SOFA       |        |         |</span><br><span class="line">           +--------+       +------------+        +---------+</span><br></pre></td></tr></table></figure><p>ä¸»è¦ç»å†äº†ä»¥ä¸Šä¸‰ä¸ªé‡è¦çš„é˜¶æ®µï¼Œåˆ†åˆ«æ˜¯ RPC æ¡†æ¶åˆ°å¾®æœåŠ¡å†åˆ°ç°åœ¨çš„æœåŠ¡ç½‘æ ¼ã€‚</p><ul><li>RPC æ¡†æ¶ä¸»è¦å¸®æˆ‘ä»¬ç®€åŒ–äº†åˆ†å¸ƒå¼é€šä¿¡ï¼Œåªä¸“æ³¨äºä¸šåŠ¡æœ¬èº«</li><li>å¾®æœåŠ¡æ¡†æ¶çš„å‡ºç°å¯ä»¥æ›´å¥½çš„å¸®æˆ‘ä»¬æ²»ç†å¤§æ‰¹é‡çš„æœåŠ¡ï¼Œæ¯”å¦‚ä¸€äº›é™æµã€è·¯ç”±ã€é™çº§ç­‰åŠŸèƒ½ï¼Œè®©æˆ‘ä»¬åˆ†å¸ƒå¼åº”ç”¨æ›´åŠ å¥å£®ã€‚</li><li>è€Œå¦‚ä»Šçš„æœåŠ¡ç½‘æ ¼è®©æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ›´åŠ é€‚é…äº‘åŸç”Ÿï¼Œä¸“æ³¨äºä¸šåŠ¡ç ”å‘è€Œä¸å†éœ€è¦å»ç»´æŠ¤å¾®æœåŠ¡æ¡†æ¶ï¼›å°†è¿™äº›åŸºç¡€åŠŸèƒ½å…¨éƒ¨ä¸‹æ²‰åˆ°æˆ‘ä»¬çš„åŸºç¡€å±‚ï¼ŒåŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸å¼±äºå¾®æœåŠ¡æ¡†æ¶çš„åŠŸèƒ½æ€§ã€‚</li></ul><p>ä½†ä½¿ç”¨ Istio ä¹Ÿæœ‰ç€ä¸ä½çš„æŠ€æœ¯é—¨æ§›ï¼Œæˆ‘è§‰å¾—å¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ›´æ¨èä½¿ç”¨ Istioï¼š</p><ul><li>åº”ç”¨å·²ç»æ¥å…¥ kubernetes å¹³å°</li><li>åº”ç”¨ä¹‹é—´é‡‡ç”¨çš„æ˜¯ gRPC é€šè®¯æ¡†æ¶</li><li>API ç½‘å…³ä¹Ÿè¿ç§»åˆ° Istio Gateway</li><li>å…¬å¸è‡³å°‘é¢„å¤‡ä¸€ä¸ªä¸“äººç»´æŠ¤ Istioï¼ˆè¿™é‡Œçš„ç»´æŠ¤ä¸ä¸€å®šæ˜¯å¯¹ä»£ç çš„äº†è§£ï¼Œä½†ä¸€å®šè¦å¯¹ Istio æœ¬èº«çš„åŠŸèƒ½å’Œæ–‡æ¡£è¶³å¤Ÿäº†è§£ï¼‰</li></ul><p>é™¤æ­¤ä¹‹å¤–ä½¿ç”¨ <code>SpringCloud</code>ã€<code>Dubbo</code>ã€<code>kratos</code>ã€<code>go-zero</code>ä¹‹ç±»çš„å¾®æœåŠ¡æ¡†æ¶ä¹Ÿæœªå°ä¸å¯ã€‚</p><p>æˆ‘ä¹‹å‰æœ‰å†™è¿‡ä¸¤ç¯‡å…³äº Istio çš„ æ–‡ç« ï¼Œä¹Ÿå¯ä»¥ç”¨åšå‚è€ƒï¼š</p><ul><li><a href="https://crossoverjie.top/2023/10/16/ob/k8s-grpc-lb/">åœ¨ kubernetes ç¯å¢ƒä¸­å®ç° gRPC è´Ÿè½½å‡è¡¡</a></li><li><a href="https://crossoverjie.top/2023/10/31/ob/k8s-Istio01/">æœåŠ¡ç½‘æ ¼å®æˆ˜-å…¥é—¨Istio</a></li></ul><h1 id="å¯è§‚æµ‹æ€§"><a href="#å¯è§‚æµ‹æ€§" class="headerlink" title="å¯è§‚æµ‹æ€§"></a>å¯è§‚æµ‹æ€§</h1><p><img src="https://s2.loli.net/2024/03/06/wOtk3Fb5fhEIWpB.png"><br>ç°å¦‚ä»Šå¯è§‚æµ‹ç³»ç»Ÿä¹Ÿå˜å¾—è¶Šæ¥è¶Šé‡è¦ï¼Œä¸ªäººè§‰å¾—è¯„ä»·ä¸€ä¸ªæŠ€æœ¯å›¢é˜Ÿé‡è¦æŒ‡æ ‡å°±æ˜¯ä»–ä»¬çš„å¯è§‚æµ‹ç³»ç»Ÿåšçš„å¦‚ä½•ã€‚</p><p>ä¸€ä¸ªä¼˜ç§€çš„å¯è§‚æµ‹ç³»ç»Ÿå¯ä»¥æ¸…æ™°å¾—çŸ¥ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ã€é«˜æ•ˆçš„æ’æŸ¥é—®é¢˜ã€è¿˜æœ‰åŠæ—¶çš„æ•…éšœå‘Šè­¦ã€‚</p><p>è¦å®ç°ä¸Šè¿°æ ‡å‡†å°±éœ€è¦æˆ‘ä»¬å¯è§‚æµ‹ç³»ç»Ÿçš„ä¸‰ä¸ªæ ¸å¿ƒæŒ‡æ ‡äº†ï¼š</p><p><img src="https://s2.loli.net/2024/03/06/gXQIfcJO1qVWimH.png"></p><ul><li>Metricsï¼Œå€ŸåŠ©å®ƒæˆ‘ä»¬å¯ä»¥åœ¨ Grafana ä¸­ç»˜åˆ¶å‡ºå„ç§ç›´è§‚çš„é¢æ¿ï¼Œå¯ä»¥æ›´åŠ å…¨é¢çš„äº†è§£æˆ‘ä»¬ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€</li></ul><p><img src="https://s2.loli.net/2024/03/06/sWk2gXnTNxuafBF.png"></p><ul><li>Traceåˆ™æ˜¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ„å»ºå‡ºç³»ç»Ÿè°ƒç”¨çš„å…¨è²Œï¼Œé€šè¿‡ä¸€ä¸ª trace å°±å¯ä»¥çŸ¥é“ä¸€ä¸ªè¯·æ±‚ç»å†äº†å“ªäº›ç³»ç»Ÿï¼Œåœ¨å“ªä¸ªç¯èŠ‚å‡ºäº†é—®é¢˜ã€‚</li><li>Logs å°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œå°±æ˜¯æˆ‘ä»¬è‡ªå·±åœ¨åº”ç”¨é‡Œæ‰“å°çš„ä¸€äº›æ—¥å¿—ï¼›åªæ˜¯å’Œä»¥å¾€çš„å¼€å‘æ¨¡å¼ç•¥æœ‰ä¸åŒçš„æ˜¯ï¼šåœ¨äº‘åŸç”Ÿä½“ç³»ä¸­æ›´æ¨èç›´æ¥è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯æµä¸­ï¼Œä¸€äº›ç¬¬ä¸‰æ–¹é‡‡é›†ç»„ä»¶å¯ä»¥æ›´æ–¹ä¾¿çš„è¿›è¡Œé‡‡é›†ã€‚</li></ul><hr><p>æˆ‘ä»¬è‡ªå·±çš„å¯è§‚æµ‹ç³»ç»Ÿç»å†è¿‡ä¸€æ¬¡è¿­ä»£ï¼Œä»¥å¾€çš„æŠ€æœ¯æ ˆæ˜¯ï¼š</p><ul><li><code>Metrics</code> ä½¿ç”¨ <code>VictoriaMetrics</code>ï¼šè¿™æ˜¯ä¸€ä¸ªå®Œå…¨å…¼å®¹ <code>Prometheus</code> çš„æ—¶åºæ•°æ®åº“ï¼Œä½†ç›¸å¯¹ <code>Prometheus</code> æ¥è¯´æ›´åŠ çš„èŠ‚çœèµ„æºã€‚</li><li>Trace é€‰æ‹©çš„æ˜¯ <code>SkyWalking</code>ï¼Œè¿™ä¹Ÿæ˜¯ Java trace é¢†åŸŸæ¯”è¾ƒæµè¡Œçš„æŠ€æœ¯æ–¹æ¡ˆã€‚</li><li>Logsï¼šä½¿ç”¨ filebeat é‡‡é›†æ—¥å¿—ç„¶åè¾“å‡ºåˆ° ElasticSearch ä¸­ï¼Œè¿™ä¹Ÿæ˜¯æ¯”è¾ƒç»å…¸çš„æ–¹æ¡ˆã€‚</li></ul><p>å»å¹´åº•æˆ‘ä»¬åšäº†ä¸€æ¬¡æ¯”è¾ƒå¤§çš„æ”¹é€ ï¼Œä¸»è¦å°±æ˜¯å°† <code>SkyWalking</code> æ¢ä¸ºäº† <code>OpenTelemetry</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªæ›´åŠ å¼€æ”¾çš„ç¤¾åŒºï¼Œä¹Ÿé€æ¸æˆä¸ºäº‘åŸç”Ÿå¯è§‚æµ‹çš„æ ‡å‡†äº†ã€‚</p><p>ä½¿ç”¨å®ƒæˆ‘ä»¬çš„çµæ´»æ€§æ›´é«˜ï¼Œä¸ç”¨ä¸æŸäº›å…·ä½“çš„æŠ€æœ¯æ ˆè¿›è¡Œç»‘å®šï¼›ç›®å‰ logs è¿˜æ²¡æœ‰åˆ‡æ¢ï¼Œç¤¾åŒºä¹Ÿè¿˜åœ¨ beta æµ‹è¯•ä¸­ï¼Œåç»­æˆç†Ÿåä¹Ÿå¯ä»¥ç›´æ¥ç”¨ <code>OpenTelemetry</code> æ¥æ”¶é›†æ—¥å¿—ã€‚</p><p>æˆ‘ä¹Ÿå†™çš„æœ‰ä¸€ç¯‡ SW è¿ç§»åˆ° <code>OpenTelemetry</code> çš„æ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å‚è€ƒï¼š</p><ul><li><a href="https://juejin.cn/post/7341669201010262053">å®æˆ˜ï¼šå¦‚ä½•ä¼˜é›…çš„ä» SkyWalking åˆ‡æ¢åˆ° OpenTelemetry</a></li></ul><h1 id="æ¶ˆæ¯é˜Ÿåˆ—"><a href="#æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—"></a>æ¶ˆæ¯é˜Ÿåˆ—</h1><p>è¿™é‡Œå•ç‹¬æŠŠæ¶ˆæ¯é˜Ÿåˆ—æ‹å‡ºæ¥æ˜¯å› ä¸ºæˆ‘ç›®å‰ä¸»è¦æ˜¯åœ¨ç»´æŠ¤å…¬å¸å†…éƒ¨çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¸šåŠ¡ä½“é‡å¤§äº†ä¹‹åæ¶ˆæ¯é˜Ÿåˆ—å˜å¾—éå¸¸é‡è¦äº†ï¼Œé€šå¸¸ä¼šå……å½“å„ä¸ªä¸šåŠ¡çº¿å¯¹æ¥çš„æ¡¥æ¢ï¼Œæˆ–è€…æ˜¯æ•°æ®åº“åŒæ­¥ MySQL çš„æ¸ é“ï¼Œæ€»ä¹‹ç”¨å¤„éå¸¸å¹¿æ³›ã€‚</p><p><img src="https://s2.loli.net/2024/03/07/WBeYUK8AVlcrgGs.png"></p><p>è¿™é‡Œè¿˜æ˜¯æ¨èæ›´è´´åˆäº‘åŸç”Ÿçš„æ¶ˆæ¯é˜Ÿåˆ— Pulsarï¼Œç”±äºå®ƒå­˜ç®—åˆ†ç¦»çš„æ¶æ„ç‰¹æ€§ï¼Œé…åˆkubernetes çš„ç‰¹æ€§å¯ä»¥å®ç°å¿«é€Ÿçš„æ‰©ç¼©å®¹ï¼Œç›¸æ¯” kafka æ¥è¯´æ›´æ˜“ç»´æŠ¤ï¼›åŒæ—¶ç¤¾åŒºæ´»è·ƒåº¦ä¹Ÿéå¸¸é«˜ï¼Œåœ¨ Bug ä¿®å¤å’Œæ”¯æŒæ–°ç‰¹æ€§æ–¹é¢æ¯”è¾ƒç§¯æã€‚</p><p>Pulsarå®˜æ–¹æ”¯æŒçš„å®¢æˆ·ç«¯ä¹Ÿæ¯”è¾ƒå…¨é¢ï¼š</p><table><thead><tr><th>Language</th><th>Documentation</th><th>Release note</th><th>Code repo</th></tr></thead><tbody><tr><td>Java</td><td><a href="client-libraries-java.md">User doc</a>   <br/> <a href="/api/client/">API doc</a></td><td><a href="pathname:///release-notes/client-java">Standalone</a></td><td><a href="https://github.com/apache/pulsar/tree/master/pulsar-client">Bundled</a></td></tr><tr><td>C++</td><td><a href="client-libraries-cpp.md">User doc</a>    <br/> <a href="@pulsar:apidoc:cpp@">API doc</a></td><td><a href="pathname:///release-notes/client-cpp">Standalone</a></td><td><a href="https://github.com/apache/pulsar-client-cpp">Standalone</a></td></tr><tr><td>Python</td><td><a href="client-libraries-python.md">User doc</a> <br/> <a href="@pulsar:apidoc:python@">API doc</a></td><td><a href="pathname:///release-notes/client-python">Standalone</a></td><td><a href="https://github.com/apache/pulsar-client-python">Standalone</a></td></tr><tr><td>Go client</td><td><a href="client-libraries-go.md">User doc</a>   <br/> <a href="https://pkg.go.dev/github.com/apache/pulsar-client-go/pulsar">API doc</a></td><td><a href="pathname:///release-notes/client-go">Standalone</a></td><td><a href="https://github.com/apache/pulsar-client-go">Standalone</a></td></tr><tr><td>Node.js</td><td><a href="client-libraries-node.md">User doc</a>  <br/> <a href="@pulsar:apidoc:js@">API doc</a></td><td><a href="pathname:///release-notes/client-node">Standalone</a></td><td><a href="https://github.com/apache/pulsar-client-node">Standalone</a></td></tr><tr><td>C#&#x2F;DotPulsar</td><td><a href="client-libraries-dotnet.md">User doc</a></td><td><a href="pathname:///release-notes/client-cs">Standalone</a></td><td><a href="https://github.com/apache/pulsar-dotpulsar">Standalone</a></td></tr></tbody></table><p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå¦‚ä½•éƒ¨ç½²æˆ‘ä»¬çš„ Pulsar é›†ç¾¤ï¼Œæ˜¯ç§æœ‰åŒ–éƒ¨ç½²è¿˜æ˜¯è´­ä¹°äº‘æœåŠ¡ï¼ˆç›®å‰ Pulsarçš„å•†ä¸šå…¬å¸ streamnative å’Œå›½å†…çš„è…¾è®¯äº‘éƒ½æœ‰ç±»ä¼¼çš„æœåŠ¡ï¼‰</p><p>æˆ‘ä»¬ä¹‹å‰æœ‰å’¨è¯¢è¿‡ä»·æ ¼ï¼Œç›¸å¯¹æ¥è¯´è¿˜æ˜¯è‡ªå·±éƒ¨ç½²æ€§ä»·æ¯”æœ€é«˜ï¼›å’Œå‰æ–‡è®²çš„ä¸€æ ·ï¼Œåªä½¿ç”¨äº‘å‚å•†çš„ kubernetes æœåŠ¡ï¼Œåœ¨è¿™åŸºç¡€ä¸Šéƒ¨ç½²æˆ‘ä»¬çš„è‡ªå·±çš„æœåŠ¡ã€‚</p><p>å› ä¸ºå¾—ç›Šäº Pulsar ç¤¾åŒºçš„æ´»è·ƒï¼Œå³ä¾¿æ˜¯è‡ªå·±ç»´æŠ¤å‡ºç°é—®é¢˜ä¹Ÿå¯ä»¥åŠæ—¶å¾—åˆ°åé¦ˆï¼›åŒæ—¶è‡ªå·±å¹³æ—¶è¸©çš„å‘ä¹Ÿå¯ä»¥åå“ºç¤¾åŒºã€‚</p><p>ä¹‹å‰ä¹Ÿå†™è¿‡ä¸€äº›å…³äº Pulsar çš„ç³»åˆ—æ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥æŸ¥é˜…ï¼š</p><ul><li><a href="https://juejin.cn/post/7340195874867904547">åœ¨ kubernetes ç¯å¢ƒä¸‹å¦‚ä½•ä¼˜é›…æ‰©ç¼©å®¹ Pulsar</a></li><li><a href="https://crossoverjie.top/2024/01/03/ob/Pulsar3.0-new-feature/">Pulsar3.0æ–°åŠŸèƒ½ä»‹ç»</a></li><li><a href="https://crossoverjie.top/2023/02/07/pulsar/pulsar-load-banance/">Pulsarè´Ÿè½½å‡è¡¡åŸç†åŠä¼˜åŒ–</a></li><li><a href="https://crossoverjie.top/2024/01/15/ob/Bookkeeper-storage/">ç™½è¯ Pulsar Bookkeeper çš„å­˜å‚¨æ¨¡å‹</a></li><li><a href="https://crossoverjie.top/2023/01/16/pulsar/pulsar-perf-test/">Pulsarå‹æµ‹åŠä¼˜åŒ–</a></li></ul><h1 id="ä¸šåŠ¡æ¡†æ¶"><a href="#ä¸šåŠ¡æ¡†æ¶" class="headerlink" title="ä¸šåŠ¡æ¡†æ¶"></a>ä¸šåŠ¡æ¡†æ¶</h1><p>æœ€åæ˜¯ä¸šåŠ¡æ¡†æ¶çš„é€‰æ‹©ï¼Œå†³å®šè¿™ä¸ªçš„å‰ææ˜¯æˆ‘ä»¬å…ˆè¦ç¡®å®šé€‰æ‹©å“ªä¸ªè¯­è¨€ä½œä¸ºä¸»åŠ›ä¸šåŠ¡è¯­è¨€ã€‚</p><p>è™½ç„¶è¿™ç‚¹å¯¹äº kubernetes æ¥è¯´æ— å…³ç´§è¦ï¼Œä¸‹é¢ä»¥æˆ‘æ¯”è¾ƒç†Ÿæ‚‰çš„ Java å’Œ Golang è¿›è¡Œä»‹ç»ã€‚</p><h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><p>Java å¯é€‰çš„æŠ€æœ¯æ–¹æ¡ˆå°±æ¯”è¾ƒå¤šäº†ï¼Œå¦‚æœæˆ‘ä»¬åªæ˜¯ä¸Šäº† kubernetes ä½†æ²¡æœ‰ä½¿ç”¨æœåŠ¡ç½‘æ ¼ï¼›é‚£å®Œå…¨å¯ä»¥åªä½¿ç”¨ <code>springboot</code> å¼€å‘ http æ¥å£ï¼Œå°±å’Œå¼€å‘ä¸€ä¸ªå•ä½“åº”ç”¨ä¸€æ ·ç®€å•ã€‚</p><p>åªæ˜¯è¿™æ ·ä¼šç¼ºå°‘ä¸€äº›æœåŠ¡æ²»ç†çš„èƒ½åŠ›ï¼Œæ›´é€‚ç”¨äºä¸­å°å‹å›¢é˜Ÿã€‚</p><p>å¦‚æœå›¢é˜Ÿäººå‘˜è¾ƒå¤šï¼Œä¹Ÿæ²¡ä½¿ç”¨æœåŠ¡ç½‘æ ¼æ—¶ï¼›é‚£å°±æ¨èä½¿ç”¨å‰æ–‡ä»‹ç»çš„å¾®æœåŠ¡æ¡†æ¶ï¼šæ¯”å¦‚ Dubboã€SpringCloud ç­‰ã€‚</p><p>å½“æœ‰ä¸“é—¨çš„äº‘åŸç”Ÿå›¢é˜Ÿæ—¶ï¼Œåˆ™æ›´æ¨èä½¿ç”¨æœåŠ¡ç½‘æ ¼çš„æ–¹æ¡ˆï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½ç»¼åˆä»¥ä¸Šä¸¤ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼š</p><ul><li>ä»£ç ç®€æ´ï¼Œåªæ˜¯éœ€è¦å°† http æ¢ä¸º gRPCã€‚</li><li>åŒæ—¶åˆ©ç”¨ Istio ä¹ŸåŒ…å«äº†å¾®æœåŠ¡æ¡†æ¶çš„èƒ½åŠ›ã€‚</li></ul><h2 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h2><p>Golang å…¶å®ä¹Ÿä¸ Java ç±»ä¼¼ï¼Œä¸­å°å›¢é˜Ÿæ—¶æˆ‘ä»¬å®Œå…¨å¯ä»¥åªä½¿ç”¨ Gin è¿™ç±» http æ¡†æ¶è¿›è¡Œå¼€å‘ã€‚</p><p>è€Œä¸­å¤§å‹å›¢é˜Ÿåœ¨ <code>Golang</code> ç”Ÿæ€ä¸­ä¹Ÿæœ‰å¯¹æ ‡ <code>Dubbo</code> å’Œ <code>SpringCloud</code> çš„æ¡†æ¶ï¼Œæ¯”å¦‚ <a href="https://github.com/go-kratos/kratos">kratos</a>å’Œ <a href="https://github.com/zeromicro/go-zero">go-zero</a> ç­‰ã€‚</p><p>å¾—ç›Šäº Golang çš„ç®€æ´ç‰¹æ€§ï¼Œæˆ‘è§‰å¾—æ¯”ä½¿ç”¨ Java å¼€å‘ä¸šåŠ¡æ›´åŠ ç®€å•å’Œâ€œæ— è„‘â€ã€‚</p><p>åŒæ ·çš„åç»­ä¹Ÿå¯ä»¥åˆ‡æ¢åˆ°æœåŠ¡ç½‘æ ¼ï¼Œç›´æ¥é‡‡ç”¨ gRPC å’Œ Golang ä¹Ÿéå¸¸é€‚é…ï¼Œæ­¤æ—¶å›¢é˜Ÿåº”è¯¥ä¹Ÿæ¯”è¾ƒæˆç†Ÿäº†ï¼Œå®Œå…¨å¯ä»¥è‡ªå·±åŸºäº gRPC åšä¸€ä¸ªå¼€å‘è„šæ‰‹æ¶ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ Kratos æˆ–è€…æ˜¯ go-zero å»æ‰ä»–ä»¬çš„æœåŠ¡è°ƒç”¨æ¨¡å—å³å¯ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šå°±æ˜¯ä¸ªäººå¯¹ç›®å‰æµè¡Œçš„æŠ€æœ¯æ–¹æ¡ˆçš„ç†è§£ï¼Œä¹Ÿåˆ†åˆ«å¯¹ä¸åŒå›¢é˜Ÿè§„æ¨¡è¿›è¡Œäº†æ¨èï¼›ç¡®å®æ²¡æœ‰å®Œç¾çš„æŠ€æœ¯æ–¹æ¡ˆï¼Œåªæœ‰æœ€åˆé€‚çš„ï¼Œä¹Ÿä¸è¦è·Ÿé£é€‰æ‹©ä¸€äº›è‡ªå·±ä¸èƒ½æŠŠæ§çš„æŠ€æœ¯æ ˆï¼Œæœ€ç»ˆåƒäºçš„å¯èƒ½å°±æ˜¯è‡ªå·±ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://levelup.gitconnected.com/gitops-in-kubernetes-with-gitlab-ci-and-argocd-9e20b5d3b55b">https://levelup.gitconnected.com/gitops-in-kubernetes-with-gitlab-ci-and-argocd-9e20b5d3b55b</a></li><li><a href="https://grpc.io/">https://grpc.io/</a></li></ul><p>#Blog #CloudNative </p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;æ—¶é—´è¿‡å¾—å¾ˆå¿«å•Šï¼Œä¸€è½¬çœ¼å·²ç»åˆ°äº† 2024 å¹´ï¼Œè¿˜è®°å¾— 15 å¹´åˆšå·¥ä½œé‚£ä¼šæŒæ¡ä¸ª &lt;code&gt;SSM/H(Spring/Struts2/Mybatis/Hibernate)&lt;/code&gt; æ¡†æ¶å°±èƒ½åº”ä»˜å¤§éƒ¨åˆ†é¢è¯•äº†ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ç°åœ¨ CS ä¸“ä¸šçš„æ–°åŒå­¦ä¼°è®¡éƒ½æ²¡å¬è¯´è¿‡ SSMğŸ˜¢&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æ°å¥½ä»æˆ‘åˆšå¼€å§‹å·¥ä½œæ—¶çš„ç§»åŠ¨äº’è”ç½‘çƒ­æ½®åˆ°ç”µå•†-&amp;gt;å…±äº«ç»æµ-&amp;gt;toB å¤§çƒ­-&amp;gt;å¦‚ä»Šæˆ‘éƒ½ç»å†äº†ä¸€éï¼ŒæŠ€æœ¯æ ˆä¹Ÿæœ‰ç”±æœ€å¼€å§‹çš„å•ä½“åº”ç”¨+ç‰©ç†æœºå‘å±•åˆ°ç°åœ¨çš„ kubernetes äº‘åŸç”Ÿæ¶æ„ã€‚&lt;/p&gt;
&lt;p&gt;å½“ç„¶ä¸­é€”ä¹Ÿç»å†äº†å‡ ä¸ªå¤§çš„é˜¶æ®µï¼š&lt;br&gt;SOAæœåŠ¡åŒ–-&amp;gt; å¾®æœåŠ¡-&amp;gt; äº‘åŸç”Ÿ-&amp;gt; æœåŠ¡ç½‘æ ¼-&amp;gt; æ— æœåŠ¡ç­‰å‡ ä¸ªé˜¶æ®µã€‚&lt;/p&gt;
&lt;p&gt;æœ€è¿‘ä¸€ä»½å·¥ä½œåˆä¸»è¦æ˜¯åœ¨åšåŸºç¡€æ¶æ„ï¼Œæˆ‘è®¤ä¸ºäº†è§£çš„è¿˜ç®—æ˜¯æ¯”è¾ƒå…¨é¢çš„ï¼Œæ‰€ä»¥æœ¬æ–‡æˆ‘å°±ä»¥æˆ‘çš„è§†è§’åˆ†äº«ä¸‹æˆ‘ä»¬åœ¨ 2024 å¹´åº”å½“ä½¿ç”¨å“ªäº›äº‘åŸç”ŸæŠ€æœ¯æ ˆï¼Œå› ä¸ºæ¶‰åŠåˆ°çš„æŠ€æœ¯ç»„ä»¶æ¯”è¾ƒå¤šï¼Œå°±ä¸è¿‡å¤šè®¨è®ºç»†èŠ‚äº†ã€‚&lt;/p&gt;
&lt;p&gt;ä½†å¯ä»¥ä¿è¯çš„æ˜¯æåˆ°çš„æŠ€æœ¯æ ˆéƒ½æ˜¯æˆ‘æ‰€ç”¨è¿‡çš„ï¼Œä¼˜ç¼ºç‚¹éƒ½ä¼šæåˆ°ï¼Œä¸»æ‰“ä¸€ä¸ªçœŸå®ä½“éªŒã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="CloudNative" scheme="http://crossoverjie.top/tags/CloudNative/"/>
    
    <category term="k8s" scheme="http://crossoverjie.top/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>å®æˆ˜ï¼šå¦‚ä½•ä¼˜é›…çš„ä» Skywalking åˆ‡æ¢åˆ° OpenTelemetry</title>
    <link href="http://crossoverjie.top/2024/04/07/ob/otel-replace-sw/"/>
    <id>http://crossoverjie.top/2024/04/07/ob/otel-replace-sw/</id>
    <published>2024-04-07T09:16:21.000Z</published>
    <updated>2024-04-07T15:27:53.792Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2024/03/04/8YFIh7suTirZacj.png"></p><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æœ€è¿‘å…¬å¸å°†æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„é“¾è·¯å·¥å…·åˆ‡æ¢ä¸ºäº† <code>OpenTelemetry</code>.</p><p><img src="https://s2.loli.net/2024/03/03/9V1aUnpOd8EAG2Y.png"></p><span id="more"></span><p>æˆ‘ä»¬çš„æŠ€æœ¯æ ˆæ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">        OTLP                               </span><br><span class="line">Clientâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºCollectâ”€â”€â”€â”€â”€â”€â”€â”€â–ºStartRocks</span><br><span class="line">(Agent)                               â–²    </span><br><span class="line">                                      â”‚    </span><br><span class="line">                                      â”‚    </span><br><span class="line">                                   Jaeger                                       </span><br></pre></td></tr></table></figure><p>å…¶ä¸­å®¢æˆ·ç«¯ä½¿ç”¨ OpenTelemetry æä¾›çš„ Java Agent è¿›è¡ŒåŸ‹ç‚¹æ”¶é›†æ•°æ®ï¼Œå†ç”± Agent é€šè¿‡ OTLP(OpenTelemetry Protocol) åè®®å°†æ•°æ®å‘å¾€ Collectorï¼Œåœ¨ <code>Collector</code> ä¸­æˆ‘ä»¬å¯ä»¥è‡ªè¡Œä»»æ„å¤„ç†æ•°æ®ï¼Œå¹¶å†³å®šå°†è¿™äº›æ•°æ®å¦‚ä½•å­˜å‚¨ï¼ˆè¿™ç‚¹åœ¨ä»¥å¾€çš„ SkyWalking ä½“ç³»ä¸­æ˜¯å¾ˆéš¾è‡ªå®šä¹‰çš„ï¼‰</p><p>è¿™é‡Œæˆ‘ä»¬å°†æ•°æ®å†™å…¥ StartRocks ä¸­ï¼Œä¾›ä¹‹åçš„ UI å±‚è¿›è¡ŒæŸ¥çœ‹ã€‚</p><blockquote><p><code>OpenTelemetry</code> æ˜¯å¯è§‚æµ‹ç³»ç»Ÿçš„æ–°æ ‡å‡†ï¼ŒåŸºäºå®ƒå¯ä»¥å…¼å®¹ä»¥å‰ä½¿ç”¨çš„ Prometheusã€ victoriametricsã€skywalking ç­‰ç³»ç»Ÿï¼ŒåŒæ—¶è¿˜å¯ä»¥çµæ´»æ‰©å±•ï¼Œä¸ç”¨ä¸ä»»ä½•ä½†ä¸€ç”Ÿæ€æˆ–æŠ€æœ¯æ ˆè¿›è¡Œç»‘å®šã€‚<br>æ›´å¤šå…³äº OTel çš„å†…å®¹ä¼šåœ¨ä»Šåä»‹ç»ã€‚</p></blockquote><h2 id="éš¾ç‚¹"><a href="#éš¾ç‚¹" class="headerlink" title="éš¾ç‚¹"></a>éš¾ç‚¹</h2><p>å…¶ä¸­æœ‰ä¸€ä¸ªå…³é”®é—®é¢˜å°±æ˜¯ï¼šå¦‚ä½•åœ¨çº¿ä¸Šè¿›è¡Œ<strong>æ— ç¼åˆ‡æ¢</strong>ã€‚</p><p>è™½ç„¶æˆ‘ä»¬å†…éƒ¨çš„å‘å¸ƒç³»ç»Ÿå·²ç»æ”¯æŒé‡æ–°å‘å¸ƒåå°±ä¼šåˆ‡æ¢åˆ°æ–°çš„é“¾è·¯ï¼Œä¹Ÿå¯ä»¥è®©ä¸šåŠ¡è‡ªè¡Œå‘å¸ƒç„¶åé€æ­¥çš„åˆ‡æ¢åˆ°æ–°çš„ç³»ç»Ÿï¼Œè¿™æ ·ä¹Ÿæ˜¯æœ€ä¿é™©çš„æ–¹å¼ã€‚</p><p>ä½†è¿™æ ·ä¼šæœ‰å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>å½“å­˜åœ¨è°ƒç”¨ä¾èµ–çš„ç³»ç»Ÿæ²¡æœ‰å…¨éƒ¨åˆ‡æ¢ä¸ºæ–°é“¾è·¯æ—¶ï¼Œå†æŸ¥è¯¢çš„æ—¶å€™å°±ä¼šå‡ºç°æ–­å±‚ï¼Œæ•´ä¸ªé“¾è·¯æ— æ³•å…¨éƒ¨ä¸²è”èµ·æ¥ã€‚</li><li>ä¸šåŠ¡å›¢é˜Ÿæ²¡æœ‰è¶³å¤Ÿçš„åŠ¨åŠ›å»æ¨åŠ¨å‘å¸ƒï¼Œå¯èƒ½åˆ‡æ¢çš„å‘¨æœŸè¾ƒé•¿ã€‚</li></ul><p>æ‰€ä»¥æœ€å¥½çš„æ–¹å¼è¿˜æ˜¯ç”±æˆ‘ä»¬åœ¨åå°ç»Ÿä¸€å‘å¸ƒï¼Œå¯¹å¤–æ²¡æœ‰ä»»ä½•æ„ŸçŸ¥å°±å¯ä»¥ä¸€é”®å…¨éƒ¨åˆ‡æ¢ä¸º OpenTelemetryã€‚</p><p>ä»”ç»†ä¸€çœ‹è²Œä¼¼ä¹Ÿæ²¡ä»€ä¹ˆéš¾çš„ï¼Œæ— éå°±æ˜¯æ¨¡æ‹Ÿç”¨æˆ·ç‚¹å‡»å‘å¸ƒæŒ‰é’®è€Œå·²ã€‚</p><p>ä½†è¿™äº‹ç”±æˆ‘ä»¬è‡ªåŠ¨æ¥åšå°±ä¸ä¸€æ ·äº†ï¼Œç”¨æˆ·ç‚¹å‡»å‘å¸ƒçš„æ—¶å€™ä¼šé€‰æ‹©ä»–ä»¬è®¤ä¸ºå¯ä»¥å‘å¸ƒçš„åˆ†æ”¯è¿›è¡Œå‘å¸ƒï¼Œæˆ‘ä»¬ä¸èƒ½è‡ªä½œä¸»å¼ çš„æ¯”å¦‚é€‰æ‹© main åˆ†æ”¯ï¼Œæœ‰å¯èƒ½åªæ˜¯åˆå¹¶äº†ä½†è¿˜ä¸å…·å¤‡å‘å¸ƒæ¡ä»¶ã€‚</p><p>æ‰€ä»¥ä¿é™©çš„æ–¹å¼è¿˜æ˜¯å¾—ç”¨å½“å‰é¡¹ç›®ä¸Šä¸€æ¬¡å‘å¸ƒæ—¶æ‰€ä½¿ç”¨çš„ git hash å€¼é‡æ–°æ‰“åŒ…å‘å¸ƒã€‚</p><p>ä½†è¿™ä¹Ÿæœ‰å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>é‡å¤æ‰“åŒ…å‘å¸ƒå¤ªæ…¢äº†ï¼Œçº¿ä¸Šå‡ åä¸Šç™¾ä¸ªé¡¹ç›®ï¼Œæ¯æ‰“åŒ…å‘å¸ƒä¸€æ¬¡å°±å¾—å‡ åˆ†é’Ÿï¼Œè™½ç„¶å¯ä»¥å¹¶å‘ï¼Œä½†è€ƒè™‘åˆ° kubernetes çš„å‹åŠ›ä¹Ÿä¸èƒ½è°ƒçš„å¤ªé«˜ã€‚</li><li>ä¿ä¸å‡†ä¸šåŠ¡é•œåƒä¸­æœ‰å•ç‹¬åŠ å…¥ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œè¿™æ ·æ‰“åŒ…å¯èƒ½ä¼šæ¼ã€‚</li></ul><h1 id="åˆ‡æ¢æ–¹æ¡ˆ"><a href="#åˆ‡æ¢æ–¹æ¡ˆ" class="headerlink" title="åˆ‡æ¢æ–¹æ¡ˆ"></a>åˆ‡æ¢æ–¹æ¡ˆ</h1><p>æ‰€ä»¥æ€æ¥æƒ³å»æœ€ä¿é™©çš„æ–¹æ³•è¿˜æ˜¯å°†ä¸šåŠ¡é•œåƒæ‹‰å–ä¸‹æ¥ï¼Œç„¶åæ‰‹åŠ¨åˆ é™¤é•œåƒä¸­çš„ skywalking åŒ…ä»¥åŠ JVM å‚æ•°ï¼Œå…¨éƒ¨æ›¿æ¢ä¸º OpenTelemetry çš„åŒ…å’Œ JVM å‚æ•°ã€‚</p><p>æ•´ä½“çš„æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ol><li>éå† namespace çš„ <code>pod ï¼0</code> çš„ deployment</li><li>éå† deployment ä¸­çš„æ‰€æœ‰ containerï¼Œè·å¾—ä¸šåŠ¡é•œåƒ<ol><li>è·³è¿‡ istio å’Œæ—¥å¿—é‡‡é›† containerï¼Œè·å–åˆ°ä¸šåŠ¡å®¹å™¨</li><li>åˆ¤æ–­è¯¥å®¹å™¨æ˜¯å¦éœ€è¦æ›¿æ¢ï¼Œå…¶å®å°±æ˜¯åˆ¤æ–­ç¯å¢ƒå˜é‡ä¸­æ˜¯å¦æœ‰ skywalking ï¼Œå¦‚æœæœ‰å°±éœ€è¦æ›¿æ¢ã€‚</li><li>è·å–ä¸šåŠ¡å®¹å™¨çš„é•œåƒ</li></ol></li><li>åŸºäºè¯¥ Image é‡æ–°æ„å»ºä¸€ä¸ª OpenTelemetry çš„é•œåƒ<br>   3.1 æ–°çš„é•œåƒåŒ…å«æ–°çš„å¯åŠ¨è„šæœ¬.<br>   3.1.1 æ–°çš„å¯åŠ¨è„šæœ¬ä¸­ä¼šåˆ é™¤åŸæœ‰çš„ skywalking agent<br>   3.2 æ–°é•œåƒä¼šåŒ…å« OpenTelemetry çš„ jar åŒ…ä»¥åŠæˆ‘ä»¬è‡ªå®šä¹‰çš„ OTel æ‰©å±•åŒ…<br>   3.3 æ›¿æ¢å¯åŠ¨å‘½ä»¤ä¸ºæ–°çš„å¯åŠ¨è„šæœ¬</li><li>ä¿®æ”¹ deployment ä¸­çš„ JVM å¯åŠ¨å‚æ•°</li><li>ä¿®æ”¹ deployment çš„é•œåƒåæ»šåŠ¨æ›´æ–°</li><li>å¼€å¯ä¸€ä¸ª goroutine å®šæ—¶æ£€æµ‹æ›´æ–°ä¹‹åæ˜¯å¦å¯åŠ¨æˆåŠŸ<ol><li>å¦‚æœé•¿æ—¶é—´ (æ¯”å¦‚äº”åˆ†é’Ÿ) éƒ½æ²¡æœ‰å¯åŠ¨æˆåŠŸï¼Œåˆ™æ‰§è¡Œå›æ»šæµç¨‹</li></ol></li></ol><h1 id="å…·ä½“ä»£ç "><a href="#å…·ä½“ä»£ç " class="headerlink" title="å…·ä½“ä»£ç "></a>å…·ä½“ä»£ç </h1><p>å› ä¸ºéœ€è¦æ¶‰åŠåˆ°æ“ä½œ kubernetesï¼Œæ‰€ä»¥æ•´ä½“å°±ä½¿ç”¨ Golang å®ç°äº†ã€‚</p><h2 id="éå†-deployment-å¾—åˆ°éœ€è¦æ›¿æ¢çš„å®¹å™¨é•œåƒ"><a href="#éå†-deployment-å¾—åˆ°éœ€è¦æ›¿æ¢çš„å®¹å™¨é•œåƒ" class="headerlink" title="éå† deployment å¾—åˆ°éœ€è¦æ›¿æ¢çš„å®¹å™¨é•œåƒ"></a>éå† deployment å¾—åˆ°éœ€è¦æ›¿æ¢çš„å®¹å™¨é•œåƒ</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ProcessDeployment</span><span class="params">(ctx context.Context, finish []<span class="type">string</span>, deployment v1.Deployment, clientSet kubernetes.Interface)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">deploymentName := deployment.Name</span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> finish &#123;</span><br><span class="line"><span class="keyword">if</span> s == deploymentName &#123;</span><br><span class="line">klog.Infof(<span class="string">&quot;Skip finish deployment:%s&quot;</span>, deploymentName)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Write finish deployment name to a file</span></span><br><span class="line"><span class="keyword">defer</span> writeDeploymentName2File(deploymentName, fmt.Sprintf(<span class="string">&quot;finish-%s.log&quot;</span>, deployment.Namespace))</span><br><span class="line"></span><br><span class="line">appName := deployment.GetObjectMeta().GetLabels()[<span class="string">&quot;appName&quot;</span>]</span><br><span class="line">klog.Infof(<span class="string">&quot;Begin to process deployment:%s, appName:%s&quot;</span>, deploymentName, appName)</span><br><span class="line"></span><br><span class="line">upgrade, err := checkContainIstio(ctx, deployment, clientSet)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> upgrade == <span class="literal">false</span> &#123;</span><br><span class="line">klog.Infof(<span class="string">&quot;Don&#x27;t have istio, No need to upgrade deployment:%s appName:%s&quot;</span>, deploymentName, appName)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, container := <span class="keyword">range</span> deployment.Spec.Template.Spec.Containers &#123;</span><br><span class="line"><span class="keyword">if</span> strings.HasPrefix(deploymentName, container.Name) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if container has sw jvm</span></span><br><span class="line"><span class="keyword">for</span> _, envVar := <span class="keyword">range</span> container.Env &#123;</span><br><span class="line"><span class="keyword">if</span> envVar.Name == <span class="string">&quot;CATALINA_OPTS&quot;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> !strings.Contains(envVar.Value, <span class="string">&quot;skywalking&quot;</span>) &#123;</span><br><span class="line">klog.Infof(<span class="string">&quot;Skip upgrade don&#x27;t have sw jvm deployment:%s container:%s&quot;</span>, deploymentName, container.Name)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">upgrade(container)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check newDeployment status</span></span><br><span class="line"><span class="keyword">go</span> checkNewDeploymentStatus(ctx, clientSet, newDeployment)</span><br><span class="line"></span><br><span class="line"><span class="comment">// delete from image</span></span><br><span class="line">deleteImage(container.Image)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°éœ€è¦ä¼ å…¥ä¸€ä¸ª deployment ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªå·²ç»å®Œæˆäº†çš„åˆ—è¡¨è¿›æ¥ã€‚</p><blockquote><p>å·²å®Œæˆåˆ—è¡¨ç”¨äºå¤šæ¬¡è¿è¡Œçš„æ—¶å€™å¯ä»¥å¿«é€Ÿè·³è¿‡å·²ç»æ‰§è¡Œçš„ deploymentã€‚</p></blockquote><p><code>checkContainIstio()</code> å‡½æ•°å¾ˆç®€å•ï¼Œåˆ¤æ–­æ˜¯å¦åŒ…å«äº† Istio å®¹å™¨ï¼Œå¦‚æœæ²¡æœ‰åŒ…å«è¯´æ˜ä¸æ˜¯åç«¯åº”ç”¨ï¼ˆå¯èƒ½æ˜¯å‰ç«¯ã€å¤§æ•°æ®ä¹‹ç±»çš„ä»»åŠ¡ï¼‰ï¼Œå°±å¯ä»¥ç›´æ¥è·³è¿‡äº†ã€‚</p><hr><p><img src="https://s2.loli.net/2024/03/03/xzHPV9mgCJkZ4cY.png"><br>è€Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ›¿æ¢çš„å‰æè¿™äº‹åˆ¤æ–­ç¯å¢ƒå˜é‡ <code>CATALINA_OPTS</code> ä¸­æ˜¯å¦åŒ…å«äº† skywalking çš„å†…å®¹ï¼Œå¦‚æœåŒ…å«åˆ™è¯´æ˜éœ€è¦è¿›è¡Œæ›¿æ¢ã€‚</p><h2 id="Upgrade-æ ¸å¿ƒå‡½æ•°"><a href="#Upgrade-æ ¸å¿ƒå‡½æ•°" class="headerlink" title="Upgrade æ ¸å¿ƒå‡½æ•°"></a>Upgrade æ ¸å¿ƒå‡½æ•°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">upgrade</span><span class="params">(container Container)</span></span>&#123;</span><br><span class="line">klog.Infof(<span class="string">&quot;Begin to upgrade deployment:%s container:%s&quot;</span>, deploymentName, container.Name)</span><br><span class="line">newImageName := fmt.Sprintf(<span class="string">&quot;%s-otel-%s&quot;</span>, container.Image, generateRandomString(<span class="number">4</span>))</span><br><span class="line">err := BuildNewOtelImage(container.Image, newImageName)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Update deployment jvm ENV</span></span><br><span class="line"><span class="keyword">for</span> e, envVar := <span class="keyword">range</span> container.Env &#123;</span><br><span class="line"><span class="keyword">if</span> envVar.Name == <span class="string">&quot;CATALINA_OPTS&quot;</span> &#123;</span><br><span class="line">otelJVM := replaceSWAgent2OTel(envVar.Value, appName)</span><br><span class="line">deployment.Spec.Template.Spec.Containers[i].Env[e].Value = otelJVM</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Update deployment image</span></span><br><span class="line">deployment.Spec.Template.Spec.Containers[i].Image = newImageName</span><br><span class="line"></span><br><span class="line">newDeployment, err := clientSet.AppsV1().Deployments(deployment.Namespace).Update(ctx, &amp;deployment, metav1.UpdateOptions&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">klog.Infof(<span class="string">&quot;Finish upgrade deployment:%s container:%s&quot;</span>, deploymentName, container.Name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸€å…±åˆ†ä¸ºä»¥ä¸‹å‡ éƒ¨ï¼š</p><ul><li>åŸºäºè€é•œåƒæ„å»ºæ–°é•œåƒ</li><li>æ›´æ–°åŸæœ‰çš„ <code>CATALINA_OPTS</code> ç¯å¢ƒå˜é‡ï¼Œä¹Ÿå°±æ˜¯æ›¿æ¢ skywalking çš„å‚æ•°</li><li>æ›´æ–° deployment é•œåƒï¼Œè§¦å‘æ»šåŠ¨æ›´æ–°</li></ul><h2 id="æ„å»ºæ–°é•œåƒ"><a href="#æ„å»ºæ–°é•œåƒ" class="headerlink" title="æ„å»ºæ–°é•œåƒ"></a>æ„å»ºæ–°é•œåƒ</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">dockerfile = fmt.Sprintf(<span class="string">`FROM %s</span></span><br><span class="line"><span class="string">COPY %s /home/admin/%s</span></span><br><span class="line"><span class="string">COPY otel.tar.gz /home/admin/otel.tar.gz</span></span><br><span class="line"><span class="string">RUN tar -zxvf /home/admin/otel.tar.gz -C /home/admin</span></span><br><span class="line"><span class="string">RUN rm -rf /home/admin/skywalking-agent</span></span><br><span class="line"><span class="string">ENTRYPOINT [&quot;/bin/sh&quot;, &quot;/home/admin/start.sh&quot;]</span></span><br><span class="line"><span class="string">`</span>, fromImage, script, script)</span><br><span class="line"></span><br><span class="line">idx := strings.LastIndex(newImageName, <span class="string">&quot;/&quot;</span>) + <span class="number">1</span></span><br><span class="line">dockerFileName := newImageName[idx:]</span><br><span class="line">create, err := os.Create(fmt.Sprintf(<span class="string">&quot;Dockerfile-%s&quot;</span>, dockerFileName))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">create.Close()</span><br><span class="line">os.Remove(create.Name())</span><br><span class="line">&#125;()</span><br><span class="line">_, err = create.WriteString(dockerfile)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cmd := exec.Command(<span class="string">&quot;docker&quot;</span>, <span class="string">&quot;build&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;-f&quot;</span>, create.Name(), <span class="string">&quot;-t&quot;</span>, newImageName)</span><br><span class="line">cmd.Stdin = strings.NewReader(dockerfile)</span><br><span class="line"><span class="keyword">if</span> err := cmd.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®è¿™é‡Œçš„é‡ç‚¹å°±æ˜¯æ„å»ºè¿™ä¸ªæ–°é•œåƒï¼Œä»è¿™ä¸ª dockerfile ä¸­ä¹Ÿèƒ½çœ‹å‡ºå…·ä½“çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„åˆ é™¤åŸæœ‰çš„ skywalking èµ„æºåŒæ—¶å°†æ–°çš„ OpenTelemetry èµ„æºæ‰“åŒ…è¿›å»ã€‚</p><p>æœ€åå†å°†è¿™ä¸ªé•œåƒä¸Šä¼ åˆ°ç§æœã€‚</p><p><img src="https://s2.loli.net/2024/03/03/s7fryhQSPJgcuvj.png"><br>å…¶ä¸­çš„æ›¿æ¢ JVM å‚æ•°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œç›´æ¥åˆ é™¤ skywalking çš„å†…å®¹ï¼Œç„¶åå†è¿½åŠ ä¸Š OpenTelemetry éœ€è¦çš„å‚æ•°å³å¯ã€‚</p><h2 id="å®šæ—¶æ£€æµ‹æ›¿æ¢æ˜¯å¦æˆåŠŸ"><a href="#å®šæ—¶æ£€æµ‹æ›¿æ¢æ˜¯å¦æˆåŠŸ" class="headerlink" title="å®šæ—¶æ£€æµ‹æ›¿æ¢æ˜¯å¦æˆåŠŸ"></a>å®šæ—¶æ£€æµ‹æ›¿æ¢æ˜¯å¦æˆåŠŸ</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkNewDeploymentStatus</span><span class="params">(ctx context.Context, clientSet kubernetes.Interface, newDeployment *v1.Deployment)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">ready := <span class="literal">true</span></span><br><span class="line">tick := time.Tick(<span class="number">10</span> * time.Second)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">30</span>; i++ &#123;</span><br><span class="line">&lt;-tick</span><br><span class="line">originPodList, err := clientSet.CoreV1().Pods(newDeployment.Namespace).List(ctx, metav1.ListOptions&#123;</span><br><span class="line">LabelSelector: metav1.FormatLabelSelector(&amp;metav1.LabelSelector&#123;</span><br><span class="line">MatchLabels: newDeployment.Spec.Selector.MatchLabels,</span><br><span class="line">&#125;),</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if there are any Pods</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(originPodList.Items) == <span class="number">0</span> &#123;</span><br><span class="line">klog.Infof(<span class="string">&quot;No Pod in deployment:%s, Skip&quot;</span>, newDeployment.Name)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> originPodList.Items &#123;</span><br><span class="line"><span class="comment">// Check Pod running</span></span><br><span class="line"><span class="keyword">for</span> _, status := <span class="keyword">range</span> item.Status.ContainerStatuses &#123;</span><br><span class="line"><span class="keyword">if</span> status.RestartCount &gt; <span class="number">0</span> &#123;</span><br><span class="line">ready = <span class="literal">false</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">klog.Infof(<span class="string">&quot;Check deployment:%s namespace:%s status:%t&quot;</span>, newDeployment.Name, newDeployment.Namespace, ready)</span><br><span class="line"><span class="keyword">if</span> ready == <span class="literal">false</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ready == <span class="literal">false</span> &#123;</span><br><span class="line"><span class="comment">// rollback</span></span><br><span class="line">klog.Infof(<span class="string">&quot;=======Rollback deployment:%s namespace:%s&quot;</span>, newDeployment.Name, newDeployment.Namespace)</span><br><span class="line">writeDeploymentName2File(newDeployment.Name, fmt.Sprintf(<span class="string">&quot;rollback-%s.log&quot;</span>, newDeployment.Namespace))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šå¯åŠ¨ä¸€ä¸ª 10s æ‰§è¡Œä¸€æ¬¡çš„å®šæ—¶ä»»åŠ¡ï¼Œæ¯æ¬¡éƒ½ä¼šæ£€æµ‹æ˜¯å¦æœ‰å®¹å™¨å‘ç”Ÿäº†é‡å¯ï¼ˆæ­£å¸¸æƒ…å†µä¸‹æ˜¯ä¸ä¼šå‡ºç°é‡å¯çš„ï¼‰</p><p>å¦‚æœæ£€æµ‹äº† 30 æ¬¡éƒ½æ²¡æœ‰é‡å¯çš„å®¹å™¨ï¼Œé‚£å°±è¯´æ˜æœ¬æ¬¡æ›¿æ¢æˆåŠŸäº†ï¼Œä¸ç„¶å°±è®°å½•ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œç„¶åäººå·¥å¤„ç†ã€‚</p><blockquote><p>è¿™ç§é€šå¸¸æ˜¯åŸæœ‰çš„é•œåƒä¸ OpenTelemetry ä¸å…¼å®¹ï¼Œæ¯”å¦‚é‡Œé¢å†™æ­»äº†ä¸€äº› skywalking çš„ APIï¼Œå¯¼è‡´å¯åŠ¨å¤±è´¥ã€‚</p></blockquote><p>æ‰€ä»¥æ›¿æ¢ä»»åŠ¡è·‘å®Œä¹‹åæˆ‘è¿˜ä¼šæ£€æµ‹è¿™ä¸ª <code>rollback-$namespace</code> çš„æ—¥å¿—æ–‡ä»¶ï¼Œäººå·¥å¤„ç†è¿™äº›å¤±è´¥çš„åº”ç”¨ã€‚</p><h2 id="åˆ†æ‰¹å¤„ç†-deployment"><a href="#åˆ†æ‰¹å¤„ç†-deployment" class="headerlink" title="åˆ†æ‰¹å¤„ç† deployment"></a>åˆ†æ‰¹å¤„ç† deployment</h2><p>æœ€åè®²è®²å¦‚ä½•å•ä¸ªè°ƒç”¨åˆšæ‰çš„ <code>ProcessDeployment()</code> å‡½æ•°ã€‚</p><p>è€ƒè™‘åˆ°ä¸èƒ½å¯¹ kubernetes äº§ç”Ÿå½±å“ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é™åˆ¶å¹¶å‘å¤„ç† deployment çš„æ•°é‡ï¼ˆæˆ‘è¿™é‡Œçš„é™åˆ¶æ˜¯ 10 ä¸ªï¼‰ã€‚</p><p>æ‰€ä»¥å°±å¾—åˆ†æ‰¹è¿›è¡Œæ›¿æ¢ï¼Œæ¯æ¬¡æ›¿æ¢ 10 ä¸ªï¼Œè€Œä¸”å…¶ä¸­æœ‰ä¸€ä¸ªæ‰§è¡Œå¤±è´¥å°±å¾—æš‚åœåç»­ä»»åŠ¡ï¼Œç”±äººå·¥æ£€æµ‹å¤±è´¥åŸå› å†å†³å®šæ˜¯å¦ç»§ç»­å¤„ç†ã€‚</p><blockquote><p>æ¯•ç«Ÿå¤„ç†çš„æ˜¯çº¿ä¸Šåº”ç”¨ï¼Œéœ€è¦å°å¿ƒè°¨æ…ã€‚</p></blockquote><p>æ‰€ä»¥è§¦å‘çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ProcessDeploymentList</span><span class="params">(ctx context.Context, data []v1.Deployment, clientSet kubernetes.Interface)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">file, err := os.ReadFile(fmt.Sprintf(<span class="string">&quot;finish-%s.log&quot;</span>, data[<span class="number">0</span>].Namespace))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">split := strings.Split(<span class="type">string</span>(file), <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">batchSize := <span class="number">10</span></span><br><span class="line">start := <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> start &lt; <span class="built_in">len</span>(data) &#123;</span><br><span class="line"></span><br><span class="line">end := start + batchSize</span><br><span class="line"><span class="keyword">if</span> end &gt; <span class="built_in">len</span>(data) &#123;</span><br><span class="line">end = <span class="built_in">len</span>(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">batch := data[start:end]</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç­‰å¾…goroutineç»“æŸ</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">klog.Infof(<span class="string">&quot;Start process batch size %d&quot;</span>, <span class="built_in">len</span>(batch))</span><br><span class="line"></span><br><span class="line">errs := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">error</span>, <span class="built_in">len</span>(batch))</span><br><span class="line"></span><br><span class="line">wg.Add(<span class="built_in">len</span>(batch))</span><br><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> batch &#123;</span><br><span class="line">d := item</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">if</span> err := ProcessDeployment(ctx, split, d, clientSet); err != <span class="literal">nil</span> &#123;</span><br><span class="line">klog.Errorf(<span class="string">&quot;!!!Process deployment name:%s error: %v&quot;</span>, d.Name, err)</span><br><span class="line">errs &lt;- err</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">wg.Wait()</span><br><span class="line"><span class="built_in">close</span>(errs)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»»ä½•ä¸€ä¸ªå¤±è´¥å°±è¿”å›</span></span><br><span class="line"><span class="keyword">for</span> err := <span class="keyword">range</span> errs &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start = end</span><br><span class="line">klog.Infof(<span class="string">&quot;Deal next batch&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>WaitGroup</code> æ¥æ§åˆ¶ä¸€ç»„ä»»åŠ¡ï¼Œä½¿ç”¨ä¸€ä¸ª chan æ¥ä¼ é€’å¼‚å¸¸ï¼›è¿™ç±»åˆ†æ‰¹å¤„ç†çš„ä»£ç åœ¨ä¸€äº›æ‰¹å¤„ç†æ¡†æ¶ä¸­è¿˜è›®å¸¸è§çš„ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ€ååªéœ€è¦æŸ¥è¯¢æŸä¸ª namespace ä¸‹çš„æ‰€æœ‰ deployment åˆ—è¡¨ä¼ å…¥è¿™ä¸ªæ‰¹å¤„ç†å‡½æ•°å³å¯ã€‚</p><p>ä¸è¿‡æ•´ä¸ªè¿‡ç¨‹ä¸­è¿˜æ˜¯æœ‰å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ï¼š</p><ul><li>å› ä¸ºéœ€è¦æ›¿æ¢é•œåƒçš„å‰ææ˜¯è¦æŠŠç°æœ‰çš„é•œåƒæ‹‰å–åˆ°æœ¬åœ°ï¼Œæ‰€ä»¥è·‘è¿™ä¸ªä»»åŠ¡çš„å®¢æˆ·ç«¯éœ€è¦æœ‰å……è¶³çš„ç£ç›˜ï¼ŒåŒæ—¶å’Œé•œåƒæœåŠ¡å™¨çš„ç½‘ç»œæ¡ä»¶è¾ƒå¥½ã€‚</li><li>ä¸ç„¶æ‰§è¡Œçš„è¿‡ç¨‹ä¼šæ¯”è¾ƒæ…¢ï¼ŒåŒæ—¶ç£ç›˜å ç”¨æ»¡äº†ä¹Ÿä¼šå½±å“ä»»åŠ¡ã€‚</li></ul><p>å…¶å®è¿™ä¸ªåŠŸèƒ½ä¾ç„¶æœ‰æå‡ç©ºé—´ï¼Œè€ƒè™‘åˆ°åç»­ä¼šå‡çº§ OpenTelemetry  agent çš„ç‰ˆæœ¬ï¼Œç”šè‡³ä¹Ÿéœ€è¦å¢å‡ä¸€äº› JVM å‚æ•°ã€‚</p><p>æ‰€ä»¥æœ€åæœ‰ä¸€ä¸ªç»Ÿä¸€çš„å·¥å…·ï¼Œå¯ä»¥ç›´æ¥å‡çº§ Agentï¼Œè€Œä¸æ˜¯æ¯æ¬¡æˆ‘éƒ½éœ€è¦ä¿®æ”¹è¿™é‡Œçš„ä»£ç ã€‚</p><p><img src="https://s2.loli.net/2024/03/03/lLIqQtmD2AdfGyv.png"></p><p>åæ¥åœ¨ç½‘ä¸Šçœ‹åˆ°äº†å¾—ç‰©çš„ç›¸å…³åˆ†äº«ï¼Œä»–ä»¬å¯ä»¥è¿œç¨‹åŠ è½½é…ç½®æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>è¿™ä¹Ÿæ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œç›´åˆ°æˆ‘ä»¬çœ‹åˆ°äº† OpenTelemetry ç¤¾åŒºæä¾›äº† <a href="https://github.com/open-telemetry/opentelemetry-operator/#opentelemetry-auto-instrumentation-injection">Operator</a>ï¼Œå…¶ä¸­ä¹ŸåŒ…å«äº†æ³¨å…¥ agent çš„åŠŸèƒ½ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Instrumentation</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-instrumentation</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">exporter:</span>  </span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">http://otel-collector:4317</span>  </span><br><span class="line">  <span class="attr">propagators:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="string">tracecontext</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="string">baggage</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="string">b3</span>  </span><br><span class="line">  <span class="attr">sampler:</span>  </span><br><span class="line">    <span class="attr">type:</span> <span class="string">parentbased_traceidratio</span>  </span><br><span class="line">    <span class="attr">argument:</span> <span class="string">&quot;0.25&quot;</span>  </span><br><span class="line">  <span class="attr">java:</span>  </span><br><span class="line">    <span class="attr">image:</span> <span class="string">private/autoinstrumentation-java:1.32.0-1</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»–æä¾›çš„ CRD æ¥é…ç½®æˆ‘ä»¬ agentï¼Œåªè¦ç»´æŠ¤å¥½è‡ªå·±çš„é•œåƒå°±å¥½äº†ã€‚</p><p>ä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦å®‰è£…å¥½äº† OpenTelemetry-operator ï¼Œç„¶åå†éœ€è¦æ³¨å…¥ Java Agent çš„ Pod ä¸­ä½¿ç”¨æ³¨è§£ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">instrumentation.opentelemetry.io/inject-java:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure><p> operator å°±ä¼šè‡ªåŠ¨ä»åˆšæ‰æˆ‘ä»¬é…ç½®çš„é•œåƒä¸­è¯»å– agentï¼Œç„¶åå¤åˆ¶åˆ°æˆ‘ä»¬çš„ä¸šåŠ¡å®¹å™¨ã€‚</p><p>å†é…ç½®ä¸Šç¯å¢ƒå˜é‡ <code>$JAVA_TOOL_OPTIONS=/otel/javaagent.java</code>, è¿™æ˜¯ä¸€ä¸ª Java å†…ç½®çš„ç¯å¢ƒå˜é‡ï¼Œåº”ç”¨å¯åŠ¨çš„æ—¶å€™ä¼šè‡ªåŠ¨è¯†åˆ«ï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨æ³¨å…¥ agent äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">envJavaToolsOptions   = <span class="string">&quot;JAVA_TOOL_OPTIONS&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// set env value</span></span><br><span class="line">idx := getIndexOfEnv(container.Env, envJavaToolsOptions)  </span><br><span class="line"><span class="keyword">if</span> idx == <span class="number">-1</span> &#123;  </span><br><span class="line">    container.Env = <span class="built_in">append</span>(container.Env, corev1.EnvVar&#123;  </span><br><span class="line">       Name:  envJavaToolsOptions,  </span><br><span class="line">       Value: javaJVMArgument,  </span><br><span class="line">    &#125;)&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    container.Env[idx].Value = container.Env[idx].Value + javaJVMArgument  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// copy javaagent.jar</span></span><br><span class="line">pod.Spec.InitContainers = <span class="built_in">append</span>(pod.Spec.InitContainers, corev1.Container&#123;  </span><br><span class="line">    Name:      javaInitContainerName,  </span><br><span class="line">    Image:     javaSpec.Image,  </span><br><span class="line">    Command:   []<span class="type">string</span>&#123;<span class="string">&quot;cp&quot;</span>, <span class="string">&quot;/javaagent.jar&quot;</span>, javaInstrMountPath + <span class="string">&quot;/javaagent.jar&quot;</span>&#125;,  </span><br><span class="line">    Resources: javaSpec.Resources,  </span><br><span class="line">    VolumeMounts: []corev1.VolumeMount&#123;&#123;  </span><br><span class="line">       Name:      javaVolumeName,  </span><br><span class="line">       MountPath: javaInstrMountPath,  </span><br><span class="line">    &#125;&#125;,&#125;)</span><br></pre></td></tr></table></figure><p>å¤§è‡´çš„è¿è¡ŒåŸç†æ˜¯å½“æœ‰ Pod çš„äº‹ä»¶å‘ç”Ÿäº†å˜åŒ–ï¼ˆé‡å¯ã€é‡æ–°éƒ¨ç½²ç­‰ï¼‰ï¼Œoperator å°±ä¼šæ£€æµ‹åˆ°å˜åŒ–ï¼Œæ­¤æ—¶ä¼šåˆ¤æ–­æ˜¯å¦å¼€å¯äº†åˆšæ‰çš„æ³¨è§£ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">instrumentation.opentelemetry.io/inject-java:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure><p>æ¥ç€ä¼šå†™å…¥ç¯å¢ƒå˜é‡ <code>JAVA_TOOL_OPTIONS</code>ï¼ŒåŒæ—¶å°† jar åŒ…ä» InitContainers ä¸­å¤åˆ¶åˆ°ä¸šåŠ¡å®¹å™¨ä¸­ã€‚</p><blockquote><p>è¿™é‡Œä½¿ç”¨åˆ°äº† kubernetes çš„åˆå§‹åŒ–å®¹å™¨ï¼Œè¯¥å®¹å™¨æ˜¯ç”¨äºåšä¸€äº›å‡†å¤‡å·¥ä½œçš„ï¼Œæ¯”å¦‚ä¾èµ–å®‰è£…ã€é…ç½®æ£€æµ‹æˆ–è€…æ˜¯ç­‰å¾…å…¶ä»–ä¸€äº›ç»„ä»¶å¯åŠ¨æˆåŠŸåå†å¯åŠ¨ä¸šåŠ¡å®¹å™¨ã€‚</p></blockquote><p>ç›®å‰è¿™ä¸ª operator è¿˜å¤„äºä½¿ç”¨é˜¶æ®µï¼ŒåŒæ—¶éƒ¨åˆ†åŠŸèƒ½è¿˜ä¸æ»¡è¶³ï¼ˆæ¯”å¦‚æ”¯æŒè‡ªå®šä¹‰æ‰©å±•ï¼‰ï¼Œä»Šåæœ‰æ—¶é—´ä¹Ÿå¯ä»¥åˆ†æä¸‹å®ƒçš„è¿è¡ŒåŸç†ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://xie.infoq.cn/article/e6def1e245e9d67735bd00dd5">https://xie.infoq.cn/article/e6def1e245e9d67735bd00dd5</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-operator/#opentelemetry-auto-instrumentation-injection">https://github.com/open-telemetry/opentelemetry-operator/#opentelemetry-auto-instrumentation-injection</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/03/04/8YFIh7suTirZacj.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;æœ€è¿‘å…¬å¸å°†æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„é“¾è·¯å·¥å…·åˆ‡æ¢ä¸ºäº† &lt;code&gt;OpenTelemetry&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/03/03/9V1aUnpOd8EAG2Y.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="k8s" scheme="http://crossoverjie.top/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨ kubernetes ç¯å¢ƒä¸‹å¦‚ä½•ä¼˜é›…æ‰©ç¼©å®¹ Pulsar</title>
    <link href="http://crossoverjie.top/2024/03/27/ob/k8s-pulsar-scale/"/>
    <id>http://crossoverjie.top/2024/03/27/ob/k8s-pulsar-scale/</id>
    <published>2024-03-27T08:13:42.000Z</published>
    <updated>2024-05-13T07:46:08.867Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>åœ¨æ•´ä¸ªå¤§ç¯å¢ƒçš„é™æœ¬å¢æ•ˆçš„ç†é™¶ä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¾—ä¸åšå¥½åº”å¯¹æ–¹æ¡ˆã€‚</p><p>æ ¹æ®å¯¹çº¿ä¸Šæµé‡ã€å­˜å‚¨ä»¥åŠç³»ç»Ÿèµ„æºçš„å ç”¨ï¼Œå‘ç°æˆ‘ä»¬çš„ Pulsar é›†ç¾¤æœ‰è®¸å¤šçš„å†—ä½™ï¼Œæ‰€ä»¥è€ƒè™‘è¿›è¡Œç¼©å®¹ä»è€Œå‡å°‘èµ„æºæµªè´¹ï¼Œæœ€ç»ˆä¹Ÿèƒ½çœä¸€äº›è´¹ç”¨ã€‚</p><p>ä¸è¿‡åœ¨ç¼©å®¹ä¹‹å‰å¾ˆæœ‰å¿…è¦å…ˆèŠèŠæ‰©å®¹ï¼ŒPulsar ä¸€å¼€å§‹å°±æ˜¯å­˜ç®—åˆ†ç¦»çš„æ¶æ„ï¼ˆæ›´å¤šå…³äº Pulsar æ¶æ„çš„å†…å®¹æœ¬æ–‡ä¸åšè¿‡å¤šä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œæœç´¢ï¼‰ï¼Œå¤©ç„¶å°±éå¸¸é€‚åˆ kubernetes ç¯å¢ƒï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ <code>kubernetes</code> çš„èƒ½åŠ›è¿›è¡Œå¿«é€Ÿæ‰©å®¹ã€‚</p><span id="more"></span><h1 id="æ‰©å®¹"><a href="#æ‰©å®¹" class="headerlink" title="æ‰©å®¹"></a>æ‰©å®¹</h1><p>Pulsar çš„æ‰©å®¹ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œåœ¨ kubernetes ç¯å¢ƒä¸‹åªéœ€è¦ä¿®æ”¹å‰¯æœ¬å³å¯ã€‚</p><h2 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h2><p>å½“æˆ‘ä»¬çš„ broker å±‚å‡ºç°ç“¶é¢ˆæ—¶ï¼ˆæ¯”å¦‚ CPUã€å†…å­˜è´Ÿè½½è¾ƒé«˜ã€GC é¢‘ç¹æ—¶ï¼‰å¯ä»¥è€ƒè™‘æ‰©å®¹ã€‚</p><blockquote><p>è®¡ç®—å±‚éƒ½æ‰©å®¹äº†ï¼Œä¹Ÿéœ€è¦æ ¹æ®æµé‡è®¡ç®—ä¸‹å­˜å‚¨å±‚æ˜¯å¦å¤Ÿç”¨ã€‚</p></blockquote><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ helm å®‰è£…çš„ Pulsar é›†ç¾¤ï¼Œé‚£åªéœ€è¦ä¿®æ”¹å¯¹äºçš„å‰¯æœ¬æ•°å³å¯ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">broker:</span>  </span><br><span class="line">  <span class="string">configuration</span>  </span><br><span class="line">  <span class="attr">component:</span> <span class="string">broker</span>  </span><br><span class="line">  <span class="attr">replicaCount:</span> <span class="number">3</span><span class="string">-&gt;5</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å°†å‰¯æœ¬æ•°ä» 3 å¢åŠ åˆ° 5 ä¹‹å kubernetes ä¼šè‡ªåŠ¨æ‹‰èµ·æ–°å¢çš„ä¸¤ä¸ª Podï¼Œä¹‹åæˆ‘ä»¬å•¥ä¹Ÿä¸éœ€è¦åšäº†ã€‚</p><p>Pulsar çš„è´Ÿè½½å‡è¡¡å™¨ä¼šè‡ªåŠ¨æ„ŸçŸ¥åˆ°æ–°å¢ä¸¤ä¸ª broker çš„åŠ å…¥ï¼Œä»è€Œå¸®æˆ‘ä»¬å°†ä¸€äº›è´Ÿè½½é«˜çš„èŠ‚ç‚¹çš„æµé‡è¿ç§»åˆ°æ–°å¢çš„èŠ‚ç‚¹ä¸­ã€‚</p><h2 id="Bookkeeper"><a href="#Bookkeeper" class="headerlink" title="Bookkeeper"></a>Bookkeeper</h2><p>åœ¨ä»‹ç» bookkeeper æ‰©å®¹å‰å…ˆç®€å•ä»‹ç»äº› Bookkeeper çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚</p><ul><li>Ensemble size (E)ï¼šå½“å‰ Bookkeeper é›†ç¾¤çš„èŠ‚ç‚¹æ•°é‡</li><li>Write quorum size (QW)ï¼šä¸€æ¡æ¶ˆæ¯éœ€è¦å†™å…¥åˆ°å‡ ä¸ª Bookkeeper èŠ‚ç‚¹ä¸­</li><li>ACK quorum size (QA)ï¼šæœ‰å¤šå°‘ä¸ª Bookkeeper èŠ‚ç‚¹ ACK ä¹‹åè¡¨ç¤ºå†™å…¥æˆåŠŸ</li></ul><p>å¯¹åº”åˆ°æˆ‘ä»¬åœ¨ <code>broker.conf</code> ä¸­çš„é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">managedLedgerDefaultEnsembleSize</span>: <span class="string">&quot;2&quot;  </span></span><br><span class="line"><span class="attr">managedLedgerDefaultWriteQuorum</span>: <span class="string">&quot;2&quot;  </span></span><br><span class="line"><span class="attr">managedLedgerDefaultAckQuorum</span>: <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¸‰ä¸ªå‚æ•°è¡¨ç¤ºä¸€æ¡æ¶ˆæ¯éœ€è¦åŒæ—¶å†™å…¥ä¸¤ä¸ª Bookkeeper èŠ‚ç‚¹ï¼ŒåŒæ—¶éƒ½è¿”å› ACK ä¹‹åæ‰èƒ½è¡¨ç¤ºå½“å‰æ¶ˆæ¯å†™å…¥æˆåŠŸã€‚</p><p>ä»è¿™ä¸ªé…ç½®ä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒBookkeeper æ˜¯å¤šå‰¯æœ¬å†™å…¥æ¨¡å‹ï¼Œé€‚å½“çš„é™ä½ QW å’Œ QA çš„æ•°é‡å¯ä»¥æé«˜å†™å…¥ååç‡ã€‚</p><p>å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ Bookkeeper æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ç„¶å E&#x2F;QW&#x2F;QA éƒ½é…ç½®ä¸º 2 å°±å¯ä»¥æ»¡è¶³æ¶ˆæ¯å¤šå‰¯æœ¬å†™å…¥äº†ã€‚</p><blockquote><p>å¤šå‰¯æœ¬å¯ä»¥ä¿è¯å½“æŸä¸ªèŠ‚ç‚¹å®•æœºåï¼Œè¿™ä¸ªèŠ‚ç‚¹çš„æ¶ˆæ¯åœ¨å…¶ä»–èŠ‚ç‚¹ä¾ç„¶æœ‰å­˜æ”¾ï¼Œæ¶ˆæ¯è¯»å–ä¸ä¼šå‡ºç°é—®é¢˜ã€‚</p></blockquote><p>é‚£ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦æ‰©å®¹ Bookkeeper äº†ï¼Œå½“ç„¶å¦‚æœå•ä¸ª Bookkeeper çš„è´Ÿè½½è¾ƒé«˜ä¹Ÿæ˜¯å¯ä»¥æ‰©å®¹çš„ã€‚</p><p>ä½†æˆ‘ä»¬å½“æ—¶æ‰©å®¹ Bookkeeper çš„åœºæ™¯æ˜¯æƒ³åˆ©ç”¨ Pulsar çš„èµ„æºéš”ç¦»åŠŸèƒ½ã€‚</p><p>å› ä¸ºæœ‰éƒ¨åˆ†ä¸šåŠ¡çš„æ¶ˆæ¯é‡æ˜æ˜¾æ¯”é«˜äºå…¶ä»–çš„ topicï¼Œè¿™æ ·ä¼šå¯¼è‡´æŸä¸ª Broker çš„è´Ÿè½½è¾ƒé«˜ï¼ŒåŒæ—¶ä¹Ÿå¯èƒ½å½±å“åˆ°å…¶ä»–æ­£å¸¸çš„ topicã€‚</p><p>æœ€å¥½çš„æ–¹å¼å°±å°†è¿™éƒ¨åˆ†æ•°æ®ç”¨å•ç‹¬çš„ broker å’Œ Bookkeeper æ¥æ‰¿è½½ï¼Œä»è€Œå®ç°ç¡¬ä»¶èµ„æºçš„éš”ç¦»ã€‚</p><p>è¿™æ ·çš„éœ€æ±‚å¦‚æœä½¿ç”¨å…¶ä»–æ¶ˆæ¯é˜Ÿåˆ—å¾€å¾€ä¸å¤ªå¥½å®ç°ï¼Œåˆ°åæ¥å¯èƒ½å°±ä¼šéƒ¨ç½²å¤šä¸ªé›†ç¾¤æ¥å®ç°éš”ç¦»ï¼Œä½†è¿™æ ·ä¹Ÿä¼šå¢åŠ è¿ç»´çš„å¤æ‚åº¦ã€‚</p><p>å¥½åœ¨ Pulsar å¤©ç„¶å°±æ”¯æŒèµ„æºéš”ç¦»ï¼Œåªéœ€è¦ä¸€ä¸ªé›†ç¾¤å°±å¯ä»¥å®ç°ä¸åŒ namespace çš„æµé‡éš”ç¦»ã€‚</p><p>æ­¤æ—¶å°±å¯ä»¥é¢å¤–æ‰©å®¹å‡ ä¸ª Bookkeeper èŠ‚ç‚¹ç”¨äºç‰¹å®šçš„ namespace ä½¿ç”¨ã€‚<br><img src="https://s2.loli.net/2024/02/27/qA89EUDHpxNmK7O.png"></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼šæˆ‘ä»¬å¯ä»¥å°† broker å’Œ Bookkeeper åˆ†åˆ«è¿›è¡Œåˆ†ç»„ï¼Œç„¶åå†é…ç½®å¯¹åº”çš„ namespaceï¼Œè¿™æ ·å°±èƒ½å®ç°èµ„æºéš”ç¦»äº†ã€‚</p><blockquote><p>æ›´å¤šå…³äºèµ„æºéš”ç¦»çš„ç»†èŠ‚æœ¬æ–‡å°±ä¸è¿‡å¤šèµ˜è¿°äº†ã€‚</p></blockquote><p>é“ºå«äº†è¿™ä¹ˆå¤šï¼Œå…¶å® Bookkeeper çš„æ‰©å®¹ä¹Ÿè›®ç®€å•çš„ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">bookkeeper:</span></span><br><span class="line">  <span class="attr">component:</span> <span class="string">bookie</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="comment"># requests:</span></span><br><span class="line">    <span class="comment"># memory: 4Gi</span></span><br><span class="line">    <span class="comment"># cpu: 2</span></span><br><span class="line">  <span class="attr">replicaCount:</span> <span class="number">3</span><span class="string">-&gt;5</span></span><br></pre></td></tr></table></figure><p>å’Œ broker æ‰©å®¹ç±»ä¼¼ï¼Œæé«˜å‰¯æœ¬æ•°é‡åï¼ŒPulsar çš„å…ƒæ•°æ®ä¸­å¿ƒä¼šæ„ŸçŸ¥åˆ°æ–°çš„ Bookkeeper èŠ‚ç‚¹åŠ å…¥ï¼Œä»è€Œæ›´æ–° broker ä¸­çš„èŠ‚ç‚¹æ•°æ®ï¼Œè¿™æ ·å°±ä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„éš”ç¦»ç­–ç•¥åˆ†é…æµé‡ã€‚</p><h1 id="ç¼©å®¹"><a href="#ç¼©å®¹" class="headerlink" title="ç¼©å®¹"></a>ç¼©å®¹</h1><p>å…¶å®æœ¬æ–‡çš„é‡ç‚¹åœ¨äºç¼©å®¹ï¼Œç‰¹åˆ«æ˜¯ Bookkeeper çš„ç¼©å®¹ï¼Œè¿™éƒ¨åˆ†å†…å®¹æˆ‘åœ¨äº’è”ç½‘ä¸Šå¾ˆå°‘çœ‹åˆ°æœ‰äººæåŠã€‚</p><h2 id="Broker-1"><a href="#Broker-1" class="headerlink" title="Broker"></a>Broker</h2><p>Broker çš„ç¼©å®¹ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºå­˜ç®—åˆ†ç¦»çš„ç‰¹ç‚¹ï¼šbroker ä½œä¸ºè®¡ç®—å±‚æ˜¯æ— çŠ¶æ€çš„ï¼Œå¹¶ä¸æ‰¿è½½ä»»ä½•çš„æ•°æ®ã€‚</p><blockquote><p>å…¶å®æ˜¯æ‰¿è½½æ•°æ®çš„ï¼Œåªæ˜¯ Pulsar ä¼šè‡ªåŠ¨è¿ç§»æ•°æ®ï¼Œä»è€Œä½“æ„Ÿä¸Šè§‰å¾—æ˜¯æ— çŠ¶æ€çš„ã€‚</p></blockquote><p>åªæ˜¯å½“ä¸€ä¸ª broker ä¸‹çº¿åï¼Œå®ƒä¸Šé¢æ‰€ç»‘å®šçš„ topic ä¼šè‡ªåŠ¨è½¬ç§»åˆ°å…¶ä»–åœ¨çº¿çš„ broker ä¸­ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹ä¼šå¯¼è‡´è¿æ¥äº†è¿™ä¸ª broker çš„ client è§¦å‘é‡è¿ï¼Œä»è€ŒçŸ­æš‚çš„å½±å“ä¸šåŠ¡ã€‚</p><blockquote><p>æ­£å› ä¸º broker çš„ä¸‹çº¿ä¼šå¯¼è‡´ topic çš„å½’å±å‘ç”Ÿè½¬ç§»ï¼Œæ‰€ä»¥åœ¨ä¸‹çº¿å‰æœ€å¥½æ˜¯å…ˆé€šè¿‡ç›‘æ§é¢æ¿è§‚å¯Ÿéœ€è¦ä¸‹çº¿çš„ broker topic æ˜¯å¦è¿‡å¤šï¼Œå¦‚æœè¿‡å¤šåˆ™å¯ä»¥å…ˆæ‰‹åŠ¨ unload ä¸€äº›æ•°æ®ï¼Œå°½é‡é¿å…ä¸€æ¬¡æ€§å¤§æ‰¹é‡çš„æ•°æ®è½¬ç§»ã€‚</p></blockquote><p><img src="https://s2.loli.net/2024/02/27/1SzKpNiACdZIbrq.png" alt="image.png"></p><blockquote><p>è§‚å¯Ÿå„ä¸ªbroker çš„ topic æ•°é‡</p></blockquote><h2 id="Bookkeeper-1"><a href="#Bookkeeper-1" class="headerlink" title="Bookkeeper"></a>Bookkeeper</h2><p>è€Œ Bookkeeper çš„ç¼©å®¹åˆ™æ²¡é‚£ä¹ˆå®¹æ˜“äº†ï¼Œç”±äºå®ƒæ˜¯ä½œä¸ºå­˜å‚¨å±‚ï¼Œæœ¬èº«æ˜¯æœ‰çŠ¶æ€çš„ï¼Œä¸‹çº¿åèŠ‚ç‚¹ä¸Šå­˜å‚¨çš„æ•°æ®æ˜¯éœ€è¦è¿ç§»åˆ°å…¶ä»–çš„ Bookkeeper èŠ‚ç‚¹ä¸­çš„ã€‚</p><p>ä¸ç„¶å°±æ— æ³•æ»¡è¶³ä¹‹å‰æåˆ°çš„ Write quorum size (QW) è¦æ±‚ï¼›å› æ­¤ç¼©å®¹è¿˜æœ‰ä¸€ä¸ªæ½œåœ¨æ¡ä»¶éœ€è¦æ»¡è¶³ï¼š</p><p>ç¼©å®¹åçš„ Bookkeeper èŠ‚ç‚¹æ•°é‡éœ€è¦å¤§äºbroker ä¸­çš„é…ç½®ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">managedLedgerDefaultEnsembleSize</span>: <span class="string">&quot;2&quot;  </span></span><br><span class="line"><span class="attr">managedLedgerDefaultWriteQuorum</span>: <span class="string">&quot;2&quot;  </span></span><br><span class="line"><span class="attr">managedLedgerDefaultAckQuorum</span>: <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure><p>ä¸ç„¶å†™å…¥ä¼šå¤±è´¥ï¼Œæ•´ä¸ªé›†ç¾¤å°†å˜å¾—ä¸å¯ç”¨ã€‚</p><p>Pulsar æä¾›äº†ä¸¤ç§ Bookkeeper çš„ä¸‹çº¿æ–¹æ¡ˆï¼š</p><h3 id="ä¸éœ€è¦è¿ç§»æ•°æ®"><a href="#ä¸éœ€è¦è¿ç§»æ•°æ®" class="headerlink" title="ä¸éœ€è¦è¿ç§»æ•°æ®"></a>ä¸éœ€è¦è¿ç§»æ•°æ®</h3><p>å…¶å®ä¸¤ç§æ–¹æ¡ˆä¸»è¦åŒºåˆ«åœ¨äºæ˜¯å¦éœ€è¦è¿ç§»æ•°æ®ï¼Œç¬¬ä¸€ç§æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä¸è¿ç§»æ•°æ®çš„æ–¹æ¡ˆã€‚</p><p>é¦–å…ˆéœ€è¦å°† Bookkeeper è®¾ç½®ä¸º read-only çŠ¶æ€ï¼Œæ­¤æ—¶è¯¥èŠ‚ç‚¹å°†ä¸ä¼šæ¥å—å†™è¯·æ±‚ï¼Œç›´åˆ°è¿™ä¸ª Bookkeeper ä¸Šçš„æ•°æ®å…¨éƒ¨è¿‡æœŸè¢«å›æ”¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰‹åŠ¨ä¸‹çº¿è¯¥èŠ‚ç‚¹ã€‚</p><p>ä½¿ç”¨ <code>forceReadOnlyBookie=true</code> å¯ä»¥å¼ºåˆ¶å°† Bookkeeper è®¾ç½®ä¸ºåªè¯»ã€‚</p><p>ä½†è¿™ä¸ªæ–¹æ¡ˆå­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>ä¸‹çº¿æ—¶é—´ä¸ç¡®å®šï¼Œå¦‚æœè¯¥ <code>Bookkeeper</code> ä¸Šå­˜å‚¨çš„æ•°æ®ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿ï¼Œåˆ™æ— æ³•é¢„ä¼°ä»€ä¹ˆæ—¶å€™å¯ä»¥ä¸‹çº¿è¯¥èŠ‚ç‚¹ã€‚</li><li>è¯¥é…ç½®ä¿®æ”¹åéœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆï¼Œåœ¨ kubernetes ç¯å¢ƒä¸­è¿™äº›é…ç½®éƒ½æ˜¯å†™åœ¨äº† configmap ä¸­ï¼Œä¸€æ—¦åˆ·æ–°åæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šè¯»å–åˆ°è¯¥é…ç½®ï¼Œæ— æ³•é’ˆå¯¹æŸä¸€ä¸ªèŠ‚ç‚¹ç”Ÿæ•ˆï¼›æ‰€ä»¥å¯èƒ½ä¼šå‡ºç°å°†ä¸è¯¥ä¸‹çº¿çš„èŠ‚ç‚¹è®¾ç½®ä¸ºäº†åªè¯»çŠ¶æ€ã€‚</li></ul><p>ä½†è¯¥æ–¹æ¡ˆçš„å¥½å¤„æ˜¯ä¸éœ€è¦è¿ç§»æ•°æ®ï¼Œäººå·¥ä»‹å…¥çš„æµç¨‹å°‘ï¼ŒåŒæ ·ä¹Ÿå°±å‡å°‘äº†å‡ºé”™çš„å¯èƒ½ã€‚</p><p>æ¯”è¾ƒé€‚åˆäºç”¨è™šæ‹Ÿæœºéƒ¨ç½²çš„é›†ç¾¤ã€‚</p><h3 id="è¿ç§»æ•°æ®"><a href="#è¿ç§»æ•°æ®" class="headerlink" title="è¿ç§»æ•°æ®"></a>è¿ç§»æ•°æ®</h3><p>ç¬¬äºŒç§å°±æ˜¯éœ€è¦è¿ç§»æ•°æ®çš„æ–¹æ¡ˆï¼Œæ›´é€‚ç”¨äº kubernetes ç¯å¢ƒã€‚</p><h4 id="è¿ç§»åŸç†"><a href="#è¿ç§»åŸç†" class="headerlink" title="è¿ç§»åŸç†"></a>è¿ç§»åŸç†</h4><p>å…ˆæ¥çœ‹çœ‹è¿ç§»çš„åŸç†ï¼š</p><ol><li>å½“ bookkeeper åœæœºåï¼ŒAutoRecovery Auditor ä¼šæ£€æµ‹åˆ° zookeeper èŠ‚ç‚¹<code>/ledger/available</code> å‘ç”Ÿå˜åŒ–ï¼Œå°†ä¸‹çº¿èŠ‚ç‚¹çš„ ledger ä¿¡æ¯å†™å…¥åˆ° zookeeper çš„ <code>/ledgers/underreplicated</code> èŠ‚ç‚¹ä¸­ã€‚</li><li>AutoRecoveryÂ ReplicationWorkerÂ ä¼šæ£€æµ‹ <code>/ledgers/underreplicated</code>èŠ‚ç‚¹ä¿¡æ¯ï¼Œç„¶åè½®è®­è¿™äº› ledger ä¿¡æ¯ä»å…¶ä»–åœ¨çº¿çš„ BK ä¸­å¤åˆ¶æ•°æ®åˆ°æ²¡æœ‰è¯¥æ•°æ®çš„èŠ‚ç‚¹ï¼Œä¿è¯ QW æ•°é‡ä¸å˜ã€‚<ol><li>æ¯å¤åˆ¶ä¸€æ¡æ•°æ®åéƒ½ä¼šåˆ é™¤ <code>/ledgers/underreplicated</code> èŠ‚ç‚¹ä¿¡æ¯ã€‚</li><li>æ‰€æœ‰ <code>/ledgers/underreplicated</code> è¢«åˆ é™¤åè¯´æ˜è¿ç§»ä»»åŠ¡å®Œæˆã€‚</li></ol></li><li>æ‰§è¡Œ <code>bin/bookkeeper shell decommissionbookie</code> ä¸‹çº¿å‘½ä»¤ï¼š<ol><li>ä¼šç­‰å¾… <code>/ledgers/underreplicated</code> å…¨éƒ¨åˆ é™¤</li><li>Â ç„¶ååˆ é™¤ zookeeper ä¸­çš„å…ƒæ•°æ®</li><li>å…ƒæ•°æ®åˆ é™¤å bookkeeper æ‰æ˜¯çœŸæ­£ä¸‹çº¿æˆåŠŸï¼Œæ­¤æ—¶ broker æ‰ä¼šæ„ŸçŸ¥åˆ° Bookkeeper ä¸‹çº¿ã€‚</li></ol></li></ol><p><code>AutoRecovery</code> æ˜¯ Bookkeeper æä¾›çš„ä¸€ä¸ªè‡ªåŠ¨æ¢å¤ç¨‹åºï¼Œä»–ä¼šåœ¨åå°æ£€æµ‹æ˜¯å¦æœ‰æ•°æ®éœ€è¦è¿ç§»ã€‚</p><blockquote><p>ç®€å•æ¥è¯´å°±æ˜¯å½“æŸä¸ªBookkeeper åœæœºåï¼Œå®ƒä¸Šé¢æ‰€å­˜å‚¨çš„ ledgerID ä¼šè¢«å†™å…¥åˆ°å…ƒæ•°æ®ä¸­å¿ƒï¼Œæ­¤æ—¶ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥æ‰«æè¿™äº›éœ€è¦è¿ç§»çš„æ•°æ®ï¼Œæœ€ç»ˆå°†è¿™äº›æ•°æ®å†™å…¥åˆ°å…¶ä»–åœ¨çº¿çš„ Bookkeeper èŠ‚ç‚¹ã€‚</p></blockquote><p>Bookkeeper ä¸­çš„ä¸€äº›å…³é”®ä»£ç ï¼š<br><img src="https://s2.loli.net/2024/02/27/QqtYUBvadWpDmnR.png" alt="image.png"><br><img src="https://s2.loli.net/2024/02/27/gi9JLdMmYxunHTE.png" alt="image.png"></p><h4 id="ä¸‹çº¿æ­¥éª¤"><a href="#ä¸‹çº¿æ­¥éª¤" class="headerlink" title="ä¸‹çº¿æ­¥éª¤"></a>ä¸‹çº¿æ­¥éª¤</h4><p>ä¸‹é¢æ¥çœ‹å…·ä½“çš„ä¸‹çº¿æµç¨‹ï¼š</p><ol><li>å‰¯æœ¬æ•°-1<ol><li><code>bin/bookkeeper shell listunderreplicated</code> æ£€æµ‹æœ‰å¤šå°‘ ledger éœ€è¦è¢«è¿ç§»</li></ol></li><li>æ‰§è¡Œè¿œç¨‹ä¸‹çº¿å…ƒæ•°æ®<ol><li><code>nohup bin/bookkeeper shell decommissionbookie -bookieid bkid:3181 &gt; bk.log 2&gt;&amp;1 &amp;</code></li><li>è¿™ä¸ªå‘½ä»¤ä¼šä¸€ç›´åå°è¿è¡Œç­‰å¾…æ•°æ®è¿ç§»å®Œæˆï¼Œæ¯”è¾ƒè€—æ—¶</li></ol></li><li>æŸ¥çœ‹ä¸‹çº¿èŠ‚ç‚¹æ˜¯å¦å·²è¢«å‰”é™¤<ol><li><code>bin/bookkeeper shell listbookies -a</code></li></ol></li><li>å¾ªç¯ç¬¬ä¸€æ­¥</li></ol><p>ç¬¬ä¸€æ­¥æ˜¯æ£€æµ‹ä¸€äº›ç°åœ¨æœ‰å¤šå°‘æ•°æ®éœ€è¦è¿ç§»ï¼š<br><code>bin/bookkeeper shell listunderreplicated</code> å‘½ä»¤æŸ¥çœ‹éœ€è¦è¢«è¿ç§»çš„ ledger æ•°æ®ä¹Ÿæ˜¯æ¥è‡ªäº <code>/ledgers/underreplicated</code>èŠ‚ç‚¹<br><img src="https://s2.loli.net/2024/02/27/FiWJ8b27QD6w5E1.png" alt="image.png"></p><blockquote><p>æ­£å¸¸æƒ…å†µä¸‹æ˜¯ 0</p></blockquote><p>ç¬¬äºŒæ­¥çš„å‘½ä»¤ä¼šç­‰å¾…æ•°æ®è¿ç§»å®Œæˆåä» zookeeper ä¸­åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯ï¼Œè¿™ä¸ªè¿›ç¨‹é€€å‡ºåè¡¨ç¤ºä¸‹çº¿æˆåŠŸã€‚</p><p><img src="https://s2.loli.net/2024/02/27/TuK7FPXCm1fcgJS.png" alt="image.png"></p><blockquote><p>è¿™ä¸ªå‘½ä»¤æœ€å¥½æ˜¯åå°æ‰§è¡Œï¼Œå¹¶è¾“å‡ºæ—¥å¿—åˆ°ä¸“é—¨çš„æ–‡ä»¶ï¼Œå› ä¸ºå‘¨æœŸè¾ƒé•¿ï¼Œå¾ˆæœ‰å¯èƒ½ç»ˆç«¯ä¼šè¯å·²ç»è¶…æ—¶äº†ã€‚</p></blockquote><p>æˆ‘ä»¬ç™»å½• zookeeper å¯ä»¥çœ‹åˆ°éœ€è¦è¿ç§»çš„ ledger æ•°æ®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bin/pulsar zookeeper-shell -server pulsar-zookeeper:2181</span><br><span class="line"></span><br><span class="line">get /ledgers/underreplication/ledgers/0000/0000/0000/0002/urL0000000002</span><br><span class="line">replica: &quot;pulsar-test-2-bookie-0.pulsar-test-2-bookie.pulsar-test-2.svc.cluster.local:3181&quot;</span><br><span class="line">ctime: 1708507296519</span><br></pre></td></tr></table></figure><p>underreplication çš„èŠ‚ç‚¹è·¯å¾„ä¸­å­˜æ”¾äº† ledgerIdï¼Œé€šè¿‡ ledgerId è®¡ç®—è·¯å¾„ï¼š<br><img src="https://s2.loli.net/2024/02/27/bAx8nqeKQT7F4HV.png"><br><img src="https://s2.loli.net/2024/02/27/GiVlDP2M85pafAO.png"></p><h4 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h4><p>ä¸‹çº¿è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ <code>nohup bin/bookkeeper shell decommissionbookie -bookieid bkid:3181 &gt; bk.log 2&gt;&amp;1 &amp;</code>è¿™ä¸ªå‘½ä»¤å†™å…¥çš„æ—¥å¿—æ¥ç¡®è®¤è¿ç§»çš„è¿›åº¦ï¼Œæ—¥å¿—ä¸­ä¼šæ‰“å°å½“å‰è¿˜æœ‰å¤šå°‘æ•°é‡çš„ ledger æ²¡æœ‰è¿ç§»ã€‚</p><p>åŒæ—¶éœ€è¦è§‚å¯Ÿ zookeeperã€Bookkeeper çš„èµ„æºå ç”¨æƒ…å†µã€‚</p><p>å› ä¸ºè¿ç§»è¿‡ç¨‹ä¸­å†™å…¥å¤§é‡æ•°æ®åˆ° zookeeper èŠ‚ç‚¹ï¼ŒåŒæ—¶è¿ç§»æ•°æ—¶ä¹Ÿä¼šæœ‰å¤§é‡æµé‡å†™å…¥ Bookkeeperã€‚</p><p>ä¸è¦è®©è¿ç§»è¿‡ç¨‹å½±å“åˆ°äº†æ­£å¸¸çš„ä¸šåŠ¡ä½¿ç”¨ã€‚</p><p>æ ¹æ®æˆ‘çš„è¿ç§»ç»éªŒæ¥çœ‹ï¼Œé€šå¸¸ 2w çš„ledger æ•°æ®éœ€è¦ 2ï½3 å°æ—¶ä¸ç­‰çš„æ—¶é—´ï¼Œå…·ä½“æƒ…å†µè¿˜å¾—æ ¹æ®ä½ çš„é›†ç¾¤æ¥ç¡®è®¤ã€‚</p><h4 id="å›æ»šæ–¹æ¡ˆ"><a href="#å›æ»šæ–¹æ¡ˆ" class="headerlink" title="å›æ»šæ–¹æ¡ˆ"></a>å›æ»šæ–¹æ¡ˆ</h4><p>å½“ç„¶ä¸‡ä¸€è¿ç§»æ¯”è¾ƒè€—æ—¶ï¼Œæˆ–è€…å½±å“äº†ä¸šåŠ¡ä½¿ç”¨ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦æœ‰ä¸€ä¸ªå›æ»šæ–¹æ¡ˆï¼š</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªå¤§çš„å‰æï¼š<br><strong>åªè¦ BK èŠ‚ç‚¹å…ƒæ•°æ®ã€PVCï¼ˆä¹Ÿå°±æ˜¯ç£ç›˜ä¸­çš„æ•°æ®ï¼‰ æ²¡æœ‰è¢«åˆ é™¤å°±å¯ä»¥è¿›è¡Œå›æ»šã€‚</strong></p><p>æ‰€ä»¥åªè¦ä¸Šè¿°çš„ decommissionbookie å‘½ä»¤æ²¡æœ‰å®Œå…¨æ‰§è¡Œå®Œæ¯•ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰‹åŠ¨ kill è¯¥è¿›ç¨‹ï¼Œç„¶åæ¢å¤å‰¯æœ¬æ•°æ®ã€‚</p><p>è¿™æ ·æ¢å¤çš„ Bookkeeper èŠ‚ç‚¹ä¾ç„¶å¯ä»¥æä¾›æœåŠ¡ï¼ŒåŒæ—¶æ•°æ®ä¹Ÿè¿˜å­˜åœ¨ï¼›åªæ˜¯æµªè´¹äº†ä¸€äº› autorecovery çš„èµ„æºã€‚</p><p>æœ€åå½“ bookkeeper æˆåŠŸä¸‹çº¿åï¼Œæˆ‘ä»¬éœ€è¦åˆ é™¤ PVCï¼Œä¸ç„¶å¦‚æœä»Šåéœ€è¦æ‰©å®¹çš„æ—¶å€™æ˜¯æ— æ³•å¯åŠ¨ bookkeeper çš„ï¼Œå› ä¸ºåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šåˆ¤æ–­æŒ‚è½½çš„ç£ç›˜æ˜¯å¦æœ‰æ•°æ®ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ€»çš„æ¥è¯´ Pulsar çš„æ‰©ç¼©å®¹è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œåªæ˜¯å¯¹äºæœ‰çŠ¶æ€èŠ‚ç‚¹çš„æ•°æ®è¿ç§»ç¨å¾®å¤æ‚ä¸€äº›ï¼Œä½†åªè¦è·Ÿç€æµç¨‹èµ°å°±ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://pulsar.apache.org/docs/next/administration-isolation/">https://pulsar.apache.org/docs/next/administration-isolation/</a></li><li><a href="https://bookkeeper.apache.org/docs/4.13.0/admin/decomission">https://bookkeeper.apache.org/docs/4.13.0/admin/decomission</a></li><li><a href="https://bookkeeper.apache.org/docs/4.13.0/admin/autorecovery">https://bookkeeper.apache.org/docs/4.13.0/admin/autorecovery</a></li></ul><p>#Blog #Pulsar </p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;åœ¨æ•´ä¸ªå¤§ç¯å¢ƒçš„é™æœ¬å¢æ•ˆçš„ç†é™¶ä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¾—ä¸åšå¥½åº”å¯¹æ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;p&gt;æ ¹æ®å¯¹çº¿ä¸Šæµé‡ã€å­˜å‚¨ä»¥åŠç³»ç»Ÿèµ„æºçš„å ç”¨ï¼Œå‘ç°æˆ‘ä»¬çš„ Pulsar é›†ç¾¤æœ‰è®¸å¤šçš„å†—ä½™ï¼Œæ‰€ä»¥è€ƒè™‘è¿›è¡Œç¼©å®¹ä»è€Œå‡å°‘èµ„æºæµªè´¹ï¼Œæœ€ç»ˆä¹Ÿèƒ½çœä¸€äº›è´¹ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ä¸è¿‡åœ¨ç¼©å®¹ä¹‹å‰å¾ˆæœ‰å¿…è¦å…ˆèŠèŠæ‰©å®¹ï¼ŒPulsar ä¸€å¼€å§‹å°±æ˜¯å­˜ç®—åˆ†ç¦»çš„æ¶æ„ï¼ˆæ›´å¤šå…³äº Pulsar æ¶æ„çš„å†…å®¹æœ¬æ–‡ä¸åšè¿‡å¤šä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œæœç´¢ï¼‰ï¼Œå¤©ç„¶å°±éå¸¸é€‚åˆ kubernetes ç¯å¢ƒï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ &lt;code&gt;kubernetes&lt;/code&gt; çš„èƒ½åŠ›è¿›è¡Œå¿«é€Ÿæ‰©å®¹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/categories/Pulsar/"/>
    
    <category term="OB" scheme="http://crossoverjie.top/categories/Pulsar/OB/"/>
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/tags/Pulsar/"/>
    
  </entry>
  
  <entry>
    <title>é¡¶çº§å¼€æºç¤¾åŒºéƒ½èƒ½åµèµ·æ¥ï¼Ÿ</title>
    <link href="http://crossoverjie.top/2024/03/20/ob/about-opensource-argument/"/>
    <id>http://crossoverjie.top/2024/03/20/ob/about-opensource-argument/</id>
    <published>2024-03-20T03:15:51.000Z</published>
    <updated>2024-03-21T14:08:20.204Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>å› ä¸ºè®¢é˜…äº† Pulsar çš„å¼€å‘è€…é‚®ä»¶ï¼Œå‰æ®µæ—¶é—´çœ‹åˆ°ä¸€å°æ ‡é¢˜ä¸º<a href="https://lists.apache.org/thread/gzx4j9q0xdtcvrfvvq72t9tm2rt9h3r7">ã€Š(Apache committer criteria) [ANNOUNCE] New Committer: Asaf Mesikaã€‹</a>çš„é‚®ä»¶ã€‚</p><p>ä¹ä¸€çœ‹ä»¥ä¸ºæ˜¯æ¬¢è¿ <code>Asaf Mesika</code> æˆä¸º Committerï¼Œä½†ä»”ç»†ä¸€çœ‹ä¸å¤ªå¯¹åŠ²ï¼Œè¿™å†…å®¹ä¹Ÿå¤ªå¤šäº†ï¼Œä»¥å¾€çš„æ¬¢è¿éƒ½æ˜¯ç®€å•çš„ <code>Congratulations!</code> ä½œä¸ºå›å¤ï¼Œè¿™ç¯‡å†…å®¹æ˜æ˜¾æœ‰ç‚¹å¤šäº†ï¼Œäºæ˜¯ä¾¿ä»”ç»†çœ‹äº†ä¸‹ã€‚</p><span id="more"></span><p><img src="https://s2.loli.net/2024/03/20/aASNcDpnwVIjHFv.png"></p><h1 id="äº‰è®º"><a href="#äº‰è®º" class="headerlink" title="äº‰è®º"></a>äº‰è®º</h1><p>å¤§æ¦‚çš„æ„æ€æ˜¯è¿™å°é‚®ä»¶çš„ä½œè€… <code>Kalwit</code> å¯¹æˆä¸º Committer çš„æ ‡å‡†äº§ç”Ÿäº†ç–‘é—®ï¼š</p><blockquote><p>ä»–è§‰å¾—æœ¬æ¬¡æåæˆä¸º Committer çš„å¤§éƒ¨åˆ†è´¡çŒ®éƒ½æ˜¯ä¸€äº›æ–‡æ¡£ç›¸å…³çš„å†…å®¹ï¼Œè¿˜æœ‰å°‘éƒ¨åˆ†æ˜¯ä¸ç›‘æ§ç›¸å…³çš„ææ¡ˆã€‚<br>ä»–ä»¬å›¢é˜Ÿä½¿ç”¨ Pulsar æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œä½†ç›®å‰è¿˜æœªå‘ç°ç¨³å®šçš„ Pulsar ç‰ˆæœ¬ï¼›å¤§éƒ¨åˆ†çš„ Review éƒ½æ˜¯æ¥è‡ªåŒä¸€å…¬å¸ï¼ˆstreamnativeï¼‰ã€‚<br>çœ‹èµ·æ¥æ˜¯æ•´ä¸ª Pulsar é¡¹ç›®ç”±æŸä¸€å®¶å…¬å¸æ§åˆ¶äº†ï¼Œä»–ä»¬å½“åˆé€‰æ‹©ä» Kafka åˆ‡æ¢åˆ° Pulsar å°±æ˜¯å› ä¸º Kafka ç”± Confluent æ§åˆ¶ï¼Œæ‰é€‰æ‹©ä¸€ä¸ªæ›´åŠ å¼€æ”¾çš„ç¤¾åŒºã€‚</p></blockquote><p>è¿™æ ·çš„ä¸€å°æœ‰ç€â€œè®¨ä¼â€æ„å‘³çš„é‚®ä»¶ä¸€ç»å‘å‡ºï¼Œè‡ªç„¶æ˜¯ä¸€çŸ³æ¿€èµ·åƒå±‚æµªï¼Œç¤¾åŒºé‡Œå¾ˆå¤šæˆå‘˜éƒ½å‘è¡¨äº†å›å¤ã€‚</p><p>è¿™é‡Œæˆ‘æŒ‘é€‰äº†å‡ ä¸ªä»£è¡¨æ€§çš„å›å¤ï¼š<br><img src="https://s2.loli.net/2024/03/21/8ZEBJrVpiW6KYXk.png"><br>å¤§æ¦‚æ„æ€å°±æ˜¯ Pulsar æ˜¯ä¸€ä¸ªå¼€æ”¾æ€§é¡¹ç›®ï¼Œä»»ä½•äººéƒ½å¯ä»¥å‚åŠ ï¼Œæ¯ä¸¤å‘¨ä¹Ÿæœ‰ Zoom ä¼šè®®ï¼Œä¹Ÿæ˜¯æ¯ä¸ªäººéƒ½å¯ä»¥å‚åŠ ã€‚</p><p>åœ¨è¿œç¨‹çš„ç¤¾åŒºå¼‚æ­¥æ²Ÿé€šè¿‡ç¨‹ä¸­ï¼Œå¾ˆæœ‰å¯èƒ½ä½ çš„è¯·æ±‚æ²¡æœ‰å¾—åˆ°åŠæ—¶çš„å“åº”ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚</p><p>Pulsar æ˜¯ç”±ç¤¾åŒºå¼€å‘è´Ÿè´£ç»´æŠ¤çš„ï¼Œæ²¡æœ‰å…¬å¸å¯¹æ­¤è´Ÿè´£ï¼Œå› æ­¤æ²¡æœ‰å¾—åˆ°å“åº”æ—¶æ˜¯æ²¡æœ‰å…¬å¸å¯ä»¥è´£æ€ªçš„ï¼›éœ€è¦å¤§å®¶ä¸€èµ·æ¥è§£å†³é—®é¢˜ï¼Œå¹¶ä¸ä¸€å®šæ˜¯éœ€è¦ PMCï¼ˆé¡¹ç›®ç®¡ç†å§”å‘˜ä¼šæˆå‘˜ï¼‰è¿˜æ˜¯ committeræ‰èƒ½æå‡ºæ„è§ï¼Œä»»ä½•äººéƒ½å¯ä»¥å‘è¡¨è‡ªå·±çš„çœ‹æ³•ã€‚</p><p>ä½†è¿™ä¸ªè¿‡ç¨‹ä¸­å¤§å®¶çš„èº«ä»½éƒ½æ˜¯å¿—æ„¿è€…ï¼Œéœ€è¦å¤§å®¶è‡ªå‘çš„å»åšè¿™äº›äº‹æƒ…ã€‚</p><p>åç»­ Kalwit åˆç»§ç»­å›å¤äº†ä¸€äº›é‚®ä»¶ï¼Œæ€»ä½“å†…å®¹å°±æ˜¯å¯¹ç¤¾åŒºæ²»ç†å­˜åœ¨ç–‘æƒ‘ï¼›ç‰¹åˆ«æ˜¯æ‹…å¿ƒç¤¾åŒºèƒŒåç”±æŸä¸€å®¶å…¬å¸ä½œä¸ºä¸»å¯¼ï¼Œä»è€Œå¯¼è‡´ç¤¾åŒºå’Œå…¬å¸çš„åˆ©ç›Šè¿›è¡Œç»‘å®šã€‚</p><p>å½“ç„¶ç¤¾åŒºçš„è§‚ç‚¹ä¾ç„¶æ˜¯ï¼ŒPulsar ç¤¾åŒºä¸å—æŸä¸€å…·ä½“å…¬å¸æŒæ§ï¼Œå¹¶ä¸¾äº†å…·ä½“æ•°æ®ï¼š<br><img src="https://s2.loli.net/2024/03/21/UDiRHjMWdO8xsSI.png"><br>åœ¨ 41 ä¸ª PMC æˆå‘˜ä¸­ï¼Œåªæœ‰ 9 ä½æ˜¯ StreamNative çš„å‘˜å·¥ï¼Œ41 ä½ committer ä¸­æœ‰ 13 ä½æ˜¯ StreamNative çš„å‘˜å·¥ã€‚</p><blockquote><p>å…¶å®ä»¥æˆ‘ç›®å‰åœ¨ç¤¾åŒºçš„è§‚æ„Ÿï¼Œç¡®å®æ˜¯ streamnative å…¬å¸ç¤¾åŒºç»´æŠ¤è€…æ›´åŠ æ´»è·ƒï¼Œå…¶ä»–çš„ä¸€äº› committer å¯èƒ½ç”±äºå·¥ä½œå˜åŠ¨å•¥çš„å¾ˆå°‘å†è´¡çŒ®é¡¹ç›®äº†ã€‚</p></blockquote><h2 id="ææ¡ˆè¢«å¦"><a href="#ææ¡ˆè¢«å¦" class="headerlink" title="ææ¡ˆè¢«å¦"></a>ææ¡ˆè¢«å¦</h2><p><code>Kalwit</code> ä¸¾äº†ä¸€äº›ä¾‹å­è®¤ä¸ºè¿™äº› PIP ææ¡ˆæ²¡æœ‰è·å¾—é€šè¿‡ï¼Œä½†æ˜¯ SN å›¢é˜Ÿæå‡ºçš„ææ¡ˆå¤§éƒ¨åˆ†éƒ½èƒ½é€šè¿‡ã€‚</p><p>æˆ‘è§‰å¾—è¿™ç¡®å®æ˜¯ä¸€ç§å®¢è§‚ç°è±¡ï¼Œä½†å¯èƒ½æ›´å¤šçš„åŸå› å¹¶ä¸æ˜¯ SN å…¬å¸æƒ³è¦ä¸»å¯¼ Pulsar ç¤¾åŒºçš„è¿›å±•ï¼Œè€Œæ˜¯ä»–ä»¬åœ¨ç¤¾åŒºä¹‹å¤–ï¼ˆä¸ç®¡æ˜¯çº¿ä¸Šè¿˜æ˜¯çº¿ä¸‹ï¼‰è¿›è¡Œè¿‡é¢å¤–çš„æ²Ÿé€šï¼Œä¹Ÿè®¸åœ¨æäº¤è‰æ¡ˆä¹‹å‰å°±å·²ç»è¾¾æˆäº†åˆæ­¥ä¸€è‡´äº†ï¼Œæ‰€ä»¥åœ¨ææ¡ˆå®¡æ ¸é˜¶æ®µåªéœ€è¦åšä¸€äº›å…·ä½“çš„è°ƒæ•´å°±å¾ˆå®¹æ˜“è¢«é€šè¿‡ã€‚</p><p>æˆ‘è‡ªå·±ä¹Ÿæè¿‡ä¸€äº›ææ¡ˆï¼Œå¤§æ¦‚æäº¤äº†ä¸‰ä¸ªåªæœ‰ä¸€ä¸ªé€šè¿‡äº†ï¼›æˆ‘ä¸ªäººçš„æ„Ÿå—æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¸­å“åº”æ—¶é—´ç¡®å®ä¸å¯æ§ï¼ˆæ¯•ç«Ÿæ˜¯å¼‚æ­¥æ²Ÿé€šï¼‰ï¼Œä½†å¹¶ä¸ä¼šå­˜åœ¨æŸä¸ªå›¢é˜Ÿæƒ³è¦æ§åˆ¶å“ªäº›ææ¡ˆå¯ä»¥é€šè¿‡ï¼Œå“ªäº›ææ¡ˆä¸è¡Œçš„è¿™ç§è¯´æ³•ã€‚</p><p>éƒ½æ˜¯åœ¨å°±äº‹è®ºäº‹çš„è®¨è®ºäº‹æƒ…ï¼Œè€Œä¸”ä¸é€šè¿‡çš„è¯ä¹Ÿä¼šç”±ç›¸å…³çš„å›å¤å’Œå»ºè®®ï¼Œç¡®å®å¤§éƒ¨åˆ†æƒ…å†µä¹Ÿæ˜¯æˆ‘è€ƒè™‘ä¸å‘¨ã€‚</p><p>æˆ‘ä¹Ÿçœ‹è¿‡ asafm çš„è´¡çŒ®ï¼Œå…¶ä¸­å…³äº Pulsar é›†æˆ <a href="https://github.com/apache/pulsar/pull/21080">OpenTelemetry</a> çš„ææ¡ˆç¡®å®æ˜¯ä¸‹äº†åŠŸå¤«çš„ï¼ˆä¸€ä¸‡å¤šå­—çš„å†…å®¹ï¼‰ï¼Œä»å¤´è®²è§£äº† OpenTelemetry çš„æ¦‚å¿µï¼Œä»¥åŠ Pulsar éœ€è¦åšå“ªäº›äº‹æƒ…æ¥é›†æˆã€‚</p><h1 id="ä¸ªäººæ„Ÿå—"><a href="#ä¸ªäººæ„Ÿå—" class="headerlink" title="ä¸ªäººæ„Ÿå—"></a>ä¸ªäººæ„Ÿå—</h1><h2 id="å‚å•†ç»‘å®š"><a href="#å‚å•†ç»‘å®š" class="headerlink" title="å‚å•†ç»‘å®š"></a>å‚å•†ç»‘å®š</h2><p>çœ‹å®Œä¹‹åæˆ‘ä¸ªäººçš„æ„Ÿå—æ˜¯ <code>Kalwit</code> æˆ–è€…ä»–çš„å›¢é˜Ÿåœ¨å‚ä¸ç¤¾åŒºçš„æ—¶å€™åº”è¯¥æ˜¯è¿›å±•ä¸é¡ºåˆ©ï¼Œä¸€äº›ææ¡ˆæˆ–è€…æ”¹åŠ¨æ²¡æœ‰å¾—åˆ°æ”¯æŒï¼Œä½†çœ‹åˆ° SN å…¬å¸æäº¤çš„å†…å®¹æ›´å¿«å¾—åˆ°å“åº”ï¼Œæ‰€ä»¥å¾—å‡ºäº†ä»¥ä¸Šçš„ç»“è®ºï¼šPulsar ç¤¾åŒºç”± SN å…¬å¸è¿›è¡Œäº†ä¸»å¯¼ã€‚</p><p>ä»–çš„é¡¾è™‘ä¹Ÿä¸æ˜¯æ²¡æœ‰é“ç†ï¼Œå°±åƒä»–è¯´çš„ Kafka ç¤¾åŒºç”± confluence å…¬å¸ä¸»å¯¼ï¼Œç±»ä¼¼çš„è¿˜æœ‰ Dubbo ç¤¾åŒºç”±é˜¿é‡Œä¸»å¯¼ã€Golang ç”± google ä¸»å¯¼ã€‚</p><p>ä½†é¡¹ç›®å¦‚æœåŠ å…¥äº† Apache é‚£ä»–åŸæœ¬çš„å…¬å¸å…¶å®å·²ç»å¤±å»äº†å¯¹é¡¹ç›®çš„æ‰€æœ‰æƒï¼Œåªæ˜¯åˆšå¼€å§‹çš„ä¸€äº› PMC&#x2F;committer å¤§éƒ¨åˆ†ä¼šæ˜¯è¿™ä¸ªå…¬å¸çš„å‘˜å·¥ï¼Œæ¯•ç«Ÿä»–ä»¬æ˜¯é¡¹ç›®çš„å‘èµ·è€…ï¼Œä¹Ÿæ›´åŠ ç†Ÿæ‚‰æ•´ä¸ªç³»ç»Ÿã€‚</p><p>å¦‚æœç¤¾åŒºå‘å±•çš„å¥åº·ï¼Œåç»­åº”è¯¥ä¼šè¡¥å……ä¸€äº›å…¶ä»–å¼€å‘è€…ï¼Œè¿™äº›å¼€å‘è€…ä¸å—é›‡äºä¹‹å‰å‘èµ·çš„é¡¹ç›®çš„å…¬å¸ï¼Œç”šè‡³æ˜¯ä»¥ä¸ªäººèº«ä»½åŠ å…¥ï¼›åªæœ‰è¿™æ ·ç¤¾åŒºå°±ä¼šæ›´åŠ å¤šæ ·åŒ–ï¼Œå‡ºç°â€œä¸€è¨€å ‚â€çš„å‡ ç‡å°±ä¼šå¤§å¤§é™ä½ã€‚</p><p>æˆ‘è§‰å¾—é€ æˆè¿™ç§ç°è±¡çš„åŸå› å’Œä¸€å¼€å§‹è¯¥é¡¹ç›®æ˜¯ç”±æŸä¸€ä¸ªç‰¹å®šå…¬å¸å‘èµ·æœ‰æœ‰å¾ˆå¤§çš„åŸå› ï¼Œæ¯”å¦‚ Dubboã€Golangï¼Œæ‰€ä»¥ä»–ä»¬å…¬å¸åœ¨ç¤¾åŒºçš„å£°æµªæ›´å¤§ï¼Œè‡ªå·±å…¬å¸çš„éœ€æ±‚ä¼˜å…ˆçº§ä¹Ÿä¼šæ›´é«˜ï¼Œæ¯•ç«Ÿä¼šæœ‰æ¥è‡ªåŒä¸€å…¬å¸çš„æ›´å¤šçš„äººæ¥å®¡æ ¸è¿™äº›éœ€æ±‚ã€‚</p><p>è™½è¯´å¦‚å‰é¢é‚®ä»¶é‡Œå›å¤çš„ï¼š<code>ç¤¾åŒºæ˜¯ç”±å¿—æ„¿è€…è‡ªæ„¿ç»´æŠ¤çš„</code>ï¼Œä½†ä¸å¯å¦è®¤çš„æ˜¯åœ¨è¿™äº›åšå¼€æºé¡¹ç›®å•†ä¸šåŒ–çš„å…¬å¸å†…æœ‰ä¸€æ‰¹äººå°±åœ¨ä¸“é—¨ç»´æŠ¤ç¤¾åŒºå·¥ä½œã€‚</p><p>ä»–ä»¬ä¼šæŠŠè‡ªå·±å•†ä¸šåŒ–è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œæˆ–è€…æ˜¯æ–°çš„ feature ä¹Ÿæäº¤ç»™ç¤¾åŒºï¼Œä½†è¿™é‡Œçš„åŒºåˆ«æ˜¯ä»–ä»¬æ˜¯æ‹¿å·¥èµ„çš„ï¼Œç§¯ææ€§è‚¯å®šè¦æ¯”åœ¨ç¤¾åŒºç”¨çˆ±å‘ç”µçš„å¼€å‘è€…æ›´ç§¯æã€‚</p><p>è¿™æ ·å°±ä¼šå¯¼è‡´ç¤¾åŒºä¸­æœ€æ´»è·ƒçš„é‚£æ‰¹äººå¤§æ¦‚ç‡æ˜¯é ç¤¾åŒºå…»æ´»è‡ªå·±çš„äººï¼Œä½†è¿™ä¹Ÿä¸æ˜¯ä»€ä¹ˆåäº‹ï¼›å¦‚æœä½ ä¸ªäººæˆ–è€…å…¬å¸å¼ºä¾èµ–äºæŸä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œé‚£ä¹Ÿå¯ä»¥æƒ³åŠæ³•å¤šåšè´¡çŒ®ï¼Œæˆä¸º committerï¼Œè¿™æ ·åœ¨ä¸€äº›éœ€è¦æŠ•ç¥¨çš„ç¯èŠ‚ä¹Ÿèƒ½æœ‰ä¸€å¸­ä¹‹ä½ã€‚</p><h2 id="å‚å•†æ— å…³"><a href="#å‚å•†æ— å…³" class="headerlink" title="å‚å•†æ— å…³"></a>å‚å•†æ— å…³</h2><p>å½“ç„¶ä¹Ÿæœ‰å¯¹åº”çš„ä¸æ˜¯ç”±æŸä¸€ä¸ªå‚å•†å‘èµ·çš„é¡¹ç›®ï¼Œæ¯”å¦‚æˆ‘æœ€è¿‘å‚ä¸è¾ƒå¤šçš„ <code>OpenTelemetry</code> ç¤¾åŒºã€‚</p><p><img src="https://s2.loli.net/2024/03/21/DZ2KAX5Wklpm7tr.png"><br>æŒ‰ç…§å®˜æ–¹è¯´æ³•æœ‰ç€ 1000 å¤šä½ç‹¬ç«‹çš„å¼€å‘è€…ï¼Œä»£è¡¨äº†è¶…è¿‡ 180 å®¶å…¬å¸ï¼Œåœ¨ç»´æŠ¤è€…çš„åˆ—è¡¨ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°å¤§å¤šæ•°éƒ½æ˜¯æ¥è‡ªäºä¸åŒçš„å…¬å¸ï¼š<br><img src="https://s2.loli.net/2024/03/21/jHgCdyoanmzGR8D.png"></p><p>æ‰€ä»¥è‡ªç„¶ä¹Ÿå°±æ²¡æœ‰æŸä¸€å‚å•†ä¸»å¯¼çš„è¯´æ³•ï¼Œæ‰€ä»¥æƒ³è¦é¿å…è¿™ç±»äº‹æƒ…å†æ¬¡å‘ç”Ÿï¼Œæœ€å¥½çš„æ–¹æ³•è¿˜æ˜¯å¸çº³æ›´å¤šçš„å¼€å‘è€…åŠ å…¥ï¼Œåªæœ‰ç¤¾åŒºæˆå‘˜ä¸°å¯Œèµ·æ¥ç¤¾åŒºæ‰å¥½è‰¯æ€§å‘å±•ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://lists.apache.org/thread/gzx4j9q0xdtcvrfvvq72t9tm2rt9h3r7">https://lists.apache.org/thread/gzx4j9q0xdtcvrfvvq72t9tm2rt9h3r7</a></li><li><a href="https://github.com/apache/pulsar/pull/21080">https://github.com/apache/pulsar/pull/21080</a></li><li><a href="https://opentelemetry.io/blog/2024/opentelemetry-announced-support-for-profiling/">https://opentelemetry.io/blog/2024/opentelemetry-announced-support-for-profiling/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èµ·å› &quot;&gt;&lt;a href=&quot;#èµ·å› &quot; class=&quot;headerlink&quot; title=&quot;èµ·å› &quot;&gt;&lt;/a&gt;èµ·å› &lt;/h1&gt;&lt;p&gt;å› ä¸ºè®¢é˜…äº† Pulsar çš„å¼€å‘è€…é‚®ä»¶ï¼Œå‰æ®µæ—¶é—´çœ‹åˆ°ä¸€å°æ ‡é¢˜ä¸º&lt;a href=&quot;https://lists.apache.org/thread/gzx4j9q0xdtcvrfvvq72t9tm2rt9h3r7&quot;&gt;ã€Š(Apache committer criteria) [ANNOUNCE] New Committer: Asaf Mesikaã€‹&lt;/a&gt;çš„é‚®ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;ä¹ä¸€çœ‹ä»¥ä¸ºæ˜¯æ¬¢è¿ &lt;code&gt;Asaf Mesika&lt;/code&gt; æˆä¸º Committerï¼Œä½†ä»”ç»†ä¸€çœ‹ä¸å¤ªå¯¹åŠ²ï¼Œè¿™å†…å®¹ä¹Ÿå¤ªå¤šäº†ï¼Œä»¥å¾€çš„æ¬¢è¿éƒ½æ˜¯ç®€å•çš„ &lt;code&gt;Congratulations!&lt;/code&gt; ä½œä¸ºå›å¤ï¼Œè¿™ç¯‡å†…å®¹æ˜æ˜¾æœ‰ç‚¹å¤šäº†ï¼Œäºæ˜¯ä¾¿ä»”ç»†çœ‹äº†ä¸‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="OpenSource" scheme="http://crossoverjie.top/tags/OpenSource/"/>
    
  </entry>
  
  <entry>
    <title>æŠ€æœ¯é˜…è¯»å‘¨åˆŠç¬¬åå››æœŸï¼šå¸¸ç”¨çš„ Git é…ç½®</title>
    <link href="http://crossoverjie.top/2024/02/29/ob/newsletter/Newsletter14-20240223/"/>
    <id>http://crossoverjie.top/2024/02/29/ob/newsletter/Newsletter14-20240223/</id>
    <published>2024-02-29T09:28:25.000Z</published>
    <updated>2024-02-29T14:09:37.281Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2024/01/11/YMoyEKwUubfZA9a.png"></p><p><strong>æŠ€æœ¯é˜…è¯»å‘¨åˆŠï¼Œæ¯å‘¨æ›´æ–°ã€‚</strong></p><span id="more"></span><h2 id="å†å²æ›´æ–°"><a href="#å†å²æ›´æ–°" class="headerlink" title="å†å²æ›´æ–°"></a>å†å²æ›´æ–°</h2><ul><li><a href="https://crossoverjie.top/2023/12/22/ob/newsletter/Newsletter10-20231222/">20231122ï¼šç¬¬åä¸€æœŸ</a></li><li><a href="https://crossoverjie.top/2023/12/29/ob/newsletter/Newsletter12-20231229/">20231129ï¼šç¬¬åäºŒæœŸ</a></li><li><a href="https://crossoverjie.top/2024/01/05/ob/newsletter/Newsletter12-20240105/">20240105ï¼šç¬¬åä¸‰æœŸï¼šä¸€äº›æé«˜ç”Ÿäº§åŠ›çš„ç»ˆç«¯å‘½ä»¤</a></li><li><a href="https://crossoverjie.top/2024/01/12/ob/newsletter/Newsletter12-202401012/">20240112ï¼šç¬¬åå››æœŸï¼šGolang ä½œè€… Rob Pike åœ¨ GopherConAU ä¸Šçš„åˆ†äº«</a></li></ul><h1 id="How-I-write-HTTP-services-in-Go-after-13-years"><a href="#How-I-write-HTTP-services-in-Go-after-13-years" class="headerlink" title="How I write HTTP services in Go after 13 years"></a>How I write HTTP services in Go after 13 years</h1><p><img src="https://s2.loli.net/2024/02/27/SJIHKtpc5m1u7vs.png"></p><ol><li>ä½¿ç”¨NewServerå‡½æ•°æ„å»ºæœåŠ¡å®ä¾‹,åˆ©ç”¨ä¾èµ–æ³¨å…¥æ–¹å¼å°†æ‰€æœ‰çš„ä¾èµ–å‚æ•°åŒ…å«è¿›æ¥ã€‚</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">logger *Logger</span></span></span><br><span class="line"><span class="params"><span class="function">config *Config</span></span></span><br><span class="line"><span class="params"><span class="function">commentStore *commentStore</span></span></span><br><span class="line"><span class="params"><span class="function">anotherStore *anotherStore</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> http.Handler &#123;</span><br><span class="line">mux := http.NewServeMux()</span><br><span class="line">addRoutes(</span><br><span class="line">mux,</span><br><span class="line">Logger,</span><br><span class="line">Config,</span><br><span class="line">commentStore,</span><br><span class="line">anotherStore,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> handler http.Handler = mux</span><br><span class="line">handler = someMiddleware(handler)</span><br><span class="line">handler = someMiddleware2(handler)</span><br><span class="line">handler = someMiddleware3(handler)</span><br><span class="line"><span class="keyword">return</span> handler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>åœ¨routes.goæ–‡ä»¶ä¸­ç»Ÿä¸€å®šä¹‰æ‰€æœ‰è·¯ç”±å‡½æ•°ã€‚</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addRoutes</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">mux                 *http.ServeMux,</span></span></span><br><span class="line"><span class="params"><span class="function">logger              *logging.Logger,</span></span></span><br><span class="line"><span class="params"><span class="function">config              Config,</span></span></span><br><span class="line"><span class="params"><span class="function">tenantsStore        *TenantsStore,</span></span></span><br><span class="line"><span class="params"><span class="function">commentsStore       *CommentsStore,</span></span></span><br><span class="line"><span class="params"><span class="function">conversationService *ConversationService,</span></span></span><br><span class="line"><span class="params"><span class="function">chatGPTService      *ChatGPTService,</span></span></span><br><span class="line"><span class="params"><span class="function">authProxy           *authProxy</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">mux.Handle(<span class="string">&quot;/api/v1/&quot;</span>, handleTenantsGet(logger, tenantsStore))</span><br><span class="line">mux.Handle(<span class="string">&quot;/oauth2/&quot;</span>, handleOAuth2Proxy(logger, authProxy))</span><br><span class="line">mux.HandleFunc(<span class="string">&quot;/healthz&quot;</span>, handleHealthzPlease(logger))</span><br><span class="line">mux.Handle(<span class="string">&quot;/&quot;</span>, http.NotFoundHandler())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li><p>ä¸»å‡½æ•°åªè°ƒç”¨runå‡½æ•°æ¥è¿è¡ŒæœåŠ¡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">(ctx context.Context, w io.Writer, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">ctx, cancel := signal.NotifyContext(ctx, os.Interrupt)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ctx := context.Background()</span><br><span class="line"><span class="keyword">if</span> err := run(ctx, os.Stdout, os.Args); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Fprintf(os.Stderr, <span class="string">&quot;%s\n&quot;</span>, err)</span><br><span class="line">os.Exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è¿”å›é—­åŒ… handle</p></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// handleSomething handles one of those web requests</span></span><br><span class="line"><span class="comment">// that you hear so much about.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleSomething</span><span class="params">(logger *Logger)</span></span> http.Handler &#123;</span><br><span class="line">thing := prepareThing()</span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">// use thing to handle request</span></span><br><span class="line">logger.Info(r.Context(), <span class="string">&quot;msg&quot;</span>, <span class="string">&quot;handleSomething&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li><p>å®šä¹‰é€šç”¨çš„encodeå’Œdecodeå‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">encode</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(w http.ResponseWriter, r *http.Request, status <span class="type">int</span>, v T)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">w.WriteHeader(status)</span><br><span class="line"><span class="keyword">if</span> err := json.NewEncoder(w).Encode(v); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;encode json: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">decode</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(r *http.Request)</span></span> (T, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> v T</span><br><span class="line"><span class="keyword">if</span> err := json.NewDecoder(r.Body).Decode(&amp;v); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> v, fmt.Errorf(<span class="string">&quot;decode json: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> v, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æä¾›ä¸€ä¸ªæŠ½è±¡çš„ Validator æ¥å£ç”¨äºéªŒè¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Validator is an object that can be validated.</span></span><br><span class="line"><span class="keyword">type</span> Validator <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// Valid checks the object and returns any</span></span><br><span class="line"><span class="comment">// problems. If len(problems) == 0 then</span></span><br><span class="line"><span class="comment">// the object is valid.</span></span><br><span class="line">Valid(ctx context.Context) (problems <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">decodeValid</span>[<span class="title">T</span> <span class="title">Validator</span>]<span class="params">(r *http.Request)</span></span> (T, <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> v T</span><br><span class="line"><span class="keyword">if</span> err := json.NewDecoder(r.Body).Decode(&amp;v); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> v, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;decode json: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> problems := v.Valid(r.Context()); <span class="built_in">len</span>(problems) &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> v, problems, fmt.Errorf(<span class="string">&quot;invalid %T: %d problems&quot;</span>, v, <span class="built_in">len</span>(problems))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> v, <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>è‡ªå®šä¹‰æ ¡éªŒéœ€è¦å®ç° <code>Validator</code> æ¥å£ã€‚</p><ol start="8"><li>ä½¿ç”¨ Once å»¶è¿Ÿè°ƒç”¨æ¥æé«˜å¯åŠ¨æ€§èƒ½ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleTemplate</span><span class="params">(files <span class="type">string</span>...)</span></span> http.HandlerFunc &#123;</span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">init    sync.Once</span><br><span class="line">tpl     *template.Template</span><br><span class="line">tplerr  <span class="type">error</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">init.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">tpl, tplerr = template.ParseFiles(files...)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> tplerr != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, tplerr.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// use tpl</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h1 id="What-is-OpenTelemetry"><a href="#What-is-OpenTelemetry" class="headerlink" title="What is OpenTelemetry?"></a>What is OpenTelemetry?</h1><p><img src="https://s2.loli.net/2024/02/27/w13m5cQqdinLDIP.png"></p><blockquote><p>è¿™æ˜¯ä¸€ç¯‡ OTel çš„ç§‘æ™®æ–‡ç« </p></blockquote><p>OpenTelemetry æä¾›ä¸€ä¸ªç»Ÿä¸€ã€å¯æ‰©å±•çš„æ¡†æ¶ï¼Œç”¨äºæ”¶é›†ã€åˆ†æå’Œè§‚å¯Ÿåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ€§èƒ½æ•°æ®ã€‚å®ƒåŒ…æ‹¬ä¸€ç»„APIã€åº“ã€ä»£ç†å’Œæ”¶é›†å™¨ï¼Œè¿™äº›ç»„ä»¶å¯ä»¥è·¨å¤šç§ç¼–ç¨‹è¯­è¨€å’Œå¹³å°å®ç°å¯¹åº”ç”¨ç¨‹åºçš„ç›‘æ§ã€‚</p><p>OpenTelemetry æ•´åˆ OpenTracing å’Œ OpenCensusã€‚</p><p><img src="https://s2.loli.net/2024/02/27/3C1VLqIBGgAwdeR.png"></p><blockquote><p>2019å¹´ï¼Œä¸¤ä¸ªç¤¾åŒºè¿›è¡Œäº†åˆå¹¶ã€‚</p></blockquote><p>åŒæ—¶ OTel å…·å¤‡ä»¥ä¸‹ç‰¹å¾ï¼š</p><ol><li><p><strong>ç»Ÿä¸€æ€§</strong>ï¼šOpenTelemetry æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„APIï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥åœ¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ä¸­ä»¥ä¸€è‡´çš„æ–¹å¼å®ç°ç›‘æ§ã€‚</p></li><li><p><strong>å¯æ‰©å±•æ€§</strong>ï¼šå¯ä»¥ç¼–å†™è‡ªå·±çš„æ‰©å±•æ¥æ»¡è¶³ä¸ªæ€§åŒ–éœ€è¦</p></li><li><p><strong>è·¨å¹³å°</strong>ï¼šOpenTelemetry æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ï¼Œå¦‚ Javaã€Pythonã€Goã€.NET ç­‰ï¼Œä»¥åŠå¤šç§äº‘æœåŠ¡å’Œå®¹å™¨å¹³å°ã€‚</p></li><li><p><strong>ç¤¾åŒºé©±åŠ¨</strong>ï¼šä½œä¸ºä¸€ä¸ªå¼€æºé¡¹ç›®ï¼ŒOpenTelemetry ç”±ä¸€ä¸ªæ´»è·ƒçš„ç¤¾åŒºæ”¯æŒï¼Œç¤¾åŒºæˆå‘˜è´¡çŒ®ä»£ç ã€æ–‡æ¡£å’Œæœ€ä½³å®è·µã€‚</p></li><li><p><strong>ä¸ç°æœ‰å·¥å…·çš„å…¼å®¹æ€§</strong>ï¼šOpenTelemetry è®¾è®¡æ—¶è€ƒè™‘äº†ä¸ç°æœ‰ç›‘æ§å·¥å…·çš„å…¼å®¹æ€§ï¼Œå¦‚ Prometheusã€Jaegerã€Zipkin ç­‰ï¼Œè¿™ä½¿å¾—å®ƒå¯ä»¥è½»æ¾åœ°é›†æˆåˆ°ç°æœ‰çš„ç›‘æ§åŸºç¡€è®¾æ–½ä¸­ã€‚</p></li></ol><p>æä¾›äº†ä¸€ç§åä¸ºï¼šOTLPï¼ˆOpenTelemetry Protocolï¼‰çš„é€šè®¯åè®®ï¼ŒåŸºäº gRPCã€‚</p><p>ä½¿ç”¨è¯¥åè®®ç”¨äºå®¢æˆ·ç«¯ä¸ Collector é‡‡é›†å™¨è¿›è¡Œäº¤äº’ã€‚</p><p>Collector æ˜¯ OpenTelemetry æ¶æ„ä¸­çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œå®ƒè´Ÿè´£æ¥æ”¶ã€å¤„ç†å’Œå¯¼å‡ºæ•°æ®(Trace&#x2F;log&#x2F;metrics)ã€‚</p><p><img src="https://s2.loli.net/2024/02/27/fFOnesN4zhQIPR2.png"></p><p>å®ƒå¯ä»¥æ¥å—ä»å®¢æˆ·ç«¯å‘å‡ºçš„æ•°æ®è¿›è¡Œå¤„ç†ï¼ŒåŒæ—¶å¯ä»¥å¯¼å‡ºä¸ºä¸åŒæ ¼å¼çš„æ•°æ®ã€‚</p><blockquote><p>æ€»çš„æ¥è¯´ OTel æ˜¯å¯è§‚æµ‹ç³»ç»Ÿçš„æ–°æ ‡å‡†ï¼ŒåŸºäºå®ƒå¯ä»¥å…¼å®¹ä»¥å‰ä½¿ç”¨çš„ Prometheusã€ victoriametricsã€skywalking ç­‰ç³»ç»Ÿï¼ŒåŒæ—¶è¿˜å¯ä»¥çµæ´»æ‰©å±•ï¼Œä¸ç”¨ä¸ä»»ä½•ä½†ä¸€ç”Ÿæ€æˆ–æŠ€æœ¯æ ˆè¿›è¡Œç»‘å®šã€‚</p></blockquote><h1 id="Popular-git-config-options"><a href="#Popular-git-config-options" class="headerlink" title="Popular git config options"></a>Popular git config options</h1><p><img src="https://s2.loli.net/2024/02/29/d9x7T2yhFfcjluO.png"></p><blockquote><p>æœ¬æ–‡æ€»ç»“äº†ä¸€äº›å¸¸ç”¨çš„ git é…ç½®</p></blockquote><ol><li><p><code>pull.ff only</code> æˆ– <code>pull.rebase true</code>ï¼šè¿™ä¸¤ä¸ªé€‰é¡¹éƒ½å¯ä»¥é¿å…åœ¨æ‰§è¡Œ<code>git pull</code>æ—¶æ„å¤–åˆ›å»ºåˆå¹¶æäº¤ï¼Œç‰¹åˆ«æ˜¯å½“ä¸Šæ¸¸åˆ†æ”¯å·²ç»å‘ç”Ÿäº†å˜åŒ–çš„æ—¶å€™ã€‚</p></li><li><p><code>merge.conflictstyle diff3</code>ï¼šè¿™ä¸ªé€‰é¡¹ä½¿å¾—åˆå¹¶å†²çªæ›´æ˜“äºé˜…è¯»ï¼Œé€šè¿‡åœ¨å†²çªä¸­æ˜¾ç¤ºåŸå§‹ä»£ç ç‰ˆæœ¬ï¼Œå¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°è§£å†³å†²çªã€‚</p></li><li><p><code>rebase.autosquash true</code> å’Œ <code>rebase.autostash true</code>ï¼šè¿™äº›é€‰é¡¹ä½¿å¾—ä¿®æ”¹æ—§æäº¤å˜å¾—æ›´å®¹æ˜“ï¼Œå¹¶ä¸”è‡ªåŠ¨å¤„ç†stashã€‚</p></li><li><p><code>push.default simple</code> æˆ– <code>push.default current</code>ï¼šè¿™äº›é€‰é¡¹å‘Šè¯‰<code>git push</code>è‡ªåŠ¨æ¨é€å½“å‰åˆ†æ”¯åˆ°åŒåçš„è¿œç¨‹åˆ†æ”¯ã€‚</p></li><li><p><code>init.defaultBranch main</code>ï¼šåˆ›å»ºæ–°ä»“åº“æ—¶ï¼Œé»˜è®¤åˆ›å»º<code>main</code>åˆ†æ”¯è€Œä¸æ˜¯<code>master</code>åˆ†æ”¯ã€‚</p></li><li><p><code>commit.verbose true</code>ï¼šåœ¨æäº¤æ—¶æ˜¾ç¤ºæ•´ä¸ªæäº¤å·®å¼‚ã€‚</p></li><li><p><code>rerere.enabled true</code>ï¼šå¯ç”¨<code>rerere</code>åŠŸèƒ½ï¼Œè‡ªåŠ¨è§£å†³å†²çª</p></li><li><p><code>help.autocorrect</code>ï¼šè®¾ç½®è‡ªåŠ¨çŸ«æ­£çš„çº§åˆ«ï¼Œä»¥è‡ªåŠ¨è¿è¡Œå»ºè®®çš„å‘½ä»¤ã€‚</p></li><li><p><code>core.pager delta</code>ï¼šè®¾ç½®Gitä½¿ç”¨çš„åˆ†é¡µå™¨ï¼Œä¾‹å¦‚ä½¿ç”¨<code>delta</code>æ¥æŸ¥çœ‹å¸¦æœ‰è¯­æ³•é«˜äº®çš„diffã€‚</p></li><li><p><code>diff.algorithm histogram</code>ï¼šè®¾ç½®Gitçš„diffç®—æ³•ï¼Œä»¥æ”¹å–„å‡½æ•°é‡æ’æ—¶çš„diffæ˜¾ç¤ºã€‚</p></li></ol><p>æ–‡ç« é“¾æ¥ï¼š</p><ul><li><a href="https://grafana.com/blog/2024/02/09/how-i-write-http-services-in-go-after-13-years/">https://grafana.com/blog/2024/02/09/how-i-write-http-services-in-go-after-13-years/</a></li><li><a href="https://codeboten.medium.com/what-is-opentelemetry-6a7e5c6901c5">https://codeboten.medium.com/what-is-opentelemetry-6a7e5c6901c5</a></li><li><a href="https://jvns.ca/blog/2024/02/16/popular-git-config-options/">https://jvns.ca/blog/2024/02/16/popular-git-config-options/</a></li></ul><p>#Newletters </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/01/11/YMoyEKwUubfZA9a.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æŠ€æœ¯é˜…è¯»å‘¨åˆŠï¼Œæ¯å‘¨æ›´æ–°ã€‚&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="Newsletter" scheme="http://crossoverjie.top/categories/OB/Newsletter/"/>
    
    
  </entry>
  
  <entry>
    <title>ã€è¯‘ã€‘Apache Pulsar 3.2.0 å‘å¸ƒ</title>
    <link href="http://crossoverjie.top/2024/02/27/ob/translate-pulsar-3.2.0/"/>
    <id>http://crossoverjie.top/2024/02/27/ob/translate-pulsar-3.2.0/</id>
    <published>2024-02-27T02:37:24.000Z</published>
    <updated>2024-02-27T06:31:23.848Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://pulsar.apache.org/blog/2024/02/12/announcing-apache-pulsar-3-2/">åŸæ–‡é“¾æ¥</a></p><p>Pulsar3.2.0 äº 2024-02-05 å‘å¸ƒï¼Œæä¾›äº†ä¸€äº›æ–°ç‰¹æ€§å’Œä¿®å¤äº†ä¸€äº› bug ï¼Œå…±æœ‰ 57 ä½å¼€å‘è€…æäº¤äº† 88 æ¬¡ commitã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®ç‰¹æ€§ä»‹ç».</p><span id="more"></span><h1 id="é€Ÿç‡é™åˆ¶"><a href="#é€Ÿç‡é™åˆ¶" class="headerlink" title="é€Ÿç‡é™åˆ¶"></a>é€Ÿç‡é™åˆ¶</h1><p>åœ¨ 3.2 ä¸­å¯¹é€Ÿç‡é™åˆ¶åšäº†é‡æ„ï¼š<br><a href="https://github.com/apache/pulsar/blob/master/pip/pip-322.md">PIP-322 Pulsar Rate Limiting Refactoring</a>.</p><p>é€Ÿç‡é™åˆ¶å™¨æ˜¯ Pulsar æœåŠ¡è´¨é‡ï¼ˆQosï¼‰ä¿è¯çš„é‡è¦æ¸ é“ï¼Œä¸»è¦è§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li>é€Ÿç‡é™åˆ¶å™¨çš„é«˜ CPU è´Ÿè½½</li><li>å¤§é‡çš„é”ç«äº‰ä¼šå½±å“ <code>Netty IO</code> çº¿ç¨‹ï¼Œä»è€Œå¢åŠ å…¶ä»– topic çš„å‘é€å»¶è¿Ÿ</li><li>æ›´å¥½çš„ä»£ç å°è£…</li></ul><h1 id="Topic-å‹ç¼©æ—¶ä¼šåˆ é™¤-Null-key-æ¶ˆæ¯"><a href="#Topic-å‹ç¼©æ—¶ä¼šåˆ é™¤-Null-key-æ¶ˆæ¯" class="headerlink" title="Topic å‹ç¼©æ—¶ä¼šåˆ é™¤ Null-key æ¶ˆæ¯"></a>Topic å‹ç¼©æ—¶ä¼šåˆ é™¤ Null-key æ¶ˆæ¯</h1><p>Pulsar æ”¯æŒ <a href="https://pulsar.apache.org/docs/3.2.x/concepts-topic-compaction/">Topic å‹ç¼©</a>ï¼Œåœ¨ 3.2 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ topic å‹ç¼©æ—¶ä¼šä¿ç•™ Null key çš„æ¶ˆæ¯ã€‚</p><p>ä» 3.2.0 å¼€å§‹å°†ä¼šä¿®æ”¹é»˜è®¤è¡Œä¸ºï¼Œé»˜è®¤ä¸ä¼šä¿ç•™ï¼Œè¿™å¯ä»¥å‡å°‘å­˜å‚¨ã€‚å¦‚æœæƒ³è¦æ¢å¤ä»¥å‰çš„ç­–ç•¥å¯ä»¥åœ¨ broker.conf ä¸­æ–°å¢é…ç½®ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">topicCompactionRetainNullKey</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><p>å…·ä½“ä¿¡æ¯è¯·å‚è€ƒï¼š<a href="https://github.com/apache/pulsar/blob/master/pip/pip-318.md">PIP-318</a>.</p><h1 id="WebSocket-çš„æ–°ç‰¹æ€§"><a href="#WebSocket-çš„æ–°ç‰¹æ€§" class="headerlink" title="WebSocket çš„æ–°ç‰¹æ€§"></a>WebSocket çš„æ–°ç‰¹æ€§</h1><ul><li>æ”¯æŒå¤šä¸ª topic æ¶ˆè´¹ï¼š<a href="https://github.com/apache/pulsar/blob/master/pip/pip_307.md">PIP-307</a>.</li><li>ç«¯å¯¹ç«¯åŠ å¯†Â <a href="https://github.com/apache/pulsar/blob/master/pip/pip-290.md">PIP-290</a>.</li></ul><h1 id="CLI-çš„ç”¨æˆ·ä½“éªŒæ”¹è¿›"><a href="#CLI-çš„ç”¨æˆ·ä½“éªŒæ”¹è¿›" class="headerlink" title="CLI çš„ç”¨æˆ·ä½“éªŒæ”¹è¿›"></a>CLI çš„ç”¨æˆ·ä½“éªŒæ”¹è¿›</h1><ul><li><a href="https://github.com/apache/pulsar/pull/20663">CLI å¯ä»¥é…ç½®å†…å­˜é™åˆ¶</a></li><li><a href="https://github.com/apache/pulsar/pull/21664">å…è®¸é€šè¿‡æ­£åˆ™æˆ–è€…æ˜¯æ–‡ä»¶æ‰¹é‡åˆ é™¤ topic</a></li><li><a href="https://github.com/apache/pulsar/pull/20614">é€šè¿‡Â <code>pulsar-admin clusters list</code> å¯ä»¥æ‰“å°å½“å‰ä½¿ç”¨çš„ cluster</a></li></ul><h1 id="æ„å»ºç³»ç»Ÿçš„æ”¹è¿›"><a href="#æ„å»ºç³»ç»Ÿçš„æ”¹è¿›" class="headerlink" title="æ„å»ºç³»ç»Ÿçš„æ”¹è¿›"></a>æ„å»ºç³»ç»Ÿçš„æ”¹è¿›</h1><p>3.2.0 ä¸­å¼•å…¥äº†PIP-326: <a href="https://github.com/apache/pulsar/blob/master/pip/pip-326.md">Bill of Materials(BOM)</a> æ¥ç®€åŒ–ä¾èµ–ç®¡ç†ã€‚</p><h1 id="å‚ä¸å…¶ä¸­"><a href="#å‚ä¸å…¶ä¸­" class="headerlink" title="å‚ä¸å…¶ä¸­"></a>å‚ä¸å…¶ä¸­</h1><p>Pulsar æ˜¯å‘å±•æœ€å¿«çš„å¼€æºé¡¹ç›®ä¹‹ä¸€ï¼Œè¢« Apache åŸºé‡‘ä¼šè¯„é€‰ä¸ºå‚ä¸åº¦å‰äº”çš„é¡¹ç›®ï¼Œç¤¾åŒºæ¬¢è¿å¯¹å¼€æºã€æ¶ˆæ¯ç³»ç»Ÿã€streaming æ„Ÿå…´è¶£çš„å‚ä¸è´¡çŒ®ğŸ‰ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹èµ„æºä¸ç¤¾åŒºä¿æŒè”ç³»ï¼š</p><ul><li>é˜…è¯»è´¡çŒ®æ‰‹å†Œ Â <a href="https://pulsar.apache.org/contribute/">Apache Pulsar Contribution Guide</a>Â å¼€å§‹ä½ çš„ç¬¬ä¸€ä¸ªè´¡çŒ®ã€‚</li><li>è®¿é—®Â <a href="https://github.com/apache/pulsar">Pulsar GitHub repository</a>, å…³æ³¨Â <a href="https://twitter.com/apache_pulsar">@apache_pulsar</a>Â çš„ Twitter&#x2F;XÂ , åŠ å…¥ slack ç¤¾åŒº <a href="https://apache-pulsar.slack.com/">Pulsar community on Slack</a>.</li></ul><p>ğŸ”—å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/apache/pulsar/blob/master/pip/pip-318.md">https://github.com/apache/pulsar/blob/master/pip/pip-318.md</a></li><li><a href="https://pulsar.apache.org/docs/3.2.x/concepts-topic-compaction/">https://pulsar.apache.org/docs/3.2.x/concepts-topic-compaction/</a></li><li><a href="https://github.com/apache/pulsar/blob/master/pip/pip-322.md">https://github.com/apache/pulsar/blob/master/pip/pip-322.md</a></li><li><a href="https://github.com/apache/pulsar/blob/master/pip/pip_307.md">https://github.com/apache/pulsar/blob/master/pip/pip_307.md</a></li><li><a href="https://github.com/apache/pulsar/blob/master/pip/pip-290.md">https://github.com/apache/pulsar/blob/master/pip/pip-290.md</a></li><li><a href="https://github.com/apache/pulsar/pull/20663">https://github.com/apache/pulsar/pull/20663</a></li><li><a href="https://github.com/apache/pulsar/pull/20614">https://github.com/apache/pulsar/pull/20614</a></li><li><a href="https://github.com/apache/pulsar/blob/master/pip/pip-326.md">https://github.com/apache/pulsar/blob/master/pip/pip-326.md</a></li><li><a href="https://pulsar.apache.org/contribute/">https://pulsar.apache.org/contribute/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://pulsar.apache.org/blog/2024/02/12/announcing-apache-pulsar-3-2/&quot;&gt;åŸæ–‡é“¾æ¥&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Pulsar3.2.0 äº 2024-02-05 å‘å¸ƒï¼Œæä¾›äº†ä¸€äº›æ–°ç‰¹æ€§å’Œä¿®å¤äº†ä¸€äº› bug ï¼Œå…±æœ‰ 57 ä½å¼€å‘è€…æäº¤äº† 88 æ¬¡ commitã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®ç‰¹æ€§ä»‹ç».&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/tags/Pulsar/"/>
    
  </entry>
  
  <entry>
    <title>æˆ‘çš„ 2023</title>
    <link href="http://crossoverjie.top/2024/02/17/annual-summary/2023/"/>
    <id>http://crossoverjie.top/2024/02/17/annual-summary/2023/</id>
    <published>2024-02-17T07:59:49.000Z</published>
    <updated>2024-02-21T13:46:59.929Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©æ˜¯æ˜¥èŠ‚çš„æœ€åä¸€å¤©ï¼Œå› ä¸ºå·¥ä½œä¸Šä¸´æ—¶æœ‰ç‚¹äº‹ï¼Œå¾ˆä¸æƒ…æ„¿çš„æ‰“å¼€ç”µè„‘çœ‹ç€ä¹Ÿå°± 10 å¤©æ²¡çœ‹ä»£ç è§‰å¾—éå¸¸é™Œç”Ÿã€‚</p><span id="more"></span><p>ä¹‹åä¾¿å‡†å¤‡å°†è¿Ÿè¿Ÿæœªå†™çš„ 2023 æ€»ç»“è¡¥å®Œï¼Œè¿™ä¸ªä¼ ç»Ÿä»16å¹´è‡³ä»Šå·²ç»åšæŒå°†è¿‘ 7 å¹´æ—¶é—´äº†ï¼Œä»Šå¹´å½“ç„¶ä¹Ÿä¸èƒ½æ„å¤–ã€‚</p><p><img src="https://s2.loli.net/2024/02/17/AgYLTPxs7u35RqB.png"></p><h1 id="å¥èº«"><a href="#å¥èº«" class="headerlink" title="å¥èº«"></a>å¥èº«</h1><p>ä»Šå¹´è¦è¯´æœ€è®©æˆ‘å°è±¡æ·±åˆ»çš„äº‹å°±æ˜¯å¥èº«äº†ï¼Œä¸ºæ­¤æˆ‘æŠ•å…¥äº†å¤§é‡çš„æ—¶é—´ã€‚</p><p><img src="https://s2.loli.net/2024/02/17/NB6dLUxZRnQPCAS.jpg"><br><img src="https://s2.loli.net/2024/02/17/gWe2p7LQITDuCh5.jpg"><br>æˆ‘è®°å¾—æ˜¯åœ¨ 22 å¹´å››æœˆä»½å½“æ—¶æ˜¯å› ä¸ºç¡®å®é•¿èƒ–å¤ªæ˜æ˜¾äº†ï¼Œä¸‹å®šå†³å¿ƒæ‰¾ä¸ªæ•™ç»ƒè¿›è¡Œè®­ç»ƒï¼Œæ•ˆæœç¡®å®ä¹Ÿæœ‰ã€‚</p><p>å»å¹´ä¹Ÿåˆ†äº«è¿‡ï¼Œæœ€åä» 75kg å‡åˆ° 66kgï¼›ä½†å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯è¢«åŠ¨çš„è¿›è¡Œè®­ç»ƒï¼Œæ‰€ä»¥åˆ°äº† 23 å¹´åˆçš„æ—¶å€™å…¶å®å°±åå¼¹ä¸å°‘äº†ã€‚</p><p>è€Œä»Šå¹´æœ€å¤§çš„ä¸åŒæ˜¯æˆ‘ç”±åŸå…ˆçš„è¢«åŠ¨å¥èº«æ”¹ä¸ºä¸»åŠ¨äº†ï¼Œç”šè‡³åˆ°åé¢ä¸€å¤©ä¸ç»ƒè¿˜æµ‘èº«ä¸èˆ’æœã€‚</p><p>æ‰€ä»¥ä»Šå¹´æˆ‘å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯è‡ªå·±é”»ç‚¼ï¼Œå› ä¸ºæˆ‘æ˜¯ä¸ª I äººï¼Œæ¯”è¾ƒå–œæ¬¢ä¸€ä¸ªäººï¼Œæ‰€ä»¥å¤å¤©çš„æ—¶å€™æ˜¯æ¯å¤©æ—©ä¸Š 7 ç‚¹å¤šå»å¥èº«æˆ¿ç„¶åå†å»å…¬å¸ã€‚ </p><p>åˆ°äº†å†¬å¤©æ—©ä¸Šç¡®å®æ˜¯èµ·ä¸æ¥ï¼Œå°±æ”¹ä¸ºäº†ä¸­åˆå»è®­ç»ƒã€‚</p><p>å°±è¿™æ ·ä¸çŸ¥ä¸è§‰å°±åšæŒäº†å¤§åŠå¹´ï¼Œç›´åˆ°ç°åœ¨ã€‚</p><p>è®­ç»ƒæ—¥å¿—è§æ–‡æœ«ã€‚</p><blockquote><p>ç”šè‡³ç°åœ¨å¶å°”æ‰¾æ•™ç»ƒè®­ç»ƒæ—¶ï¼Œä»–è¯´æˆ‘æ¯”ä»–ç»ƒçš„éƒ½å‹¤ğŸ¤£ã€‚</p></blockquote><p>æœ€ç»ˆè¾¾åˆ°çš„æ•ˆæœå°±æ˜¯ç”Ÿæ´»ä½œæ¯æ›´åŠ è§„å¾‹ï¼ŒåŒæ—¶èº«ä½“ç´ è´¨ä¹Ÿæ˜¯è‚‰çœ¼å¯è§çš„æå‡ã€‚</p><ul><li>è‡ªé‡å¼•ä½“ä»ä¸€ä¸ªä¸èƒ½åš-&gt;åæ¡-&gt;å¯¹æ¡-&gt;æ­£æ¡-&gt;æ­£æ¡åšç»„</li><li>ä¿¯å§æ’‘ä» 5 ä¸ª-&gt;10ä¸ª&#x2F;ç»„-&gt;15ä¸ª&#x2F;ç»„-&gt;25ä¸ª&#x2F;ç»„-&gt;ä¸€æ¬¡æœ€å¤šåš 40 ä¸ª-&gt;é’»çŸ³ä¿¯å§æ’‘ 15&#x2F;ç»„</li></ul><p>å…¶ä½™çš„å°±æ˜¯èƒ¸è‚Œæœ‰äº›è½®å»“ã€è‚©éƒ¨ä¹Ÿæ¯”ä»¥å¾€æ›´åœ†æ¶¦ä¸€äº›ï¼Œè…¹è‚Œåœ¨æŸäº›ç‰¹å®šè§’åº¦ä¹Ÿå¯ä»¥è‹¥éšè‹¥ç°ï¼ˆå½“ç„¶è¿™ä¸ªå¾—ä½“è„‚è¶³å¤Ÿä½æ‰è¡Œï¼‰ï¼Œä»Šå¹´çš„ä¸»è¦ç›®æ ‡æ˜¯ä¸ŠåŠå¹´è®¤çœŸåˆ·åˆ·è„‚ã€‚</p><h1 id="å·¥ä½œ"><a href="#å·¥ä½œ" class="headerlink" title="å·¥ä½œ"></a>å·¥ä½œ</h1><p>å·¥ä½œä»Šå¹´å¤§ä½“ä¸Šæ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œä½†ç»æµä¸æ™¯æ°”åº”è¯¥æ¯ä¸ªäººéƒ½èƒ½æ„Ÿå—åˆ°ï¼›ç›®å‰æˆ‘èƒ½è‹Ÿç€çš„åŒæ—¶è¿˜èƒ½å­¦ä¸€äº›è‡ªå·±æ„Ÿå…´è¶£çš„ä¸œè¥¿å°±éå¸¸æ»¡è¶³äº†ã€‚</p><p><img src="https://s2.loli.net/2024/02/18/yoqsN3S1LWalw8P.png"></p><blockquote><p>åˆ°ç°åœ¨ä¾ç„¶å¾ˆæ€€æ‹åœ¨ä¸Šå®¶å…¬å¸çš„æ—¥å­ã€‚</p></blockquote><p>ä»Šå¹´åœ¨å…¬å¸ä¸»è¦è¿˜æ˜¯ç»´æŠ¤ Pulsarï¼ŒåŒæ—¶ä¹Ÿç»™ç¤¾åŒºè´¡çŒ®äº†ä¸€äº›ä»£ç ï¼Œç®—æ˜¯è¿™ä¹ˆäº›å¹´æ¥æœ€è®¤çœŸå‚ä¸å¼€æºçš„ä¸€å¹´ã€‚</p><p>æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹ä¹‹å‰å†™çš„æ–‡ç« ï¼š</p><ul><li><a href="https://crossoverjie.top/2023/12/21/ob/Pulsar%20Proposal/">å¦‚ä½•ç»™å¼€æºé¡¹ç›®å‘èµ·ææ¡ˆ</a></li><li><a href="https://crossoverjie.top/2023/08/05/ob/novice-contribute-open-source/">æ–°æ‰‹å¦‚ä½•å¿«é€Ÿå‚ä¸å¼€æºé¡¹ç›®</a></li></ul><p>ç›¸æ¯”æˆ‘ä»¥å‰çš„å·¥ä½œæ¥è¯´ï¼Œç°åœ¨çš„å²—ä½æ˜¯åŸºç¡€æ¶æ„ï¼Œæ‰€ä»¥æ¥è§¦çš„å‡ ä¹éƒ½æ˜¯ä¸€äº›å¼€æºäº§å“ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä¸ªäººæ„Ÿå…´è¶£çš„æ–¹å‘ã€‚</p><p>æ‰€ä»¥è™½ç„¶åŒäº‹ä¹‹é—´çš„äº¤æµæ²¡æœ‰ä¹‹å‰çš„å…¬å¸é‚£ä¹ˆé¢‘ç¹ï¼ˆæˆ‘ä»¬éƒ¨é—¨å’Œä¸šåŠ¡å›¢é˜Ÿåœ¨ä¸åŒçš„åŸå¸‚ï¼‰ï¼Œä½†å› ä¸ºç”±å…´è¶£é©±åŠ¨ï¼Œæ‰€ä»¥ä¹Ÿæ²¡é‚£ä¹ˆæ¯ç‡¥ã€‚</p><h2 id="è‹±è¯­"><a href="#è‹±è¯­" class="headerlink" title="è‹±è¯­"></a>è‹±è¯­</h2><p>å¯¹äº†ï¼Œå¹´ä¸­çš„æ—¶å€™è¿˜å¤´è„‘å‘çƒ­å»æŠ¥äº†ä¸€ä¸ªè‹±è¯­çº¿ä¸‹åŸ¹è®­ç­ï¼Œä¸Šäº†ä¸¤æœˆåå‘ç°é™¤éæ˜¯è¿ç»­æ¯å¤©ä¸Š 8 å°æ—¶çªå‡»å‡ ä¸ªæœˆï¼Œä¸ç„¶åˆ«æƒ³ä¸€ä¸‹å­é€Ÿæˆã€‚</p><p>å¹³æ—¶æ²¡æœ‰ä½¿ç”¨è‹±è¯­çš„ç¯å¢ƒï¼Œé‚£å°±åªèƒ½è‡ªå·±åˆ›é€ äº†ï¼Œæˆ‘ç°åœ¨ä¼šåšæŒæ¯å¤©çœ‹ä¸€ä¸ªæ²¹ç®¡çš„ç§‘æŠ€è§†é¢‘ï¼Œç›®å‰çœ‹ç”Ÿè‚‰æœ‰å­—å¹•çš„æƒ…å†µä¸‹å‹‰å¼ºå¯ä»¥ç†è§£ã€‚</p><p>åŒæ—¶åˆå› ä¸ºä»Šå¹´é•¿æœŸéƒ½åœ¨æ°´å¼€æºç¤¾åŒºï¼Œå¯¼è‡´æˆ‘ç°åœ¨çœ‹è‹±æ–‡æ–‡æ¡£ã€é‚®ä»¶ä¹‹ç±»çš„ä¸å€ŸåŠ©ç¿»è¯‘ä¹Ÿæ²¡é‚£ä¹ˆåƒåŠ›ï¼Œç®—æ˜¯å¼€äº†ä¸€ä¸ªå¥½å¤´ã€‚</p><p>ä»Šå¹´äº‰å–å†å¤šå¬å¬è‹±æ–‡æ’­å®¢ï¼Œè™½ç„¶æš‚æ—¶æ— æ³•é€šè¿‡è‹±è¯­æ‰¾åˆ°è¿œç¨‹å·¥ä½œï¼Œä½†åˆ©ç”¨è‹±æ–‡ç¡®å®å¯ä»¥æ‰“å¼€æ–°ä¸–ç•Œã€‚</p><h2 id="æ’­å®¢"><a href="#æ’­å®¢" class="headerlink" title="æ’­å®¢"></a>æ’­å®¢</h2><p><img src="https://s2.loli.net/2024/02/20/wMLS5luy8HDKerf.jpg"><br>ä»Šå¹´ç®—æ˜¯æ’­å®¢çš„é‡åº¦ç”¨æˆ·ï¼Œå…¶å®å¬æ’­å®¢çš„ä¹ æƒ¯å‰å‡ å¹´å°±æœ‰äº†ï¼Œä½†é‚£æ—¶å€™å¤§éƒ¨åˆ†æ˜¯å†å¼€è½¦çš„æ—¶å€™å¬ï¼Œä»Šå¹´å› ä¸ºæ¯å¤©æœ‰1~2å°æ—¶çš„å¥èº«æ—¶é—´ï¼Œæ‰€ä»¥å¥èº«çš„æ—¶å€™å‡ ä¹éƒ½æ˜¯å¬æ’­å®¢è¿‡æ¥çš„ã€‚</p><p>ä¸ªäººè§‰å¾—æ’­å®¢æ˜¯éå¸¸å¥½çš„å†…å®¹è¾“å…¥æºï¼Œæ¯”å¾ˆå¤šè§†é¢‘å†…å®¹çš„è´¨é‡è¿˜é«˜ï¼›è¿™é‡Œæ¨èå‡ ä¸ªæˆ‘å¸¸å¬çš„é¢‘é“ï¼š</p><ul><li>æ«è¨€æ«è¯­</li><li>ç¡¬åœ°éª‡å®¢</li><li>çˆ±å¦ç§‘æŠ€</li><li>å¼€æºé¢å¯¹é¢</li><li>æ•è›‡è€…è¯´</li><li>çš®è›‹æ¼«æ¸¸è®°ç­‰</li></ul><h2 id="å‰¯ä¸š"><a href="#å‰¯ä¸š" class="headerlink" title="å‰¯ä¸š"></a>å‰¯ä¸š</h2><p>åœ¨å¹´åº•çš„æ—¶å€™æ— æ„é—´åˆ©ç”¨ Pulsar å®Œæˆäº†æˆ‘äººç”Ÿçš„ç¬¬ä¸€ç¬”å’¨è¯¢æœåŠ¡ï¼Œå½“æ—¶è¿˜å‘äº†ä¸ªæœ‹å‹åœˆã€‚<br><img src="https://s2.loli.net/2024/02/18/d6PnUej5DSrJZ8R.png" alt="image.png"><br>æ²¡æƒ³åˆ°ä¹‹ååˆæœ‰ä¸ªæœ‹å‹æ¥å’¨è¯¢äº†ä¸€äº›å…³äºèŒåœºçš„é—®é¢˜ï¼Œå®Œäº‹åå®¢æˆ·æ»¡æ„åº¦è¿˜æŒºé«˜ã€‚</p><p>äºæ˜¯æˆ‘ä»Šå¹´ä¹Ÿå‡†å¤‡å¥½å¥½ç­¹å¤‡ä¸‹ï¼Œè¯´ä¸å®šçœŸèƒ½åšæˆä¸€ä¸ªå‰¯ä¸šã€‚</p><blockquote><p>æ‰“ä¸ªå¹¿å‘Šï¼Œæ„Ÿå…´è¶£çš„ä¹Ÿå¯ä»¥ç§èŠã€‚</p></blockquote><hr><p>å¹´åº•è¿˜å¥½è¿è·å¾—äº†æ˜é‡‘çš„<a href="https://juejin.cn/post/7328012551756464139">ç­¾çº¦</a>èµ„æ ¼ï¼š<br><img src="https://s2.loli.net/2024/02/18/25xMEJANaRIbHgP.png"><br>æˆ‘ç®—æ˜¯æ˜é‡‘æœ€æ—©ä¸€æ‰¹ç”¨æˆ·äº†ï¼Œè®°å¾—æ˜¯ 16 å¹´å°±å¼€å§‹åœ¨ä¸Šé¢å‘å¸ƒæ–‡ç« ï¼Œè¿™ä¹Ÿæ˜¯é•¿æœŸåšæŒè·å¾—çš„è‚¯å®šã€‚</p><p>è€Œä¸”æ˜é‡‘ç”±äºè¢«å­—èŠ‚æ”¶è´­åèµ„é‡‘æ˜æ˜¾æ¯”å‰å‡ å¹´å®½è£•ï¼Œå‚ä¸è¿‡å‡ æ¬¡å¾æ–‡æ´»åŠ¨è¿˜æ˜¯æ”¶è·äº†ä¸€äº›ç°é‡‘å¥–åŠ±ã€‚</p><p>ç°åœ¨å’Œæ˜é‡‘ç­¾çº¦åè¿˜èƒ½è·å¾—æ›´å¤šçš„ç°é‡‘å’Œæµé‡å¥–åŠ±ï¼Œå¯¹ä½œè€…å’Œå¹³å°æ¥è¯´éƒ½æ˜¯åŒèµ¢ï¼Œåªæ˜¯ä»Šåçš„æ–‡ç« éœ€è¦å…ˆåœ¨æ˜é‡‘å‘å¸ƒä¸‰ä¸ªæœˆåæ‰å¯ä»¥åŒæ­¥åˆ°å…¶ä»–å¹³å°ã€‚</p><p>æ‰€ä»¥æ˜é‡‘è¿˜æ²¡å…³æ³¨çš„æˆ‘çš„æœ‹å‹èµ¶ç´§å…³æ³¨ä¸€æ³¢å§ï¼š<br><a href="https://juejin.cn/user/835284565229597">https://juejin.cn/user/835284565229597</a></p><h1 id="æŠ€èƒ½"><a href="#æŠ€èƒ½" class="headerlink" title="æŠ€èƒ½"></a>æŠ€èƒ½</h1><p>æŠ€èƒ½ä¸Šé™¤äº†åˆšæ‰åœ¨å·¥ä½œä¸­æåˆ°çš„ Pulsar å¤–è¿˜é¢å¤–å­¦ä¹ äº†ï¼š</p><ul><li><code>VictoriaMetrics</code> å…¥é—¨åˆ°å®‰è£…<ul><li><code>VictoriaLog</code> ä¸€ä¸ªæ–°çš„æ—¥å¿—å­˜å‚¨æ•°æ®åº“ï¼Œä¹‹å‰ä¹Ÿå†™è¿‡ä¸€ç¯‡ä»‹ç»ä½¿ç”¨<a href="https://crossoverjie.top/2023/08/23/ob/VictoriaLogs-Intro/">æ–‡ç« </a>ã€‚</li><li>è¿˜ç»™ <code>VictoriaLog</code> åšè¿‡ä¸€ç‚¹è´¡çŒ®ã€‚</li></ul></li><li>Grafana æ›´ç†Ÿç»ƒäº†</li><li>kubernetes çš„ä¸€äº›çŸ¥è¯†ç‚¹ä¹Ÿæ•°é‡äº†ï¼Œå†™è¿‡å‡ ä¸ªå°å·¥å…·ï¼š<ul><li><a href="https://crossoverjie.top/2023/10/19/ob/k8s-restart-pod/">ä¼˜é›…é‡å¯ Pod</a></li><li>æ‰¹é‡æ›¿æ¢åº”ç”¨é•œåƒ</li></ul></li><li>Istio çš„åº”ç”¨ï¼ŒåŒ…å«ç½‘å…³å’ŒæœåŠ¡è°ƒç”¨ç­‰</li><li>åœ¨å…¬å¸å†…éƒ¨åšè¿‡ä¸¤æ¬¡åˆ†äº«ï¼ˆå…³äº Pulsar å’Œå¼€æºçš„å†…å®¹ï¼‰</li><li>å¹´åº•çš„æ—¶å€™è¿˜å†™è¿‡ä¸€ä¸ª <code>OTel</code> çš„ <code>extension</code>ï¼Œç†Ÿæ‚‰äº† <code>OTel</code> çš„ä¸€äº›æ¦‚å¿µå’Œå®è·µã€‚</li></ul><p><img src="https://s2.loli.net/2024/02/21/kYTHJLrnVmvlxMB.png"><br>ä»ä»Šå¹´é•¿æœŸä½¿ç”¨çš„ tag æ¥çœ‹ï¼Œæœç„¶è¿˜æ˜¯ <code>Pulsar</code> å’Œ <code>kubernetes</code> ä½¿ç”¨çš„æœ€å¤šã€‚</p><h2 id="åšå®¢"><a href="#åšå®¢" class="headerlink" title="åšå®¢"></a>åšå®¢</h2><p><img src="https://s2.loli.net/2024/02/20/B2kATswN7ZGQSzd.png"><br>ä»Šå¹´çš„åšå®¢æ•°æ®äº§é‡ç®—æ˜¯æ¯”è¾ƒå¤šçš„äº†ï¼Œç¡®å®ä¹Ÿæ˜¯æœ‰æˆ‘å·¥ä½œçš„å…³ç³»ï¼Œå¹³æ—¶æ¥è§¦åˆ°çš„å¤§éƒ¨åˆ†éƒ½æ˜¯äº›æŠ€æœ¯é—®é¢˜ï¼Œæ‰€ä»¥èƒ½å†™çš„ä¸œè¥¿ä¹Ÿå°±æ¯”è¾ƒå¤šäº†ã€‚</p><p>åŒæ—¶ä¹Ÿå†å°è¯•æ¯å‘¨å‘å¸ƒæŠ€æœ¯å‘¨åˆŠï¼š<br><img src="https://s2.loli.net/2024/02/20/B1zoHZUNd6iKw48.png"></p><p>ç›®å‰å‘äº†åå‡ æœŸï¼Œæ•ˆæœä¸é”™ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ä¸€äº›è‹±æ–‡æ–‡ç« ï¼Œè‡ªå·±ä¹Ÿèƒ½å­¦åˆ°ä¸€äº›ä¸œè¥¿ã€‚</p><h2 id="å¼€æº"><a href="#å¼€æº" class="headerlink" title="å¼€æº"></a>å¼€æº</h2><p>ä¹‹å‰ä¹Ÿæåˆ°äº†ä»Šå¹´ç®—æ˜¯æˆ‘æ¯”è¾ƒæ·±å…¥çš„å‚ä¸å¼€æºé¡¹ç›®ï¼Œä»¥å¾€å¤§éƒ¨åˆ†éƒ½æ˜¯å‘å¸ƒä¸€äº›ä¸ªäººä½œå“ï¼Œå½“ç„¶ä¹Ÿæœ‰ç»™ä¸€äº›ä¸ªäººæˆ–è€…å°é¡¹ç›®æè¿‡ PRï¼Œç°åœ¨çœ‹æ¥å¤šå°‘æœ‰ç‚¹â€å°æ‰“å°é—¹â€œäº†ã€‚</p><p><img src="https://s2.loli.net/2024/02/20/y84mXRtDJYz7HuG.png"><br>å› ä¸ºåœ¨å…¬å¸ä¸»è¦ç»´æŠ¤ Pulsarï¼Œæ‰€ä»¥ä¸å¯é¿å…çš„å°±éœ€è¦å’Œç¤¾åŒºæ²Ÿé€šï¼Œä¸ç®¡æ˜¯åé¦ˆ Bug è¿˜æ˜¯ä¿®å¤é—®é¢˜æµç¨‹éƒ½æ¯”ä»¥å¾€æ­£è§„ï¼Œæ¯•ç«Ÿè¿™ä¹Ÿæ˜¯ä¸€ä¸ª Apache é¡¶çº§é¡¹ç›®ã€‚</p><p><img src="https://s2.loli.net/2024/02/20/IZKxknlzdO9Gcys.png"></p><p>ä¸»è¦æ´»è·ƒçš„æ˜¯ <a href="https://github.com/apache/pulsar/pulls?q=is:pr+sort:updated-desc+author:crossoverJie+is:merged">Pulsar</a> ä¸»ä»“åº“ï¼Œåˆå¹¶äº† 14 ä¸ª PRã€‚</p><p><img src="https://s2.loli.net/2024/02/20/xbmp8hLZnCkBuMR.png"></p><p>å…¶æ¬¡æ˜¯ <a href="https://github.com/apache/pulsar-client-go/pulls?q=is:pr+sort:updated-desc+author:crossoverJie+is:merged">pulsar-client-go</a> ä¹Ÿå°±æ˜¯ Pulsar çš„ Go å®¢æˆ·ç«¯ï¼Œåˆå¹¶äº† 6 ä¸ª PRã€‚</p><hr><p><img src="https://s2.loli.net/2024/02/20/vpfMGde6gq4hsRm.png"></p><p><img src="https://s2.loli.net/2024/02/20/83zZDhX9arGu6Yo.jpg"></p><p>ç„¶åæ˜¯ <code>VictoriaMetrics</code>ï¼Œå…¶å®ä¸»è¦å°±æ˜¯ç»™ä»–ä»¬æ–°å‘å¸ƒçš„ <code>VictoriaLogs</code> ä¿®äº†ä¸ª Bugï¼Œä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡è¢«å•ç‹¬æåŠçš„è´¡çŒ®ã€‚</p><hr><p>æœ€åå°±æ˜¯å¹´åº•çš„æ—¶å€™åœ¨ä¸€ä¸ªåšå¯è§‚æµ‹æ€§å¤§ä½¬çš„å…¬ä¼—å·ä¸‹çœ‹åˆ°çš„é¡¹ç›®ï¼š<a href="https://github.com/cprobe/cprobe/">cprobe</a></p><p><img src="https://s2.loli.net/2024/02/20/luc9yaMvW18wHdF.png"><br>ä¸»è¦æ˜¯è´¡çŒ®äº†ä¸€ä¸ª helm å®‰è£…ä»“åº“ä»¥åŠå‡ ä¸ªæ’ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹æ–°æ‰‹å¾ˆå‹å¥½çš„é¡¹ç›®ï¼Œå¯¹å¼€æºæ„Ÿå…´è¶£çš„éƒ½å¯ä»¥æ¥å‚ä¸ä¸‹ã€‚</p><p>å½“ç„¶è´¡çŒ®æ•°é‡ä¸èƒ½ä½œä¸ºè¯„åˆ¤å‚ä¸å¼€æºçš„å”¯ä¸€æ ‡å‡†ï¼Œä½†ç¡®å®æ¯”è¾ƒå¥½é‡åŒ–çš„æŒ‡æ ‡ï¼Œä»Šå¹´åŠ æ²¹ç»§ç»­è´¡çŒ®ã€‚</p><h1 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h1><p>åˆåˆ°äº†ç»™å¾€å¹´æ‰“åˆ†çš„ç¯èŠ‚äº†ï¼š<br><img src="https://s2.loli.net/2024/02/21/Flfrmn4Tp6qYVWI.png"></p><p>å»å¹´ç®—æ˜¯å®Œæˆäº† 60%ï¼Œä»Šå¹´çš„å®šä¸€äº›å®¹æ˜“å®ç°çš„ç›®æ ‡ï¼š</p><ul><li>å§æ¨ 80kg</li><li>ä½“è„‚ä¿æŒåœ¨ 13% å·¦å³ï¼ˆè¯¯å·®ä¸èƒ½å¤šäº 2ï¼‰</li><li>å»æµ·å¤–ç©ä¼°è®¡æœ‰ç‚¹éš¾åº¦ï¼Œé‚£å°±å…ˆå®šå›½å†…å§ï¼Œå“ªé‡Œéƒ½è¡Œ.</li><li>å¹´åº•å¼€æºç¤¾åŒºäº‰å–æåä¸€ä¸ª Committer</li><li>è‹±è¯­å¯ä»¥è¾¾åˆ°ç”Ÿè‚‰æ²¹ç®¡çš„ç¨‹åº¦</li><li>åšä¸€ä¸ªå‰¯ä¸šè¯•è¯•</li></ul><h2 id="å¾€å¹´è®°å½•"><a href="#å¾€å¹´è®°å½•" class="headerlink" title="å¾€å¹´è®°å½•"></a>å¾€å¹´è®°å½•</h2><ul><li><a href="https://crossoverjie.top/2023/01/18/annual-summary/2022/">2022</a></li><li><a href="https://crossoverjie.top/2022/01/27/annual-summary/2021/">2021</a></li><li><a href="https://crossoverjie.top/2021/03/02/annual-summary/2020/">2020</a></li><li><a href="https://crossoverjie.top/2019/12/30/annual-summary/2019/">2019</a></li><li><a href="https://crossoverjie.top/2018/12/30/annual-summary/2018/">2018</a></li><li><a href="https://crossoverjie.top/2018/12/30/annual-summary/2018/">2016</a></li></ul><blockquote><p><strong>é•¿å›¾é¢„è­¦</strong></p></blockquote><p><img src="https://s2.loli.net/2024/02/17/8Tl19muAntiXg4a.jpg"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»Šå¤©æ˜¯æ˜¥èŠ‚çš„æœ€åä¸€å¤©ï¼Œå› ä¸ºå·¥ä½œä¸Šä¸´æ—¶æœ‰ç‚¹äº‹ï¼Œå¾ˆä¸æƒ…æ„¿çš„æ‰“å¼€ç”µè„‘çœ‹ç€ä¹Ÿå°± 10 å¤©æ²¡çœ‹ä»£ç è§‰å¾—éå¸¸é™Œç”Ÿã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="annual-summary" scheme="http://crossoverjie.top/categories/annual-summary/"/>
    
    
  </entry>
  
  <entry>
    <title>ã€è¯‘ã€‘Apache Pulsar 2023 å¹´åº¦å›é¡¾</title>
    <link href="http://crossoverjie.top/2024/01/26/ob/translate-pulsar-2023-year-in-review/"/>
    <id>http://crossoverjie.top/2024/01/26/ob/translate-pulsar-2023-year-in-review/</id>
    <published>2024-01-26T02:37:24.000Z</published>
    <updated>2024-01-26T06:58:04.544Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://pulsar.apache.org/blog/2024/01/12/pulsar-2023-year-in-review/">åŸæ–‡é“¾æ¥</a><br>å‰ä¸¤å¤© Pulsar ç¤¾åŒºå‘å¸ƒäº† 2023 å¹´å¹´åº¦å›é¡¾ï¼Œå»å¹´æˆ‘ä¹ŸèŠ±äº†ä¸€äº›æ—¶é—´å‚ä¸ç¤¾åŒºï¼Œæ‰€ä»¥å…¶ä¸­ä¸€äº›å†…å®¹æ„Ÿå—æŒºæ˜æ˜¾çš„ï¼Œä»¥ä¸‹å°±æ˜¯å¯¹ä¸€äº›é‡ç‚¹å†…å®¹çš„æç‚¼ã€‚</p><span id="more"></span><p>2023 å¹´æ˜¯ä¸€ä¸ªé‡è¦çš„é‡Œç¨‹ç¢‘ï¼Œå‚ä¸<a href="https://github.com/apache/pulsar">ä¸»ä»“åº“</a>è´¡çŒ®çš„å¼€å‘è€…è¾¾åˆ°äº† 600 ä½ã€‚<br>è‡ªä» Pulsar ä» 2018 æ¯•ä¸šæˆä¸º Apache é¡¶çº§é¡¹ç›®è‡³ä»Šä¸€å…±åˆ 12K+ çš„ä»£ç æäº¤æ¬¡æ•°ã€639 ä½è´¡çŒ®è€…ã€12.2k starã€3.5k forkã€10k+ çš„ slack ç”¨æˆ·ã€‚</p><h1 id="2023-é«˜å…‰æ—¶åˆ»"><a href="#2023-é«˜å…‰æ—¶åˆ»" class="headerlink" title="2023 é«˜å…‰æ—¶åˆ»"></a>2023 é«˜å…‰æ—¶åˆ»</h1><h2 id="ç¬¬ä¸€ä¸ª-LTS-3-0-é‡Œç¨‹ç¢‘ç‰ˆæœ¬"><a href="#ç¬¬ä¸€ä¸ª-LTS-3-0-é‡Œç¨‹ç¢‘ç‰ˆæœ¬" class="headerlink" title="ç¬¬ä¸€ä¸ª LTS 3.0 é‡Œç¨‹ç¢‘ç‰ˆæœ¬"></a>ç¬¬ä¸€ä¸ª LTS 3.0 é‡Œç¨‹ç¢‘ç‰ˆæœ¬</h2><p><img src="https://s2.loli.net/2024/01/26/BRvYSLPOnxoQ614.png"><br>ç¤¾åŒºå‘å¸ƒ Apache Pulsar 3.0ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªé•¿æœŸæ”¯æŒ ï¼ˆLTSï¼‰ ç‰ˆæœ¬ï¼Œä» Pulsar 3.0 å¼€å§‹ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒç”¨æˆ·å¯¹ç¨³å®šæ€§å’Œæ–°åŠŸèƒ½çš„éœ€æ±‚ï¼ŒåŒæ—¶å‡è½»ç»´æŠ¤å†å²ç‰ˆæœ¬çš„è´Ÿæ‹…ã€‚</p><p>ä»¥å¾€çš„ç‰ˆæœ¬å‘å¸ƒå‘¨æœŸå¾ˆçŸ­ï¼Œä¸€èˆ¬æ˜¯ 3ï½4 ä¸ªæœˆï¼Œä¸ºäº†å¯ä»¥è·Ÿä¸Šç¤¾åŒºæ–°ç‰ˆï¼Œå¾€å¾€éœ€è¦ä¸åœçš„å‡çº§ï¼Œå¯¹ç»´æŠ¤ä¸­çš„è´Ÿæ‹…è¾ƒå¤§ã€‚</p><p>ä»Šåçš„ç»´æŠ¤æ—¶é—´è¡¨å¦‚ä¸Šå›¾ï¼Œä»¥ç¨³å®šä¸ºä¸»çš„å›¢é˜Ÿå¯ä»¥é€‰æ‹© LTS ç‰ˆæœ¬ï¼Œè¿½æ±‚æ–°åŠŸèƒ½çš„å›¢é˜Ÿå¯ä»¥é€‰æ‹© feature ç‰ˆæœ¬ã€‚</p><h2 id="æ–°çš„å®˜æ–¹ç½‘ç«™"><a href="#æ–°çš„å®˜æ–¹ç½‘ç«™" class="headerlink" title="æ–°çš„å®˜æ–¹ç½‘ç«™"></a>æ–°çš„å®˜æ–¹ç½‘ç«™</h2><p><a href="https://pulsar.apache.org/">https://pulsar.apache.org/</a>å®˜æ–¹ç½‘ç«™å¾—åˆ°äº†æ–°çš„è®¾è®¡ã€‚</p><h2 id="Pulsar-Admin-Go-Library"><a href="#Pulsar-Admin-Go-Library" class="headerlink" title="Pulsar Admin Go Library"></a>Pulsar Admin Go Library</h2><p>æä¾›äº† Pulsar Admin Go çš„å®¢æˆ·ç«¯ï¼Œæ–¹ä¾¿ Go ç”¨æˆ·ç®¡ç† Pulsar èµ„æº</p><h2 id="ä½¿ç”¨-OTel-å¢å¼º-Pulsar-çš„å¯è§‚æµ‹ç³»ç»Ÿ"><a href="#ä½¿ç”¨-OTel-å¢å¼º-Pulsar-çš„å¯è§‚æµ‹ç³»ç»Ÿ" class="headerlink" title="ä½¿ç”¨ OTel å¢å¼º Pulsar çš„å¯è§‚æµ‹ç³»ç»Ÿ"></a>ä½¿ç”¨ OTel å¢å¼º Pulsar çš„å¯è§‚æµ‹ç³»ç»Ÿ</h2><p><a href="https://github.com/apache/pulsar/blob/master/pip/pip-264.md">PIP-264</a> ææ¡ˆå·²ç»è·å¾—äº†ç¤¾åŒºæ‰¹å‡†å¼€å§‹å¼€å‘ï¼Œå®ƒå°†è§£å†³ topic æ•°é‡è¾¾åˆ° 50k~100M çš„å¯è§‚æµ‹æ€§é—®é¢˜ã€‚<br>åŒæ—¶ Pulsar ç¤¾åŒºå·²ç»ä¸º OpenTelemetry æäº¤äº†ä¸¤ä¸ªç‰¹æ€§ <a href="https://github.com/open-telemetry/opentelemetry-java/issues/5105">Near-zero memory allocations</a>Â <a href="https://github.com/open-telemetry/opentelemetry-java/issues/6107">metric filtering upon collection</a> å·²ç»ä½œä¸ºäº† OpenTelemetry çš„è§„èŒƒã€‚</p><h1 id="ä¸»è¦äº‹ä»¶å›é¡¾"><a href="#ä¸»è¦äº‹ä»¶å›é¡¾" class="headerlink" title="ä¸»è¦äº‹ä»¶å›é¡¾"></a>ä¸»è¦äº‹ä»¶å›é¡¾</h1><p>2023 å¹´ï¼ŒPulsar ç¤¾åŒºåœ¨å…¨çƒèŒƒå›´å†…ä¸¾åŠäº†ä¸€ç³»åˆ—æ´»åŠ¨ã€‚</p><ul><li><a href="https://streamnative.io/blog/pulsar-virtual-summit-europe-2023-key-takeaways">Pulsar Summit Europe 2023</a></li><li><a href="https://pulsar.apache.org/blog/2023/08/28/pulsar-sessions-in-communityovercode-aisa-2023/">CommunityOverCode Asia 2023</a></li><li><a href="https://communityovercode.org/past-sessions/community-over-code-na-2023/">CommunityOverCode NA 2023</a></li><li><a href="https://streamnative.io/blog/pulsar-summit-north-america-2023-a-deep-dive-into-the-on-demand-summit-videos">Pulsar Summit NA 2023</a></li></ul><h1 id="ç¤¾åŒºæˆé•¿"><a href="#ç¤¾åŒºæˆé•¿" class="headerlink" title="ç¤¾åŒºæˆé•¿"></a>ç¤¾åŒºæˆé•¿</h1><p>æ²¡æœ‰è´¡çŒ®è€…ç¤¾åŒºå¾ˆéš¾å‘å±•ï¼Œ2023å¹´åŠ å…¥äº†è®¸å¤šæ–°é¢å­”ã€‚</p><ul><li>639 ä½è´¡çŒ®è€…</li><li>13.4k Github star</li><li>3.5k fork</li><li>æ–°å¢ 8 ä½ Committers</li><li>æ–°å¢ 6 ä½ PMC</li><li>10k+ slack ç”¨æˆ·</li><li>20M+ docker pulls</li></ul><h1 id="é¡¹ç›®å‘å¸ƒ"><a href="#é¡¹ç›®å‘å¸ƒ" class="headerlink" title="é¡¹ç›®å‘å¸ƒ"></a>é¡¹ç›®å‘å¸ƒ</h1><p>2023å¹´ï¼Œç¤¾åŒºå‘å¸ƒäº†ä¸¤ä¸ª major version å’Œ 12 ä¸ª minor version ç‰ˆæœ¬ï¼›æœ€å¤§çš„é‡Œç¨‹ç¢‘ä¾ç„¶æ˜¯å‘å¸ƒäº†é¦–ä¸ª LTS ç‰ˆæœ¬ <a href="https://pulsar.apache.org/blog/2023/05/02/announcing-apache-pulsar-3-0/">Pulsar3.0</a>ã€‚<br>è¶…è¿‡äº† 140 ä¸ªè´¡çŒ®è€…æäº¤äº†å¤§çº¦ 1500 æ¬¡æäº¤ã€‚</p><p>åŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸€äº›é‡è¦çš„ç‰¹æ€§ï¼Œæ¯”å¦‚æ–°ç‰ˆæœ¬çš„<a href="https://github.com/apache/pulsar/issues/16691">è´Ÿè½½å‡è¡¡å™¨</a>ï¼Œ<a href="https://github.com/apache/pulsar/issues/16763">å¤§è§„æ¨¡çš„å»¶æ—¶æ¶ˆæ¯æ”¯æŒ</a>ã€‚</p><p>æ›´æ–°äº†ä»¥ä¸‹ä¸€äº›å®¢æˆ·ç«¯ï¼š</p><ul><li><a href="https://github.com/apache/pulsar-client-cpp/releases/tag/v3.4.2">Pulsar C++ Client 3.4.2</a></li><li><a href="https://github.com/apache/pulsar-client-go/releases/tag/v0.11.1">Pulsar Go Client 0.11.1</a></li><li><a href="https://github.com/apache/pulsar-client-node/releases/tag/v1.9.0">Pulsar Node.js Client 1.9.0</a></li><li><a href="https://github.com/apache/pulsar-client-python/releases/tag/v3.3.0">Pulsar Python Client 3.3.0</a></li><li><a href="https://github.com/apache/pulsar-manager/releases/tag/v0.4.0">Pulsar Manager 0.4.0</a></li><li><a href="https://github.com/apache/pulsar-helm-chart/releases/tag/pulsar-3.1.0">Pulsar Helm Chart 3.1.0</a></li><li><a href="https://github.com/apache/pulsar-dotpulsar/blob/master/CHANGELOG.md#311---2023-12-11">Pulsar dotnet Client 3.1.1</a></li><li><a href="https://github.com/apache/pulsar-client-reactive/releases/tag/v0.5.1">Reactive Client for Apache Pulsar 0.1.0</a></li></ul><h1 id="ç”Ÿæ€ç³»ç»Ÿ"><a href="#ç”Ÿæ€ç³»ç»Ÿ" class="headerlink" title="ç”Ÿæ€ç³»ç»Ÿ"></a>ç”Ÿæ€ç³»ç»Ÿ</h1><p>2023 å¹´Pulsar ç¤¾åŒºä¹Ÿä¸å¤šä¸ªå¼€æºé¡¹ç›®è¿›è¡Œäº†é›†æˆï¼š</p><ul><li><a href="https://quarkus.io/guides/pulsar">Quarkus Extension for Apache Pulsar</a>ï¼Œé€šè¿‡äº‹ä»¶é©±åŠ¨åœ¨ Quarkus ä½¿ç”¨ Pulsarã€‚</li><li><a href="https://spring.io/blog/2023/11/21/spring-for-apache-pulsar-1-0-0-goes-ga/">Spring for Apache Pulsar</a> æä¾›äº† PulsarTemplate ç”¨äºç”Ÿäº§æ¶ˆæ¯ï¼ŒPulsarListener æ³¨è§£å¯ä»¥æ–¹ä¾¿çš„æ¶ˆè´¹æ¶ˆæ¯ï¼Œåœ¨ spring ç”Ÿæ€ä¸‹æ›´å®¹æ˜“é›†æˆ Pulsar</li><li><a href="https://github.com/streamnative/oxia">Oxia</a>:å¯ä»¥ä½¿ç”¨ Oxia æåˆ° zookeeper ä»è€Œçªç ´ Pulsar æ”¯æŒ 1M topic çš„é™åˆ¶ã€‚</li></ul><h1 id="2024å¹´è®¡åˆ’"><a href="#2024å¹´è®¡åˆ’" class="headerlink" title="2024å¹´è®¡åˆ’"></a>2024å¹´è®¡åˆ’</h1><h2 id="OTel"><a href="#OTel" class="headerlink" title="OTel"></a>OTel</h2><p>ç»§ç»­æ¨è¿›ä½¿ç”¨ OpenTelemetry æ›¿æ¢ç°æœ‰çš„å¯è§‚æµ‹æ€§ç³»ç»Ÿ</p><h2 id="é™æµé‡æ„"><a href="#é™æµé‡æ„" class="headerlink" title="é™æµé‡æ„"></a>é™æµé‡æ„</h2><p><a href="https://github.com/apache/pulsar/blob/master/pip/pip-322.md">PIP-322 Pulsar Rate Limiting Refactoring</a>é™æµé‡æ„å·²ç»è¢«åˆå¹¶ï¼Œå°†åœ¨ 3.2 ç‰ˆæœ¬ä¸­å‘å¸ƒã€‚</p><h2 id="ç§»é™¤-Pulsar-SQL-æ¨¡å—"><a href="#ç§»é™¤-Pulsar-SQL-æ¨¡å—" class="headerlink" title="ç§»é™¤ Pulsar SQL æ¨¡å—"></a>ç§»é™¤ Pulsar SQL æ¨¡å—</h2><p>å°† SQL æ¨¡å—ç§»é™¤åæœ‰æ•ˆçš„å‡å°‘äº†é•œåƒå¤§å°ä»¥åŠæ„å»ºæ—¶é—´ã€‚</p><h2 id="äº‹ä»¶"><a href="#äº‹ä»¶" class="headerlink" title="äº‹ä»¶"></a>äº‹ä»¶</h2><p>2024 å¹´å°†ä¼šç»§ç»­ä¸¾åŠæ´»åŠ¨ï¼ŒåŒ…æ‹¬ Pulsar Summit North America å’Œ Pulsar Summit APACã€‚<a href="https://youtube.com/playlist?list=PLqRma1oIkcWhOZ6W-g4D_3JNxJzYnwLNX&si=o6G-fRcNgW9zqHGa">åœ¨è¿™é‡Œå¯ä»¥æŸ¥çœ‹ä»¥å¾€çš„æ´»åŠ¨</a>ã€‚</p><p>ğŸ”—å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://youtube.com/playlist?list=PLqRma1oIkcWhOZ6W-g4D_3JNxJzYnwLNX&amp;si=o6G-fRcNgW9zqHGa">https://youtube.com/playlist?list=PLqRma1oIkcWhOZ6W-g4D_3JNxJzYnwLNX&amp;si=o6G-fRcNgW9zqHGa</a></li><li><a href="https://github.com/apache/pulsar/wiki/Community-Meetings">https://github.com/apache/pulsar/wiki/Community-Meetings</a></li><li><a href="https://pulsar.apache.org/blog/2024/01/12/pulsar-2023-year-in-review/">https://pulsar.apache.org/blog/2024/01/12/pulsar-2023-year-in-review/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://pulsar.apache.org/blog/2024/01/12/pulsar-2023-year-in-review/&quot;&gt;åŸæ–‡é“¾æ¥&lt;/a&gt;&lt;br&gt;å‰ä¸¤å¤© Pulsar ç¤¾åŒºå‘å¸ƒäº† 2023 å¹´å¹´åº¦å›é¡¾ï¼Œå»å¹´æˆ‘ä¹ŸèŠ±äº†ä¸€äº›æ—¶é—´å‚ä¸ç¤¾åŒºï¼Œæ‰€ä»¥å…¶ä¸­ä¸€äº›å†…å®¹æ„Ÿå—æŒºæ˜æ˜¾çš„ï¼Œä»¥ä¸‹å°±æ˜¯å¯¹ä¸€äº›é‡ç‚¹å†…å®¹çš„æç‚¼ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/tags/Pulsar/"/>
    
  </entry>
  
</feed>
