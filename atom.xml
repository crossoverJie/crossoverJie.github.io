<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>crossoverJie&#39;s Blog</title>
  
  <subtitle>baller</subtitle>
  <link href="http://crossoverjie.top/atom.xml" rel="self"/>
  
  <link href="http://crossoverjie.top/"/>
  <updated>2025-01-02T06:04:30.164Z</updated>
  <id>http://crossoverjie.top/</id>
  
  <author>
    <name>crossoverJie</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>k8s-monitor-pod</title>
    <link href="http://crossoverjie.top/2025/01/02/ob/k8s-monitor-pod/"/>
    <id>http://crossoverjie.top/2025/01/02/ob/k8s-monitor-pod/</id>
    <published>2025-01-02T06:00:50.000Z</published>
    <updated>2025-01-02T06:04:30.164Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ®µæ—¶é—´æœ‰æœ‹å‹é—®æˆ‘å¦‚ä½•åœ¨ kubernetes é‡Œæ­å»ºç›‘æ§ç³»ç»Ÿï¼Œæ°å¥½åœ¨å…¬å¸ä¹Ÿåœ¨ç»´æŠ¤å†…éƒ¨çš„å¯è§‚æµ‹å¹³å°ï¼Œæ­£å¥½å€Ÿè¿™ä¸ªæœºä¼šæ•´ç†ä¸‹ç›®å‰å¸¸è§çš„è‡ªå»ºç›‘æ§æ–¹æ¡ˆã€‚</p><p>ä¸€ä¸ªå®Œæ•´çš„ç›‘æ§ç³»ç»Ÿé€šå¸¸åŒ…å«ä»¥ä¸‹çš„å†…å®¹ï¼š</p><ul><li>æŒ‡æ ‡æš´éœ²ï¼šå°†ç³»ç»Ÿå†…éƒ¨éœ€è¦å…³æ³¨çš„æŒ‡æ ‡æš´éœ²å‡ºå»</li><li>æŒ‡æ ‡é‡‡é›†ï¼šæ”¶é›†å¹¶å­˜å‚¨æš´éœ²å‡ºæ¥çš„æŒ‡æ ‡</li><li>æŒ‡æ ‡å±•ç¤ºï¼šä»¥å„ç§å›¾è¡¨å±•ç¤ºå’Œåˆ†ææ”¶é›†åˆ°çš„æ•°æ®</li><li>ç›‘æ§å‘Šè­¦ï¼šå½“æŸäº›å…³é”®æŒ‡æ ‡åœ¨ä¸€å®šæ—¶é—´å‘¨æœŸå†…å‡ºç°å¼‚å¸¸æ—¶ï¼Œå¯ä»¥åŠæ—¶é€šçŸ¥ç›¸å…³äººå‘˜</li></ul><p><img src="https://s2.loli.net/2024/12/20/nAOS5E1YzWDoZyF.png" alt="image.png"></p><p>å¯¹äº k8s çš„ç›‘æ§é€šå¸¸åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>k8s è‡ªå¸¦çš„ç³»ç»Ÿç»„å»º</li><li>ä¸šåŠ¡ Pod æš´éœ²å‡ºæ¥çš„ç›‘æ§æŒ‡æ ‡</li></ul><h1 id="ç³»ç»Ÿç»„å»º"><a href="#ç³»ç»Ÿç»„å»º" class="headerlink" title="ç³»ç»Ÿç»„å»º"></a>ç³»ç»Ÿç»„å»º</h1><p>å¯¹äº kubernetes ç³»ç»Ÿç»„å»ºå¯ä»¥ç”± <code>cAdvisor</code> æä¾›ç›‘æ§èƒ½åŠ›ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿™ä¸ªåŠŸèƒ½æ˜¯å¼€ç®±å³ç”¨çš„ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ Prometheus ä¸­é…ç½®ç›¸å…³çš„ä»»åŠ¡æŠ“å–å³å¯ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">nodeScrape/monitoring/cadvisor-scrape/0</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">15s</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">node</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/RhKZGp94sUTbvFa.png" alt="image.png"><br>è¿™æ ·çš„è¯å°±å¯ä»¥ç›‘æ§ k8s çš„å†…å­˜ã€CPU ä¹‹ç±»çš„æ•°æ®ã€‚</p><p>å…·ä½“æä¾›äº†å“ªäº›æŒ‡æ ‡å¯ä»¥å‚è€ƒè¿™é‡Œï¼š<br><a href="https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md#prometheus-container-metrics">https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md#prometheus-container-metrics</a></p><p>ä¹Ÿå¯ä»¥æ‰¾ä¸€äº›å¸¸ç”¨çš„ç›‘æ§é¢æ¿:<br><a href="https://grafana.com/grafana/dashboards/13077-kubernetes-monitoring-dashboard-kubelet-cadvisor-node-exporter/">https://grafana.com/grafana/dashboards/13077-kubernetes-monitoring-dashboard-kubelet-cadvisor-node-exporter/</a></p><p>k8s ä¸ä½†æä¾›äº† cAdvisor çš„æ•°æ®ï¼Œè¿˜æœ‰å…¶ä»–ç±»ä¼¼çš„ endpoint: <code>/metrics/resource &amp; /metrics/probes</code> </p><p>å…·ä½“æš´éœ²å‡ºæ¥çš„æŒ‡æ ‡å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<br><a href="https://kubernetes.io/docs/concepts/cluster-administration/system-metrics/">https://kubernetes.io/docs/concepts/cluster-administration/system-metrics/</a></p><h1 id="ä¸šåŠ¡æŒ‡æ ‡"><a href="#ä¸šåŠ¡æŒ‡æ ‡" class="headerlink" title="ä¸šåŠ¡æŒ‡æ ‡"></a>ä¸šåŠ¡æŒ‡æ ‡</h1><p>å¯¹äºä¸šåŠ¡åº”ç”¨æ¥è¯´ç¬¬ä¸€æ­¥ä¹Ÿæ˜¯éœ€è¦å°†è‡ªå·±çš„æŒ‡æ ‡æš´éœ²å‡ºå»ï¼Œå¦‚æœæ˜¯ Java çš„è¯å¯ä»¥ä½¿ç”¨ Prometheus æä¾›çš„åº“ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- The client --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!-- Hotspot JVM metrics--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient_hotspot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p> å®ƒä¼šè‡ªåŠ¨å°† JVM ç›¸å…³çš„æŒ‡æ ‡æš´éœ²å‡ºå»ï¼Œå¦‚æœæ˜¯åœ¨ VM ä¸­çš„åº”ç”¨ï¼Œé‚£åªéœ€è¦ç®€å•çš„é…ç½®ä¸‹ <code>static_configs</code> å°±å¯ä»¥æŠ“å–æŒ‡æ ‡äº†ï¼š</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attr">scrape_configs:</span>  </span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;springboot&#x27;</span>  </span><br><span class="line"><span class="attr">scrape_interval:</span> <span class="string">10s</span>  </span><br><span class="line"><span class="attr">static_configs:</span>  </span><br><span class="line"><span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8080&#x27;</span>] <span class="comment"># Spring Boot ip+port</span></span><br></pre></td></tr></table></figure><p>ä½†åœ¨ kubernetes ä¸­è¿™ä¸ª IP æ˜¯ä¸å›ºå®šçš„ï¼Œæ¯æ¬¡é‡å»ºåº”ç”¨çš„æ—¶å€™éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶æ¥åŠ¨æ€çš„æ‰¾åˆ° Pod çš„ IPã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-pods&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_label_component</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">job</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br></pre></td></tr></table></figure><p>Prometheus æä¾›äº†ä¸€ä¸ª <code>kubernetes_sd_configs</code> çš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œä»–ä¼šåœ¨ kubernetes ä¸­æŸ¥æ‰¾ Pod ä¸­æ˜¯å¦æœ‰é…ç½®ä»¥ä¸‹çš„æ³¨è§£ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">template:</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">prometheus.io/path:</span> <span class="string">/metrics</span></span><br><span class="line">      <span class="attr">prometheus.io/port:</span> <span class="string">&quot;8082&quot;</span></span><br><span class="line">      <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure><p>éƒ½é…ç½®æˆåŠŸåæˆ‘ä»¬ä¾¿å¯ä»¥åœ¨ Prometheus çš„ç®¡ç†åå°æŸ¥çœ‹åˆ°å…·ä½“çš„æœåŠ¡ä¿¡æ¯ï¼š<br><img src="https://s2.loli.net/2024/12/23/9tZ3uJTpvQY278D.png" alt="image.png"><br>çŠ¶æ€æ˜¯ UP åˆ™è¡¨æ˜æŠ“å–æ•°æ®æˆåŠŸï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ Prometheus ä¸­æŸ¥è¯¢åˆ°æ•°æ®äº†ã€‚</p><p><img src="https://s2.loli.net/2024/12/23/rM7nDiWgTUmA8h3.png" alt="image.png"></p><p>Prometheus é™¤äº†æ”¯æŒ k8s çš„æœåŠ¡å‘ç°ä¹‹å¤–è¿˜æ”¯æŒå„ç§å„æ ·çš„æœåŠ¡å‘ç°ï¼Œæ¯”å¦‚ä½ å·²ç»ä½¿ç”¨äº†  Consul æˆ–è€…æ˜¯ Erueka ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œä¹Ÿå¯ä»¥ç›´æ¥é…ç½®ä»–ä»¬çš„åœ°å€ç„¶åè¿›è¡ŒæœåŠ¡å‘ç°ï¼Œè¿™æ ·åº”ç”¨ä¿¡æ¯å‘ç”Ÿå˜åŒ–æ—¶ Prometheus ä¹Ÿèƒ½åŠæ—¶æ„ŸçŸ¥åˆ°ã€‚</p><p>å½“ç„¶ <code>docker/http/docker</code> ç­‰éƒ½æ˜¯æ”¯æŒçš„ï¼Œå¯ä»¥æŒ‰éœ€é€‰æ‹©ã€‚</p><h2 id="OpenTelemetry"><a href="#OpenTelemetry" class="headerlink" title="OpenTelemetry"></a>OpenTelemetry</h2><p>éšç€è¿™ä¸¤å¹´å¯è§‚æµ‹æ€§æ ‡å‡†çš„å®Œå–„ï¼Œè®¸å¤šå‚å•†éƒ½åœ¨å¾€ <code>OpenTelemetry</code> ä¸Šè¿›è¡Œè¿ç§»ï¼Œæ¥å…¥ OpenTelemetry ä¸ç›´æ¥ä½¿ç”¨ Prometheus æœ€å¤§çš„ä¸åŒæ˜¯ï¼š</p><blockquote><p>ä¸å†ç”± Prometheus ä¸»åŠ¨æŠ“å–åº”ç”¨æŒ‡æ ‡ï¼Œè€Œæ˜¯ç”±åº”ç”¨ç»™ <code>OpenTelemetry-Collector</code> æ¨é€æ ‡å‡†åŒ–çš„å¯è§‚æµ‹æ•°æ®ï¼ˆåŒ…å«æ—¥å¿—ã€traceã€æŒ‡æ ‡ï¼‰ï¼Œå†ç”±å®ƒè¿œç¨‹å†™å…¥ Prometheus è¿™ç±»æ—¶åºæ•°æ®åº“ä¸­ã€‚</p></blockquote><p>æ•´ä½“æµç¨‹å›¾å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/07/22/oUPjd4KlX7niBaI.png" alt="image.png"></p><p>å¯¹åº”ç”¨çš„æœ€å¤§çš„åŒºåˆ«å°±æ˜¯å¯ä»¥ä¸å†ä½¿ç”¨åˆšæ‰æåˆ° Prometheus ä¾èµ–ï¼Œè€Œæ˜¯åªéœ€è¦æŒ‚è½½ä¸€ä¸ª javaagent å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \  </span><br><span class="line">-Dotel.traces.exporter=otlp \  </span><br><span class="line">-Dotel.metrics.exporter=otlp \  </span><br><span class="line">-Dotel.logs.exporter=none \  </span><br><span class="line">-Dotel.service.name=java-demo \  </span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \  </span><br><span class="line">-Dotel.propagators=tracecontext,baggage \  </span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 -jar target/demo-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p>è€Œå…¶ä¸­ä¼šæ–°å¢çš„ä¸€ä¸ª <code>OpenTelemetry-Collector</code>é¡¹ç›®ï¼Œç”±å®ƒå°†æ”¶åˆ°çš„æŒ‡æ ‡æ•°æ®è½¬å‘ç»™ Prometheusï¼Œæ‰€ä»¥åœ¨å®ƒçš„é…ç½®é‡Œä¼šé…ç½® Prometheus çš„åœ°å€ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">otlphttp/prometheus:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">http://prometheus:9292/api/v1/otlp</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>ä¹‹å‰ä¹Ÿå†™è¿‡ä¸¤ç¯‡ <code>OpenTelemetry</code> å’Œç›‘æ§ç›¸å…³çš„æ–‡ç« ï¼Œå¯ä»¥ä¸€èµ·é˜…è¯»ä½“éªŒæ›´ä½³ï¼š</p><ul><li><a href="https://crossoverjie.top/2024/06/13/ob/OpenTelemetry-metrics-concept/">ä» Prometheus åˆ° OpenTelemetryï¼šæŒ‡æ ‡ç›‘æ§çš„æ¼”è¿›ä¸å®è·µ</a></li><li><a href="https://crossoverjie.top/2024/08/27/ob/OpenTelemetry-02-metrics/">OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åº”ç”¨æŒ‡æ ‡ç›‘æ§</a></li></ul><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å…³äº Prometheus çš„å®‰è£…å¯ä»¥å‚è€ƒå®˜æ–¹çš„ operator æˆ–è€…æ˜¯ helmï¼š<br><a href="https://github.com/prometheus-operator/kube-prometheus">https://github.com/prometheus-operator/kube-prometheus</a></p><p>å½“ç„¶å¦‚æœä¸æƒ³ä½¿ç”¨ Prometheus ä¹Ÿæ¨èä½¿ç”¨ <a href="https://victoriametrics.com/">VictoriaMetrics</a>ï¼Œæ˜¯ä¸€ä¸ªå®Œå…¨å…¼å®¹ Prometheus ä½†æ˜¯èµ„æºå ç”¨æ›´å°‘çš„æ—¶åºæ•°æ®åº“ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://kubernetes.io/docs/concepts/cluster-administration/system-metrics/">https://kubernetes.io/docs/concepts/cluster-administration/system-metrics/</a></li><li><a href="https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md">https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md</a></li><li><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å‰æ®µæ—¶é—´æœ‰æœ‹å‹é—®æˆ‘å¦‚ä½•åœ¨ kubernetes é‡Œæ­å»ºç›‘æ§ç³»ç»Ÿï¼Œæ°å¥½åœ¨å…¬å¸ä¹Ÿåœ¨ç»´æŠ¤å†…éƒ¨çš„å¯è§‚æµ‹å¹³å°ï¼Œæ­£å¥½å€Ÿè¿™ä¸ªæœºä¼šæ•´ç†ä¸‹ç›®å‰å¸¸è§çš„è‡ªå»ºç›‘æ§æ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;p&gt;ä¸€ä¸ªå®Œæ•´çš„ç›‘æ§ç³»ç»Ÿé€šå¸¸åŒ…å«ä»¥ä¸‹çš„å†…å®¹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŒ‡æ ‡æš´éœ²ï¼šå°†ç³»ç»Ÿå†…éƒ¨éœ€è¦å…³æ³¨çš„æŒ‡æ ‡æš´éœ²å‡ºå»&lt;/l</summary>
      
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="kubernetes" scheme="http://crossoverjie.top/categories/OB/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="http://crossoverjie.top/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Istio å®‰è£…è¿‡ç¨‹ä¸­é‡åˆ°çš„å‘</title>
    <link href="http://crossoverjie.top/2024/12/25/ob/istio-install-problem/"/>
    <id>http://crossoverjie.top/2024/12/25/ob/istio-install-problem/</id>
    <published>2024-12-25T05:48:35.000Z</published>
    <updated>2024-12-26T03:52:47.449Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å®‰è£…-Istio"><a href="#å®‰è£…-Istio" class="headerlink" title="å®‰è£… Istio"></a>å®‰è£… Istio</h1><p>æœ€è¿‘è¿™æ®µæ—¶é—´ä¸€ç›´åœ¨åšæœåŠ¡ç½‘æ ¼ï¼ˆIstioï¼‰ç›¸å…³çš„å·¥ä½œï¼ŒèƒŒæ™¯æ˜¯æˆ‘ä»¬å‡†å¤‡è‡ªå»º Istioï¼Œé¦–å…ˆç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯è¦å®‰è£…ã€‚</p><p>æˆ‘è¿™é‡Œç›´æ¥ä½¿ç”¨å®˜ç½‘æ¨èçš„ <a href="https://istio.io/v1.18/docs/setup/install/istioctl">istioctl</a> è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; ./my-config.yaml</span></span><br><span class="line"><span class="string">apiVersion: install.istio.io/v1alpha1  </span></span><br><span class="line"><span class="string">kind: IstioOperator  </span></span><br><span class="line"><span class="string">metadata:  </span></span><br><span class="line"><span class="string">  namespace: istio-1-18-5  </span></span><br><span class="line"><span class="string">spec:  </span></span><br><span class="line"><span class="string">  profile: minimal  </span></span><br><span class="line"><span class="string">  revision: istio-1-18-5  </span></span><br><span class="line"><span class="string">  meshConfig:  </span></span><br><span class="line"><span class="string">    accessLogFile: /dev/stdout</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">$ istioctl install -f my-config.yaml -n istio-1-18-5</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä½¿ç”¨çš„ profile æ˜¯ minimalï¼Œå®ƒåªä¼šå®‰è£…æ ¸å¿ƒçš„æ§åˆ¶é¢ï¼Œå…·ä½“å·®å¼‚è§ä¸‹å›¾ï¼š<br><img src="https://s2.loli.net/2024/12/25/KBu5w4WjLU9zTH3.png" alt="image.png"></p><span id="more"></span><p>è¾“å‡ºä»¥ä¸‹å†…å®¹æ—¶ä»£è¡¨å®‰è£…æˆåŠŸï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">This will install the Istio 1.18.5 minimal profile with [<span class="string">&quot;Istio core&quot;</span> <span class="string">&quot;Istiod&quot;</span>] components into the cluster. Proceed? (y/N) y</span><br><span class="line">âœ” Istio core installed                                                                                                                                   </span><br><span class="line">âœ” Istiod installed                                                                         </span><br><span class="line">âœ” Installation complete  </span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ä¾¿å¯ä»¥åœ¨æŒ‡å®šçš„ <code>namespace</code> ä¸‹æŸ¥è¯¢åˆ°æ§åˆ¶é¢çš„ Podï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k get pod -n istio-1-18-5</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">istiod-istio-1-18-5-6cb9898585-64jtg   1/1     Running   0          22h</span><br></pre></td></tr></table></figure><p>ç„¶ååªéœ€è¦å°†éœ€è¦æ³¨å…¥ sidecar çš„ namespace ä¸­å¼€å¯ç›¸å…³çš„é…ç½®å³å¯ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œå°† test è¿™ä¸ª namespace å¼€å¯ sidecar æ³¨å…¥ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">istio.io/rev:</span> <span class="string">istio-1-18-5</span></span><br><span class="line">    <span class="attr">kubernetes.io/metadata.name:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure><p>æœ€ä¸»è¦çš„å°±æ˜¯åŠ ä¸Š <code>istio.io/rev: istio-1-18-5</code> çš„æ ‡ç­¾ï¼Œæ ‡ç­¾çš„å€¼å°±æ˜¯æˆ‘ä»¬åœ¨å®‰è£… istio æ—¶æŒ‡å®šçš„å€¼ï¼š<code>revision: istio-1-18-5</code>ã€‚</p><p>æ­¤æ—¶åªè¦æˆ‘ä»¬åœ¨è¿™ä¸ª namespace ä¸‹éƒ¨ç½²ä¸€ä¸ª Pod å°±ä¼šä¸ºè¿™ä¸ª Pod æŒ‚è½½ä¸€ä¸ª sidecarã€‚</p><p><img src="https://s2.loli.net/2024/12/25/Jdrx47cosVtqBv3.png" alt="image.png"></p><h1 id="æ›´æ–°é…ç½®çš„å‘"><a href="#æ›´æ–°é…ç½®çš„å‘" class="headerlink" title="æ›´æ–°é…ç½®çš„å‘"></a>æ›´æ–°é…ç½®çš„å‘</h1><p><img src="https://s2.loli.net/2024/12/25/WJjBgqIxCMN1Tz3.png" alt="image.png"><br><img src="https://s2.loli.net/2024/12/25/n4bQDHys9hMoR6c.png" alt="image.png"></p><p><a href="https://istio.io/latest/docs/ops/integrations/prometheus/#option-1-metrics-merging">é»˜è®¤æƒ…å†µ</a>ä¸‹ Istio ä¼šå°†åº”ç”¨ Pod çš„æš´éœ²å‡ºæ¥çš„ metrics å’Œ sidecar çš„æŒ‡æ ‡åˆå¹¶åœ¨ä¸€èµ·ï¼Œç„¶åæš´éœ²ä¸º <code>:15020/stats/prometheus</code> è¿™ä¸ª endpointã€‚</p><p>è€Œæˆ‘ä»¬è‡ªå·±åœ¨ Pod ä¸Šå®šä¹‰çš„æ³¨è§£åˆ™æ˜¯è¢«è¦†ç›–æ‰äº†ï¼š<br><img src="https://s2.loli.net/2024/12/25/vCpUEJgnTYI5rje.png" alt="image.png"></p><p>ä½†æˆ‘ä»¬æ˜¯å°†åº”ç”¨å’Œ sidecar çš„æŒ‡æ ‡åˆ†å¼€é‡‡é›†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦è¿™ä¸ªè‡ªåŠ¨åˆå¹¶ã€‚</p><p><img src="https://s2.loli.net/2024/12/25/5bQ71OYxmkBFXh6.png"></p><blockquote><p>ä¼šå•ç‹¬é…ç½® 15090 ç«¯å£çš„é‡‡é›†ä»»åŠ¡</p></blockquote><p>æ‰€ä»¥æˆ‘éœ€è¦å°†è¿™ä¸ªåŠŸèƒ½å…³é—­ï¼Œå®‰è£…æ–‡æ¡£çš„è¯´æ˜åªéœ€è¦åœ¨æ§åˆ¶é¢ä¸­å°† <code>enablePrometheusMerge</code> ä¿®æ”¹ä¸º false å³å¯ã€‚</p><p>å®‰è£…å¥½ Istio æ§åˆ¶é¢ä¹‹åä¼šåˆ›å»ºä¸€ä¸ª IstioOperator çš„ CRD èµ„æºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k get IstioOperator -A</span><br><span class="line">NAMESPACE      NAME                           REVISION       STATUS   AGE</span><br><span class="line">istio-1-18-5   installed-state-istio-1-18-5   istio-1-18-5            27h</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰æ§åˆ¶é¢çš„é…ç½®éƒ½å¯ä»¥åœ¨è¿™é‡Œé¢ä¿®æ”¹ï¼Œæ‰€ä»¥æˆ‘æƒ³å½“ç„¶çš„åœ¨è¿™é‡ŒåŠ å…¥äº† <code>enablePrometheusMerge: false</code> çš„é…ç½®ã€‚</p><p><img src="https://s2.loli.net/2024/12/25/bCdUxLRQDFEOI6j.png" alt="image.png"></p><p>åŠ ä¸Šä¹‹åæˆ‘é‡å¯äº† Pod å‘ç°ä¾ç„¶è¿˜æ˜¯ Istio çš„æ³¨è§£ï¼š</p><p><img src="https://s2.loli.net/2024/12/25/n4bQDHys9hMoR6c.png" alt="image.png"></p><p>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªé…ç½®å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œå³ä¾¿æ˜¯æˆ‘æŠŠæ§åˆ¶é¢ä¹Ÿé‡å¯äº†ä¹Ÿæ²¡æœ‰æ•ˆæœã€‚</p><p>æŒ‰ç…§åŸç†æ¥è¯´ï¼Œè¿™äº›é…ç½®åº”è¯¥æ˜¯æ§åˆ¶é¢ä¸‹å‘ç»™æ•°æ®é¢çš„ï¼Œå¤§èƒ†çŒœæµ‹ä¸‹ä¹Ÿå°±æ˜¯æ§åˆ¶é¢æ²¡æœ‰æ‹¿åˆ°æœ€æ–°çš„é…ç½®ã€‚</p><p>ä½†æ˜¯æˆ‘å¸è½½æ§åˆ¶é¢ï¼Œå†å®‰è£…çš„æ—¶å€™å°±æŒ‡å®šè¿™ä¸ªé…ç½®ç¡®æ˜¯ç”Ÿæ•ˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´é…ç½®æ²¡é—®é¢˜ï¼Œåªæ˜¯æˆ‘åœ¨å®‰è£…å®Œæˆåå†ä¿®æ”¹å°±æ²¡æ³•åŒæ­¥ã€‚</p><p>ä¹‹åæˆ‘åœ¨ <a href="https://stackoverflow.com/questions/70076326/how-to-update-istio-configuration-after-installation">stackoverflow</a> ä¸Šæ‰¾åˆ°äº†ç±»ä¼¼çš„é—®é¢˜ï¼š<br><img src="https://s2.loli.net/2024/12/25/SybMZeG6fc1pjhd.png" alt="image.png"></p><p>ç®€å•æ¥è¯´å®‰è£…å¥½ istio ä¹‹åæˆ‘ä»¬ä¹Ÿå¯ä»¥ç»§ç»­ä½¿ç”¨ <code>istioctl install -f xx.yaml</code> è¿›è¡Œæ›´æ–°ã€‚</p><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>åæ¥æˆ‘ä»”ç»†çœ‹äº†ä¸‹ istioctl è¿™ä¸ªå‘½ä»¤çš„ help æ–‡æ¡£ï¼Œå‘ç°å…¶å®å·²ç»åœ¨æè¿°é‡Œå†™æ¸…æ¥šäº†ï¼š<br><img src="https://s2.loli.net/2024/12/26/rv9nkiIO6wgbj5s.png" alt="image.png"><br>ç”šè‡³è¿˜æœ‰ä¸ªåˆ«åå°±å« <code>apply</code> è¿™å°±å’Œ <code>kubectl apply</code> çš„å‘½ä»¤éå¸¸ç±»ä¼¼äº†ï¼Œä¹Ÿæ›´å®¹æ˜“ç†è§£äº†ï¼Œä»»ä½•çš„ä¿®æ”¹åªéœ€è¦ <code>apply</code> æ‰§è¡Œä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p><p>ä¸è¿‡æˆ‘ä¹Ÿåœ¨å¥½å¥‡ï¼Œæ—¢ç„¶åˆ›å»ºçš„æ˜¯ä¸€ä¸ª <code>IstioOperator</code> çš„ CRDï¼Œç†è®ºä¸Šæ˜¯éœ€è¦ä¸€ä¸ª Operator æ¥è¯»å–è¿™é‡Œçš„æ•°æ®ç„¶åå†åˆ›å»ºä¸€ä¸ªæ§åˆ¶é¢ï¼ŒåŒæ­¥é…ç½®ä¹‹ç±»çš„æ“ä½œã€‚</p><p>ä½†å½“æˆ‘å®‰è£…å¥½ Istio ä¹‹åå¹¶æ²¡çœ‹åˆ°æœ‰ä¸€ä¸ª Operator çš„ Pod åœ¨è¿è¡Œï¼Œæ‰€ä»¥å°±æ¯”è¾ƒå¥½å¥‡ <code>install</code> è¿™ä¸ªå‘½ä»¤æ˜¯å¦‚ä½•å®ç°é…ç½®åŒæ­¥çš„ã€‚</p><p>ç»è¿‡å¯¹ <code>istioctl</code> çš„ debug æ‰¾åˆ°äº†å…·ä½“çš„åŸå› ï¼š</p><p><img src="https://s2.loli.net/2024/12/26/2bWSIDsf5gXdkHt.png" alt="WeChatWorkScreenshot_bab3706b-2815-46a6-961e-408439b81841.png"><br><img src="https://s2.loli.net/2024/12/26/XNtGeqnvZiEomfc.png" alt="WeChatWorkScreenshot_8f421734-f1e7-4a07-a676-84300187485d.png"></p><p>åœ¨ <code>istioctl install -f xx.yaml</code> æ‰§è¡Œä¹‹åä¼šç›´æ¥è§£æ <code>xx.yaml</code> é‡Œçš„ <code>IstioOperator</code> ç”Ÿæˆæ‰€æœ‰çš„ <code>manifest</code> èµ„æºï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿä¼šç”Ÿæˆä¸€ä¸ª <code>ConfigMap</code>ï¼Œæ‰€æœ‰çš„é…ç½®éƒ½æ˜¯å­˜æ”¾åœ¨å…¶ä¸­çš„ã€‚</p><p>æ‰€ä»¥å…¶å®æˆ‘æ‰‹åŠ¨ä¿®æ”¹è¿™ä¸ª <code>ConfigMap</code> ä¹Ÿå¯ä»¥åŠ¨æ€æ›´æ–°æ§åˆ¶é¢çš„é…ç½®ï¼Œä¹‹å‰æˆ‘åªæ˜¯ä¿®æ”¹äº† CRDï¼Œæˆ‘ä»¥ä¸ºè¿˜æœ‰ä¸€ä¸ª Operator æ¥ç›‘å¬è¿™é‡Œçš„å˜åŒ–ç„¶ååŒæ­¥æ•°æ®ï¼›å®é™…ä¸Šå¹¶ä¸å­˜åœ¨è¿™ä¸ªé€»è¾‘ï¼Œè€Œæ˜¯ç›´æ¥åº”ç”¨çš„ <code>manifest</code>ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://istio.io/v1.18/docs/setup/install/istioctl">https://istio.io/v1.18/docs/setup/install/istioctl</a></li><li><a href="https://istio.io/latest/docs/ops/integrations/prometheus/#option-1-metrics-merging">https://istio.io/latest/docs/ops/integrations/prometheus/#option-1-metrics-merging</a></li><li><a href="https://stackoverflow.com/questions/70076326/how-to-update-istio-configuration-after-installation">https://stackoverflow.com/questions/70076326/how-to-update-istio-configuration-after-installation</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å®‰è£…-Istio&quot;&gt;&lt;a href=&quot;#å®‰è£…-Istio&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£… Istio&quot;&gt;&lt;/a&gt;å®‰è£… Istio&lt;/h1&gt;&lt;p&gt;æœ€è¿‘è¿™æ®µæ—¶é—´ä¸€ç›´åœ¨åšæœåŠ¡ç½‘æ ¼ï¼ˆIstioï¼‰ç›¸å…³çš„å·¥ä½œï¼ŒèƒŒæ™¯æ˜¯æˆ‘ä»¬å‡†å¤‡è‡ªå»º Istioï¼Œé¦–å…ˆç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯è¦å®‰è£…ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘è¿™é‡Œç›´æ¥ä½¿ç”¨å®˜ç½‘æ¨èçš„ &lt;a href=&quot;https://istio.io/v1.18/docs/setup/install/istioctl&quot;&gt;istioctl&lt;/a&gt; è¿›è¡Œå®‰è£…ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;cat&lt;/span&gt; &amp;lt;&amp;lt;&lt;span class=&quot;string&quot;&gt;EOF &amp;gt; ./my-config.yaml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;apiVersion: install.istio.io/v1alpha1  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;kind: IstioOperator  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;metadata:  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;  namespace: istio-1-18-5  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;spec:  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;  profile: minimal  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;  revision: istio-1-18-5  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;  meshConfig:  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;    accessLogFile: /dev/stdout&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ istioctl install -f my-config.yaml -n istio-1-18-5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;è¿™é‡Œæˆ‘ä½¿ç”¨çš„ profile æ˜¯ minimalï¼Œå®ƒåªä¼šå®‰è£…æ ¸å¿ƒçš„æ§åˆ¶é¢ï¼Œå…·ä½“å·®å¼‚è§ä¸‹å›¾ï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/12/25/KBu5w4WjLU9zTH3.png&quot; alt=&quot;image.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Istio" scheme="http://crossoverjie.top/categories/Istio/"/>
    
    <category term="k8s" scheme="http://crossoverjie.top/categories/Istio/k8s/"/>
    
    
    <category term="Istio" scheme="http://crossoverjie.top/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨å¹³æ·¡çš„å·¥ä½œä¸­æ•´ç†å‡ºæœ‰ä»·å€¼çš„ç®€å†</title>
    <link href="http://crossoverjie.top/2024/12/10/ob/%E5%A6%82%E4%BD%95%E5%9C%A8%E5%B9%B3%E6%B7%A1%E7%9A%84%E5%B7%A5%E4%BD%9C%E4%B8%AD%E6%95%B4%E7%90%86%E5%87%BA%E6%9C%89%E4%BB%B7%E5%80%BC%E7%9A%84%E7%AE%80%E5%8E%86/"/>
    <id>http://crossoverjie.top/2024/12/10/ob/%E5%A6%82%E4%BD%95%E5%9C%A8%E5%B9%B3%E6%B7%A1%E7%9A%84%E5%B7%A5%E4%BD%9C%E4%B8%AD%E6%95%B4%E7%90%86%E5%87%BA%E6%9C%89%E4%BB%B7%E5%80%BC%E7%9A%84%E7%AE%80%E5%8E%86/</id>
    <published>2024-12-10T07:07:10.000Z</published>
    <updated>2024-12-09T07:09:39.100Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©åœ¨ HackNews ä¸Šçœ‹åˆ°ä¸€ä¸ª<a href="https://news.ycombinator.com/item?id=41937892">å¸–å­</a>ï¼šä½ ä»¬æ˜¯å¦å¾ˆéš¾å›å¿†èµ·åœ¨å·¥ä½œä¸­åšäº†å“ªäº›è´¡çŒ®ï¼Ÿ</p><p><img src="https://s2.loli.net/2024/10/25/ItaHwFoWzG3ASZV.png"></p><p>æˆ‘è§‰å¾—æŒºå¤šäººéƒ½æœ‰ç±»ä¼¼çš„é—®é¢˜ï¼Œé€šå¸¸éƒ½æ˜¯åœ¨éœ€è¦é¢è¯•æˆ–è€…å†…éƒ¨æ™‹å‡çš„æ—¶å€™æ‰å¼€å§‹æ€è€ƒè¿™äº›é—®é¢˜ï¼Œè¿™æ—¶å€™åœ¨æƒ³çš„è¯éš¾å…ä¼šæœ‰é—æ¼ã€‚</p><p>ç»“åˆå¸–å­é‡Œçš„å›ç­”æˆ‘æ•´ç†äº†ä»¥ä¸‹ä»¥ä¸‹æ–¹æ³•ã€‚</p><span id="more"></span><h2 id="æ¯æ—¥è®°å½•"><a href="#æ¯æ—¥è®°å½•" class="headerlink" title="æ¯æ—¥è®°å½•"></a>æ¯æ—¥è®°å½•</h2><p>å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œæ¯æ—¥åšå¥½å·¥ä½œè®°å½•ï¼Œå‘¨æœ«å†åšä¸€æ¬¡æ±‡æ€»ï¼›<br>æœ‰éƒ¨åˆ†å…¬å¸åº”è¯¥å°±æœ‰ç±»ä¼¼çš„åˆ¶åº¦ï¼ˆæ—¥æŠ¥ã€å‘¨æŠ¥ï¼‰ï¼Œä½†é‚£æ˜¯å†™ç»™å…¬å¸çœ‹çš„ï¼Œè¿™æ˜¯å†™ç»™è‡ªå·±æ•´ç†çš„ï¼›<br>å¯¹è‡ªå·±æ¥è¯´åªéœ€è¦æ•´ç†æœ‰ç”¨çš„å†…å®¹ï¼Œå»æ‰é‚£äº›å·¥ä½œä¸­éœ€è¦çš„åºŸè¯ã€‚</p><p>è¿™é‡Œæ¨èå¯ä»¥ä½¿ç”¨ Obsidian çš„ daily æ’ä»¶ï¼Œæ¯å¤©ç‚¹å‡»ä¸€ä¸‹æ—¥å†å°±ä¼šç”Ÿæˆä¸€ä»½æ–‡æ¡£ï¼Œå‘¨æœ«çš„æ—¶å€™å†ç‚¹å‡»å°±ä¼šè‡ªåŠ¨å°†å‘¨ä¸€åˆ°å‘¨äº”çš„å†…å®¹è¿›è¡Œæ±‡æ€»ã€‚<br><img src="https://s2.loli.net/2024/10/25/vQVkq34zCsTMDZh.png"><br><img src="https://s2.loli.net/2024/10/25/RvtwnAP4DQmbYWz.png"><br><img src="https://s2.loli.net/2024/10/25/iCV5YKoyXOmxhsA.png"></p><blockquote><p>å»ºè®®æ˜¯åœ¨åšä¹‹å‰å°±è®°å½•ä¸‹æ¥ï¼Œè€Œä¸æ˜¯ç­‰åˆ°ä»Šå¤©ç»“æŸäº†å†è®°å½•ï¼Œæ­¤æ—¶è¦ä¹ˆä¸æƒ³è®°ï¼Œè¦ä¹ˆå·²ç»å¿˜äº†ã€‚<br>å‘¨æœ«æ±‡æ€»çš„æ—¶å€™å¯ä»¥æç‚¼ä¸‹ï¼Œå¦‚æœæ˜¯è¦å†™åˆ°ç®€å†é‡Œåº”è¯¥æ€ä¹ˆå†™ï¼Ÿ</p></blockquote><p>åŒæ ·çš„è§‚ç‚¹æˆ‘åœ¨æ’­å®¢<a href="https://www.xiaoyuzhoufm.com/episode/65954bca6d045a7f5e7a9286">ä»£ç ä¹‹å¤–</a>ä¸­ä¹Ÿæœ‰å¬åˆ°ï¼Œæ¯å¤©åœ¨ä¸‹ç­çš„æ—¶å€™è¿›è¡Œæ€»ç»“æœ‰ä»¥ä¸‹çš„å¥½å¤„ï¼š</p><ul><li>æ›´æœ‰ä»ªå¼æ„Ÿï¼Œåšå®Œè¿™ä¸ªåä¸€å¤©çš„å·¥ä½œå°±ç»“æŸäº†ã€‚</li><li>å¯ä»¥å­¦ä¼šå°†ä»»åŠ¡åˆ‡åˆ†ï¼Œæé«˜å¯¹å·¥ä½œçš„æŒæ§æ„Ÿã€‚</li><li>é•¿æœŸåšæŒä¸‹æ¥å¯ä»¥å¢å¼ºå¯¹ä»»åŠ¡å®Œæˆæ—¶é—´çš„å‡†ç¡®é¢„ä¼°ã€‚</li></ul><h2 id="Git-log-æ±‡æ€»"><a href="#Git-log-æ±‡æ€»" class="headerlink" title="Git log æ±‡æ€»"></a>Git log æ±‡æ€»</h2><p>è¿˜å¯ä»¥ä½¿ç”¨ <code>git log --author=&#39;&lt;Your Name&gt;</code> æ±‡æ€»ä½ å¯¹æäº¤è®°å½•ï¼Œç„¶åäº¤ç»™ AI å¸®æˆ‘ä»¬æ€»ç»“ï¼Œè¿™ä¸ªæ„Ÿè§‰æ›´é€‚åˆåšå·¥ä½œæ±‡æŠ¥ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log --pretty=format:&quot;%h - %an, %ar : %s&quot; --author=&#x27;crossoverJie&#x27; | pbcopy</span><br></pre></td></tr></table></figure><p>åœ¨ macOS ä¸­å¯ä»¥ä½¿ç”¨ <code>pbcopy</code> å‘½ä»¤å°†è¾“å‡ºå†…å®¹å¤åˆ¶åˆ°ç²˜è´´æ¿ï¼Œç„¶åæˆ‘ä»¬åªéœ€è¦å¤åˆ¶åˆ° chatgpt ä¸­å°±å¯ä»¥å¸®æˆ‘ä»¬æç‚¼æ€»ç»“äº†ï¼ˆä½†è¿™é‡Œçš„å‰ææ˜¯è‡ªå·±çš„æ¯æ¬¡æäº¤éƒ½æ˜¯æœ‰æ„ä¹‰çš„å¤‡æ³¨ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log --author=&quot;your_username&quot; --since=&quot;2024-01-01&quot; --until=&quot;2024-12-31&quot;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥åŠ ä¸Šæ—¶é—´ç­›é€‰ï¼Œæ›´åŠ ç²¾ç¡®çš„ç»Ÿè®¡ã€‚</p><h2 id="å®šæ—¶æ›´æ–°ç®€å†"><a href="#å®šæ—¶æ›´æ–°ç®€å†" class="headerlink" title="å®šæ—¶æ›´æ–°ç®€å†"></a>å®šæ—¶æ›´æ–°ç®€å†</h2><p>æˆ‘ä¸ªäººæ˜¯å»ºè®®æ¯ä¸ªå­£åº¦éƒ½æ›´æ–°ä¸€ä¸‹è‡ªå·±çš„ç®€å†ï¼Œçœ‹çœ‹æœ‰å“ªäº›æ–°çš„ä¸œè¥¿å¯ä»¥å†™ä¸Šå»ï¼Œè¿™ä¹Ÿæ˜¯å›é¡¾è‡ªå·±è¿™æ®µæ—¶é—´å·¥ä½œçš„æœ‰æ•ˆæ‰‹æ®µï¼Œæ¯•ç«Ÿç®€å†å°±æ˜¯è¦ç»™äººçœ‹çš„ç¾åŒ–ç‰ˆè‡ªå·±ã€‚</p><p><img src="https://s2.loli.net/2024/10/25/BpqVocTehZbUFD6.png"><br>Â <br>è¿™ä¸ªå¸–å­è¿˜æœ‰æåˆ°é¢è¯•æ—¶ä¸è¦å®³æ€•å†™è‡ªå·±ä¸ç†Ÿçš„æŠ€æœ¯æ ˆï¼Œå³ä¾¿æ˜¯åªåœ¨è‡ªå·±çš„ä¸ªäººé¡¹ç›®ä¸­ä½¿ç”¨è¿‡ï¼ˆçœ‹æ¥å›½å¤–å’Œæˆ‘ä»¬ä¹Ÿç±»ä¼¼ï¼‰</p><p>è¿™ä¸ªæˆ‘è§‰å¾—å¾—æ˜¯é¢è¯•æƒ…å†µè€Œå®šï¼Œå¦‚æœåº”è˜çš„ 1~3 å¹´çš„åˆä¸­çº§å²—ä½ï¼Œä¹Ÿä¸æ˜¯å¤§å‚ï¼Œé‚£å¯ä»¥è¿™ä¹ˆå†™ï¼Œä½†å¯¹äºä¸šç•Œéƒ½çŸ¥é“çš„ä¸€äº›å¤§å‚ï¼ˆæ¯”å¦‚é˜¿é‡Œã€å­—èŠ‚ï¼‰è¿™äº›é¢è¯•å¤§æ¦‚ç‡ä¸ä¼šåªé—®è¡¨é¢é—®é¢˜ï¼ŒæŠ€æœ¯æ ˆå†™çš„è¶Šå¤šå¯¹è‡ªå·±ä¹Ÿè¶Šæ²¡æœ‰å¥½å¤„ã€‚</p><p>æœ¬è´¨ä¸Šå°±æ˜¯éœ€è¦å¤§å®¶å¤šæ€»ç»“ï¼Œå¤šå‚è€ƒã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://news.ycombinator.com/item?id=41937892">https://news.ycombinator.com/item?id=41937892</a></li><li><a href="https://www.xiaoyuzhoufm.com/episode/65954bca6d045a7f5e7a9286">https://www.xiaoyuzhoufm.com/episode/65954bca6d045a7f5e7a9286</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»Šå¤©åœ¨ HackNews ä¸Šçœ‹åˆ°ä¸€ä¸ª&lt;a href=&quot;https://news.ycombinator.com/item?id=41937892&quot;&gt;å¸–å­&lt;/a&gt;ï¼šä½ ä»¬æ˜¯å¦å¾ˆéš¾å›å¿†èµ·åœ¨å·¥ä½œä¸­åšäº†å“ªäº›è´¡çŒ®ï¼Ÿ&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/10/25/ItaHwFoWzG3ASZV.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘è§‰å¾—æŒºå¤šäººéƒ½æœ‰ç±»ä¼¼çš„é—®é¢˜ï¼Œé€šå¸¸éƒ½æ˜¯åœ¨éœ€è¦é¢è¯•æˆ–è€…å†…éƒ¨æ™‹å‡çš„æ—¶å€™æ‰å¼€å§‹æ€è€ƒè¿™äº›é—®é¢˜ï¼Œè¿™æ—¶å€™åœ¨æƒ³çš„è¯éš¾å…ä¼šæœ‰é—æ¼ã€‚&lt;/p&gt;
&lt;p&gt;ç»“åˆå¸–å­é‡Œçš„å›ç­”æˆ‘æ•´ç†äº†ä»¥ä¸‹ä»¥ä¸‹æ–¹æ³•ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•é€‰æ‹©å¯ä»¥æé’±çš„æŠ€æœ¯æ ˆ</title>
    <link href="http://crossoverjie.top/2024/11/26/ob/%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E5%8F%AF%E4%BB%A5%E6%90%9E%E9%92%B1%E7%9A%84%E6%8A%80%E6%9C%AF%E6%A0%88/"/>
    <id>http://crossoverjie.top/2024/11/26/ob/%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E5%8F%AF%E4%BB%A5%E6%90%9E%E9%92%B1%E7%9A%84%E6%8A%80%E6%9C%AF%E6%A0%88/</id>
    <published>2024-11-26T14:50:58.000Z</published>
    <updated>2024-11-26T14:57:10.858Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰åœ¨å…¬å¸ä¸»è¦è´Ÿè´£å¯è§‚æµ‹æ€§å’Œ Pulsar æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„å†…å®¹ï¼Œæœ€è¿‘ç³»ç»Ÿæ¯”è¾ƒç¨³å®šï¼Œåªéœ€è¦åšæ—¥å¸¸è¿ç»´ï¼Œæ‰€ä»¥å°±æŠ½å‡ºæ—¶é—´é€æ­¥åœ¨æ¥è§¦ OLAP ç›¸å…³çš„æŠ€æœ¯æ ˆã€‚</p><p>æˆ‘ä»¬ç”¨çš„æ˜¯ <a href="https://www.starrocks.io/">StarRocks</a>ï¼Œä¹Ÿæ˜¯ç›®å‰æ¯”è¾ƒæµè¡Œçš„ OLAP æ•°æ®åº“ï¼›åœ¨æ¥è§¦çš„è¿™æ®µæ—¶é—´ä»¥æ¥ï¼Œè®©æˆ‘è¶Šå‘æ„Ÿè§‰åˆ°é€‰å¯¹ä¸€ä¸ªé è°±çš„æŠ€æœ¯æ–¹å‘çš„é‡è¦æ€§ã€‚</p><span id="more"></span><p>è¿™é‡Œä»¥ <a href="https://pulsar.apache.org/">Pulsar</a> ä¸¾ä¾‹ï¼ŒPulsar ä¹Ÿæ˜¯ Apache çš„é¡¶çº§é¡¹ç›®ï¼Œæœ‰ä¸€å®šçš„æŠ€æœ¯é—¨æ§›ï¼ŒåŒæ—¶ä¹Ÿè§£å†³ä»¥å¾€æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸€äº›é—®é¢˜ï¼ˆå¤šç§Ÿæˆ·ã€ä½å»¶è¿Ÿã€å­˜ç®—åˆ†ç¦»ç­‰ï¼‰ ä½†å¦‚æœæŠŠå®ƒä½œä¸ºä¸€ä¸ªå•†ä¸šäº§å“çš„è¯ï¼Œç›¸å¯¹æ¥è¯´ä»˜è´¹èƒ½åŠ›è¿˜ä¸å¤Ÿå¼ºã€‚</p><p>å…¶å®ä¹Ÿèƒ½æƒ³å¾—åˆ°ï¼Œå°±å•çº¯çš„æ¶ˆæ¯ä¸­é—´ä»¶åœ¨å¸‚åœºä¸Šèƒ½è®²çš„æ•…äº‹ä¸å¤šï¼Œå¯ä»¥å°†å®ƒèå…¥åˆ°å…¶ä»–çš„ç”Ÿæ€é‡Œï¼Œæ¯”å¦‚æ•°æ®å¤„ç†ã€ä¸šåŠ¡è§£è€¦ç­‰ï¼Œä½†æ€»å½’æ˜¯é…è§’ï¼Œæ²¡æœ‰å®ƒè™½ç„¶æ²¡é‚£ä¹ˆä¼˜é›…ï¼Œä½†ä¹Ÿå¯ä»¥ç©ã€‚</p><p>åŒç† OpenTelemetry ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå®ƒç”¨äºå¯è§‚æµ‹æ€§ç³»ç»Ÿï¼Œä¸»è¦æ˜¯å°±æ˜¯æ‹¿æ¥æ’æŸ¥é—®é¢˜çš„ï¼Œå¯¹äºä¼ä¸šæ¥è¯´ä¹Ÿè°ˆä¸ä¸Šåˆšéœ€ã€‚</p><p>ä»–ä»¬ä¸¤ä¸ªéƒ½æœ‰ä¸€ä¸ªå…±åŒçš„ç‰¹ç‚¹ï¼šå°å…¬å¸ä¸éœ€è¦ï¼ˆæˆ–è€…è‡ªå·±ç»´æŠ¤å¼€æºç‰ˆï¼Œé‡å°ä¹Ÿä¸å®¹æ˜“æš´éœ²é—®é¢˜ï¼‰ï¼Œå¤§å…¬å¸é€‰æ‹©å•ç‹¬çš„å›¢é˜Ÿè‡ªå·±ç»´æŠ¤ï¼Œå¸‚åœºè›‹ç³•è¾ƒå°ã€‚</p><p>å³ä¾¿æ˜¯éƒ¨åˆ†ä¸­å‚å¯èƒ½é€‰æ‹©è´­ä¹°äº‘æœåŠ¡ï¼Œä¸€èˆ¬ä¹Ÿä¼šé€‰æ‹©å’Œè‡ªå·±ç°æœ‰æŠ€æœ¯æ ˆé…å¥—çš„äº‘å‚å•†ï¼Œæ¯”å¦‚å·²ç»ç”¨äº†å¤§éƒ¨åˆ†é˜¿é‡Œäº‘çš„äº§å“ï¼Œè¿™ç§å‘¨è¾¹æœåŠ¡ä¹Ÿä¼šå°½å¯èƒ½çš„åœ¨é˜¿é‡Œäº‘ä¸Šé€‰æ‹©æ›¿ä»£æ–¹æ¡ˆï¼Œæ¯•ç«Ÿè¿™æ ·çš„é£é™©æ›´å°ï¼Œè€Œä¸”å›½å†…çš„äº§å“å¤§å¤šéƒ½å†™è¿˜ ALL INã€‚</p><blockquote><p>å¯èƒ½æ›´å¤šçš„è¿˜æ˜¯ä¸€äº›æ”¿ä¼ã€é‡‘èç­‰ä¸šåŠ¡ä¼šé€‰æ‹©è¿™äº›å¼€æºäº§å“çš„ä¼ä¸šç‰ˆï¼Œå¤§éƒ¨åˆ†å› ä¸ºéœ€è¦ç§æœ‰åŒ–éƒ¨ç½²ï¼Œä¸å¤ªæ–¹ä¾¿ç›´æ¥ä½¿ç”¨å…¬æœ‰äº‘ã€‚</p></blockquote><p>è€Œæ›´åˆšéœ€çš„å¾€å¾€éƒ½æ˜¯å’Œæ•°æ®ç›¸å…³çš„ï¼Œæ¯”å¦‚æ•°æ®åº“ã€MongoDBã€ElasticSearch ã€kubernetes ç­‰ï¼Œå¦‚æœæƒ³è¦æå‡ä¸‹éä¸šåŠ¡æ°´å¹³ï¼Œå€’æ˜¯å¯ä»¥æ·±å…¥ä¸€ä¸‹è¿™äº›æŠ€æœ¯æ ˆã€‚</p><h1 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h1><p>æ‹¿æ•°æ®åº“æ¥è¯´ï¼Œä»»ä½•å…¬å¸éƒ½éœ€è¦ï¼Œå³ä¾¿æ˜¯å°å…¬å¸ä¹Ÿä¸æ•¢åœ¨ç”Ÿäº§ç¯å¢ƒè‡ªå·±ç»´æŠ¤æ•°æ®åº“ï¼Œä¸€èˆ¬ä¹Ÿä¼šè´­ä¹°äº‘äº§å“ï¼Œæˆ–è€…æ˜¯æ‹›ä¸€ä¸ª DBAã€‚</p><p>åŒç†è¿˜æœ‰äº‘åŸç”Ÿç›¸å…³çš„åŸºç¡€æŠ€æœ¯æ ˆï¼Œæ¯”å¦‚ kubernetes ä»¥åŠå›´ç»•ç€ kubernetes å‘¨è¾¹çš„ç”Ÿæ€ã€‚</p><p>k8s ä½œä¸ºäº‘åŸç”Ÿçš„åŸºç¡€åº•åº§ï¼Œåªè¦æ¶‰åŠåˆ°ä¸Šäº‘å°±ç¦»ä¸å¼€å®ƒï¼Œä¸ç®¡å°å‚é€‰æ‹©äº‘æœåŠ¡è¿˜æ˜¯å¤§å‚è‡ªå·±æ‰˜ç®¡éƒ½å¾—éœ€è¦ç›¸å…³æŠ€èƒ½ã€‚</p><p>å³ä¾¿ä¸æ˜¯ç›´æ¥åš kubernetes å¼€å‘ä¹Ÿå¾—éœ€è¦äº†è§£ç›¸å…³çš„çŸ¥è¯†ï¼Œå¯¹è‡ªå·±ç†è§£æ•´ä¸ªç³»ç»Ÿæ˜¯å¦‚ä½•è¿è½¬çš„å¾ˆå¤§çš„å¸®åŠ©ã€‚</p><p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¹Ÿæœ‰ä¸ªç®€å•çš„æ–¹æ³•ï¼šå°±æ˜¯çœ‹çœ‹ä½ ä»¬å…¬å¸ä¸ºå“ªäº›æœåŠ¡ä¹°å•ã€‚</p><p>ä»¥æˆ‘æœ€è¿‘æ¥è§¦åˆ°çš„ StarRocks ä¸ºä¾‹ï¼Œä¹Ÿæ˜¯å’Œæ•°æ®å¤„ç†ç›¸å…³çš„å…¬å¸ï¼Œä»–ä»¬åœ¨ç–«æƒ…æœŸé—´æˆç«‹çš„å•†ä¸šåŒ–å…¬å¸ï¼Œè¿™å‡ å¹´éä½†æ²¡å—åˆ°å½±å“åè€Œè¿˜åœ¨å¢é•¿ã€‚</p><p><img src="https://s2.loli.net/2024/10/10/26uepDnY1yPzBaV.png"></p><blockquote><p>çœ‹åˆ°ä»–ä»¬çš„æ‹›è˜è¿˜è›®æ´»è·ƒã€‚</p></blockquote><p>å³ä¾¿æ˜¯å‚å•†æ›´å€¾å‘äºé€‰æ‹©äº‘å‚å•†çš„æ•°æ®æœåŠ¡ï¼ŒStarRocks è¿™ç±»åŸå‚å…¬å¸æˆ–å¤šæˆ–å°‘ä¹Ÿä¼šå‚ä¸è¿›å»æä¾›ä¸€äº›æŠ€æœ¯æ”¯æŒã€‚</p><p>ä¸è¿‡å¯èƒ½æœ‰äººçš„ç¬¬ä¸€ååº”æ˜¯è¿™äº›äº§å“çš„æŠ€æœ¯é—¨æ§›è¾ƒé«˜ï¼Œä¸Šæ‰‹æ¯”è¾ƒå›°éš¾ï¼Œä½†å…¶å®è¿™äº›å¾€å¾€éƒ½æ˜¯è‡ªå·±ç»™è‡ªå·±ä¸Šçš„éš¾åº¦ã€‚</p><p>ä»¥æˆ‘æœ€è¿‘æäº¤çš„ä¸€ä¸ª PR æ¥è¯´:<br><a href="https://github.com/StarRocks/starrocks/pull/50926">https://github.com/StarRocks/starrocks/pull/50926</a></p><p>æˆ‘ä¹‹å‰æ ¹æœ¬å°±æ²¡æœ‰æ¥è§¦è¿‡ OLAP ç›¸å…³çš„å†…å®¹ï¼Œä½†åªè¦æœ‰åœºæ™¯ï¼Œå¯ä»¥åœ¨æœ¬åœ° debug å¤ç°ï¼Œä»»ä½•é—®é¢˜éƒ½å¾ˆå¥½è§£å†³ï¼Œå³ä¾¿æ˜¯è¿™æ˜¯ä½ ä¸ç†Ÿçš„æŠ€æœ¯æ ˆã€‚</p><p>æ¯”å¦‚ ES ä¹Ÿæ˜¯ Java å†™çš„ï¼Œå¦‚æœä½ ä»¬å…¬å¸ä¸ºå®ƒä»˜è´¹äº†ï¼Œé‚£ä¸å¦‚å¤šèŠ±æ—¶é—´ç ”ç©¶ä¸€ä¸‹ï¼Œä¸ä¸€å®šæ˜¯éœ€è¦æ”¹å®ƒçš„æ ¸å¿ƒé€»è¾‘ï¼Œä¸Šå±‚ä¹Ÿæœ‰å¾ˆå¤šä¸œè¥¿å¯ä»¥å‚ä¸çš„ã€‚</p><p>è€Œä¸€æ—¦æˆ‘ä»¬å¯¹è¿™äº›æŠ€æœ¯æ ˆç†Ÿæ‚‰ä¹‹åï¼Œä»Šååœ¨æ¢å·¥ä½œæ—¶å°±æœ‰ç€å…¶ä»–äººä¸å…·å¤‡çš„ä¼˜åŠ¿ï¼Œç”šè‡³å¯ä»¥åŠ å…¥è¿™äº›æŠ€æœ¯èƒŒåçš„å•†ä¸šå…¬å¸ã€‚</p><p>è€Œè¿™äº›å…¬å¸å¤§éƒ¨åˆ†éƒ½æ˜¯æ»¡è¶³å¼€å‘è€…çš„å–œå¥½ï¼šæ¯”å¦‚è¿œç¨‹åŠå…¬ã€æŠ€æœ¯é©±åŠ¨ç­‰ï¼Œå¤§å®¶ä¸å¦¨ä»ç°åœ¨å°±å¯ä»¥è¯•è¯•ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¸ç®¡æ˜¯å“ªç§æŠ€æœ¯æœ€ç»ˆéƒ½æ˜¯è¦è½¬æ¢ä¸ºæˆ‘ä»¬åˆ°æ‰‹çš„æ”¶å…¥ï¼Œæ‰€ä»¥é€‰æ‹©å¯¹æ”¶å…¥æ›´åŠ æ•æ„Ÿçš„æŠ€æœ¯æ ˆè¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚</p><p>ä»¥ä¸Šçš„å†…å®¹ä¸»è¦æ˜¯é’ˆå¯¹åç«¯å¼€å‘ï¼Œå½“ç„¶è¿™é‡Œå¹¶ä¸åŒ…å«æƒ³è¦åšç‹¬ç«‹å¼€å‘çš„æŠ€æœ¯æ ˆï¼Œä¸»è¦è¿˜æ˜¯ç”¨äºæ±‚èŒã€‚</p><p>å¤§å®¶å¯ä»¥çœ‹çœ‹è‡ªå·±å…¬å¸ä»¥åŠæ›¾ç»çš„å…¬å¸æœ‰å¯¹å“ªäº›æŠ€æœ¯ä»˜è´¹ï¼Œæˆ–è€…æ˜¯ä¸€äº›éƒ½éœ€è¦çš„åˆšéœ€é€šç”¨çš„æŠ€æœ¯æ ˆï¼Œæ·±å…¥è¿™äº›æŠ€èƒ½å¯¹æé’±æˆ–å¤šæˆ–å°‘éƒ½æœ‰å¥½å¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;ä¹‹å‰åœ¨å…¬å¸ä¸»è¦è´Ÿè´£å¯è§‚æµ‹æ€§å’Œ Pulsar æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„å†…å®¹ï¼Œæœ€è¿‘ç³»ç»Ÿæ¯”è¾ƒç¨³å®šï¼Œåªéœ€è¦åšæ—¥å¸¸è¿ç»´ï¼Œæ‰€ä»¥å°±æŠ½å‡ºæ—¶é—´é€æ­¥åœ¨æ¥è§¦ OLAP ç›¸å…³çš„æŠ€æœ¯æ ˆã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬ç”¨çš„æ˜¯ &lt;a href=&quot;https://www.starrocks.io/&quot;&gt;StarRocks&lt;/a&gt;ï¼Œä¹Ÿæ˜¯ç›®å‰æ¯”è¾ƒæµè¡Œçš„ OLAP æ•°æ®åº“ï¼›åœ¨æ¥è§¦çš„è¿™æ®µæ—¶é—´ä»¥æ¥ï¼Œè®©æˆ‘è¶Šå‘æ„Ÿè§‰åˆ°é€‰å¯¹ä¸€ä¸ªé è°±çš„æŠ€æœ¯æ–¹å‘çš„é‡è¦æ€§ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¨èä¸€äº›å€¼å¾—å­¦ä¹ çš„å¼€æºé¡¹ç›®å’Œæ¡†æ¶</title>
    <link href="http://crossoverjie.top/2024/11/20/ob/%E6%8E%A8%E8%8D%90%E4%B8%80%E4%BA%9B%E5%80%BC%E5%BE%97%E5%AD%A6%E4%B9%A0%E7%9A%84%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%92%8C%E6%A1%86%E6%9E%B6/"/>
    <id>http://crossoverjie.top/2024/11/20/ob/%E6%8E%A8%E8%8D%90%E4%B8%80%E4%BA%9B%E5%80%BC%E5%BE%97%E5%AD%A6%E4%B9%A0%E7%9A%84%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%92%8C%E6%A1%86%E6%9E%B6/</id>
    <published>2024-11-20T09:06:46.000Z</published>
    <updated>2024-11-20T09:07:50.027Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2024/11/06/YtoOV3dMNEsqw4u.png" alt="image.png"><br>ä»Šå¤©æ”¶åˆ°çƒå‹çš„é—®é¢˜ï¼Œè®©æ¨èä¸€äº›å€¼å¾—çœ‹çš„å¼€æºé¡¹ç›®ï¼Œè§‰å¾— netty è¿™äº›å¤ªå¤æ‚äº†ä¸å¤ªå¥½ä¸Šæ‰‹ã€‚</p><p>ç¡®å®å¦‚æ­¤ï¼Œæˆ‘ä»¬æ—¥å¸¸å¸¸ç”¨çš„ Springã€Netty ç¡®å®ç”±äºå‘å±•äº†å¤šå¹´ï¼Œçœ‹èµ·æ¥æ¯”è¾ƒå¤´å¤§ã€‚</p><p>ä¸‹é¢æˆ‘æ¥æ¨èä¸€äº›æˆ‘çœ‹è¿‡åŒæ—¶è§‰å¾—ä¸é”™çš„é¡¹ç›®(å‡ ä¹éƒ½æ˜¯æˆ‘å‚ä¸è¿‡çš„ï¼‰ï¼Œç”±æ˜“åˆ°éš¾ï¼Œå…¶ä¸­ä¹Ÿä¼šåŒ…å« Java å’Œ Go çš„é¡¹ç›®ï¼ŒåŒ…å«ä¸»æµçš„ä¸­é—´ä»¶å’Œäº‘åŸç”Ÿé¡¹ç›®ã€‚</p><span id="more"></span><h1 id="Java-é¡¹ç›®"><a href="#Java-é¡¹ç›®" class="headerlink" title="Java é¡¹ç›®"></a>Java é¡¹ç›®</h1><h2 id="xxl-job"><a href="#xxl-job" class="headerlink" title="xxl-job"></a>xxl-job</h2><p>éš¾åº¦ï¼šğŸŒŸğŸŒŸ<br>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸ</p><p><img src="https://s2.loli.net/2024/11/06/xuLRoCfVhiFcjbz.png"></p><p><a href="https://github.com/xuxueli/xxl-job">xxl-job</a> æ˜¯ä¸€ä¸ªå¾ˆç»å…¸çš„è°ƒåº¦æ¡†æ¶ï¼Œç›®å‰åœ¨ GitHub ä¸Šä¹Ÿæœ‰ 27k star çš„å…³æ³¨ï¼Œå› ä¸ºåŠŸèƒ½ä¸å¤æ‚æ‰€ä»¥æœ€è¿‘ä¹Ÿæ²¡æœ‰æ€ä¹ˆæ›´æ–°äº†ã€‚</p><p>å¤§å®¶æ—¥å¸¸éƒ½ä¼šä½¿ç”¨è¿™ç±»è°ƒåº¦æ¡†æ¶ï¼Œæ‰€ä»¥ç†è§£éš¾åº¦éå¸¸ä½ï¼ŒåŠ ä¸Šä»–çš„å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ¯”å¦‚ï¼š</p><ul><li>ä½¿ç”¨ MySQL çš„é”æ¥ç®€å•ç²—æš´çš„è§£å†³åˆ†å¸ƒå¼é”çš„é—®é¢˜</li><li>çº¿ç¨‹æ± çš„ä½¿ç”¨ï¼šå› ä¸ºæ¯ä¸ªä»»åŠ¡çš„è°ƒåº¦éƒ½éœ€è¦å°½å¯èƒ½çš„äº’ç›¸ä¸å½±å“ï¼Œæ‰€ä»¥é‡Œé¢å¤§é‡ä½¿ç”¨äº†çº¿ç¨‹æ± ï¼ŒåŒæ—¶å¯¹å¦‚ä½•è·å–å¼‚æ­¥ä»»åŠ¡ç»“æœä¹Ÿæœ‰ä¸€äº›æœ€ä½³å®è·µã€‚</li><li>RPC è°ƒç”¨ï¼šé‡Œé¢å†…ç½®äº†ä¸€ä¸ª <a href="https://github.com/xuxueli/xxl-rpc">RPC</a> æ¡†æ¶ï¼Œä¹Ÿæ˜¯ä½œè€…ç¼–å†™çš„ï¼Œå…¶ä¸­çš„å®ç°åŸç†ä¹Ÿä¸å¤æ‚ï¼Œå»ºè®®çœ‹çœ‹æºç ï¼Œå¯ä»¥æ›´å¥½çš„ç†è§£æˆ‘ä»¬åœ¨å·¥ä½œä¸­ç”¨åˆ° rpc æ¡†æ¶ã€‚</li></ul><h2 id="cim"><a href="#cim" class="headerlink" title="cim"></a>cim</h2><p>éš¾åº¦ï¼šğŸŒŸğŸŒŸğŸŒŸ<br>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸ<br>è¿™é‡Œå¤¹äº†ä¸€ç‚¹ç§è´§ï¼Œå°±æ˜¯æˆ‘è‡ªå·±å¼€æºçš„ä¸€ä¸ª<a href="https://github.com/crossoverJie/cim">åˆ†å¸ƒå¼å³æ—¶é€šè®¯ç³»ç»Ÿ</a>ï¼Œå…¶å®ç°åœ¨æ¥çœ‹ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„ä»£ç å†™çš„æŒºçƒ‚çš„ï¼Œä¸è¿‡å¥½åœ¨æœ€è¿‘å‘å¸ƒäº† v2.0.0ï¼Œæå‡äº†ä¸å°‘ä»£ç è´¨é‡ã€‚</p><p><img src="https://s2.loli.net/2024/10/14/pBvDML4HVgyYZxS.gif" alt="Oct-14-2024 11-09-54-min.gif"><br>å®ƒå…·å¤‡ IM å³æ—¶é€šè®¯çš„åŸºæœ¬åŠŸèƒ½ï¼ŒåŒæ—¶åŸºäºå®ƒå¯ä»¥å®ç°ï¼š</p><ul><li>å³æ—¶é€šè®¯</li><li>æ¶ˆæ¯æ¨é€</li><li>IOT æ¶ˆæ¯å¹³å°</li></ul><p>é€šè¿‡ cim ä½ å¯ä»¥å­¦ä¹ åˆ°åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼š</p><ul><li>å…ƒæ•°æ®æ˜¯å¦‚ä½•å­˜æ”¾å’ŒåŒæ­¥çš„ã€‚</li><li>RPC è°ƒç”¨å¦‚ä½•å®ç°ã€‚</li><li>é•¿é“¾æ¥ç³»ç»Ÿå¦‚ä½•å®ç°ã€‚</li><li>å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿå¦‚ä½•åšé›†æˆæµ‹è¯•ç­‰ã€‚</li></ul><p>è¯¦ç»†çš„ä»‹ç»å¯ä»¥æŸ¥çœ‹é¡¹ç›®é¦–é¡µçš„ <a href="https://github.com/crossoverJie/cim">readme</a>ï¼Œå‘ç°æœ‰ä»€ä¹ˆéœ€è¦ä¼˜åŒ–çš„åœ°æ–¹ï¼ˆå…¶å®è¿˜è›®å¤š todo æ²¡æœ‰åšï¼‰éƒ½æ¬¢è¿æäº¤ PRã€‚</p><h2 id="PowerJob"><a href="#PowerJob" class="headerlink" title="PowerJob"></a>PowerJob</h2><p>éš¾åº¦ï¼šğŸŒŸğŸŒŸğŸŒŸ<br>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ<br><a href="https://github.com/PowerJob/PowerJob">PowerJob</a> ä¹Ÿæ˜¯ä¸€ä¸ªè°ƒåº¦æ¡†æ¶ï¼Œåªæ˜¯ä»–æœ‰åå‘ä¼˜åŠ¿ï¼Œç»“åˆäº†å¸‚é¢ä¸Šå…¶ä»–è°ƒåº¦ç³»ç»Ÿçš„ä¼˜ç‚¹åŒæ—¶ä¹Ÿæ–°å¢äº†ä¸€äº›åŠŸèƒ½ï¼Œä»¥ä¸‹æ˜¯ä»–åŠŸèƒ½çš„å®˜æ–¹å¯¹æ¯”å›¾ï¼š<br><img src="https://s2.loli.net/2024/11/07/Ngab96HlYstJOyT.png"><br>ç¤¾åŒºç›¸å¯¹äº xxl-job ä¹Ÿæ›´åŠ æ´»è·ƒï¼Œç›®å‰åˆšå‘å¸ƒäº† <code>5.1.0</code> ç‰ˆæœ¬ï¼ŒåŒæ—¶ç¤¾åŒºä¹Ÿæ•´ç†è®¸å¤šå­¦ä¹ çš„æ–‡ç« å’Œ<a href="https://www.yuque.com/powerjob/guidence/wu2e93">èµ„æ–™</a>ï¼š</p><p><img src="https://s2.loli.net/2024/11/07/aGUzAwhX5CE2Lbj.png" alt="image.png"></p><p>å®ƒä½¿ç”¨äº† Akka æ¥å®ç°è¿œç¨‹é€šä¿¡ï¼Œå¯¹è¿™éƒ¨åˆ†å†…å®¹æ„Ÿå…´è¶£çš„æœ‹å‹ä¸å®¹é”™è¿‡ï¼Œå¯ä»¥çœ‹åˆ°ä¸€äº›æœ€ä½³å®è·µã€‚<br>å…¶ä¸­çš„ä»£ç å†™çš„ä¹Ÿå¾ˆè§„èŒƒï¼Œä¸€äº›ç±»çš„è®¾è®¡å¾ˆå¥½ï¼Œå¯æ‰©å±•æ€§å¾ˆé«˜ï¼Œæ¯”å¦‚å¸¸ç”¨çš„æ‰§è¡Œå™¨éƒ½æ˜¯é€šè¿‡ä¸€ä¸ª<br><code>MapProcessor</code> æ‰©å±•è€Œæ¥çš„ã€‚<br><img src="https://s2.loli.net/2024/11/07/SO2eRbvqrI5EGyU.png" alt="image.png"><br><img src="https://s2.loli.net/2024/11/07/rvabkCdo4g3FTyU.png" alt="image.png"></p><p>æ¨èå¤§å®¶ä»ä»»åŠ¡è°ƒåº¦é‚£ä¸€å—å¼€å§‹çœ‹ï¼š<code>tech.powerjob.worker.actors.TaskTrackerActor#onReceiveServerScheduleJobReq</code></p><h2 id="Pulsar"><a href="#Pulsar" class="headerlink" title="Pulsar"></a>Pulsar</h2><p>éš¾åº¦ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ<br>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ<br><img src="https://s2.loli.net/2024/11/07/2MFiE1vPSfl69ty.png" alt="image.png"><br>Pulsar æ˜¯ç›®å‰ä¸»æµçš„äº‘åŸç”Ÿæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œç°åœ¨ä½¿ç”¨çš„å…¬å¸ä¹Ÿéå¸¸å¤šï¼Œé€šè¿‡ä»–ä½ å¯ä»¥å­¦ä¹ åˆ°ï¼š</p><ul><li>API è®¾è®¡ï¼šPulsar çš„ client æ˜¯ç›´æ¥é¢å‘å¼€å‘è€…çš„ï¼Œåœ¨æ˜“ç”¨æ€§çš„å‰æä¸‹æ¯æ¬¡è¿­ä»£å‡çº§è¿˜è¦è€ƒè™‘åˆ°å…¼å®¹æ€§ã€‚</li><li>å¼‚æ­¥è°ƒç”¨ï¼šPulsar é‡Œå‡ ä¹æ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥å¤§é‡ä½¿ç”¨äº†å¼‚æ­¥â•å›è°ƒï¼ˆè™½ç„¶ä¹Ÿæœ‰ä¸€äº›å‘ï¼‰ï¼Œå¯ä»¥å­¦åˆ°ä¸€äº›é«˜æ€§èƒ½ä»£ç çš„ç¼–å†™æ–¹å¼ã€‚</li><li>Netty çš„æœ€ä½³ç”¨æ³•ï¼šæ¶ˆæ¯æ”¶å‘çš„åº•å±‚ç½‘ç»œæ¡†æ¶ä¹Ÿæ˜¯ Netty æ”¯æ’‘çš„ï¼ŒPulsar å¯¹å®ƒåšäº†å°è£…ã€‚</li><li>åŸºäº protocol çš„å¤šè¯­è¨€å®¢æˆ·ç«¯ã€‚<ul><li>å› ä¸º Pulsar çš„é€šä¿¡ç¼–è§£ç ä½¿ç”¨çš„æ˜¯ protocolï¼Œæœ¬èº«æ˜¯å¯ä»¥åŸºäºå®ƒç”Ÿæˆå„ç§è¯­è¨€çš„ APIï¼Œæ‰€ä»¥åœ¨æ­¤åŸºç¡€ä¸Šç¼–å†™å…¶ä»–è¯­è¨€çš„å®¢æˆ·ç«¯å°±éå¸¸æ–¹ä¾¿ã€‚</li></ul></li></ul><p>ä¸è¿‡ç”±äº Pulsar æœ¬èº«çš„å¤æ‚æ€§ï¼Œä¸Šæ‰‹èµ·æ¥é—¨æ§›è¿˜æ˜¯ä¸ä½ï¼Œæ¨èå…ˆä»å®¢æˆ·ç«¯çš„ä»£ç ï¼ˆJava å’Œ  Go çš„éƒ½å¯ä»¥ï¼‰ä¸Šæ‰‹ã€‚</p><h2 id="StarRocks"><a href="#StarRocks" class="headerlink" title="StarRocks"></a>StarRocks</h2><p>éš¾åº¦ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ<br>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ<br><img src="https://s2.loli.net/2024/11/08/zZ8jD9JU1tSkm6A.png" alt="image.png"></p><p>StarRocks ä¹Ÿæ˜¯æˆ‘æœ€è¿‘æ‰æ¥è§¦åˆ°çš„ OLAP æ•°æ®åº“é¡¹ç›®ï¼Œä»¥å‰å¯¹è¿™ä¸ªé¢†åŸŸçš„ç§¯ç´¯å‡ ä¹ä¸ºé›¶ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ä»å¤´å­¦ä¹ ã€‚</p><p>å¥½åœ¨è¿™æ®µæ—¶é—´å› ä¸ºæœ‰éœ€æ±‚ä¹Ÿç»™å®ƒæäº¤äº†å‡ ä¸ª PRï¼Œé€æ¸ç†Ÿæ‚‰èµ·æ¥äº†ã€‚<br><img src="https://s2.loli.net/2024/11/08/gVb15UWrwXHq8YI.png" alt="image.png"></p><p>æˆ‘æ¥è§¦ä¸‹æ¥è¿™äº›å¼€æºé¡¹ç›®ï¼Œå‘ç° StarRocks è¿™ç±»æ•°æ®åº“é¡¹ç›®æ˜¯æœ€æœ‰å‰ï¼ˆé’±ï¼‰æ™¯çš„ï¼Œæ¯•ç«Ÿå’Œæ•°æ®æ‰“äº¤é“çš„äº§å“å…¬å¸çš„ä»˜è´¹æ„æ„¿ä¼šæ›´é«˜ä¸€äº›ã€‚</p><p>ä¸è¿‡è¯¥é¡¹ç›®ç¡®å®å¯¹æ–°æ‰‹ä¸å¤ªå‹å¥½ï¼Œæœ€å¥½æ˜¯å·²ç»æ¥è§¦è¿‡å¤§æ•°æ®é¢†åŸŸå†å­¦ä¹ ä¼šæ›´åˆé€‚ä¸€äº›ï¼Œä½†ä¹Ÿä¸è¦æ€•ï¼Œæˆ‘å°±æ˜¯ä¸€ä¸ªçº¯å°ç™½ï¼Œæ²¡åŸºç¡€å°±è·Ÿç€ä»£ç  debugï¼Œåæ­£éƒ½æ˜¯ Java å†™çš„æ€»èƒ½çœ‹æ‡‚ã€‚</p><p>è¿™é‡Œæ¨èå…ˆçœ‹çœ‹æˆ‘ä¹‹å‰å†™çš„<a href="https://crossoverjie.top/2024/10/09/ob/StarRocks-dev-env-build/">æœ¬åœ°æ­å»ºå¼€å‘ç¯å¢ƒ</a>ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ idea é‡Œ debug äº†ã€‚</p><h2 id="OpenTelemetry"><a href="#OpenTelemetry" class="headerlink" title="OpenTelemetry"></a>OpenTelemetry</h2><p>éš¾åº¦ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ<br>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ<br><img src="https://s2.loli.net/2024/08/08/p5WkVbSarUdIQwT.png"><br>OpenTelemetry ç°åœ¨ä½œä¸ºäº‘åŸç”Ÿå¯è§‚æµ‹æ€§çš„äº‹å®æ ‡å‡†ï¼Œç°åœ¨å·²ç»é€æ­¥æˆä¸ºå„å¤§å…¬å¸å¿…å¤‡çš„æŠ€æœ¯æ ˆäº†ã€‚</p><p>é€šè¿‡ä¸€ä¸ª <code>javaagent</code> å°±å¯ä»¥è‡ªåŠ¨é‡‡é›†åº”ç”¨çš„ traceã€metricsã€logs ç­‰æ•°æ®ï¼Œè¿™é‡Œå…ˆæ¨è <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/">opentelemetry-java-instrumentation</a>ï¼Œå› ä¸ºæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨æœ€å¤šçš„å°±æ˜¯åŸºäºè¿™ä¸ªé¡¹ç›®æ‰“åŒ…å‡ºæ¥çš„ <code>javaagent</code>ï¼Œé€šè¿‡å®ƒå¯ä»¥å­¦ä¹ åˆ°ï¼š</p><ul><li>å¦‚ä½•ç¼–å†™ä»»æ„å‡½æ•°çš„æ‹¦æˆªå™¨</li><li>trace ä¿¡æ¯æ˜¯å¦‚ä½•åœ¨çº¿ç¨‹å’Œè¿›ç¨‹ä¹‹é—´ä¼ é€’çš„</li><li>ä¸€äº›å¸¸ç”¨æ¡†æ¶æ˜¯å¦‚ä½•è¿è¡Œçš„<ul><li>æ¯”å¦‚ä½ éœ€è¦äº†è§£ <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/tree/main/instrumentation/grpc-1.6">gRPC</a> çš„åŸç†ï¼Œå°±å¯ä»¥æŸ¥çœ‹ OpenTelemetry æ˜¯å¦‚ä½•å¯¹ä»–åŸ‹ç‚¹çš„ï¼Œä»è€ŒçŸ¥æ™“ä»–çš„æ ¸å¿ƒåŸç†ã€‚</li></ul></li><li>ä¼˜é›…çš„ API è®¾è®¡</li></ul><p><img src="https://s2.loli.net/2024/11/08/1yenwuxJ9C6tOSb.png" alt="image.png"><br>åŒæ—¶ OpenTelemetry ç®—æ˜¯æˆ‘çœ‹è¿‡æœ€ä¼˜é›…çš„ä»£ç ä¹‹ä¸€äº†ï¼Œéå¸¸å»ºè®®å¤§å®¶éƒ½çœ‹çœ‹ã€‚</p><p>å¦‚æœå¯¹ OpenTelemetry è¿˜ä¸å¤ªç†Ÿæ‚‰ï¼Œå¯ä»¥å…ˆçœ‹çœ‹æˆ‘<a href="https://crossoverjie.top/tags/OpenTelemetry/">ä¹‹å‰å†™è¿‡çš„æ–‡ç« </a>ã€‚</p><h1 id="Goï¼ˆäº‘åŸç”Ÿé¡¹ç›®ï¼‰"><a href="#Goï¼ˆäº‘åŸç”Ÿé¡¹ç›®ï¼‰" class="headerlink" title="Goï¼ˆäº‘åŸç”Ÿé¡¹ç›®ï¼‰"></a>Goï¼ˆäº‘åŸç”Ÿé¡¹ç›®ï¼‰</h1><h2 id="cprobe"><a href="#cprobe" class="headerlink" title="cprobe"></a>cprobe</h2><p>éš¾åº¦ï¼šğŸŒŸğŸŒŸğŸŒŸ<br>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸ</p><p><a href="https://github.com/cprobe/cprobe">cprobe</a> å±äºå¯è§‚æµ‹æ€§é¡¹ç›®ï¼Œä»–çš„ç›®çš„æ˜¯å¯ä»¥æŠŠå„ç§ exporter éƒ½æ•´åˆåœ¨ä¸€èµ·ï¼Œæ¯”å¦‚ <code>kafka_exporter</code>, <code>nginx_exporter</code>, <code>mysql_exporter</code> ç­‰ã€‚</p><p>åŒæ—¶è¿˜åšäº†ä¸Šå±‚æŠ½è±¡ï¼Œå¯ä»¥ç»Ÿä¸€ç®¡ç†å„ç§ç›‘æ§å¯¹è±¡çš„é…ç½®ï¼Œè¿™æ ·å°±å¯ä»¥éƒ¨ç½²ä¸€ä¸ªè¿›ç¨‹ç›‘æ§æ‰€æœ‰çš„åº”ç”¨äº†ã€‚</p><p>é€šè¿‡è¿™ä¸ªé¡¹ç›®å¯ä»¥å­¦åˆ°ï¼š</p><ul><li>ç›‘æ§ä½“ç³»çš„åŸºç¡€çŸ¥è¯†ï¼Œæ¯”å¦‚ Prometheus å’Œ metrics ç­‰</li><li>Go è¯­è¨€çš„åŸºæœ¬ç”¨æ³•</li></ul><p>æˆ‘ä¹‹å‰å†™è¿‡ä¸€ç¯‡ <a href="https://crossoverjie.top/2024/01/25/ob/create-a-plugin-for-cprobe/">æ‰‹æŠŠæ‰‹æ•™ä½ ä¸ºå¼€æºé¡¹ç›®è´¡çŒ®ä»£ç </a>å°±æ˜¯ä»¥ cprobe ä¸ºä¾‹æ¥ä»‹ç»çš„ã€‚</p><h2 id="VictoriaLogs"><a href="#VictoriaLogs" class="headerlink" title="VictoriaLogs"></a>VictoriaLogs</h2><p>éš¾åº¦ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ<br>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</p><p>è¿™æ˜¯ä¸€ä¸ªå±äº <a href="https://github.com/VictoriaMetrics/VictoriaMetrics/tree/master/app/victoria-logs">VictoriaMetrics</a> çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œé€šè¿‡è¿™ä¸ªåå­—åº”è¯¥ä¼šçŸ¥é“ä»–ä¸»è¦ç”¨äºå¤„ç†æ—¥å¿—ï¼Œå¯ä»¥æŠŠä»–ç†è§£ä¸º ElasticSearch çš„ç®€æ˜“ç‰ˆï¼Œè™½ç„¶åŠŸèƒ½ç®€å•äº†ä½†èµ„æºæ¶ˆè€—ä¹Ÿä¼šæ¯” ES ä½å¾ˆå¤šï¼Œå…·ä½“å¯ä»¥çœ‹ä¸‹é¢çš„å‹æµ‹å›¾ï¼š</p><p><img src="https://s2.loli.net/2023/08/23/3Epxdzie8q5tVmY.png" alt="image.png"></p><p>é€šè¿‡è¿™ä¸ªé¡¹ç›®å¯ä»¥å­¦åˆ°ï¼š</p><ul><li>æ•°æ®åœ¨ç£ç›˜ä¸­æ˜¯å¦‚ä½•å­˜å‚¨å’ŒæŸ¥è¯¢çš„</li><li>Go è¯­è¨€ä¸­å…³äº <code>goroutine</code> å’Œ <code>channel</code> çš„ä¸€äº›æœ€ä½³å®è·µ<br>ç›®å‰çš„ç‰ˆæœ¬è¿˜æ¯”è¾ƒæ—©ï¼Œæ‰€ä»¥ä»£ç éƒ½ä¸å¤ªå¤æ‚ï¼Œå»ºè®®å¤§å®¶å¯ä»¥ä»æŸ¥è¯¢çš„å…¥å£å¼€å§‹<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/master/lib/logstorage/storage_search.go">çœ‹èµ·</a>ã€‚</li></ul><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šéƒ½æ˜¯æˆ‘æ­£ç»æ¥è§¦è¿‡çš„é¡¹ç›®ï¼Œå¦‚æœæ˜¯æƒ³é•¿æœŸè€•è€˜åŒæ—¶æé’±çš„è¯ï¼Œæ¨è <code>StarRocks</code>ï¼Œç›®å‰ä¹Ÿå¾ˆç«ã€‚</p><p>å¦‚æœåªæ˜¯æƒ³æå‡åœ¨ Java é¢†åŸŸçš„æ°´å¹³ï¼Œé‚£æ¨è Pulsar å’Œ OpenTelemetryï¼Œéƒ½æœ‰å¾ˆå¤šä»£ç æœ€ä½³å®è·µã€‚</p><p>å¦‚æœæƒ³è¦å…¥å‘äº‘åŸç”Ÿå’Œ Go é¡¹ç›®ï¼Œé‚£ cprobe æ˜¯æ¯”è¾ƒåˆé€‚çš„ã€‚</p><p>å½“ç„¶ä¸ç®¡æ˜¯å“ªä¸ªé¡¹ç›®æœ€ä¸»è¦çš„è¿˜æ˜¯åšæŒï¼Œå¾ˆå¤šé¡¹ç›®å¦‚æœåªæ˜¯å¶å°”çœ‹ä¸€ä¸‹å¾ˆå®¹æ˜“å¿˜è®°ï¼Œèµ·ç è¦åšåˆ°çœŸæ­£è¿è¡Œèµ·æ¥ç„¶å debug è¿‡ä»£ç ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://www.yuque.com/powerjob/guidence/wu2e93">https://www.yuque.com/powerjob/guidence/wu2e93</a></li><li><a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/master/lib/logstorage/storage_search.go">https://github.com/VictoriaMetrics/VictoriaMetrics/blob/master/lib/logstorage/storage_search.go</a></li><li><a href="https://crossoverjie.top/tags/OpenTelemetry/">https://crossoverjie.top/tags/OpenTelemetry/</a></li><li><a href="https://crossoverjie.top/2024/10/09/ob/StarRocks-dev-env-build/">https://crossoverjie.top/2024/10/09/ob/StarRocks-dev-env-build/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/11/06/YtoOV3dMNEsqw4u.png&quot; alt=&quot;image.png&quot;&gt;&lt;br&gt;ä»Šå¤©æ”¶åˆ°çƒå‹çš„é—®é¢˜ï¼Œè®©æ¨èä¸€äº›å€¼å¾—çœ‹çš„å¼€æºé¡¹ç›®ï¼Œè§‰å¾— netty è¿™äº›å¤ªå¤æ‚äº†ä¸å¤ªå¥½ä¸Šæ‰‹ã€‚&lt;/p&gt;
&lt;p&gt;ç¡®å®å¦‚æ­¤ï¼Œæˆ‘ä»¬æ—¥å¸¸å¸¸ç”¨çš„ Springã€Netty ç¡®å®ç”±äºå‘å±•äº†å¤šå¹´ï¼Œçœ‹èµ·æ¥æ¯”è¾ƒå¤´å¤§ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘æ¥æ¨èä¸€äº›æˆ‘çœ‹è¿‡åŒæ—¶è§‰å¾—ä¸é”™çš„é¡¹ç›®(å‡ ä¹éƒ½æ˜¯æˆ‘å‚ä¸è¿‡çš„ï¼‰ï¼Œç”±æ˜“åˆ°éš¾ï¼Œå…¶ä¸­ä¹Ÿä¼šåŒ…å« Java å’Œ Go çš„é¡¹ç›®ï¼ŒåŒ…å«ä¸»æµçš„ä¸­é—´ä»¶å’Œäº‘åŸç”Ÿé¡¹ç›®ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OpenSource" scheme="http://crossoverjie.top/categories/OpenSource/"/>
    
    
    <category term="OpenSource" scheme="http://crossoverjie.top/tags/OpenSource/"/>
    
  </entry>
  
  <entry>
    <title>StarRocks ç‰©åŒ–è§†å›¾åˆ·æ–°æµç¨‹å’ŒåŸç†</title>
    <link href="http://crossoverjie.top/2024/11/18/ob/StarRocks-MV-refresh-Principle/"/>
    <id>http://crossoverjie.top/2024/11/18/ob/StarRocks-MV-refresh-Principle/</id>
    <published>2024-11-18T14:35:25.000Z</published>
    <updated>2024-11-18T10:46:12.231Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ®µæ—¶é—´ç»™ StarRocks çš„ç‰©åŒ–è§†å›¾æ–°å¢äº†ä¸€ä¸ª<a href="https://github.com/StarRocks/starrocks/pull/50926">ç‰¹æ€§</a>ï¼Œé‚£ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦ StarRocksï¼Œå› ä¸ºå®Œå…¨ä¸ç†Ÿæ‚‰è¿™ä¸ªæ•°æ®åº“ï¼Œæ‰€ä»¥å¾ˆå¤šä¸œè¥¿éƒ½æ˜¯ä»å¤´å¼€å§‹äº†è§£æ¦‚å¿µã€‚</p><p>ä¸ºäº†èƒ½é¡ºåˆ©çš„æ–°å¢è¿™ä¸ªç‰¹æ€§ï¼ˆå…·ä½“å†…å®¹å¯ä»¥è§åæ–‡ï¼‰ï¼Œæˆ‘éœ€è¦æŠŠæ•´ä¸ªç‰©åŒ–è§†å›¾çš„æµç¨‹ä¸²è”ä¸€éï¼Œäºæ˜¯ä¾¿æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚</p><p>åœ¨å¼€å§‹ä¹‹å‰ç®€å•äº†è§£ä¸‹ç‰©åŒ–è§†å›¾çš„åŸºæœ¬æ¦‚å¿µï¼š</p><p><img src="https://s2.loli.net/2024/11/13/TMAjuUsEZGJiFDS.png" alt="image.png"></p><p>ç®€å•æ¥è¯´ï¼Œè§†å›¾å’Œ MySQL è¿™ç±»ä¼ ç»Ÿæ•°æ®åº“çš„æ¦‚å¿µç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”¨äºè§£å†³å¤§é‡æ¶ˆè€—æ€§èƒ½çš„ SQL çš„ï¼Œå¯ä»¥æå‰å°†è¿™äº›æ•°æ®æŸ¥è¯¢å¥½ç„¶åæ”¾åœ¨ä¸€å¼ å•ç‹¬çš„è¡¨ä¸­ï¼Œè¿™æ ·å†æŸ¥è¯¢çš„æ—¶å€™æ€§èƒ½æ¶ˆè€—å°±æ¯”è¾ƒä½äº†ã€‚</p><span id="more"></span><h1 id="åˆ·æ–°æ¡ä»¶"><a href="#åˆ·æ–°æ¡ä»¶" class="headerlink" title="åˆ·æ–°æ¡ä»¶"></a>åˆ·æ–°æ¡ä»¶</h1><p>ä¸ºäº†ä¿è¯è§†å›¾æ•°æ®çš„å®æ—¶æ€§ï¼Œè¿˜éœ€è¦åœ¨æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™èƒ½å¤ŸåŠæ—¶åˆ·æ–°è§†å›¾é‡Œçš„æ•°æ®ï¼Œç›®å‰æœ‰è¿™å‡ ä¸ªåœ°æ–¹ä¼šè§¦å‘è§†å›¾åˆ·æ–°ï¼š<br><img src="https://s2.loli.net/2024/11/13/vJFQBAyfus5ZwIT.png" alt="image.png"></p><ul><li>æ‰‹åŠ¨åˆ·æ–°è§†å›¾ï¼Œä½¿ç”¨ <code>REFRESH MATERIALIZED VIEW order_mv;</code> è¯­å¥</li><li>å°†è§†å›¾è®¾ç½®ä¸º active çŠ¶æ€ï¼š<code>ALTER MATERIALIZED VIEW order_mv ACTIVE;</code></li><li>åŸºè¡¨æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘åˆ·æ–°ã€‚<ul><li><img src="https://s2.loli.net/2024/11/13/6QCojHZEJcUL4t2.png" alt="image.png"></li></ul></li><li>truncate åŸºè¡¨æ—¶è§¦å‘åˆ·æ–°ï¼š<code>truncate table trunc_db.t1;</code> </li><li>drop partition æ—¶è§¦å‘ï¼š<code>ALTER TABLE &lt;tbl_name&gt; DROP PARTITION(S) p0, p1 [, ...];</code></li></ul><p>è¿™é‡Œçš„ truncate table  å’Œ drop partition ç›®å‰çš„ç‰ˆæœ¬è¿˜å­˜åœ¨ bugï¼šå½“åŸºè¡¨å’Œç‰©åŒ–è§†å›¾ä¸åœ¨ä¸€ä¸ªæ•°æ®åº“æ—¶ä¸ä¼šè§¦å‘è‡ªåŠ¨åˆ·æ–°ï¼Œç›®å‰å·²ç»ä¿®å¤äº†ã€‚</p><p><img src="https://s2.loli.net/2024/11/13/2wtZfnFTUbsHaY4.png" alt="image.png"></p><ul><li><a href="https://github.com/StarRocks/starrocks/pull/52618">https://github.com/StarRocks/starrocks/pull/52618</a></li><li><a href="https://github.com/StarRocks/starrocks/pull/52295">https://github.com/StarRocks/starrocks/pull/52295</a></li></ul><h1 id="åˆ·æ–°æµç¨‹"><a href="#åˆ·æ–°æµç¨‹" class="headerlink" title="åˆ·æ–°æµç¨‹"></a>åˆ·æ–°æµç¨‹</h1><p><img src="https://s2.loli.net/2024/11/14/QljDLmRrx97EIK6.png" alt="image.png"></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œå½“è§¦å‘ä¸€æ¬¡åˆ·æ–°ä¹‹åä¸»è¦å°±æ˜¯éœ€è¦è®¡ç®—å‡ºéœ€è¦åˆ·æ–°çš„åˆ†åŒºã€‚</p><p>ç¬¬ä¸€æ¬¡è§¦å‘åˆ·æ–°çš„æ—¶å€™æ˜¯ä¸ä¼šå¸¦ä¸Šå‘¨æœŸï¼ˆæ¯”å¦‚æ—¶é—´èŒƒå›´ï¼‰ï¼Œç„¶åæ ¹æ®è¿‡æ»¤è®¡ç®—å‡ºæ¥çš„å‘¨æœŸï¼Œé»˜è®¤æƒ…å†µä¸‹åªä¼šä½¿ç”¨ç¬¬ä¸€ä¸ªå‘¨æœŸï¼ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>partition_refresh_number</code> å‚æ•°æ¥è°ƒæ•´å•æ¬¡åˆ·æ–°çš„åˆ†åŒºæ•°é‡ï¼‰ã€‚</p><p><img src="https://s2.loli.net/2024/11/14/3QFtkXRfvhCdNrS.png"></p><p>ç„¶åå¦‚æœè¿˜æœ‰å…¶ä½™çš„å‘¨æœŸï¼Œä¼šå°†è¿™äº›å‘¨æœŸé‡æ–°è§¦å‘ä¸€æ¬¡åˆ·æ–°ä»»åŠ¡ï¼ˆä¼šå¸¦ä¸Šåˆšæ‰å‰©ä½™çš„å‘¨æœŸæ•°æ®ï¼‰ï¼Œè¿™æ ·è¿›è¡Œé€’å½’æ‰§è¡Œã€‚</p><p><img src="https://s2.loli.net/2024/11/15/OqjuMl1LNkWh39g.png"></p><p>é€šè¿‡æ—¥å¿—ä¼šçœ‹åˆ°è¿”å›çš„åˆ†åŒºæ•°æ®ã€‚</p><h1 id="æ–°å¢ä¼˜åŒ–å‚æ•°"><a href="#æ–°å¢ä¼˜åŒ–å‚æ•°" class="headerlink" title="æ–°å¢ä¼˜åŒ–å‚æ•°"></a>æ–°å¢ä¼˜åŒ–å‚æ•°</h1><p>æˆ‘ä»¬åœ¨ä½¿ç”¨ç‰©åŒ–è§†å›¾çš„æ—¶å€™ï¼Œç¢°åˆ°ä¸€ä¸ªåœºæ™¯ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> test.par_tbl1</span><br><span class="line">(</span><br><span class="line">    datekey DATETIME,</span><br><span class="line">    k1      <span class="type">INT</span>,</span><br><span class="line">    item_id STRING,</span><br><span class="line">    v2      <span class="type">INT</span></span><br><span class="line">)<span class="keyword">PRIMARY</span> KEY (`datekey`,`k1`)</span><br><span class="line"> <span class="keyword">PARTITION</span> <span class="keyword">BY</span> date_trunc(<span class="string">&#x27;day&#x27;</span>, `datekey`);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> test.par_tbl2</span><br><span class="line">(</span><br><span class="line">    datekey DATETIME,</span><br><span class="line">    k1      <span class="type">INT</span>,</span><br><span class="line">    item_id STRING,</span><br><span class="line">    v2      <span class="type">INT</span></span><br><span class="line">)<span class="keyword">PRIMARY</span> KEY (`datekey`,`k1`)</span><br><span class="line"> <span class="keyword">PARTITION</span> <span class="keyword">BY</span> date_trunc(<span class="string">&#x27;day&#x27;</span>, `datekey`);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> test.par_tbl3</span><br><span class="line">(</span><br><span class="line">    datekey DATETIME,</span><br><span class="line">    k1      <span class="type">INT</span>,</span><br><span class="line">    item_id STRING,</span><br><span class="line">    v2      <span class="type">INT</span></span><br><span class="line">)</span><br><span class="line"> <span class="keyword">PRIMARY</span> KEY (`datekey`,`k1`);</span><br></pre></td></tr></table></figure><p>ä½†æˆ‘ä»¬æœ‰ä¸‰å¼ åŸºè¡¨ï¼Œå…¶ä¸­ 1 å’Œ 2 éƒ½æ˜¯åˆ†åŒºè¡¨ï¼Œä½†æ˜¯ 3 æ˜¯éåˆ†åŒºè¡¨ã€‚</p><p>æ­¤æ—¶åŸºäºä»–ä»¬æ–°å»ºäº†ä¸€ä¸ªç‰©åŒ–è§†å›¾ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span></span><br><span class="line">MATERIALIZED <span class="keyword">VIEW</span> test.mv_test</span><br><span class="line">REFRESH ASYNC</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> a_time</span><br><span class="line">PROPERTIES (</span><br><span class="line">&quot;excluded_trigger_tables&quot; <span class="operator">=</span> &quot;par_tbl3&quot;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">select</span> date_trunc(&quot;day&quot;, a.datekey) <span class="keyword">as</span> a_time, date_trunc(&quot;day&quot;, b.datekey) <span class="keyword">as</span> b_time,date_trunc(&quot;day&quot;, c.datekey) <span class="keyword">as</span> c_time</span><br><span class="line"><span class="keyword">from</span> test.par_tbl1 a</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> test.par_tbl2 b <span class="keyword">on</span> a.datekey <span class="operator">=</span> b.datekey <span class="keyword">and</span> a.k1 <span class="operator">=</span> b.k1</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> test.par_tbl3 c <span class="keyword">on</span> a.k1 <span class="operator">=</span> c.k1;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘åŒæ—¶æ›´æ–°äº†åˆ†åŒºè¡¨å’Œéåˆ†åŒºè¡¨çš„æ•°æ®æ—¶ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> `par_tbl1` <span class="keyword">SET</span> `v2` <span class="operator">=</span> <span class="number">2</span> <span class="keyword">WHERE</span> `datekey` <span class="operator">=</span> <span class="string">&#x27;2024-08-05 01:00:00&#x27;</span> <span class="keyword">AND</span> `k1` <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> `par_tbl3` <span class="keyword">SET</span> `item_id` <span class="operator">=</span> <span class="string">&#x27;3&#x27;</span> <span class="keyword">WHERE</span> `datekey` <span class="operator">=</span> <span class="string">&#x27;2024-10-01 01:00:00&#x27;</span> <span class="keyword">AND</span> `k1` <span class="operator">=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>é¢„æœŸçš„ç»“æœæ˜¯åªæœ‰ <code>par_tbl1</code> è¡¨é‡Œä¿®æ”¹çš„æ•°æ®ä¼šè¢«åŒæ­¥åˆ°è§†å›¾ï¼ˆ<code>&quot;excluded_trigger_tables&quot; = &quot;par_tbl3&quot;</code>å·²ç»è¢«è®¾ç½®ä¸ºä¸ä¼šè§¦å‘è§†å›¾åˆ·æ–°ï¼‰ï¼Œä½†å®é™…æƒ…å†µæ˜¯ <code>par_tbl1</code> å’Œ <code>par_tbl2</code> è¡¨é‡Œæ‰€æœ‰çš„æ•°æ®éƒ½ä¼šè¢«åˆ·æ–°åˆ°ç‰©åŒ–è§†å›¾ä¸­ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ª SQL æŸ¥è¯¢æ— åˆ·è§†å›¾ä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.task_runs <span class="keyword">order</span> <span class="keyword">by</span> create_time <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±ä¼šé€ æˆèµ„æºæŸè€—ï¼Œå¦‚æœè¿™ä¸¤å¼ åŸºè¡¨çš„æ•°æ®éå¸¸å¤§ï¼Œæœ¬æ¬¡åˆ·æ–°ä¼šéå¸¸è€—æ—¶ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬çš„éœ€æ±‚æ˜¯åœ¨è¿™æ ·çš„åœºæ™¯ä¸‹ä¹Ÿåªåˆ·æ–°ä¿®æ”¹çš„æ•°æ®ã€‚</p><p>å› æ­¤æˆ‘ä»¬åœ¨æ–°å»ºç‰©åŒ–è§†å›¾çš„æ—¶å€™æ–°å¢äº†ä¸€ä¸ªå‚æ•°ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span></span><br><span class="line">MATERIALIZED <span class="keyword">VIEW</span> test.mv_test</span><br><span class="line">REFRESH ASYNC</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> a_time</span><br><span class="line">PROPERTIES (</span><br><span class="line">&quot;excluded_trigger_tables&quot; <span class="operator">=</span> &quot;par_tbl3&quot;,</span><br><span class="line">&quot;excluded_refresh_tables&quot;<span class="operator">=</span>&quot;par_tbl3&quot;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">select</span> date_trunc(&quot;day&quot;, a.datekey) <span class="keyword">as</span> a_time, date_trunc(&quot;day&quot;, b.datekey) <span class="keyword">as</span> b_time,date_trunc(&quot;day&quot;, c.datekey) <span class="keyword">as</span> c_time</span><br><span class="line"><span class="keyword">from</span> test.par_tbl1 a</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> test.par_tbl2 b <span class="keyword">on</span> a.datekey <span class="operator">=</span> b.datekey <span class="keyword">and</span> a.k1 <span class="operator">=</span> b.k1</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> test.par_tbl3 c <span class="keyword">on</span> a.k1 <span class="operator">=</span> c.k1;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å½“åœ¨åˆ·æ–°æ•°æ®çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­ <code>excluded_refresh_tables</code> é…ç½®çš„è¡¨æ˜¯å¦æœ‰å‘ç”Ÿæ•°æ®å˜åŒ–ï¼Œå¦‚æœæœ‰çš„è¯åˆ™ä¸èƒ½å°†å½“å‰è®¡ç®—å‡ºæ¥çš„åˆ†åŒºï¼ˆ1,2 ä¸¤å¼ è¡¨çš„å…¨é‡æ•°æ®ï¼‰å…¨éƒ¨åˆ·æ–°ï¼Œè€Œæ˜¯ç»§ç»­æ±‚ä¸€ä¸ªäº¤é›†ï¼Œåªè®¡ç®—åŸºè¡¨å‘ç”Ÿå˜åŒ–çš„æ•°æ®ã€‚</p><p>è¿™æ ·å°±å¯ä»¥é¿å… par_tbl1ã€par_tbl2 çš„æ•°æ®å…¨é‡åˆ·æ–°ï¼Œè€Œåªåˆ·æ–°ä¿®æ”¹çš„æ•°æ®ã€‚</p><p>è¿™æ ·çš„åœºæ™¯é€šå¸¸æ˜¯åœ¨å…³è”çš„åŸºè¡¨ä¸­æœ‰ä¸€å¼ å­—å…¸è¡¨ï¼Œé€šå¸¸æ•°æ®é‡ä¸å¤§ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦åˆ†åŒºçš„åœºæ™¯ã€‚</p><p>è¿™æ ·åœ¨åˆ›å»ºç‰©åŒ–è§†å›¾çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªå‚æ•° <code>excluded_trigger_tablesï¼Œexcluded_refresh_tables</code> å°†å®ƒæ’é™¤æ‰äº†ã€‚</p><p><img src="https://s2.loli.net/2024/11/15/lrGJEnRgyQDd2Pc.png"></p><p>æ•´ä½“çš„åˆ·æ–°é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œä¸»è¦å°±æ˜¯å‡ ä¸ªä¸åŒçš„åˆ·æ–°å…¥å£ä»¥åŠåˆ·æ–°è¿‡ç¨‹ä¸­è®¡ç®—åˆ†åŒºçš„é€»è¾‘ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://docs.starrocks.io/zh/docs/using_starrocks/async_mv/Materialized_view/#%E7%90%86%E8%A7%A3-starrocks-%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE">https://docs.starrocks.io/zh/docs/using_starrocks/async_mv/Materialized_view/#%E7%90%86%E8%A7%A3-starrocks-%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE</a></li><li><a href="https://docs.starrocks.io/zh/docs/using_starrocks/async_mv/use_cases/data_modeling_with_materialized_views/#%E5%88%86%E5%8C%BA%E5%BB%BA%E6%A8%A1">https://docs.starrocks.io/zh/docs/using_starrocks/async_mv/use_cases/data_modeling_with_materialized_views/#%E5%88%86%E5%8C%BA%E5%BB%BA%E6%A8%A1</a></li><li><a href="https://github.com/StarRocks/starrocks/pull/52295">https://github.com/StarRocks/starrocks/pull/52295</a></li><li><a href="https://github.com/StarRocks/starrocks/pull/52618">https://github.com/StarRocks/starrocks/pull/52618</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰æ®µæ—¶é—´ç»™ StarRocks çš„ç‰©åŒ–è§†å›¾æ–°å¢äº†ä¸€ä¸ª&lt;a href=&quot;https://github.com/StarRocks/starrocks/pull/50926&quot;&gt;ç‰¹æ€§&lt;/a&gt;ï¼Œé‚£ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦ StarRocksï¼Œå› ä¸ºå®Œå…¨ä¸ç†Ÿæ‚‰è¿™ä¸ªæ•°æ®åº“ï¼Œæ‰€ä»¥å¾ˆå¤šä¸œè¥¿éƒ½æ˜¯ä»å¤´å¼€å§‹äº†è§£æ¦‚å¿µã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†èƒ½é¡ºåˆ©çš„æ–°å¢è¿™ä¸ªç‰¹æ€§ï¼ˆå…·ä½“å†…å®¹å¯ä»¥è§åæ–‡ï¼‰ï¼Œæˆ‘éœ€è¦æŠŠæ•´ä¸ªç‰©åŒ–è§†å›¾çš„æµç¨‹ä¸²è”ä¸€éï¼Œäºæ˜¯ä¾¿æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨å¼€å§‹ä¹‹å‰ç®€å•äº†è§£ä¸‹ç‰©åŒ–è§†å›¾çš„åŸºæœ¬æ¦‚å¿µï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/11/13/TMAjuUsEZGJiFDS.png&quot; alt=&quot;image.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç®€å•æ¥è¯´ï¼Œè§†å›¾å’Œ MySQL è¿™ç±»ä¼ ç»Ÿæ•°æ®åº“çš„æ¦‚å¿µç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”¨äºè§£å†³å¤§é‡æ¶ˆè€—æ€§èƒ½çš„ SQL çš„ï¼Œå¯ä»¥æå‰å°†è¿™äº›æ•°æ®æŸ¥è¯¢å¥½ç„¶åæ”¾åœ¨ä¸€å¼ å•ç‹¬çš„è¡¨ä¸­ï¼Œè¿™æ ·å†æŸ¥è¯¢çš„æ—¶å€™æ€§èƒ½æ¶ˆè€—å°±æ¯”è¾ƒä½äº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="StarRocks" scheme="http://crossoverjie.top/categories/StarRocks/"/>
    
    
    <category term="StarRocks" scheme="http://crossoverjie.top/tags/StarRocks/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£ StarRocks çš„å…ƒæ•°æ®ç®¡ç†</title>
    <link href="http://crossoverjie.top/2024/11/11/ob/StarRocks-meta/"/>
    <id>http://crossoverjie.top/2024/11/11/ob/StarRocks-meta/</id>
    <published>2024-11-11T10:44:37.000Z</published>
    <updated>2024-11-11T13:54:42.770Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æœ€è¿‘åœ¨æ’æŸ¥ <code>starrocks</code> çº¿ä¸Šçš„ä¸€ä¸ªå‘Šè­¦æ—¥å¿—ï¼š</p><p><img src="https://s2.loli.net/2024/09/26/QtMIBdmL7OciVJa.png"></p><p>æ¯éš”ä¸€æ®µæ—¶é—´éƒ½ä¼šæ‰“å° <code>base-table</code> ä¹Ÿå°±æ˜¯ç‰©åŒ–è§†å›¾çš„åŸºè¡¨è¢«åˆ é™¤äº†ï¼Œä½†å…¶å®è¡¨è¿˜åœ¨ï¼Œä¹Ÿæ²¡äººå»åˆ é™¤ï¼›æˆ‘ä»¬å°±æ€€ç–‘æ˜¯å¦çœŸçš„è¡¨è¢«åˆ é™¤äº†ï¼ˆå¯èƒ½æ˜¯ bugï¼‰ã€‚</p><p>ä¸æ­¤åŒæ—¶è¿˜æœ‰ç‰©åŒ–è§†å›¾ inactive çš„æ—¥å¿—ï¼Œä¹Ÿæ€€ç–‘å¦‚æœè§†å›¾æ˜¯ inactive ä¹‹åä¼šå¯¼è‡´ä¸šåŠ¡ä½¿ç”¨æœ‰é—®é¢˜ã€‚</p><p>ä¸ºäº†ç¡®è®¤è¿™ä¸ªæ—¥å¿—æ˜¯å¦å¯¹ä½¿ç”¨å½±å“ï¼Œå°±å¾—éœ€è¦ææ¸…æ¥šå®ƒå‡ºç°çš„åŸå› ï¼›äºæ˜¯æˆ‘å°±ç€æ‰‹ä»æ—¥å¿—æ‰“å°çš„åœ°æ–¹å¼€å§‹æ’æŸ¥ã€‚</p><span id="more"></span><h1 id="é—®é¢˜æ’æŸ¥"><a href="#é—®é¢˜æ’æŸ¥" class="headerlink" title="é—®é¢˜æ’æŸ¥"></a>é—®é¢˜æ’æŸ¥</h1><p><img src="https://s2.loli.net/2024/09/26/2T4sGfw1YC63EuP.png"><br>ä»è¿™ä¸ªä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ˜¯åœ¨æŸ¥è¯¢è¡¨çš„ä¿¡æ¯çš„æ—¶å€™æ²¡æœ‰æŸ¥åˆ°ï¼Œä»è€Œå¯¼è‡´æ—¥å¿—æ‰“å° base-table è¢« dropped äº†ã€‚</p><p>è€Œæˆ‘æŸ¥è¯¢äº†å‡ å¤©çš„ <code>drop table</code> çš„æ—¥å¿—ï¼Œä¾ç„¶æ²¡æœ‰æ‰¾åˆ°å¯èƒ½æ˜¯ç¨‹åº bug å¯¼è‡´è¢«åˆ é™¤çš„ç—•è¿¹ã€‚</p><blockquote><p>å¥½åœ¨ starrocks çš„æ—¥å¿—æ‰“å°éå¸¸è¯¦ç»†ï¼ŒåŒ…å«äº†çº¿ç¨‹åç§°ã€ç±»+æ–¹æ³•åç§°ï¼Œè¿˜æœ‰å…·ä½“çš„ä»£ç å‡½æ•°ï¼Œå¾ˆå®¹æ˜“å°±å®šä½æ—¥å¿—è¾“å‡ºçš„åœ°æ–¹ã€‚</p></blockquote><h2 id="å…ƒæ•°æ®"><a href="#å…ƒæ•°æ®" class="headerlink" title="å…ƒæ•°æ®"></a>å…ƒæ•°æ®</h2><p>åªæ˜¯ä¸ºä½•ä¼šè°ƒç”¨åˆ°è¿™é‡Œè¿˜éœ€è¦é˜…è¯»æºç ä»è€Œæ‰¾åˆ°åŸå› ï¼Œåœ¨å¼€å§‹ä¹‹å‰éœ€è¦å…ˆäº†è§£ä¸€ä¸‹ starrocks å…ƒæ•°æ®çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚</p><blockquote><p>å…¶å®åœ¨è¿™ç¯‡æ–‡ç« ï¼š<a href="https://xie.infoq.cn/article/6f2f9f56916f0eb2fdb6b001a">StarRocks å…ƒæ•°æ®ç®¡ç†åŠ FE é«˜å¯ç”¨æœºåˆ¶</a>ä¸­å·²ç»æœ‰å…¨é¢çš„ä»‹ç»ï¼Œåªæ˜¯è¿™ç¯‡æ–‡ç« æœ‰ç‚¹æ—©äº†ï¼Œå’Œç°åœ¨æœ€æ–°çš„ä»£ç ä¸å¤ªåŒ¹é…ã€‚</p></blockquote><p>åœ¨ StarRocks å…ƒæ•°æ®ä¸­ä¼šä¿å­˜ Databaseã€Table ç­‰ä¿¡æ¯ã€‚</p><p>è¿™äº›æ•°æ®å®šæœŸä¿å­˜åœ¨ <code>fe/meta</code> ç›®å½•ä¸­ã€‚<br><img src="https://s2.loli.net/2024/09/27/3C4GaXM5BlWmNIw.png"></p><p>StarRocks å¯¹å…ƒæ•°æ®çš„æ¯ä¸€æ¬¡æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥æ•°æ®åº“ã€è¡¨ã€ç‰©åŒ–è§†å›¾ï¼‰éƒ½ä¼šç”Ÿæˆ editLog çš„æ“ä½œæ—¥å¿—ã€‚</p><p><img src="https://s2.loli.net/2024/09/27/5hbDBHGwtarE8fj.png" alt="image.png"></p><blockquote><p>æ–°å»ºæ•°æ®åº“ã€ä¿®æ”¹è¡¨åç§°ç­‰</p></blockquote><p>å½“ StarRocks çš„ FE é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œä¼šç”± leader çš„ FE å¯åŠ¨ä¸€ä¸ª checkpoint çº¿ç¨‹ï¼Œå®šæ—¶æ‰«æå½“å‰çš„å…ƒæ•°æ®æ˜¯å¦éœ€è¦ç”Ÿæˆä¸€ä¸ª <code>image.$&#123;JournalId&#125;</code> çš„æ–‡ä»¶ã€‚</p><p><img src="https://s2.loli.net/2024/09/20/lQCkBnNWIZ4GwuV.png"></p><blockquote><p>å…¶å®å°±æ˜¯åˆ¤æ–­å½“å‰æ—¥å¿—æ•°é‡æ˜¯å¦è¾¾åˆ°ä¸Šé™ï¼ˆé»˜è®¤æ˜¯ 5wï¼‰ç”Ÿæˆä¸€æ¬¡ã€‚</p></blockquote><p>å…·ä½“çš„æµç¨‹å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/09/27/zgy6ZaQ7b1ceWkm.png"></p><ul><li>åˆ¤æ–­å½“å‰æ˜¯å¦éœ€è¦å°†æ—¥å¿—ç”Ÿæˆ image</li><li>åŠ è½½å½“å‰ image é‡Œçš„å…ƒæ•°æ®åˆ°å†…å­˜</li><li>ä» bdb ä¸­è¯»å–æœ€æ–°çš„ Journalï¼Œç„¶åè¿›è¡Œé‡æ”¾ï¼ˆreplayï¼‰ï¼šå…¶å®å°±æ˜¯æ›´æ–°åˆšæ‰åŠ è½½åˆ°å†…å­˜ä¸­çš„å…ƒæ•°æ®ã€‚</li><li>åŸºäºå†…å­˜ä¸­çš„å…ƒæ•°æ®é‡æ–°ç”Ÿæˆä¸€ä»½ image æ–‡ä»¶</li><li>åˆ é™¤å†å²çš„ image æ–‡ä»¶</li><li>å°†ç”Ÿæˆçš„ image æ–‡ä»¶åç§°é€šçŸ¥ FE çš„ follower èŠ‚ç‚¹ï¼Œè®©ä»–ä»¬ä¸‹è½½åˆ°æœ¬åœ°ï¼Œä»è€Œå¯ä»¥å®ç° image åŒæ­¥ã€‚</li></ul><p><img src="https://s2.loli.net/2024/09/27/Hd1NRzgfSy2xECW.png"><br><img src="https://s2.loli.net/2024/09/27/QiTHLpOfJ19oAam.png"></p><blockquote><p>é€šçŸ¥ follower ä¸‹è½½ imageã€‚</p></blockquote><h2 id="å…ƒæ•°æ®åŒæ­¥æµç¨‹"><a href="#å…ƒæ•°æ®åŒæ­¥æµç¨‹" class="headerlink" title="å…ƒæ•°æ®åŒæ­¥æµç¨‹"></a>å…ƒæ•°æ®åŒæ­¥æµç¨‹</h2><p>å®Œæ•´çš„æµç¨‹å›¾å¦‚ä¸‹å›¾ï¼š<br><img src="https://i.imgur.com/txqTt0U.png"></p><p>åœ¨è¿™ä¸ªæµç¨‹å›¾æœ‰ä¸€ä¸ªå…³é”® <code>loadImage</code> æµç¨‹ï¼š<br><img src="https://s2.loli.net/2024/09/27/MoWjm8SKsgx2GXh.png"></p><p>ä»–ä¼šè¯»å– image è¿™ä¸ªæ–‡ä»¶é‡Œçš„æ•°æ®ï¼Œç„¶åååºåˆ—åŒ–ååŠ è½½åˆ°å†…å­˜é‡Œï¼Œä¸»è¦å°±æ˜¯æ¢å¤æ•°æ®åº“å’Œè¡¨ã€‚</p><p>è¿˜ä¼šå¯¹æ¯ä¸ªè¡¨è°ƒç”¨ä¸€æ¬¡ <code>onReload()</code> å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°ä¼šåª MV(<code>MATERIALIZED VIEWS</code>) ç”Ÿæ•ˆã€‚</p><p>è¿™ä¸ªå‡½æ•°æ­£å¥½å°±æ˜¯åœ¨æ–‡åˆæåˆ°çš„è¿™ä¸ªå‡½æ•° <code>com.starrocks.catalog.MaterializedView#onReloadImpl</code>ï¼š<br><img src="https://s2.loli.net/2024/09/26/2T4sGfw1YC63EuP.png"></p><p>ä»ä»–çš„å®ç°æ¥çœ‹å°±æ˜¯åˆ¤æ–­è§†å›¾æ‰€ä¾èµ–çš„åŸºè¡¨æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæœ‰ä¸€ä¸ªä¸å­˜åœ¨å°±ä¼šå°†å½“å‰åŸºè¡¨ç½®ä¸º inactiveã€‚</p><p>å¦‚æœç¢°åˆ°è§†å›¾çš„åŸºè¡¨ä¹Ÿæ˜¯è§†å›¾ï¼Œé‚£å°±é€’å½’å† reload ä¸€æ¬¡ã€‚</p><h2 id="å¤ç°é—®é¢˜"><a href="#å¤ç°é—®é¢˜" class="headerlink" title="å¤ç°é—®é¢˜"></a>å¤ç°é—®é¢˜</h2><p>æ—¢ç„¶çŸ¥æ™“äº†è¿™ä¸ªåŠ è½½æµç¨‹ï¼Œå†ç»“åˆæºç åº”è¯¥ä¸éš¾çœ‹å‡ºè¿™é‡Œçš„é—®é¢˜æ‰€åœ¨äº†ã€‚</p><p><img src="https://s2.loli.net/2024/09/27/MoWjm8SKsgx2GXh.png"><br>ä»è¿™é‡Œçš„åŠ è½½æ•°æ®åº“å¯ä»¥çœ‹å‡ºç«¯å€ªï¼Œå¦‚æœæˆ‘çš„è§†å›¾å’ŒåŸºè¡¨ä¸åœ¨åŒä¸€ä¸ªæ•°æ®åº“é‡Œï¼Œæ­¤æ—¶å…ˆåŠ è½½è§†å›¾æ˜¯ä¸æ˜¯å°±ä¼šå‡ºç°é—®é¢˜ï¼Ÿ</p><p>åŠ è½½è§†å›¾çš„æ—¶å€™ä¼šåˆ¤æ–­åŸºè¡¨æ˜¯å¦å­˜åœ¨ï¼Œè€Œæ­¤æ—¶åŸºè¡¨æ‰€åœ¨çš„æ•°æ®åº“è¿˜æ²¡åŠ è½½åˆ°å†…å­˜é‡Œï¼Œè‡ªç„¶å°±ä¼šæŸ¥è¯¢ä¸åˆ°ä»è€Œå‡ºç°é‚£ä¸ªæ—¥å¿—ã€‚</p><p>æˆ‘ä¹‹å‰ä¸€ç›´åœ¨æœ¬åœ°æ¨¡æ‹Ÿï¼Œå› ä¸ºéƒ½æ˜¯åœ¨åŒä¸€ä¸ªæ•°æ®åº“é‡Œçš„åŸºè¡¨å’Œè§†å›¾ï¼Œæ‰€ä»¥ä¸€ç›´ä¸èƒ½å¤ç°ã€‚</p><p>åªè¦å°†åŸºè¡¨å’Œè§†å›¾åˆ†å¼€åœ¨ä¸åŒçš„æ•°æ®åº“ä¸­ï¼Œè®©è§†å›¾å…ˆäºæ•°æ®åº“å‰åŠ è½½å°±ä¼šè§¦å‘è¿™ä¸ªæ—¥å¿—ã€‚</p><h1 id="ä¿®å¤é—®é¢˜"><a href="#ä¿®å¤é—®é¢˜" class="headerlink" title="ä¿®å¤é—®é¢˜"></a>ä¿®å¤é—®é¢˜</h1><p>è¦ä¿®å¤è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦ç­‰åˆ°æ‰€æœ‰çš„æ•°æ®åº“éƒ½è¡¨éƒ½åŠ è½½å®Œæ¯•åå†å» reload ç‰©åŒ–è§†å›¾å°±å¯ä»¥äº†ã€‚</p><p>å½“æˆ‘å›åˆ° main åˆ†æ”¯å‡†å¤‡ç€æ‰‹ä¿®æ”¹æ—¶ï¼Œå‘ç°è¿™ä¸ªé—®é¢˜å·²ç»è¢«ä¿®å¤äº†ï¼š<br><a href="https://github.com/StarRocks/starrocks/pull/51002">https://github.com/StarRocks/starrocks/pull/51002</a></p><p><img src="https://s2.loli.net/2024/09/27/pzWPnoF2MIji9Kw.png"></p><p>ä¿®å¤è¿‡ç¨‹ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ reload æ—¶è·³è¿‡äº† MVï¼Œç­‰åˆ°æ‰€æœ‰çš„æ•°æ®éƒ½åŠ è½½å®Œä¹‹åä¼šåœ¨ <code>com.starrocks.server.GlobalStateMgr#postLoadImage</code> æ‰‹åŠ¨åŠ è½½ <code>MV</code>ã€‚</p><p><img src="https://s2.loli.net/2024/09/27/7JCLyU6umlRnqvE.png"></p><p>è¿™ä¸ª PR ä¿®å¤çš„é—®é¢˜ä¹Ÿæ˜¯æˆ‘ä¸€å¼€å§‹æåˆ°çš„ï¼Œä¼šæ‰“å°è®¸å¤šä»¤äººè¯¯è§£çš„æ—¥å¿—ã€‚</p><p>åˆ°è¿™é‡Œå°±å¯ä»¥è§£é‡Šæ–‡ç« å¼€å¤´çš„é‚£ä¸ªé—®é¢˜äº†ï¼šæ‰“å°çš„è¿™ä¸ª base-table è¢«åˆ é™¤çš„æ—¥å¿—å¯¹ä¸šåŠ¡æ¥è¯´æ²¡æœ‰å½±å“ï¼Œåªæ˜¯ä¸€ä¸ª bug å¯¼è‡´å‡ºç°äº†è¿™ä¸ªæ—¥å¿—ã€‚</p><p>é¢å¤–æä¸€å¥ï¼Œè¿™ä¸ªæ—¥å¿—ä¹Ÿæ¯”è¾ƒè¿·ï¼Œæ²¡æœ‰æ‰“å°æ•°æ®åº“åç§°ï¼Œå¦‚æœæœ‰æ•°æ®åº“åç§°çš„è¯å¯èƒ½ä¼šæ›´å¿«å®šä½åˆ°è¿™ä¸ªé—®é¢˜ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š</p><ul><li><a href="https://xie.infoq.cn/article/6f2f9f56916f0eb2fdb6b001a">https://xie.infoq.cn/article/6f2f9f56916f0eb2fdb6b001a</a></li><li><a href="https://github.com/StarRocks/starrocks/pull/51002">https://github.com/StarRocks/starrocks/pull/51002</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;æœ€è¿‘åœ¨æ’æŸ¥ &lt;code&gt;starrocks&lt;/code&gt; çº¿ä¸Šçš„ä¸€ä¸ªå‘Šè­¦æ—¥å¿—ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/09/26/QtMIBdmL7OciVJa.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æ¯éš”ä¸€æ®µæ—¶é—´éƒ½ä¼šæ‰“å° &lt;code&gt;base-table&lt;/code&gt; ä¹Ÿå°±æ˜¯ç‰©åŒ–è§†å›¾çš„åŸºè¡¨è¢«åˆ é™¤äº†ï¼Œä½†å…¶å®è¡¨è¿˜åœ¨ï¼Œä¹Ÿæ²¡äººå»åˆ é™¤ï¼›æˆ‘ä»¬å°±æ€€ç–‘æ˜¯å¦çœŸçš„è¡¨è¢«åˆ é™¤äº†ï¼ˆå¯èƒ½æ˜¯ bugï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;ä¸æ­¤åŒæ—¶è¿˜æœ‰ç‰©åŒ–è§†å›¾ inactive çš„æ—¥å¿—ï¼Œä¹Ÿæ€€ç–‘å¦‚æœè§†å›¾æ˜¯ inactive ä¹‹åä¼šå¯¼è‡´ä¸šåŠ¡ä½¿ç”¨æœ‰é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†ç¡®è®¤è¿™ä¸ªæ—¥å¿—æ˜¯å¦å¯¹ä½¿ç”¨å½±å“ï¼Œå°±å¾—éœ€è¦ææ¸…æ¥šå®ƒå‡ºç°çš„åŸå› ï¼›äºæ˜¯æˆ‘å°±ç€æ‰‹ä»æ—¥å¿—æ‰“å°çš„åœ°æ–¹å¼€å§‹æ’æŸ¥ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="StarRocks" scheme="http://crossoverjie.top/categories/StarRocks/"/>
    
    
    <category term="StarRocks" scheme="http://crossoverjie.top/tags/StarRocks/"/>
    
  </entry>
  
  <entry>
    <title>æ—¶éš”äº”å¹´ 9K star çš„ IM é¡¹ç›®å‘å¸ƒ v2.0.0 äº†</title>
    <link href="http://crossoverjie.top/2024/11/04/ob/cim-2.0.0/"/>
    <id>http://crossoverjie.top/2024/11/04/ob/cim-2.0.0/</id>
    <published>2024-11-04T03:11:48.000Z</published>
    <updated>2024-11-04T10:28:18.438Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ä¸šä½™æ—¶é—´èŠ±äº†å°ä¸‰ä¸ªæœˆé‡æ„äº† <a href="https://github.com/crossoverJie/cim">cim</a>ï¼Œä¹Ÿå°†ç‰ˆæœ¬å’Œå‡çº§åˆ°äº† <a href="https://github.com/crossoverJie/cim/releases/tag/v2.0.0">v2.0.0</a>ï¼Œåˆå¹¶äº†åå‡ ä¸ª PR åŒæ—¶ä¹Ÿæ–°å¢äº†å‡ ä½å¼€å‘è€…ã€‚</p><p><img src="https://s2.loli.net/2024/10/12/yKzedUZ8DQlVwTC.png" alt="image.png"></p><blockquote><p>å…¶ä¸­æœ‰ä¸¤ä½ä¹Ÿæ˜¯å’±ä»¬æ˜Ÿçƒé‡Œçš„å°ä¼™ä¼´ğŸ‰</p></blockquote><span id="more"></span><h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>ä¸Šæ¬¡å‘ç‰ˆè¿˜æ˜¯åœ¨äº”å¹´å‰äº†ï¼š<br><img src="https://s2.loli.net/2024/10/12/WCP1Vn62SeBNAmZ.png"></p><p>å› ä¸ºç¡®å®å·²ç»å¾ˆä¹…æ²¡æœ‰æ›´æ–°äº†ï¼Œåœ¨å¼€å§‹ä¹‹å‰è¿˜æ˜¯å…ˆä»‹ç» <a href="https://github.com/crossoverJie/cim/">cim</a> æ˜¯ä»€ä¹ˆã€‚</p><p>è¿™é‡Œæœ‰ä¸€å¼ ç®€å•çš„ä½¿ç”¨å›¾ç‰‡ï¼š<br><img src="https://s2.loli.net/2024/10/14/pBvDML4HVgyYZxS.gif" alt="Oct-14-2024 11-09-54-min.gif"><br>åŒæ—¶ä»¥å‰ä¹Ÿæœ‰å½•è¿‡ç›¸å…³çš„è§†é¢‘ï¼š</p><p>é€šè¿‡ <a href="https://github.com/crossoverJie/cim">cim</a> è¿™ä¸ªåå­—å’Œè§†é¢‘å¯ä»¥çœ‹å‡ºï¼Œå®ƒå…·å¤‡ IM å³æ—¶é€šè®¯çš„åŸºæœ¬åŠŸèƒ½ï¼ŒåŒæ—¶åŸºäºå®ƒå¯ä»¥å®ç°ï¼š</p><ul><li>å³æ—¶é€šè®¯</li><li>æ¶ˆæ¯æ¨é€</li><li>IOT æ¶ˆæ¯å¹³å°</li></ul><p>ç°åœ¨è¦åœ¨æœ¬åœ°è¿è¡Œç®€å•è®¸å¤šäº†ï¼Œå‰ææ˜¯æœ‰ docker å°±å¯ä»¥äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> --name zookeeper -d -p 2181:2181 zookeeper:3.9.2</span><br><span class="line">docker run --<span class="built_in">rm</span> --name redis -d -p 6379:6379 redis:7.4.0</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/crossoverJie/cim.git</span><br><span class="line"><span class="built_in">cd</span> cim</span><br><span class="line">mvn clean package -DskipTests=<span class="literal">true</span></span><br><span class="line"><span class="built_in">cd</span> cim-server &amp;&amp; cim-client &amp;&amp; cim-forward-route</span><br><span class="line">mvn clean package spring-boot:repackage -DskipTests=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p><a href="https://github.com/crossoverJie/cim">cim</a> çš„æ¶æ„å›¾å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/10/13/O7wVi8QYr3lMFJo.png"><br>ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>Client åŸºæœ¬äº¤äº’åŠŸèƒ½<ul><li>æ¶ˆæ¯æ”¶å‘</li><li>æ¶ˆæ¯æŸ¥è¯¢</li><li>å»¶è¿Ÿæ¶ˆæ¯</li></ul></li><li>Route æä¾›äº†æ¶ˆæ¯è·¯ç”±ä»¥åŠç›¸å…³çš„ç®¡ç†åŠŸèƒ½<ul><li>API è½¬å‘</li><li>æ¶ˆæ¯æ¨é€</li><li>ä¼šè¯ç®¡ç†</li><li>å¯è§‚æµ‹æ€§</li></ul></li><li>Server ä¸»è¦å°±æä¾›é•¿é“¾æ¥èƒ½åŠ›ï¼Œä»¥åŠçœŸæ­£çš„æ¶ˆæ¯æ¨é€</li></ul><p>åŒæ—¶è¿˜æœ‰å…ƒæ•°æ®ä¸­å¿ƒï¼ˆæ”¯æŒæ‰©å±•å®ç°ï¼‰ã€æ¶ˆæ¯å­˜å‚¨ç­‰ç»„ä»¶ï¼›</p><p>ä¸ç®¡æ˜¯å®¢æˆ·ç«¯ã€routeã€server éƒ½æ˜¯æ”¯æŒé›†ç¾¤ï¼š</p><ul><li>route ç”±äºæ˜¯æ— çŠ¶æ€ï¼Œå¯ä»¥ä»»æ„æ‰©å±•</li><li>server é€šè¿‡æ³¨å†Œä¸­å¿ƒä¹Ÿæ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œå½“å‘ç”Ÿå®•æœºæˆ–è€…æ˜¯æ‰©å®¹æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šé€šè¿‡å¿ƒè·³å’Œé‡è¿æœºåˆ¶ä¿è¯å¯ç”¨æ€§ã€‚</li></ul><p>æ‰€ä»¥æ•´ä¸ªæ¶æ„ä¸å­˜åœ¨<strong>å•ç‚¹</strong>ï¼ŒåŒæ—¶æ¯”è¾ƒç®€å•æ¸…æ™°çš„ï¼Œå¤§éƒ¨åˆ†ç»„ä»¶éƒ½æ”¯æŒå¯æ‰©å±•ã€‚</p><h2 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h2><p><img src="https://s2.loli.net/2024/10/13/8teMn7BSa5VWuvi.png"></p><p>ä¸ºäº†æ›´æ–¹ä¾¿ç†è§£ï¼ŒèŠ±äº†ä¸€ä¸ªæµç¨‹å›¾ã€‚</p><ul><li>server åœ¨å¯åŠ¨ä¹‹åä¼šå…ˆåœ¨å…ƒæ•°æ®ä¸­å¿ƒæ³¨å†Œ</li><li>åŒæ—¶ route ä¼šè®¢é˜…å…ƒæ•°æ®ä¸­çš„ server ä¿¡æ¯</li><li>å®¢æˆ·ç«¯ç™»é™†æ—¶ä¼šè°ƒç”¨ route è·å–ä¸€ä¸ª server çš„èŠ‚ç‚¹ä¿¡æ¯</li><li>ç„¶åå‘èµ·ç™»é™†è¯·æ±‚ã€‚<ul><li>æˆåŠŸä¹‹åä¼šä¿æŒé•¿é“¾æ¥ã€‚</li></ul></li><li>å®¢æˆ·ç«¯å‘å‘é€æ¶ˆæ¯æ—¶ä¼šè°ƒç”¨ route æ¥å£æ¥å‘èµ·æ¶ˆæ¯<ul><li>route æ ¹æ®é•¿é“¾æ¥å…³ç³»é€‰æ‹© server è¿›è¡Œæ¶ˆæ¯æ¨é€</li></ul></li></ul><h2 id="v2-0-0"><a href="#v2-0-0" class="headerlink" title="v2.0.0"></a>v2.0.0</h2><p>æ¥ä¸‹æ¥ä»‹ç»ä¸‹æœ¬æ¬¡ <a href="https://github.com/crossoverJie/cim/releases/tag/v2.0.0">v2.0.0</a> æœ‰å“ªäº›é‡å¤§å˜æ›´ï¼Œæ¯•ç«Ÿæ˜¯ä¿®æ”¹äº†å¤§çš„ç‰ˆæœ¬å·ã€‚</p><p>è¿™é‡Œåˆ—ä¸¾ä¸€äº›é‡å¤§çš„æ”¹åŠ¨ï¼š<br><img src="https://s2.loli.net/2024/10/12/mRGDV6hBCTAblcI.png" alt="image.png"></p><ul><li>é¦–å…ˆæ˜¯æ”¯æŒäº†å…ƒæ•°æ®ä¸­å¿ƒï¼Œè§£è€¦äº† zookeeperï¼Œä¹Ÿæ”¯æŒè‡ªå®šä¹‰å®ç°ã€‚</li><li>æ”¯æŒäº†é›†æˆæµ‹è¯•ï¼Œå¯ä»¥ä¿è¯æäº¤çš„ PR å¯¹ç°æœ‰åŠŸèƒ½çš„å½±å“é™åˆ°æœ€ä½ï¼Œä»£ç è´¨é‡æœ‰ä¸€å®šä¿è¯ï¼›review ä»£ç æ—¶æ›´åŠ æ”¾å¿ƒã€‚</li><li>å•ç‹¬æŠ½ç¦»äº† <code>client-sdk</code>ï¼Œä»£ç è€¦åˆæ€§æ›´å¥½ä¸”æ›´æ˜“ç»´æŠ¤ã€‚</li><li>æœåŠ¡ä¹‹é—´è°ƒç”¨çš„ RPC å®Œæˆäº†é‡æ„<ul><li>æ”¯æŒäº†åŠ¨æ€ URL</li><li>æ³›å‹æ•°æ®è§£æ</li></ul></li><li>è¿˜æœ‰ç¤¾åŒºå°ä¼™ä¼´è´¡çŒ®çš„ä¸€äº› bug ä¿®å¤ã€<code>RpcProxyManager</code> çš„ IOC æ”¯æŒç­‰ç‰¹æ€§ã€‚</li></ul><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ›´å¤šçš„éƒ¨ç½²å’Œä½¿ç”¨å¯ä»¥å‚è€ƒé¡¹ç›®é¦–é¡µçš„ READMEï¼Œæœ‰è¯¦ç»†çš„ä»‹ç»ã€‚</p><p><a href="https://github.com/crossoverJie/cim">cim</a> ç›®å‰è¿˜éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹éå¸¸å¤šï¼›æ¥ä¸‹æ¥çš„é‡ç‚¹æ˜¯å®ç° ACKï¼ŒåŒæ—¶ä¼šå®Œå–„ä¸€ä¸‹é€šè®¯åè®®ã€‚<br><img src="https://s2.loli.net/2024/10/14/l7RIZfYOsmM1N3P.png" alt="image.png"></p><p>todo åˆ—è¡¨æˆ‘ä¹Ÿæ·»åŠ äº†å¾ˆå¤šï¼Œæ‰€ä»¥éå¸¸æ¨èæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å…ˆçœ‹çœ‹ todo åˆ—è¡¨ï¼Œè¯´ä¸å®šå°±æœ‰ä½ æ„Ÿå…´è¶£çš„å¯ä»¥å‚ä¸ä¸€ä¸‹ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘ä¸šä½™æ—¶é—´èŠ±äº†å°ä¸‰ä¸ªæœˆé‡æ„äº† &lt;a href=&quot;https://github.com/crossoverJie/cim&quot;&gt;cim&lt;/a&gt;ï¼Œä¹Ÿå°†ç‰ˆæœ¬å’Œå‡çº§åˆ°äº† &lt;a href=&quot;https://github.com/crossoverJie/cim/releases/tag/v2.0.0&quot;&gt;v2.0.0&lt;/a&gt;ï¼Œåˆå¹¶äº†åå‡ ä¸ª PR åŒæ—¶ä¹Ÿæ–°å¢äº†å‡ ä½å¼€å‘è€…ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/10/12/yKzedUZ8DQlVwTC.png&quot; alt=&quot;image.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å…¶ä¸­æœ‰ä¸¤ä½ä¹Ÿæ˜¯å’±ä»¬æ˜Ÿçƒé‡Œçš„å°ä¼™ä¼´ğŸ‰&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="IM" scheme="http://crossoverjie.top/categories/IM/"/>
    
    
    <category term="IM" scheme="http://crossoverjie.top/tags/IM/"/>
    
  </entry>
  
  <entry>
    <title>ğŸ’¢çº¿ä¸Šé«˜å»¶è¿Ÿè¯·æ±‚æ’æŸ¥</title>
    <link href="http://crossoverjie.top/2024/10/29/ob/%F0%9F%92%A2%E7%BA%BF%E4%B8%8A%E9%AB%98%E5%BB%B6%E8%BF%9F%E8%AF%B7%E6%B1%82%E6%8E%92%E6%9F%A5/"/>
    <id>http://crossoverjie.top/2024/10/29/ob/%F0%9F%92%A2%E7%BA%BF%E4%B8%8A%E9%AB%98%E5%BB%B6%E8%BF%9F%E8%AF%B7%E6%B1%82%E6%8E%92%E6%9F%A5/</id>
    <published>2024-10-29T10:21:42.000Z</published>
    <updated>2024-10-28T10:29:17.642Z</updated>
    
    <content type="html"><![CDATA[<p>å‰å‡ å¤©æ’æŸ¥äº†ä¸€ä¸ªä¸šåŠ¡æ¥å£æ‰§è¡Œé«˜å»¶è¿Ÿçš„é—®é¢˜ï¼Œä¹ŸæŒºæœ‰å‚è€ƒæ„ä¹‰çš„ï¼Œåˆ†äº«ä¸€ä¸‹æ’æŸ¥è¿‡ç¨‹ã€‚</p><p>ç°è±¡æ˜¯ä¸šåŠ¡åé¦ˆæœ‰ä¸€ä¸ªæ¥å£ä¸šåŠ¡é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œä½†æ˜¯è°ƒç”¨ä¸€æ¬¡è€—æ—¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://s2.loli.net/2024/10/16/Am9VkNZ5Ep4Uj6G.png"></p><span id="more"></span><h1 id="æ’æŸ¥åº”ç”¨è¿è¡ŒçŠ¶æ€"><a href="#æ’æŸ¥åº”ç”¨è¿è¡ŒçŠ¶æ€" class="headerlink" title="æ’æŸ¥åº”ç”¨è¿è¡ŒçŠ¶æ€"></a>æ’æŸ¥åº”ç”¨è¿è¡ŒçŠ¶æ€</h1><p>é¦–å…ˆç¬¬ä¸€æ­¥éœ€è¦æŸ¥çœ‹å½“æ—¶çš„åº”ç”¨è¿è¡ŒçŠ¶æ€ï¼ŒåŒ…å«å½“æ—¶çš„æ—¥å¿—ã€JVM çš„å„ç§ç›‘æ§ç­‰ã€‚</p><p>å› ä¸ºæˆ‘ä»¬æ¥å…¥äº† <code>OpenTelemetry</code>ï¼Œæ‰€ä»¥ <code>trace</code> å’Œæ—¥å¿—æ˜¯å¯ä»¥å…³è”èµ·æ¥çš„ã€‚</p><blockquote><p>ç‚¹å‡»é“¾è·¯ç³»ç»Ÿæ—è¾¹çš„æ—¥å¿—æŒ‰é’®å¯ä»¥ç›´æ¥è·³è½¬ã€‚</p></blockquote><p>å¯ä»¥é€šè¿‡ <code>trace_id</code> æŸ¥è¯¢åˆ°ç›¸å…³æ—¥å¿—ï¼š<br><img src="https://s2.loli.net/2024/10/16/W5ow6KpdCaOk2f7.png"></p><p>é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹å‡ºè€—æ—¶å¤§çº¦åœ¨ 4s å¤šä¸€ç‚¹ï¼Œç„¶åç»“åˆä»£ç å‘ç°è¿™ä¸¤æ®µæ—¥å¿—åˆ†åˆ«æ˜¯åœ¨è¿›å…¥ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡æ–¹æ³•ä¹‹å‰å’Œæ–¹æ³•å†…æ‰“å°çš„ã€‚</p><p><img src="https://s2.loli.net/2024/10/16/XeqoaGPx8kEmSrD.png"></p><p>è€Œç¬¬ä¸€è¡Œæ—¥å¿—æ˜¯åœ¨ä¸€ä¸ªè‡ªå®šä¹‰é™æµå™¨ä¸­æ‰“å°çš„ï¼Œè¿™ä¸ªé™æµå™¨æ˜¯ä½¿ç”¨ <code>Guava</code> çš„ <code>RateLimiter</code>å®ç°çš„ã€‚</p><p>æˆ‘çš„ç¬¬ä¸€ååº”æ˜¯ä¸æ˜¯è¿™ä¸ªé™æµå™¨å½“æ—¶é™æµäº†ï¼Œä»è€Œå¯¼è‡´é˜»å¡äº†ï¼›ä½†æŸ¥çœ‹äº†å½“æ—¶çš„ QPS å‘ç°å®Œå…¨ä½äºé™æµå™¨çš„é…ç½®ï¼Œæ‰€ä»¥åŸºæœ¬å¯ä»¥æ’é™¤å®ƒçš„å«Œç–‘äº†ã€‚</p><h2 id="JVM-ç›‘æ§"><a href="#JVM-ç›‘æ§" class="headerlink" title="JVM ç›‘æ§"></a>JVM ç›‘æ§</h2><p><img src="https://s2.loli.net/2024/10/16/f3H6VBFRpCN7Yza.png"></p><p><img src="https://s2.loli.net/2024/10/16/zvKPyXuScQwmiYN.png"></p><p>ä¹‹åæˆ‘ä»¬æŸ¥è¯¢å½“æ—¶çš„ JVM ç›‘æ§å‘ç°å½“æ—¶çš„ GC  é¢‘ç¹ï¼Œè€Œå †å†…å­˜ä¹Ÿæ­£å¥½å‘ç”Ÿäº†ä¸€æ¬¡å›æ”¶ï¼Œåˆæ­¥åˆ¤æ–­æ˜¯ GC å¯¼è‡´çš„æœ¬æ¬¡é—®é¢˜ã€‚</p><p>ä½†ä¸ºå•¥ä¼šå¯¼è‡´é¢‘ç¹çš„ GC å‘¢ï¼Œè¿˜éœ€è¦ç»§ç»­æ’æŸ¥ã€‚</p><h2 id="å†…å­˜æ’æŸ¥"><a href="#å†…å­˜æ’æŸ¥" class="headerlink" title="å†…å­˜æ’æŸ¥"></a>å†…å­˜æ’æŸ¥</h2><p>æˆ‘ä»¬åœ¨åº”ç”¨è¯Šæ–­ä¸­é›†æˆäº† <a href="https://github.com/grafana/pyroscope">Pyroscope</a>çš„æŒç»­å‰–æï¼Œå¯ä»¥å®æ—¶æŸ¥çœ‹å†…å­˜çš„å ç”¨æƒ…å†µã€‚<br><img src="https://s2.loli.net/2024/10/16/Ow5WksxJan9G8py.png"></p><p><img src="https://s2.loli.net/2024/10/16/CbPhVJ4mDyFxicX.png" alt="image.png"></p><p>é€šè¿‡å†…å­˜åˆ†æå‘ç°æœ‰å¤§é‡çš„ JSON åºåˆ—åŒ–å ç”¨äº†å¤§é‡çš„å†…å­˜ï¼ŒåŒæ—¶è¿˜å‘ç° Pod å·²ç»è¢«é‡å¯å¥½å‡ æ¬¡äº†ï¼š<br><img src="https://s2.loli.net/2024/10/16/iKHCFodeVPM9A68.png" alt="image.png"></p><p><img src="https://s2.loli.net/2024/10/16/31aTS7yqNCKlFJQ.png" alt="image.png"></p><p>æŸ¥çœ‹åŸå› å‘ç°æ˜¯ Pod OOM å¯¼è‡´çš„ã€‚</p><p>å› æ­¤éå¸¸æœ‰å¯èƒ½æ˜¯ GC å¯¼è‡´çš„ï¼Œæ°å¥½é‚£æ®µæ—¶é—´å‘ç”Ÿäº† GC å†…å­˜ä¹Ÿæœ‰æ˜æ˜¾å˜åŒ–ã€‚</p><p><img src="https://s2.loli.net/2024/10/16/f3H6VBFRpCN7Yza.png"></p><p><img src="https://s2.loli.net/2024/10/16/zvKPyXuScQwmiYN.png"></p><p><img src="https://s2.loli.net/2024/10/16/hsXUAZCIGY12gFk.png"></p><p>æœ€åå†é€šè¿‡ arthas ç¡®è®¤äº† GC éå¸¸é¢‘ç¹ï¼Œå¯ä»¥ç¡®è®¤ç›®å‰çš„èµ„æºæ˜¯æ˜¯éå¸¸ç´§å¼ çš„ï¼Œå’¨è¯¢ä¸šåŠ¡ä¹‹åå¾—çŸ¥è¯¥åº”ç”¨æœ¬èº«å ç”¨çš„èµ„æºå°±æ¯”è¾ƒå¤§ï¼Œæ²¡æœ‰å¤ªå¤šä¼˜åŒ–ç©ºé—´ï¼Œæ‰€ä»¥æœ€ç»ˆå†³å®šè¿˜æ˜¯åŠ é…ç½®ã€‚<br><img src="https://s2.loli.net/2024/10/16/VGyrCAZgjx64wHP.png"><br><img src="https://s2.loli.net/2024/10/17/zIEjeMxvkgLomZ4.png" alt="image.png"><br>è¿˜æ˜¯æé«˜ç¡¬ä»¶æ•ˆç‡æœ€é«˜ï¼Œç›®å‰è¿è¡ŒåŠä¸ªæœˆä¹‹å Pod å†…å­˜è¡¨ç°ç¨³å®šï¼Œæ²¡æœ‰å‡ºç°ä¸€æ¬¡ OOM çš„å¼‚å¸¸ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è™½ç„¶æœ€åçš„å¤„ç†çš„æ–¹å¼æ˜¯ç®€å•ç²—æš´çš„ï¼Œä½†å…¶ä¸­çš„è¿‡ç¨‹è¿˜æ˜¯æœ‰æ„ä¹‰çš„ï¼Œé‡åˆ°ä¸åŒçš„æƒ…å†µä¹Ÿæœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚</p><p>æ¯”å¦‚åœ¨æ’æŸ¥è¿‡ç¨‹ä¸­å‘ç°å†…å­˜æ¶ˆè€—å¼‚å¸¸ï¼Œé€šè¿‡å†…å­˜åˆ†æå‘ç°ä»£ç å¯ä»¥ä¼˜åŒ–ï¼Œé‚£å°±ä¼˜åŒ–ä»£ç é€»è¾‘ã€‚</p><p>å¦‚æœæ˜¯å †å†…å­˜å ç”¨ä¸å¤§ï¼Œä½†æ˜¯ Pod è¿˜æ˜¯ OOM å¯¼è‡´é‡å¯ï¼Œé‚£å°±è¦çœ‹çœ‹ JVM çš„å†…å­˜åˆ†é…æ˜¯å¦åˆç†ï¼Œåº”è¯¥å¤šé¢„ç•™ä¸€äº›å†…å­˜ç»™å †å¤–ä½¿ç”¨ã€‚</p><p>ä½†è¿™ä¸ªè¿‡ç¨‹éœ€è¦æœ‰<strong>å®Œå–„çš„å¯è§‚æµ‹ç³»ç»Ÿçš„</strong>æ”¯æ’‘ï¼Œæ¯”å¦‚æ—¥å¿—ã€ç›‘æ§ç­‰ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›æ•°æ®ï¼Œå†å›å¤´æ’æŸ¥é—®é¢˜å°±ä¼šæ¯”è¾ƒå›°éš¾ã€‚</p><p>æ€»ä¹‹è¿™ä¸ªæ’æŸ¥è¿‡ç¨‹æ‰æ˜¯æœ€ä¸»è¦çš„ï¼Œå¤§å®¶è¿˜æœ‰ä»€ä¹ˆæ’æŸ¥é—®é¢˜çš„å° tips ä¹Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰å‡ å¤©æ’æŸ¥äº†ä¸€ä¸ªä¸šåŠ¡æ¥å£æ‰§è¡Œé«˜å»¶è¿Ÿçš„é—®é¢˜ï¼Œä¹ŸæŒºæœ‰å‚è€ƒæ„ä¹‰çš„ï¼Œåˆ†äº«ä¸€ä¸‹æ’æŸ¥è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;ç°è±¡æ˜¯ä¸šåŠ¡åé¦ˆæœ‰ä¸€ä¸ªæ¥å£ä¸šåŠ¡é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œä½†æ˜¯è°ƒç”¨ä¸€æ¬¡è€—æ—¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/10/16/Am9VkNZ5Ep4Uj6G.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="é—®é¢˜æ’æŸ¥" scheme="http://crossoverjie.top/categories/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    
    
    <category term="Java" scheme="http://crossoverjie.top/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>IMç³»ç»Ÿé‡æ„åˆ° SDK è®¾è®¡çš„æœ€ä½³å®è·µ</title>
    <link href="http://crossoverjie.top/2024/10/13/ob/cim-client-sdk/"/>
    <id>http://crossoverjie.top/2024/10/13/ob/cim-client-sdk/</id>
    <published>2024-10-13T14:04:45.000Z</published>
    <updated>2024-10-13T06:00:43.572Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2024/10/13/PW1J2bXx39cfpnC.png"></p><h1 id="SDK-è®¾è®¡"><a href="#SDK-è®¾è®¡" class="headerlink" title="SDK è®¾è®¡"></a>SDK è®¾è®¡</h1><p><img src="https://s2.loli.net/2024/09/17/Ck6AfdGOPISDrVN.png"></p><p>åœ¨ä¹‹å‰æåˆ°äº† <a href="https://github.com/crossoverJie/cim">cim</a> åœ¨åšé›†æˆæµ‹è¯•çš„æ—¶å€™é‡åˆ°çš„é—®é¢˜ï¼Œéœ€è¦æä¾›ä¸€ä¸ª SDK æ¥è§£å†³ï¼Œäºæ˜¯æˆ‘èŠ±äº†ä¸€äº›æ—¶é—´ç¼–å†™äº† SDKï¼ŒåŒæ—¶ä¹Ÿå°† cim-client é‡æ„äº†ã€‚</p><span id="more"></span><p>é‡æ„åçš„ä»£ç é•¿è¿™ä¸ªæ ·å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Client <span class="title function_">buildClient</span><span class="params">(<span class="meta">@Qualifier(&quot;callBackThreadPool&quot;)</span> ThreadPoolExecutor callbackThreadPool,</span></span><br><span class="line"><span class="params">                          Event event)</span> &#123;</span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder().connectTimeout(<span class="number">3</span>, TimeUnit.SECONDS)</span><br><span class="line">            .readTimeout(<span class="number">3</span>, TimeUnit.SECONDS)</span><br><span class="line">            .writeTimeout(<span class="number">3</span>, TimeUnit.SECONDS)</span><br><span class="line">            .retryOnConnectionFailure(<span class="literal">true</span>).build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Client.builder()</span><br><span class="line">            .auth(ClientConfigurationData.Auth.builder()</span><br><span class="line">                    .userName(appConfiguration.getUserName())</span><br><span class="line">                    .userId(appConfiguration.getUserId())</span><br><span class="line">                    .build())</span><br><span class="line">            .routeUrl(appConfiguration.getRouteUrl())</span><br><span class="line">            .loginRetryCount(appConfiguration.getReconnectCount())</span><br><span class="line">            .event(event)</span><br><span class="line">            .reconnectCheck(client -&gt; !shutDownSign.checkStatus())</span><br><span class="line">            .okHttpClient(okHttpClient)</span><br><span class="line">            .messageListener(<span class="keyword">new</span> <span class="title class_">MsgCallBackListener</span>(msgLogger))</span><br><span class="line">            .callbackThreadPool(callbackThreadPool)</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…åˆ <code>springboot</code> ä½¿ç”¨æ—¶åªéœ€è¦åˆ›å»ºä¸€ä¸ª <code>Client</code> å³å¯ï¼Œè¿™ä¸ª <code>Client</code> é‡Œç»´æŠ¤äº†æ ¸å¿ƒçš„ï¼š</p><ul><li>é•¿é“¾æ¥åˆ›å»ºã€çŠ¶æ€ç»´æŠ¤</li><li>å¿ƒè·³æ£€æµ‹</li><li>è¶…æ—¶ã€ç½‘ç»œå¼‚å¸¸é‡è¿ç­‰</li></ul><p>åŒæ—¶ä¹Ÿæä¾›äº†ç®€æ˜“çš„ API å¯ä»¥ç›´æ¥æ”¶å‘æ¶ˆæ¯ï¼š<br><img src="https://s2.loli.net/2024/09/17/2tCXEo9nLvIrNTf.png"></p><p>è¿™æ ·åœ¨é›†æˆåˆ°ä¸šåŠ¡ä»£ç ä¸­æ—¶ä¼šæ›´æ–¹ä¾¿ã€‚</p><p>ä»¥å‰çš„ä»£ç è€¦åˆåº¦éå¸¸é«˜ï¼ŒåŒæ—¶å› ä¸ºåŸºç¡€ä»£ç æ˜¯ 18 å¹´å†™çš„ï¼Œç°åœ¨çœŸçš„æ²¡æœ‰çœ¼çœ‹äº†ï¼›</p><p>é‡æ„çš„è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸€äº› Java8+ çš„ä¸€äº›è¯­æ³•ç³–ç²¾ç®€äº†è®¸å¤šä»£ç ï¼Œå„ä¸ªæ¨¡å—é—´çš„ç»„ç»‡å…³ç³»ä¹Ÿé‡æ–°æ¢³ç†ï¼Œç°åœ¨ä¼šæ›´æ˜“ç»´æŠ¤äº†ã€‚</p><p>æ¯”å¦‚ç”±äºåˆ›å»ºå®¢æˆ·ç«¯éœ€è¦è®¸å¤šå¯é€‰å‚æ•°ï¼Œäºæ˜¯å°±æä¾›äº† Builder æ¨¡å¼çš„åˆ›å»ºé€‰é¡¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClientBuilder</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    Client <span class="title function_">build</span><span class="params">()</span>;  </span><br><span class="line">    ClientBuilder <span class="title function_">auth</span><span class="params">(ClientConfigurationData.Auth auth)</span>;  </span><br><span class="line">    ClientBuilder <span class="title function_">routeUrl</span><span class="params">(String routeUrl)</span>;  </span><br><span class="line">    ClientBuilder <span class="title function_">loginRetryCount</span><span class="params">(<span class="type">int</span> loginRetryCount)</span>;  </span><br><span class="line">    ClientBuilder <span class="title function_">event</span><span class="params">(Event event)</span>;  </span><br><span class="line">    ClientBuilder <span class="title function_">reconnectCheck</span><span class="params">(ReconnectCheck reconnectCheck)</span>;  </span><br><span class="line">    ClientBuilder <span class="title function_">okHttpClient</span><span class="params">(OkHttpClient okHttpClient)</span>;  </span><br><span class="line">    ClientBuilder <span class="title function_">messageListener</span><span class="params">(MessageListener messageListener)</span>;  </span><br><span class="line">    ClientBuilder <span class="title function_">callbackThreadPool</span><span class="params">(ThreadPoolExecutor callbackThreadPool)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä»¥ä¸Šéƒ¨åˆ† API çš„è®¾è®¡å€Ÿé‰´äº† Pulsarã€‚</p></blockquote><h1 id="Proxy-ä¼˜åŒ–"><a href="#Proxy-ä¼˜åŒ–" class="headerlink" title="Proxy ä¼˜åŒ–"></a>Proxy ä¼˜åŒ–</h1><p>é™¤æ­¤ä¹‹å¤–è¿˜ä¼˜åŒ–äº†è¯·æ±‚ä»£ç†ï¼Œè¿™ä¸ª Proxy ä¸»è¦æ˜¯ç”¨äºæ–¹ä¾¿åœ¨å„ä¸ªæœåŠ¡ä¸­å‘èµ· rest è°ƒç”¨ï¼Œæˆ‘è¿™é‡Œä¸ºäº†è½»é‡ä¹Ÿæ²¡æœ‰ä½¿ç”¨ Dubboã€SpringCloud è¿™ç±»æœåŠ¡æ¡†æ¶ã€‚</p><p>ä½†å¦‚æœéƒ½ç¡¬ç¼–ç  http client å»è¯·æ±‚æ—¶ä¼šæœ‰è®¸å¤šé‡å¤å†—ä½™çš„ä»£ç ï¼Œæ¯”å¦‚åˆ›å»ºè¿æ¥ã€è¯·æ±‚å‚æ•°ã€å“åº”è§£æã€å¼‚å¸¸å¤„ç†ç­‰ã€‚</p><p>äºæ˜¯åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­å°±æä¾›äº†ä¸€ä¸ª <code>ProxyManager</code> çš„åŸºæœ¬å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> List&lt;OnlineUsersResVO.DataBodyBean&gt; onlineUsers() <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">    <span class="type">RouteApi</span> <span class="variable">routeApi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProxyManager</span>&lt;&gt;(RouteApi.class, routeUrl, okHttpClient).getInstance();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="type">OnlineUsersResVO</span> <span class="variable">onlineUsersResVO</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        response = (Response) routeApi.onlineUser();  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> response.body().string() ;  </span><br><span class="line">        onlineUsersResVO = JSON.parseObject(json, OnlineUsersResVO.class);  </span><br><span class="line">  </span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;  </span><br><span class="line">        log.error(<span class="string">&quot;exception&quot;</span>,e);  </span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;  </span><br><span class="line">        response.body().close();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> onlineUsersResVO.getDataBody();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™½ç„¶æä¾›äº†ä¸€äº›è¿æ¥ç®¡ç†å’Œå‚æ•°å°è£…ç­‰åŸºç¡€åŠŸèƒ½ï¼Œä½†åªå®ç°äº†ä¸€åŠã€‚</p><p>ä»ä¸Šé¢çš„ä»£ç ä¹Ÿå¯ä»¥çœ‹å‡ºåºåˆ—åŒ–éƒ½å¾—è‡ªå·±å®ç°ï¼Œè¿™äº›ä»£ç å®Œå…¨æ˜¯å†—ä½™çš„ã€‚</p><p>ç»è¿‡é‡æ„åä»¥ä¸Šçš„ä»£ç å¯ä»¥ç²¾ç®€åˆ°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜æ¥å£</span></span><br><span class="line"><span class="meta">@Request(method = Request.GET)</span>  </span><br><span class="line">BaseResponse&lt;Set&lt;CIMUserInfo&gt;&gt; <span class="title function_">onlineUser</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">routeApi = RpcProxyManager.create(RouteApi.class, routeUrl, okHttpClient);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Set&lt;CIMUserInfo&gt; <span class="title function_">onlineUser</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">    BaseResponse&lt;Set&lt;CIMUserInfo&gt;&gt; onlineUsersResVO = routeApi.onlineUser();  </span><br><span class="line">    <span class="keyword">return</span> onlineUsersResVO.getDataBody();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè°ƒæ•´ä¹‹åå°±éå¸¸ç±»ä¼¼äº Dubbo gRPC è¿™ç±» RPC æ¡†æ¶çš„ä½¿ç”¨ï¼Œåªéœ€è¦æŠŠæ¥å£å®šä¹‰å¥½ï¼Œå°±å’Œè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·çš„ç®€å•ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿åç»­å¯èƒ½è°ƒç”¨ä¸€äº›å¤–éƒ¨ç³»ç»Ÿï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿˜æ”¯æŒäº†æŒ‡å®šå¤šç§è¯·æ±‚ methodã€æŒ‡å®š URL ã€è¿”å›ç»“æœåµŒå¥—æ³›å‹ç­‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Request(url = &quot;sample-request?author=beeceptor&quot;)</span>  </span><br><span class="line">EchoGeneric&lt;EchoResponse.HeadersDTO&gt; echoGeneric(EchoRequest message);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGeneric</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();  </span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://echo.free.beeceptor.com&quot;</span>;  </span><br><span class="line">    <span class="type">Echo</span> <span class="variable">echo</span> <span class="operator">=</span> RpcProxyManager.create(Echo.class, url, client);  </span><br><span class="line">    <span class="type">EchoRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EchoRequest</span>();  </span><br><span class="line">    request.setName(<span class="string">&quot;crossoverJie&quot;</span>);  </span><br><span class="line">    request.setAge(<span class="number">18</span>);  </span><br><span class="line">    request.setCity(<span class="string">&quot;shenzhen&quot;</span>);  </span><br><span class="line">    <span class="comment">// æ”¯æŒæ³›å‹è§£æ</span></span><br><span class="line">    EchoGeneric&lt;EchoResponse.HeadersDTO&gt; response = echo.echoGeneric(request);  </span><br><span class="line">    Assertions.assertEquals(response.getHeaders().getHost(), <span class="string">&quot;echo.free.beeceptor.com&quot;</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ”¯æŒåŠ¨æ€-URL-è°ƒç”¨"><a href="#æ”¯æŒåŠ¨æ€-URL-è°ƒç”¨" class="headerlink" title="æ”¯æŒåŠ¨æ€ URL è°ƒç”¨"></a>æ”¯æŒåŠ¨æ€ URL è°ƒç”¨</h2><p><img src="https://s2.loli.net/2024/09/19/v8NgprfJ5PWAsER.png"></p><p>è¿˜æœ‰ä¸€ä¸ª todoï¼šå¸Œæœ›å¯ä»¥å°† <code>ProxyManager</code> äº¤ç»™ <code>Spring</code> å»ç®¡ç†ï¼Œä¹‹å‰æ˜¯åœ¨æ¯æ¬¡è°ƒç”¨çš„åœ°æ–¹éƒ½ä¼šåˆ›å»ºä¸€ä¸ª Proxy å¯¹è±¡ï¼Œå®Œå…¨æ²¡æœ‰å¿…è¦ï¼Œä»£ç ä¹Ÿå¾ˆå†—ä½™ã€‚</p><p>ä½†æœ‰ç½‘å‹åœ¨å®ç°è¿‡ç¨‹ä¸­å‘ç°ï¼Œæœ‰ä¸ªåœºæ™¯çš„è¯·æ±‚åœ°å€æ˜¯åŠ¨æ€çš„ï¼Œå¦‚æœæ˜¯äº¤ç»™ Spring ç®¡ç†ä¸ºå•ä¾‹åæ˜¯æ²¡æ³•ä¿®æ”¹ URL åœ°å€çš„ï¼Œå› ä¸ºè¿™ä¸ªåœ°å€æ˜¯åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™åˆå§‹åŒ–çš„ã€‚</p><p>æ‰€ä»¥æˆ‘å°±åœ¨è¿™é‡Œæ–°å¢äº†ä¸€ä¸ªåŠ¨æ€ URL çš„ç‰¹æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EchoResponse <span class="title function_">echoTarget</span><span class="params">(EchoRequest message, <span class="meta">@DynamicUrl(useMethodEndpoint = false)</span> String url)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">Echo</span> <span class="variable">echo</span> <span class="operator">=</span> RpcProxyManager.create(Echo.class, client);</span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://echo.free.beeceptor.com/sample-request?author=beeceptor&quot;</span>;</span><br><span class="line"><span class="type">EchoResponse</span> <span class="variable">response</span> <span class="operator">=</span> echo.echoTarget(request, url);</span><br></pre></td></tr></table></figure><p>åœ¨å£°æ˜æ¥å£çš„æ—¶å€™ä½¿ç”¨ <code>@DynamicUrl</code> çš„æ–¹æ³•å‚æ•°æ³¨è§£ï¼Œå‘Šè¯‰ä»£ç†è¿™ä¸ªå‚æ•°æ˜¯ URLã€‚<br>è¿™æ ·å°±å¯ä»¥å…è®¸åœ¨åˆ›å»º  <code>Proxy</code> å¯¹è±¡çš„æ—¶å€™ä¸æŒ‡å®š URLï¼Œè€Œæ˜¯åœ¨å®é™…è°ƒç”¨æ—¶å€™å†ä¼ å…¥å…·ä½“çš„ URLï¼Œæ›´æ–¹ä¾¿åˆ›å»ºå•ä¾‹äº†ã€‚</p><h1 id="é›†æˆæµ‹è¯•ä¼˜åŒ–"><a href="#é›†æˆæµ‹è¯•ä¼˜åŒ–" class="headerlink" title="é›†æˆæµ‹è¯•ä¼˜åŒ–"></a>é›†æˆæµ‹è¯•ä¼˜åŒ–</h1><p>åŒæ—¶è¿˜ä¼˜åŒ–äº†é›†æˆæµ‹è¯•ï¼Œæ”¯æŒäº† server çš„é›†ç¾¤ç‰ˆæµ‹è¯•ã€‚</p><p><a href="https://github.com/crossoverJie/cim/blob/4c149f8bda78718e3ecae2c5759aa9732eff9132/cim-client-sdk/src/test/java/com/crossoverjie/cim/client/sdk/ClientTest.java#L210">https://github.com/crossoverJie/cim/blob/4c149f8bda78718e3ecae2c5759aa9732eff9132/cim-client-sdk/src/test/java/com/crossoverjie/cim/client/sdk/ClientTest.java#L210</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReconnect</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">    <span class="built_in">super</span>.startTwoServer();  </span><br><span class="line">    <span class="built_in">super</span>.startRoute();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">routeUrl</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8083&quot;</span>;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">cj</span> <span class="operator">=</span> <span class="string">&quot;cj&quot;</span>;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">zs</span> <span class="operator">=</span> <span class="string">&quot;zs&quot;</span>;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">cjId</span> <span class="operator">=</span> <span class="built_in">super</span>.registerAccount(cj);  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">zsId</span> <span class="operator">=</span> <span class="built_in">super</span>.registerAccount(zs);  </span><br><span class="line">    <span class="type">var</span> <span class="variable">auth1</span> <span class="operator">=</span> ClientConfigurationData.Auth.builder()  </span><br><span class="line">            .userName(cj)  </span><br><span class="line">            .userId(cjId)  </span><br><span class="line">            .build();  </span><br><span class="line">    <span class="type">var</span> <span class="variable">auth2</span> <span class="operator">=</span> ClientConfigurationData.Auth.builder()  </span><br><span class="line">            .userName(zs)  </span><br><span class="line">            .userId(zsId)  </span><br><span class="line">            .build();  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Cleanup</span>  </span><br><span class="line">    <span class="type">Client</span> <span class="variable">client1</span> <span class="operator">=</span> Client.builder()  </span><br><span class="line">            .auth(auth1)  </span><br><span class="line">            .routeUrl(routeUrl)  </span><br><span class="line">            .build();  </span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">3</span>);  </span><br><span class="line">    ClientState.<span class="type">State</span> <span class="variable">state</span> <span class="operator">=</span> client1.getState();  </span><br><span class="line">    Awaitility.await().atMost(<span class="number">10</span>, TimeUnit.SECONDS)  </span><br><span class="line">            .untilAsserted(() -&gt; Assertions.assertEquals(ClientState.State.Ready, state));  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    AtomicReference&lt;String&gt; client2Receive = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();  </span><br><span class="line">    <span class="meta">@Cleanup</span>  </span><br><span class="line">    <span class="type">Client</span> <span class="variable">client2</span> <span class="operator">=</span> Client.builder()  </span><br><span class="line">            .auth(auth2)  </span><br><span class="line">            .routeUrl(routeUrl)  </span><br><span class="line">            .messageListener((client, message) -&gt; client2Receive.set(message))  </span><br><span class="line">            .build();  </span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">3</span>);  </span><br><span class="line">    ClientState.<span class="type">State</span> <span class="variable">state2</span> <span class="operator">=</span> client2.getState();  </span><br><span class="line">    Awaitility.await().atMost(<span class="number">10</span>, TimeUnit.SECONDS)  </span><br><span class="line">            .untilAsserted(() -&gt; Assertions.assertEquals(ClientState.State.Ready, state2));  </span><br><span class="line">  </span><br><span class="line">    Optional&lt;CIMServerResVO&gt; serverInfo2 = client2.getServerInfo();  </span><br><span class="line">    Assertions.assertTrue(serverInfo2.isPresent());  </span><br><span class="line">    System.out.println(<span class="string">&quot;client2 serverInfo = &quot;</span> + serverInfo2.get());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// send msg  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;  </span><br><span class="line">    client1.sendGroup(msg);  </span><br><span class="line">    Awaitility.await()  </span><br><span class="line">            .untilAsserted(() -&gt; Assertions.assertEquals(String.format(<span class="string">&quot;cj:%s&quot;</span>, msg), client2Receive.get()));  </span><br><span class="line">    client2Receive.set(<span class="string">&quot;&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    System.out.println(<span class="string">&quot;ready to restart server&quot;</span>);  </span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">3</span>);  </span><br><span class="line">    Optional&lt;CIMServerResVO&gt; serverInfo = client1.getServerInfo();  </span><br><span class="line">    Assertions.assertTrue(serverInfo.isPresent());  </span><br><span class="line">    System.out.println(<span class="string">&quot;server info = &quot;</span> + serverInfo.get());  </span><br><span class="line">  </span><br><span class="line">    <span class="built_in">super</span>.stopServer(serverInfo.get().getCimServerPort());  </span><br><span class="line">    System.out.println(<span class="string">&quot;stop server success! &quot;</span> + serverInfo.get());  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Waiting server stopped, and client reconnect.  </span></span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">30</span>);  </span><br><span class="line">    System.out.println(<span class="string">&quot;reconnect state: &quot;</span> + client1.getState());  </span><br><span class="line">    Awaitility.await().atMost(<span class="number">15</span>, TimeUnit.SECONDS)  </span><br><span class="line">            .untilAsserted(() -&gt; Assertions.assertEquals(ClientState.State.Ready, state));  </span><br><span class="line">    serverInfo = client1.getServerInfo();  </span><br><span class="line">    Assertions.assertTrue(serverInfo.isPresent());  </span><br><span class="line">    System.out.println(<span class="string">&quot;client1 reconnect server info = &quot;</span> + serverInfo.get());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Send message again.  </span></span><br><span class="line">    log.info(<span class="string">&quot;send message again, client2Receive = &#123;&#125;&quot;</span>, client2Receive.get());  </span><br><span class="line">    client1.sendGroup(msg);  </span><br><span class="line">    Awaitility.await()  </span><br><span class="line">            .untilAsserted(() -&gt; Assertions.assertEquals(String.format(<span class="string">&quot;cj:%s&quot;</span>, msg), client2Receive.get()));  </span><br><span class="line">    <span class="built_in">super</span>.stopTwoServer();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚åœ¨è¿™é‡Œç¼–å†™äº†ä¸€ä¸ªå®¢æˆ·ç«¯é‡è¿çš„å•æµ‹ï¼Œä»£ç æœ‰ç‚¹é•¿ï¼Œä½†å®ƒçš„ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å¯åŠ¨ä¸¤ä¸ª Serverï¼šServer1ï¼ŒServer2</li><li>å¯åŠ¨ Route</li><li>åœ¨å¯åŠ¨ä¸¤ä¸ª Client å‘é€æ¶ˆæ¯<ul><li>æ ¡éªŒæ¶ˆæ¯å‘é€æ˜¯å¦æˆåŠŸ</li></ul></li><li><strong>åœæ­¢ Client1 è¿æ¥çš„ Server</strong></li><li><strong>ç­‰å¾… Client è‡ªåŠ¨é‡è¿åˆ°å¦ä¸€ä¸ª Server</strong></li><li>å†æ¬¡å‘é€æ¶ˆæ¯<ul><li>æ ¡éªŒæ¶ˆæ¯å‘é€æ˜¯å¦æˆåŠŸ</li></ul></li></ul><p>è¿™æ ·å°±å¯ä»¥éªŒè¯åœ¨æœåŠ¡ç«¯ Server å®•æœºåæ•´ä¸ªæœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œæ¶ˆæ¯æ”¶å‘æ˜¯å¦æ­£å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startTwoServer</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (!zooKeeperContainer.isRunning())&#123;  </span><br><span class="line">        zooKeeperContainer.start();  </span><br><span class="line">    &#125;    zookeeperAddr = String.format(<span class="string">&quot;%s:%d&quot;</span>, zooKeeperContainer.getHost(), zooKeeperContainer.getMappedPort(ZooKeeperContainer.DEFAULT_CLIENT_PORT));  </span><br><span class="line">    <span class="type">SpringApplication</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(CIMServerApplication.class);  </span><br><span class="line">    String[] args1 = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;  </span><br><span class="line">            <span class="string">&quot;--cim.server.port=11211&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;--server.port=8081&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;--app.zk.addr=&quot;</span> + zookeeperAddr,  </span><br><span class="line">    &#125;;    <span class="type">ConfigurableApplicationContext</span> <span class="variable">run1</span> <span class="operator">=</span> server.run(args1);  </span><br><span class="line">    runMap.put(Integer.parseInt(<span class="string">&quot;11211&quot;</span>), run1);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="type">SpringApplication</span> <span class="variable">server2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(CIMServerApplication.class);  </span><br><span class="line">    String[] args2 = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;  </span><br><span class="line">            <span class="string">&quot;--cim.server.port=11212&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;--server.port=8082&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;--app.zk.addr=&quot;</span> + zookeeperAddr,  </span><br><span class="line">    &#125;;    <span class="type">ConfigurableApplicationContext</span> <span class="variable">run2</span> <span class="operator">=</span> server2.run(args2);  </span><br><span class="line">    runMap.put(Integer.parseInt(<span class="string">&quot;11212&quot;</span>), run2);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopServer</span><span class="params">(Integer port)</span> &#123;  </span><br><span class="line">    runMap.get(port).close();  </span><br><span class="line">    runMap.remove(port);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å¯åŠ¨ä¸¤ä¸ª Server å°±æ˜¯åˆ›å»ºäº†ä¸¤ä¸ª Server åº”ç”¨ï¼Œç„¶åä¿å­˜å¥½ç«¯å£å’Œåº”ç”¨ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</p><p>è¿™æ ·å°±å¯ä»¥æ ¹æ®å®¢æˆ·ç«¯è¿æ¥çš„ Server ä¿¡æ¯æŒ‡å®šåœæ­¢å“ªä¸€ä¸ª Serverï¼Œæ›´æ–¹ä¾¿åšæµ‹è¯•ã€‚</p><p>è¿™æ¬¡é‡å¯ <a href="https://github.com/crossoverJie/cim">cim</a> çš„ç»´æŠ¤åä¼šå°½é‡ç»´æŠ¤ä¸‹å»ï¼Œå³ä¾¿æ›´æ–°æ—¶é—´æ…¢ä¸€ç‚¹ã€‚</p><p>åç»­è¿˜ä¼šåŠ ä¸Šæ¶ˆæ¯ ackã€ç¦»çº¿æ¶ˆæ¯ç­‰ä¹‹å‰å‘¼å£°å¾ˆé«˜çš„åŠŸèƒ½ï¼Œæ„Ÿå…´è¶£çš„å®Œå…¨å¯ä»¥ä¸€èµ·å‚ä¸ã€‚</p><p>æºç åœ°å€ï¼š<br><a href="https://github.com/crossoverJie/cim">https://github.com/crossoverJie/cim</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/10/13/PW1J2bXx39cfpnC.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;SDK-è®¾è®¡&quot;&gt;&lt;a href=&quot;#SDK-è®¾è®¡&quot; class=&quot;headerlink&quot; title=&quot;SDK è®¾è®¡&quot;&gt;&lt;/a&gt;SDK è®¾è®¡&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/09/17/Ck6AfdGOPISDrVN.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ä¹‹å‰æåˆ°äº† &lt;a href=&quot;https://github.com/crossoverJie/cim&quot;&gt;cim&lt;/a&gt; åœ¨åšé›†æˆæµ‹è¯•çš„æ—¶å€™é‡åˆ°çš„é—®é¢˜ï¼Œéœ€è¦æä¾›ä¸€ä¸ª SDK æ¥è§£å†³ï¼Œäºæ˜¯æˆ‘èŠ±äº†ä¸€äº›æ—¶é—´ç¼–å†™äº† SDKï¼ŒåŒæ—¶ä¹Ÿå°† cim-client é‡æ„äº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="cim" scheme="http://crossoverjie.top/categories/cim/"/>
    
    
    <category term="cim" scheme="http://crossoverjie.top/tags/cim/"/>
    
  </entry>
  
  <entry>
    <title>StarRocks å¼€å‘ç¯å¢ƒæ­å»ºè¸©å‘æŒ‡åŒ—</title>
    <link href="http://crossoverjie.top/2024/10/09/ob/StarRocks-dev-env-build/"/>
    <id>http://crossoverjie.top/2024/10/09/ob/StarRocks-dev-env-build/</id>
    <published>2024-10-09T09:20:19.000Z</published>
    <updated>2024-10-08T14:21:33.221Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æœ€è¿‘è¿™æ®µæ—¶é—´åœ¨å¤„ç†ä¸€ä¸ª <code>StarRocks</code> çš„å…³äºç‰©åŒ–è§†å›¾ä¼˜åŒ–çš„ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨æ­¤ä¹‹å‰å…¶å®æˆ‘ä¹Ÿæ²¡æœ‰æ¥è§¦è¿‡ <code>StarRocks</code> è¿™ç±»ä¸»è¦å¤„ç†æ•°æ®åˆ†æçš„æ•°æ®åº“ï¼Œå°±æ›´åˆ«æåœ¨è¿™ä¸Šé¢åšä¼˜åŒ–äº†ã€‚</p><p>åœ¨è§£å†³é—®é¢˜ä¹‹å‰æˆ‘å…ˆèŠ±äº†ä¸€ä¸¤å¤©æ—¶é—´ç†Ÿæ‚‰äº†ä¸€ä¸‹ <code>StarRocks</code> çš„ä¸€äº›æ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ï¼Œç„¶ååˆèŠ±äº†ä¸€äº›æ—¶é—´æ­å»ºç¯å¢ƒç„¶åå¤ç°äº†è¯¥é—®é¢˜ã€‚</p><p>ä¹‹åä¾¿å¼€å§‹é˜…è¯»æºç ï¼Œå¤§æ¦‚çŸ¥é“äº†ç›¸å…³ä»£ç çš„æ‰§è¡Œæµç¨‹ï¼Œä½†å³ä¾¿æ˜¯åå¤é˜…è¯»äº†å¤šæ¬¡ä»£ç ä¹Ÿæ²¡æœ‰æ‰¾åˆ°å…·ä½“å‡ºç°é—®é¢˜çš„åœ°æ–¹ã€‚</p><p>æ‰€ä»¥ä¾¿è€ƒè™‘åœ¨æœ¬åœ° Debug æºç ï¼Œæœ€ç»ˆè°ƒè¯•åŠå¤©ä¹‹åçŸ¥é“äº†é—®é¢˜æ‰€ä»¥ï¼Œä¹Ÿåšäº†ç›¸å…³ä¿®æ”¹ï¼Œç»™ç¤¾åŒºæäº¤äº† PRï¼Œç›®å‰è¿˜åœ¨æ¨è¿›è¿‡ç¨‹ä¸­ã€‚</p><span id="more"></span><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>è¿™é‡Œæ¯”è¾ƒéº»çƒ¦çš„æ˜¯å¦‚ä½•åœ¨æœ¬åœ° debug ä»£ç ã€‚<br><img src="https://s2.loli.net/2024/09/16/uqKGRIJXZB3pbMy.png"><br>æ ¹æ®å®˜æ–¹çš„æ¶æ„å›¾ä¼šå‘ç° <code>StarRocks</code> ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>FEï¼šä¹Ÿå°±æ˜¯å¸¸è¯´çš„å‰ç«¯éƒ¨åˆ†ï¼Œä¸»è¦è´Ÿè´£å…ƒæ•°æ®ç®¡ç†å’Œæ„å»ºæ‰§è¡Œè®¡åˆ’ã€‚</li><li>BEï¼šåç«¯å­˜å‚¨éƒ¨åˆ†ï¼Œæ‰§è¡ŒæŸ¥è¯¢è®¡åˆ’å¹¶å­˜å‚¨æ•°æ®ã€‚</li></ul><p>å…¶ä¸­ FE æ˜¯ Java å†™çš„ï¼Œè€Œå­˜å‚¨çš„ BE åˆ™æ˜¯ C++ å†™çš„ï¼Œæˆ‘è¿™æ¬¡éœ€è¦ä¿®æ”¹çš„æ˜¯ FE å‰ç«¯çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥æœ¬ç¯‡æ–‡ç« ä¸»è¦è®¨è®ºçš„æ˜¯ FE ç›¸å…³çš„å†…å®¹ã€‚</p><p>å¥½åœ¨ç¤¾åŒºå·²ç»æœ‰å…³äºå¦‚ä½•ç¼–è¯‘å’Œæ„å»ºæºç çš„æ•™ç¨‹ï¼Œè¿™é‡Œæˆ‘åˆ—ä¸¾ä¸€äº›é‡ç‚¹ï¼ŒFE é¦–å…ˆéœ€è¦å®‰è£…ä»¥ä¸‹ä¸€äº›å·¥å…·ï¼š</p><ul><li>Thrift</li><li>Protobuf</li><li>Python3</li><li>JDK8+</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">brew install alberttwong/thrift/thrift@0.13</span><br><span class="line">$ thrift -version  </span><br><span class="line">Thrift version 0.13.0</span><br><span class="line"></span><br><span class="line">brew install protobuf</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé»˜è®¤æ˜¯åœ¨  Mac å¹³å°ä¸Šå®‰è£…çš„æµç¨‹ï¼Œæ‰€ä»¥å…¨ç¨‹ä½¿ç”¨ <code>brew</code> æœ€æ–¹ä¾¿äº†ï¼Œå¦‚æœæ˜¯å…¶ä»–å¹³å°ä¹Ÿæ˜¯åŒç†ï¼Œåªè¦å®‰è£…å¥½è¿™äº›å·¥å…·å³å¯ã€‚</p><p>ç´§æ¥ç€ä¾¿æ˜¯ç¼–è¯‘ FEï¼Œæˆ‘ä»¬éœ€è¦å…ˆä¸‹è½½æºç ï¼Œç„¶åè¿›å…¥ FE çš„ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/StarRocks/starrocks.git</span><br><span class="line"><span class="built_in">cd</span> fe</span><br><span class="line">mvn install -DskipTests</span><br></pre></td></tr></table></figure><p>ç„¶åç›´æ¥ä½¿ç”¨ <code>maven</code> ç¼–è¯‘å®‰è£…å³å¯ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„âš ï¸ï¼Œå› ä¸ºç¼–è¯‘è¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨ <code>Python3</code> æ¥æ‰§è¡Œä¸€äº›æ„å»ºä»»åŠ¡ï¼Œæ–°ç‰ˆæœ¬çš„ Mac éƒ½æ˜¯å†…ç½® <code>Python3</code> çš„ï¼Œä½†å¦‚æœæ˜¯è€ç‰ˆæœ¬çš„ <code>Mac</code> å†…ç½®çš„åˆ™æ˜¯ Python2ã€‚</p><p>è¿™æ—¶å°±éœ€è¦æˆ‘ä»¬å°† Python3 çš„å‘½ä»¤æ‰‹åŠ¨åœ¨æ„å»ºä»»åŠ¡é‡ŒæŒ‡å®šä¸€ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2024/09/16/ouLglsXJEm1TpSh.png"></p><p>æ¯”å¦‚æˆ‘è¿™é‡Œçš„ Python3  å‘½ä»¤ä¸º <code>python3</code></p><p>æˆ‘ä»¬éœ€è¦åœ¨ <code>fe/fe-core/pom.xml</code> ç›®å½•é‡Œä¿®æ”¹ä¸‹ Python çš„å‘½ä»¤åç§°ï¼š<br><img src="https://s2.loli.net/2024/09/16/tcfwoilyDdTQpxX.png"></p><p>ä¿®æ”¹ä¹‹åå† <code>mvn install</code> ç¼–è¯‘ä¸€æ¬¡ï¼Œå¦‚æœä¸€åˆ‡é¡ºåˆ©çš„è¯ä¾¿ä¼šç¼–è¯‘æˆåŠŸã€‚</p><h2 id="æ­å»ºæœ¬åœ°é›†ç¾¤"><a href="#æ­å»ºæœ¬åœ°é›†ç¾¤" class="headerlink" title="æ­å»ºæœ¬åœ°é›†ç¾¤"></a>æ­å»ºæœ¬åœ°é›†ç¾¤</h2><h3 id="å¯åŠ¨-FE"><a href="#å¯åŠ¨-FE" class="headerlink" title="å¯åŠ¨ FE"></a>å¯åŠ¨ FE</h3><p>æˆ‘çš„æœ€ç»ˆç›®çš„æ˜¯å¯ä»¥åœ¨æœ¬åœ° IDEA ä¸­å¯åŠ¨ FE ç„¶åå†é…åˆå¯åŠ¨ä¸€ä¸ª BEï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ IDEA ä¸­è°ƒè¯• FE çš„æºç äº†ã€‚</p><p>åœ¨å¯åŠ¨ FE ä¹‹å‰è¿˜éœ€è¦åˆ›å»ºä¸€äº›ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> -r conf fe/conf</span><br><span class="line"><span class="built_in">cp</span> -r bin fe/bin</span><br><span class="line"><span class="built_in">cp</span> -r webroot fe/webroot</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> fe  </span><br><span class="line"><span class="built_in">mkdir</span> <span class="built_in">log</span>  </span><br><span class="line"><span class="built_in">mkdir</span> meta</span><br></pre></td></tr></table></figure><p>ä¸»è¦å°±æ˜¯è¦åœ¨ FE çš„ç›®å½•ä¸‹åˆ›å»ºé…ç½®æ–‡ä»¶ã€æ‰§è¡Œè„šæœ¬ã€æ—¥å¿—ã€å…ƒæ•°æ®ç­‰ç›®å½•ã€‚</p><p>æ¥ç€ä¾¿å¯ä»¥æ‰“å¼€ <code>com.starrocks.StarRocksFE</code> ç±»åœ¨ IDEA ä¸­è¿è¡Œäº†ï¼Œåœ¨å¯åŠ¨ä¹‹å‰è¿˜éœ€è¦é…ç½®ä¸€ä¸‹ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹ä¸ºè‡ªå·±çš„ç›®å½•</span></span><br><span class="line"><span class="built_in">export</span> PID_DIR=/Users/smith/Code/starrocks/fe/bin</span><br><span class="line"><span class="built_in">export</span> STARROCKS_HOME=/Users/smith/Code/starrocks/fe</span><br><span class="line"><span class="built_in">export</span> LOG_DIR=/Users/smith/Code/starrocks/fe/log</span><br></pre></td></tr></table></figure><p>åŒæ—¶éœ€è¦é…ç½®ä¸‹ <code>fe.conf</code> ä¸­çš„ <code>priority_networks</code> ç½‘ç»œé…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">priority_networks = 10.10.10.0/24</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª IP å¾—æ˜¯<strong>å®¿ä¸»æœºçš„ IP</strong>ï¼Œåç»­æˆ‘ä»¬ä½¿ç”¨ docker å¯åŠ¨ BE çš„æ—¶å€™ä¹Ÿéœ€è¦ç”¨åˆ°ã€‚</p><p><img src="https://s2.loli.net/2024/09/16/Lgrl4YSaD1GdzIZ.png"></p><p>å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œå¯ä»¥åœ¨æ—¥å¿—ç›®å½•ä¸‹æŸ¥çœ‹æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2024-09-16 21:21:59.942+08:00 ERROR (main|1) [NodeMgr.getCheckedSelfHostPort():642] edit_log_port 9010 is already in use. will exit.</span><br></pre></td></tr></table></figure><p>ç¢°åˆ°è¿™ä¸ªå¼‚å¸¸ï¼šæç¤ºç«¯å£è¢«å ç”¨ï¼Œé‚£å¯ä»¥å°è¯•å…³é—­ä»£ç†ä¹‹åå†è¯•è¯•ã€‚</p><p>å¯åŠ¨æˆåŠŸåæˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨ <code>MySQL</code> å…¼å®¹çš„å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥äº†ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ <code>tableplus</code>:<br><img src="https://s2.loli.net/2024/09/16/8XMI1DdjGkOKVPy.png"></p><p>ç„¶åæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ sql  å¯ä»¥æŸ¥è¯¢ fe çš„èŠ‚ç‚¹çŠ¶æ€ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> PROC <span class="string">&#x27;/frontends&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/09/16/Jg5TIMtpKoknq4Z.png"></p><p>çœ‹åˆ°ç±»ä¼¼çš„è¾“å‡ºåˆ™ä»£è¡¨å¯åŠ¨æˆåŠŸäº†ã€‚</p><h3 id="å¯åŠ¨-BE"><a href="#å¯åŠ¨-BE" class="headerlink" title="å¯åŠ¨ BE"></a>å¯åŠ¨ BE</h3><p>ä¹‹åæˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨ Docker æ¥å¯åŠ¨ BE äº†ï¼Œä¹‹æ‰€ä»¥ç”¨ docker å¯åŠ¨ï¼Œæ˜¯å› ä¸º BE æ˜¯ C++ ç¼–å†™çš„ï¼Œæƒ³è¦åœ¨ Mac ä¸Šè¿è¡Œæ¯”è¾ƒéº»çƒ¦ï¼Œæœ€å¥½æ˜¯å¾—æœ‰ä¸€å° <code>Ubuntu22</code> çš„è™šæ‹Ÿæœºã€‚</p><p>å¦‚æœæˆ‘ä»¬ä¸éœ€è¦è°ƒè¯• BE çš„è¯ï¼Œåªä½¿ç”¨ docker å¯åŠ¨æ˜¯å†åˆé€‚ä¸è¿‡äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 9060:9060 -p 8040:8040 -p 9050:9050 -p 8060:8060 -p 9070:9070 -itd --<span class="built_in">rm</span> --name be -e <span class="string">&quot;TZ=Asia/Shanghai&quot;</span> starrocks/be-ubuntu</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦å°† FE éœ€è¦è¿æ¥ BE çš„ç«¯å£æš´éœ²å‡ºæ¥ï¼Œå¯åŠ¨æˆåŠŸåè¯¥é•œåƒå¹¶ä¸ä¼šç›´æ¥å¯åŠ¨ BEï¼Œæˆ‘ä»¬éœ€è¦è¿›å…¥å®¹å™¨æ‰‹åŠ¨å¯åŠ¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it be bash</span><br></pre></td></tr></table></figure><p>åœ¨å¯åŠ¨ä¹‹å‰æˆ‘ä»¬ä¾ç„¶éœ€è¦ä¿®æ”¹ä¸‹ be.conf ä¸­çš„ <code>priority_networks</code> é…ç½®ï¼š</p><p><img src="https://s2.loli.net/2024/09/16/mcFCo24Kyxui8gt.png"><br>ä¿®æ”¹ä¸ºå’Œ fe.conf ä¸­ç›¸åŒçš„é…ç½®ã€‚</p><p>ä¹‹åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ be:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/start_be.sh --daemon</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æ—¥å¿—æˆ‘ä»¬å¯ä»¥åœ¨ logs ç›®å½•ä¸­æŸ¥çœ‹ã€‚</p><h3 id="ç»‘å®š-FE-å’Œ-BE"><a href="#ç»‘å®š-FE-å’Œ-BE" class="headerlink" title="ç»‘å®š FE å’Œ BE"></a>ç»‘å®š FE å’Œ BE</h3><p>æ¥ä¸‹æ¥è¿˜æœ‰æœ€åä¸€æ­¥å°±æ˜¯å°† FE å’Œ BE ç»‘å®šåœ¨ä¸€èµ·ã€‚</p><p>æˆ‘ä»¬åœ¨ fe ä¸­æ‰§è¡Œä»¥ä¸‹ sqlï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">ADD</span> BACKEND &quot;127.0.0.1:9050&quot;;</span><br></pre></td></tr></table></figure><p>æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹‹åå†ä½¿ç”¨ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> PROC <span class="string">&#x27;/backends&#x27;</span>;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æŸ¥è¯¢åˆ° BE çš„èŠ‚ç‚¹çŠ¶æ€ï¼š</p><p><img src="https://s2.loli.net/2024/09/16/YMCXQDoch3NlA1L.png"></p><p>å¦‚æœå‡ºç°ä»¥ä¸‹ç»“æœä»£è¡¨è¿æ¥æˆåŠŸï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºæ•°æ®åº“å’Œè¡¨äº†ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™éƒ¨åˆ†å†…å®¹ï¼ˆæœ¬åœ° FE è”ç»“ docker é‡Œçš„ FEï¼‰å®˜æ–¹æ–‡æ¡£å¹¶æ²¡æœ‰æåŠï¼Œä¹Ÿæ˜¯æˆ‘è¸©äº†ä¸å°‘å‘ã€åŒæ—¶è¿˜å’¨è¯¢äº†ä¸€äº›å¤§ä½¬æ‰å…¨éƒ¨è°ƒè¯•æˆåŠŸã€‚</p><p>è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„äº‹ï¼šå¦‚æœæˆ‘ä»¬ç½‘ç»œç¯å¢ƒå‘ç”Ÿäº†å˜åŒ–ï¼Œæ¯”å¦‚ä»å®¶é‡Œçš„ Wi-Fi åˆ‡æ¢åˆ°äº†å…¬å¸çš„ï¼Œéœ€è¦æ‰‹åŠ¨åˆ é™¤ä¸‹ <code>FE/meta</code> ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å†æ¬¡å¯åŠ¨ï¼ŒBE åˆ™æ˜¯éœ€è¦é‡å¯ä¸€ä¸‹å®¹å™¨ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://docs.starrocks.io/zh/docs/developers/development-environment/IDEA/">https://docs.starrocks.io/zh/docs/developers/development-environment/IDEA/</a></li><li><a href="https://docs.starrocks.io/zh/docs/deployment/deploy_manually/#%E7%AC%AC%E5%9B%9B%E6%AD%A5%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4">https://docs.starrocks.io/zh/docs/deployment/deploy_manually/#%E7%AC%AC%E5%9B%9B%E6%AD%A5%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;æœ€è¿‘è¿™æ®µæ—¶é—´åœ¨å¤„ç†ä¸€ä¸ª &lt;code&gt;StarRocks&lt;/code&gt; çš„å…³äºç‰©åŒ–è§†å›¾ä¼˜åŒ–çš„ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨æ­¤ä¹‹å‰å…¶å®æˆ‘ä¹Ÿæ²¡æœ‰æ¥è§¦è¿‡ &lt;code&gt;StarRocks&lt;/code&gt; è¿™ç±»ä¸»è¦å¤„ç†æ•°æ®åˆ†æçš„æ•°æ®åº“ï¼Œå°±æ›´åˆ«æåœ¨è¿™ä¸Šé¢åšä¼˜åŒ–äº†ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨è§£å†³é—®é¢˜ä¹‹å‰æˆ‘å…ˆèŠ±äº†ä¸€ä¸¤å¤©æ—¶é—´ç†Ÿæ‚‰äº†ä¸€ä¸‹ &lt;code&gt;StarRocks&lt;/code&gt; çš„ä¸€äº›æ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ï¼Œç„¶ååˆèŠ±äº†ä¸€äº›æ—¶é—´æ­å»ºç¯å¢ƒç„¶åå¤ç°äº†è¯¥é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;ä¹‹åä¾¿å¼€å§‹é˜…è¯»æºç ï¼Œå¤§æ¦‚çŸ¥é“äº†ç›¸å…³ä»£ç çš„æ‰§è¡Œæµç¨‹ï¼Œä½†å³ä¾¿æ˜¯åå¤é˜…è¯»äº†å¤šæ¬¡ä»£ç ä¹Ÿæ²¡æœ‰æ‰¾åˆ°å…·ä½“å‡ºç°é—®é¢˜çš„åœ°æ–¹ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ä¾¿è€ƒè™‘åœ¨æœ¬åœ° Debug æºç ï¼Œæœ€ç»ˆè°ƒè¯•åŠå¤©ä¹‹åçŸ¥é“äº†é—®é¢˜æ‰€ä»¥ï¼Œä¹Ÿåšäº†ç›¸å…³ä¿®æ”¹ï¼Œç»™ç¤¾åŒºæäº¤äº† PRï¼Œç›®å‰è¿˜åœ¨æ¨è¿›è¿‡ç¨‹ä¸­ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="StarRocks" scheme="http://crossoverjie.top/categories/StarRocks/"/>
    
    
    <category term="StarRocks" scheme="http://crossoverjie.top/tags/StarRocks/"/>
    
  </entry>
  
  <entry>
    <title>ğŸ¤³å¦‚ä½•ä¸ºå¤æ‚çš„ Java åº”ç”¨ç¼–å†™é›†æˆæµ‹è¯•</title>
    <link href="http://crossoverjie.top/2024/09/29/ob/%F0%9F%A4%B3cim-support-integration-test/"/>
    <id>http://crossoverjie.top/2024/09/29/ob/%F0%9F%A4%B3cim-support-integration-test/</id>
    <published>2024-09-29T11:16:06.000Z</published>
    <updated>2024-09-29T01:37:17.532Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æœ‰æ—¶é—´åˆæŠŠä»¥å‰å¼€æºçš„ <a href="https://github.com/crossoverJie/cim">IM æ¶ˆæ¯ç³»ç»Ÿ</a>æ¡èµ·æ¥ç»§ç»­å¼€å‘äº†ï¼ˆç¡®å®è¿™äº›å¹´ç»å¸¸æœ‰æœ‹å‹å‚¬æ›´ï¼‰ã€‚</p><blockquote><p>æ²¡é”™ï¼Œç¡®å®æ˜¯è¿™äº›å¹´ï¼Œå› ä¸ºä¸Šæ¬¡å‘ç‰ˆè¿˜æ˜¯å† 2019 å¹´çš„å…«æœˆä»½ã€‚</p></blockquote><p>è¿™æ®µæ—¶é—´æ¯”è¾ƒé‡å¤§çš„æ›´æ–°å°±æ˜¯æŠŠ<a href="https://github.com/crossoverJie/cim/pull/140">å…ƒæ•°æ®ä¸­å¿ƒ</a>æŠ½ç¦»å‡ºæ¥äº†ï¼Œä»¥å‰æ˜¯å’Œ zookeeper çš„ä»£ç å¼ºè€¦åˆåœ¨ä¸€èµ·çš„ï¼Œé‡æ„ä¹‹åå¯ä»¥æœ‰å¤šç§å®ç°äº†ã€‚</p><span id="more"></span><p>ä»Šåç”šè‡³å¯ä»¥æä¾›ä¸€ä¸ª jar åŒ…å°±å¯ä»¥æŠŠåç«¯æœåŠ¡å…¨éƒ¨å¯åŠ¨èµ·æ¥ç”¨äºä½“éªŒï¼Œæ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç®€å•çš„åŸºäºå†…å­˜çš„æ³¨å†Œä¸­å¿ƒã€‚</p><p>é™¤æ­¤ä¹‹å¤–åšçš„æ›´å¤šçš„å°±æ˜¯æ–°å¢äº†ä¸€ä¸ªé›†æˆæµ‹è¯•çš„æ¨¡å—ï¼Œæ²¡æœ‰å®Œå–„çš„é›†æˆæµ‹è¯•åŠŸèƒ½åœ¨åˆå¹¶ä»£ç çš„æ—¶å€™éƒ½è¦å°å¿ƒç¿¼ç¿¼ï¼ŒåŸºæœ¬çš„åŠŸèƒ½éœ€æ±‚éƒ½æ²¡æ³•ä¿è¯ã€‚</p><p>åŠ ä¸Šè¿™å‡ å¹´æˆ‘ä¹Ÿæ¥è§¦äº†ä¸å°‘ä¼˜ç§€çš„å¼€æºé¡¹ç›®ï¼ˆæ¯”å¦‚ Pulsarã€OpenTelemetryã€HertzBeat ç­‰ï¼‰ï¼Œä»–ä»¬éƒ½æœ‰å®Œæ•´çš„ä»£ç åˆå¹¶æµç¨‹ï¼›é¦–å…ˆç¬¬ä¸€ç‚¹å°±å¾—æŠŠæµ‹è¯•æµæ°´çº¿è·‘é€šè¿‡ã€‚</p><p>è¿™ä¸€ç‚¹åœ¨ OpenTelemetry ç¤¾åŒºæ›´ä¸ºä¸¥æ ¼ï¼š</p><p><img src="https://s2.loli.net/2024/09/04/wlaPtbJNux5vc9n.png"></p><blockquote><p>ä»–ä»¬çš„æ„å»ºæµ‹è¯•æµç¨‹éå¸¸å¤šï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ä»£ç é£æ ¼ã€å¤šç‰ˆæœ¬å…¼å®¹ç­‰ã€‚</p></blockquote><p>æ‰€ä»¥åœ¨ç»“åˆäº†è¿™äº›ä¼˜ç§€é¡¹ç›®çš„ç»éªŒåæˆ‘ä¹Ÿä¸º cim é¡¹ç›®æ–°å¢ç›¸å…³çš„æ¨¡å— <a href="https://github.com/crossoverJie/cim/pull/144">cim-integration-test</a>ï¼ŒåŒæ—¶ä¹Ÿåœ¨ github ä¸Šé…ç½®äº†ç›¸å…³çš„ actionï¼Œæœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2024/09/04/p9tLcvPTlMBIVq4.png"><br><img src="https://s2.loli.net/2024/09/04/Rxw5F8kNWT1pDO7.png"></p><p>åœ¨ <code>â€œBuild with Mavenâ€</code> é˜¶æ®µè§¦å‘å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼Œæœ€ç»ˆä¼šæŠŠæµ‹è¯•ç»“æœä¸Šä¼ åˆ° Codecovï¼Œç„¶åä¼šåœ¨ PR çš„è¯„è®ºåŒºè¾“å‡ºæµ‹è¯•æŠ¥å‘Šã€‚<br><img src="https://s2.loli.net/2024/09/04/zmPHB16ryCtGoEM.png"></p><p>ç›¸å…³çš„ action é…ç½®å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2024/09/05/mteK1Yj43Z7gIrR.png"></p><p>å°±æ˜¯é…ç½®äº†å‡ ä¸ª Jobï¼Œé‡ç‚¹æ˜¯è¿™é‡Œçš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn -B package --file pom.xml</span><br></pre></td></tr></table></figure><p>å®ƒä¼šç¼–è¯‘å¹¶è¿è¡Œé¡¹ç›®ä¸‹é¢çš„æ‰€æœ‰ test ä»£ç ã€‚</p><h1 id="cim-integration-test-æ¨¡å—"><a href="#cim-integration-test-æ¨¡å—" class="headerlink" title="cim-integration-test æ¨¡å—"></a>cim-integration-test æ¨¡å—</h1><p>ä¸ºäº†æ–¹ä¾¿è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œæˆ‘æ–°å¢äº† <code>cim-integration-test</code> è¿™ä¸ªæ¨¡å—ï¼Œè¿™é‡Œé¢æ²¡æœ‰ä»»ä½•æºç ï¼Œåªæœ‰æµ‹è¯•ç›¸å…³çš„ä»£ç ã€‚</p><p><img src="https://s2.loli.net/2024/09/05/RfK8FVrL916D7cI.png"></p><p>ç±»çš„ç»§æ‰¿å…³ç³»å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2024/09/05/75U9vbkPZOgqrRx.png"></p><p>å› ä¸ºæˆ‘ä»¬åšé›†æˆæµ‹è¯•éœ€è¦æŠŠ cim æ‰€ä¾èµ–çš„æœåŠ¡éƒ½å¯åŠ¨èµ·æ¥ï¼Œç›®å‰ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæœåŠ¡ï¼š</p><ul><li>cim-server: cim çš„æœåŠ¡ç«¯</li><li>cim-route: è·¯ç”±æœåŠ¡</li><li>cim-client: å®¢æˆ·ç«¯</li></ul><p>è€Œ route æœåŠ¡æ˜¯ä¾èµ–äº server æœåŠ¡ï¼Œæ‰€ä»¥ route ç»§æ‰¿äº† serverï¼Œclient åˆ™æ˜¯éœ€è¦ route å’Œ server éƒ½å¯åŠ¨ï¼Œæ‰€ä»¥å®ƒéœ€è¦ç»§æ‰¿ routeã€‚</p><h2 id="é›†æˆ-test-container"><a href="#é›†æˆ-test-container" class="headerlink" title="é›†æˆ test container"></a>é›†æˆ test container</h2><p>å…ˆæ¥çœ‹çœ‹ server çš„æµ‹è¯•å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractServerBaseTest</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">DockerImageName</span> <span class="variable">DEFAULT_IMAGE_NAME</span> <span class="operator">=</span> DockerImageName  </span><br><span class="line">            .parse(<span class="string">&quot;zookeeper&quot;</span>)  </span><br><span class="line">            .withTag(<span class="string">&quot;3.9.2&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">DEFAULT_STARTUP_TIMEOUT</span> <span class="operator">=</span> Duration.ofSeconds(<span class="number">60</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Container</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">ZooKeeperContainer</span>  </span><br><span class="line">            <span class="variable">zooKeeperContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZooKeeperContainer</span>(DEFAULT_IMAGE_NAME, DEFAULT_STARTUP_TIMEOUT);  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Getter</span>  </span><br><span class="line">    <span class="keyword">private</span> String zookeeperAddr;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startServer</span><span class="params">()</span> &#123;  </span><br><span class="line">        zooKeeperContainer.start();  </span><br><span class="line">        zookeeperAddr = String.format(<span class="string">&quot;%s:%d&quot;</span>, zooKeeperContainer.getHost(), zooKeeperContainer.getMappedPort(ZooKeeperContainer.DEFAULT_CLIENT_PORT));  </span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(CIMServerApplication.class);  </span><br><span class="line">        server.run(<span class="string">&quot;--app.zk.addr=&quot;</span> + zookeeperAddr);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸º <code>server</code> æ˜¯éœ€è¦ä¾èµ– <code>zookeeper</code> ä½œä¸ºå…ƒæ•°æ®ä¸­å¿ƒï¼Œæ‰€ä»¥åœ¨å¯åŠ¨ä¹‹å‰éœ€è¦å…ˆæŠŠ zookeeper å¯åŠ¨èµ·æ¥ã€‚</p><p>æ­¤æ—¶å°±éœ€è¦ä½¿ç”¨ <a href="https://testcontainers.com/">testcontainer</a> æ¥åšæ”¯æŒäº†ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨å•æµ‹çš„è¿‡ç¨‹ä¸­ä½¿ç”¨ docker å¯åŠ¨ä»»æ„ä¸€ä¸ªæœåŠ¡ï¼Œè¿™æ ·åœ¨ CI ä¸­åšé›†æˆæµ‹è¯•å°±å¾ˆç®€å•äº†ã€‚</p><p><img src="https://s2.loli.net/2024/09/06/X3vzp5qd7tbAIHB.png"></p><p>æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„å¤§éƒ¨åˆ†ä¸­é—´ä»¶éƒ½æ˜¯æ”¯æŒçš„ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•ã€‚</p><p>å…ˆæ·»åŠ ç›¸å…³çš„ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>42.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.10.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨é€‰æ‹©æˆ‘ä»¬éœ€è¦ä¾èµ–çš„æœåŠ¡ï¼Œæ¯”å¦‚æ˜¯ <code>PostgreSQL</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.testcontainers<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.19.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨æµ‹è¯•ä»£ç ä¸­å¯åŠ¨ç›¸å…³çš„æœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CustomerServiceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> PostgreSQLContainer&lt;?&gt; postgres = <span class="keyword">new</span> <span class="title class_">PostgreSQLContainer</span>&lt;&gt;(</span><br><span class="line">    <span class="string">&quot;postgres:16-alpine&quot;</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  CustomerService customerService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@BeforeAll</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">beforeAll</span><span class="params">()</span> &#123;</span><br><span class="line">    postgres.start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@AfterAll</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">afterAll</span><span class="params">()</span> &#123;</span><br><span class="line">    postgres.stop();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@BeforeEach</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DBConnectionProvider</span> <span class="variable">connectionProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DBConnectionProvider</span>(</span><br><span class="line">      postgres.getJdbcUrl(),</span><br><span class="line">      postgres.getUsername(),</span><br><span class="line">      postgres.getPassword()</span><br><span class="line">    );</span><br><span class="line">    customerService = <span class="keyword">new</span> <span class="title class_">CustomerService</span>(connectionProvider);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯éœ€è¦è·å–è¿™äº›ä¸­é—´ä»¶çš„é“¾æ¥ï¼Œæ¯”å¦‚ IP ç«¯å£å•¥çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.testcontainers.containers.ContainerState#getHost</span><br><span class="line">org.testcontainers.containers.ContainerState#getMappedPort</span><br></pre></td></tr></table></figure><p>é€šå¸¸æ˜¯é€šè¿‡è¿™ä¸¤ä¸ªå‡½æ•°æ¥è·å–å¯¹åº”çš„ IP å’Œç«¯å£ã€‚</p><h1 id="é›†æˆ"><a href="#é›†æˆ" class="headerlink" title="é›†æˆ"></a>é›†æˆ</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Container</span>  </span><br><span class="line"><span class="type">RedisContainer</span> <span class="variable">redis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisContainer</span>(DockerImageName.parse(<span class="string">&quot;redis:7.4.0&quot;</span>));  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startRoute</span><span class="params">()</span> &#123;  </span><br><span class="line">    redis.start();  </span><br><span class="line">    <span class="type">SpringApplication</span> <span class="variable">route</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(RouteApplication.class);  </span><br><span class="line">    String[] args = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;  </span><br><span class="line">            <span class="string">&quot;--spring.data.redis.host=&quot;</span> + redis.getHost(),  </span><br><span class="line">            <span class="string">&quot;--spring.data.redis.port=&quot;</span> + redis.getMappedPort(<span class="number">6379</span>),  </span><br><span class="line">            <span class="string">&quot;--app.zk.addr=&quot;</span> + <span class="built_in">super</span>.getZookeeperAddr(),  </span><br><span class="line">    &#125;;    </span><br><span class="line">    route.setAdditionalProfiles(<span class="string">&quot;route&quot;</span>);  </span><br><span class="line">    route.run(args);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº route æ¥è¯´ä¸ä½†éœ€è¦ <code>zookeeper</code> è¿˜éœ€è¦ <code>Redis</code> æ¥å­˜æ”¾ç”¨æˆ·çš„è·¯ç”±å…³ç³»ï¼Œæ­¤æ—¶å°±è¿˜éœ€è¦è¿è¡Œä¸€ä¸ª Redis çš„å®¹å™¨ï¼Œä½¿ç”¨æ–¹æ³•åŒç†ã€‚</p><p>æœ€åå°±éœ€è¦ä»¥ <code>springboot</code> çš„æ–¹å¼å°†è¿™ä¸¤ä¸ªåº”ç”¨å¯åŠ¨èµ·æ¥ï¼Œæˆ‘ä»¬ç›´æ¥åˆ›å»ºä¸€ä¸ª <code>SpringApplication</code> å¯¹è±¡ï¼Œç„¶åå°†éœ€è¦ä¿®æ”¹çš„å‚æ•°é€šè¿‡ <code>--varname=value</code> çš„å½¢å¼å°†æ•°æ®ä¼ é€’è¿›å»ã€‚</p><p>è¿˜å¯ä»¥é€šè¿‡ <code>setAdditionalProfiles()</code> å‡½æ•°æŒ‡å®šå½“å‰åº”ç”¨è¿è¡Œçš„ profileï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨æµ‹è¯•ç›®å½•ä½¿ç”¨å¯¹åº”çš„é…ç½®æ–‡ä»¶äº†ã€‚</p><p><img src="https://s2.loli.net/2024/09/06/ySK2akYOIAPJqUH.png" alt="image.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route.setAdditionalProfiles(<span class="string">&quot;route&quot;</span>);  </span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘ä»¬è¿™é‡Œè®¾ç½®ä¸º route å°±å¯ä»¥ä½¿ç”¨ <code>application-route.yaml</code> ä½œä¸º route çš„é…ç½®æ–‡ä»¶å¯åŠ¨ï¼Œå°±ä¸ç”¨æ¯ä¸ªå‚æ•°éƒ½é€šè¿‡ <code>--</code> ä¼ é€’äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(String userName, <span class="type">int</span> port)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="built_in">super</span>.registerAccount(userName);  </span><br><span class="line">    <span class="type">SpringApplication</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(CIMClientApplication.class);  </span><br><span class="line">    client.setAdditionalProfiles(<span class="string">&quot;client&quot;</span>);  </span><br><span class="line">    String[] args = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;  </span><br><span class="line">            <span class="string">&quot;--server.port=&quot;</span> + port,  </span><br><span class="line">            <span class="string">&quot;--cim.user.id=&quot;</span> + userId,  </span><br><span class="line">            <span class="string">&quot;--cim.user.userName=&quot;</span> + userName  </span><br><span class="line">    &#125;;  </span><br><span class="line">    client.run(args);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Test</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">olu</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">    <span class="built_in">super</span>.startServer();  </span><br><span class="line">    <span class="built_in">super</span>.startRoute();  </span><br><span class="line">    <span class="built_in">this</span>.login(<span class="string">&quot;crossoverJie&quot;</span>, <span class="number">8082</span>);  </span><br><span class="line">    <span class="built_in">this</span>.login(<span class="string">&quot;cj&quot;</span>, <span class="number">8182</span>);  </span><br><span class="line">    <span class="type">MsgHandle</span> <span class="variable">msgHandle</span> <span class="operator">=</span> SpringBeanFactory.getBean(MsgHandle.class);  </span><br><span class="line">    msgHandle.innerCommand(<span class="string">&quot;:olu&quot;</span>);  </span><br><span class="line">    msgHandle.sendMsg(<span class="string">&quot;hello&quot;</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœŸæ­£è¦æµ‹è¯•çš„å…¶å®æ˜¯å®¢æˆ·ç«¯çš„åŠŸèƒ½ï¼Œåªè¦å®¢æˆ·ç«¯åŠŸèƒ½æ­£å¸¸ï¼Œè¯´æ˜ server å’Œ route ä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚</p><p>æ¯”å¦‚è¿™é‡Œçš„ <code>olu(oline user)</code> çš„æµ‹è¯•æµç¨‹æ˜¯ï¼š</p><ul><li>å¯åŠ¨ server å’Œ route</li><li>ç™»å½•æ³¨å†Œä¸¤ä¸ªè´¦å·</li><li>æŸ¥è¯¢å‡ºæ‰€æœ‰ç”¨æˆ·</li><li>å‘é€æ¶ˆæ¯</li></ul><p>æœ€ç»ˆçš„æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼Œç¬¦åˆé¢„æœŸã€‚</p><p><img src="https://s2.loli.net/2024/09/06/uX7BrNwC8iOHqSQ.png" alt="image.png"></p><h1 id="ç¢°åˆ°çš„é—®é¢˜"><a href="#ç¢°åˆ°çš„é—®é¢˜" class="headerlink" title="ç¢°åˆ°çš„é—®é¢˜"></a>ç¢°åˆ°çš„é—®é¢˜</h1><h2 id="åº”ç”¨åˆ†å±‚"><a href="#åº”ç”¨åˆ†å±‚" class="headerlink" title="åº”ç”¨åˆ†å±‚"></a>åº”ç”¨åˆ†å±‚</h2><p>ä¸çŸ¥é“å¤§å®¶æ³¨æ„åˆ°åˆšæ‰æµ‹è¯•ä»£ç å­˜åœ¨çš„é—®é¢˜æ²¡æœ‰ï¼Œä¸»è¦å°±æ˜¯æ²¡æ³•æ–­è¨€ã€‚</p><p>å› ä¸ºå®¢æˆ·ç«¯ã€routeã€server éƒ½æ˜¯ä»¥ä¸€ä¸ªåº”ç”¨çš„ç»´åº¦å»è¿è¡Œçš„ï¼Œæ²¡æ³•è·å–åˆ°ä¸€äº›å…³é”®æŒ‡æ ‡ã€‚</p><p>æ¯”å¦‚è¾“å‡ºåœ¨çº¿ç”¨æˆ·ï¼Œå½“å®¢æˆ·ç«¯ä½œä¸ºä¸€ä¸ªåº”ç”¨æ—¶ï¼Œåœ¨çº¿ç”¨æˆ·å°±æ˜¯ç›´æ¥æ‰“å°åœ¨äº†ç»ˆç«¯ï¼Œè€Œæ²¡æœ‰ç›´æ¥æš´éœ²ä¸€ä¸ªæ¥å£è¿”å›åœ¨çº¿æ•°æ®ï¼›æ”¶å‘æ¶ˆæ¯ä¹Ÿæ˜¯åŒç†ã€‚</p><p>å…¶å®åœ¨åº”ç”¨å†…éƒ¨è¿™äº›éƒ½æ˜¯æœ‰æ¥å£çš„ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“çš„ <code>springboot</code> åº”ç”¨å°±æ²¡æœ‰æä¾›è¿™äº›èƒ½åŠ›äº†ã€‚</p><p>æœ¬è´¨ä¸Šçš„é—®é¢˜å°±æ˜¯è¿™é‡Œåº”è¯¥æœ‰ä¸€ä¸ª client-sdk çš„æ¨¡å—ï¼Œclient ä¹Ÿæ˜¯åŸºäºè¿™ä¸ª sdk å®ç°çš„ï¼Œè¿™æ ·å°±å¯ä»¥æ›´å¥½çš„æµ‹è¯•ç›¸å…³çš„åŠŸèƒ½äº†ã€‚</p><p>ä¹‹åå°±å‡†å¤‡æŠŠ sdk å•ç‹¬æŠ½ç¦»ä¸€ä¸ªæ¨¡å—ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿åŸºäºè¿™ä¸ª sdk å®ç°ä¸åŒçš„äº¤äº’ï¼Œç”šè‡³åšä¸€ä¸ª UI ç•Œé¢éƒ½æ˜¯å¯ä»¥çš„ã€‚</p><h2 id="ç¼–è¯‘å¤±è´¥"><a href="#ç¼–è¯‘å¤±è´¥" class="headerlink" title="ç¼–è¯‘å¤±è´¥"></a>ç¼–è¯‘å¤±è´¥</h2><p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯æˆ‘æ˜¯ç›´æ¥å°† <code>client/route/server</code> çš„ä¾èµ–é›†æˆåˆ° <code>integration-test</code> æ¨¡å—ä¸­ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.crossoverjie.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cim-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.crossoverjie.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cim-forward-route<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.crossoverjie.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cim-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨ IDEA é‡Œç›´æ¥ç‚¹å‡»æµ‹è¯•æŒ‰é’®æ˜¯å¯ä»¥ç›´æ¥è¿è¡Œè¿™é‡Œçš„æµ‹è¯•ç”¨ä¾‹çš„ï¼Œä½†æ˜¯æƒ³é€šè¿‡ <code>mvn test</code> æ—¶å°±é‡åˆ°äº†é—®é¢˜ã€‚</p><p><img src="https://s2.loli.net/2024/09/06/DFy6otpPvjar4JM.png" alt="image.png"></p><p>ä¼šåœ¨ç¼–è¯‘æœŸé—´å°±æ˜¯å¤±è´¥äº†ï¼Œæˆ‘æ’æŸ¥äº†å¾ˆä¹…æœ€ç»ˆå‘ç°æ˜¯å› ä¸ºè¿™ä¸‰ä¸ªæ¨¡å—åº”ç”¨ä½¿ç”¨äº†springboot çš„æ„å»ºæ’ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™å‡ ä¸ªæ¨¡å—æœ€ç»ˆä¼šè¢«æ‰“åŒ…æˆä¸€ä¸ª springboot çš„ jar åŒ…ï¼Œä»è€Œå¯¼è‡´ integration-test åœ¨ç¼–è¯‘æ—¶æ— æ³•åŠ è½½è¿›æ¥ä»è€Œä½¿ç”¨é‡Œé¢çš„ç±»ã€‚</p><p>æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°å¥½çš„è§£å†³åŠæ³•ï¼Œæˆ‘å°±åªæœ‰æŠŠè¿™å‡ ä¸ªæ’ä»¶å…ˆå»æ‰ï¼Œéœ€è¦æ‰“åŒ…æ—¶å†æ‰‹åŠ¨æŒ‡å®šæ’ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package spring-boot:repackage -DskipTests=true</span><br></pre></td></tr></table></figure><p>å…¶å®è¿™é‡Œçš„æœ¬è´¨é—®é¢˜ä¹Ÿæ˜¯æ²¡æœ‰åˆ†å±‚çš„ç»“æœï¼Œæœ€å¥½è¿˜æ˜¯ä¾èµ– <code>route</code> å’Œ <code>server</code> çš„ SDK è¿›è¡Œæµ‹è¯•ã€‚</p><p>ç°åœ¨å› ä¸ºæœ‰äº†æµ‹è¯•çš„ CI ä¹Ÿæ¬¢è¿å¤§å®¶æ¥åšè´¡çŒ®ï¼Œå¯ä»¥çœ‹çœ‹è¿™é‡Œçš„ <code>help want</code>ï¼Œæœ‰ä¸€äº›ç®€å•æ˜“ä¸Šæ‰‹å¯ä»¥å…ˆæèµ·æ¥ã€‚</p><p><img src="https://s2.loli.net/2024/09/06/kmgfrIxdhGXib9L.png"></p><p><a href="https://github.com/crossoverJie/cim/issues/135">https://github.com/crossoverJie/cim/issues/135</a></p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/crossoverJie/cim/pull/140">https://github.com/crossoverJie/cim/pull/140</a></li><li><a href="https://github.com/crossoverJie/cim/pull/144">https://github.com/crossoverJie/cim/pull/144</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘æœ‰æ—¶é—´åˆæŠŠä»¥å‰å¼€æºçš„ &lt;a href=&quot;https://github.com/crossoverJie/cim&quot;&gt;IM æ¶ˆæ¯ç³»ç»Ÿ&lt;/a&gt;æ¡èµ·æ¥ç»§ç»­å¼€å‘äº†ï¼ˆç¡®å®è¿™äº›å¹´ç»å¸¸æœ‰æœ‹å‹å‚¬æ›´ï¼‰ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æ²¡é”™ï¼Œç¡®å®æ˜¯è¿™äº›å¹´ï¼Œå› ä¸ºä¸Šæ¬¡å‘ç‰ˆè¿˜æ˜¯å† 2019 å¹´çš„å…«æœˆä»½ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™æ®µæ—¶é—´æ¯”è¾ƒé‡å¤§çš„æ›´æ–°å°±æ˜¯æŠŠ&lt;a href=&quot;https://github.com/crossoverJie/cim/pull/140&quot;&gt;å…ƒæ•°æ®ä¸­å¿ƒ&lt;/a&gt;æŠ½ç¦»å‡ºæ¥äº†ï¼Œä»¥å‰æ˜¯å’Œ zookeeper çš„ä»£ç å¼ºè€¦åˆåœ¨ä¸€èµ·çš„ï¼Œé‡æ„ä¹‹åå¯ä»¥æœ‰å¤šç§å®ç°äº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="cim" scheme="http://crossoverjie.top/categories/cim/"/>
    
    <category term="test" scheme="http://crossoverjie.top/categories/cim/test/"/>
    
    
    <category term="cim" scheme="http://crossoverjie.top/tags/cim/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetry å®æˆ˜ï¼šä» 0 åˆ° 1 ç¼–å†™ä¸€ä¸ª Instrumentation</title>
    <link href="http://crossoverjie.top/2024/09/26/ob/OpenTelemetry-create-instrumentation/"/>
    <id>http://crossoverjie.top/2024/09/26/ob/OpenTelemetry-create-instrumentation/</id>
    <published>2024-09-26T05:14:01.000Z</published>
    <updated>2024-09-26T13:39:32.089Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å› ä¸ºå…¬å¸å†…éƒ¨åœ¨ä½¿ç”¨ <a href="https://github.com/PowerJob/PowerJob">PowerJob</a> ä½œä¸ºæˆ‘ä»¬çš„åˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿï¼ŒåŒæ—¶åˆæ˜¯ä½¿ç”¨ OpenTelemetry ä½œä¸ºå¯è§‚æµ‹çš„åº•åº§ï¼Œä½†ç›®å‰ OpenTelemetry è¿˜æ²¡æœ‰å¯¹ PowerJob æä¾›æ”¯æŒï¼Œç›®å‰ç¤¾åŒºåªå¯¹åŒç±»å‹çš„ XXL-JOB æœ‰æ”¯æŒã€‚<br><img src="https://s2.loli.net/2024/08/26/qfdloarJ7iNzPXy.png"></p><p>æ°å¥½å…¬å¸å†…éƒ¨ä¹Ÿæœ‰ä¸€äº›å¼€å‘åŒå­¦æœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼š<br><img src="https://s2.loli.net/2024/08/26/6aIFxlEyKt7OfsC.png"></p><p>äºæ˜¯åœ¨è¿™ä¸ªèƒŒæ™¯ä¸‹æˆ‘ä¾¿å¼€å§‹ç€æ‰‹å¼€å‘ PowerJob çš„ instrumentationï¼Œæœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/08/26/r7xgSHKCftqvuXw.png"><br><img src="https://s2.loli.net/2024/08/26/KNnWPzm5rU9By3c.png"></p><span id="more"></span><p>ä»è¿™ä¸ªé“¾è·¯å›¾ä¸­å¯ä»¥çœ‹åˆ° grpc-consumer æä¾›äº†è°ƒåº¦çš„å…¥å£å‡½æ•°ï¼Œç„¶ååœ¨å†…éƒ¨å‘é€äº† Pulsar æ¶ˆæ¯ï¼Œæœ€ç»ˆåˆè°ƒç”¨äº† grpc-provider çš„ <code>gRPC</code> æ¥å£ã€‚</p><p>è¿™æ ·å°±å¯ä»¥æŠŠæ•´ä¸ªé“¾è·¯ä¸²èµ·æ¥ï¼ŒåŒæ—¶è¿˜èƒ½æŸ¥çœ‹ <code>PowerJob</code> è°ƒåº¦çš„ JobIdã€ä»¥åŠè°ƒç”¨å‚æ•°ç­‰æ•°æ®ï¼Œè¿™æ ·æ’æŸ¥é—®é¢˜æ—¶ä¹Ÿæ›´åŠ ç›´è§‚ã€‚</p><h1 id="å¼€å‘-Instrumentation-çš„å‰ç½®çŸ¥è¯†"><a href="#å¼€å‘-Instrumentation-çš„å‰ç½®çŸ¥è¯†" class="headerlink" title="å¼€å‘ Instrumentation çš„å‰ç½®çŸ¥è¯†"></a>å¼€å‘ Instrumentation çš„å‰ç½®çŸ¥è¯†</h1><p>åœ¨æ­£å¼å¼€å‘ Instrumentation ä¹‹å‰è¿˜éœ€è¦äº†è§£ä¸€äº›å‰ç½®çŸ¥è¯†ç‚¹ã€‚</p><p><img src="https://s2.loli.net/2024/08/26/K43Ix8LCkQWAao5.png"><br><img src="https://s2.loli.net/2024/08/26/29DQxfMgFViuHYa.png"></p><p>è¿™é‡Œæˆ‘ä»¬ä»¥ç°æœ‰çš„  <code>gRPC</code> å’Œæˆ‘ç¼–å†™çš„ PowerJob instrumentation ä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ° <code>gRPC</code> çš„ instrumentation ä¸­å¤šäº†ä¸€ä¸ª library çš„æ¨¡å—ã€‚</p><p>è¿™é‡Œå°±å¼•ç”³å‡ºäº†ä¸¤ç§åŸ‹ç‚¹æ–¹å¼ï¼š</p><ul><li><strong>Library instrumentation</strong></li><li><strong>Java agent instrumentation</strong></li></ul><p>é€šå¸¸æˆ‘ä»¬å¯¹ä¸€ä¸ªæ¡†æ¶æˆ–è€…ä¸€ä¸ªåº“è¿›è¡ŒåŸ‹ç‚¹æ—¶ï¼Œé¦–å…ˆéœ€è¦æ‰¾åˆ°å®ƒçš„åŸ‹ç‚¹å…¥å£ã€‚</p><p>ä»¥ <em><code>grpc</code></em> ä¸ºä¾‹ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦çœ‹ä»–æ˜¯å¦æœ‰æä¾›æ‰©å±•çš„ API å¯ä»¥ä¾›æˆ‘ä»¬åŸ‹ç‚¹ï¼Œæ°å¥½ grpc æ˜¯æœ‰æä¾›å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æ‹¦æˆªå™¨çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">io.grpc.ClientInterceptor</span><br><span class="line">io.grpc.ServerInterceptor</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¾¿å¯ä»¥åœ¨è¿™äº›æ‹¦æˆªä¸­åŠ å…¥åŸ‹ç‚¹é€»è¾‘ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯çš„åŸ‹ç‚¹ä»£ç å¦‚ä¸‹ <code>io.opentelemetry.instrumentation.grpc.v1_6.TracingClientInterceptor</code> ï¼š</p><p><img src="https://s2.loli.net/2024/08/26/FJgRjf1ACVlmG3D.png"></p><p>è¿™éƒ¨åˆ†ä»£ç ä¾¿æ˜¯å†™åœ¨ <code>grpc-1.6/library</code> æ¨¡å—ä¸‹çš„ã€‚</p><p>è¿™æ ·åšæœ‰ä¸€ä¸ªå¥½å¤„æ˜¯ï¼šå½“æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç ä¸æƒ³ä½¿ç”¨ <code>javaagent</code> æ—¶è¿˜å¯ä»¥æ‰‹åŠ¨å¼•å…¥ <code>grpc-1.6/library</code> åŒ…ï¼Œç„¶åä½¿ç”¨ <code>TracingClientInterceptor</code> æ‹¦æˆªå™¨ä¹Ÿå¯ä»¥å®ç° trace åŸ‹ç‚¹çš„åŠŸèƒ½ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(project(<span class="string">&quot;:instrumentation:grpc-1.6:library&quot;</span>))</span><br></pre></td></tr></table></figure><p>ä¹‹å <code>javaagent</code> è¿™ä¸ªæ¨¡å—ä¹Ÿä¼šå¼•å…¥ <code>library</code> ï¼Œç„¶åç›´æ¥ä½¿ç”¨å®ƒæä¾›çš„ API å®ç° agent çº§åˆ«çš„åŸ‹ç‚¹ã€‚</p><p>è€Œå¦‚æœä¸€äº›åº“æˆ–è€…ä¸­é—´ä»¶å¹¶æ²¡æœ‰æä¾›è¿™ç§æ‰©å±• API æ—¶ï¼Œæˆ‘ä»¬å°±åªèƒ½ä½¿ç”¨ agent çš„æ–¹å¼åœ¨å­—èŠ‚ç å±‚é¢ä¸Šè¿›è¡ŒåŸ‹ç‚¹ï¼Œè¿™æ ·å°±ä¸ä¼šé™åˆ¶æ¡†æ¶äº†ï¼Œç†è®ºä¸Šä»»ä½• Java ä»£ç éƒ½å¯ä»¥åŸ‹ç‚¹ã€‚</p><p>æ‰€ä»¥æ€»çš„æ¥è¯´ä¸€ä¸ªåº“å¯èƒ½ä¼šæ²¡æœ‰ library instrumentationï¼Œä½†ä¸€å®šä¼šæœ‰ agent instrumentationï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å½“å‰æ¡†æ¶çš„ä»£ç è¿›è¡Œé€‰æ‹©ã€‚</p><blockquote><p>è€Œè¿™é‡Œçš„ PowerJob å› ä¸ºå¹¶æ²¡æœ‰æä¾›æ‰©å±•æ¥å£ï¼Œæ‰€æœ‰åªæœ‰ agent çš„ instrumentationã€‚</p></blockquote><h1 id="æ‰¾åˆ°åŸ‹ç‚¹å…¥å£"><a href="#æ‰¾åˆ°åŸ‹ç‚¹å…¥å£" class="headerlink" title="æ‰¾åˆ°åŸ‹ç‚¹å…¥å£"></a>æ‰¾åˆ°åŸ‹ç‚¹å…¥å£</h1><p>åœ¨å¼€å§‹ç¼–ç ä¹‹å‰æˆ‘ä»¬éœ€è¦å¯¹è¦åŸ‹ç‚¹çš„åº“æˆ–è€…æ¡†æ¶æœ‰ä¸€ä¸ªæ¸…æ™°çš„ç†è§£ï¼Œè‡³å°‘å¾—çŸ¥é“å®ƒçš„æ ¸å¿ƒé€»è¾‘åœ¨å“ªé‡Œã€‚</p><p>ä»¥ PowerJob çš„è°ƒåº¦æ‰§è¡Œé€»è¾‘ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBasicProcessor</span> <span class="keyword">implements</span> <span class="title class_">BasicProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProcessResult <span class="title function_">process</span><span class="params">(TaskContext context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;======== BasicProcessor#process ========&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;TaskContext: &quot;</span> + JsonUtils.toJSONString(context) + <span class="string">&quot;;time = &quot;</span> + System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProcessResult</span>(<span class="literal">true</span>, System.currentTimeMillis() + <span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„è°ƒåº¦æ‰§è¡Œå™¨çš„å®ç°é€»è¾‘ã€‚</p></blockquote><p>ä»è¿™é‡Œçœ‹å‡ºï¼šå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨æ‰§è¡Œå™¨ä¸­åŸ‹ç‚¹ï¼Œé‚£æœ€æ ¸å¿ƒçš„å°±æ˜¯è¿™é‡Œçš„ process å‡½æ•°ã€‚</p><p>éœ€è¦åœ¨ process çš„æ‰§è¡Œå‰åæ‹¿åˆ° context æ•°æ®ï¼Œå†™å…¥åˆ° OpenTelemetry ä¸­çš„ span å³å¯ã€‚</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleCustomizedHandler</span> <span class="keyword">extends</span> <span class="title class_">IJobHandler</span> &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">execute</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReturnT</span>&lt;&gt;(<span class="string">&quot;Hello World&quot;</span>);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨ xxl-job ä¸­ï¼Œå®ƒçš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯è¿™é‡Œçš„ <code>execute</code> å‡½æ•°ã€‚</p><h1 id="é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬"><a href="#é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬" class="headerlink" title="é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬"></a>é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬</h1><p>æ‰¾åˆ°æ ¸å¿ƒçš„åŸ‹ç‚¹é€»è¾‘åè¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å·¥ä½œè¦åšï¼šé‚£å°±æ˜¯<strong>é€‰æ‹©ä½ éœ€è¦æ”¯æŒçš„ç‰ˆæœ¬</strong>ã€‚</p><p>é€‰æ‹©ç‰ˆæœ¬çš„åŸå› æ˜¯æœ‰å¯èƒ½æ¡†æ¶æˆ–åº“åœ¨ç‰ˆæœ¬è¿­ä»£è¿‡ç¨‹ä¸­æ ¸å¿ƒ API å‘ç”Ÿäº†å˜åŒ–ï¼Œæ¯”å¦‚ï¼š</p><ul><li>å‡½æ•°ç­¾åå‘ç”Ÿäº†æ”¹å˜</li><li>åŒ…åä¹Ÿå‘ç”Ÿäº†æ”¹å˜</li></ul><p>ä»¥ xxl-job ä¸ºä¾‹ï¼Œå®ƒåœ¨è¿­ä»£è¿‡ç¨‹ä¸­å°±å‘ç”Ÿäº†å‡ æ¬¡å‡½æ•°ç­¾åçš„ä¿®æ”¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸åŒçš„ç‰ˆæœ¬åšå…¼å®¹å¤„ç†ï¼š</p><p><img src="https://s2.loli.net/2024/08/26/yLhmXBKDzVaYjJ5.png"></p><p>è€Œæˆ‘è¿™é‡Œé€‰æ‹©æ”¯æŒ <code>PowerJob:4.0+</code> çš„ç‰ˆæœ¬ï¼Œå› ä¸ºç¤¾åŒºåœ¨ 4.0 ä¹‹ååšäº†å¤§é‡é‡æ„ï¼Œå¯¼è‡´ä¿®æ”¹äº†åŒ…åï¼ŒåŒæ—¶æ ¸å¿ƒé€»è¾‘çš„å‡½æ•°ç­¾åä¹Ÿæ²¡å‘ç”Ÿè¿‡å˜åŒ–ã€‚</p><p><img src="https://s2.loli.net/2024/08/26/MuRmI9e28pghzNH.png"></p><blockquote><p>4.0 ä¹‹å‰çš„ç‰ˆæœ¬æˆ‘å°±æ²¡åšå…¼å®¹äº†ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªè¡Œå®ç°ã€‚</p></blockquote><h1 id="é€»è¾‘å®ç°"><a href="#é€»è¾‘å®ç°" class="headerlink" title="é€»è¾‘å®ç°"></a>é€»è¾‘å®ç°</h1><p>é¦–å…ˆç¬¬ä¸€æ­¥éœ€è¦åˆ›å»ºä¸€ä¸ª <code>InstrumentationModule</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoService(InstrumentationModule.class)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PowerJobInstrumentationModule</span> <span class="keyword">extends</span> <span class="title class_">InstrumentationModule</span> &#123;  </span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">PowerJobInstrumentationModule</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="built_in">super</span>(<span class="string">&quot;powerjob&quot;</span>, <span class="string">&quot;powerjob-4.0&quot;</span>);  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> List&lt;TypeInstrumentation&gt; <span class="title function_">typeInstrumentations</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> asList(<span class="keyword">new</span> <span class="title class_">BasicProcessorInstrumentation</span>());  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/08/26/AxGWtdflEI5NmKn.png"></p><blockquote><p>è¿™é‡Œçš„ @AutoService æ³¨è§£ï¼Œä¼šåœ¨ä»£ç ç¼–è¯‘ä¹‹åç”Ÿæˆä¸€ä»½ SPI æ–‡ä»¶ã€‚</p></blockquote><p>ä¹‹åä¾¿æ˜¯å®ç°è¿™é‡Œæœ€æ ¸å¿ƒçš„ <code>BasicProcessorInstrumentation</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasicProcessorInstrumentation</span> <span class="keyword">implements</span> <span class="title class_">TypeInstrumentation</span> &#123;  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> ElementMatcher&lt;TypeDescription&gt; <span class="title function_">typeMatcher</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> implementsInterface(named(<span class="string">&quot;tech.powerjob.worker.core.processor.sdk.BasicProcessor&quot;</span>));  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(TypeTransformer transformer)</span> &#123;  </span><br><span class="line">    transformer.applyAdviceToMethod(  </span><br><span class="line">        named(<span class="string">&quot;process&quot;</span>).and(isPublic()).and(takesArguments(<span class="number">1</span>)),  </span><br><span class="line">        BasicProcessorInstrumentation.class.getName() + <span class="string">&quot;$ProcessAdvice&quot;</span>);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>ä»å®ƒçš„ä»£ç ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œä¸»è¦æ˜¯æŒ‡å®šæˆ‘ä»¬éœ€è¦å¯¹å“ªä¸ªæ–¹æ³•çš„å“ªä¸ªå‡½æ•°è¿›è¡ŒåŸ‹ç‚¹ï¼Œç„¶ååŸ‹ç‚¹ä¹‹åçš„å¤„ç†é€»è¾‘æ˜¯åœ¨å“ªä¸ªç±»(<code>ProcessAdvice</code>)ä¸­å®ç°çš„ã€‚</p><p>ä¹‹åä¾¿æ˜¯ <code>ProcessAdvice</code> çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ProcessAdvice</span> &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unused&quot;)</span>  </span><br><span class="line">  <span class="meta">@Advice</span>.OnMethodEnter(suppress = Throwable.class)  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">onSchedule</span><span class="params">(  </span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.This BasicProcessor handler,  </span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.Argument(<span class="number">0</span>)</span> TaskContext taskContext,  </span><br><span class="line">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelRequest&quot;</span>) PowerJobProcessRequest request,  </span><br><span class="line">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelContext&quot;</span>) Context context,  </span><br><span class="line">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelScope&quot;</span>) Scope scope) &#123;  </span><br><span class="line">    <span class="type">Context</span> <span class="variable">parentContext</span> <span class="operator">=</span> currentContext();  </span><br><span class="line">    request = PowerJobProcessRequest.createRequest(taskContext.getJobId(), handler, <span class="string">&quot;process&quot;</span>);  </span><br><span class="line">    request.setInstanceParams(taskContext.getInstanceParams());  </span><br><span class="line">    request.setJobParams(taskContext.getJobParams());  </span><br><span class="line">    context = helper().startSpan(parentContext, request);  </span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;  </span><br><span class="line">      <span class="keyword">return</span>;  </span><br><span class="line">    &#125;    scope = context.makeCurrent();  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unused&quot;)</span>  </span><br><span class="line">  <span class="meta">@Advice</span>.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">stopSpan</span><span class="params">(  </span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.Return ProcessResult result,  </span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.Thrown Throwable throwable,  </span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelRequest&quot;</span>)</span> PowerJobProcessRequest request,  </span><br><span class="line">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelContext&quot;</span>) Context context,  </span><br><span class="line">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelScope&quot;</span>) Scope scope) &#123;  </span><br><span class="line">    helper().stopSpan(result, request, throwable, scope, context);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€ä¸»è¦çš„å°±æ˜¯ä½¿ç”¨ <code>OpenTelemetry</code> æä¾› SDK åœ¨å…¥å£å¤„è°ƒç”¨ <code>startSpan</code> å¼€å§‹ä¸€ä¸ª spanï¼Œç„¶ååœ¨å‡½æ•°é€€å‡ºæ—¶è°ƒç”¨ <code>stopSpan</code> å‡½æ•°ã€‚</p><p>åŒæ—¶åœ¨æ‰§è¡Œå‰å°†ä¸€äº›è¯·æ±‚ä¿¡æ¯å­˜èµ·æ¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request = PowerJobProcessRequest.createRequest(taskContext.getJobId(), handler, <span class="string">&quot;process&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¿™æ ·å¯ä»¥æ ¹æ®è¿™äº›è¯·æ±‚ä¿¡æ¯ç”Ÿæˆ span çš„ attributeï¼Œä¹Ÿå°±æ˜¯ jobId, jobParam ç­‰æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PowerJobExperimentalAttributeExtractor</span>  </span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">AttributesExtractor</span>&lt;PowerJobProcessRequest, Void&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(  </span></span><br><span class="line"><span class="params">      AttributesBuilder attributes,  </span></span><br><span class="line"><span class="params">      Context parentContext,  </span></span><br><span class="line"><span class="params">      PowerJobProcessRequest powerJobProcessRequest)</span> &#123;  </span><br><span class="line">    attributes.put(POWERJOB_JOB_ID, powerJobProcessRequest.getJobId());  </span><br><span class="line">    attributes.put(POWERJOB_JOB_PARAM, powerJobProcessRequest.getJobParams());  </span><br><span class="line">    attributes.put(POWERJOB_JOB_INSTANCE_PARAM, powerJobProcessRequest.getInstanceParams());  </span><br><span class="line">    attributes.put(POWERJOB_JOB_INSTANCE_TRPE, powerJobProcessRequest.getJobType());  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™é‡Œçš„ jobId&#x2F; jobParams æ•°æ®éƒ½æ˜¯ä»åˆšæ‰å†™å…¥çš„ <code>PowerJobProcessRequest</code> ä¸­è·å–çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (CAPTURE_EXPERIMENTAL_SPAN_ATTRIBUTES) &#123;  </span><br><span class="line">  builder.addAttributesExtractor(  </span><br><span class="line">      AttributesExtractor.constant(AttributeKey.stringKey(<span class="string">&quot;job.system&quot;</span>), <span class="string">&quot;powerjob&quot;</span>));  </span><br><span class="line">  builder.addAttributesExtractor(<span class="keyword">new</span> <span class="title class_">PowerJobExperimentalAttributeExtractor</span>());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶åªéœ€è¦å°†åˆšæ‰çš„ <code>PowerJobExperimentalAttributeExtractor</code> åœ¨åˆå§‹åŒ– Instrumenter æ—¶è¿›è¡Œé…ç½®ï¼Œè¿™æ · <code>OpenTelemetry</code> çš„ SDK å°±ä¼šè‡ªåŠ¨å›è°ƒè¿™ä¸ªæ¥å£ï¼Œä»è€Œè·å–åˆ° Span çš„ attributeã€‚</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.bytebuddy.matcher.ElementMatchers.isPublic;  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.bytebuddy.matcher.ElementMatchers.named;  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.bytebuddy.matcher.ElementMatchers.takesArguments;</span><br><span class="line"><span class="keyword">import</span> net.bytebuddy.asm.Advice;</span><br></pre></td></tr></table></figure><blockquote><p>å…¶å®è¿™é‡Œå¤§éƒ¨åˆ†çš„ API éƒ½æ˜¯ bytebuddy æä¾›çš„ã€‚</p></blockquote><p>ä¸çŸ¥é“å¤§å®¶æ˜¯å¦è§‰å¾—çœ¼ç†Ÿï¼ŒInstrumentation çš„å†™æ³•å…¶å®å’Œ spring çš„æ‹¦æˆªå™¨æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AroundExample</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Around(&quot;execution(* com.xyz..service.*.*(..))&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">doBasicProfiling</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"><span class="comment">// start stopwatch</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">retVal</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line"><span class="comment">// stop stopwatch</span></span><br><span class="line"><span class="keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ¯•ç«Ÿ Spring çš„æ‹¦æˆªå™¨ä¹Ÿæ˜¯ä½¿ç”¨ <code>bytebuddy</code> å®ç°çš„ã€‚</p></blockquote><h1 id="ä¸€äº›å‘"><a href="#ä¸€äº›å‘" class="headerlink" title="ä¸€äº›å‘"></a>ä¸€äº›å‘</h1><p>å…¶å®æ•´ä¸ªåŸ‹ç‚¹è¿‡ç¨‹éå¸¸ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒä¸€äº›ç°æœ‰çš„ instrumentation å°±å¯ä»¥å¾ˆå¿«å®ç°é€»è¾‘ï¼›çœŸæ­£éº»çƒ¦çš„æ—¶å€™åœ¨æäº¤ PR æ—¶éœ€è¦é€šè¿‡ CI æ ¡éªŒã€‚</p><p><img src="https://s2.loli.net/2024/08/26/ynupP2g5UMWGD3Z.png"></p><blockquote><p>æˆ‘è¿™é‡Œå¤§æ¦‚æäº¤äº† 8æ¬¡æ‰æŠŠ  CI å…¨éƒ¨è·‘é€šè¿‡ã€‚</p></blockquote><p>è¿™é‡Œé¢æœ‰å„ç§å°å‘ï¼Œåªæœ‰è‡ªå·±æäº¤è¿‡æ‰èƒ½æ„Ÿå—å¾—åˆ°ï¼Œä¸‹é¢æˆ‘å°±ä¸€ä¸€åˆ—ä¸¾ä¸€äº›å¤§å®¶å¯èƒ½ä¼šç¢°åˆ°çš„é—®é¢˜ã€‚</p><h2 id="åˆ›å»ºæ¨¡å—"><a href="#åˆ›å»ºæ¨¡å—" class="headerlink" title="åˆ›å»ºæ¨¡å—"></a>åˆ›å»ºæ¨¡å—</h2><p>é¦–å…ˆç¬¬ä¸€ä¸ªæ˜¯åˆ›å»ºæ¨¡å—çš„æ—¶å€™è®°å¾—ä½¿ç”¨ kotlin ä½œä¸º gradle çš„ DSLã€‚</p><p><img src="https://s2.loli.net/2024/08/26/ku9e3vhG5mSYPc4.png"></p><p>IDEA è¿™é‡Œé»˜è®¤é€‰æ‹©çš„æ˜¯ Groovy ä½œä¸º DSLï¼›æˆ‘å½“æ—¶æ²¡æœ‰æ³¨æ„ï¼Œåé¢åœ¨é¡¹ç›®æ„å»ºè¿‡ç¨‹ä¸­ä¸€ç›´åœ¨æŠ¥é”™ï¼Œä»”ç»†æ ¸å¯¹åå‘ç°æ˜¯ DSL çš„é—®é¢˜ï¼Œä¿®æ”¹ä¹‹åå°±èƒ½ç¼–è¯‘é€šè¿‡äº†ã€‚</p><h2 id="é¡¹ç›®æ„å»º"><a href="#é¡¹ç›®æ„å»º" class="headerlink" title="é¡¹ç›®æ„å»º"></a>é¡¹ç›®æ„å»º</h2><p>ç¬¬äºŒä¸ªæ˜¯ module çš„å‘½åè§„åˆ™ã€‚</p><p><img src="https://s2.loli.net/2024/08/26/NZgl4GUR327IXW5.png"></p><p>æˆ‘ä»¬éœ€è¦éµå®ˆ v4_0_0 çš„è§„åˆ™ï¼ŒåŒæ—¶è¿˜å¾—ä¸ <code>PowerJobInstrumentationModule</code> ä¸­å®šä¹‰çš„åç§°ç›¸åŒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">PowerJobInstrumentationModule</span><span class="params">()</span> &#123;  </span><br><span class="line">  <span class="built_in">super</span>(<span class="string">&quot;powerjob&quot;</span>, <span class="string">&quot;powerjob-4.0&quot;</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚å¦‚æœæˆ‘ä»¬çš„åŒ…åç§°æ˜¯ <code>powerjob.v1.1.0</code> ï¼Œé‚£è¿™é‡Œçš„åç§°ä¹Ÿå¾—æ˜¯ <code>&quot;powerjob-1.1.0&quot;</code></p><h1 id="Muzzle"><a href="#Muzzle" class="headerlink" title="Muzzle"></a>Muzzle</h1><p>ç¬¬ä¸‰ä¸ªæ˜¯ <code>Muzzle</code> æ ¡éªŒï¼Œ<code>Muzzle</code> æ˜¯ä¸ºäº†ä¿è¯ <code>javaagent</code> åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨æ—¶å’Œè¿è¡Œæ—¶çš„ä¾èµ–ä¸å‘ç”Ÿå†²çªè€Œå®šä¹‰çš„ä¸€ä¸ªæ ¡éªŒè§„åˆ™ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">muzzle &#123;  </span><br><span class="line">  pass &#123;  </span><br><span class="line">    group.<span class="keyword">set</span>(<span class="string">&quot;tech.powerjob&quot;</span>)  </span><br><span class="line">    module.<span class="keyword">set</span>(<span class="string">&quot;powerjob-worker&quot;</span>)  </span><br><span class="line">    versions.<span class="keyword">set</span>(<span class="string">&quot;[4.0.0,)&quot;</span>)  </span><br><span class="line">    assertInverse.<span class="keyword">set</span>(<span class="literal">true</span>)  </span><br><span class="line">    extraDependency(<span class="string">&quot;tech.powerjob:powerjob-official-processors:1.1.0&quot;</span>)  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥æˆ‘è¿™ä¸ªä¸ºä¾‹ï¼Œå®ƒçš„å«ä¹‰æ˜¯å…¼å®¹ <code>tech.powerjob:powerjob-worker:4.0.0+</code>ä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚</p><p><code>assertInverse.set(true)</code>: çš„ä½œç”¨æ˜¯ä¸ä¹‹ç›¸åçš„ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ 4.0.0 ä»¥ä¸‹çš„ç‰ˆæœ¬éƒ½ä¸åšæ”¯æŒï¼Œå¦‚æœåœ¨è¿™äº›ç‰ˆæœ¬ä¸­è¿è¡Œ javaagent æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚</p><blockquote><p>å› ä¸ºè¿™äº›ä½ç‰ˆæœ¬çš„ powerjob ä¸å…¼å®¹æˆ‘ä»¬çš„åŸ‹ç‚¹ä»£ç ã€‚</p></blockquote><p><code>extraDependency</code>ï¼šçš„ä½œç”¨æ˜¯é¢å¤–éœ€è¦ä¾èµ–çš„åŒ…ï¼Œæˆ‘è¿™é‡Œé¢å¤–ä½¿ç”¨äº†è¿™ä¸ªåŒ…é‡Œçš„ä¸€äº›ç±»ï¼Œå¦‚æœä¸åŠ ä¸Šçš„è¯åœ¨åš <code>Muzzle</code> æ ¡éªŒæ—¶ä¹Ÿä¼šå¤±è´¥ã€‚</p><h2 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h2><p>æœ€åä¾¿æ˜¯å•å…ƒæµ‹è¯•äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testBasicProcessor</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="type">long</span> <span class="variable">jobId</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">  <span class="type">String</span> <span class="variable">jobParam</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">  <span class="type">TaskContext</span> <span class="variable">taskContext</span> <span class="operator">=</span> genTaskContext(jobId, jobParam);</span><br><span class="line">  <span class="type">BasicProcessor</span> <span class="variable">testBasicProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestBasicProcessor</span>();</span><br><span class="line">  testBasicProcessor.process(taskContext);</span><br><span class="line">  testing.waitAndAssertTraces(</span><br><span class="line">      trace -&gt; &#123;</span><br><span class="line">        trace.hasSpansSatisfyingExactly(</span><br><span class="line">            span -&gt; &#123;</span><br><span class="line">              span.hasName(String.format(<span class="string">&quot;%s.process&quot;</span>, TestBasicProcessor.class.getSimpleName()));</span><br><span class="line">              span.hasKind(SpanKind.INTERNAL);</span><br><span class="line">              span.hasStatus(StatusData.unset());</span><br><span class="line">              span.hasAttributesSatisfying(</span><br><span class="line">                  attributeAssertions(</span><br><span class="line">                      TestBasicProcessor.class.getName(), jobId, jobParam, BASIC_PROCESSOR));</span><br><span class="line">            &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;AttributeAssertion&gt; <span class="title function_">attributeAssertions</span><span class="params">(</span></span><br><span class="line"><span class="params">    String codeNamespace, <span class="type">long</span> jobId, String jobParam, String jobType)</span> &#123;</span><br><span class="line">  List&lt;AttributeAssertion&gt; attributeAssertions =</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">          asList(</span><br><span class="line">              equalTo(AttributeKey.stringKey(<span class="string">&quot;code.namespace&quot;</span>), codeNamespace),</span><br><span class="line">              equalTo(AttributeKey.stringKey(<span class="string">&quot;code.function&quot;</span>), <span class="string">&quot;process&quot;</span>),</span><br><span class="line">              equalTo(AttributeKey.stringKey(<span class="string">&quot;job.system&quot;</span>), <span class="string">&quot;powerjob&quot;</span>),</span><br><span class="line">              equalTo(AttributeKey.longKey(<span class="string">&quot;scheduling.powerjob.job.id&quot;</span>), jobId),</span><br><span class="line">              equalTo(AttributeKey.stringKey(<span class="string">&quot;scheduling.powerjob.job.type&quot;</span>), jobType)));</span><br><span class="line">  <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(jobParam)) &#123;</span><br><span class="line">    attributeAssertions.add(</span><br><span class="line">        equalTo(AttributeKey.stringKey(<span class="string">&quot;scheduling.powerjob.job.param&quot;</span>), jobParam));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> attributeAssertions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•çš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯æ¨¡æ‹Ÿä¸€ä¸‹æ ¸å¿ƒé€»è¾‘çš„è°ƒç”¨ï¼Œç„¶åæ–­è¨€æ˜¯å¦å­˜åœ¨æˆ‘ä»¬é¢„æœŸçš„ Spanï¼ŒåŒæ—¶è¿˜å¾—æ ¡éªŒå®ƒçš„ attribute æ˜¯å¦ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p><p>è¿™ä¸ªå•æµ‹å½“æ—¶ä¹Ÿè°ƒäº†è®¸ä¹…ï¼Œå› ä¸º <code>versions.set(&quot;[4.0.0,)&quot;)</code> è¿™ä¸ªé…ç½®ï¼Œæœ‰ä¸€ä¸ª CI workflow ä¼šæ ¡éªŒæœ€æ–°ç‰ˆæœ¬çš„ powerjob æ˜¯å¦ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚</p><p><img src="https://s2.loli.net/2024/08/26/vDSXq9tpGW7LAdb.png"></p><p>æ¯”å¦‚å®ƒä¼šæ‹‰å–ç›®å‰æœ€æ–°çš„ä¾èµ–è¿›è¡Œæµ‹è¯•ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;tech.powerjob:powerjob-worker:5.1.0&quot;</span>)</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬åœ¨å•æµ‹ä¸­ä¾èµ–äº†æŸäº›ç‰ˆæœ¬ä¸å­˜åœ¨çš„ç±»ï¼Œæˆ–è€…æ˜¯å‡½æ•°ç­¾åå‘ç”Ÿè¿‡å˜åŒ–çš„å‡½æ•°ç”¨äºæµ‹è¯•ï¼Œé‚£è¿™ä¸ª CI å°±ä¼šæ‰§è¡Œå¤±è´¥ã€‚</p><p><img src="https://s2.loli.net/2024/08/26/HjIi5dBKlw9FxQy.png"></p><p>å› ä¸ºè¿™é‡Œçš„æ„å»ºæ—¥å¿—éå¸¸å¤šï¼ŒåŒæ—¶è¿˜æ˜¯å¹¶å‘æµ‹è¯•çš„ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç›´æ¥æŸ¥çœ‹æ—¥å¿—æ¥å®šä½é—®é¢˜ä¼šéå¸¸éº»çƒ¦ã€‚</p><p>å½“ç„¶ç¤¾åŒºä¹Ÿè€ƒè™‘åˆ°äº†ï¼Œå¯ä»¥åœ¨ <code>â€œBuild scanâ€</code> è¿™ä¸ªæ­¥éª¤ä¸­æŸ¥çœ‹ <code>gradle</code> çš„æ„å»ºæ—¥å¿—ã€‚</p><p><img src="https://s2.loli.net/2024/08/26/4xmRqFZi6NpkPML.png"></p><p><a href="https://scans.gradle.com/s/meywfxnvhhqtc/console-log/task/:instrumentation:powerjob-4.0:javaagent:compileTestJava?anchor=37&page=1">è¿™é‡Œ</a>ä¼šç›´æ¥è¾“å‡ºå…·ä½“æ˜¯å“ªé‡Œæ„å»ºå‡ºäº†é—®é¢˜ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å°±èƒ½å¾ˆå¿«å®šä½åˆ°åŸå› ã€‚</p><p>æˆ‘è¿™é‡Œä¹Ÿæ˜¯å› ä¸ºä½¿ç”¨çš„æŸäº›å¸®åŠ©å‡½æ•°åœ¨æœ€æ–°çš„ç‰ˆæœ¬ä¸­å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸ºäº†æµ‹è¯•é€šè¿‡ï¼Œå°±ä¸å¾—ä¸è°ƒæ•´æµ‹è¯•ä»£ç äº†ã€‚</p><p>å¦‚æœä½ å‘ç°å¿…é¡»å¾—ä¾èµ–è¿™äº›ç±»æˆ–è€…å‡½æ•°æ¥é…åˆæµ‹è¯•ï¼Œé‚£å°±åªæœ‰è€ƒè™‘åˆ†ä¸ºå¤šä¸ªä¸åŒçš„ç‰ˆæœ¬è¿›è¡Œæµ‹è¯•ï¼Œç±»ä¼¼äº xxl-jobï¼š</p><p><img src="https://s2.loli.net/2024/08/26/yLhmXBKDzVaYjJ5.png"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šå°±æ˜¯æ•´ä¸ª instrumentation çš„ç¼–å†™è¿‡ç¨‹ï¼Œå…¶ä¸­æ ¸å¿ƒçš„åŸ‹ç‚¹è¿‡ç¨‹å¹¶ä¸å¤æ‚ï¼Œåªè¦æˆ‘ä»¬å¯¹éœ€è¦åŸ‹ç‚¹çš„åº“æˆ–æ¡†æ¶æ¯”è¾ƒç†Ÿæ‚‰ï¼Œéƒ½å¯ä»¥å®ç°åŸ‹ç‚¹ã€‚</p><p>çœŸæ­£éº»çƒ¦çš„æ˜¯éœ€è¦é€šè¿‡ç¤¾åŒºå¤æ‚ä¸”ä¸¥è°¨çš„ CI æµç¨‹ï¼Œå¥½åœ¨ä¸ç®¡æ˜¯å“ªä¸€æ­¥çš„ CI å¤±è´¥éƒ½å¯ä»¥æŸ¥åˆ°å…·ä½“çš„åŸå› ï¼Œæœ‰ç‚¹ç±»ä¼¼äºå‡çº§æ‰“æ€ªï¼Œè·Ÿç€é”™è¯¯ä¿¡æ¯èµ°ï¼Œæœ€ç»ˆéƒ½èƒ½éªŒè¯é€šè¿‡ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/CONTRIBUTING.md">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/CONTRIBUTING.md</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/contributing/writing-instrumentation.md">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/contributing/writing-instrumentation.md</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;å› ä¸ºå…¬å¸å†…éƒ¨åœ¨ä½¿ç”¨ &lt;a href=&quot;https://github.com/PowerJob/PowerJob&quot;&gt;PowerJob&lt;/a&gt; ä½œä¸ºæˆ‘ä»¬çš„åˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿï¼ŒåŒæ—¶åˆæ˜¯ä½¿ç”¨ OpenTelemetry ä½œä¸ºå¯è§‚æµ‹çš„åº•åº§ï¼Œä½†ç›®å‰ OpenTelemetry è¿˜æ²¡æœ‰å¯¹ PowerJob æä¾›æ”¯æŒï¼Œç›®å‰ç¤¾åŒºåªå¯¹åŒç±»å‹çš„ XXL-JOB æœ‰æ”¯æŒã€‚&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/26/qfdloarJ7iNzPXy.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æ°å¥½å…¬å¸å†…éƒ¨ä¹Ÿæœ‰ä¸€äº›å¼€å‘åŒå­¦æœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/26/6aIFxlEyKt7OfsC.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;äºæ˜¯åœ¨è¿™ä¸ªèƒŒæ™¯ä¸‹æˆ‘ä¾¿å¼€å§‹ç€æ‰‹å¼€å‘ PowerJob çš„ instrumentationï¼Œæœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/26/r7xgSHKCftqvuXw.png&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/26/KNnWPzm5rU9By3c.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>æˆ‘ç”¨æˆ‘çš„270ç¯‡æ–‡ç« åšäº†ä¸€ä¸ªæ•°å­— AI æ›¿èº«</title>
    <link href="http://crossoverjie.top/2024/09/23/ob/Build-ower-AI-robot/"/>
    <id>http://crossoverjie.top/2024/09/23/ob/Build-ower-AI-robot/</id>
    <published>2024-09-23T13:54:01.000Z</published>
    <updated>2024-09-23T14:55:08.624Z</updated>
    
    <content type="html"><![CDATA[<p>23 å¹´åœ¨ ChatGPT åˆšå‡ºæ¥çš„æ—¶å€™å°±åœ¨ <a href="https://www.v2ex.com/t/931521">V ç«™</a>ä¸Šçœ‹åˆ°æœ‰ä¸€ä¸ªçœ‹åˆ°æœ‰å¤§ä½¬ç”¨è‡ªå·±çš„å¾®ä¿¡èŠå¤©è®°å½•å’Œåšå®¢æ–‡ç« ç”Ÿæˆäº†ä¸€ä¸ª AI æ›¿èº«ï¼š</p><span id="more"></span><p><img src="https://s2.loli.net/2024/09/23/7xPdy54cIEm6pnR.png" alt="image.png"></p><p>å½“æ—¶å°±æƒ³ç€è‡ªå·±åšä¸€ä¸ªï¼Œä¸è¿‡å½“æ—¶å®ç°èµ·æ¥è¿˜æ¯”è¾ƒå¤æ‚ï¼Œç›´åˆ°å¦‚ä»Š AI å·²ç»è¶Šæ¥è¶Šæ™®åŠï¼Œæƒ³åšä¸€ä¸ªè‡ªå·±çš„ AI æ›¿èº«æˆæœ¬ä¹Ÿéå¸¸ä½äº†ã€‚</p><p>äºæ˜¯å°±æœ‰äº†ä¸‹å›¾é‡Œçš„æ•ˆæœï¼š<br><img src="https://s2.loli.net/2024/09/23/vmJhURZKsg96yaY.png"><br><img src="https://s2.loli.net/2024/09/23/tOzlgqvEMdm6LFo.png"></p><p>å’Œè‡ªå·±çš„å†…å®¹è¿™ä¹ˆå¯¹è¯è¿˜æŒºæœ‰æ„æ€çš„ï¼Œç°åœ¨å¤§å®¶å°±å¯ä»¥ç›´æ¥åœ¨æˆ‘å…¬ä¼—å·å›å¤æ¶ˆæ¯å’Œâ€ä»–â€œèŠå¤©ã€‚<br><img src="https://s2.loli.net/2024/09/23/7CiykumvIdALDZe.jpg"></p><blockquote><p>ä¹Ÿå¯ä»¥é€šè¿‡å°ç¨‹åºæ¥ä½¿ç”¨ï¼š<br><img src="https://s2.loli.net/2024/09/23/9bdLkeP6XGorKAJ.png"></p></blockquote><h2 id="å¦‚ä½•æ­å»º"><a href="#å¦‚ä½•æ­å»º" class="headerlink" title="å¦‚ä½•æ­å»º"></a>å¦‚ä½•æ­å»º</h2><p>è¿™é‡Œä½¿ç”¨çš„æ•°æ®æºå…¨éƒ½æ˜¯æˆ‘å‘å¸ƒåœ¨å…¬ä¼—å·é‡Œçš„ 260 ç¯‡æ–‡ç« ã€‚<br><img src="https://s2.loli.net/2024/09/23/NWae9gRJbPHO6M8.png"></p><p>èƒ½å¤Ÿç›´æ¥è·å–åˆ°å¾®ä¿¡å…¬ä¼—å·çš„æ•°æ®ä¸€å®šæ˜¯è…¾è®¯è‡ªå·±çš„äº§å“ï¼Œå…¶å®è¿™ä¸ªäº§å“å«åšï¼š<a href="https://yuanqi.tencent.com/">è…¾è®¯å…ƒå™¨</a>ï¼Œæ˜¯è…¾è®¯å¤§æ¨¡å‹å›¢é˜ŸåŸºäºæ··å…ƒå¤§æ¨¡å‹æ¨å‡ºçš„æ™ºèƒ½åˆ›ä½œå·¥å…·ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ promptã€æ•°æ®æºã€æ’ä»¶æ¥å®ç°è‡ªå·±çš„ AI æœºå™¨äººï¼Œæˆ–è€…ç±»ä¼¼çš„äº¤äº’äº§å“ã€‚</p><p>ç›´æ¥åˆ›å»ºä¸€ä¸ªæ™ºèƒ½ä½“ï¼Œç„¶åç¼–å†™å¯¹åº”çš„æç¤ºè¯å³å¯ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œå®˜æ–¹ä¹Ÿæä¾›äº†ä¸€äº› <code>prompt</code> çš„ç¤ºä¾‹ï¼š<br><img src="https://s2.loli.net/2024/09/23/sOhwLG28i9qTcBz.png" alt="image.png"></p><p>æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å¡«å†™å°±å¯ä»¥äº†ã€‚</p><p>æœ€ä¸»è¦çš„è¿˜æ˜¯åˆ›å»ºä¸€ä¸ªçŸ¥è¯†åº“ï¼Œä¹Ÿå°±æ˜¯ä½ çš„æ•°æ®æºï¼Œå¥½åœ¨è¿™é‡Œç›´æ¥æ•´åˆäº†å…¬ä¼—å·çš„æ•°æ®ï¼›<br><img src="https://s2.loli.net/2024/09/23/sXALurKi5BRET23.png"></p><p>ç›´æ¥æˆæƒå°±å¯ä»¥ä½¿ç”¨ï¼ŒåŒæ—¶è¿˜å¯ä»¥æ¯å¤©å®šæ—¶æ›´æ–°ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p><p><img src="https://s2.loli.net/2024/09/23/TEJZ56MNCBV3aLh.png"></p><p>å®ƒä¼šæ ¹æ®ä½ çš„é—®é¢˜æ¥åˆ¤æ–­æ˜¯å¦ç”¨çŸ¥è¯†åº“çš„å†…å®¹æ¥å›ç­”ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯é—®ä¸€äº›çŸ¥è¯†åº“ä¸å­˜åœ¨çš„å†…å®¹ä¹Ÿèƒ½æ‹¿åˆ°ç»“æœã€‚</p><hr><p><img src="https://s2.loli.net/2024/09/23/AJbU4s1FXq7rSxO.png"><br>é™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥ä¸Šä¼ ä½ æœ¬åœ°çš„æ–‡ä»¶ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯ä½ æ²¡æœ‰å†™å…¬ä¼—å·ä¹Ÿå¯ä»¥ä¸Šä¼ è‡ªå·±æ•´ç†çš„å†…å®¹ã€‚</p><p>æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥è¯•è¯•å°å°é²œï¼Œåç»­æˆ‘å¯ä»¥æŒç»­å®Œå–„è¿™ä¸ªçŸ¥è¯†åº“ï¼Œæ¯”å¦‚è¾“å…¥ä¸€äº›ä»£ç ï¼Œä¹‹åå†æœ‰å‘æˆ‘å’¨è¯¢é—®é¢˜çš„æœ‹å‹å°±å¯ä»¥å…ˆå»é—®é—®â€ä»–â€œï¼Œ</p><p>å¤§å®¶å¯ä»¥ç›´æ¥åœ¨å…¬ä¼—å·é‡Œå’Œâ€å¯¹è¯â€œï¼Œè¯´ä¸å®šè¿˜æœ‰æ„å¤–æ”¶è·ğŸ¶ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;23 å¹´åœ¨ ChatGPT åˆšå‡ºæ¥çš„æ—¶å€™å°±åœ¨ &lt;a href=&quot;https://www.v2ex.com/t/931521&quot;&gt;V ç«™&lt;/a&gt;ä¸Šçœ‹åˆ°æœ‰ä¸€ä¸ªçœ‹åˆ°æœ‰å¤§ä½¬ç”¨è‡ªå·±çš„å¾®ä¿¡èŠå¤©è®°å½•å’Œåšå®¢æ–‡ç« ç”Ÿæˆäº†ä¸€ä¸ª AI æ›¿èº«ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="AI" scheme="http://crossoverjie.top/categories/AI/"/>
    
    
    <category term="AI" scheme="http://crossoverjie.top/tags/AI/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetryåœ¨ä¼ä¸šå†…éƒ¨åº”ç”¨æ‰€éœ€è¦çš„æŠ€æœ¯æ ˆ</title>
    <link href="http://crossoverjie.top/2024/09/15/ob/OpenTelemetry-enterprise/"/>
    <id>http://crossoverjie.top/2024/09/15/ob/OpenTelemetry-enterprise/</id>
    <published>2024-09-15T07:54:11.000Z</published>
    <updated>2024-09-17T11:50:48.221Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¯è§‚æµ‹æ€§æ¦‚å¿µ"><a href="#å¯è§‚æµ‹æ€§æ¦‚å¿µ" class="headerlink" title="å¯è§‚æµ‹æ€§æ¦‚å¿µ"></a>å¯è§‚æµ‹æ€§æ¦‚å¿µ</h1><p><img src="https://s2.loli.net/2024/08/08/Sdot1TJUfWgNZyu.png"><br>å½“ä¸€ä¸ªè½¯ä»¶æˆ–ç³»ç»Ÿå‡ºäºè¿è¡ŒçŠ¶æ€æ—¶ï¼Œå¦‚æœæˆ‘ä»¬ä¸å¯¹ä»–åŠ ä»¥è§‚æµ‹ï¼Œé‚£å®ƒçš„è¿è¡ŒçŠ¶æ€å¯¹æˆ‘ä»¬æ¥è¯´å°±æ˜¯ä¸€ä¸ªé»‘ç›’ã€‚</p><blockquote><p>å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p></blockquote><p>æˆ‘ä»¬åªèƒ½é€šè¿‡ä¸šåŠ¡çš„è¡¨è±¡æ¥åˆ¤æ–­å®ƒæ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæ— æ³•åœ¨æ•…éšœå‘ç”Ÿå‰è¿›è¡Œé¢„åˆ¤ï¼Œä»è€Œåªèƒ½è¢«åŠ¨è§£å†³é—®é¢˜ã€‚</p><span id="more"></span><p>è¿™ç±»é—®é¢˜åœ¨å¾®æœåŠ¡æ—¶ä»£ä½“ç°çš„æ›´åŠ æ˜æ˜¾ï¼Œå³ä¾¿æ˜¯ä¸šåŠ¡å·²ç»å‡ºç°é—®é¢˜ï¼Œåœ¨æ²¡æœ‰å¯è§‚æµ‹æ€§ç³»ç»Ÿçš„å‰æä¸‹æƒ³è¦å®šä½é—®é¢˜æ›´æ˜¯éš¾ä¸ŠåŠ éš¾ã€‚</p><p><img src="https://s2.loli.net/2024/08/08/eUFuwnPxf3cVrCL.png"><br>å¥½åœ¨å¯è§‚æµ‹æ€§è¿™ä¸ªæ¦‚å¿µç”±æ¥å·²ä¹…ï¼Œå·²ç»ç”±ä¸€äº›ä¸šç•Œå¤§ä½¬æŠ½è±¡å‡ºå‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ul><li>Logsï¼šç¦»æ•£çš„æ—¥å¿—ä¿¡æ¯</li><li>Metricsï¼šèšåˆçš„æŒ‡æ ‡</li><li>Traceï¼šè¯·æ±‚åŸºæœ¬çš„é“¾è·¯è¿½è¸ª</li></ul><p>ç»“åˆè¿™ä¸‰ä¸ªæŒ‡æ ‡ï¼Œæˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æµç¨‹ä¸€èˆ¬å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/08/08/Ixqt2WnBaz9jAQ4.png"></p><p>é¦–å…ˆæ ¹æ® metrics æ¥åˆ¤æ–­æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œè¿™ç‚¹å¯ä»¥é€šè¿‡åœ¨ Prometheus çš„ AlertManager é…ç½®ä¸€äº›æ ¸å¿ƒçš„å‘Šè­¦æŒ‡æ ‡ã€‚</p><p>æ¯”å¦‚å½“ CPUã€å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 80% æˆ–è€…æŸä¸ªåº”ç”¨ Down æœºåå°±å‘å‡ºå‘Šè­¦ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AllInstances</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">InstanceDown</span></span><br><span class="line">    <span class="comment"># Condition for alerting</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="comment"># Annotation - additional informational labels to store more information</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">title:</span> <span class="string">&#x27;Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> down&#x27;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> of job <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has been down for more than 1 minute.&#x27;</span></span><br><span class="line">    <span class="comment"># Labels - additional labels to be attached to the alert</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;critical&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/08/15/vh4t8nLk2NaXKu9.png"></p><p>è¿™å¯ä»¥è®©æˆ‘ä»¬å°½æ—©å‘ç°æ•…éšœã€‚</p><p>ä¹‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡é“¾è·¯ä¿¡æ¯æ‰¾åˆ°å‘ç”Ÿæ•…éšœçš„èŠ‚ç‚¹ã€‚<br><img src="https://s2.loli.net/2024/08/15/A4C8xQour2WqpLO.png"></p><p>ç„¶åé€šè¿‡è¿™é‡Œçš„ trace_id åœ¨åº”ç”¨ä¸­æ‰¾åˆ°å…·ä½“çš„æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdc.trace_id:4a686dedcdf4e95b1a83b36e62563a96</span><br></pre></td></tr></table></figure><p>å†æ ¹æ®æ—¥å¿—ä¸­çš„ä¸Šä¸‹æ–‡ç¡®å®šå…·ä½“çš„å¼‚å¸¸åŸå› ã€‚</p><p>è¿™å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ’æŸ¥é—®é¢˜çš„æµç¨‹ã€‚</p><h1 id="OpenTelemetry-å‘å±•å†å²"><a href="#OpenTelemetry-å‘å±•å†å²" class="headerlink" title="OpenTelemetry å‘å±•å†å²"></a>OpenTelemetry å‘å±•å†å²</h1><p><img src="https://s2.loli.net/2024/08/08/p5WkVbSarUdIQwT.png" alt="image.png"><br><img src="https://s2.loli.net/2024/08/08/pvMEBObGgHcdRom.png"><br>åœ¨ OpenTelemetry å¼€å§‹ä¹‹å‰è¿˜æ˜¯å…ˆå›é¡¾ä¸‹å¯è§‚æµ‹æ€§çš„å‘å±•å†å²ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªé‡è¦æ—¶é—´ç‚¹ï¼š</p><ul><li>2010 å¹´ Google å‘å¸ƒäº† Dapper è®ºæ–‡ï¼Œç»™ä¸šç•Œå¸¦æ¥äº†å®ç°åˆ†å¸ƒå¼è¿½è¸ªçš„ç†è®ºæ”¯æŒï¼Œä¹‹åçš„è®¸å¤šåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªå®ç°éƒ½æœ‰å®ƒçš„å½±å­</li><li>kubernetes çš„å‘å¸ƒå¥ å®šäº†åç»­äº‘åŸç”Ÿç¤¾åŒºçš„åŸºç¡€</li><li>Jaeger å‘å¸ƒåæˆä¸ºäº†ä¸»æµçš„é“¾è·¯å­˜å‚¨ç³»ç»Ÿ</li><li>2019 å¹´ OpenTracing å’Œ OpenCensus åˆå¹¶ä¸º OpenTelemetry</li><li>2021 å¹´åº• OpenTelemetry å‘å¸ƒç¬¬ä¸€ä¸ª GA release ç‰ˆæœ¬</li></ul><h2 id="OpenTelemetry-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#OpenTelemetry-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="OpenTelemetry æ˜¯ä»€ä¹ˆï¼Ÿ"></a>OpenTelemetry æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><img src="https://s2.loli.net/2024/08/08/FDzVTSqruLxY8EX.png"></p><p>ä»¥å‰æˆ‘ä»¬æ‰€æ¥è§¦åˆ°çš„ç±»ä¼¼äºé˜¿é‡Œçš„ARMSã€ç¾å›¢çš„ CATã€Pinpoint è¿™ç±»ç³»ç»Ÿå¤§å¤šéƒ½æœ‰ä¸€ä¸ªå…¬å¸åœ¨èƒŒåè¿›è¡Œé©±åŠ¨ï¼Œä¸å‚å•†ç»‘å®šçš„éå¸¸ç´§å¯†ã€‚</p><p>è€Œ OpenTelemetry åˆ™ç›¸åï¼Œå®ƒä¸»è¦ç”±ç¤¾åŒºé©±åŠ¨ï¼Œå‚ä¸çš„å…¬å¸ä¼—å¤šï¼›åŒæ—¶å®ƒå®šä¹‰å’Œæä¾›äº†ä¸€å¥—å¯è§‚æµ‹æ€§çš„æ ‡å‡†ï¼ˆåŒ…æ‹¬ APIã€SDKã€è§„èŒƒç­‰æ•°æ®ï¼‰ã€‚</p><p>ä½¿ç”¨å®ƒä½ å¯ä»¥çµæ´»çš„é€‰æ‹©å’Œæ­é…ä»»æ„çš„å¼€æºæˆ–å•†ä¸šäº§å“æ¥ç»„æˆä½ çš„å¯è§‚æµ‹æ€§æŠ€æœ¯æ ˆã€‚</p><p><img src="https://s2.loli.net/2024/08/08/8RJ6H75hsICWgcD.png"></p><p>å› ä¸ºç¤¾åŒºéå¸¸æ´»è·ƒï¼Œæ‰€ä»¥å½“å‰ä¹Ÿå‡ ä¹æ”¯æŒä¸»æµçš„å¼€å‘è¯­è¨€ã€‚</p><h2 id="OpenTelemetry-çš„æ¶æ„"><a href="#OpenTelemetry-çš„æ¶æ„" class="headerlink" title="OpenTelemetry çš„æ¶æ„"></a>OpenTelemetry çš„æ¶æ„</h2><p><img src="https://s2.loli.net/2024/08/08/DMd1JfcCrO7Pm52.png"><br>OpenTelemetry çš„æ¶æ„ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>å·¦ä¾§çš„å®¢æˆ·ç«¯ Agentï¼Œç”¨äºé‡‡é›†å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œé€šå¸¸å°±æ˜¯æˆ‘ä»¬çš„åº”ç”¨ã€‚</li><li>ä¸­é—´çš„æ˜¯ Collector-Serviceï¼Œç”¨äºæ¥å—å®¢æˆ·ç«¯çš„æ•°æ®ã€å†…éƒ¨å¤„ç†ã€å¯¼å‡ºæ•°æ®åˆ°å„ç§å­˜å‚¨</li><li>å³ä¾§çš„åˆ™æ˜¯å„ç§å­˜å‚¨å±‚ï¼Œç”¨äºå­˜å‚¨ Metricsã€Logsã€Traces è¿™äº›æ•°æ®ã€‚</li></ul><p>æˆ‘ä»¬åŸºäºå®˜æ–¹æ¨èçš„æŠ€æœ¯æ¶æ„é€‰å‹äº†æˆ‘ä»¬çš„æŠ€æœ¯æ ˆï¼š<br><img src="https://s2.loli.net/2024/08/09/XTzCOPBI6HYNta1.png" alt="image.png"><br>ä¸»è¦çš„åŒºåˆ«å°±æ˜¯ä½¿ç”¨ VictoriaMetrics å­˜å‚¨æŒ‡æ ‡ã€StackRocks å­˜å‚¨ Traceï¼ŒElasticSearch å­˜å‚¨æ—¥å¿—ã€‚</p><blockquote><p>åªæ˜¯ç›®å‰æˆ‘ä»¬çš„æ—¥å¿—é“¾è·¯è¿˜æ²¡æœ‰å®Œå…¨åˆ‡æ¢åˆ° OpenTelemetry çš„é“¾è·¯ï¼Œä¾ç„¶æ˜¯åœ¨ Pod ä¸­æŒ‚è½½äº†ä¸€ä¸ª sidecarï¼Œåœ¨è¿™ä¸ª sidecar ä¸­é€šè¿‡ filebeat é‡‡é›†æ—¥å¿—è¾“å‡ºåˆ° elasticsearchï¼Œåç»­ä¹Ÿä¼šé€æ­¥è¿ç§»ã€‚</p></blockquote><h2 id="æ ¸å¿ƒé¡¹ç›®"><a href="#æ ¸å¿ƒé¡¹ç›®" class="headerlink" title="æ ¸å¿ƒé¡¹ç›®"></a>æ ¸å¿ƒé¡¹ç›®</h2><h3 id="Collecotor"><a href="#Collecotor" class="headerlink" title="Collecotor"></a>Collecotor</h3><p>OpenTelemetry ç¤¾åŒºçš„é¡¹ç›®ä¼—å¤šï¼Œå…¶ä¸­å¤§éƒ¨åˆ†éƒ½æ˜¯å„ç§è¯­è¨€çš„ SDK å’Œ APIï¼Œå…¶ä¸­æœ€ä¸ºå…³é”®çš„åº”è¯¥å°±æ˜¯ <a href="https://github.com/open-telemetry?q=opentelemetry-collector&type=all&language=&sort=">opentelemetry-collector</a></p><p>ä¹Ÿå°±æ˜¯åˆšæ‰æ¶æ„å›¾ä¸­çš„ä¸­é—´éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£ä¸ºç±»ä¼¼ APIGateway çš„è§’è‰²ï¼Œæ‰€æœ‰ä¸ŠæŠ¥çš„ OTel æ•°æ®éƒ½å¾—ç»è¿‡å®ƒçš„å¤„ç†ã€‚</p><p><img src="https://s2.loli.net/2024/08/16/UfuI2wHtojqNS96.png"></p><p>ä¸»è¦ç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>Receiverï¼šç”¨äºæ¥å—å®¢æˆ·ç«¯ä¸ŠæŠ¥çš„æ•°æ®</li><li>Processï¼šå†…éƒ¨çš„æ•°æ®å¤„ç†å™¨</li><li>Exporterï¼šå°†æ•°æ®å¯¼å‡ºåˆ°ä¸åŒçš„å­˜å‚¨</li></ul><p>ç”±äº OpenTelemetry ç¤¾åŒºéå¸¸çš„æ´»è·ƒï¼Œæ‰€ä»¥è¿™é‡Œæ”¯æŒçš„ <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver">Receiver</a>ã€<a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor">Processor</a> å’Œ <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter">Exporter</a> ç±»å‹éå¸¸å¤šã€‚</p><p><img src="https://s2.loli.net/2024/08/16/hTeuXskGMitYFCr.png"><br><img src="https://s2.loli.net/2024/08/16/EqPcjxK3Myr2LUC.png"><br><img src="https://s2.loli.net/2024/08/16/btqTu9gAl7heJra.png"></p><h3 id="å…¶ä»–æ ¸å¿ƒé¡¹ç›®"><a href="#å…¶ä»–æ ¸å¿ƒé¡¹ç›®" class="headerlink" title="å…¶ä»–æ ¸å¿ƒé¡¹ç›®"></a>å…¶ä»–æ ¸å¿ƒé¡¹ç›®</h3><p>æˆ‘ä»¬ä»¥ Java ä¸ºä¾‹ï¼Œå¯¹ä¸šåŠ¡å¼€å‘æœ€é‡è¦çš„åº“å°±æ˜¯ <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/">opentelemetry-java-instrumentation</a></p><p>å®ƒå¯ä»¥æ‰“åŒ…ä¸€ä¸ª javaagent ç»™æˆ‘ä»¬ä½¿ç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Java example</span></span><br><span class="line">java -javaagent:path/to/opentelemetry-javaagent.jar \  </span><br><span class="line">     -jar myapp.jar</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/08/16/YjzfWKFxPOqH5N6.png"></p><p>åŒæ—¶ä¹Ÿæ”¯æŒäº†æˆ‘ä»¬æ—¥å¸¸å¼€å‘çš„ç»å¤§å¤šæ•°æ¡†æ¶å’Œä¸­é—´ä»¶ã€‚</p><blockquote><p>æ”¯æŒçš„<a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md">åº“ä¸æ¡†æ¶</a>åˆ—è¡¨</p></blockquote><p>å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨ä¸­è‡ªå®šä¹‰æ‰“æ¡©ä¸€äº› Spanã€Metrics ï¼Œå°±è¿˜éœ€è¦ <a href="https://github.com/open-telemetry/opentelemetry-java">opentelemetry-java</a> è¿™ä¸ªé¡¹ç›®ã€‚</p><p>å®ƒæä¾›äº†å…·ä½“çš„ SDK å¯ä»¥æ–¹ä¾¿çš„åˆ›å»º Span å’Œ Metricsã€‚</p><h1 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h1><p>ä¹‹åæ¥çœ‹çœ‹ <code>OpenTelemetry</code> ä¸­å…·ä½“çš„ä¸‰ä¸ªç»´åº¦çš„æ¦‚å¿µå’Œåº”ç”¨ï¼Œé¦–å…ˆæ˜¯ Traceã€‚</p><p><img src="https://s2.loli.net/2024/08/16/DAB7J5Rpx8OFs6L.png"></p><p>Trace è¿™ä¸ªæ¦‚å¿µé¦–å…ˆæ˜¯ <a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/papers/dapper-2010-1.pdf">Google Dapper</a> è®ºæ–‡ä¸­æåˆ°ã€‚</p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼šä¸€æ¬¡ç”¨æˆ·è¯·æ±‚ç»å†äº† 4 æ¬¡ PRC è°ƒç”¨ï¼Œåˆ†åˆ«ä¹Ÿå±äºä¸åŒçš„ç³»ç»Ÿã€‚</p><p>æ¯ä¸€æ¬¡ RPC è°ƒç”¨å°±ä¼šäº§ç”Ÿä¸€ä¸ª Spanï¼Œå°†è¿™äº› span ä¸²è”èµ·æ¥å°±èƒ½å½¢æˆä¸€ä¸ªè°ƒç”¨é“¾è·¯ã€‚</p><p>è¿™ä¸ª Span ä¸»è¦åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li>SpanName</li><li>ParentID</li><li>SpanID</li></ul><p>å½“æˆ‘ä»¬å°†ä¸€ä¸ª Span æ”¾å¤§åä¼šçœ‹åˆ°æ›´åŠ å…·ä½“çš„ä¿¡æ¯ï¼š</p><ul><li>TraceId</li><li>SpanName</li><li>ParentID</li><li>SpanID</li><li>å¼€å§‹æ—¶é—´</li><li>ç»“æŸæ—¶é—´<br>åœ¨ Dapper è®ºæ–‡ä¸­ä½¿ç”¨ Annotations æ¥å­˜æ”¾ span çš„å±æ€§ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å­˜æ”¾ä¸€äº›æ•°æ®ï¼Œæ¯”å¦‚å›¾ä¸­çš„ <code>&quot;foo&quot;</code>ã€‚</li></ul><blockquote><p>åœ¨ OpenTelemetry çš„ SDK ä¸­ç§°ä¸º  attributeï¼Œè€Œåœ¨ Jaeger çš„ UI ä¸­åˆç§°ä¸º tagï¼Œè™½ç„¶å«æ³•ä¸åŒï¼Œä½†æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¸œè¥¿ã€‚</p></blockquote><p>æœ€ç»ˆå°±ä¼šå½¢æˆä¸Šå›¾ä¸­çš„æ ‘çŠ¶ç»“æ„çš„è°ƒç”¨å…³ç³»ã€‚</p><h2 id="Span-Kind"><a href="#Span-Kind" class="headerlink" title="Span Kind"></a>Span Kind</h2><p><img src="https://s2.loli.net/2024/08/16/XSAGlCY7F4f1pu5.png"><br>Span ä¸­è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå°±æ˜¯ Span Kindï¼Œä¹Ÿå°±æ˜¯ Span çš„ç±»å‹ï¼Œè¿™ä¸ªç±»å‹å¯ä»¥åœ¨æ’æŸ¥é—®é¢˜æ—¶å¾ˆå®¹æ˜“å¾—çŸ¥è¯¥æœåŠ¡çš„ç±»å‹ã€‚</p><p><img src="https://s2.loli.net/2024/08/16/cqezfgKSylJipRB.png"><br>æŒ‰ç…§å®˜æ–¹çš„å®šä¹‰ï¼ŒSpan çš„ç±»å‹åˆ†ä¸ºï¼š</p><ul><li>Client</li><li>Server</li><li>Internal</li><li>Producer</li><li>Consumer</li></ul><p>å¯¹äº RPC çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è‡ªç„¶å°±å¯¹åº” Client å’Œ Serverï¼Œè€Œä½¿ç”¨äº†æ¶ˆæ¯é˜Ÿåˆ—çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…å¯¹åº”çš„å°±æ˜¯ Produce å’Œ Consumerã€‚</p><p>é™¤æ­¤ä¹‹å¤–å‘ç”Ÿåœ¨åº”ç”¨å†…éƒ¨çš„ä¸€äº›å…³é”® Span çš„ç±»å‹å°±æ˜¯ Internalï¼Œæ¯”å¦‚æˆ‘ä»¬éœ€è¦å¯¹ä¸šåŠ¡çš„æŸäº›å…³é”®å‡½æ•°ç”Ÿæˆ Span æ—¶ï¼Œæ­¤æ—¶çš„ Span ç±»å‹é€šå¸¸ä¹Ÿéƒ½æ˜¯ Internalã€‚</p><h2 id="ä¸Šä¸‹æ–‡ä¼ é€’"><a href="#ä¸Šä¸‹æ–‡ä¼ é€’" class="headerlink" title="ä¸Šä¸‹æ–‡ä¼ é€’"></a>ä¸Šä¸‹æ–‡ä¼ é€’</h2><p><img src="https://s2.loli.net/2024/08/09/v1mwnLEGNlKMbsq.png" alt="image.png"></p><p>åœ¨ Trace ä¸­æœ‰ä¸€ä¸ªå…³é”®æŠ€æœ¯é—®é¢˜éœ€è¦è¢«è§£å†³ï¼Œä¹Ÿå°±æ˜¯ Context çš„ä¸Šä¸‹æ–‡ä¼ é€’ã€‚</p><p>è¿™ä¸ªç‰¹åˆ«æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¿…é¡»è¦è§£å†³ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•æŠŠå®ƒç†è§£ä¸ºå¦‚ä½•æŠŠä¸Šæ¸¸ç”Ÿæˆçš„ trace_id ä¼ é€’åˆ°ä¸‹æ¸¸ï¼Œè¿™æ ·æ‰èƒ½åœ¨è¿½è¸ªçš„é“¾è·¯è¿½è¸ªç³»ç»Ÿä¸­ä¸²è”èµ·æ¥ã€‚</p><p>è¿™ä¸ªå…³é”®çš„æŠ€æœ¯åè¯åœ¨ OpenTelemetry ä¸­ç§°ä¸ºï¼š<a href="https://opentelemetry.io/docs/concepts/context-propagation/">Context Propagation</a>.</p><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ•°æ®éƒ½æ˜¯é€šè¿‡ç½‘ç»œä¼ é€’çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„æœ¬è´¨é—®é¢˜ä¾ç„¶æ˜¯å¦‚ä½•å°†ä¸Šä¸‹æ–‡æ•°æ®åºåˆ—åŒ–ä¹‹åï¼Œåœ¨ä¸‹æ¸¸å¯ä»¥ååºåˆ—åŒ–åˆ° <code>Context</code> ä¸­ã€‚</p><p>èªæ˜çš„å°ä¼™ä¼´åº”è¯¥å·²ç»æƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥å°† trace_id å†™å…¥åˆ°è·¨è¿›ç¨‹è°ƒç”¨çš„å…ƒæ•°æ®ä¸­ï¼š</p><ul><li>http å¯ä»¥å­˜æ”¾åœ¨ http header ä¸­</li><li>gRPC å¯ä»¥å­˜æ”¾åœ¨ meta ä¸­</li><li>Pulsar å¯ä»¥å­˜æ”¾åœ¨æ¶ˆæ¯çš„ properties ä¸­</li><li>å…¶ä½™çš„ä¸­é—´ä»¶å’Œæ¡†æ¶ä¹Ÿæ˜¯åŒç†</li></ul><p>ç„¶ååœ¨è¿œç¨‹è°ƒç”¨ä¹‹å‰ä½¿ç”¨ <code>Inject</code> å°†æ•°æ®æ³¨å…¥åˆ°è¿™äº›å…ƒæ•°æ®é‡Œï¼Œä¸‹æ¸¸åœ¨æ¥æ”¶åˆ°è¯·æ±‚åå†é€šè¿‡ä¸€ä¸ª<code>Extract</code> å‡½æ•°å°†å…ƒæ•°æ®è§£æåˆ° <code>Context</code> ä¸­ï¼Œè¿™æ · <code>trace_id</code> å°±å¯ä»¥ä¸²è”èµ·æ¥äº†ã€‚</p><p><img src="https://s2.loli.net/2024/08/08/wfKZNacuBJeMDO1.png" alt="image.png"></p><p><img src="https://s2.loli.net/2024/08/08/NHOYS9R1EIZrBhd.png" alt="image.png"></p><p>ä¸Šå›¾å°±æ˜¯ Pulsar å’Œ gRPC ä¼ é€’ trace_id çš„è¿‡ç¨‹ï¼Œæ•°æ®éƒ½æ˜¯å­˜æ”¾åœ¨å…ƒæ•°æ®ä¸­çš„ï¼Œè¿™é‡Œçš„ <code>traceparent</code> çš„å€¼æœ¬è´¨ä¸Šå°±æ˜¯ trace_id.</p><blockquote><p>å…·ä½“çš„ä»£ç ç»†èŠ‚æˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡ç»§ç»­åˆ†æã€‚</p></blockquote><h1 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h1><p><img src="https://s2.loli.net/2024/08/09/HfFnubtAKvJ8hVy.png"></p><p>Metrics ç›¸å¯¹äº Trace æ¥è¯´åˆ™æ˜¯è¦ç®€å•è®¸å¤šï¼ŒOpenTelemetry å®šä¹‰äº†è®¸å¤šå‘½åè§„èŒƒå’Œæ ‡å‡†ï¼Œè¿™æ ·å¤§å®¶åœ¨å¤ç”¨ç¤¾åŒºçš„ä¸€äº›ç›‘æ§æ¨¡æ¿æ—¶å°±è¦æ›´åŠ å®¹æ˜“ä¸€äº›ã€‚</p><h2 id="Metrics-Exemplars"><a href="#Metrics-Exemplars" class="headerlink" title="Metrics Exemplars"></a>Metrics Exemplars</h2><p><img src="https://s2.loli.net/2024/08/09/tOlkQFZBH421wri.png"></p><p>Metrics è¿˜æä¾›äº†ä¸€ä¸ª Exemplar çš„åŠŸèƒ½ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å¯ä»¥å°† Metrics å’Œ Trace å…³è”åœ¨ä¸€èµ·ï¼Œè¿™æ ·åœ¨é€šè¿‡ Metrics å‘ç°é—®é¢˜æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥è·³è½¬åˆ°é“¾è·¯ç³»ç»Ÿã€‚</p><p>å› ä¸º trace_id å¯ä»¥é€šè¿‡ MDC å’Œæ—¥å¿—å…³è”ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ Metrics å®šä½å…·ä½“åº”ç”¨çš„æ—¥å¿—ï¼Œè¿™æ ·æ’æŸ¥é—®é¢˜çš„æ•ˆç‡å°†ä¼šéå¸¸é«˜ã€‚</p><h1 id="æ‰©å±•ä¿¡æ¯"><a href="#æ‰©å±•ä¿¡æ¯" class="headerlink" title="æ‰©å±•ä¿¡æ¯"></a>æ‰©å±•ä¿¡æ¯</h1><p>ä»¥ä¸Šå°±æ˜¯å…³äº OpenTelemetry çš„æ•´ä½“æ¶æ„ï¼Œä¸‹é¢æ¥æ‰©å±•ä¸€äº›å†…å®¹ã€‚</p><h2 id="eBPF"><a href="#eBPF" class="headerlink" title="eBPF"></a>eBPF</h2><p><img src="https://s2.loli.net/2024/08/16/KPxF6kvcBCX4JER.png"><br>eBPF æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ Linux å†…æ ¸ä¸­çš„è™šæ‹Ÿæœºï¼Œå®ƒæä¾›ä¸€å¥—ç‰¹æ®Šçš„æŒ‡ä»¤é›†å¹¶å…è®¸æˆ‘ä»¬åœ¨ä¸é‡æ–°ç¼–è¯‘å†…æ ¸ã€ä¹Ÿä¸éœ€è¦é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹åŠ è½½è‡ªå®šä¹‰çš„é€»è¾‘ã€‚</p><p>eBPF æŠ€æœ¯å…·æœ‰ä¸‰å¤§ç‰¹ç‚¹ï¼š</p><ul><li>ç¬¬ä¸€æ˜¯<strong>æ— ä¾µå…¥</strong>ï¼ŒåŠ¨æ€æŒ‚è½½ï¼Œç›®æ ‡è¿›ç¨‹æ— éœ€é‡å¯ï¼Œè€Œä¸”å› ä¸ºæ˜¯ Linux å†…æ ¸æä¾›åŠŸèƒ½ï¼Œæ‰€ä»¥ä¸è¯­è¨€æ— å…³ï¼Œä»»ä½•è¯­è¨€éƒ½å¯ä»¥æ”¯æŒã€‚</li><li>ç¬¬äºŒæ˜¯<strong>é«˜æ€§èƒ½</strong>ï¼ŒeBPF å­—èŠ‚ç ä¼šè¢« JIT æˆæœºå™¨ç åæ‰§è¡Œï¼Œæ•ˆç‡éå¸¸é«˜ï¼›</li><li>ç¬¬ä¸‰æ˜¯æ›´åŠ <strong>å®‰å…¨</strong>ï¼Œå®ƒä¼šè¿è¡Œåœ¨è‡ªå·±çš„æ²™ç®±ç¯å¢ƒä¸­ï¼Œä¸ä¼šå¯¼è‡´ç›®æ ‡è¿›ç¨‹å´©æºƒã€‚</li></ul><p>eBPF è™½ç„¶æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸€äº›å±€é™æ€§ï¼Œæ¯”å¦‚æˆ‘æƒ³ç›‘æ§ä¸šåŠ¡ä»£ç ä¸­çš„æŸä¸ªå…·ä½“æŒ‡æ ‡ï¼ˆè®¢å•åˆ›å»ºæ•°é‡ï¼‰ï¼Œæ­¤æ—¶å®ƒå°±éš¾ä»¥å®ç°äº†ï¼Œæ‰€ä»¥è¿˜å¾—çœ‹æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯ã€‚<br>æ›´é€‚åˆä¸€äº›äº‘å¹³å°ï¼Œæˆ–è€…æ›´åå‘åº•å±‚çš„åº”ç”¨ã€‚</p><p>ç›®å‰ eBPF çš„åº”ç”¨åœºæ™¯è¿˜ä¸å¤Ÿå¹¿æ³›ï¼Œä½†å‡ä»¥æ—¶æ—¥ä¸€å®šä¼šæˆä¸ºå¯è§‚æµ‹é¢†åŸŸçš„æœªæ¥ä¹‹æ˜Ÿã€‚</p><h2 id="SigNoz"><a href="#SigNoz" class="headerlink" title="SigNoz"></a><a href="https://signoz.io/">SigNoz</a></h2><p>ä¸çŸ¥é“å¤§å®¶å‘ç°æ²¡æœ‰ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ OpenTelemetry æŠ€æœ¯æ ˆä¼šéœ€è¦ä¸º Traceã€Metricsã€Logs é€‰æ‹©ä¸åŒçš„å­˜å‚¨ï¼Œè€Œä¸”ä»–ä»¬çš„æŸ¥è¯¢ç•Œé¢ä¹Ÿåˆ†æ•£åœ¨ä¸åŒçš„åœ°æ–¹ã€‚</p><p>é‚£æœ‰æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„å¹³å°å¯ä»¥ç»™æˆ‘ä»¬æä¾›å®Œæ•´çš„å¯è§‚æµ‹ä½“éªŒå‘¢ï¼Ÿ</p><p>æœ‰è¿™æ ·çš„éœ€æ±‚é‚£å°±æœ‰å¯¹åº”çš„å‚å•†å®ç°äº†ï¼š<br><img src="https://s2.loli.net/2024/08/09/YZbT3CrlGwoceDE.png"></p><p><a href="https://signoz.io/">SigNoz</a> å°±æ˜¯è¿™æ ·çš„å¹³å°ï¼Œå®ƒå°† OpenTelemetry-collector å’Œæ•°æ®å­˜å‚¨å…¨éƒ¨æ•´åˆåœ¨äº†ä¸€èµ·ï¼ŒåŒæ—¶å…¨é¢å…¼å®¹  OpenTelemetryï¼›å¯ä»¥è¯´å®ƒå°±æ˜¯åŸºäº OpenTelemetry æ„å»ºçš„ä¸€ä¸ªå¯è§‚æµ‹äº§å“ã€‚</p><p>å¯¹äºä¸€äº›ä¸­å°å‚å•†ï¼Œä¸æƒ³å•ç‹¬ç»´æŠ¤è¿™äº›ç»„ä»¶æ—¶æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p><h2 id="OpenObserve"><a href="#OpenObserve" class="headerlink" title="OpenObserve"></a><a href="https://openobserve.ai/">OpenObserve</a></h2><p><img src="https://s2.loli.net/2024/08/16/CuzXT7ts6vWQAEO.png" alt="image.png"></p><p><a href="https://openobserve.ai/">OpenObserve</a>åœ¨ SigNoz çš„åŸºç¡€ä¸Šåšçš„æ›´åŠ æè‡´ä¸€äº›ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„å­˜å‚¨å¯ä»¥å­˜æ”¾æ—¥å¿—ã€Traceã€Metrics ç­‰æ•°æ®ã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åªä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“å­˜æ”¾æ‰€æœ‰çš„æ•°æ®ï¼ŒåŒæ—¶å®ƒä¹Ÿæä¾›äº†å®Œæ•´çš„ UIï¼Œå¹¶ä¸”ä¹Ÿå…¨é¢å…¼å®¹ OpenTelemetryã€‚</p><p>è¿™æ ·å¯¹äºè¿ç»´æ¥è¯´ä¼šæ›´åŠ ç®€å•ï¼Œåªæ˜¯å¯èƒ½å¸¦æ¥çš„å‰¯ä½œç”¨å°±æ˜¯éœ€è¦ä¸å®ƒå®Œå…¨ç»‘å®šã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šå°±æ˜¯ OpenTelemetry åœ¨ä¼ä¸šçš„åº”ç”¨ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µé€‰æ‹©è‡ªå»º OTel çš„æŠ€æœ¯æ ˆï¼Œè¿˜æ˜¯é€‰æ‹© SigNoz å’Œ OpenObserve è¿™ç±»çš„æ ‡å‡†åŒ–äº§å“ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å¯è§‚æµ‹æ€§æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#å¯è§‚æµ‹æ€§æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;å¯è§‚æµ‹æ€§æ¦‚å¿µ&quot;&gt;&lt;/a&gt;å¯è§‚æµ‹æ€§æ¦‚å¿µ&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/08/Sdot1TJUfWgNZyu.png&quot;&gt;&lt;br&gt;å½“ä¸€ä¸ªè½¯ä»¶æˆ–ç³»ç»Ÿå‡ºäºè¿è¡ŒçŠ¶æ€æ—¶ï¼Œå¦‚æœæˆ‘ä»¬ä¸å¯¹ä»–åŠ ä»¥è§‚æµ‹ï¼Œé‚£å®ƒçš„è¿è¡ŒçŠ¶æ€å¯¹æˆ‘ä»¬æ¥è¯´å°±æ˜¯ä¸€ä¸ªé»‘ç›’ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æˆ‘ä»¬åªèƒ½é€šè¿‡ä¸šåŠ¡çš„è¡¨è±¡æ¥åˆ¤æ–­å®ƒæ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæ— æ³•åœ¨æ•…éšœå‘ç”Ÿå‰è¿›è¡Œé¢„åˆ¤ï¼Œä»è€Œåªèƒ½è¢«åŠ¨è§£å†³é—®é¢˜ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>æ—¥å¿—ä¸è¿½è¸ªçš„å®Œç¾èåˆï¼šOpenTelemetry MDC å®è·µæŒ‡å—</title>
    <link href="http://crossoverjie.top/2024/09/05/ob/OpenTelemetry-client-log-mdc/"/>
    <id>http://crossoverjie.top/2024/09/05/ob/OpenTelemetry-client-log-mdc/</id>
    <published>2024-09-05T06:50:33.000Z</published>
    <updated>2024-09-10T13:41:32.260Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨å‰é¢ä¸¤ç¯‡å®æˆ˜æ–‡ç« ä¸­ï¼š</p><ul><li><a href="https://juejin.cn/post/7391744486979076146">OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª</a></li><li><a href="https://juejin.cn/post/7394395254566846475">OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åº”ç”¨æŒ‡æ ‡ç›‘æ§</a></li></ul><p>è¦†ç›–äº†å¯è§‚æµ‹ä¸­çš„æŒ‡æ ‡è¿½è¸ªå’Œ <code>metrics</code> ç›‘æ§ï¼Œä¸‹é¢ç†åº”å¼€å§‹ç¬¬ä¸‰éƒ¨åˆ†ï¼š<strong>æ—¥å¿—</strong>ã€‚</p><p>ä½†åœ¨å¼€å§‹æ—¥å¿—ä¹‹å‰è¿˜æ˜¯è¦å…ˆå°†é“¾è·¯è¿½è¸ªå’Œæ—¥å¿—ç»“åˆèµ·æ¥çœ‹çœ‹åº”ç”¨å®é™…ä½¿ç”¨çš„å®è·µã€‚</p><p>é€šå¸¸æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æ–¹å¼æ˜¯å…ˆæŸ¥è¯¢å¼‚å¸¸æ—¥å¿—ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ç³»ç»Ÿçš„é—®é¢˜ã€‚</p><p>å¦‚æœä¸æ˜¯ï¼Œåˆ™åœ¨æ—¥å¿—ä¸­æå‡º <code>trace_id</code> å†åˆ°é“¾è·¯æŸ¥è¯¢ç³»ç»Ÿä¸­æŸ¥è¯¢é“¾è·¯ï¼Œçœ‹çœ‹å…·ä½“æ˜¯å“ªä¸ªç³»ç»Ÿçš„é—®é¢˜ï¼Œç„¶åå†åšå…·ä½“çš„æ’æŸ¥ã€‚</p><p>ç±»ä¼¼äºè¿™æ ·ï¼š<br><img src="https://s2.loli.net/2024/08/05/mP97tShHKrGXge2.png"><br>æ—¥å¿—ä¸­ä¼šæ‰“å° <code>trace_id</code> å’Œ <code>span_id</code>ã€‚</p><blockquote><p>å¦‚æœæ—¥å¿—ç³»ç»Ÿåšçš„æ¯”è¾ƒå®Œå–„çš„è¯ï¼Œè¿˜å¯ä»¥ç›´æ¥ç‚¹å‡» <code>trace_id</code> è·³è½¬åˆ°é“¾è·¯ç³»ç»Ÿé‡Œç›´æ¥æŸ¥è¯¢é“¾è·¯ä¿¡æ¯ã€‚</p></blockquote><span id="more"></span><h1 id="MDC"><a href="#MDC" class="headerlink" title="MDC"></a>MDC</h1><p>è¿™é‡Œçš„æ—¥å¿—é‡Œå…³è” trace ä¿¡æ¯çš„åšæ³•æœ‰ä¸ªä¸“æœ‰åè¯ï¼šMDC:(Mapped Diagnostic Context)ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯ç”¨äºæ’æŸ¥é—®é¢˜çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œé€šå¸¸æ˜¯ç”±é”®å€¼å¯¹ç»„æˆï¼Œç±»ä¼¼äºè¿™æ ·çš„æ•°æ®ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2024-08-05 17:27:31.097&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;level&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;INFO&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;thread&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;http-nio-9191-exec-1&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;mdc&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">    <span class="attr">&quot;trace_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;26242f945af80b044a60226af00211fb&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;trace_flags&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;01&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;span_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;3a7842b3e28ed5c8&quot;</span>  </span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;logger&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;com.example.demo.DemoApplication&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;message&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;request: name: \&quot;1232\&quot;\n&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;context&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;default&quot;</span>  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>åœ¨ Java ä¸­çš„ Log4j å’Œ Logback éƒ½æœ‰æä¾›å¯¹åº”çš„å®ç°ã€‚</p><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº† OpenTelemetry æä¾›çš„ <code>javaagent</code> å†é…åˆ <code>logback</code> æˆ–è€… <code>Log4j</code> æ—¶å°±ä¼šè‡ªåŠ¨å…·å¤‡æ‰“å° <code>MDC</code> çš„èƒ½åŠ›ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:/Users/chenjie/Downloads/blog-img/demo/opentelemetry-javaagent-2.4.0-SNAPSHOT.jar xx.jar</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘ä»¬åªéœ€è¦è¿™æ ·é…ç½®è¿™æ ·ä¸€ä¸ªJSON è¾“å‡ºçš„ logback å³å¯ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;PROJECT_LOG&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;PATH&#125;/demo.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.FixedWindowRollingPolicy&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;PATH&#125;/demo_%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">maxIndex</span>&gt;</span>1<span class="tag">&lt;/<span class="name">maxIndex</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.contrib.json.classic.JsonLayout&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">jsonFormatter</span>  </span></span><br><span class="line"><span class="tag">                <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.contrib.jackson.JacksonJsonFormatter&quot;</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">prettyPrint</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prettyPrint</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">jsonFormatter</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">timestampFormat</span>&gt;</span>yyyy-MM-dd&#x27; &#x27;HH:mm:ss.SSS<span class="tag">&lt;/<span class="name">timestampFormat</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">layout</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;PROJECT_LOG&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/08/05/ba195iyS2hgnOVx.png"></p><p>å°±ä¼šåœ¨æ—¥å¿—æ–‡ä»¶ä¸­è¾“å‡º <code>JSON</code> æ ¼å¼çš„æ—¥å¿—ï¼Œå¹¶ä¸”å¸¦ä¸Š <code>MDC</code> çš„ä¿¡æ¯ã€‚</p><h1 id="è‡ªåŠ¨-MDC-çš„åŸç†"><a href="#è‡ªåŠ¨-MDC-çš„åŸç†" class="headerlink" title="è‡ªåŠ¨ MDC çš„åŸç†"></a>è‡ªåŠ¨ MDC çš„åŸç†</h1><p>æˆ‘ä¹Ÿæ¯”è¾ƒå¥½å¥‡ OpenTelemetry æ˜¯å¦‚ä½•è‡ªåŠ¨å†™å…¥ MDC ä¿¡æ¯çš„ï¼Œè¿™é‡Œä»¥ <code>logback</code> ä¸ºä¾‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> ElementMatcher&lt;TypeDescription&gt; <span class="title function_">typeMatcher</span><span class="params">()</span> &#123;  </span><br><span class="line">  <span class="keyword">return</span> implementsInterface(named(<span class="string">&quot;ch.qos.logback.classic.spi.ILoggingEvent&quot;</span>));  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(TypeTransformer transformer)</span> &#123;  </span><br><span class="line">  transformer.applyAdviceToMethod(  </span><br><span class="line">      isMethod()  </span><br><span class="line">          .and(isPublic())  </span><br><span class="line">          .and(namedOneOf(<span class="string">&quot;getMDCPropertyMap&quot;</span>, <span class="string">&quot;getMdc&quot;</span>))  </span><br><span class="line">          .and(takesArguments(<span class="number">0</span>)),  </span><br><span class="line">      LoggingEventInstrumentation.class.getName() + <span class="string">&quot;$GetMdcAdvice&quot;</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šåœ¨è°ƒç”¨ <code>ch.qos.logback.classic.spi.ILoggingEvent.getMDCPropertyMap()/getMdc()</code> è¿™ä¸¤ä¸ªå‡½æ•°ä¸­è¿›è¡ŒåŸ‹ç‚¹ã€‚</p><blockquote><p>è¿™äº›é€»è¾‘éƒ½æ˜¯å†™åœ¨ javaagent ä¸­çš„ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getMDCPropertyMap</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="comment">// populate mdcPropertyMap if null  </span></span><br><span class="line">    <span class="keyword">if</span> (mdcPropertyMap == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="type">MDCAdapter</span> <span class="variable">mdc</span> <span class="operator">=</span> MDC.getMDCAdapter();  </span><br><span class="line">        <span class="keyword">if</span> (mdc <span class="keyword">instanceof</span> LogbackMDCAdapter)  </span><br><span class="line">            mdcPropertyMap = ((LogbackMDCAdapter) mdc).getPropertyMap();  </span><br><span class="line">        <span class="keyword">else</span>  </span><br><span class="line">            mdcPropertyMap = mdc.getCopyOfContextMap();  </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="comment">// mdcPropertyMap still null, use emptyMap()  </span></span><br><span class="line">    <span class="keyword">if</span> (mdcPropertyMap == <span class="literal">null</span>)  </span><br><span class="line">        mdcPropertyMap = Collections.emptyMap();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> mdcPropertyMap;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å…¶å®é»˜è®¤æƒ…å†µä¸‹ä¼šè¿”å›ä¸€ä¸ª logback å†…ç½® MDC çš„ map æ•°æ®ï¼ˆè¿™é‡Œçš„æ•°æ®æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰é…ç½®ï¼‰ã€‚</p><p>è€Œè¿™é‡Œè¦åšçš„å°±æ˜¯å°† trace çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å†™å…¥è¿™ä¸ª mdcPropertyMap ä¸­ã€‚</p><p>ä»¥ä¸‹æ˜¯ OpenTelemetry agent ä¸­çš„æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; spanContextData = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">  </span><br><span class="line"><span class="type">SpanContext</span> <span class="variable">spanContext</span> <span class="operator">=</span> Java8BytecodeBridge.spanFromContext(context).getSpanContext();  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (spanContext.isValid()) &#123;  </span><br><span class="line">  spanContextData.put(traceIdKey(), spanContext.getTraceId());  </span><br><span class="line">  spanContextData.put(spanIdKey(), spanContext.getSpanId());  </span><br><span class="line">  spanContextData.put(traceFlagsKey(), spanContext.getTraceFlags().asHex());  </span><br><span class="line">&#125;  </span><br><span class="line">spanContextData.putAll(ConfiguredResourceAttributesHolder.getResourceAttributes());  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (LogbackSingletons.addBaggage()) &#123;  </span><br><span class="line">  <span class="type">Baggage</span> <span class="variable">baggage</span> <span class="operator">=</span> Java8BytecodeBridge.baggageFromContext(context);  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// using a lambda here does not play nicely with instrumentation bytecode process  </span></span><br><span class="line">  <span class="comment">// (Java 6 related errors are observed) so relying on for loop instead  for (Map.Entry&lt;String, BaggageEntry&gt; entry : baggage.asMap().entrySet()) &#123;  </span></span><br><span class="line">    spanContextData.put(  </span><br><span class="line">        <span class="comment">// prefix all baggage values to avoid clashes with existing context  </span></span><br><span class="line">        <span class="string">&quot;baggage.&quot;</span> + entry.getKey(), entry.getValue().getValue());  </span><br><span class="line">  &#125;&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (contextData == <span class="literal">null</span>) &#123;  </span><br><span class="line">  contextData = spanContextData;  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">  contextData = <span class="keyword">new</span> <span class="title class_">UnionMap</span>&lt;&gt;(contextData, spanContextData);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯æ ¸å¿ƒçš„å†™å…¥é€»è¾‘ï¼Œä»è¿™ä¸ªä»£ç ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºç›´æ¥ä»ä¸Šçº¿æ–‡ä¸­è·å–çš„ span çš„ contextï¼Œè€Œæˆ‘ä»¬æ‰€éœ€è¦çš„ <code>trace_id/span_id</code>  éƒ½æ˜¯å­˜æ”¾åœ¨ context ä¸­çš„ï¼Œåªéœ€è¦ get å‡ºæ¥ç„¶åå†™å…¥è¿› map ä¸­å³å¯ã€‚</p><p>ä»æºç é‡Œè¿˜å¾—çŸ¥ï¼Œåªè¦æˆ‘ä»¬å¼€å¯ <code>-Dotel.instrumentation.logback-mdc.add-baggage=true</code> é…ç½®è¿˜å¯ä»¥å°† baggage ä¸­çš„æ•°æ®ä¹Ÿå†™å…¥åˆ° MDC ä¸­ã€‚</p><p>è€Œå¾—æ˜“äº OpenTelemetry ä¸­çš„ trace æ˜¯å¯ä»¥è·¨çº¿ç¨‹ä¼ è¾“çš„ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯æˆ‘ä»¬åœ¨å¤šçº¿ç¨‹é‡Œæ‰“å°æ—¥å¿—æ—¶ MDC æ•°æ®ä¾ç„¶å¯ä»¥å‡†ç¡®æ— è¯¯çš„ä¼ é€’ã€‚</p><h2 id="MDC-çš„åŸç†"><a href="#MDC-çš„åŸç†" class="headerlink" title="MDC çš„åŸç†"></a>MDC çš„åŸç†</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MDC_ATTR_NAME</span> <span class="operator">=</span> <span class="string">&quot;mdc&quot;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/08/05/e7PIASyowDGO1sQ.png"></p><p>åœ¨ <code>logback</code> çš„å®ç°ä¸­æ˜¯ä¼šè°ƒç”¨åˆšæ‰çš„ <code>getMDCPropertyMap()</code> ç„¶åå†™å…¥åˆ°ä¸€ä¸ª key ä¸º <code>mdc</code> çš„ <code>map</code> é‡Œï¼Œæœ€ç»ˆå¯ä»¥å†™å…¥åˆ°æ–‡ä»¶æˆ–è€…æ§åˆ¶å°ã€‚</p><p>è¿™æ ·æ•´ä¸ªåŸç†å°±å¯ä»¥ä¸²èµ·æ¥äº†ã€‚</p><h2 id="è‡ªå®šä¹‰æ—¥å¿—-æ•°æ®"><a href="#è‡ªå®šä¹‰æ—¥å¿—-æ•°æ®" class="headerlink" title="è‡ªå®šä¹‰æ—¥å¿— æ•°æ®"></a>è‡ªå®šä¹‰æ—¥å¿— æ•°æ®</h2><p>æåˆ°å¯ä»¥è‡ªå®šä¹‰ MDC æ•°æ®å…¶å®ä¹Ÿæ˜¯æœ‰ä½¿ç”¨åœºæ™¯çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ä¸šåŠ¡ç³»ç»Ÿç»å¸¸æœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼Œéœ€è¦åœ¨æ—¥å¿—ä¸­æ‰“å°ä¸€äº›å¸¸ç”¨ä¸šåŠ¡æ•°æ®ï¼š</p><ul><li>userIdã€userName</li><li>å®¢æˆ·ç«¯ IPç­‰ä¿¡æ¯æ—¶</li></ul><p>æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>Layout</code> ç±»æ¥ç»§æ‰¿ <code>ch.qos.logback.contrib.json.classic.JsonLayout</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomJsonLayout</span> <span class="keyword">extends</span> <span class="title class_">JsonLayout</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomJsonLayout</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addCustomDataToJsonMap</span><span class="params">(Map&lt;String, Object&gt; map, ILoggingEvent event)</span> &#123;</span><br><span class="line">        map.put(<span class="string">&quot;user_name&quot;</span>, context.getProperty(<span class="string">&quot;userName&quot;</span>));</span><br><span class="line">        map.put(<span class="string">&quot;user_id&quot;</span>, context.getProperty(<span class="string">&quot;userId&quot;</span>));</span><br><span class="line">        map.put(<span class="string">&quot;trace_id&quot;</span>, TraceContext.traceId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomJsonLayoutEncoder</span> <span class="keyword">extends</span> <span class="title class_">LayoutWrappingEncoder</span>&lt;ILoggingEvent&gt; &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomJsonLayoutEncoder</span><span class="params">()</span> &#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="type">CustomJsonLayout</span> <span class="variable">jsonLayout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomJsonLayout</span>();  </span><br><span class="line">        jsonLayout.setContext(<span class="built_in">this</span>.context);  </span><br><span class="line">        jsonLayout.setIncludeContextName(<span class="literal">false</span>);  </span><br><span class="line">        jsonLayout.setAppendLineSeparator(<span class="literal">true</span>);  </span><br><span class="line">        jsonLayout.setJsonFormatter(<span class="keyword">new</span> <span class="title class_">JacksonJsonFormatter</span>());  </span><br><span class="line">        jsonLayout.start();  </span><br><span class="line">        <span class="built_in">super</span>.setCharset(StandardCharsets.UTF_8);  </span><br><span class="line">        <span class="built_in">super</span>.setLayout(jsonLayout);  </span><br><span class="line">        <span class="built_in">super</span>.start();  </span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œçš„ trace_id æ˜¯ä¹‹å‰ä½¿ç”¨ skywalking çš„æ—¶å€™ç”± skywalking æä¾›çš„å‡½æ•°ï¼šorg.apache.skywalking.apm.toolkit.trace.TraceContext#traceId</p></blockquote><p>æ¥ç€åªéœ€è¦åœ¨ <code>logback.xml</code> ä¸­é…ç½®è¿™ä¸ª <code>CustomJsonLayoutEncoder</code> å°±å¯ä»¥æŒ‰ç…§æˆ‘ä»¬è‡ªå®šä¹‰çš„æ•°æ®è¾“å‡ºæ—¥å¿—äº†ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;PROJECT_LOG&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;PATH&#125;/app.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.FixedWindowRollingPolicy&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;PATH&#125;/app_%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">maxIndex</span>&gt;</span>1<span class="tag">&lt;/<span class="name">maxIndex</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;xx.CustomJsonLayoutEncoder&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;PROJECT_LOG&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è™½ç„¶è¿™ä¸ªåŠŸèƒ½ä¹Ÿå¯ä»¥ä½¿ç”¨æ—¥å¿—åˆ‡é¢æ¥æ‰“å°ï¼Œä½†è¿˜æ˜¯æ²¡æœ‰ç›´æ¥åœ¨æ—¥å¿—ä¸­è¾“å‡ºæ›´åŠ æ–¹ä¾¿ï¼Œå®ƒå¯ä»¥ç›´æ¥å’Œæˆ‘ä»¬çš„æ—¥å¿—å…³è”åœ¨ä¸€èµ·ï¼Œåªæ˜¯å¤šåŠ äº†è¿™å‡ ä¸ªå­—æ®µè€Œå·²ã€‚</p><h2 id="Spring-Boot-ä½¿ç”¨"><a href="#Spring-Boot-ä½¿ç”¨" class="headerlink" title="Spring Boot ä½¿ç”¨"></a>Spring Boot ä½¿ç”¨</h2><p><code>OpenTelemetry</code> æœ‰ç»™ springboot åº”ç”¨æä¾›ä¸€ä¸ª <code>spring-boot-starter</code> åŒ…ï¼Œç”¨äºåœ¨ä¸ä½¿ç”¨  <code>javaagent</code> çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è‡ªåŠ¨åŸ‹ç‚¹ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry.instrumentation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>OPENTELEMETRY_VERSION<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä½†åœ¨æ—©<a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/discussions/7653">æœŸçš„ç‰ˆæœ¬</a>ä¸­è¿˜ä¸æ”¯æŒç›´æ¥æ‰“å° MDC æ—¥å¿—ï¼š<br><img src="https://s2.loli.net/2024/08/05/aunR8ApiMEoeJ1O.png" alt="image.png"></p><blockquote><p>æœ€æ–°çš„ç‰ˆæœ¬å·²ç»æ”¯æŒ</p></blockquote><p>å³ä¾¿å·²ç»æ”¯æŒé»˜è®¤è¾“å‡º MDC åï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥è‡ªå®šä¹‰çš„å†…å®¹ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³ä¿®æ”¹ä¸€ä¸‹ key çš„åç§°ï¼Œç”± <code>trace_id</code> ä¿®æ”¹ä¸º <code>otel_trace_id</code> ç­‰ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;OTEL&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.opentelemetry.instrumentation.logback.mdc.v1_0.OpenTelemetryAppender&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">traceIdKey</span>&gt;</span>otel_trace_id<span class="tag">&lt;/<span class="name">traceIdKey</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spanIdKey</span>&gt;</span>otel_span_id<span class="tag">&lt;/<span class="name">spanIdKey</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">traceFlagsKey</span>&gt;</span>otel_trace_flags<span class="tag">&lt;/<span class="name">traceFlagsKey</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯å’Œä¹‹å‰ç±»ä¼¼ï¼Œä¿®æ”¹ä¸‹ logback.xml å³å¯ã€‚</p><p><img src="https://s2.loli.net/2024/08/05/Y3zvfm6rUbxwtOK.png" alt="image.png"><br>ä»–çš„å®ç°é€»è¾‘å…¶å®å’Œä¹‹å‰çš„ auto instrument ä¸­çš„ç±»ä¼¼ï¼Œåªä¸è¿‡ä½¿ç”¨çš„ API ä¸åŒè€Œå·²ã€‚</p><p>auto instrument æ˜¯ç›´æ¥æ‹¦æˆªä»£ç é€»è¾‘ä¿®æ”¹ map çš„è¿”å›å€¼ï¼Œè€Œ <code>OpenTelemetryAppender</code> æ˜¯ç»§æ‰¿äº† <code>ch.qos.logback.core.UnsynchronizedAppenderBase</code> æ¥å£ï¼Œä»è€Œè·å¾—äº†é‡å†™ <code>MDC</code> çš„èƒ½åŠ›ï¼Œä½†æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p><p>ä¸è¿‡ä½¿ç”¨å®ƒçš„å‰ææ˜¯æˆ‘ä»¬éœ€è¦å¼•å…¥ä»¥ä¸‹ä¸€ä¸ªä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry.instrumentation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-logback-mdc-1.0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>OPENTELEMETRY_VERSION<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æƒ³ä¿®æ”¹ logback.yaml ï¼Œå¯¹äº <code>springboot</code> æ¥è¯´è¿˜æœ‰æ›´ç®€å•çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ä»¥ä¸‹é…ç½®å³å¯è‡ªå®šä¹‰ MDC æ•°æ®ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging.pattern.level</span> = <span class="string">trace_id=%mdc&#123;trace_id&#125; span_id=%mdc&#123;span_id&#125; trace_flags=%mdc&#123;trace_flags&#125; %5p</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ key ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼Œåªè¦å ä½ç¬¦æ²¡æœ‰å–é”™å³å¯ã€‚</p><blockquote><p>ä½¿ç”¨è¿™ä¸ªçš„å‰ææ˜¯éœ€è¦åŠ è½½  javaagentï¼Œå› ä¸ºè¿™é‡Œçš„æ•°æ®æ˜¯ javaagent é‡Œå†™è¿›å»çš„ã€‚</p></blockquote><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šå°±æ˜¯å…³äº <code>MDC</code> åœ¨ <code>OpenTelemetry</code> ä¸­çš„ä½¿ç”¨ï¼Œä»ä½¿ç”¨å’Œæºç é€»è¾‘ä¸Šéƒ½åˆ†æäº†ä¸€éï¼Œå¸Œæœ›å¯¹ <code>MDC</code> å’Œ <code>OpenTelemetry</code> çš„ç†è§£æ›´åŠ æ·±åˆ»ä¸€äº›ã€‚</p><p>å…³äº MDC ç›¸å…³çš„æ¦‚å¿µä¸ä½¿ç”¨è¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œæ˜¯æ—¥å¸¸æ’æŸ¥é—®é¢˜å¿…ä¸å¯å°‘çš„ä¸€ä¸ªå·¥å…·ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;åœ¨å‰é¢ä¸¤ç¯‡å®æˆ˜æ–‡ç« ä¸­ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7391744486979076146&quot;&gt;OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7394395254566846475&quot;&gt;OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åº”ç”¨æŒ‡æ ‡ç›‘æ§&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¦†ç›–äº†å¯è§‚æµ‹ä¸­çš„æŒ‡æ ‡è¿½è¸ªå’Œ &lt;code&gt;metrics&lt;/code&gt; ç›‘æ§ï¼Œä¸‹é¢ç†åº”å¼€å§‹ç¬¬ä¸‰éƒ¨åˆ†ï¼š&lt;strong&gt;æ—¥å¿—&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ä½†åœ¨å¼€å§‹æ—¥å¿—ä¹‹å‰è¿˜æ˜¯è¦å…ˆå°†é“¾è·¯è¿½è¸ªå’Œæ—¥å¿—ç»“åˆèµ·æ¥çœ‹çœ‹åº”ç”¨å®é™…ä½¿ç”¨çš„å®è·µã€‚&lt;/p&gt;
&lt;p&gt;é€šå¸¸æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æ–¹å¼æ˜¯å…ˆæŸ¥è¯¢å¼‚å¸¸æ—¥å¿—ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ç³»ç»Ÿçš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœä¸æ˜¯ï¼Œåˆ™åœ¨æ—¥å¿—ä¸­æå‡º &lt;code&gt;trace_id&lt;/code&gt; å†åˆ°é“¾è·¯æŸ¥è¯¢ç³»ç»Ÿä¸­æŸ¥è¯¢é“¾è·¯ï¼Œçœ‹çœ‹å…·ä½“æ˜¯å“ªä¸ªç³»ç»Ÿçš„é—®é¢˜ï¼Œç„¶åå†åšå…·ä½“çš„æ’æŸ¥ã€‚&lt;/p&gt;
&lt;p&gt;ç±»ä¼¼äºè¿™æ ·ï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/05/mP97tShHKrGXge2.png&quot;&gt;&lt;br&gt;æ—¥å¿—ä¸­ä¼šæ‰“å° &lt;code&gt;trace_id&lt;/code&gt; å’Œ &lt;code&gt;span_id&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¦‚æœæ—¥å¿—ç³»ç»Ÿåšçš„æ¯”è¾ƒå®Œå–„çš„è¯ï¼Œè¿˜å¯ä»¥ç›´æ¥ç‚¹å‡» &lt;code&gt;trace_id&lt;/code&gt; è·³è½¬åˆ°é“¾è·¯ç³»ç»Ÿé‡Œç›´æ¥æŸ¥è¯¢é“¾è·¯ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetry å®æˆ˜ï¼šgRPC ç›‘æ§çš„å®ç°åŸç†</title>
    <link href="http://crossoverjie.top/2024/08/29/ob/OpenTelemetry-grpc-principle/"/>
    <id>http://crossoverjie.top/2024/08/29/ob/OpenTelemetry-grpc-principle/</id>
    <published>2024-08-29T06:50:33.000Z</published>
    <updated>2024-09-03T15:08:51.463Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><img src="https://s2.loli.net/2024/07/29/uUTYr8lziEABk4d.png"></p><p>æœ€è¿‘åœ¨ç»™ <code>opentelemetry-java-instrumentation</code> æäº¤äº†ä¸€ä¸ª <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/11833">PR</a>ï¼Œæ˜¯å…³äºç»™ gRPC æ–°å¢å››ä¸ª metricsï¼š</p><ul><li><code>rpc.client.request.size</code>: å®¢æˆ·ç«¯è¯·æ±‚åŒ…å¤§å°</li><li><code>rpc.client.response.size</code>ï¼šå®¢æˆ·ç«¯æ”¶åˆ°çš„å“åº”åŒ…å¤§å°</li><li><code>rpc.server.request.size</code>ï¼šæœåŠ¡ç«¯æ”¶åˆ°çš„è¯·æ±‚åŒ…å¤§å°</li><li><code>rpc.server.response.size</code>ï¼šæœåŠ¡ç«¯å“åº”çš„è¯·æ±‚åŒ…å¤§å°</li></ul><p>è¿™ä¸ª PR çš„ä¸»è¦ç›®çš„å°±æ˜¯èƒ½å¤Ÿåœ¨æŒ‡æ ‡ç›‘æ§ä¸­æ‹¿åˆ° <code>RPC</code> è¯·æ±‚çš„åŒ…å¤§å°ï¼Œè€Œè¿™é‡Œçš„å…³é”®å°±æ˜¯å¦‚ä½•æ‰èƒ½æ‹¿åˆ°è¿™äº›åŒ…çš„å¤§å°ã€‚</p><span id="more"></span><p>é¦–å…ˆæ”¯æŒçš„æ˜¯ <code>gRPC</code>ï¼ˆç›®å‰åœ¨äº‘åŸç”Ÿé¢†åŸŸä½¿ç”¨çš„æœ€å¤šï¼‰ï¼Œå…¶ä½™çš„ RPC ç†è®ºä¸Šä¹Ÿæ˜¯å¯ä»¥æ”¯æŒçš„ï¼š<br><img src="https://s2.loli.net/2024/07/29/efGYRktoK8IESzP.png"></p><p>åœ¨å®ç°çš„è¿‡ç¨‹ä¸­æˆ‘ä¹Ÿæ¯”è¾ƒå¥½å¥‡ <code>OpenTelemetry</code> æ¡†æ¶æ˜¯å¦‚ä½•ç»™ <code>gRPC</code> è¯·æ±‚åˆ›å»º <code>span</code> è°ƒç”¨é“¾çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://s2.loli.net/2024/07/15/skNmSDJaPfHh3GB.png" alt="image.png"><br><img src="https://s2.loli.net/2024/07/15/xoG2finOmFlDReE.png" alt="image.png"></p><blockquote><p>è¿™æ˜¯ä¸€ä¸ª gRPC è¿œç¨‹è°ƒç”¨ï¼Œjava-demo æ˜¯ gRPC çš„å®¢æˆ·ç«¯ï¼Œk8s-combat æ˜¯ gRPC çš„æœåŠ¡ç«¯</p></blockquote><p>åœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬å¯ä»¥æ ¹æ® <code>OpenTelemetry</code> çš„è¿è¡ŒåŸç†å¤§æ¦‚çŒœæµ‹ä¸‹å®ƒçš„å®ç°è¿‡ç¨‹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬åº”ç”¨å¯ä»¥åˆ›å»ºè¿™äº›é“¾è·¯ä¿¡æ¯çš„å‰ææ˜¯ï¼šä½¿ç”¨äº† <code>OpenTelemetry</code> æä¾›çš„ <code>javaagent</code>ï¼Œè¿™ä¸ª agent çš„åŸç†æ˜¯åœ¨è¿è¡Œæ—¶ä½¿ç”¨äº† <a href="https://github.com/raphw/byte-buddy">byte-buddy</a> å¢å¼ºäº†æˆ‘ä»¬åº”ç”¨çš„å­—èŠ‚ç ï¼Œåœ¨è¿™äº›å­—èŠ‚ç ä¸­ä»£ç†ä¸šåŠ¡é€»è¾‘ï¼Œä»è€Œå¯ä»¥åœ¨ä¸å½±å“ä¸šåŠ¡çš„å‰æä¸‹å¢å¼ºæˆ‘ä»¬çš„ä»£ç ï¼ˆåªè¦å°±æ˜¯åˆ›å»º spanã€metrics ç­‰æ•°æ®ï¼‰</p><blockquote><p>Spring çš„ä¸€äº›ä»£ç†é€»è¾‘ä¹Ÿæ˜¯è¿™æ ·å®ç°çš„</p></blockquote><h1 id="gRPC-å¢å¼ºåŸç†"><a href="#gRPC-å¢å¼ºåŸç†" class="headerlink" title="gRPC å¢å¼ºåŸç†"></a>gRPC å¢å¼ºåŸç†</h1><p>è€Œåœ¨å·¥ç¨‹å®ç°ä¸Šï¼Œæˆ‘ä»¬æœ€å¥½æ˜¯ä¸èƒ½å¯¹ä¸šåŠ¡ä»£ç è¿›è¡Œå¢å¼ºï¼Œè€Œæ˜¯è¦æ‰¾åˆ°è¿™äº›æ¡†æ¶æä¾›çš„æ‰©å±•æ¥å£ã€‚</p><p>æ‹¿ <code>gRPC</code> æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ‰€æä¾›çš„ <code>io.grpc.ClientInterceptor</code> å’Œ <code>io.grpc.ServerInterceptor</code> æ¥å£æ¥å¢å¼ºä»£ç ã€‚</p><p>æ‰“å¼€ <code>io.opentelemetry.instrumentation.grpc.v1_6.TracingClientInterceptor</code> ç±»æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå°±æ˜¯å®ç°äº† <code>io.grpc.ClientInterceptor</code>ï¼š<br><img src="https://s2.loli.net/2024/07/29/dVaESmoXIwJC6Li.png"></p><p>è€Œå…¶ä¸­æœ€å…³é”®çš„å°±æ˜¯è¦å®ç° <code>io.grpc.ClientInterceptor#interceptCall</code> å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> &lt;REQUEST, RESPONSE&gt; ClientCall&lt;REQUEST, RESPONSE&gt; <span class="title function_">interceptCall</span><span class="params">(  </span></span><br><span class="line"><span class="params">    MethodDescriptor&lt;REQUEST, RESPONSE&gt; method, CallOptions callOptions, Channel next)</span> &#123;  </span><br><span class="line">  <span class="type">GrpcRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GrpcRequest</span>(method, <span class="literal">null</span>, <span class="literal">null</span>, next.authority());  </span><br><span class="line">  <span class="type">Context</span> <span class="variable">parentContext</span> <span class="operator">=</span> Context.current();  </span><br><span class="line">  <span class="keyword">if</span> (!instrumenter.shouldStart(parentContext, request)) &#123;  </span><br><span class="line">    <span class="keyword">return</span> next.newCall(method, callOptions);  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> instrumenter.start(parentContext, request);  </span><br><span class="line">  ClientCall&lt;REQUEST, RESPONSE&gt; result;  </span><br><span class="line">  <span class="keyword">try</span> (<span class="type">Scope</span> <span class="variable">ignored</span> <span class="operator">=</span> context.makeCurrent()) &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">      <span class="comment">// call other interceptors  </span></span><br><span class="line">      result = next.newCall(method, callOptions);  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </span><br><span class="line">      instrumenter.end(context, request, Status.UNKNOWN, e);  </span><br><span class="line">      <span class="keyword">throw</span> e;  </span><br><span class="line">    &#125;  &#125;  </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TracingClientCall</span>&lt;&gt;(result, parentContext, context, request);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ¥å£æ˜¯ <code>gRPC</code> æä¾›çš„æ‹¦æˆªå™¨æ¥å£ï¼Œå¯¹äº <code>gRPC</code> å®¢æˆ·ç«¯æ¥è¯´å°±æ˜¯åœ¨å‘èµ·çœŸæ­£çš„ç½‘ç»œè°ƒç”¨å‰åä¼šæ‰§è¡Œçš„æ–¹æ³•ã€‚</p><p>æ‰€ä»¥åœ¨è¿™ä¸ªæ¥å£ä¸­æˆ‘ä»¬å°±å¯ä»¥å®ç°åˆ›å»º span è·å–åŒ…å¤§å°ç­‰é€»è¾‘ã€‚</p><h2 id="ä½¿ç”¨-byte-buddy-å¢å¼ºä»£ç "><a href="#ä½¿ç”¨-byte-buddy-å¢å¼ºä»£ç " class="headerlink" title="ä½¿ç”¨ byte-buddy å¢å¼ºä»£ç "></a>ä½¿ç”¨ byte-buddy å¢å¼ºä»£ç </h2><p>ä¸è¿‡æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬å®ç°çš„ <code>io.grpc.ClientInterceptor</code> ç±»éœ€è¦åŠ å…¥åˆ°æ‹¦æˆªå™¨ä¸­æ‰å¯ä»¥ä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">managedChannel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(host, port) .intercept(<span class="keyword">new</span> <span class="title class_">TracingClientInterceptor</span>()) <span class="comment">// åŠ å…¥æ‹¦æˆªå™¨</span></span><br><span class="line">.usePlaintext()</span><br><span class="line">.build();</span><br></pre></td></tr></table></figure><p>ä½†åœ¨ <code>javaagent</code> ä¸­æ˜¯æ²¡æ³•ç»™ä¸šåŠ¡ä»£ç ä¸­åŠ ä¸Šè¿™æ ·çš„ä»£ç çš„ã€‚</p><p>æ­¤æ—¶å°±éœ€è¦ <a href="https://bytebuddy.net/#/">byte-buddy</a> ç™»åœºäº†ï¼Œå®ƒå¯ä»¥åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç ä»è€Œå®ç°ç±»ä¼¼äºä¿®æ”¹æºç çš„æ•ˆæœã€‚</p><p>åœ¨ <code>io.opentelemetry.javaagent.instrumentation.grpc.v1_6.GrpcClientBuilderBuildInstr umentation</code>  ç±»é‡Œå¯ä»¥çœ‹åˆ° <code>OpenTelemetry</code> æ˜¯å¦‚ä½•ä½¿ç”¨ <code>byte-buddy</code> çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ElementMatcher&lt;TypeDescription&gt; <span class="title function_">typeMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> extendsClass(named(<span class="string">&quot;io.grpc.ManagedChannelBuilder&quot;</span>))</span><br><span class="line">      .and(declaresField(named(<span class="string">&quot;interceptors&quot;</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(TypeTransformer transformer)</span> &#123;</span><br><span class="line">  transformer.applyAdviceToMethod(</span><br><span class="line">      isMethod().and(named(<span class="string">&quot;build&quot;</span>)),</span><br><span class="line">      GrpcClientBuilderBuildInstrumentation.class.getName() + <span class="string">&quot;$AddInterceptorAdvice&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unused&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AddInterceptorAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Advice</span>.OnMethodEnter(suppress = Throwable.class)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addInterceptor</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.This ManagedChannelBuilder&lt;?&gt; builder,</span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.FieldValue(<span class="string">&quot;interceptors&quot;</span>)</span> List&lt;ClientInterceptor&gt; interceptors) &#123;</span><br><span class="line">    VirtualField&lt;ManagedChannelBuilder&lt;?&gt;, Boolean&gt; instrumented =</span><br><span class="line">        VirtualField.find(ManagedChannelBuilder.class, Boolean.class);</span><br><span class="line">    <span class="keyword">if</span> (!Boolean.TRUE.equals(instrumented.get(builder))) &#123;</span><br><span class="line">      interceptors.add(<span class="number">0</span>, GrpcSingletons.CLIENT_INTERCEPTOR);</span><br><span class="line">      instrumented.set(builder, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™é‡Œçš„æºç å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨äº† <code>byte-buddy</code> æ‹¦æˆªäº† <code>io.grpc.ManagedChannelBuilder#intercept(java.util.List&lt;io.grpc.ClientInterceptor&gt;)</code> å‡½æ•°ã€‚</p><blockquote><p>io.opentelemetry.javaagent.extension.matcher.AgentElementMatchers#extendsClass&#x2F; isMethod ç­‰å‡½æ•°éƒ½æ˜¯ byte-buddy åº“æä¾›çš„å‡½æ•°ã€‚</p></blockquote><p>è€Œè¿™ä¸ªå‡½æ•°æ­£å¥½å°±æ˜¯æˆ‘ä»¬éœ€è¦åœ¨ä¸šåŠ¡ä»£ç é‡ŒåŠ å…¥æ‹¦æˆªå™¨çš„åœ°æ–¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">interceptors.add(<span class="number">0</span>, GrpcSingletons.CLIENT_INTERCEPTOR);</span><br><span class="line">GrpcSingletons.CLIENT_INTERCEPTOR = <span class="keyword">new</span> <span class="title class_">TracingClientInterceptor</span>(clientInstrumenter, propagators);</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™è¡Œä»£ç å¯ä»¥æ‰‹åŠ¨å°† <code>OpenTelemetry</code> é‡Œçš„ <code>TracingClientInterceptor</code> åŠ å…¥åˆ°æ‹¦æˆªå™¨åˆ—è¡¨ä¸­ï¼Œå¹¶ä¸”ä½œä¸ºç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ã€‚</p><p>è€Œè¿™é‡Œçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">extendsClass(named(<span class="string">&quot;io.grpc.ManagedChannelBuilder&quot;</span>))</span><br><span class="line">        .and(declaresField(named(<span class="string">&quot;interceptors&quot;</span>)))</span><br></pre></td></tr></table></figure><p>é€šè¿‡å‡½æ•°çš„åç§°ä¹Ÿå¯ä»¥çœ‹å‡ºæ˜¯ä¸ºäº†æ‰¾åˆ° ç»§æ‰¿äº†<code>io.grpc.ManagedChannelBuilder</code> ç±»ä¸­å­˜åœ¨æˆå‘˜å˜é‡ <code>interceptors</code> çš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">transformer.applyAdviceToMethod(  </span><br><span class="line">    isMethod().and(named(<span class="string">&quot;build&quot;</span>)),  </span><br><span class="line">    GrpcClientBuilderBuildInstrumentation.class.getName() + <span class="string">&quot;$AddInterceptorAdvice&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨è°ƒç”¨ <code>build</code> å‡½æ•°åå°±ä¼šè¿›å…¥è‡ªå®šä¹‰çš„ <code>AddInterceptorAdvice</code> ç±»ï¼Œä»è€Œå°±å¯ä»¥æ‹¦æˆªåˆ°æ·»åŠ æ‹¦æˆªå™¨çš„é€»è¾‘ï¼Œç„¶åæŠŠè‡ªå®šä¹‰çš„æ‹¦æˆªå™¨åŠ å…¥å…¶ä¸­ã€‚</p><h1 id="è·å–-span-çš„-attribute"><a href="#è·å–-span-çš„-attribute" class="headerlink" title="è·å– span çš„ attribute"></a>è·å– span çš„ attribute</h1><p><img src="https://s2.loli.net/2024/07/29/dawSY4uQGmJo6qi.png"></p><p>æˆ‘ä»¬åœ¨ gRPC çš„é“¾è·¯ä¸­è¿˜å¯ä»¥çœ‹åˆ°è¿™ä¸ªè¯·æ±‚çš„å…·ä½“å±æ€§ï¼Œæ¯”å¦‚ï¼š</p><ul><li>gRPC æœåŠ¡æä¾›çš„ IP ç«¯å£ã€‚</li><li>è¯·æ±‚çš„å“åº”ç </li><li>è¯·æ±‚çš„ service å’Œ method</li><li>çº¿ç¨‹ç­‰ä¿¡æ¯ã€‚<blockquote><p>è¿™äº›ä¿¡æ¯åœ¨é—®é¢˜æ’æŸ¥è¿‡ç¨‹ä¸­éƒ½æ˜¯è‡³å…³é‡è¦çš„ã€‚</p></blockquote></li></ul><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ–°çš„ <code>attribute</code> ä¸»è¦æ˜¯åˆ†ä¸ºäº†ä¸‰ç±»ï¼š</p><ul><li><code>net.*</code> æ˜¯ç½‘ç»œç›¸å…³çš„å±æ€§</li><li><code>rpc.*</code> æ˜¯å’Œ grpc ç›¸å…³çš„å±æ€§</li><li><code>thread.*</code> æ˜¯çº¿ç¨‹ç›¸å…³çš„å±æ€§</li></ul><p>æ‰€ä»¥ç†è®ºä¸Šæˆ‘ä»¬åœ¨è®¾è®¡ API æ—¶æœ€å¥½å¯ä»¥å°†è¿™äº›ä¸åŒåˆ†ç»„çš„å±æ€§è§£è€¦å¼€ï¼Œå¦‚æœæ˜¯ MQ ç›¸å…³çš„å¯èƒ½è¿˜æœ‰ä¸€äº› topic ç­‰æ•°æ®ï¼Œæ‰€ä»¥å„ä¸ªå±æ€§ä¹‹é—´æ˜¯äº’ä¸å½±å“çš„ã€‚</p><p>å¸¦ç€è¿™ä¸ªæ€è·¯æˆ‘ä»¬æ¥çœ‹çœ‹ gRPC è¿™é‡Œæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">clientInstrumenterBuilder</span><br><span class="line">.setSpanStatusExtractor(GrpcSpanStatusExtractor.CLIENT)</span><br><span class="line">.addAttributesExtractors(additionalExtractors)</span><br><span class="line">        .addAttributesExtractor(RpcClientAttributesExtractor.create(rpcAttributesGetter))</span><br><span class="line">        .addAttributesExtractor(ServerAttributesExtractor.create(netClientAttributesGetter))</span><br><span class="line">        .addAttributesExtractor(NetworkAttributesExtractor.create(netClientAttributesGetter))</span><br></pre></td></tr></table></figure><p><code>OpenTelemetry</code> ä¼šæä¾›ä¸€ä¸ª <code>io.opentelemetry.instrumentation.api.instrumenter.InstrumenterBuilder#addAttributesExtractor</code>æ„å»ºå™¨å‡½æ•°ï¼Œç”¨äºå­˜æ”¾è‡ªå®šä¹‰çš„å±æ€§è§£æå™¨ã€‚</p><p>ä»è¿™é‡Œçš„æºç å¯ä»¥çœ‹å‡ºåˆ†åˆ«ä¼ å…¥äº†ç½‘ç»œç›¸å…³ã€RPC ç›¸å…³çš„è§£æå™¨ï¼›æ­£å¥½ä¹Ÿå°±å¯¹åº”äº†å›¾ä¸­çš„é‚£äº›å±æ€§ï¼Œä¹Ÿæ»¡è¶³äº†æˆ‘ä»¬åˆšæ‰æåˆ°çš„è§£è€¦ç‰¹æ€§ã€‚</p><p>è€Œæ¯ä¸€ä¸ªè‡ªå®šä¹‰å±æ€§è§£æå™¨éƒ½éœ€è¦å®ç°æ¥å£ <code>io.opentelemetry.instrumentation.api.instrumenter.AttributesExtractor</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AttributesExtractor</span>&lt;REQUEST, RESPONSE&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä»¥ <code>GrpcRpcAttributesGetter</code> ä¸ºä¾‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">GrpcRpcAttributesGetter</span> <span class="keyword">implements</span> <span class="title class_">RpcAttributesGetter</span>&lt;GrpcRequest&gt; &#123;</span><br><span class="line">  INSTANCE;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getSystem</span><span class="params">(GrpcRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;grpc&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getService</span><span class="params">(GrpcRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullMethodName</span> <span class="operator">=</span> request.getMethod().getFullMethodName();</span><br><span class="line">    <span class="type">int</span> <span class="variable">slashIndex</span> <span class="operator">=</span> fullMethodName.lastIndexOf(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (slashIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fullMethodName.substring(<span class="number">0</span>, slashIndex);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° system æ˜¯å†™æ­»çš„ <code>grpc</code>ï¼Œä¹Ÿå°±æ˜¯å¯¹äºåˆ°é¡µé¢ä¸Šçš„ <code>rpc.system</code> å±æ€§ã€‚</p><p>è€Œè¿™é‡Œçš„ <code>getService</code> å‡½æ•°åˆ™æ˜¯æ‹¿æ¥è·å– <code>rpc.service</code> å±æ€§çš„ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯é€šè¿‡ <code>gRPC</code> <code>çš„method</code> ä¿¡æ¯æ¥è·å– <code>service</code> çš„ã€‚</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RpcAttributesGetter</span>&lt;REQUEST&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Nullable</span>  </span><br><span class="line">  String <span class="title function_">getService</span><span class="params">(REQUEST request)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œè¿™é‡Œ <code>REQUEST</code> å…¶å®æ˜¯ä¸€ä¸ªæ³›å‹ï¼Œåœ¨ gRPC é‡Œæ˜¯ <code>GrpcRequest</code>ï¼Œåœ¨å…¶ä»– RPC é‡Œè¿™æ˜¯å¯¹åº”çš„ RPC çš„æ•°æ®ã€‚</p><p>è¿™ä¸ª <code>GrpcRequest</code> æ˜¯åœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨ä¸­åˆ›å»ºå¹¶ä¼ é€’çš„ã€‚<br><img src="https://s2.loli.net/2024/07/29/46mOv7XMoT81Bxl.png"></p><p>è€Œæˆ‘è¿™é‡Œéœ€è¦çš„è¯·æ±‚åŒ…å¤§å°ä¹Ÿæ˜¯åœ¨æ‹¦æˆªä¸­è·å–åˆ°æ•°æ®ç„¶åå†™å…¥è¿› GrpcRequestã€‚</p><p><img src="https://s2.loli.net/2024/07/29/A1zk79tVOr3DxnQ.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;T&gt; Long <span class="title function_">getBodySize</span><span class="params">(T message)</span> &#123;  </span><br><span class="line">  <span class="keyword">if</span> (message <span class="keyword">instanceof</span> MessageLite) &#123;  </span><br><span class="line">    <span class="keyword">return</span> (<span class="type">long</span>) ((MessageLite) message).getSerializedSize();  </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    <span class="comment">// Message is not a protobuf message  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥å®ç°ä¸åŒçš„ RPC ä¸­è·å–è‡ªå·±çš„ <code>attribute</code>ï¼ŒåŒæ—¶æ¯ä¸€ç»„ <code>attribute</code> ä¹Ÿéƒ½æ˜¯éš”ç¦»çš„ï¼Œäº’ç›¸è§£è€¦ã€‚</p><h1 id="è‡ªå®šä¹‰-metrics"><a href="#è‡ªå®šä¹‰-metrics" class="headerlink" title="è‡ªå®šä¹‰ metrics"></a>è‡ªå®šä¹‰ metrics</h1><p>æ¯ä¸ªæ’ä»¶è‡ªå®šä¹‰ Metrics çš„é€»è¾‘ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œéœ€è¦ç”±æ¡†æ¶å±‚é¢æä¾› API æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> InstrumenterBuilder&lt;REQUEST, RESPONSE&gt; <span class="title function_">addOperationMetrics</span><span class="params">(OperationMetrics factory)</span> &#123;  </span><br><span class="line">  operationMetrics.add(requireNonNull(factory, <span class="string">&quot;operationMetrics&quot;</span>));  </span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å®¢æˆ·ç«¯çš„ metrics</span></span><br><span class="line">.addOperationMetrics(RpcClientMetrics.get());</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœåŠ¡ç«¯çš„ metrics</span></span><br><span class="line">.addOperationMetrics(RpcServerMetrics.get());</span><br></pre></td></tr></table></figure><p>ä¹‹åä¹Ÿä¼šåœ¨æ¡†æ¶å±‚é¢å›è°ƒè¿™äº›è‡ªå®šä¹‰çš„ <code>OperationMetrics</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> (operationListeners.length != <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="comment">// operation listeners run after span start, so that they have access to the current span</span></span><br><span class="line">     <span class="comment">// for capturing exemplars</span></span><br><span class="line">     <span class="type">long</span> <span class="variable">startNanos</span> <span class="operator">=</span> getNanos(startTime);</span><br><span class="line">     <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; operationListeners.length; i++) &#123;</span><br><span class="line">       context = operationListeners[i].onStart(context, attributes, startNanos);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (operationListeners.length != <span class="number">0</span>) &#123;  </span><br><span class="line">  <span class="type">long</span> <span class="variable">endNanos</span> <span class="operator">=</span> getNanos(endTime);  </span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> operationListeners.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;  </span><br><span class="line">    operationListeners[i].onEnd(context, attributes, endNanos);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å…¶ä¸­æœ€å…³é”®çš„å°±æ˜¯ä¸¤ä¸ªå‡½æ•° onStart å’Œ onEndï¼Œåˆ†åˆ«ä¼šåœ¨å½“å‰è¿™ä¸ª span çš„å¼€å§‹å’Œç»“æŸæ—¶è¿›è¡Œå›è°ƒã€‚</p><p>æ‰€ä»¥é€šå¸¸çš„åšæ³•æ˜¯åœ¨ <code>onStart</code> å‡½æ•°ä¸­åˆå§‹åŒ–æ•°æ®ï¼Œç„¶ååœ¨ <code>onEnd</code> ç»“æŸæ—¶ç»Ÿè®¡ç»“æœï¼Œæœ€ç»ˆå¯ä»¥æ‹¿åˆ° metrics æ‰€éœ€è¦çš„æ•°æ®ã€‚</p><p>ä»¥è¿™ä¸ª <code>rpc.client.duration</code> å®¢æˆ·ç«¯çš„è¯·æ±‚è€—æ—¶æŒ‡æ ‡ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Context <span class="title function_">onStart</span><span class="params">(Context context, Attributes startAttributes, <span class="type">long</span> startNanos)</span> &#123;  </span><br><span class="line">  <span class="keyword">return</span> context.with(  </span><br><span class="line">      RPC_CLIENT_REQUEST_METRICS_STATE,  </span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AutoValue_RpcClientMetrics_State</span>(startAttributes, startNanos));  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEnd</span><span class="params">(Context context, Attributes endAttributes, <span class="type">long</span> endNanos)</span> &#123;  </span><br><span class="line">  <span class="type">State</span> <span class="variable">state</span> <span class="operator">=</span> context.get(RPC_CLIENT_REQUEST_METRICS_STATE);</span><br><span class="line"><span class="type">Attributes</span> <span class="variable">attributes</span> <span class="operator">=</span> state.startAttributes().toBuilder().putAll(endAttributes).build();  </span><br><span class="line">clientDurationHistogram.record(  </span><br><span class="line">    (endNanos - state.startTimeNanos()) / NANOS_PER_MS, attributes, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¼€å§‹æ—¶è®°å½•ä¸‹å½“å‰çš„æ—¶é—´ï¼Œç»“æŸæ—¶è·å–å½“å‰æ—¶é—´å’Œç»“æŸæ—¶é—´çš„å·®å€¼æ­£å¥½å°±æ˜¯è¿™ä¸ª span çš„æ‰§è¡Œæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯ rpc client çš„å¤„ç†æ—¶é—´ã€‚</p><p>åœ¨ <code>OpenTelemetry</code> ä¸­ç»å¤§å¤šæ•°çš„è¯·æ±‚æ—¶é—´éƒ½æ˜¯è¿™ä¹ˆè®°å½•çš„ã€‚</p><h1 id="Golang-å¢å¼º"><a href="#Golang-å¢å¼º" class="headerlink" title="Golang å¢å¼º"></a>Golang å¢å¼º</h1><p>è€Œåœ¨ <code>Golang</code> ä¸­å› ä¸ºæ²¡æœ‰ <a href="https://bytebuddy.net/#/">byte-buddy</a> è¿™ç§é­”æ³•åº“çš„å­˜åœ¨ï¼Œä¸å¯ä»¥ç›´æ¥ä¿®æ”¹æºç ï¼Œæ‰€ä»¥é€šå¸¸çš„åšæ³•è¿˜æ˜¯å¾—ç¡¬ç¼–ç æ‰è¡Œã€‚</p><p>è¿˜æ˜¯ä»¥ <code>gRPC</code> ä¸ºä¾‹ï¼Œæˆ‘ä»¬åœ¨åˆ›å»º gRPC server æ—¶å°±å¾—æŒ‡å®šä¸€ä¸ª <code>OpenTelemetry</code> æä¾›çš„å‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s := grpc.NewServer(  </span><br><span class="line">    grpc.StatsHandler(otelgrpc.NewServerHandler()),  </span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/07/29/RP9LWQVKSOF1d4Z.png"></p><p> åœ¨è¿™ä¸ª SDK ä¸­ä¹Ÿä¼šå®ç°åˆšæ‰åœ¨ Java é‡Œç±»ä¼¼çš„é€»è¾‘ï¼Œé™äºç¯‡å¹…å…·ä½“é€»è¾‘å°±ä¸ç»†è®²äº†ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šå°±æ˜¯ <code>gRPC</code> åœ¨ <code>OpenTelemetry</code> ä¸­çš„å…·ä½“å®ç°ï¼Œä¸»è¦å°±æ˜¯åœ¨æ‰¾åˆ°éœ€è¦å¢å¼ºæ¡†æ¶æ˜¯å¦æœ‰æä¾›æ‰©å±•çš„æ¥å£ï¼Œå¦‚æœæœ‰å°±ç›´æ¥ä½¿ç”¨è¯¥æ¥å£è¿›è¡ŒåŸ‹ç‚¹ã€‚</p><p>å¦‚æœæ²¡æœ‰é‚£å°±éœ€è¦æŸ¥çœ‹æºç ï¼Œæ‰¾åˆ°æ ¸å¿ƒé€»è¾‘ï¼Œå†ä½¿ç”¨ <code>byte-buddy</code> è¿›è¡ŒåŸ‹ç‚¹ã€‚</p><p><img src="https://s2.loli.net/2024/07/30/h1uvr3EjA9fGmzR.png"></p><p>æ¯”å¦‚ Pulsar å¹¶æ²¡æœ‰åœ¨å®¢æˆ·ç«¯æä¾›ä¸€äº›æ‰©å±•æ¥å£ï¼Œåªèƒ½æ‰¾åˆ°å®ƒçš„æ ¸å¿ƒå‡½æ•°è¿›è¡ŒåŸ‹ç‚¹ã€‚</p><p>è€Œåœ¨å…·ä½“åŸ‹ç‚¹è¿‡ç¨‹ä¸­ <code>OpenTelemetry</code> æä¾›äº†è®¸å¤šè§£è€¦çš„ APIï¼Œæ–¹ä¾¿æˆ‘ä»¬å®ç°åŸ‹ç‚¹æ‰€éœ€è¦çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¹Ÿä¼šåœ¨åç»­çš„æ–‡ç« ç»§ç»­åˆ†æ <code>OpenTelemetry</code> çš„ä¸€äº›è®¾è®¡åŸç†å’Œæ ¸å¿ƒ API çš„ä½¿ç”¨ã€‚</p><p>è¿™éƒ¨åˆ† API çš„è®¾è®¡æˆ‘è§‰å¾—æ˜¯ <code>OpenTelemetry</code> ä¸­æœ€å€¼å¾—å­¦ä¹ çš„åœ°æ–¹ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://bytebuddy.net/#/">https://bytebuddy.net/#/</a></li><li><a href="https://opentelemetry.io/docs/specs/semconv/rpc/rpc-metrics/#metric-rpcserverrequestsize">https://opentelemetry.io/docs/specs/semconv/rpc/rpc-metrics/#metric-rpcserverrequestsize</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/07/29/uUTYr8lziEABk4d.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æœ€è¿‘åœ¨ç»™ &lt;code&gt;opentelemetry-java-instrumentation&lt;/code&gt; æäº¤äº†ä¸€ä¸ª &lt;a href=&quot;https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/11833&quot;&gt;PR&lt;/a&gt;ï¼Œæ˜¯å…³äºç»™ gRPC æ–°å¢å››ä¸ª metricsï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;rpc.client.request.size&lt;/code&gt;: å®¢æˆ·ç«¯è¯·æ±‚åŒ…å¤§å°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;rpc.client.response.size&lt;/code&gt;ï¼šå®¢æˆ·ç«¯æ”¶åˆ°çš„å“åº”åŒ…å¤§å°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;rpc.server.request.size&lt;/code&gt;ï¼šæœåŠ¡ç«¯æ”¶åˆ°çš„è¯·æ±‚åŒ…å¤§å°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;rpc.server.response.size&lt;/code&gt;ï¼šæœåŠ¡ç«¯å“åº”çš„è¯·æ±‚åŒ…å¤§å°&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™ä¸ª PR çš„ä¸»è¦ç›®çš„å°±æ˜¯èƒ½å¤Ÿåœ¨æŒ‡æ ‡ç›‘æ§ä¸­æ‹¿åˆ° &lt;code&gt;RPC&lt;/code&gt; è¯·æ±‚çš„åŒ…å¤§å°ï¼Œè€Œè¿™é‡Œçš„å…³é”®å°±æ˜¯å¦‚ä½•æ‰èƒ½æ‹¿åˆ°è¿™äº›åŒ…çš„å¤§å°ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åº”ç”¨æŒ‡æ ‡ç›‘æ§</title>
    <link href="http://crossoverjie.top/2024/08/27/ob/OpenTelemetry-02-metrics/"/>
    <id>http://crossoverjie.top/2024/08/27/ob/OpenTelemetry-02-metrics/</id>
    <published>2024-08-27T06:53:35.000Z</published>
    <updated>2024-08-27T14:42:10.419Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ï¼š<a href="https://juejin.cn/post/7391744486979076146">OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª</a>è®²è§£äº†é“¾è·¯ç›¸å…³çš„å®æˆ˜ï¼Œæœ¬æ¬¡æˆ‘ä»¬ç»§ç»­è·Ÿè¿›å¦‚ä½•ä½¿ç”¨ OpenTelemetry é›†æˆ metrics ç›‘æ§ã€‚</p><blockquote><p>å»ºè®®å¯¹æŒ‡æ ‡ç›‘æ§ä¸å¤ªç†Ÿçš„æœ‹å‹å¯ä»¥å…ˆæŸ¥çœ‹è¿™ç¯‡å‰èœæ–‡ç« ï¼š<a href="https://crossoverjie.top/2024/06/13/ob/OpenTelemetry-metrics-concept/">ä» Prometheus åˆ° OpenTelemetryï¼šæŒ‡æ ‡ç›‘æ§çš„æ¼”è¿›ä¸å®è·µ</a></p></blockquote><span id="more"></span><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th><th>è¯­è¨€</th><th>ç‰ˆæœ¬</th></tr></thead><tbody><tr><td>java-demo</td><td>å‘é€ gRPC è¯·æ±‚çš„å®¢æˆ·ç«¯</td><td>Java</td><td>opentelemetry-agent: 2.4.0&#x2F;SpringBoot: 2.7.14</td></tr><tr><td><a href="https://github.com/crossoverJie/k8s-combat">k8s-combat</a></td><td>æä¾› gRPC æœåŠ¡çš„æœåŠ¡ç«¯</td><td>Golang</td><td>go.opentelemetry.io&#x2F;otel: 1.28&#x2F; Go: 1.22</td></tr><tr><td><a href="https://www.jaegertracing.io/">Jaeger</a></td><td>trace å­˜å‚¨çš„æœåŠ¡ç«¯ä»¥åŠ TraceUI å±•ç¤º</td><td>Golang</td><td>jaegertracing&#x2F;all-in-one:1.56</td></tr><tr><td><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib">opentelemetry-collector-contrib</a></td><td>OpenTelemetry çš„ collector æœåŠ¡ç«¯ï¼Œç”¨äºæ”¶é›† trace&#x2F;metrics&#x2F;logs ç„¶åå†™å…¥åˆ°è¿œç«¯å­˜å‚¨</td><td>Golang</td><td>otel&#x2F;opentelemetry-collector-contrib:0.98.0</td></tr><tr><td><a href="https://prometheus.io/">Prometheus</a></td><td>ä½œä¸º metrics çš„å­˜å‚¨å’Œå±•ç¤ºç»„ä»¶ï¼Œä¹Ÿå¯ä»¥ç”¨ <a href="https://github.com/VictoriaMetrics/VictoriaMetrics">VictoriaMetrics</a> ç­‰å…¼å®¹ Prometheus çš„å­˜å‚¨æ›¿ä»£ã€‚</td><td>Golang</td><td>quay.io&#x2F;prometheus&#x2F;prometheus:v2.49.1</td></tr></tbody></table><p><img src="https://s2.loli.net/2024/07/22/oUPjd4KlX7niBaI.png" alt="image.png"></p><h1 id="å¿«é€Ÿå¼€å§‹"><a href="#å¿«é€Ÿå¼€å§‹" class="headerlink" title="å¿«é€Ÿå¼€å§‹"></a>å¿«é€Ÿå¼€å§‹</h1><p>ä»¥ä¸Šæ˜¯åŠ å…¥ metrics ä¹‹åçš„æµç¨‹å›¾ï¼Œåœ¨åŸæœ‰çš„åŸºç¡€ä¸Šä¼šæ–°å¢ä¸€ä¸ª <code>Prometheus</code> ç»„ä»¶ï¼Œcollector ä¼šå°† metrics æŒ‡æ ‡æ•°æ®é€šè¿‡è¿œç¨‹çš„ remote write çš„æ–¹å¼å†™å…¥åˆ° Prometheus ä¸­ã€‚</p><p>Prometheus ä¸ºäº†èƒ½å…¼å®¹ OpenTelemetry å†™å…¥è¿‡æ¥çš„æ•°æ®ï¼Œéœ€è¦å¼€å¯ç›¸å…³<a href="https://prometheus.io/docs/prometheus/latest/feature_flags/#otlp-receiver">ç‰¹æ€§</a>æ‰å¯ä»¥ã€‚</p><p>å¦‚æœæ˜¯ docker å¯åŠ¨çš„è¯éœ€è¦ä¼ å…¥ç›¸å…³å‚æ•°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run  -d -p 9292:9090 --name prometheus \</span><br><span class="line">-v /prometheus/prometheus.yml:/etc/prometheus/prometheus.yml \</span><br><span class="line">quay.io/prometheus/prometheus:v2.49.1 \</span><br><span class="line">--config.file=/etc/prometheus/prometheus.yml \</span><br><span class="line">--storage.tsdb.path=/prometheus \</span><br><span class="line">--web.console.libraries=/etc/prometheus/console_libraries \</span><br><span class="line">--web.console.templates=/etc/prometheus/consoles \</span><br><span class="line">--enable-feature=exemplar-storage \</span><br><span class="line">--enable-feature=otlp-write-receiver</span><br></pre></td></tr></table></figure><p><code>--enable-feature=otlp-write-receiver</code> æœ€ä¸»è¦çš„å°±æ˜¯è¿™ä¸ªå‚æ•°ï¼Œç”¨äºå¼€å¯æ¥æ”¶ OTLP æ ¼å¼çš„æ•°æ®ã€‚</p><p>ä½†ä½¿ç”¨è¿™ä¸ª Push ç‰¹æ€§å°±ä¼šä¸§å¤±æ‰ Prometheus çš„è®¸å¤š Pull ç‰¹æ€§ï¼Œæ¯”å¦‚æœåŠ¡å‘ç°ï¼Œå®šæ—¶æŠ“å–ç­‰ï¼Œä¸è¿‡ä¹Ÿè¿˜å¥½ï¼ŒPush å’Œ Pull å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼ŒåŸæœ¬ä½¿ç”¨ Pull æŠ“å–çš„ç»„ä»¶ä¾ç„¶ä¸å—å½±å“ã€‚</p><h2 id="ä¿®æ”¹-OpenTelemetry-Collector"><a href="#ä¿®æ”¹-OpenTelemetry-Collector" class="headerlink" title="ä¿®æ”¹ OpenTelemetry-Collector"></a>ä¿®æ”¹ OpenTelemetry-Collector</h2><p>æ¥ç€æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸‹ Collector çš„é…ç½®:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">debug:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">&quot;jaeger:4317&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">otlphttp/prometheus:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">http://prometheus:9292/api/v1/otlp</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span>      </span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="attr">batch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">traces:</span></span><br><span class="line">      <span class="attr">receivers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlp</span></span><br><span class="line">      <span class="attr">processors:</span> [<span class="string">batch</span>]</span><br><span class="line">      <span class="attr">exporters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">debug</span>        </span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">exporters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlphttp/prometheus</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">debug</span></span><br><span class="line">      <span class="attr">processors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">      <span class="attr">receivers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlp</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬åœ¨ <code>exporter</code> ä¸­æ–°å¢äº†ä¸€ä¸ª <code>otlphttp/prometheus</code> çš„èŠ‚ç‚¹ï¼Œç”¨äºæŒ‡å®šå¯¼å‡º <code>prometheus</code> çš„ <code>endpoint</code> åœ°å€ã€‚</p><p>åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦åœ¨ <code>server.metrics.exporters</code> ä¸­é…ç½®ç›¸åŒçš„ key: <code>otlphttp/prometheus</code>ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œæˆ‘ä»¬ä¸€å®šå¾—æ˜¯é…ç½®åœ¨ <code>metrics.exporters</code> è¿™ä¸ªèŠ‚ç‚¹ä¸‹ï¼Œå¦‚æœé…ç½®åœ¨ <code>traces.exporters</code> ä¸‹æ—¶ï¼Œç›¸å½“äºæ˜¯å‘Šè¯‰ collector è®² trace çš„æ•°æ®å¯¼å‡ºåˆ° <code>otlphttp/prometheus.endpoint</code> è¿™ä¸ª endpoint é‡Œäº†ã€‚</p><blockquote><p>æ‰€ä»¥é‡ç‚¹æ˜¯éœ€è¦ç†è§£è¿™é‡Œçš„é…å¯¹å…³ç³»ã€‚</p></blockquote><h2 id="è¿è¡Œæ•ˆæœ"><a href="#è¿è¡Œæ•ˆæœ" class="headerlink" title="è¿è¡Œæ•ˆæœ"></a>è¿è¡Œæ•ˆæœ</h2><p>è¿™æ ·æˆ‘ä»¬åªéœ€è¦å°†åº”ç”¨å¯åŠ¨ä¹‹åå°±å¯ä»¥åœ¨ Prometheus ä¸­æŸ¥è¯¢åˆ°åº”ç”¨ä¸ŠæŠ¥çš„æŒ‡æ ‡äº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.traces.exporter=otlp \</span><br><span class="line">-Dotel.metrics.exporter=otlp \</span><br><span class="line">-Dotel.logs.exporter=none \</span><br><span class="line">-Dotel.service.name=java-demo \</span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \</span><br><span class="line">-Dotel.propagators=tracecontext,baggage \</span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 -jar target/demo-0.0.1-SNAPSHOT.jar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Run go app</span></span><br><span class="line">export OTEL_EXPORTER_OTLP_ENDPOINT=http://127.0.0.1:5317 OTEL_RESOURCE_ATTRIBUTES=service.name=k8s-combat</span><br><span class="line">./k8s-combat</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬åœ¨ collector ä¸­å¼€å¯äº† Debug çš„ exporterï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2024-07-22T06:34:08.060ZinfoMetricsExporter&#123;&quot;kind&quot;: &quot;exporter&quot;, &quot;data_type&quot;: &quot;metrics&quot;, &quot;name&quot;: &quot;debug&quot;, &quot;resource metrics&quot;: 1, &quot;metrics&quot;: 18, &quot;data points&quot;: 44&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æ˜¯å¯ä»¥è¯´æ˜æŒ‡æ ‡ä¸Šä¼ æˆåŠŸçš„ã€‚</p><p>ç„¶åæˆ‘ä»¬æ‰“å¼€ <code>Prometheus</code> çš„åœ°å€ï¼š<a href="http://127.0.0.1:9292/graph">http://127.0.0.1:9292/graph</a><br>ä¾¿å¯ä»¥æŸ¥è¯¢åˆ° Java åº”ç”¨å’Œ Go åº”ç”¨ä¸ŠæŠ¥çš„æŒ‡æ ‡ã€‚<br><img src="https://s2.loli.net/2024/07/22/O4TuE5WlFJ8Gyk1.png"></p><blockquote><p>OpenTelemetry çš„ javaagent ä¼šè‡ªåŠ¨ä¸ŠæŠ¥ JVM ç›¸å…³çš„æŒ‡æ ‡ã€‚</p></blockquote><hr><p>è€Œåœ¨ Go ç¨‹åºä¸­æˆ‘ä»¬è¿˜æ˜¯éœ€è¦æ˜¾å¼çš„é…ç½®ä¸€äº›åŸ‹ç‚¹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMeterProvider</span><span class="params">()</span></span> *sdkmetric.MeterProvider &#123;  </span><br><span class="line">    ctx := context.Background()  </span><br><span class="line">  </span><br><span class="line">    exporter, err := otlpmetricgrpc.New(ctx)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Printf(<span class="string">&quot;new otlp metric grpc exporter failed: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    mp := sdkmetric.NewMeterProvider(  </span><br><span class="line">       sdkmetric.WithReader(sdkmetric.NewPeriodicReader(exporter)),  </span><br><span class="line">       sdkmetric.WithResource(initResource()),  </span><br><span class="line">    )    otel.SetMeterProvider(mp)  </span><br><span class="line">    <span class="keyword">return</span> mp  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mp := initMeterProvider()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := mp.Shutdown(context.Background()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Error shutting down meter provider: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>å’Œ Tracer ç±»ä¼¼ï¼Œæˆ‘ä»¬é¦–å…ˆä¹Ÿå¾—åœ¨ main å‡½æ•°ä¸­è°ƒç”¨ <code>initMeterProvider()</code> å‡½æ•°æ¥åˆå§‹åŒ– Meterï¼Œæ­¤æ—¶å®ƒä¼šè¿”å›ä¸€ä¸ª <code>sdkmetric.MeterProvider</code> å¯¹è±¡ã€‚</p><p>OpenTelemetry Go çš„ SDK ä¸­å·²ç»æä¾›äº†å¯¹ go runtime çš„è‡ªåŠ¨åŸ‹ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ç›¸å…³å‡½æ•°å³å¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">err := runtime.Start(runtime.WithMinimumReadMemStatsInterval(time.Second))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬å¯åŠ¨åº”ç”¨ï¼Œåœ¨ Prometheus ä¸­å°±å¯ä»¥çœ‹åˆ°  Go  åº”ç”¨ä¸ŠæŠ¥çš„ç›¸å…³æŒ‡æ ‡äº†ã€‚<br><img src="https://s2.loli.net/2024/07/21/FAHrsZ5ap6SWNU7.png" alt="image.png"><br><img src="https://s2.loli.net/2024/07/22/pxWu4UREZ5PXng1.png"></p><blockquote><p>runtime_uptime_milliseconds_total  Go çš„è¿è¡Œæ—¶æŒ‡æ ‡</p></blockquote><p><code>Prometheus</code> ä¸­å±•ç¤ºæŒ‡æ ‡çš„ UI èƒ½åŠ›æœ‰é™ï¼Œé€šå¸¸æˆ‘ä»¬éƒ½æ˜¯é…åˆ <code>grafana</code> è¿›è¡Œå±•ç¤ºçš„ã€‚<br><img src="https://s2.loli.net/2024/07/22/A7HNl1zbfeI4JuR.png" alt="image.png"></p><h2 id="æ‰‹åŠ¨ä¸ŠæŠ¥æŒ‡æ ‡"><a href="#æ‰‹åŠ¨ä¸ŠæŠ¥æŒ‡æ ‡" class="headerlink" title="æ‰‹åŠ¨ä¸ŠæŠ¥æŒ‡æ ‡"></a>æ‰‹åŠ¨ä¸ŠæŠ¥æŒ‡æ ‡</h2><p>å½“ç„¶é™¤äº† SDK è‡ªåŠ¨ä¸ŠæŠ¥çš„æŒ‡æ ‡ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç±»ä¼¼äº trace é‚£æ ·æ‰‹åŠ¨ä¸ŠæŠ¥ä¸€äº›æŒ‡æ ‡ï¼›</p><p>æ¯”å¦‚æˆ‘å°±æƒ³è®°å½•æŸä¸ªå‡½æ•°è°ƒç”¨çš„æ¬¡æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> meter =  otel.Meter(<span class="string">&quot;test.io/k8s/combat&quot;</span>)  </span><br><span class="line">apiCounter, err = meter.Int64Counter(  </span><br><span class="line">    <span class="string">&quot;api.counter&quot;</span>,  </span><br><span class="line">    metric.WithDescription(<span class="string">&quot;Number of API calls.&quot;</span>),  </span><br><span class="line">    metric.WithUnit(<span class="string">&quot;&#123;call&#125;&quot;</span>),  </span><br><span class="line">)  </span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Err(err)  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">defer</span> apiCounter.Add(ctx, <span class="number">1</span>)  </span><br><span class="line">    <span class="keyword">return</span> &amp;pb.HelloReply&#123;Message: fmt.Sprintf(<span class="string">&quot;hostname:%s, in:%s, md:%v&quot;</span>, name, in.Name, md)&#125;, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªéœ€è¦åˆ›å»ºä¸€ä¸ª <code>Int64Counter</code> ç±»å‹çš„æŒ‡æ ‡ï¼Œç„¶ååœ¨éœ€è¦åŸ‹ç‚¹å¤„è°ƒç”¨å®ƒçš„å‡½æ•° <code>apiCounter.Add(ctx, 1)</code> å³å¯ã€‚</p><p><img src="https://s2.loli.net/2024/07/21/cSwCa4U7WuoJ82n.png" alt="image.png"><br>ä¹‹åä¾¿å¯ä»¥åœ¨ <code>Prometheus</code> ä¸­æŸ¥åˆ°è¿™ä¸ªæŒ‡æ ‡äº†ã€‚</p><p>é™¤æ­¤ä¹‹å¤– OpenTelemetry ä¸­çš„ metrics å®šä¹‰å’Œ Prometheus ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œè¿˜æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p><ul><li><strong>Counter</strong>ï¼šå•è°ƒé€’å¢è®¡æ•°å™¨ï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥è®°å½•è®¢å•æ•°ã€æ€»çš„è¯·æ±‚æ•°ã€‚</li><li><strong>UpDownCounter</strong>ï¼šä¸ Counter ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒå¯ä»¥é€’å‡ã€‚</li><li><strong>Gauge</strong>ï¼šç”¨äºè®°å½•éšæ—¶åœ¨å˜åŒ–çš„å€¼ï¼Œæ¯”å¦‚å†…å­˜ä½¿ç”¨é‡ã€CPU ä½¿ç”¨é‡ç­‰ã€‚</li><li><strong>Histogram</strong>ï¼šé€šå¸¸ç”¨äºè®°å½•è¯·æ±‚å»¶è¿Ÿã€å“åº”æ—¶é—´ç­‰ã€‚</li></ul><p>åœ¨ Java ä¸­ä¹Ÿæä¾›æœ‰ç±»ä¼¼çš„ API å¯ä»¥å®Œæˆè‡ªå®šä¹‰æŒ‡æ ‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">messageInCounter = meter    </span><br><span class="line">        .counterBuilder(MESSAGE_IN_COUNTER)    </span><br><span class="line">        .setUnit(<span class="string">&quot;&#123;message&#125;&quot;</span>)    </span><br><span class="line">        .setDescription(<span class="string">&quot;The total number of messages received for this topic.&quot;</span>)    </span><br><span class="line">        .buildObserver();</span><br></pre></td></tr></table></figure><p>å¯¹äº Gauge ç±»å‹çš„æ•°æ®ç”¨æ³•å¦‚ä¸‹ï¼Œä½¿ç”¨ <code>buildWithCallback</code> å›è°ƒå‡½æ•°ä¸ŠæŠ¥æ•°æ®ï¼Œ<code>OpenTelemetry</code> ä¼šåœ¨æ¡†æ¶å±‚é¢æ¯ 30s å›è°ƒä¸€æ¬¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerObservers</span><span class="params">()</span> &#123;      </span><br><span class="line">    <span class="type">Meter</span> <span class="variable">meter</span> <span class="operator">=</span> MetricsRegistration.getMeter();      </span><br><span class="line">      </span><br><span class="line">    meter.gaugeBuilder(<span class="string">&quot;pulsar_producer_num_msg_send&quot;</span>)      </span><br><span class="line">            .setDescription(<span class="string">&quot;The number of messages published in the last interval&quot;</span>)      </span><br><span class="line">            .ofLongs()      </span><br><span class="line">            .buildWithCallback(      </span><br><span class="line">                    r -&gt; recordProducerMetrics(r, ProducerStats::getNumMsgsSent));  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recordProducerMetrics</span><span class="params">(ObservableLongMeasurement observableLongMeasurement, Function&lt;ProducerStats, Long&gt; getter)</span> &#123;      </span><br><span class="line">    <span class="keyword">for</span> (Producer producer : CollectionHelper.PRODUCER_COLLECTION.list()) &#123;      </span><br><span class="line">        <span class="type">ProducerStats</span> <span class="variable">stats</span> <span class="operator">=</span> producer.getStats();      </span><br><span class="line">        <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> producer.getTopic();      </span><br><span class="line">        <span class="keyword">if</span> (topic.endsWith(RetryMessageUtil.RETRY_GROUP_TOPIC_SUFFIX)) &#123;      </span><br><span class="line">            <span class="keyword">continue</span>;      </span><br><span class="line">        &#125;        observableLongMeasurement.record(getter.apply(stats),      </span><br><span class="line">                Attributes.of(PRODUCER_NAME, producer.getProducerName(), TOPIC, topic));      </span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure><p>æ›´å¤šå…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£é“¾æ¥ï¼š<br><a href="https://opentelemetry.io/docs/languages/java/instrumentation/#metrics">https://opentelemetry.io/docs/languages/java/instrumentation/#metrics</a></p><p>å¦‚æœæˆ‘ä»¬ä¸æƒ³å°†æ•°æ®é€šè¿‡ collector è€Œæ˜¯ç›´æ¥ä¸ŠæŠ¥åˆ° Prometheus ä¸­ï¼Œä½¿ç”¨ OpenTelemetry æ¡†æ¶ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„ã€‚</p><p>æˆ‘ä»¬åªéœ€è¦é…ç½®ä¸‹ç¯å¢ƒå˜é‡:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export OTEL_METRICS_EXPORTER=prometheus</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è®¿é—® <a href="http://127.0.0.1:9464/metrics">http://127.0.0.1:9464/metrics</a> è·å–åˆ°å½“å‰åº”ç”¨æš´éœ²å‡ºæ¥çš„æŒ‡æ ‡ï¼Œæ­¤æ—¶å°±å¯ä»¥åœ¨ <code>Prometheus</code> é‡Œé…ç½®å¥½é‡‡é›† job æ¥è·å–æ•°æ®ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;k8s-combat&quot;</span></span><br><span class="line">    <span class="comment"># metrics_path defaults to &#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="comment"># scheme defaults to &#x27;http&#x27;.</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;k8s-combat:9464&quot;</span>]   </span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯å…¸å‹çš„ Pull æ¨¡å‹ï¼Œè€Œ OpenTelemetry æ¨èä½¿ç”¨çš„æ˜¯ Push æ¨¡å‹ï¼Œæ•°æ®ç”± OpenTelemetry è¿›è¡Œé‡‡é›†ç„¶åæ¨é€åˆ° Prometheusã€‚</p><p>è¿™ä¸¤ç§æ¨¡å¼å„æœ‰å¥½å¤„ï¼š</p><table><thead><tr><th></th><th>Pullæ¨¡å‹</th><th>Push æ¨¡å‹</th></tr></thead><tbody><tr><td>ä¼˜ç‚¹</td><td>å¯ä»¥åœ¨ä¸€ä¸ªé›†ä¸­çš„é…ç½®é‡Œç®¡ç†æ‰€æœ‰çš„æŠ“å–ç«¯ç‚¹ï¼Œä¹Ÿå¯ä»¥ä¸ºæ¯ä¸€ä¸ªåº”ç”¨å•ç‹¬é…ç½®æŠ“å–é¢‘æ¬¡ç­‰æ•°æ®ã€‚</td><td>åœ¨ OpenTelemetry çš„ collectorä¸­å¯ä»¥é›†ä¸­å¯¹æŒ‡æ ‡åšé¢„å¤„ç†ä¹‹åå†å°†è¿‡æ»¤åçš„æ•°æ®å†™å…¥ Prometheusï¼Œæ›´åŠ çš„çµæ´»ã€‚</td></tr><tr><td>ç¼ºç‚¹</td><td>1. é¢„å¤„ç†æŒ‡æ ‡æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€æœ‰çš„æ•°æ®æ˜¯åˆ°äº† Prometheus åå†ç»è¿‡relabelå¤„ç†åå†å†™å…¥å­˜å‚¨ã€‚<br>2. éœ€è¦é…ç½®æœåŠ¡å‘ç°</td><td>1. é¢å¤–éœ€è¦ç»´æŠ¤ä¸€ä¸ªç±»ä¼¼äº collector è¿™æ ·çš„æŒ‡æ ‡ç½‘å…³çš„ç»„ä»¶</td></tr></tbody></table><p>æ¯”å¦‚æˆ‘ä»¬æ˜¯ç”¨å’Œ Prometheus å…¼å®¹çš„ VictoriaMetrics é‡‡é›†äº† istio çš„ç›¸å…³æŒ‡æ ‡ï¼Œä½†é‡Œé¢çš„æŒ‡æ ‡å¤ªå¤šäº†ï¼Œæˆ‘ä»¬éœ€è¦åˆ é™¤æ‰ä¸€éƒ¨åˆ†ã€‚</p><p>å°±éœ€è¦åœ¨é‡‡é›†ä»»åŠ¡é‡Œç¼–å†™è§„åˆ™ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMPodScrape</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">isito-pod-scrape</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">podMetricsEndpoints:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">scheme:</span> <span class="string">http</span>  </span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">&quot;30s&quot;</span>  </span><br><span class="line">      <span class="attr">scrapeTimeout:</span> <span class="string">&quot;30s&quot;</span>  </span><br><span class="line">      <span class="attr">path:</span> <span class="string">/stats/prometheus</span>  </span><br><span class="line">      <span class="attr">metricRelabelConfigs:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">^envoy_.*|^url\_\_\_\_.*|istio_request_bytes_sum|istio_request_bytes_count|istio_response_bytes_sum|istio_request_bytes_sum|istio_request_duration_milliseconds_sum|istio_response_bytes_count|istio_request_duration_milliseconds_count|^ostrich_apigateway.*|istio_request_messages_total|istio_response_messages_total</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">drop_metrics</span>  </span><br><span class="line">  <span class="attr">namespaceSelector:</span>  </span><br><span class="line">    <span class="attr">any:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>æ¢æˆåœ¨ collector ä¸­å¤„ç†åï¼Œè¿™äº›é€»è¾‘éƒ½å¯ä»¥å…¨éƒ¨ç§»åŠ¨åˆ° collector ä¸­é›†ä¸­å¤„ç†ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>metrics çš„ä½¿ç”¨ç›¸å¯¹äº trace æ›´ç®€å•ä¸€äº›ï¼Œä¸éœ€è¦ç†è§£å¤æ‚çš„ contextã€span ç­‰æ¦‚å¿µï¼Œåªéœ€è¦ææ¸…æ¥šæœ‰å“ªå‡ ç§ metrics ç±»å‹ï¼Œåˆ†åˆ«åº”ç”¨åœ¨å“ªäº›ä¸åŒçš„åœºæ™¯å³å¯ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://prometheus.io/docs/prometheus/latest/feature_flags/#otlp-receiver">https://prometheus.io/docs/prometheus/latest/feature_flags/#otlp-receiver</a></li><li><a href="https://opentelemetry.io/docs/languages/java/instrumentation/#metrics">https://opentelemetry.io/docs/languages/java/instrumentation/#metrics</a></li><li><a href="https://opentelemetry.io/docs/languages/go/instrumentation/#metrics">https://opentelemetry.io/docs/languages/go/instrumentation/#metrics</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ï¼š&lt;a href=&quot;https://juejin.cn/post/7391744486979076146&quot;&gt;OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª&lt;/a&gt;è®²è§£äº†é“¾è·¯ç›¸å…³çš„å®æˆ˜ï¼Œæœ¬æ¬¡æˆ‘ä»¬ç»§ç»­è·Ÿè¿›å¦‚ä½•ä½¿ç”¨ OpenTelemetry é›†æˆ metrics ç›‘æ§ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å»ºè®®å¯¹æŒ‡æ ‡ç›‘æ§ä¸å¤ªç†Ÿçš„æœ‹å‹å¯ä»¥å…ˆæŸ¥çœ‹è¿™ç¯‡å‰èœæ–‡ç« ï¼š&lt;a href=&quot;https://crossoverjie.top/2024/06/13/ob/OpenTelemetry-metrics-concept/&quot;&gt;ä» Prometheus åˆ° OpenTelemetryï¼šæŒ‡æ ‡ç›‘æ§çš„æ¼”è¿›ä¸å®è·µ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª</title>
    <link href="http://crossoverjie.top/2024/08/20/ob/OpenTelemetry-01-trace/"/>
    <id>http://crossoverjie.top/2024/08/20/ob/OpenTelemetry-01-trace/</id>
    <published>2024-08-20T06:53:35.000Z</published>
    <updated>2024-08-20T06:35:59.105Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡ <a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</a>çš„æ–‡ç« ï¼Œä¸»è¦æ˜¯ä»æ¦‚å¿µä¸Šè®²è§£äº† Trace åœ¨ OpenTelemetry çš„ä¸­çš„åœºæ™¯å’Œä½¿ç”¨ã€‚</p><p>ä¹Ÿå†™è¿‡ä¸€ç¯‡ <a href="https://crossoverjie.top/2024/05/26/ob/OTel-demo/">å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯</a>ï¼šå¦‚ä½•ä»ä¸€ä¸ª demo å¼€å§‹é›†æˆ OpenTelemetryã€‚</p><p>ä½†è¿˜æ˜¯æœ‰ä¸å°‘å°ä¼™ä¼´åé¦ˆè¯´æ— æ³•å¿«é€Ÿä¸Šæ‰‹ï¼ˆå¯èƒ½ä¹Ÿæ˜¯è¿™ä¸ª demo çš„é¡¹ç›®æ¯”è¾ƒå¤šï¼‰ï¼Œäºæ˜¯æˆ‘å‡†å¤‡ä» 0 å¼€å§‹ä»çœŸå®çš„ä»£ç ä¸€æ­¥æ­¥å¸¦å¤§å®¶é›†æˆ <code>OpenTelemetry</code>ï¼Œå› ä¸º OpenTelemetry æœ¬èº«æ˜¯è·¨å¤šç§è¯­è¨€çš„ï¼Œæ‰€ä»¥ä¹Ÿä¼šä»¥ä¸¤ç§è¯­è¨€ä¸ºï¼ˆJavaã€Golangï¼‰ä¸»è¿›è¡Œè®²è§£ã€‚</p><blockquote><p>ä½¿ç”¨è¿™ä¸¤ç§è¯­è¨€ä¸»è¦æ˜¯å› ä¸º Java å‡ ä¹å…¨æ˜¯è‡ªåŠ¨åŸ‹ç‚¹ï¼Œè€Œ Golang å› ä¸ºè¯­è¨€ç‰¹æ€§ï¼Œå¤§éƒ¨åˆ†éƒ½å¾—ç¡¬ç¼–ç åŸ‹ç‚¹ï¼›è¦†ç›–åˆ°è¿™ä¸¤ç§åœºæ™¯åå…¶ä»–è¯­è¨€ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œé¡¶å¤šåªæ˜¯ API åç§°æœ‰äº›è®¸åŒºåˆ«ã€‚</p></blockquote><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿä¼šç©¿æ’ä¸€äº› OpenTelemetry çš„åŸç†ï¼Œå¸Œæœ›æ•´ä¸ªè¿‡ç¨‹ä¸‹æ¥å¤§å®¶å¯ä»¥åœ¨é¡¹ç›®ä¸­å®é™…è¿ç”¨èµ·æ¥ï¼ŒåŒæ—¶ä¹Ÿèƒ½çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p><span id="more"></span><h1 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h1><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹é¡¹ç›®ï¼š</p><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th><th>è¯­è¨€</th><th>ç‰ˆæœ¬</th></tr></thead><tbody><tr><td>java-demo</td><td>å‘é€ gRPC è¯·æ±‚çš„å®¢æˆ·ç«¯</td><td>Java</td><td>opentelemetry-agent: 2.4.0&#x2F;SpringBoot: 2.7.14</td></tr><tr><td>k8s-combat</td><td>æä¾› gRPC æœåŠ¡çš„æœåŠ¡ç«¯</td><td>Golang</td><td>go.opentelemetry.io&#x2F;otel: 1.28&#x2F; Go: 1.22</td></tr><tr><td>Jaeger</td><td>trace å­˜å‚¨çš„æœåŠ¡ç«¯ä»¥åŠ TraceUI å±•ç¤º</td><td>Golang</td><td>jaegertracing&#x2F;all-in-one:1.56</td></tr><tr><td>opentelemetry-collector-contrib</td><td>OpenTelemetry çš„ collector æœåŠ¡ç«¯ï¼Œç”¨äºæ”¶é›† trace&#x2F;metrics&#x2F;logs ç„¶åå†™å…¥åˆ°è¿œç«¯å­˜å‚¨</td><td>Golang</td><td>otel&#x2F;opentelemetry-collector-contrib:0.98.0</td></tr></tbody></table><p><img src="https://s2.loli.net/2024/07/15/u4BYXOkztqyUoEK.png" alt="image.png"></p><p>åœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹çœ‹å®é™…çš„æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŠŠ collector å’Œ Jaeger éƒ¨ç½²å¥½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -d --name jaeger \</span><br><span class="line">  -e COLLECTOR_ZIPKIN_HOST_PORT=:9411 \</span><br><span class="line">  -p 6831:6831/udp \</span><br><span class="line">  -p 6832:6832/udp \</span><br><span class="line">  -p 5778:5778 \</span><br><span class="line">  -p 16686:16686 \</span><br><span class="line">  -p 4317:4317 \</span><br><span class="line">  -p 4318:4318 \</span><br><span class="line">  -p 14250:14250 \</span><br><span class="line">  -p 14268:14268 \</span><br><span class="line">  -p 14269:14269 \</span><br><span class="line">  -p 9411:9411 \</span><br><span class="line">  jaegertracing/all-in-one:1.56</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run --rm -d -v $(pwd)/coll-config.yaml:/etc/otelcol-contrib/config.yaml --name coll \</span><br><span class="line">-p 5318:4318 \</span><br><span class="line">-p 5317:4317 \</span><br><span class="line">otel/opentelemetry-collector-contrib:0.98.0</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ª <code>coll-config</code> çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">protocols:</span></span><br><span class="line">      <span class="attr">grpc:</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">debug:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">&quot;127.0.0.1:4317&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="attr">batch:</span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">traces:</span></span><br><span class="line">      <span class="attr">receivers:</span> [<span class="string">otlp</span>]</span><br><span class="line">      <span class="attr">processors:</span> [<span class="string">batch</span>]</span><br><span class="line">      <span class="attr">exporters:</span> [<span class="string">otlp</span>, <span class="string">debug</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é‡ç‚¹æ˜¯è¿™é‡Œçš„ <code>endpoint: &quot;127.0.0.1:4317&quot;</code> æˆ‘ä»¬éœ€è¦é…ç½®ä½ Jaeger çš„ IP å’Œç«¯å£ã€‚</p><blockquote><p>æ›´å¤šå…³äºè¿™é‡Œçš„é…ç½®ä¼šåœ¨åç»­å•ç‹¬çš„ collector ç« èŠ‚ä¸­è®²è§£ã€‚</p></blockquote><p>è¿™ä¸¤ä¸ªæœåŠ¡éƒ½å¯åŠ¨æˆåŠŸåå†å¯åŠ¨æˆ‘ä»¬çš„ Java å®¢æˆ·ç«¯å’Œ  Go  æœåŠ¡ç«¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.traces.exporter=otlp \</span><br><span class="line">-Dotel.metrics.exporter=otlp \</span><br><span class="line">-Dotel.logs.exporter=none \</span><br><span class="line">-Dotel.service.name=demo \</span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \</span><br><span class="line">-Dotel.propagators=tracecontext,baggage \</span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Golang</span></span><br><span class="line">export OTEL_EXPORTER_OTLP_ENDPOINT=http://127.0.0.1:5317</span><br><span class="line">export OTEL_RESOURCE_ATTRIBUTES=service.name=k8s-combat</span><br><span class="line">./k8s-combat</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸ç®¡æ˜¯ Java è¿˜æ˜¯ Golang åº”ç”¨éƒ½æ˜¯éœ€è¦é…ç½® <code>OTEL_EXPORTER_OTLP_ENDPOINT</code> å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ <code>opentelemetry-collector-contrib</code> çš„åœ°å€ã€‚</p><blockquote><p>å…¶ä½™çš„ä¸€äº›é…ç½®åœ¨åé¢ä¼šè®²åˆ°ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:9191/request\?name\=1232</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è§¦å‘ä¸€ä¸‹ Java å®¢æˆ·ç«¯çš„å…¥å£ï¼Œå°±å¯ä»¥åœ¨ JaegerUI ä¸­æŸ¥è¯¢åˆ°åˆšæ‰çš„é“¾è·¯äº†ã€‚<br><code>http://localhost:16686/search</code></p><p><img src="https://s2.loli.net/2024/07/15/skNmSDJaPfHh3GB.png" alt="image.png"><br><img src="https://s2.loli.net/2024/07/15/xoG2finOmFlDReE.png" alt="image.png"><br>è¿™æ ·æ•´ä¸ª <code>trace</code> é“¾è·¯å°±ä¸²èµ·æ¥äº†ã€‚</p><h1 id="Java-åº”ç”¨"><a href="#Java-åº”ç”¨" class="headerlink" title="Java åº”ç”¨"></a>Java åº”ç”¨</h1><p>ä¸‹é¢æ¥çœ‹çœ‹å…·ä½“çš„åº”ç”¨ä»£ç é‡Œæ˜¯å¦‚ä½•ç¼–å†™çš„ã€‚</p><blockquote><p>Java æ˜¯åŸºäº springboot ç¼–å†™çš„ï¼Œå…·ä½“ springboot çš„ä½¿ç”¨å°±ä¸å†èµ˜è¿°äº†ã€‚</p></blockquote><p>å› ä¸ºæˆ‘ä»¬åº”ç”¨æ˜¯ä½¿ç”¨ gRPC é€šä¿¡çš„ï¼Œæ‰€ä»¥éœ€è¦æä¾›ä¸€ä¸ª <code>helloworld.proto</code> çš„ pb æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;  </span><br><span class="line">  </span><br><span class="line">option go_package = &quot;google.golang.org/grpc/examples/helloworld/helloworld&quot;;  </span><br><span class="line">option java_multiple_files = true;  </span><br><span class="line">option java_package = &quot;io.grpc.examples.helloworld&quot;;  </span><br><span class="line">option java_outer_classname = &quot;HelloWorldProto&quot;;  </span><br><span class="line">  </span><br><span class="line">package helloworld;  </span><br><span class="line">  </span><br><span class="line">// The greeting service definition.  </span><br><span class="line">service Greeter &#123;  </span><br><span class="line">  // Sends a greeting  </span><br><span class="line">  rpc SayHello (HelloRequest) returns (HelloReply) &#123;&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// The request message containing the user&#x27;s name.  </span><br><span class="line">message HelloRequest &#123;  </span><br><span class="line">  string name = 1;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// The response message containing the greetings  </span><br><span class="line">message HelloReply &#123;  </span><br><span class="line">  string message = 1;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶ä¹Ÿæ²¡å•¥å¥½è¯´çš„ï¼Œå°±å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„ <code>SayHello</code> æ¥å£ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.devh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨ Java ä¸­ä½¿ç”¨äº† <code>grpc-spring-boot-starter</code> è¿™ä¸ªåº“æ¥å¤„ç† gRPC çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¯·æ±‚ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">grpc:</span>  </span><br><span class="line">  <span class="attr">server:</span>  </span><br><span class="line">    <span class="attr">port:</span> <span class="number">9192</span>  </span><br><span class="line">  <span class="attr">client:</span>  </span><br><span class="line">    <span class="attr">greeter:</span>  </span><br><span class="line">      <span class="attr">address:</span> <span class="string">&#x27;static://127.0.0.1:50051&#x27;</span>  </span><br><span class="line">      <span class="attr">enableKeepAlive:</span> <span class="literal">true</span>  </span><br><span class="line">      <span class="attr">keepAliveWithoutCalls:</span> <span class="literal">true</span>  </span><br><span class="line">      <span class="attr">negotiationType:</span> <span class="string">plaintext</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ¥å£ç”¨äºæ¥æ”¶è¯·æ±‚è§¦å‘ <code>gRPC</code> çš„è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line">   log.info(<span class="string">&quot;request: &#123;&#125;&quot;</span>, request);    </span><br><span class="line">   <span class="type">HelloReply</span> <span class="variable">abc</span> <span class="operator">=</span> greeterStub.sayHello(io.grpc.examples.helloworld.HelloRequest.newBuilder().setName(request.getName()).build());   </span><br><span class="line">   <span class="keyword">return</span> abc.getMessage();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Java åº”ç”¨çš„å®ç°éå¸¸ç®€å•ï¼Œå’Œæˆ‘ä»¬æ—¥å¸¸æ—¥å¸¸å¼€å‘æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼›å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯åœ¨å¯åŠ¨æ—¶éœ€è¦åŠ å…¥ä¸€ä¸ª <code>javaagent</code>ä»¥åŠä¸€äº›å¯åŠ¨å‚æ•°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.traces.exporter=otlp \</span><br><span class="line">-Dotel.metrics.exporter=otlp \</span><br><span class="line">-Dotel.logs.exporter=none \</span><br><span class="line">-Dotel.service.name=demo \</span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \</span><br><span class="line">-Dotel.propagators=tracecontext,baggage \</span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ¥ä»”ç»†çœ‹çœ‹è¿™äº›å‚æ•°</p><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar</td><td>è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼ŒæŒ‡å®šä¸€ä¸ª javaagent</td></tr><tr><td>otel.traces.exporter</td><td>æŒ‡å®š trace ä»¥ä»€ä¹ˆæ ¼å¼ä¼ è¾“ï¼ˆé»˜è®¤æ˜¯è¿™é‡Œçš„ <code>otlp</code>)ï¼›å½“ç„¶è¿˜æœ‰å…¶ä»–çš„å€¼ï¼š<code>logging/jaeger/zipkin</code> ç­‰ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨ otlp ä¼šå°†æ•°æ®ä¼ è¾“åˆ° collector ä¸­ã€‚</td></tr><tr><td>otel.metrics.exporter</td><td>åŒä¸Šï¼Œåªæ˜¯æŒ‡å®šçš„æ˜¯ metrics çš„ä¼ è¾“æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ä¹‹åè®²è§£æŒ‡æ ‡çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</td></tr><tr><td>otel.service.name</td><td>å®šä¹‰åœ¨ trace ä¸­çš„åº”ç”¨åç§°ï¼Œspringboot ä¼šé»˜è®¤ä½¿ç”¨ <code>spring.application.name</code> è¿™ä¸ªå˜é‡ã€‚</td></tr><tr><td>otel.exporter.otlp.protocol</td><td>æŒ‡å®šä¼ è¾“åè®®ï¼›é™¤äº† grpc ä¹‹å¤–è¿˜æœ‰ <code>http/protobuf</code>ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ® trace å’Œ metrics åˆ†å¼€æŒ‡å®šï¼š<code>otel.exporter.otlp.traces.protocol/otel.exporter.otlp.metrics.protocol</code></td></tr><tr><td>otel.propagators</td><td>æŒ‡å®šæˆ‘ä»¬è·¨æœåŠ¡ä¼ æ’­ä¸Šä¸‹æ–‡çš„æ—¶å€™ä½¿ç”¨å“ªç§æ ¼å¼ï¼Œé»˜è®¤æ˜¯ <a href="https://www.w3.org/TR/trace-context/">W3C Trace Context</a>,<a href="https://www.w3.org/TR/baggage/">baggage</a>ï¼Œå½“ç„¶ä¹Ÿæœ‰å…¶ä»–çš„- <code>&quot;b3&quot;</code>:Â <a href="https://github.com/openzipkin/b3-propagation#single-header">B3 Single</a>ï¼Œ- <code>&quot;xray&quot;</code>:Â <a href="https://docs.aws.amazon.com/xray/latest/devguide/xray-concepts.html#xray-concepts-tracingheader">AWS X-Ray</a>ï¼Œ<code>&quot;jaeger&quot;</code>:Â <a href="https://www.jaegertracing.io/docs/1.21/client-libraries/#propagation-format">Jaeger</a>ç­‰</td></tr><tr><td>otel.exporter.otlp.endpoint</td><td>æŒ‡å®š collector çš„ endpoint</td></tr><tr><td>æ›´å¤šç»†èŠ‚çš„å‚æ•°å¤§å®¶å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼š</td><td></td></tr><tr><td><a href="https://opentelemetry.io/docs/languages/java/configuration/">https://opentelemetry.io/docs/languages/java/configuration/</a></td><td></td></tr></tbody></table><h1 id="Golang-åº”ç”¨"><a href="#Golang-åº”ç”¨" class="headerlink" title="Golang åº”ç”¨"></a>Golang åº”ç”¨</h1><p>æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹ Go æ˜¯å¦‚ä½•é›†æˆ <code>OpenTelemetry</code> çš„ã€‚</p><p>åœ¨åˆ›å»ºå¥½é¡¹ç›®ä¹‹åæˆ‘ä»¬éœ€è¦æ·»åŠ  <code>OpenTelemetry</code> æ‰€æä¾›çš„åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">go get &quot;go.opentelemetry.io/otel&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/exporters/otlp/otlpmetric/otlpmetricgrpc&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/propagation&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/sdk/metric&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/sdk/resource&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/sdk/trace&quot; \       &quot;go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc&quot;\</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªåˆå§‹åŒ– <code>tracer</code> çš„å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initTracerProvider</span><span class="params">()</span></span> *sdktrace.TracerProvider &#123;</span><br><span class="line">ctx := context.Background()</span><br><span class="line"></span><br><span class="line">exporter, err := otlptracegrpc.New(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;new otlp trace grpc exporter failed: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">tp := sdktrace.NewTracerProvider(</span><br><span class="line">sdktrace.WithBatcher(exporter),</span><br><span class="line">sdktrace.WithResource(initResource()),</span><br><span class="line">)</span><br><span class="line">otel.SetTracerProvider(tp)</span><br><span class="line">otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(propagation.TraceContext&#123;&#125;, propagation.Baggage&#123;&#125;))</span><br><span class="line"><span class="keyword">return</span> tp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <code>grpc</code> åè®®ä¸ŠæŠ¥ <code>otlp</code> æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>exporter, err := otlptracegrpc.New(ctx)</code>  åˆ›å»ºäº†ä¸€ä¸ª <code>exporter</code>ã€‚</p><p><code>otel.SetTextMapPropagator()</code> è¿™ä¸ªå‡½æ•°é‡Œé…ç½®æ•°æ®å’Œåˆšæ‰ Java é‡Œé…ç½®çš„ <code>-Dotel.propagators=tracecontext,baggage</code> æ˜¯ä¸€æ ·çš„æ•ˆæœã€‚</p><p>ä¸æ­¤åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦æä¾›ä¸€ä¸ª <code>initResource()</code> çš„å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initResource</span><span class="params">()</span></span> *sdkresource.Resource &#123;</span><br><span class="line">initResourcesOnce.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">extraResources, _ := sdkresource.New(</span><br><span class="line">context.Background(),</span><br><span class="line">sdkresource.WithOS(),</span><br><span class="line">sdkresource.WithProcess(),</span><br><span class="line">sdkresource.WithContainer(),</span><br><span class="line">sdkresource.WithHost(),</span><br><span class="line">)</span><br><span class="line">resource, _ = sdkresource.Merge(</span><br><span class="line">sdkresource.Default(),</span><br><span class="line">extraResources,</span><br><span class="line">)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> resource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ç”¨æ¥å‘Šè¯‰ trace éœ€è¦æš´éœ²é‚£äº› resourceï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°è¿›ç¨‹ç›¸å…³çš„å±æ€§ï¼š<br><img src="https://s2.loli.net/2024/07/15/Gveu4hNjWdYLiBo.png" alt="image.png"><br>æ¯”å¦‚è¿™é‡Œçš„ <code>sdkresource.WithOS(),</code> å°±ä¼šæ˜¾ç¤º OS çš„ç±»å‹å’Œæè¿°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithOS</span><span class="params">()</span></span> Option &#123;  </span><br><span class="line">    <span class="keyword">return</span> WithDetectors(  </span><br><span class="line">       osTypeDetector&#123;&#125;,  </span><br><span class="line">       osDescriptionDetector&#123;&#125;,  </span><br><span class="line">    )&#125;</span><br></pre></td></tr></table></figure><p>è€Œ <code>sdkresource.WithProcess(),</code> æ˜¾ç¤ºçš„æ•°æ®å°±æ›´å¤šäº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithProcess</span><span class="params">()</span></span> Option &#123;  </span><br><span class="line">    <span class="keyword">return</span> WithDetectors(  </span><br><span class="line">       processPIDDetector&#123;&#125;,  </span><br><span class="line">       processExecutableNameDetector&#123;&#125;,  </span><br><span class="line">       processExecutablePathDetector&#123;&#125;,  </span><br><span class="line">       processCommandArgsDetector&#123;&#125;,  </span><br><span class="line">       processOwnerDetector&#123;&#125;,  </span><br><span class="line">       processRuntimeNameDetector&#123;&#125;,  </span><br><span class="line">       processRuntimeVersionDetector&#123;&#125;,  </span><br><span class="line">       processRuntimeDescriptionDetector&#123;&#125;,  </span><br><span class="line">    )&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä»¥ä¸Šè¿™äº›ä»£ç åœ¨ Java ä¸­éƒ½æ˜¯ç”± agent æŒ‡å®šåˆ›å»ºçš„ã€‚</p></blockquote><hr><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Init OpenTelemetry start  </span></span><br><span class="line">tp := initTracerProvider()  </span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> err := tp.Shutdown(context.Background()); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Printf(<span class="string">&quot;Error shutting down tracer provider: %v&quot;</span>, err)  </span><br><span class="line">    &#125;&#125;()  </span><br><span class="line">   </span><br><span class="line">err := runtime.Start(runtime.WithMinimumReadMemStatsInterval(time.Second))  </span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Err(err)  </span><br><span class="line">&#125;</span><br><span class="line">tracer = tp.Tracer(<span class="string">&quot;k8s-combat&quot;</span>)</span><br><span class="line"><span class="comment">// Init OpenTelemetry end</span></span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬éœ€è¦åœ¨ main å‡½æ•°ä¸€å¼€å§‹å°±åˆå§‹åŒ– <code>traceProvider</code>ã€‚</p><p>å¯¹äº <code>grpc</code> æ¥è¯´ï¼Œ<code>OpenTelemetry</code> çš„ Go-SDK æä¾›äº†è‡ªåŠ¨åŸ‹ç‚¹ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¾—æ‰‹åŠ¨é…ç½®ä¸€ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s := grpc.NewServer(  </span><br><span class="line">    grpc.StatsHandler(otelgrpc.NewServerHandler()),  </span><br><span class="line">)  </span><br><span class="line">pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>grpc.StatsHandler(otelgrpc.NewServerHandler()),</code>  å°† <code>OTel</code> çš„ <code>serverHandle</code> åŠ å…¥è¿›å»ï¼Œè¿™ä¸ª handle ä¼šè‡ªåŠ¨åˆ›å»º <code>grpc</code> æœåŠ¡ç«¯çš„ <code>span</code>ã€‚</p><blockquote><p>å¯¹ trace&#x2F;span æ¦‚å¿µè¿˜æœ‰ä¸äº†è§£çš„æœ‹å‹å¯ä»¥æŸ¥çœ‹è¿™ç¯‡<a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">æ–‡ç« </a>ã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> port = <span class="string">&quot;:50051&quot;</span>  </span><br><span class="line">lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, port)  </span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Fatal().Msgf(<span class="string">&quot;failed to listen: %v&quot;</span>, err)  </span><br><span class="line">&#125;  </span><br><span class="line">s := grpc.NewServer(  </span><br><span class="line">    grpc.StatsHandler(otelgrpc.NewServerHandler()),  </span><br><span class="line">)  </span><br><span class="line">pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)  </span><br><span class="line"><span class="keyword">if</span> err := s.Serve(lis); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Fatal().Msgf(<span class="string">&quot;failed to serve: %v&quot;</span>, err)  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    log.Printf(<span class="string">&quot;served on %s \n&quot;</span>, port)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬åªéœ€è¦å¯åŠ¨è¿™ä¸ª grpc æœåŠ¡å³å¯ï¼Œå°±ç®—å®Œæˆäº† Go æœåŠ¡çš„é›†æˆã€‚</p><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡º Java ç›¸å¯¹äº Go æ¥è¯´ä¼šç®€å•è®¸å¤šï¼Œåªéœ€è¦é…ç½®ä¸€ä¸ª agent å°±å¯ä»¥ä¸è¯¥ä¸€è¡Œä»£ç æ”¯æŒç›®å‰å¸‚é¢ä¸Šæµè¡Œçš„ç»å¤§å¤šæ•°æ¡†æ¶ã€‚<br><img src="https://s2.loli.net/2024/04/17/kMDcrPwxJy4oZYe.png"></p><h1 id="è‡ªå®šä¹‰-span-çš„-attribute"><a href="#è‡ªå®šä¹‰-span-çš„-attribute" class="headerlink" title="è‡ªå®šä¹‰  span çš„ attribute"></a>è‡ªå®šä¹‰  span çš„ attribute</h1><p>æˆ‘ä»¬åœ¨çœ‹é“¾è·¯ä¿¡æ¯çš„æ—¶å€™å…¶å®çœ‹çš„æœ€å¤šçš„æ˜¯æŸä¸ª <code>span</code> é‡Œçš„ <code>attribute</code> æ•°æ®ï¼ˆæœ‰äº›åœ°æ–¹åˆç§°ä¸º <code>tag</code>)<br>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://s2.loli.net/2024/07/15/jrdkNCAZhi6UIvP.png"></p><p>è¿™é‡Œä¼šå±•ç¤ºå½“å‰ <code>span</code> çš„å„ç§ä¿¡æ¯ï¼Œä½†å¦‚æœæˆ‘ä»¬æƒ³è¦é¢å¤–åŠ ä¸€äº›è‡ªå·±å…³å¿ƒçš„æ•°æ®åº”è¯¥å¦‚ä½•æ·»åŠ å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">message HelloRequest &#123;  </span><br><span class="line">  string name = 1;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘ä»¬æƒ³çŸ¥é“è¿™ä¸ª grpc æ¥å£é‡Œçš„ name å‚æ•°ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºé‚£æ ·å±•ç¤ºåœ¨ span ä¸­ã€‚</p><p>å¥½åœ¨ <code>OpenTelemetry</code> å·²ç»è€ƒè™‘åˆ°ç±»ä¼¼çš„éœ€æ±‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">span := trace.SpanFromContext(ctx)  </span><br><span class="line">span.SetAttributes(attribute.String(<span class="string">&quot;request.name&quot;</span>, in.Name))</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ <code>span := trace.SpanFromContext(ctx)</code>  è·å–åˆ°å½“å‰çš„ spanï¼Œç„¶åè°ƒç”¨ <code>SetAttributes</code> å°±å¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„æ•°æ®äº†ã€‚</p><blockquote><p>å¯¹åº”çš„ Java ä¹Ÿæœ‰ç±»ä¼¼çš„å‡½æ•°ã€‚</p></blockquote><p>é™¤äº†æ–°å¢ <code>attribute</code> ä¹‹å¤–è¿˜å¯ä»¥æ–°å¢ Eventï¼ŒLink ç­‰æ•°æ®ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AddEvent adds an event with the provided name and options.  </span></span><br><span class="line">AddEvent(name <span class="type">string</span>, options ...EventOption)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// AddLink adds a link.  </span></span><br><span class="line"><span class="comment">// Adding links at span creation using WithLinks is preferred to calling AddLink  </span></span><br><span class="line"><span class="comment">// later, for contexts that are available during span creation, because head  </span></span><br><span class="line"><span class="comment">// sampling decisions can only consider information present during span creation.  </span></span><br><span class="line">AddLink(link Link)</span><br></pre></td></tr></table></figure><h1 id="è‡ªå®šä¹‰æ–°å¢-span"><a href="#è‡ªå®šä¹‰æ–°å¢-span" class="headerlink" title="è‡ªå®šä¹‰æ–°å¢ span"></a>è‡ªå®šä¹‰æ–°å¢ span</h1><p>åŒç†æˆ‘ä»¬å¯èƒ½ä¸å±€é™äºä¸ºæŸä¸ª span æ–°å¢ attributeï¼Œä¹Ÿæœ‰å¯èƒ½æƒ³è¦æ–°å¢ä¸€ä¸ªæ–°çš„ span æ¥è®°å½•å…³é”®çš„è°ƒç”¨ä¿¡æ¯ã€‚</p><blockquote><p>é»˜è®¤æƒ…å†µä¸‹åªæœ‰ OpenTelemetry å®ç°è¿‡çš„ç»„ä»¶çš„æ ¸å¿ƒå‡½æ•°æ‰ä¼šæœ‰ spanï¼Œè‡ªå·±ä»£ç é‡Œçš„å‡½æ•°è°ƒç”¨æ˜¯ä¸ä¼šåˆ›å»ºspan çš„ã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> span(ctx context.Context) &#123;  </span><br><span class="line">    ctx, span := tracer.Start(ctx, <span class="string">&quot;hello-span&quot;</span>)  </span><br><span class="line">    <span class="keyword">defer</span> span.End()  </span><br><span class="line">    <span class="comment">// do some work  </span></span><br><span class="line">    log.Printf(<span class="string">&quot;create span&quot;</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨  Go ä¸­åªéœ€è¦æ‰‹åŠ¨ Start ä¸€ä¸ª span å³å¯ã€‚</p><p>å¯¹åº”åˆ° <code>Java</code> ç¨å¾®ç®€å•ä¸€äº›ï¼Œåªéœ€è¦ä¸ºå‡½æ•°æ·»åŠ ä¸€ä¸ªæ³¨è§£å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WithSpan(&quot;span&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">span</span><span class="params">(<span class="meta">@SpanAttribute(&quot;request.name&quot;)</span> String name)</span> &#123;  </span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>);  </span><br><span class="line">    log.info(<span class="string">&quot;span:&#123;&#125;&quot;</span>, name);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªä¸è¿‡å¾—å•ç‹¬å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry.instrumentation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-instrumentation-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæˆ‘ä»¬åœ¨ Jaeger UI ä¸Šçœ‹åˆ°çš„æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2024/07/15/1tLlYezQwInZWDX.png"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><img src="https://s2.loli.net/2024/07/15/WXPp1MUkdHo4zam.png"></p><p>æœ€åæ€»ç»“ä¸€ä¸‹ï¼ŒOpenTelemetry æ”¯æŒè®¸å¤šæµè¡Œçš„è¯­è¨€ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šæ˜¯å¦æ”¯æŒè‡ªåŠ¨åŸ‹ç‚¹ã€‚</p><p><img src="https://s2.loli.net/2024/07/15/fvu67rdoxtZkq5m.png"></p><blockquote><p>è¿™é‡Œ Go ä¹Ÿå¯ä»¥é›¶ä»£ç åŸ‹ç‚¹ï¼Œæ˜¯ä½¿ç”¨äº† eBPFï¼Œæœ¬æ–‡æš‚ä¸åšä»‹ç»ã€‚</p></blockquote><p>å¯¹äºæ”¯æŒè‡ªåŠ¨åŸ‹ç‚¹çš„è¯­è¨€å°±å¾ˆç®€å•ï¼Œåªéœ€è¦é…ç½®ä¸‹ agent å³å¯ï¼›è€ŒåŸç”Ÿçš„ Go è¯­è¨€ä¸æ”¯æŒè‡ªåŠ¨åŸ‹ç‚¹å°±å¾—æ‰‹åŠ¨ä½¿ç”¨ OpenTelemetry æä¾›çš„ SDK å¤„ç†ä¸€äº›å…³é”®æ­¥éª¤ï¼›æ€»ä½“æ¥è¯´ä¹Ÿä¸ç®—å¤æ‚ã€‚</p><p>ä¸‹ä¸€æœŸä¼šé‡ç‚¹è®²è§£å¦‚ä½•ä½¿ç”¨ Metricsã€‚</p><p>æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ Go ç›¸å…³çš„æºç ï¼š</p><ul><li><a href="https://github.com/crossoverJie/k8s-combat">https://github.com/crossoverJie/k8s-combat</a></li></ul><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://opentelemetry.io/docs/languages/java/configuration/">https://opentelemetry.io/docs/languages/java/configuration/</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md</a></li><li><a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;ä¹‹å‰å†™è¿‡ä¸€ç¯‡ &lt;a href=&quot;https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/&quot;&gt;ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…&lt;/a&gt;çš„æ–‡ç« ï¼Œä¸»è¦æ˜¯ä»æ¦‚å¿µä¸Šè®²è§£äº† Trace åœ¨ OpenTelemetry çš„ä¸­çš„åœºæ™¯å’Œä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ä¹Ÿå†™è¿‡ä¸€ç¯‡ &lt;a href=&quot;https://crossoverjie.top/2024/05/26/ob/OTel-demo/&quot;&gt;å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯&lt;/a&gt;ï¼šå¦‚ä½•ä»ä¸€ä¸ª demo å¼€å§‹é›†æˆ OpenTelemetryã€‚&lt;/p&gt;
&lt;p&gt;ä½†è¿˜æ˜¯æœ‰ä¸å°‘å°ä¼™ä¼´åé¦ˆè¯´æ— æ³•å¿«é€Ÿä¸Šæ‰‹ï¼ˆå¯èƒ½ä¹Ÿæ˜¯è¿™ä¸ª demo çš„é¡¹ç›®æ¯”è¾ƒå¤šï¼‰ï¼Œäºæ˜¯æˆ‘å‡†å¤‡ä» 0 å¼€å§‹ä»çœŸå®çš„ä»£ç ä¸€æ­¥æ­¥å¸¦å¤§å®¶é›†æˆ &lt;code&gt;OpenTelemetry&lt;/code&gt;ï¼Œå› ä¸º OpenTelemetry æœ¬èº«æ˜¯è·¨å¤šç§è¯­è¨€çš„ï¼Œæ‰€ä»¥ä¹Ÿä¼šä»¥ä¸¤ç§è¯­è¨€ä¸ºï¼ˆJavaã€Golangï¼‰ä¸»è¿›è¡Œè®²è§£ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ä½¿ç”¨è¿™ä¸¤ç§è¯­è¨€ä¸»è¦æ˜¯å› ä¸º Java å‡ ä¹å…¨æ˜¯è‡ªåŠ¨åŸ‹ç‚¹ï¼Œè€Œ Golang å› ä¸ºè¯­è¨€ç‰¹æ€§ï¼Œå¤§éƒ¨åˆ†éƒ½å¾—ç¡¬ç¼–ç åŸ‹ç‚¹ï¼›è¦†ç›–åˆ°è¿™ä¸¤ç§åœºæ™¯åå…¶ä»–è¯­è¨€ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œé¡¶å¤šåªæ˜¯ API åç§°æœ‰äº›è®¸åŒºåˆ«ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿä¼šç©¿æ’ä¸€äº› OpenTelemetry çš„åŸç†ï¼Œå¸Œæœ›æ•´ä¸ªè¿‡ç¨‹ä¸‹æ¥å¤§å®¶å¯ä»¥åœ¨é¡¹ç›®ä¸­å®é™…è¿ç”¨èµ·æ¥ï¼ŒåŒæ—¶ä¹Ÿèƒ½çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£å•å…ƒæµ‹è¯•ï¼šæŠ€å·§ä¸æœ€ä½³å®è·µ</title>
    <link href="http://crossoverjie.top/2024/08/15/ob/unit-test/"/>
    <id>http://crossoverjie.top/2024/08/15/ob/unit-test/</id>
    <published>2024-08-15T02:43:09.000Z</published>
    <updated>2024-08-14T13:55:07.855Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰åˆ†äº«è¿‡å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹å¼€æºé¡¹ç›®ä»¥åŠå¦‚ä½•åœ¨å¼€æºé¡¹ç›®é‡Œåšé›†æˆæµ‹è¯•ï¼Œä½†è¿˜æ²¡æœ‰è®²è¿‡å…·ä½“çš„å®æ“ã€‚</p><p>ä»Šå¤©æ¥è¯¦ç»†è®²è®²å¦‚ä½•å†™å•å…ƒæµ‹è¯•ã€‚</p><h1 id="ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•"><a href="#ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•" class="headerlink" title="ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•"></a>ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•</h1><p>è¿™ä¸ªå¤§å®¶åº”è¯¥æ˜¯æœ‰å…±è¯†çš„ï¼Œå¯¹äºä¸€äº›åŠŸèƒ½å•ä¸€ã€æ ¸å¿ƒé€»è¾‘ã€åŒæ—¶å˜åŒ–ä¸é¢‘ç¹çš„å…¬å¼€å‡½æ•°æ‰æœ‰å¿…è¦åšå•å…ƒæµ‹è¯•ã€‚</p><p>å¯¹äºä¸šåŠ¡å¤æ‚ã€é“¾è·¯ç¹çä½†ä¹Ÿæ˜¯æ ¸å¿ƒæµç¨‹çš„åŠŸèƒ½é€šå¸¸å»ºè®®åš e2e æµ‹è¯•ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æœ€ç»ˆæµ‹è¯•ç»“æœçš„ä¸€è‡´æ€§ã€‚</p><span id="more"></span><h1 id="ğŸ’€å…·ä½“æ¡ˆä¾‹"><a href="#ğŸ’€å…·ä½“æ¡ˆä¾‹" class="headerlink" title="ğŸ’€å…·ä½“æ¡ˆä¾‹"></a>ğŸ’€å…·ä½“æ¡ˆä¾‹</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“å•æµ‹çš„ä¸»è¦ç›®çš„æ˜¯æ¨¡æ‹Ÿæ‰§è¡Œä½ å†™è¿‡çš„æ¯ä¸€è¡Œä»£ç ï¼Œç›®çš„å°±æ˜¯è¦è¦†ç›–åˆ°ä¸»è¦åˆ†æ”¯ï¼Œåšåˆ°è‡ªå·±çš„æ¯ä¸€è¡Œä»£ç éƒ½å¿ƒä¸­æœ‰æ•°ã€‚</p><p>ä¸‹é¢ä»¥ <code>Apache HertzBeat</code> çš„ä¸€äº›å•æµ‹ä¸ºä¾‹ï¼Œè®²è§£å¦‚ä½•ç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•ã€‚</p><p><img src="https://s2.loli.net/2024/07/02/SbqCvHVZk6f5tB1.png"><br>å…ˆä»¥ä¸€ä¸ªæœ€ç®€å•çš„ <code>org.apache.hertzbeat.collector.collect.udp.UdpCollectImpl#preCheck</code> å‡½æ•°æµ‹è¯•ä¸ºä¾‹ã€‚<br>è¿™é‡Œçš„ <code>preCheck</code> å‡½æ•°å°±æ˜¯ç®€å•çš„æ£€æµ‹åšå‚æ•°æ ¡éªŒã€‚<br>æµ‹è¯•æ—¶åªè¦æˆ‘ä»¬æ‰‹åŠ¨å°† <code>metrics</code> è®¾ç½®ä¸º <code>null</code> å°±å¯ä»¥è¿›å…¥è¿™ä¸ª if æ¡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UdpCollectImplTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> UdpCollectImpl udpCollect;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testPreCheck</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; aliasField = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        aliasField.add(<span class="string">&quot;responseTime&quot;</span>);</span><br><span class="line">        <span class="type">Metrics</span> <span class="variable">metrics</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Metrics</span>();</span><br><span class="line">        metrics.setAliasFields(aliasField);</span><br><span class="line">        assertThrows(IllegalArgumentException.class, () -&gt; udpCollect.preCheck(metrics));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><p>æ¥çœ‹å…·ä½“çš„å•æµ‹ä»£ç ï¼Œæˆ‘ä»¬ä¸€è¡Œè¡Œçš„æ¥çœ‹ï¼š</p><p><code>@ExtendWith(MockitoExtension.class)</code> æ˜¯ <code>Junit5</code> æä¾›çš„ä¸€ä¸ªæ³¨è§£ï¼Œé‡Œé¢ä¼ å…¥çš„ <code>MockitoExtension.class</code> æ˜¯æˆ‘ä»¬å•æµ‹ mock å¸¸ç”¨çš„æ¡†æ¶ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯å‘Šè¯‰ <code>Junit5</code> ï¼Œå½“å‰çš„æµ‹è¯•ç±»ä¼šä½¿ç”¨ mockito ä½œä¸ºæ‰©å±•è¿è¡Œï¼Œä»è€Œå¯ä»¥ <code>mock</code> æˆ‘ä»¬è¿è¡Œæ—¶çš„ä¸€äº›å¯¹è±¡ã€‚</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@InjectMocks</span>  </span><br><span class="line"><span class="keyword">private</span> UdpCollectImpl udpCollect;</span><br></pre></td></tr></table></figure><p><code>@InjectMocks</code> ä¹Ÿæ˜¯ <code>mockito</code> è¿™ä¸ªåº“æä¾›çš„æ³¨è§£ï¼Œé€šå¸¸ç”¨äºå£°æ˜éœ€è¦æµ‹è¯•çš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@InjectMocks</span>  </span><br><span class="line"><span class="keyword">private</span> AbstractCollect udpCollect;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/07/02/zSocET9f5y6lqC3.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ³¨è§£å¿…é¡»æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»ï¼Œä¸å¯ä»¥æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»æˆ–è€…æ˜¯æ¥å£ã€‚</p><p>å…¶å®å½“æˆ‘ä»¬äº†è§£äº†ä»–çš„åŸç†å°±èƒ½çŸ¥é“å…·ä½“çš„åŸå› ï¼š<br><img src="https://s2.loli.net/2024/07/02/5DwRyVsBHd1EmpA.png"></p><p>å½“æˆ‘ä»¬ debug è¿è¡Œæ—¶ä¼šå‘ç° <code>udpCollect</code> å¯¹è±¡æ˜¯æœ‰å€¼çš„ï¼Œè€Œå¦‚æœæˆ‘ä»¬å»æ‰è¿™ä¸ªæ³¨è§£ <code>@InjectMocks</code> å†è¿è¡Œå°±ä¼šæŠ›ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p><blockquote><p>å› ä¸ºå¹¶æ²¡æœ‰åˆå§‹åŒ– udpCollect</p></blockquote><p>è€Œä½¿ç”¨ <code>@InjectMocks</code>æ³¨è§£åï¼Œ<code>mockito</code> æ¡†æ¶ä¼šè‡ªåŠ¨ç»™ <code>udpCollect</code> æ³¨å…¥ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼›è€Œå¦‚æœæ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…æ˜¯æŠ½è±¡ç±»ï¼Œmockito æ¡†æ¶æ˜¯æ— æ³•çŸ¥é“åˆ›å»ºå…·ä½“å“ªä¸ªå¯¹è±¡ã€‚</p><p>å½“ç„¶åœ¨è¿™ä¸ªç®€å•åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ç›´æ¥ <code>udpCollect = new UdpCollectImpl()</code> è¿›è¡Œæµ‹è¯•ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><h1 id="ğŸ”¥é…åˆ-jacoco-è¾“å‡ºå•æµ‹è¦†ç›–ç‡"><a href="#ğŸ”¥é…åˆ-jacoco-è¾“å‡ºå•æµ‹è¦†ç›–ç‡" class="headerlink" title="ğŸ”¥é…åˆ jacoco è¾“å‡ºå•æµ‹è¦†ç›–ç‡"></a>ğŸ”¥é…åˆ jacoco è¾“å‡ºå•æµ‹è¦†ç›–ç‡</h1><p><img src="https://s2.loli.net/2024/07/02/fgv3O4RbnHsQTWV.png"><br><img src="https://s2.loli.net/2024/07/02/coXOGkjyE2zKsYa.png"></p><p>åœ¨ IDEA ä¸­æˆ‘ä»¬å¯ä»¥ä»¥ <code>Coverage</code> çš„æ–¹å¼è¿è¡Œï¼Œ<code>IDEA</code> å°±å°†æˆ‘ä»¬çš„å•æµ‹è¦†ç›–æƒ…å†µæ˜¾ç¤ºåœ¨æºä»£ç ä¸­ï¼Œç»¿è‰²çš„éƒ¨åˆ†å°±ä»£è¡¨åœ¨å®é™…åœ¨è¿è¡Œæ—¶æ‰§è¡Œåˆ°çš„åœ°æ–¹ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ <code>maven</code> é¡¹ç›®ä¸­é›†æˆ <code>jacoco</code>ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªæ ¹ç›®å½•çš„ <code>pom.xml</code> ä¸­æ·»åŠ ä¸€ä¸ª <code>plugin</code> å°±å¯ä»¥äº†ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jacoco<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jacoco-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jacoco-maven-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>prepare-agent<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>report<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test<span class="tag">&lt;/<span class="name">phase</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>report<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¹‹åè¿è¡Œ <code>mvn test</code> å°±ä¼šåœ¨ target ç›®å½•ä¸‹ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šäº†ã€‚</p><p><img src="https://s2.loli.net/2024/07/02/GiBrPjtLcXhgDbp.png"></p><p>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨ GitHub çš„ CI ä¸­é›†æˆ <code>Codecov</code>ï¼Œä»–ä¼šç›´æ¥è¯»å– jacoco çš„æµ‹è¯•æ•°æ®ï¼Œå¹¶ä¸”åœ¨ PR çš„è¯„è®ºåŒºåŠ ä¸Šæµ‹è¯•æŠ¥å‘Šã€‚<br><img src="https://s2.loli.net/2024/07/02/ujdGke4gf5mAW3x.png"></p><p><img src="https://s2.loli.net/2024/07/02/nFt5SukAjMPZ96W.png"></p><p><img src="https://s2.loli.net/2024/07/02/KcXJUs3mehxFAYz.png"></p><p>éœ€è¦ä» <code>Codecov</code> é‡Œå°†ä½ é¡¹ç›®çš„ token æ·»åŠ åˆ° repo çš„ ç¯å¢ƒå˜é‡ä¸­å³å¯ã€‚</p><p>å…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ª PRï¼š<a href="https://github.com/apache/hertzbeat/pull/1985">https://github.com/apache/hertzbeat/pull/1985</a></p><h1 id="â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹"><a href="#â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹" class="headerlink" title="â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹"></a>â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹</h1><p>åˆšæ‰å±•ç¤ºçš„æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„åœºæ™¯ï¼Œä¸‹é¢æ¥çœ‹çœ‹ç¨å¾®å¤æ‚çš„ã€‚</p><p>æˆ‘ä»¬ä»¥è¿™ä¸ªå•æµ‹ä¸ºä¾‹ï¼š<br><code>org.apache.hertzbeat.collector.collect.redis.RedisClusterCollectImplTest</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClusterCollectImplTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> RedisCommonCollectImpl redisClusterCollect;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> StatefulRedisClusterConnection&lt;String, String&gt; connection;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> RedisAdvancedClusterCommands&lt;String, String&gt; cmd;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> RedisClusterClient client;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå•æµ‹åœ¨åˆšæ‰çš„åŸºç¡€ä¸Šå¤šäº†ä¸€ä¸ª <code>@Mock</code> çš„æ³¨è§£ã€‚</p><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦æµ‹è¯•çš„ <code>RedisCommonCollectImpl</code> ç±»ä¸­éœ€è¦ä¾èµ– <code>StatefulRedisClusterConnection/RedisAdvancedClusterCommands/RedisClusterClient</code> è¿™å‡ ä¸ªç±»æ‰€æä¾›çš„æœåŠ¡ã€‚</p><p>å•æµ‹çš„æ—¶å€™éœ€è¦ä½¿ç”¨ <code>mockito</code> åˆ›å»ºä¸€ä¸ªä»–ä»¬çš„å¯¹è±¡ï¼Œå¹¶ä¸”æ³¨å…¥åˆ°éœ€è¦è¢«æµ‹è¯•çš„ <code>RedisCommonCollectImpl</code>ç±»ä¸­ã€‚</p><blockquote><p>ä¸ç„¶æˆ‘ä»¬å°±éœ€è¦å‡†å¤‡å•æµ‹æ‰€éœ€è¦çš„èµ„æºï¼Œæ¯”å¦‚å¯ä»¥ä½¿ç”¨çš„ Redisã€MySQL ç­‰ã€‚</p></blockquote><h2 id="ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º"><a href="#ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º" class="headerlink" title="ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º"></a>ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º</h2><p>åªæ˜¯æ³¨å…¥è¿›å»è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ¨¡æ‹Ÿå®ƒçš„è¡Œä¸ºï¼š</p><ul><li>æ¯”å¦‚è°ƒç”¨æŸä¸ªå‡½æ•°å¯ä»¥æ¨¡æ‹Ÿè¿”å›æ•°æ®</li><li>æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨æŠ›å‡ºå¼‚å¸¸</li><li>æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨è€—æ—¶</li></ul><p>è¿™é‡Œä»¥æœ€å¸¸è§çš„æ¨¡æ‹Ÿå‡½æ•°è¿”å›ä¸ºä¾‹ï¼š</p><p><img src="https://s2.loli.net/2024/07/02/3lnFxsQmcWqao5u.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">clusterNodes</span> <span class="operator">=</span> connection.sync().clusterInfo();</span><br></pre></td></tr></table></figure><p>åœ¨æºç é‡Œçœ‹åˆ°ä¼šä½¿ç”¨ connection çš„ <code>clusterInfo()</code> å‡½æ•°è¿”å›é›†ç¾¤ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">clusterKnownNodes</span> <span class="operator">=</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">clusterInfoTemp</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        cluster_slots_fail:0</span></span><br><span class="line"><span class="string">        cluster_known_nodes:%s</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">clusterInfo</span> <span class="operator">=</span> String.format(clusterInfoTemp, clusterKnownNodes);</span><br><span class="line">Mockito.when(cmd.clusterInfo()).thenReturn(clusterInfo);        </span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code>Mockito.when().thenReturn()</code> æ¥æ¨¡æ‹Ÿè¿™ä¸ªå‡½æ•°çš„è¿”å›æ•°æ®ã€‚</p><p>è€Œå…¶ä¸­çš„ <code>cmd</code> è‡ªç„¶ä¹Ÿæ˜¯éœ€è¦æ¨¡æ‹Ÿè¿”å›çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Mockito.mockStatic(RedisClusterClient.class).when(()-&gt;RedisClusterClient.create(Mockito.any(ClientResources.class),</span><br><span class="line">        Mockito.any(RedisURI.class))).thenReturn(client);</span><br><span class="line">Mockito.when(client.connect()).thenReturn(connection);</span><br><span class="line"></span><br><span class="line">Mockito.when(connection.sync()).thenReturn(cmd);</span><br><span class="line">Mockito.when(cmd.info(metrics.getName())).thenReturn(info);</span><br><span class="line">Mockito.when(cmd.clusterInfo()).thenReturn(clusterInfo);</span><br></pre></td></tr></table></figure><p><code>cmd</code> æ˜¯é€šè¿‡ <code>Mockito.when(connection.sync()).thenReturn(cmd);</code>è¿”å›çš„ï¼Œè€Œ <code>connection</code> åˆæ˜¯ä» <code>client.connect()</code> è¿”å›çš„ã€‚</p><p>æœ€ç»ˆå°±åƒæ˜¯å¥—å¨ƒä¸€æ ·ï¼Œ<code>client</code> åœ¨æºç ä¸­æ˜¯é€šè¿‡ä¸€ä¸ªé™æ€å‡½æ•°åˆ›å»ºçš„ã€‚</p><h3 id="âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°"><a href="#âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°" class="headerlink" title="âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°"></a>âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°</h3><p>æˆ‘ä¾ç¨€è®°å¾—åœ¨æˆ‘åˆšæ¥è§¦ <code>mockito</code> çš„ 16ï½17 å¹´é‚£æ®µæ—¶é—´è¿˜ä¸æ”¯æŒæ¨¡æ‹Ÿè°ƒç”¨é™æ€å‡½æ•°ï¼Œä¸è¿‡å¦‚ä»Šå·²ç»æ”¯æŒäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mock</span>  </span><br><span class="line"><span class="keyword">private</span> RedisClusterClient client;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mockito.mockStatic(RedisClusterClient.class).when(()-&gt;RedisClusterClient.create(Mockito.any(ClientResources.class),  </span><br><span class="line">        Mockito.any(RedisURI.class))).thenReturn(client);</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥æ¨¡æ‹Ÿé™æ€å‡½æ•°çš„è¿”å›å€¼äº†ï¼Œä½†å‰ææ˜¯è¿”å›çš„ <code>client</code> éœ€è¦ä½¿ç”¨ <code>@Mock</code> æ³¨è§£ã€‚</p><h3 id="ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°"><a href="#ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°" class="headerlink" title="ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°"></a>ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°</h3><p><img src="https://s2.loli.net/2024/07/02/aFiCLRyYh4IU83o.png"><br>æœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿéœ€è¦æ¨¡æ‹Ÿæ„é€ å‡½æ•°ï¼Œä»è€Œå¯ä»¥æ¨¡æ‹Ÿåç»­è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MockedConstruction&lt;FTPClient&gt; mocked = Mockito.mockConstruction(FTPClient.class,</span><br><span class="line">        (ftpClient, context) -&gt; &#123;</span><br><span class="line">            Mockito.doNothing().when(ftpClient).connect(ftpProtocol.getHost(),</span><br><span class="line">                    Integer.parseInt(ftpProtocol.getPort()));</span><br><span class="line"></span><br><span class="line">            Mockito.doAnswer(invocationOnMock -&gt; <span class="literal">true</span>).when(ftpClient)</span><br><span class="line">                    .login(ftpProtocol.getUsername(), ftpProtocol.getPassword());</span><br><span class="line">            Mockito.when(ftpClient.changeWorkingDirectory(ftpProtocol.getDirection())).thenReturn(isActive);</span><br><span class="line">            Mockito.doNothing().when(ftpClient).disconnect();</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ <code>Mockito.mockConstruction</code> æ¥è¿›è¡Œæ¨¡æ‹Ÿï¼Œè¯¥å¯¹è±¡çš„ä¸€äº›è¡Œä¸ºå°±ç›´æ¥å†™åœ¨è¿™ä¸ªæ¨¡æ‹Ÿå‡½æ•°å†…ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿”å›çš„ <code>mocked</code> å¯¹è±¡éœ€è¦è®°å¾—å…³é—­ã€‚</p><h3 id="ä¸éœ€è¦-Mock"><a href="#ä¸éœ€è¦-Mock" class="headerlink" title="ä¸éœ€è¦ Mock"></a>ä¸éœ€è¦ Mock</h3><p>å½“ç„¶ä¹Ÿä¸æ˜¯æ‰€æœ‰çš„åœºæ™¯éƒ½éœ€è¦ <code>mock</code>ã€‚</p><p>æ¯”å¦‚åˆšæ‰ç¬¬ä¸€ä¸ªåœºæ™¯ï¼Œæ²¡æœ‰ä¾èµ–ä»»ä½•å¤–éƒ¨æœåŠ¡æ—¶å°±ä¸éœ€è¦ <code>mock</code>ã€‚</p><p><img src="https://s2.loli.net/2024/07/02/mW3gxERBc4qoz2L.png"></p><p>ç±»ä¼¼äºè¿™ä¸ª <a href="https://github.com/apache/hertzbeat/pull/2021">PR</a> é‡Œçš„æµ‹è¯•ï¼Œåªæ˜¯ä¾èµ–ä¸€ä¸ªåŸºç¡€çš„å†…å­˜ç¼“å­˜ç»„ä»¶ï¼Œå°±æ²¡å¿…è¦ mockï¼Œä½†å¦‚æœä¾èµ–çš„æ˜¯ <code>Redis</code> ç¼“å­˜ç»„ä»¶è¿˜æ˜¯éœ€è¦ mock çš„ã€‚<br><a href="https://github.com/apache/hertzbeat/pull/2021">https://github.com/apache/hertzbeat/pull/2021</a></p><h3 id="âš™ï¸ä¿®æ”¹æºç "><a href="#âš™ï¸ä¿®æ”¹æºç " class="headerlink" title="âš™ï¸ä¿®æ”¹æºç "></a>âš™ï¸ä¿®æ”¹æºç </h3><p>å¦‚æœæœ‰äº›æµ‹è¯•åœºæ™¯ä¸‹éœ€è¦è·å–å†…éƒ¨å˜é‡æ–¹ä¾¿åç»­çš„æµ‹è¯•ï¼Œä½†æ˜¯è¯¥æµ‹è¯•ç±»ä¹Ÿæ²¡æœ‰æä¾›è·å–å˜é‡çš„å‡½æ•°ï¼Œæˆ‘ä»¬å°±åªæœ‰ä¿®æ”¹æºç æ¥é…åˆæµ‹è¯•äº†ã€‚</p><p>æ¯”å¦‚è¿™ä¸ª <a href="https://github.com/apache/hertzbeat/pull/">PR</a>ï¼š<br><img src="https://s2.loli.net/2024/07/02/bxfQgsymWVcnawE.png"></p><p>å½“ç„¶å¦‚æœåªæ˜¯ç»™æµ‹è¯•ç¯å¢ƒä¸‹ä½¿ç”¨çš„å‡½æ•°æˆ–å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸Š <code>@VisibleForTesting</code>æ³¨è§£æ ‡æ˜ä¸€ä¸‹ï¼Œè¿™ä¸ªæ³¨è§£æ²¡æœ‰å…¶ä»–ä½œç”¨ï¼Œå¯ä»¥è®©åç»­çš„ç»´æŠ¤è€…æ›´æ¸…æ¥šçš„çŸ¥é“è¿™æ˜¯åšä»€ä¹ˆç”¨çš„ã€‚</p><h1 id="ğŸ“ˆé›†æˆæµ‹è¯•"><a href="#ğŸ“ˆé›†æˆæµ‹è¯•" class="headerlink" title="ğŸ“ˆé›†æˆæµ‹è¯•"></a>ğŸ“ˆé›†æˆæµ‹è¯•</h1><p>å•å…ƒæµ‹è¯•åªèƒ½æµ‹è¯•ä¸€äº›åŠŸèƒ½å•ä¸€çš„å‡½æ•°ï¼Œè¦ä¿è¯æ•´ä¸ªè½¯ä»¶çš„è´¨é‡ä»…ä¾èµ–å•æµ‹æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é›†æˆæµ‹è¯•ã€‚</p><p>é€šå¸¸æ˜¯éœ€è¦å¯¹å¤–æä¾›æœåŠ¡çš„å¼€æºé¡¹ç›®éƒ½éœ€è¦é›†æˆæµ‹è¯•ï¼š</p><ul><li>Pulsar</li><li>Kafka</li><li>Dubbo ç­‰</li></ul><p>ä»¥æˆ‘æ¥è§¦åˆ°çš„æœåŠ¡å‹åº”ç”¨ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ä¸ªæ˜¯ Java åº”ç”¨ä¸€ä¸ªæ˜¯ Golang åº”ç”¨ã€‚</p><h1 id="ğŸ³Golang"><a href="#ğŸ³Golang" class="headerlink" title="ğŸ³Golang"></a>ğŸ³Golang</h1><p><img src="https://s2.loli.net/2024/07/11/vZISu9Qg3foKhsU.png"></p><p><code>Golang</code> å› ä¸ºå·¥å…·é“¾æ²¡æœ‰ Java é‚£ä¹ˆå¼ºå¤§ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†çš„é›†æˆæµ‹è¯•çš„åŠŸèƒ½éƒ½æ˜¯é€šè¿‡ç¼–å†™ Makefile å’Œ shell è„šæœ¬å®ç°çš„ã€‚</p><p>è¿˜æ˜¯ä»¥æˆ‘ç†Ÿæ‚‰çš„ Pulsar çš„ <code>go-client</code> ä¸ºä¾‹ï¼Œå®ƒåœ¨ GitHub çš„é›†æˆæµ‹è¯•æ˜¯é€šè¿‡ GitHub action è§¦å‘çš„ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/05/20/f2196pujo8m7KRe.png"><br>æœ€ç»ˆè°ƒç”¨çš„æ˜¯ Makefile ä¸­çš„ test å‘½ä»¤ï¼Œå¹¶ä¸”æŠŠéœ€è¦æµ‹è¯•çš„ Golang ç‰ˆæœ¬ä¼ å…¥è¿›å»ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/YpwtSHnLXqU1xQj.png"></p><p><code>Dockerfile</code>ï¼š<br><img src="https://s2.loli.net/2024/05/20/1ySGWF46U7EC2rk.png"></p><p>è¿™ä¸ªé•œåƒç®€å•æ¥è¯´å°±æ˜¯å°† Pulsar çš„é•œåƒä½œä¸ºåŸºç¡€è¿è¡Œé•œåƒï¼ˆè¿™é‡Œé¢åŒ…å«äº† Pulsar çš„æœåŠ¡ç«¯ï¼‰ï¼Œç„¶åå°†è¿™ä¸ª pulsar-client-go çš„ä»£ç å¤åˆ¶è¿›å»ç¼–è¯‘ã€‚</p><p>æ¥ç€è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /pulsar/pulsar-client-go &amp;&amp; ./scripts/run-ci.sh</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯æµ‹è¯•è„šæœ¬ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/2Afmdu8ozRvH9FC.png"></p><p>æµ‹è¯•è„šæœ¬çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼š</p><ul><li>å¯åŠ¨ pulsar æœåŠ¡ç«¯</li><li>è¿è¡Œæµ‹è¯•ä»£ç <br>å› ä¸ºæ‰€æœ‰çš„æµ‹è¯•ä»£ç é‡Œè¿æ¥æœåŠ¡ç«¯çš„åœ°å€éƒ½æ˜¯ <code>localhost</code>ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿æ¥ã€‚<br><img src="https://s2.loli.net/2024/05/20/C1RHxTkuz25Mlj8.png"></li></ul><p>é€šè¿‡è¿™é‡Œçš„ <a href="https://github.com/apache/pulsar-client-go/actions/runs/9014510238/job/24768797555">action</a> æ—¥å¿—å¯ä»¥è·Ÿè¸ªæ‰€æœ‰çš„è¿è¡Œæƒ…å†µã€‚</p><h1 id="â˜•Java"><a href="#â˜•Java" class="headerlink" title="â˜•Java"></a>â˜•Java</h1><p><img src="https://s2.loli.net/2024/07/11/KlqzSwJ6f895A4n.png"></p><p>Java å› ä¸ºå·¥å…·é“¾å¼ºå¤§ï¼Œæ‰€ä»¥é›†æˆæµ‹è¯•å‡ ä¹ä¸éœ€è¦ç”¨ Makefile å’Œè„šæœ¬é…åˆæ‰§è¡Œã€‚</p><p>è¿˜æ˜¯ä»¥ Pulsar ä¸ºä¾‹ï¼Œå®ƒçš„é›†æˆæµ‹è¯•æ˜¯éœ€è¦æ¨¡æ‹Ÿåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼ˆå› ä¸º Pulsar çš„æœåŠ¡ç«¯æºç å’Œæµ‹è¯•ä»£ç éƒ½æ˜¯ Java å†™çš„ï¼Œæ›´æ–¹ä¾¿åšæµ‹è¯•ï¼‰ï¼Œç„¶åå†è¿è¡Œæµ‹è¯•ä»£ç ã€‚</p><blockquote><p>è¿™ä¸ªçš„å¥½å¤„æ˜¯ä»»ä½•ä¸€ä¸ªå•æµ‹éƒ½å¯ä»¥åœ¨æœ¬åœ°ç›´æ¥è¿è¡Œï¼Œè€Œ  Go çš„ä»£ç è¿˜éœ€è¦å…ˆåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œæµ‹è¯•èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚</p></blockquote><p>æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Œæˆ‘ä»¥å…¶ä¸­ä¸€ä¸ª <a href="https://github.com/apache/pulsar/blob/631b13ad23d7e48c6e82d38f97c23d129062cb7c/pulsar-broker/src/test/java/org/apache/pulsar/client/impl/BrokerClientIntegrationTest.java#L117">BrokerClientIntegrationTest</a>ä¸ºä¾‹ï¼š<br><img src="https://s2.loli.net/2024/05/20/9PbioA3RQLMBy6J.png"><br><img src="https://s2.loli.net/2024/05/20/blKePdxTUIkgRD3.png"><br>ä¼šåœ¨å•æµ‹å¯åŠ¨çš„æ—¶å€™å…ˆå¯åŠ¨æœåŠ¡ç«¯ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/gzY3lyTGuEDUwZF.png"></p><p>æœ€ç»ˆä¼šè°ƒç”¨ <code>PulsarTestContext</code> çš„ <code>build</code> å‡½æ•°å¯åŠ¨ <code>broker</code>ï¼ˆæœåŠ¡ç«¯ï¼‰ï¼Œè€Œæ‰§è¡Œå•æµ‹ä¹Ÿåªéœ€è¦ä½¿ç”¨ <code>mvn test</code> å°±å¯ä»¥è‡ªåŠ¨è§¦å‘è¿™äº›å•å…ƒæµ‹è¯•ã€‚<br><img src="https://s2.loli.net/2024/05/20/N15amZihWI73Qyw.png"><br>åªæ˜¯æ¯ä¸€ä¸ªå•æµ‹éƒ½éœ€è¦å¯åœæœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¦æŠŠ Pulsar çš„æ‰€æœ‰å•æµ‹è·‘å®Œé€šå¸¸éœ€è¦ 1ï½2 ä¸ªå°æ—¶ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯æ—¥å¸¸ç¼–å†™å•æµ‹å¯èƒ½ä¼šç¢°åˆ°çš„åœºæ™¯ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰åˆ†äº«è¿‡å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹å¼€æºé¡¹ç›®ä»¥åŠå¦‚ä½•åœ¨å¼€æºé¡¹ç›®é‡Œåšé›†æˆæµ‹è¯•ï¼Œä½†è¿˜æ²¡æœ‰è®²è¿‡å…·ä½“çš„å®æ“ã€‚&lt;/p&gt;
&lt;p&gt;ä»Šå¤©æ¥è¯¦ç»†è®²è®²å¦‚ä½•å†™å•å…ƒæµ‹è¯•ã€‚&lt;/p&gt;
&lt;h1 id=&quot;ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&quot;&gt;&lt;a href=&quot;#ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&quot; class=&quot;headerlink&quot; title=&quot;ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&quot;&gt;&lt;/a&gt;ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&lt;/h1&gt;&lt;p&gt;è¿™ä¸ªå¤§å®¶åº”è¯¥æ˜¯æœ‰å…±è¯†çš„ï¼Œå¯¹äºä¸€äº›åŠŸèƒ½å•ä¸€ã€æ ¸å¿ƒé€»è¾‘ã€åŒæ—¶å˜åŒ–ä¸é¢‘ç¹çš„å…¬å¼€å‡½æ•°æ‰æœ‰å¿…è¦åšå•å…ƒæµ‹è¯•ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºä¸šåŠ¡å¤æ‚ã€é“¾è·¯ç¹çä½†ä¹Ÿæ˜¯æ ¸å¿ƒæµç¨‹çš„åŠŸèƒ½é€šå¸¸å»ºè®®åš e2e æµ‹è¯•ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æœ€ç»ˆæµ‹è¯•ç»“æœçš„ä¸€è‡´æ€§ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="å•æµ‹" scheme="http://crossoverjie.top/tags/%E5%8D%95%E6%B5%8B/"/>
    
  </entry>
  
</feed>
