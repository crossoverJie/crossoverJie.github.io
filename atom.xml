<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>crossoverJie&#39;s Blog</title>
  
  <subtitle>baller</subtitle>
  <link href="http://crossoverjie.top/atom.xml" rel="self"/>
  
  <link href="http://crossoverjie.top/"/>
  <updated>2024-09-26T13:39:32.089Z</updated>
  <id>http://crossoverjie.top/</id>
  
  <author>
    <name>crossoverJie</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>OpenTelemetry å®æˆ˜ï¼šä» 0 åˆ° 1 ç¼–å†™ä¸€ä¸ª Instrumentation</title>
    <link href="http://crossoverjie.top/2024/09/26/ob/OpenTelemetry-create-instrumentation/"/>
    <id>http://crossoverjie.top/2024/09/26/ob/OpenTelemetry-create-instrumentation/</id>
    <published>2024-09-26T05:14:01.000Z</published>
    <updated>2024-09-26T13:39:32.089Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å› ä¸ºå…¬å¸å†…éƒ¨åœ¨ä½¿ç”¨ <a href="https://github.com/PowerJob/PowerJob">PowerJob</a> ä½œä¸ºæˆ‘ä»¬çš„åˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿï¼ŒåŒæ—¶åˆæ˜¯ä½¿ç”¨ OpenTelemetry ä½œä¸ºå¯è§‚æµ‹çš„åº•åº§ï¼Œä½†ç›®å‰ OpenTelemetry è¿˜æ²¡æœ‰å¯¹ PowerJob æä¾›æ”¯æŒï¼Œç›®å‰ç¤¾åŒºåªå¯¹åŒç±»å‹çš„ XXL-JOB æœ‰æ”¯æŒã€‚<br><img src="https://s2.loli.net/2024/08/26/qfdloarJ7iNzPXy.png"></p><p>æ°å¥½å…¬å¸å†…éƒ¨ä¹Ÿæœ‰ä¸€äº›å¼€å‘åŒå­¦æœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼š<br><img src="https://s2.loli.net/2024/08/26/6aIFxlEyKt7OfsC.png"></p><p>äºæ˜¯åœ¨è¿™ä¸ªèƒŒæ™¯ä¸‹æˆ‘ä¾¿å¼€å§‹ç€æ‰‹å¼€å‘ PowerJob çš„ instrumentationï¼Œæœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/08/26/r7xgSHKCftqvuXw.png"><br><img src="https://s2.loli.net/2024/08/26/KNnWPzm5rU9By3c.png"></p><span id="more"></span><p>ä»è¿™ä¸ªé“¾è·¯å›¾ä¸­å¯ä»¥çœ‹åˆ° grpc-consumer æä¾›äº†è°ƒåº¦çš„å…¥å£å‡½æ•°ï¼Œç„¶ååœ¨å†…éƒ¨å‘é€äº† Pulsar æ¶ˆæ¯ï¼Œæœ€ç»ˆåˆè°ƒç”¨äº† grpc-provider çš„ <code>gRPC</code> æ¥å£ã€‚</p><p>è¿™æ ·å°±å¯ä»¥æŠŠæ•´ä¸ªé“¾è·¯ä¸²èµ·æ¥ï¼ŒåŒæ—¶è¿˜èƒ½æŸ¥çœ‹ <code>PowerJob</code> è°ƒåº¦çš„ JobIdã€ä»¥åŠè°ƒç”¨å‚æ•°ç­‰æ•°æ®ï¼Œè¿™æ ·æ’æŸ¥é—®é¢˜æ—¶ä¹Ÿæ›´åŠ ç›´è§‚ã€‚</p><h1 id="å¼€å‘-Instrumentation-çš„å‰ç½®çŸ¥è¯†"><a href="#å¼€å‘-Instrumentation-çš„å‰ç½®çŸ¥è¯†" class="headerlink" title="å¼€å‘ Instrumentation çš„å‰ç½®çŸ¥è¯†"></a>å¼€å‘ Instrumentation çš„å‰ç½®çŸ¥è¯†</h1><p>åœ¨æ­£å¼å¼€å‘ Instrumentation ä¹‹å‰è¿˜éœ€è¦äº†è§£ä¸€äº›å‰ç½®çŸ¥è¯†ç‚¹ã€‚</p><p><img src="https://s2.loli.net/2024/08/26/K43Ix8LCkQWAao5.png"><br><img src="https://s2.loli.net/2024/08/26/29DQxfMgFViuHYa.png"></p><p>è¿™é‡Œæˆ‘ä»¬ä»¥ç°æœ‰çš„  <code>gRPC</code> å’Œæˆ‘ç¼–å†™çš„ PowerJob instrumentation ä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ° <code>gRPC</code> çš„ instrumentation ä¸­å¤šäº†ä¸€ä¸ª library çš„æ¨¡å—ã€‚</p><p>è¿™é‡Œå°±å¼•ç”³å‡ºäº†ä¸¤ç§åŸ‹ç‚¹æ–¹å¼ï¼š</p><ul><li><strong>Library instrumentation</strong></li><li><strong>Java agent instrumentation</strong></li></ul><p>é€šå¸¸æˆ‘ä»¬å¯¹ä¸€ä¸ªæ¡†æ¶æˆ–è€…ä¸€ä¸ªåº“è¿›è¡ŒåŸ‹ç‚¹æ—¶ï¼Œé¦–å…ˆéœ€è¦æ‰¾åˆ°å®ƒçš„åŸ‹ç‚¹å…¥å£ã€‚</p><p>ä»¥ <em><code>grpc</code></em> ä¸ºä¾‹ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦çœ‹ä»–æ˜¯å¦æœ‰æä¾›æ‰©å±•çš„ API å¯ä»¥ä¾›æˆ‘ä»¬åŸ‹ç‚¹ï¼Œæ°å¥½ grpc æ˜¯æœ‰æä¾›å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æ‹¦æˆªå™¨çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">io.grpc.ClientInterceptor</span><br><span class="line">io.grpc.ServerInterceptor</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¾¿å¯ä»¥åœ¨è¿™äº›æ‹¦æˆªä¸­åŠ å…¥åŸ‹ç‚¹é€»è¾‘ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯çš„åŸ‹ç‚¹ä»£ç å¦‚ä¸‹ <code>io.opentelemetry.instrumentation.grpc.v1_6.TracingClientInterceptor</code> ï¼š</p><p><img src="https://s2.loli.net/2024/08/26/FJgRjf1ACVlmG3D.png"></p><p>è¿™éƒ¨åˆ†ä»£ç ä¾¿æ˜¯å†™åœ¨ <code>grpc-1.6/library</code> æ¨¡å—ä¸‹çš„ã€‚</p><p>è¿™æ ·åšæœ‰ä¸€ä¸ªå¥½å¤„æ˜¯ï¼šå½“æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç ä¸æƒ³ä½¿ç”¨ <code>javaagent</code> æ—¶è¿˜å¯ä»¥æ‰‹åŠ¨å¼•å…¥ <code>grpc-1.6/library</code> åŒ…ï¼Œç„¶åä½¿ç”¨ <code>TracingClientInterceptor</code> æ‹¦æˆªå™¨ä¹Ÿå¯ä»¥å®ç° trace åŸ‹ç‚¹çš„åŠŸèƒ½ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(project(<span class="string">&quot;:instrumentation:grpc-1.6:library&quot;</span>))</span><br></pre></td></tr></table></figure><p>ä¹‹å <code>javaagent</code> è¿™ä¸ªæ¨¡å—ä¹Ÿä¼šå¼•å…¥ <code>library</code> ï¼Œç„¶åç›´æ¥ä½¿ç”¨å®ƒæä¾›çš„ API å®ç° agent çº§åˆ«çš„åŸ‹ç‚¹ã€‚</p><p>è€Œå¦‚æœä¸€äº›åº“æˆ–è€…ä¸­é—´ä»¶å¹¶æ²¡æœ‰æä¾›è¿™ç§æ‰©å±• API æ—¶ï¼Œæˆ‘ä»¬å°±åªèƒ½ä½¿ç”¨ agent çš„æ–¹å¼åœ¨å­—èŠ‚ç å±‚é¢ä¸Šè¿›è¡ŒåŸ‹ç‚¹ï¼Œè¿™æ ·å°±ä¸ä¼šé™åˆ¶æ¡†æ¶äº†ï¼Œç†è®ºä¸Šä»»ä½• Java ä»£ç éƒ½å¯ä»¥åŸ‹ç‚¹ã€‚</p><p>æ‰€ä»¥æ€»çš„æ¥è¯´ä¸€ä¸ªåº“å¯èƒ½ä¼šæ²¡æœ‰ library instrumentationï¼Œä½†ä¸€å®šä¼šæœ‰ agent instrumentationï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å½“å‰æ¡†æ¶çš„ä»£ç è¿›è¡Œé€‰æ‹©ã€‚</p><blockquote><p>è€Œè¿™é‡Œçš„ PowerJob å› ä¸ºå¹¶æ²¡æœ‰æä¾›æ‰©å±•æ¥å£ï¼Œæ‰€æœ‰åªæœ‰ agent çš„ instrumentationã€‚</p></blockquote><h1 id="æ‰¾åˆ°åŸ‹ç‚¹å…¥å£"><a href="#æ‰¾åˆ°åŸ‹ç‚¹å…¥å£" class="headerlink" title="æ‰¾åˆ°åŸ‹ç‚¹å…¥å£"></a>æ‰¾åˆ°åŸ‹ç‚¹å…¥å£</h1><p>åœ¨å¼€å§‹ç¼–ç ä¹‹å‰æˆ‘ä»¬éœ€è¦å¯¹è¦åŸ‹ç‚¹çš„åº“æˆ–è€…æ¡†æ¶æœ‰ä¸€ä¸ªæ¸…æ™°çš„ç†è§£ï¼Œè‡³å°‘å¾—çŸ¥é“å®ƒçš„æ ¸å¿ƒé€»è¾‘åœ¨å“ªé‡Œã€‚</p><p>ä»¥ PowerJob çš„è°ƒåº¦æ‰§è¡Œé€»è¾‘ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBasicProcessor</span> <span class="keyword">implements</span> <span class="title class_">BasicProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProcessResult <span class="title function_">process</span><span class="params">(TaskContext context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;======== BasicProcessor#process ========&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;TaskContext: &quot;</span> + JsonUtils.toJSONString(context) + <span class="string">&quot;;time = &quot;</span> + System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProcessResult</span>(<span class="literal">true</span>, System.currentTimeMillis() + <span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„è°ƒåº¦æ‰§è¡Œå™¨çš„å®ç°é€»è¾‘ã€‚</p></blockquote><p>ä»è¿™é‡Œçœ‹å‡ºï¼šå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨æ‰§è¡Œå™¨ä¸­åŸ‹ç‚¹ï¼Œé‚£æœ€æ ¸å¿ƒçš„å°±æ˜¯è¿™é‡Œçš„ process å‡½æ•°ã€‚</p><p>éœ€è¦åœ¨ process çš„æ‰§è¡Œå‰åæ‹¿åˆ° context æ•°æ®ï¼Œå†™å…¥åˆ° OpenTelemetry ä¸­çš„ span å³å¯ã€‚</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleCustomizedHandler</span> <span class="keyword">extends</span> <span class="title class_">IJobHandler</span> &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">execute</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReturnT</span>&lt;&gt;(<span class="string">&quot;Hello World&quot;</span>);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨ xxl-job ä¸­ï¼Œå®ƒçš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯è¿™é‡Œçš„ <code>execute</code> å‡½æ•°ã€‚</p><h1 id="é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬"><a href="#é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬" class="headerlink" title="é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬"></a>é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬</h1><p>æ‰¾åˆ°æ ¸å¿ƒçš„åŸ‹ç‚¹é€»è¾‘åè¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å·¥ä½œè¦åšï¼šé‚£å°±æ˜¯<strong>é€‰æ‹©ä½ éœ€è¦æ”¯æŒçš„ç‰ˆæœ¬</strong>ã€‚</p><p>é€‰æ‹©ç‰ˆæœ¬çš„åŸå› æ˜¯æœ‰å¯èƒ½æ¡†æ¶æˆ–åº“åœ¨ç‰ˆæœ¬è¿­ä»£è¿‡ç¨‹ä¸­æ ¸å¿ƒ API å‘ç”Ÿäº†å˜åŒ–ï¼Œæ¯”å¦‚ï¼š</p><ul><li>å‡½æ•°ç­¾åå‘ç”Ÿäº†æ”¹å˜</li><li>åŒ…åä¹Ÿå‘ç”Ÿäº†æ”¹å˜</li></ul><p>ä»¥ xxl-job ä¸ºä¾‹ï¼Œå®ƒåœ¨è¿­ä»£è¿‡ç¨‹ä¸­å°±å‘ç”Ÿäº†å‡ æ¬¡å‡½æ•°ç­¾åçš„ä¿®æ”¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸åŒçš„ç‰ˆæœ¬åšå…¼å®¹å¤„ç†ï¼š</p><p><img src="https://s2.loli.net/2024/08/26/yLhmXBKDzVaYjJ5.png"></p><p>è€Œæˆ‘è¿™é‡Œé€‰æ‹©æ”¯æŒ <code>PowerJob:4.0+</code> çš„ç‰ˆæœ¬ï¼Œå› ä¸ºç¤¾åŒºåœ¨ 4.0 ä¹‹ååšäº†å¤§é‡é‡æ„ï¼Œå¯¼è‡´ä¿®æ”¹äº†åŒ…åï¼ŒåŒæ—¶æ ¸å¿ƒé€»è¾‘çš„å‡½æ•°ç­¾åä¹Ÿæ²¡å‘ç”Ÿè¿‡å˜åŒ–ã€‚</p><p><img src="https://s2.loli.net/2024/08/26/MuRmI9e28pghzNH.png"></p><blockquote><p>4.0 ä¹‹å‰çš„ç‰ˆæœ¬æˆ‘å°±æ²¡åšå…¼å®¹äº†ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªè¡Œå®ç°ã€‚</p></blockquote><h1 id="é€»è¾‘å®ç°"><a href="#é€»è¾‘å®ç°" class="headerlink" title="é€»è¾‘å®ç°"></a>é€»è¾‘å®ç°</h1><p>é¦–å…ˆç¬¬ä¸€æ­¥éœ€è¦åˆ›å»ºä¸€ä¸ª <code>InstrumentationModule</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoService(InstrumentationModule.class)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PowerJobInstrumentationModule</span> <span class="keyword">extends</span> <span class="title class_">InstrumentationModule</span> &#123;  </span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">PowerJobInstrumentationModule</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="built_in">super</span>(<span class="string">&quot;powerjob&quot;</span>, <span class="string">&quot;powerjob-4.0&quot;</span>);  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> List&lt;TypeInstrumentation&gt; <span class="title function_">typeInstrumentations</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> asList(<span class="keyword">new</span> <span class="title class_">BasicProcessorInstrumentation</span>());  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/08/26/AxGWtdflEI5NmKn.png"></p><blockquote><p>è¿™é‡Œçš„ @AutoService æ³¨è§£ï¼Œä¼šåœ¨ä»£ç ç¼–è¯‘ä¹‹åç”Ÿæˆä¸€ä»½ SPI æ–‡ä»¶ã€‚</p></blockquote><p>ä¹‹åä¾¿æ˜¯å®ç°è¿™é‡Œæœ€æ ¸å¿ƒçš„ <code>BasicProcessorInstrumentation</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasicProcessorInstrumentation</span> <span class="keyword">implements</span> <span class="title class_">TypeInstrumentation</span> &#123;  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> ElementMatcher&lt;TypeDescription&gt; <span class="title function_">typeMatcher</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> implementsInterface(named(<span class="string">&quot;tech.powerjob.worker.core.processor.sdk.BasicProcessor&quot;</span>));  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(TypeTransformer transformer)</span> &#123;  </span><br><span class="line">    transformer.applyAdviceToMethod(  </span><br><span class="line">        named(<span class="string">&quot;process&quot;</span>).and(isPublic()).and(takesArguments(<span class="number">1</span>)),  </span><br><span class="line">        BasicProcessorInstrumentation.class.getName() + <span class="string">&quot;$ProcessAdvice&quot;</span>);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>ä»å®ƒçš„ä»£ç ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œä¸»è¦æ˜¯æŒ‡å®šæˆ‘ä»¬éœ€è¦å¯¹å“ªä¸ªæ–¹æ³•çš„å“ªä¸ªå‡½æ•°è¿›è¡ŒåŸ‹ç‚¹ï¼Œç„¶ååŸ‹ç‚¹ä¹‹åçš„å¤„ç†é€»è¾‘æ˜¯åœ¨å“ªä¸ªç±»(<code>ProcessAdvice</code>)ä¸­å®ç°çš„ã€‚</p><p>ä¹‹åä¾¿æ˜¯ <code>ProcessAdvice</code> çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ProcessAdvice</span> &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unused&quot;)</span>  </span><br><span class="line">  <span class="meta">@Advice</span>.OnMethodEnter(suppress = Throwable.class)  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">onSchedule</span><span class="params">(  </span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.This BasicProcessor handler,  </span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.Argument(<span class="number">0</span>)</span> TaskContext taskContext,  </span><br><span class="line">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelRequest&quot;</span>) PowerJobProcessRequest request,  </span><br><span class="line">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelContext&quot;</span>) Context context,  </span><br><span class="line">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelScope&quot;</span>) Scope scope) &#123;  </span><br><span class="line">    <span class="type">Context</span> <span class="variable">parentContext</span> <span class="operator">=</span> currentContext();  </span><br><span class="line">    request = PowerJobProcessRequest.createRequest(taskContext.getJobId(), handler, <span class="string">&quot;process&quot;</span>);  </span><br><span class="line">    request.setInstanceParams(taskContext.getInstanceParams());  </span><br><span class="line">    request.setJobParams(taskContext.getJobParams());  </span><br><span class="line">    context = helper().startSpan(parentContext, request);  </span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;  </span><br><span class="line">      <span class="keyword">return</span>;  </span><br><span class="line">    &#125;    scope = context.makeCurrent();  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unused&quot;)</span>  </span><br><span class="line">  <span class="meta">@Advice</span>.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">stopSpan</span><span class="params">(  </span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.Return ProcessResult result,  </span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.Thrown Throwable throwable,  </span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelRequest&quot;</span>)</span> PowerJobProcessRequest request,  </span><br><span class="line">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelContext&quot;</span>) Context context,  </span><br><span class="line">      <span class="meta">@Advice</span>.Local(<span class="string">&quot;otelScope&quot;</span>) Scope scope) &#123;  </span><br><span class="line">    helper().stopSpan(result, request, throwable, scope, context);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€ä¸»è¦çš„å°±æ˜¯ä½¿ç”¨ <code>OpenTelemetry</code> æä¾› SDK åœ¨å…¥å£å¤„è°ƒç”¨ <code>startSpan</code> å¼€å§‹ä¸€ä¸ª spanï¼Œç„¶ååœ¨å‡½æ•°é€€å‡ºæ—¶è°ƒç”¨ <code>stopSpan</code> å‡½æ•°ã€‚</p><p>åŒæ—¶åœ¨æ‰§è¡Œå‰å°†ä¸€äº›è¯·æ±‚ä¿¡æ¯å­˜èµ·æ¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request = PowerJobProcessRequest.createRequest(taskContext.getJobId(), handler, <span class="string">&quot;process&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¿™æ ·å¯ä»¥æ ¹æ®è¿™äº›è¯·æ±‚ä¿¡æ¯ç”Ÿæˆ span çš„ attributeï¼Œä¹Ÿå°±æ˜¯ jobId, jobParam ç­‰æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PowerJobExperimentalAttributeExtractor</span>  </span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">AttributesExtractor</span>&lt;PowerJobProcessRequest, Void&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(  </span></span><br><span class="line"><span class="params">      AttributesBuilder attributes,  </span></span><br><span class="line"><span class="params">      Context parentContext,  </span></span><br><span class="line"><span class="params">      PowerJobProcessRequest powerJobProcessRequest)</span> &#123;  </span><br><span class="line">    attributes.put(POWERJOB_JOB_ID, powerJobProcessRequest.getJobId());  </span><br><span class="line">    attributes.put(POWERJOB_JOB_PARAM, powerJobProcessRequest.getJobParams());  </span><br><span class="line">    attributes.put(POWERJOB_JOB_INSTANCE_PARAM, powerJobProcessRequest.getInstanceParams());  </span><br><span class="line">    attributes.put(POWERJOB_JOB_INSTANCE_TRPE, powerJobProcessRequest.getJobType());  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™é‡Œçš„ jobId&#x2F; jobParams æ•°æ®éƒ½æ˜¯ä»åˆšæ‰å†™å…¥çš„ <code>PowerJobProcessRequest</code> ä¸­è·å–çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (CAPTURE_EXPERIMENTAL_SPAN_ATTRIBUTES) &#123;  </span><br><span class="line">  builder.addAttributesExtractor(  </span><br><span class="line">      AttributesExtractor.constant(AttributeKey.stringKey(<span class="string">&quot;job.system&quot;</span>), <span class="string">&quot;powerjob&quot;</span>));  </span><br><span class="line">  builder.addAttributesExtractor(<span class="keyword">new</span> <span class="title class_">PowerJobExperimentalAttributeExtractor</span>());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶åªéœ€è¦å°†åˆšæ‰çš„ <code>PowerJobExperimentalAttributeExtractor</code> åœ¨åˆå§‹åŒ– Instrumenter æ—¶è¿›è¡Œé…ç½®ï¼Œè¿™æ · <code>OpenTelemetry</code> çš„ SDK å°±ä¼šè‡ªåŠ¨å›è°ƒè¿™ä¸ªæ¥å£ï¼Œä»è€Œè·å–åˆ° Span çš„ attributeã€‚</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.bytebuddy.matcher.ElementMatchers.isPublic;  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.bytebuddy.matcher.ElementMatchers.named;  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.bytebuddy.matcher.ElementMatchers.takesArguments;</span><br><span class="line"><span class="keyword">import</span> net.bytebuddy.asm.Advice;</span><br></pre></td></tr></table></figure><blockquote><p>å…¶å®è¿™é‡Œå¤§éƒ¨åˆ†çš„ API éƒ½æ˜¯ bytebuddy æä¾›çš„ã€‚</p></blockquote><p>ä¸çŸ¥é“å¤§å®¶æ˜¯å¦è§‰å¾—çœ¼ç†Ÿï¼ŒInstrumentation çš„å†™æ³•å…¶å®å’Œ spring çš„æ‹¦æˆªå™¨æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AroundExample</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Around(&quot;execution(* com.xyz..service.*.*(..))&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">doBasicProfiling</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"><span class="comment">// start stopwatch</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">retVal</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line"><span class="comment">// stop stopwatch</span></span><br><span class="line"><span class="keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ¯•ç«Ÿ Spring çš„æ‹¦æˆªå™¨ä¹Ÿæ˜¯ä½¿ç”¨ <code>bytebuddy</code> å®ç°çš„ã€‚</p></blockquote><h1 id="ä¸€äº›å‘"><a href="#ä¸€äº›å‘" class="headerlink" title="ä¸€äº›å‘"></a>ä¸€äº›å‘</h1><p>å…¶å®æ•´ä¸ªåŸ‹ç‚¹è¿‡ç¨‹éå¸¸ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒä¸€äº›ç°æœ‰çš„ instrumentation å°±å¯ä»¥å¾ˆå¿«å®ç°é€»è¾‘ï¼›çœŸæ­£éº»çƒ¦çš„æ—¶å€™åœ¨æäº¤ PR æ—¶éœ€è¦é€šè¿‡ CI æ ¡éªŒã€‚</p><p><img src="https://s2.loli.net/2024/08/26/ynupP2g5UMWGD3Z.png"></p><blockquote><p>æˆ‘è¿™é‡Œå¤§æ¦‚æäº¤äº† 8æ¬¡æ‰æŠŠ  CI å…¨éƒ¨è·‘é€šè¿‡ã€‚</p></blockquote><p>è¿™é‡Œé¢æœ‰å„ç§å°å‘ï¼Œåªæœ‰è‡ªå·±æäº¤è¿‡æ‰èƒ½æ„Ÿå—å¾—åˆ°ï¼Œä¸‹é¢æˆ‘å°±ä¸€ä¸€åˆ—ä¸¾ä¸€äº›å¤§å®¶å¯èƒ½ä¼šç¢°åˆ°çš„é—®é¢˜ã€‚</p><h2 id="åˆ›å»ºæ¨¡å—"><a href="#åˆ›å»ºæ¨¡å—" class="headerlink" title="åˆ›å»ºæ¨¡å—"></a>åˆ›å»ºæ¨¡å—</h2><p>é¦–å…ˆç¬¬ä¸€ä¸ªæ˜¯åˆ›å»ºæ¨¡å—çš„æ—¶å€™è®°å¾—ä½¿ç”¨ kotlin ä½œä¸º gradle çš„ DSLã€‚</p><p><img src="https://s2.loli.net/2024/08/26/ku9e3vhG5mSYPc4.png"></p><p>IDEA è¿™é‡Œé»˜è®¤é€‰æ‹©çš„æ˜¯ Groovy ä½œä¸º DSLï¼›æˆ‘å½“æ—¶æ²¡æœ‰æ³¨æ„ï¼Œåé¢åœ¨é¡¹ç›®æ„å»ºè¿‡ç¨‹ä¸­ä¸€ç›´åœ¨æŠ¥é”™ï¼Œä»”ç»†æ ¸å¯¹åå‘ç°æ˜¯ DSL çš„é—®é¢˜ï¼Œä¿®æ”¹ä¹‹åå°±èƒ½ç¼–è¯‘é€šè¿‡äº†ã€‚</p><h2 id="é¡¹ç›®æ„å»º"><a href="#é¡¹ç›®æ„å»º" class="headerlink" title="é¡¹ç›®æ„å»º"></a>é¡¹ç›®æ„å»º</h2><p>ç¬¬äºŒä¸ªæ˜¯ module çš„å‘½åè§„åˆ™ã€‚</p><p><img src="https://s2.loli.net/2024/08/26/NZgl4GUR327IXW5.png"></p><p>æˆ‘ä»¬éœ€è¦éµå®ˆ v4_0_0 çš„è§„åˆ™ï¼ŒåŒæ—¶è¿˜å¾—ä¸ <code>PowerJobInstrumentationModule</code> ä¸­å®šä¹‰çš„åç§°ç›¸åŒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">PowerJobInstrumentationModule</span><span class="params">()</span> &#123;  </span><br><span class="line">  <span class="built_in">super</span>(<span class="string">&quot;powerjob&quot;</span>, <span class="string">&quot;powerjob-4.0&quot;</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚å¦‚æœæˆ‘ä»¬çš„åŒ…åç§°æ˜¯ <code>powerjob.v1.1.0</code> ï¼Œé‚£è¿™é‡Œçš„åç§°ä¹Ÿå¾—æ˜¯ <code>&quot;powerjob-1.1.0&quot;</code></p><h1 id="Muzzle"><a href="#Muzzle" class="headerlink" title="Muzzle"></a>Muzzle</h1><p>ç¬¬ä¸‰ä¸ªæ˜¯ <code>Muzzle</code> æ ¡éªŒï¼Œ<code>Muzzle</code> æ˜¯ä¸ºäº†ä¿è¯ <code>javaagent</code> åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨æ—¶å’Œè¿è¡Œæ—¶çš„ä¾èµ–ä¸å‘ç”Ÿå†²çªè€Œå®šä¹‰çš„ä¸€ä¸ªæ ¡éªŒè§„åˆ™ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">muzzle &#123;  </span><br><span class="line">  pass &#123;  </span><br><span class="line">    group.<span class="keyword">set</span>(<span class="string">&quot;tech.powerjob&quot;</span>)  </span><br><span class="line">    module.<span class="keyword">set</span>(<span class="string">&quot;powerjob-worker&quot;</span>)  </span><br><span class="line">    versions.<span class="keyword">set</span>(<span class="string">&quot;[4.0.0,)&quot;</span>)  </span><br><span class="line">    assertInverse.<span class="keyword">set</span>(<span class="literal">true</span>)  </span><br><span class="line">    extraDependency(<span class="string">&quot;tech.powerjob:powerjob-official-processors:1.1.0&quot;</span>)  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥æˆ‘è¿™ä¸ªä¸ºä¾‹ï¼Œå®ƒçš„å«ä¹‰æ˜¯å…¼å®¹ <code>tech.powerjob:powerjob-worker:4.0.0+</code>ä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚</p><p><code>assertInverse.set(true)</code>: çš„ä½œç”¨æ˜¯ä¸ä¹‹ç›¸åçš„ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ 4.0.0 ä»¥ä¸‹çš„ç‰ˆæœ¬éƒ½ä¸åšæ”¯æŒï¼Œå¦‚æœåœ¨è¿™äº›ç‰ˆæœ¬ä¸­è¿è¡Œ javaagent æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚</p><blockquote><p>å› ä¸ºè¿™äº›ä½ç‰ˆæœ¬çš„ powerjob ä¸å…¼å®¹æˆ‘ä»¬çš„åŸ‹ç‚¹ä»£ç ã€‚</p></blockquote><p><code>extraDependency</code>ï¼šçš„ä½œç”¨æ˜¯é¢å¤–éœ€è¦ä¾èµ–çš„åŒ…ï¼Œæˆ‘è¿™é‡Œé¢å¤–ä½¿ç”¨äº†è¿™ä¸ªåŒ…é‡Œçš„ä¸€äº›ç±»ï¼Œå¦‚æœä¸åŠ ä¸Šçš„è¯åœ¨åš <code>Muzzle</code> æ ¡éªŒæ—¶ä¹Ÿä¼šå¤±è´¥ã€‚</p><h2 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h2><p>æœ€åä¾¿æ˜¯å•å…ƒæµ‹è¯•äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testBasicProcessor</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="type">long</span> <span class="variable">jobId</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">  <span class="type">String</span> <span class="variable">jobParam</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">  <span class="type">TaskContext</span> <span class="variable">taskContext</span> <span class="operator">=</span> genTaskContext(jobId, jobParam);</span><br><span class="line">  <span class="type">BasicProcessor</span> <span class="variable">testBasicProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestBasicProcessor</span>();</span><br><span class="line">  testBasicProcessor.process(taskContext);</span><br><span class="line">  testing.waitAndAssertTraces(</span><br><span class="line">      trace -&gt; &#123;</span><br><span class="line">        trace.hasSpansSatisfyingExactly(</span><br><span class="line">            span -&gt; &#123;</span><br><span class="line">              span.hasName(String.format(<span class="string">&quot;%s.process&quot;</span>, TestBasicProcessor.class.getSimpleName()));</span><br><span class="line">              span.hasKind(SpanKind.INTERNAL);</span><br><span class="line">              span.hasStatus(StatusData.unset());</span><br><span class="line">              span.hasAttributesSatisfying(</span><br><span class="line">                  attributeAssertions(</span><br><span class="line">                      TestBasicProcessor.class.getName(), jobId, jobParam, BASIC_PROCESSOR));</span><br><span class="line">            &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;AttributeAssertion&gt; <span class="title function_">attributeAssertions</span><span class="params">(</span></span><br><span class="line"><span class="params">    String codeNamespace, <span class="type">long</span> jobId, String jobParam, String jobType)</span> &#123;</span><br><span class="line">  List&lt;AttributeAssertion&gt; attributeAssertions =</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">          asList(</span><br><span class="line">              equalTo(AttributeKey.stringKey(<span class="string">&quot;code.namespace&quot;</span>), codeNamespace),</span><br><span class="line">              equalTo(AttributeKey.stringKey(<span class="string">&quot;code.function&quot;</span>), <span class="string">&quot;process&quot;</span>),</span><br><span class="line">              equalTo(AttributeKey.stringKey(<span class="string">&quot;job.system&quot;</span>), <span class="string">&quot;powerjob&quot;</span>),</span><br><span class="line">              equalTo(AttributeKey.longKey(<span class="string">&quot;scheduling.powerjob.job.id&quot;</span>), jobId),</span><br><span class="line">              equalTo(AttributeKey.stringKey(<span class="string">&quot;scheduling.powerjob.job.type&quot;</span>), jobType)));</span><br><span class="line">  <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(jobParam)) &#123;</span><br><span class="line">    attributeAssertions.add(</span><br><span class="line">        equalTo(AttributeKey.stringKey(<span class="string">&quot;scheduling.powerjob.job.param&quot;</span>), jobParam));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> attributeAssertions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•çš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯æ¨¡æ‹Ÿä¸€ä¸‹æ ¸å¿ƒé€»è¾‘çš„è°ƒç”¨ï¼Œç„¶åæ–­è¨€æ˜¯å¦å­˜åœ¨æˆ‘ä»¬é¢„æœŸçš„ Spanï¼ŒåŒæ—¶è¿˜å¾—æ ¡éªŒå®ƒçš„ attribute æ˜¯å¦ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p><p>è¿™ä¸ªå•æµ‹å½“æ—¶ä¹Ÿè°ƒäº†è®¸ä¹…ï¼Œå› ä¸º <code>versions.set(&quot;[4.0.0,)&quot;)</code> è¿™ä¸ªé…ç½®ï¼Œæœ‰ä¸€ä¸ª CI workflow ä¼šæ ¡éªŒæœ€æ–°ç‰ˆæœ¬çš„ powerjob æ˜¯å¦ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚</p><p><img src="https://s2.loli.net/2024/08/26/vDSXq9tpGW7LAdb.png"></p><p>æ¯”å¦‚å®ƒä¼šæ‹‰å–ç›®å‰æœ€æ–°çš„ä¾èµ–è¿›è¡Œæµ‹è¯•ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;tech.powerjob:powerjob-worker:5.1.0&quot;</span>)</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬åœ¨å•æµ‹ä¸­ä¾èµ–äº†æŸäº›ç‰ˆæœ¬ä¸å­˜åœ¨çš„ç±»ï¼Œæˆ–è€…æ˜¯å‡½æ•°ç­¾åå‘ç”Ÿè¿‡å˜åŒ–çš„å‡½æ•°ç”¨äºæµ‹è¯•ï¼Œé‚£è¿™ä¸ª CI å°±ä¼šæ‰§è¡Œå¤±è´¥ã€‚</p><p><img src="https://s2.loli.net/2024/08/26/HjIi5dBKlw9FxQy.png"></p><p>å› ä¸ºè¿™é‡Œçš„æ„å»ºæ—¥å¿—éå¸¸å¤šï¼ŒåŒæ—¶è¿˜æ˜¯å¹¶å‘æµ‹è¯•çš„ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç›´æ¥æŸ¥çœ‹æ—¥å¿—æ¥å®šä½é—®é¢˜ä¼šéå¸¸éº»çƒ¦ã€‚</p><p>å½“ç„¶ç¤¾åŒºä¹Ÿè€ƒè™‘åˆ°äº†ï¼Œå¯ä»¥åœ¨ <code>â€œBuild scanâ€</code> è¿™ä¸ªæ­¥éª¤ä¸­æŸ¥çœ‹ <code>gradle</code> çš„æ„å»ºæ—¥å¿—ã€‚</p><p><img src="https://s2.loli.net/2024/08/26/4xmRqFZi6NpkPML.png"></p><p><a href="https://scans.gradle.com/s/meywfxnvhhqtc/console-log/task/:instrumentation:powerjob-4.0:javaagent:compileTestJava?anchor=37&page=1">è¿™é‡Œ</a>ä¼šç›´æ¥è¾“å‡ºå…·ä½“æ˜¯å“ªé‡Œæ„å»ºå‡ºäº†é—®é¢˜ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å°±èƒ½å¾ˆå¿«å®šä½åˆ°åŸå› ã€‚</p><p>æˆ‘è¿™é‡Œä¹Ÿæ˜¯å› ä¸ºä½¿ç”¨çš„æŸäº›å¸®åŠ©å‡½æ•°åœ¨æœ€æ–°çš„ç‰ˆæœ¬ä¸­å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸ºäº†æµ‹è¯•é€šè¿‡ï¼Œå°±ä¸å¾—ä¸è°ƒæ•´æµ‹è¯•ä»£ç äº†ã€‚</p><p>å¦‚æœä½ å‘ç°å¿…é¡»å¾—ä¾èµ–è¿™äº›ç±»æˆ–è€…å‡½æ•°æ¥é…åˆæµ‹è¯•ï¼Œé‚£å°±åªæœ‰è€ƒè™‘åˆ†ä¸ºå¤šä¸ªä¸åŒçš„ç‰ˆæœ¬è¿›è¡Œæµ‹è¯•ï¼Œç±»ä¼¼äº xxl-jobï¼š</p><p><img src="https://s2.loli.net/2024/08/26/yLhmXBKDzVaYjJ5.png"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šå°±æ˜¯æ•´ä¸ª instrumentation çš„ç¼–å†™è¿‡ç¨‹ï¼Œå…¶ä¸­æ ¸å¿ƒçš„åŸ‹ç‚¹è¿‡ç¨‹å¹¶ä¸å¤æ‚ï¼Œåªè¦æˆ‘ä»¬å¯¹éœ€è¦åŸ‹ç‚¹çš„åº“æˆ–æ¡†æ¶æ¯”è¾ƒç†Ÿæ‚‰ï¼Œéƒ½å¯ä»¥å®ç°åŸ‹ç‚¹ã€‚</p><p>çœŸæ­£éº»çƒ¦çš„æ˜¯éœ€è¦é€šè¿‡ç¤¾åŒºå¤æ‚ä¸”ä¸¥è°¨çš„ CI æµç¨‹ï¼Œå¥½åœ¨ä¸ç®¡æ˜¯å“ªä¸€æ­¥çš„ CI å¤±è´¥éƒ½å¯ä»¥æŸ¥åˆ°å…·ä½“çš„åŸå› ï¼Œæœ‰ç‚¹ç±»ä¼¼äºå‡çº§æ‰“æ€ªï¼Œè·Ÿç€é”™è¯¯ä¿¡æ¯èµ°ï¼Œæœ€ç»ˆéƒ½èƒ½éªŒè¯é€šè¿‡ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/CONTRIBUTING.md">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/CONTRIBUTING.md</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/contributing/writing-instrumentation.md">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/contributing/writing-instrumentation.md</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;å› ä¸ºå…¬å¸å†…éƒ¨åœ¨ä½¿ç”¨ &lt;a href=&quot;https://github.com/PowerJob/PowerJob&quot;&gt;PowerJob&lt;/a&gt; ä½œä¸ºæˆ‘ä»¬çš„åˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿï¼ŒåŒæ—¶åˆæ˜¯ä½¿ç”¨ OpenTelemetry ä½œä¸ºå¯è§‚æµ‹çš„åº•åº§ï¼Œä½†ç›®å‰ OpenTelemetry è¿˜æ²¡æœ‰å¯¹ PowerJob æä¾›æ”¯æŒï¼Œç›®å‰ç¤¾åŒºåªå¯¹åŒç±»å‹çš„ XXL-JOB æœ‰æ”¯æŒã€‚&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/26/qfdloarJ7iNzPXy.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æ°å¥½å…¬å¸å†…éƒ¨ä¹Ÿæœ‰ä¸€äº›å¼€å‘åŒå­¦æœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/26/6aIFxlEyKt7OfsC.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;äºæ˜¯åœ¨è¿™ä¸ªèƒŒæ™¯ä¸‹æˆ‘ä¾¿å¼€å§‹ç€æ‰‹å¼€å‘ PowerJob çš„ instrumentationï¼Œæœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/26/r7xgSHKCftqvuXw.png&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/26/KNnWPzm5rU9By3c.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>æˆ‘ç”¨æˆ‘çš„270ç¯‡æ–‡ç« åšäº†ä¸€ä¸ªæ•°å­— AI æ›¿èº«</title>
    <link href="http://crossoverjie.top/2024/09/23/ob/Build-ower-AI-robot/"/>
    <id>http://crossoverjie.top/2024/09/23/ob/Build-ower-AI-robot/</id>
    <published>2024-09-23T13:54:01.000Z</published>
    <updated>2024-09-23T14:55:08.624Z</updated>
    
    <content type="html"><![CDATA[<p>23 å¹´åœ¨ ChatGPT åˆšå‡ºæ¥çš„æ—¶å€™å°±åœ¨ <a href="https://www.v2ex.com/t/931521">V ç«™</a>ä¸Šçœ‹åˆ°æœ‰ä¸€ä¸ªçœ‹åˆ°æœ‰å¤§ä½¬ç”¨è‡ªå·±çš„å¾®ä¿¡èŠå¤©è®°å½•å’Œåšå®¢æ–‡ç« ç”Ÿæˆäº†ä¸€ä¸ª AI æ›¿èº«ï¼š</p><span id="more"></span><p><img src="https://s2.loli.net/2024/09/23/7xPdy54cIEm6pnR.png" alt="image.png"></p><p>å½“æ—¶å°±æƒ³ç€è‡ªå·±åšä¸€ä¸ªï¼Œä¸è¿‡å½“æ—¶å®ç°èµ·æ¥è¿˜æ¯”è¾ƒå¤æ‚ï¼Œç›´åˆ°å¦‚ä»Š AI å·²ç»è¶Šæ¥è¶Šæ™®åŠï¼Œæƒ³åšä¸€ä¸ªè‡ªå·±çš„ AI æ›¿èº«æˆæœ¬ä¹Ÿéå¸¸ä½äº†ã€‚</p><p>äºæ˜¯å°±æœ‰äº†ä¸‹å›¾é‡Œçš„æ•ˆæœï¼š<br><img src="https://s2.loli.net/2024/09/23/vmJhURZKsg96yaY.png"><br><img src="https://s2.loli.net/2024/09/23/tOzlgqvEMdm6LFo.png"></p><p>å’Œè‡ªå·±çš„å†…å®¹è¿™ä¹ˆå¯¹è¯è¿˜æŒºæœ‰æ„æ€çš„ï¼Œç°åœ¨å¤§å®¶å°±å¯ä»¥ç›´æ¥åœ¨æˆ‘å…¬ä¼—å·å›å¤æ¶ˆæ¯å’Œâ€ä»–â€œèŠå¤©ã€‚<br><img src="https://s2.loli.net/2024/09/23/7CiykumvIdALDZe.jpg"></p><blockquote><p>ä¹Ÿå¯ä»¥é€šè¿‡å°ç¨‹åºæ¥ä½¿ç”¨ï¼š<br><img src="https://s2.loli.net/2024/09/23/9bdLkeP6XGorKAJ.png"></p></blockquote><h2 id="å¦‚ä½•æ­å»º"><a href="#å¦‚ä½•æ­å»º" class="headerlink" title="å¦‚ä½•æ­å»º"></a>å¦‚ä½•æ­å»º</h2><p>è¿™é‡Œä½¿ç”¨çš„æ•°æ®æºå…¨éƒ½æ˜¯æˆ‘å‘å¸ƒåœ¨å…¬ä¼—å·é‡Œçš„ 260 ç¯‡æ–‡ç« ã€‚<br><img src="https://s2.loli.net/2024/09/23/NWae9gRJbPHO6M8.png"></p><p>èƒ½å¤Ÿç›´æ¥è·å–åˆ°å¾®ä¿¡å…¬ä¼—å·çš„æ•°æ®ä¸€å®šæ˜¯è…¾è®¯è‡ªå·±çš„äº§å“ï¼Œå…¶å®è¿™ä¸ªäº§å“å«åšï¼š<a href="https://yuanqi.tencent.com/">è…¾è®¯å…ƒå™¨</a>ï¼Œæ˜¯è…¾è®¯å¤§æ¨¡å‹å›¢é˜ŸåŸºäºæ··å…ƒå¤§æ¨¡å‹æ¨å‡ºçš„æ™ºèƒ½åˆ›ä½œå·¥å…·ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ promptã€æ•°æ®æºã€æ’ä»¶æ¥å®ç°è‡ªå·±çš„ AI æœºå™¨äººï¼Œæˆ–è€…ç±»ä¼¼çš„äº¤äº’äº§å“ã€‚</p><p>ç›´æ¥åˆ›å»ºä¸€ä¸ªæ™ºèƒ½ä½“ï¼Œç„¶åç¼–å†™å¯¹åº”çš„æç¤ºè¯å³å¯ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œå®˜æ–¹ä¹Ÿæä¾›äº†ä¸€äº› <code>prompt</code> çš„ç¤ºä¾‹ï¼š<br><img src="https://s2.loli.net/2024/09/23/sOhwLG28i9qTcBz.png" alt="image.png"></p><p>æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å¡«å†™å°±å¯ä»¥äº†ã€‚</p><p>æœ€ä¸»è¦çš„è¿˜æ˜¯åˆ›å»ºä¸€ä¸ªçŸ¥è¯†åº“ï¼Œä¹Ÿå°±æ˜¯ä½ çš„æ•°æ®æºï¼Œå¥½åœ¨è¿™é‡Œç›´æ¥æ•´åˆäº†å…¬ä¼—å·çš„æ•°æ®ï¼›<br><img src="https://s2.loli.net/2024/09/23/sXALurKi5BRET23.png"></p><p>ç›´æ¥æˆæƒå°±å¯ä»¥ä½¿ç”¨ï¼ŒåŒæ—¶è¿˜å¯ä»¥æ¯å¤©å®šæ—¶æ›´æ–°ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p><p><img src="https://s2.loli.net/2024/09/23/TEJZ56MNCBV3aLh.png"></p><p>å®ƒä¼šæ ¹æ®ä½ çš„é—®é¢˜æ¥åˆ¤æ–­æ˜¯å¦ç”¨çŸ¥è¯†åº“çš„å†…å®¹æ¥å›ç­”ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯é—®ä¸€äº›çŸ¥è¯†åº“ä¸å­˜åœ¨çš„å†…å®¹ä¹Ÿèƒ½æ‹¿åˆ°ç»“æœã€‚</p><hr><p><img src="https://s2.loli.net/2024/09/23/AJbU4s1FXq7rSxO.png"><br>é™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥ä¸Šä¼ ä½ æœ¬åœ°çš„æ–‡ä»¶ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯ä½ æ²¡æœ‰å†™å…¬ä¼—å·ä¹Ÿå¯ä»¥ä¸Šä¼ è‡ªå·±æ•´ç†çš„å†…å®¹ã€‚</p><p>æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥è¯•è¯•å°å°é²œï¼Œåç»­æˆ‘å¯ä»¥æŒç»­å®Œå–„è¿™ä¸ªçŸ¥è¯†åº“ï¼Œæ¯”å¦‚è¾“å…¥ä¸€äº›ä»£ç ï¼Œä¹‹åå†æœ‰å‘æˆ‘å’¨è¯¢é—®é¢˜çš„æœ‹å‹å°±å¯ä»¥å…ˆå»é—®é—®â€ä»–â€œï¼Œ</p><p>å¤§å®¶å¯ä»¥ç›´æ¥åœ¨å…¬ä¼—å·é‡Œå’Œâ€å¯¹è¯â€œï¼Œè¯´ä¸å®šè¿˜æœ‰æ„å¤–æ”¶è·ğŸ¶ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;23 å¹´åœ¨ ChatGPT åˆšå‡ºæ¥çš„æ—¶å€™å°±åœ¨ &lt;a href=&quot;https://www.v2ex.com/t/931521&quot;&gt;V ç«™&lt;/a&gt;ä¸Šçœ‹åˆ°æœ‰ä¸€ä¸ªçœ‹åˆ°æœ‰å¤§ä½¬ç”¨è‡ªå·±çš„å¾®ä¿¡èŠå¤©è®°å½•å’Œåšå®¢æ–‡ç« ç”Ÿæˆäº†ä¸€ä¸ª AI æ›¿èº«ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="AI" scheme="http://crossoverjie.top/categories/AI/"/>
    
    
    <category term="AI" scheme="http://crossoverjie.top/tags/AI/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetryåœ¨ä¼ä¸šå†…éƒ¨åº”ç”¨æ‰€éœ€è¦çš„æŠ€æœ¯æ ˆ</title>
    <link href="http://crossoverjie.top/2024/09/15/ob/OpenTelemetry-enterprise/"/>
    <id>http://crossoverjie.top/2024/09/15/ob/OpenTelemetry-enterprise/</id>
    <published>2024-09-15T07:54:11.000Z</published>
    <updated>2024-09-17T11:50:48.221Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¯è§‚æµ‹æ€§æ¦‚å¿µ"><a href="#å¯è§‚æµ‹æ€§æ¦‚å¿µ" class="headerlink" title="å¯è§‚æµ‹æ€§æ¦‚å¿µ"></a>å¯è§‚æµ‹æ€§æ¦‚å¿µ</h1><p><img src="https://s2.loli.net/2024/08/08/Sdot1TJUfWgNZyu.png"><br>å½“ä¸€ä¸ªè½¯ä»¶æˆ–ç³»ç»Ÿå‡ºäºè¿è¡ŒçŠ¶æ€æ—¶ï¼Œå¦‚æœæˆ‘ä»¬ä¸å¯¹ä»–åŠ ä»¥è§‚æµ‹ï¼Œé‚£å®ƒçš„è¿è¡ŒçŠ¶æ€å¯¹æˆ‘ä»¬æ¥è¯´å°±æ˜¯ä¸€ä¸ªé»‘ç›’ã€‚</p><blockquote><p>å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p></blockquote><p>æˆ‘ä»¬åªèƒ½é€šè¿‡ä¸šåŠ¡çš„è¡¨è±¡æ¥åˆ¤æ–­å®ƒæ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæ— æ³•åœ¨æ•…éšœå‘ç”Ÿå‰è¿›è¡Œé¢„åˆ¤ï¼Œä»è€Œåªèƒ½è¢«åŠ¨è§£å†³é—®é¢˜ã€‚</p><span id="more"></span><p>è¿™ç±»é—®é¢˜åœ¨å¾®æœåŠ¡æ—¶ä»£ä½“ç°çš„æ›´åŠ æ˜æ˜¾ï¼Œå³ä¾¿æ˜¯ä¸šåŠ¡å·²ç»å‡ºç°é—®é¢˜ï¼Œåœ¨æ²¡æœ‰å¯è§‚æµ‹æ€§ç³»ç»Ÿçš„å‰æä¸‹æƒ³è¦å®šä½é—®é¢˜æ›´æ˜¯éš¾ä¸ŠåŠ éš¾ã€‚</p><p><img src="https://s2.loli.net/2024/08/08/eUFuwnPxf3cVrCL.png"><br>å¥½åœ¨å¯è§‚æµ‹æ€§è¿™ä¸ªæ¦‚å¿µç”±æ¥å·²ä¹…ï¼Œå·²ç»ç”±ä¸€äº›ä¸šç•Œå¤§ä½¬æŠ½è±¡å‡ºå‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ul><li>Logsï¼šç¦»æ•£çš„æ—¥å¿—ä¿¡æ¯</li><li>Metricsï¼šèšåˆçš„æŒ‡æ ‡</li><li>Traceï¼šè¯·æ±‚åŸºæœ¬çš„é“¾è·¯è¿½è¸ª</li></ul><p>ç»“åˆè¿™ä¸‰ä¸ªæŒ‡æ ‡ï¼Œæˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æµç¨‹ä¸€èˆ¬å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/08/08/Ixqt2WnBaz9jAQ4.png"></p><p>é¦–å…ˆæ ¹æ® metrics æ¥åˆ¤æ–­æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œè¿™ç‚¹å¯ä»¥é€šè¿‡åœ¨ Prometheus çš„ AlertManager é…ç½®ä¸€äº›æ ¸å¿ƒçš„å‘Šè­¦æŒ‡æ ‡ã€‚</p><p>æ¯”å¦‚å½“ CPUã€å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 80% æˆ–è€…æŸä¸ªåº”ç”¨ Down æœºåå°±å‘å‡ºå‘Šè­¦ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AllInstances</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">InstanceDown</span></span><br><span class="line">    <span class="comment"># Condition for alerting</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="comment"># Annotation - additional informational labels to store more information</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">title:</span> <span class="string">&#x27;Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> down&#x27;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> of job <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has been down for more than 1 minute.&#x27;</span></span><br><span class="line">    <span class="comment"># Labels - additional labels to be attached to the alert</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;critical&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/08/15/vh4t8nLk2NaXKu9.png"></p><p>è¿™å¯ä»¥è®©æˆ‘ä»¬å°½æ—©å‘ç°æ•…éšœã€‚</p><p>ä¹‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡é“¾è·¯ä¿¡æ¯æ‰¾åˆ°å‘ç”Ÿæ•…éšœçš„èŠ‚ç‚¹ã€‚<br><img src="https://s2.loli.net/2024/08/15/A4C8xQour2WqpLO.png"></p><p>ç„¶åé€šè¿‡è¿™é‡Œçš„ trace_id åœ¨åº”ç”¨ä¸­æ‰¾åˆ°å…·ä½“çš„æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdc.trace_id:4a686dedcdf4e95b1a83b36e62563a96</span><br></pre></td></tr></table></figure><p>å†æ ¹æ®æ—¥å¿—ä¸­çš„ä¸Šä¸‹æ–‡ç¡®å®šå…·ä½“çš„å¼‚å¸¸åŸå› ã€‚</p><p>è¿™å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ’æŸ¥é—®é¢˜çš„æµç¨‹ã€‚</p><h1 id="OpenTelemetry-å‘å±•å†å²"><a href="#OpenTelemetry-å‘å±•å†å²" class="headerlink" title="OpenTelemetry å‘å±•å†å²"></a>OpenTelemetry å‘å±•å†å²</h1><p><img src="https://s2.loli.net/2024/08/08/p5WkVbSarUdIQwT.png" alt="image.png"><br><img src="https://s2.loli.net/2024/08/08/pvMEBObGgHcdRom.png"><br>åœ¨ OpenTelemetry å¼€å§‹ä¹‹å‰è¿˜æ˜¯å…ˆå›é¡¾ä¸‹å¯è§‚æµ‹æ€§çš„å‘å±•å†å²ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªé‡è¦æ—¶é—´ç‚¹ï¼š</p><ul><li>2010 å¹´ Google å‘å¸ƒäº† Dapper è®ºæ–‡ï¼Œç»™ä¸šç•Œå¸¦æ¥äº†å®ç°åˆ†å¸ƒå¼è¿½è¸ªçš„ç†è®ºæ”¯æŒï¼Œä¹‹åçš„è®¸å¤šåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªå®ç°éƒ½æœ‰å®ƒçš„å½±å­</li><li>kubernetes çš„å‘å¸ƒå¥ å®šäº†åç»­äº‘åŸç”Ÿç¤¾åŒºçš„åŸºç¡€</li><li>Jaeger å‘å¸ƒåæˆä¸ºäº†ä¸»æµçš„é“¾è·¯å­˜å‚¨ç³»ç»Ÿ</li><li>2019 å¹´ OpenTracing å’Œ OpenCensus åˆå¹¶ä¸º OpenTelemetry</li><li>2021 å¹´åº• OpenTelemetry å‘å¸ƒç¬¬ä¸€ä¸ª GA release ç‰ˆæœ¬</li></ul><h2 id="OpenTelemetry-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#OpenTelemetry-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="OpenTelemetry æ˜¯ä»€ä¹ˆï¼Ÿ"></a>OpenTelemetry æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><img src="https://s2.loli.net/2024/08/08/FDzVTSqruLxY8EX.png"></p><p>ä»¥å‰æˆ‘ä»¬æ‰€æ¥è§¦åˆ°çš„ç±»ä¼¼äºé˜¿é‡Œçš„ARMSã€ç¾å›¢çš„ CATã€Pinpoint è¿™ç±»ç³»ç»Ÿå¤§å¤šéƒ½æœ‰ä¸€ä¸ªå…¬å¸åœ¨èƒŒåè¿›è¡Œé©±åŠ¨ï¼Œä¸å‚å•†ç»‘å®šçš„éå¸¸ç´§å¯†ã€‚</p><p>è€Œ OpenTelemetry åˆ™ç›¸åï¼Œå®ƒä¸»è¦ç”±ç¤¾åŒºé©±åŠ¨ï¼Œå‚ä¸çš„å…¬å¸ä¼—å¤šï¼›åŒæ—¶å®ƒå®šä¹‰å’Œæä¾›äº†ä¸€å¥—å¯è§‚æµ‹æ€§çš„æ ‡å‡†ï¼ˆåŒ…æ‹¬ APIã€SDKã€è§„èŒƒç­‰æ•°æ®ï¼‰ã€‚</p><p>ä½¿ç”¨å®ƒä½ å¯ä»¥çµæ´»çš„é€‰æ‹©å’Œæ­é…ä»»æ„çš„å¼€æºæˆ–å•†ä¸šäº§å“æ¥ç»„æˆä½ çš„å¯è§‚æµ‹æ€§æŠ€æœ¯æ ˆã€‚</p><p><img src="https://s2.loli.net/2024/08/08/8RJ6H75hsICWgcD.png"></p><p>å› ä¸ºç¤¾åŒºéå¸¸æ´»è·ƒï¼Œæ‰€ä»¥å½“å‰ä¹Ÿå‡ ä¹æ”¯æŒä¸»æµçš„å¼€å‘è¯­è¨€ã€‚</p><h2 id="OpenTelemetry-çš„æ¶æ„"><a href="#OpenTelemetry-çš„æ¶æ„" class="headerlink" title="OpenTelemetry çš„æ¶æ„"></a>OpenTelemetry çš„æ¶æ„</h2><p><img src="https://s2.loli.net/2024/08/08/DMd1JfcCrO7Pm52.png"><br>OpenTelemetry çš„æ¶æ„ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>å·¦ä¾§çš„å®¢æˆ·ç«¯ Agentï¼Œç”¨äºé‡‡é›†å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œé€šå¸¸å°±æ˜¯æˆ‘ä»¬çš„åº”ç”¨ã€‚</li><li>ä¸­é—´çš„æ˜¯ Collector-Serviceï¼Œç”¨äºæ¥å—å®¢æˆ·ç«¯çš„æ•°æ®ã€å†…éƒ¨å¤„ç†ã€å¯¼å‡ºæ•°æ®åˆ°å„ç§å­˜å‚¨</li><li>å³ä¾§çš„åˆ™æ˜¯å„ç§å­˜å‚¨å±‚ï¼Œç”¨äºå­˜å‚¨ Metricsã€Logsã€Traces è¿™äº›æ•°æ®ã€‚</li></ul><p>æˆ‘ä»¬åŸºäºå®˜æ–¹æ¨èçš„æŠ€æœ¯æ¶æ„é€‰å‹äº†æˆ‘ä»¬çš„æŠ€æœ¯æ ˆï¼š<br><img src="https://s2.loli.net/2024/08/09/XTzCOPBI6HYNta1.png" alt="image.png"><br>ä¸»è¦çš„åŒºåˆ«å°±æ˜¯ä½¿ç”¨ VictoriaMetrics å­˜å‚¨æŒ‡æ ‡ã€StackRocks å­˜å‚¨ Traceï¼ŒElasticSearch å­˜å‚¨æ—¥å¿—ã€‚</p><blockquote><p>åªæ˜¯ç›®å‰æˆ‘ä»¬çš„æ—¥å¿—é“¾è·¯è¿˜æ²¡æœ‰å®Œå…¨åˆ‡æ¢åˆ° OpenTelemetry çš„é“¾è·¯ï¼Œä¾ç„¶æ˜¯åœ¨ Pod ä¸­æŒ‚è½½äº†ä¸€ä¸ª sidecarï¼Œåœ¨è¿™ä¸ª sidecar ä¸­é€šè¿‡ filebeat é‡‡é›†æ—¥å¿—è¾“å‡ºåˆ° elasticsearchï¼Œåç»­ä¹Ÿä¼šé€æ­¥è¿ç§»ã€‚</p></blockquote><h2 id="æ ¸å¿ƒé¡¹ç›®"><a href="#æ ¸å¿ƒé¡¹ç›®" class="headerlink" title="æ ¸å¿ƒé¡¹ç›®"></a>æ ¸å¿ƒé¡¹ç›®</h2><h3 id="Collecotor"><a href="#Collecotor" class="headerlink" title="Collecotor"></a>Collecotor</h3><p>OpenTelemetry ç¤¾åŒºçš„é¡¹ç›®ä¼—å¤šï¼Œå…¶ä¸­å¤§éƒ¨åˆ†éƒ½æ˜¯å„ç§è¯­è¨€çš„ SDK å’Œ APIï¼Œå…¶ä¸­æœ€ä¸ºå…³é”®çš„åº”è¯¥å°±æ˜¯ <a href="https://github.com/open-telemetry?q=opentelemetry-collector&type=all&language=&sort=">opentelemetry-collector</a></p><p>ä¹Ÿå°±æ˜¯åˆšæ‰æ¶æ„å›¾ä¸­çš„ä¸­é—´éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£ä¸ºç±»ä¼¼ APIGateway çš„è§’è‰²ï¼Œæ‰€æœ‰ä¸ŠæŠ¥çš„ OTel æ•°æ®éƒ½å¾—ç»è¿‡å®ƒçš„å¤„ç†ã€‚</p><p><img src="https://s2.loli.net/2024/08/16/UfuI2wHtojqNS96.png"></p><p>ä¸»è¦ç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>Receiverï¼šç”¨äºæ¥å—å®¢æˆ·ç«¯ä¸ŠæŠ¥çš„æ•°æ®</li><li>Processï¼šå†…éƒ¨çš„æ•°æ®å¤„ç†å™¨</li><li>Exporterï¼šå°†æ•°æ®å¯¼å‡ºåˆ°ä¸åŒçš„å­˜å‚¨</li></ul><p>ç”±äº OpenTelemetry ç¤¾åŒºéå¸¸çš„æ´»è·ƒï¼Œæ‰€ä»¥è¿™é‡Œæ”¯æŒçš„ <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver">Receiver</a>ã€<a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor">Processor</a> å’Œ <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter">Exporter</a> ç±»å‹éå¸¸å¤šã€‚</p><p><img src="https://s2.loli.net/2024/08/16/hTeuXskGMitYFCr.png"><br><img src="https://s2.loli.net/2024/08/16/EqPcjxK3Myr2LUC.png"><br><img src="https://s2.loli.net/2024/08/16/btqTu9gAl7heJra.png"></p><h3 id="å…¶ä»–æ ¸å¿ƒé¡¹ç›®"><a href="#å…¶ä»–æ ¸å¿ƒé¡¹ç›®" class="headerlink" title="å…¶ä»–æ ¸å¿ƒé¡¹ç›®"></a>å…¶ä»–æ ¸å¿ƒé¡¹ç›®</h3><p>æˆ‘ä»¬ä»¥ Java ä¸ºä¾‹ï¼Œå¯¹ä¸šåŠ¡å¼€å‘æœ€é‡è¦çš„åº“å°±æ˜¯ <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/">opentelemetry-java-instrumentation</a></p><p>å®ƒå¯ä»¥æ‰“åŒ…ä¸€ä¸ª javaagent ç»™æˆ‘ä»¬ä½¿ç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Java example</span></span><br><span class="line">java -javaagent:path/to/opentelemetry-javaagent.jar \  </span><br><span class="line">     -jar myapp.jar</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/08/16/YjzfWKFxPOqH5N6.png"></p><p>åŒæ—¶ä¹Ÿæ”¯æŒäº†æˆ‘ä»¬æ—¥å¸¸å¼€å‘çš„ç»å¤§å¤šæ•°æ¡†æ¶å’Œä¸­é—´ä»¶ã€‚</p><blockquote><p>æ”¯æŒçš„<a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md">åº“ä¸æ¡†æ¶</a>åˆ—è¡¨</p></blockquote><p>å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨ä¸­è‡ªå®šä¹‰æ‰“æ¡©ä¸€äº› Spanã€Metrics ï¼Œå°±è¿˜éœ€è¦ <a href="https://github.com/open-telemetry/opentelemetry-java">opentelemetry-java</a> è¿™ä¸ªé¡¹ç›®ã€‚</p><p>å®ƒæä¾›äº†å…·ä½“çš„ SDK å¯ä»¥æ–¹ä¾¿çš„åˆ›å»º Span å’Œ Metricsã€‚</p><h1 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h1><p>ä¹‹åæ¥çœ‹çœ‹ <code>OpenTelemetry</code> ä¸­å…·ä½“çš„ä¸‰ä¸ªç»´åº¦çš„æ¦‚å¿µå’Œåº”ç”¨ï¼Œé¦–å…ˆæ˜¯ Traceã€‚</p><p><img src="https://s2.loli.net/2024/08/16/DAB7J5Rpx8OFs6L.png"></p><p>Trace è¿™ä¸ªæ¦‚å¿µé¦–å…ˆæ˜¯ <a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/papers/dapper-2010-1.pdf">Google Dapper</a> è®ºæ–‡ä¸­æåˆ°ã€‚</p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼šä¸€æ¬¡ç”¨æˆ·è¯·æ±‚ç»å†äº† 4 æ¬¡ PRC è°ƒç”¨ï¼Œåˆ†åˆ«ä¹Ÿå±äºä¸åŒçš„ç³»ç»Ÿã€‚</p><p>æ¯ä¸€æ¬¡ RPC è°ƒç”¨å°±ä¼šäº§ç”Ÿä¸€ä¸ª Spanï¼Œå°†è¿™äº› span ä¸²è”èµ·æ¥å°±èƒ½å½¢æˆä¸€ä¸ªè°ƒç”¨é“¾è·¯ã€‚</p><p>è¿™ä¸ª Span ä¸»è¦åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li>SpanName</li><li>ParentID</li><li>SpanID</li></ul><p>å½“æˆ‘ä»¬å°†ä¸€ä¸ª Span æ”¾å¤§åä¼šçœ‹åˆ°æ›´åŠ å…·ä½“çš„ä¿¡æ¯ï¼š</p><ul><li>TraceId</li><li>SpanName</li><li>ParentID</li><li>SpanID</li><li>å¼€å§‹æ—¶é—´</li><li>ç»“æŸæ—¶é—´<br>åœ¨ Dapper è®ºæ–‡ä¸­ä½¿ç”¨ Annotations æ¥å­˜æ”¾ span çš„å±æ€§ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å­˜æ”¾ä¸€äº›æ•°æ®ï¼Œæ¯”å¦‚å›¾ä¸­çš„ <code>&quot;foo&quot;</code>ã€‚</li></ul><blockquote><p>åœ¨ OpenTelemetry çš„ SDK ä¸­ç§°ä¸º  attributeï¼Œè€Œåœ¨ Jaeger çš„ UI ä¸­åˆç§°ä¸º tagï¼Œè™½ç„¶å«æ³•ä¸åŒï¼Œä½†æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¸œè¥¿ã€‚</p></blockquote><p>æœ€ç»ˆå°±ä¼šå½¢æˆä¸Šå›¾ä¸­çš„æ ‘çŠ¶ç»“æ„çš„è°ƒç”¨å…³ç³»ã€‚</p><h2 id="Span-Kind"><a href="#Span-Kind" class="headerlink" title="Span Kind"></a>Span Kind</h2><p><img src="https://s2.loli.net/2024/08/16/XSAGlCY7F4f1pu5.png"><br>Span ä¸­è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå°±æ˜¯ Span Kindï¼Œä¹Ÿå°±æ˜¯ Span çš„ç±»å‹ï¼Œè¿™ä¸ªç±»å‹å¯ä»¥åœ¨æ’æŸ¥é—®é¢˜æ—¶å¾ˆå®¹æ˜“å¾—çŸ¥è¯¥æœåŠ¡çš„ç±»å‹ã€‚</p><p><img src="https://s2.loli.net/2024/08/16/cqezfgKSylJipRB.png"><br>æŒ‰ç…§å®˜æ–¹çš„å®šä¹‰ï¼ŒSpan çš„ç±»å‹åˆ†ä¸ºï¼š</p><ul><li>Client</li><li>Server</li><li>Internal</li><li>Producer</li><li>Consumer</li></ul><p>å¯¹äº RPC çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è‡ªç„¶å°±å¯¹åº” Client å’Œ Serverï¼Œè€Œä½¿ç”¨äº†æ¶ˆæ¯é˜Ÿåˆ—çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…å¯¹åº”çš„å°±æ˜¯ Produce å’Œ Consumerã€‚</p><p>é™¤æ­¤ä¹‹å¤–å‘ç”Ÿåœ¨åº”ç”¨å†…éƒ¨çš„ä¸€äº›å…³é”® Span çš„ç±»å‹å°±æ˜¯ Internalï¼Œæ¯”å¦‚æˆ‘ä»¬éœ€è¦å¯¹ä¸šåŠ¡çš„æŸäº›å…³é”®å‡½æ•°ç”Ÿæˆ Span æ—¶ï¼Œæ­¤æ—¶çš„ Span ç±»å‹é€šå¸¸ä¹Ÿéƒ½æ˜¯ Internalã€‚</p><h2 id="ä¸Šä¸‹æ–‡ä¼ é€’"><a href="#ä¸Šä¸‹æ–‡ä¼ é€’" class="headerlink" title="ä¸Šä¸‹æ–‡ä¼ é€’"></a>ä¸Šä¸‹æ–‡ä¼ é€’</h2><p><img src="https://s2.loli.net/2024/08/09/v1mwnLEGNlKMbsq.png" alt="image.png"></p><p>åœ¨ Trace ä¸­æœ‰ä¸€ä¸ªå…³é”®æŠ€æœ¯é—®é¢˜éœ€è¦è¢«è§£å†³ï¼Œä¹Ÿå°±æ˜¯ Context çš„ä¸Šä¸‹æ–‡ä¼ é€’ã€‚</p><p>è¿™ä¸ªç‰¹åˆ«æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¿…é¡»è¦è§£å†³ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•æŠŠå®ƒç†è§£ä¸ºå¦‚ä½•æŠŠä¸Šæ¸¸ç”Ÿæˆçš„ trace_id ä¼ é€’åˆ°ä¸‹æ¸¸ï¼Œè¿™æ ·æ‰èƒ½åœ¨è¿½è¸ªçš„é“¾è·¯è¿½è¸ªç³»ç»Ÿä¸­ä¸²è”èµ·æ¥ã€‚</p><p>è¿™ä¸ªå…³é”®çš„æŠ€æœ¯åè¯åœ¨ OpenTelemetry ä¸­ç§°ä¸ºï¼š<a href="https://opentelemetry.io/docs/concepts/context-propagation/">Context Propagation</a>.</p><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ•°æ®éƒ½æ˜¯é€šè¿‡ç½‘ç»œä¼ é€’çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„æœ¬è´¨é—®é¢˜ä¾ç„¶æ˜¯å¦‚ä½•å°†ä¸Šä¸‹æ–‡æ•°æ®åºåˆ—åŒ–ä¹‹åï¼Œåœ¨ä¸‹æ¸¸å¯ä»¥ååºåˆ—åŒ–åˆ° <code>Context</code> ä¸­ã€‚</p><p>èªæ˜çš„å°ä¼™ä¼´åº”è¯¥å·²ç»æƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥å°† trace_id å†™å…¥åˆ°è·¨è¿›ç¨‹è°ƒç”¨çš„å…ƒæ•°æ®ä¸­ï¼š</p><ul><li>http å¯ä»¥å­˜æ”¾åœ¨ http header ä¸­</li><li>gRPC å¯ä»¥å­˜æ”¾åœ¨ meta ä¸­</li><li>Pulsar å¯ä»¥å­˜æ”¾åœ¨æ¶ˆæ¯çš„ properties ä¸­</li><li>å…¶ä½™çš„ä¸­é—´ä»¶å’Œæ¡†æ¶ä¹Ÿæ˜¯åŒç†</li></ul><p>ç„¶ååœ¨è¿œç¨‹è°ƒç”¨ä¹‹å‰ä½¿ç”¨ <code>Inject</code> å°†æ•°æ®æ³¨å…¥åˆ°è¿™äº›å…ƒæ•°æ®é‡Œï¼Œä¸‹æ¸¸åœ¨æ¥æ”¶åˆ°è¯·æ±‚åå†é€šè¿‡ä¸€ä¸ª<code>Extract</code> å‡½æ•°å°†å…ƒæ•°æ®è§£æåˆ° <code>Context</code> ä¸­ï¼Œè¿™æ · <code>trace_id</code> å°±å¯ä»¥ä¸²è”èµ·æ¥äº†ã€‚</p><p><img src="https://s2.loli.net/2024/08/08/wfKZNacuBJeMDO1.png" alt="image.png"></p><p><img src="https://s2.loli.net/2024/08/08/NHOYS9R1EIZrBhd.png" alt="image.png"></p><p>ä¸Šå›¾å°±æ˜¯ Pulsar å’Œ gRPC ä¼ é€’ trace_id çš„è¿‡ç¨‹ï¼Œæ•°æ®éƒ½æ˜¯å­˜æ”¾åœ¨å…ƒæ•°æ®ä¸­çš„ï¼Œè¿™é‡Œçš„ <code>traceparent</code> çš„å€¼æœ¬è´¨ä¸Šå°±æ˜¯ trace_id.</p><blockquote><p>å…·ä½“çš„ä»£ç ç»†èŠ‚æˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡ç»§ç»­åˆ†æã€‚</p></blockquote><h1 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h1><p><img src="https://s2.loli.net/2024/08/09/HfFnubtAKvJ8hVy.png"></p><p>Metrics ç›¸å¯¹äº Trace æ¥è¯´åˆ™æ˜¯è¦ç®€å•è®¸å¤šï¼ŒOpenTelemetry å®šä¹‰äº†è®¸å¤šå‘½åè§„èŒƒå’Œæ ‡å‡†ï¼Œè¿™æ ·å¤§å®¶åœ¨å¤ç”¨ç¤¾åŒºçš„ä¸€äº›ç›‘æ§æ¨¡æ¿æ—¶å°±è¦æ›´åŠ å®¹æ˜“ä¸€äº›ã€‚</p><h2 id="Metrics-Exemplars"><a href="#Metrics-Exemplars" class="headerlink" title="Metrics Exemplars"></a>Metrics Exemplars</h2><p><img src="https://s2.loli.net/2024/08/09/tOlkQFZBH421wri.png"></p><p>Metrics è¿˜æä¾›äº†ä¸€ä¸ª Exemplar çš„åŠŸèƒ½ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å¯ä»¥å°† Metrics å’Œ Trace å…³è”åœ¨ä¸€èµ·ï¼Œè¿™æ ·åœ¨é€šè¿‡ Metrics å‘ç°é—®é¢˜æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥è·³è½¬åˆ°é“¾è·¯ç³»ç»Ÿã€‚</p><p>å› ä¸º trace_id å¯ä»¥é€šè¿‡ MDC å’Œæ—¥å¿—å…³è”ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ Metrics å®šä½å…·ä½“åº”ç”¨çš„æ—¥å¿—ï¼Œè¿™æ ·æ’æŸ¥é—®é¢˜çš„æ•ˆç‡å°†ä¼šéå¸¸é«˜ã€‚</p><h1 id="æ‰©å±•ä¿¡æ¯"><a href="#æ‰©å±•ä¿¡æ¯" class="headerlink" title="æ‰©å±•ä¿¡æ¯"></a>æ‰©å±•ä¿¡æ¯</h1><p>ä»¥ä¸Šå°±æ˜¯å…³äº OpenTelemetry çš„æ•´ä½“æ¶æ„ï¼Œä¸‹é¢æ¥æ‰©å±•ä¸€äº›å†…å®¹ã€‚</p><h2 id="eBPF"><a href="#eBPF" class="headerlink" title="eBPF"></a>eBPF</h2><p><img src="https://s2.loli.net/2024/08/16/KPxF6kvcBCX4JER.png"><br>eBPF æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ Linux å†…æ ¸ä¸­çš„è™šæ‹Ÿæœºï¼Œå®ƒæä¾›ä¸€å¥—ç‰¹æ®Šçš„æŒ‡ä»¤é›†å¹¶å…è®¸æˆ‘ä»¬åœ¨ä¸é‡æ–°ç¼–è¯‘å†…æ ¸ã€ä¹Ÿä¸éœ€è¦é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹åŠ è½½è‡ªå®šä¹‰çš„é€»è¾‘ã€‚</p><p>eBPF æŠ€æœ¯å…·æœ‰ä¸‰å¤§ç‰¹ç‚¹ï¼š</p><ul><li>ç¬¬ä¸€æ˜¯<strong>æ— ä¾µå…¥</strong>ï¼ŒåŠ¨æ€æŒ‚è½½ï¼Œç›®æ ‡è¿›ç¨‹æ— éœ€é‡å¯ï¼Œè€Œä¸”å› ä¸ºæ˜¯ Linux å†…æ ¸æä¾›åŠŸèƒ½ï¼Œæ‰€ä»¥ä¸è¯­è¨€æ— å…³ï¼Œä»»ä½•è¯­è¨€éƒ½å¯ä»¥æ”¯æŒã€‚</li><li>ç¬¬äºŒæ˜¯<strong>é«˜æ€§èƒ½</strong>ï¼ŒeBPF å­—èŠ‚ç ä¼šè¢« JIT æˆæœºå™¨ç åæ‰§è¡Œï¼Œæ•ˆç‡éå¸¸é«˜ï¼›</li><li>ç¬¬ä¸‰æ˜¯æ›´åŠ <strong>å®‰å…¨</strong>ï¼Œå®ƒä¼šè¿è¡Œåœ¨è‡ªå·±çš„æ²™ç®±ç¯å¢ƒä¸­ï¼Œä¸ä¼šå¯¼è‡´ç›®æ ‡è¿›ç¨‹å´©æºƒã€‚</li></ul><p>eBPF è™½ç„¶æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸€äº›å±€é™æ€§ï¼Œæ¯”å¦‚æˆ‘æƒ³ç›‘æ§ä¸šåŠ¡ä»£ç ä¸­çš„æŸä¸ªå…·ä½“æŒ‡æ ‡ï¼ˆè®¢å•åˆ›å»ºæ•°é‡ï¼‰ï¼Œæ­¤æ—¶å®ƒå°±éš¾ä»¥å®ç°äº†ï¼Œæ‰€ä»¥è¿˜å¾—çœ‹æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯ã€‚<br>æ›´é€‚åˆä¸€äº›äº‘å¹³å°ï¼Œæˆ–è€…æ›´åå‘åº•å±‚çš„åº”ç”¨ã€‚</p><p>ç›®å‰ eBPF çš„åº”ç”¨åœºæ™¯è¿˜ä¸å¤Ÿå¹¿æ³›ï¼Œä½†å‡ä»¥æ—¶æ—¥ä¸€å®šä¼šæˆä¸ºå¯è§‚æµ‹é¢†åŸŸçš„æœªæ¥ä¹‹æ˜Ÿã€‚</p><h2 id="SigNoz"><a href="#SigNoz" class="headerlink" title="SigNoz"></a><a href="https://signoz.io/">SigNoz</a></h2><p>ä¸çŸ¥é“å¤§å®¶å‘ç°æ²¡æœ‰ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ OpenTelemetry æŠ€æœ¯æ ˆä¼šéœ€è¦ä¸º Traceã€Metricsã€Logs é€‰æ‹©ä¸åŒçš„å­˜å‚¨ï¼Œè€Œä¸”ä»–ä»¬çš„æŸ¥è¯¢ç•Œé¢ä¹Ÿåˆ†æ•£åœ¨ä¸åŒçš„åœ°æ–¹ã€‚</p><p>é‚£æœ‰æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„å¹³å°å¯ä»¥ç»™æˆ‘ä»¬æä¾›å®Œæ•´çš„å¯è§‚æµ‹ä½“éªŒå‘¢ï¼Ÿ</p><p>æœ‰è¿™æ ·çš„éœ€æ±‚é‚£å°±æœ‰å¯¹åº”çš„å‚å•†å®ç°äº†ï¼š<br><img src="https://s2.loli.net/2024/08/09/YZbT3CrlGwoceDE.png"></p><p><a href="https://signoz.io/">SigNoz</a> å°±æ˜¯è¿™æ ·çš„å¹³å°ï¼Œå®ƒå°† OpenTelemetry-collector å’Œæ•°æ®å­˜å‚¨å…¨éƒ¨æ•´åˆåœ¨äº†ä¸€èµ·ï¼ŒåŒæ—¶å…¨é¢å…¼å®¹  OpenTelemetryï¼›å¯ä»¥è¯´å®ƒå°±æ˜¯åŸºäº OpenTelemetry æ„å»ºçš„ä¸€ä¸ªå¯è§‚æµ‹äº§å“ã€‚</p><p>å¯¹äºä¸€äº›ä¸­å°å‚å•†ï¼Œä¸æƒ³å•ç‹¬ç»´æŠ¤è¿™äº›ç»„ä»¶æ—¶æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p><h2 id="OpenObserve"><a href="#OpenObserve" class="headerlink" title="OpenObserve"></a><a href="https://openobserve.ai/">OpenObserve</a></h2><p><img src="https://s2.loli.net/2024/08/16/CuzXT7ts6vWQAEO.png" alt="image.png"></p><p><a href="https://openobserve.ai/">OpenObserve</a>åœ¨ SigNoz çš„åŸºç¡€ä¸Šåšçš„æ›´åŠ æè‡´ä¸€äº›ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„å­˜å‚¨å¯ä»¥å­˜æ”¾æ—¥å¿—ã€Traceã€Metrics ç­‰æ•°æ®ã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åªä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“å­˜æ”¾æ‰€æœ‰çš„æ•°æ®ï¼ŒåŒæ—¶å®ƒä¹Ÿæä¾›äº†å®Œæ•´çš„ UIï¼Œå¹¶ä¸”ä¹Ÿå…¨é¢å…¼å®¹ OpenTelemetryã€‚</p><p>è¿™æ ·å¯¹äºè¿ç»´æ¥è¯´ä¼šæ›´åŠ ç®€å•ï¼Œåªæ˜¯å¯èƒ½å¸¦æ¥çš„å‰¯ä½œç”¨å°±æ˜¯éœ€è¦ä¸å®ƒå®Œå…¨ç»‘å®šã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šå°±æ˜¯ OpenTelemetry åœ¨ä¼ä¸šçš„åº”ç”¨ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µé€‰æ‹©è‡ªå»º OTel çš„æŠ€æœ¯æ ˆï¼Œè¿˜æ˜¯é€‰æ‹© SigNoz å’Œ OpenObserve è¿™ç±»çš„æ ‡å‡†åŒ–äº§å“ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å¯è§‚æµ‹æ€§æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#å¯è§‚æµ‹æ€§æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;å¯è§‚æµ‹æ€§æ¦‚å¿µ&quot;&gt;&lt;/a&gt;å¯è§‚æµ‹æ€§æ¦‚å¿µ&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/08/Sdot1TJUfWgNZyu.png&quot;&gt;&lt;br&gt;å½“ä¸€ä¸ªè½¯ä»¶æˆ–ç³»ç»Ÿå‡ºäºè¿è¡ŒçŠ¶æ€æ—¶ï¼Œå¦‚æœæˆ‘ä»¬ä¸å¯¹ä»–åŠ ä»¥è§‚æµ‹ï¼Œé‚£å®ƒçš„è¿è¡ŒçŠ¶æ€å¯¹æˆ‘ä»¬æ¥è¯´å°±æ˜¯ä¸€ä¸ªé»‘ç›’ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æˆ‘ä»¬åªèƒ½é€šè¿‡ä¸šåŠ¡çš„è¡¨è±¡æ¥åˆ¤æ–­å®ƒæ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæ— æ³•åœ¨æ•…éšœå‘ç”Ÿå‰è¿›è¡Œé¢„åˆ¤ï¼Œä»è€Œåªèƒ½è¢«åŠ¨è§£å†³é—®é¢˜ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>æ—¥å¿—ä¸è¿½è¸ªçš„å®Œç¾èåˆï¼šOpenTelemetry MDC å®è·µæŒ‡å—</title>
    <link href="http://crossoverjie.top/2024/09/05/ob/OpenTelemetry-client-log-mdc/"/>
    <id>http://crossoverjie.top/2024/09/05/ob/OpenTelemetry-client-log-mdc/</id>
    <published>2024-09-05T06:50:33.000Z</published>
    <updated>2024-09-10T13:41:32.260Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨å‰é¢ä¸¤ç¯‡å®æˆ˜æ–‡ç« ä¸­ï¼š</p><ul><li><a href="https://juejin.cn/post/7391744486979076146">OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª</a></li><li><a href="https://juejin.cn/post/7394395254566846475">OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åº”ç”¨æŒ‡æ ‡ç›‘æ§</a></li></ul><p>è¦†ç›–äº†å¯è§‚æµ‹ä¸­çš„æŒ‡æ ‡è¿½è¸ªå’Œ <code>metrics</code> ç›‘æ§ï¼Œä¸‹é¢ç†åº”å¼€å§‹ç¬¬ä¸‰éƒ¨åˆ†ï¼š<strong>æ—¥å¿—</strong>ã€‚</p><p>ä½†åœ¨å¼€å§‹æ—¥å¿—ä¹‹å‰è¿˜æ˜¯è¦å…ˆå°†é“¾è·¯è¿½è¸ªå’Œæ—¥å¿—ç»“åˆèµ·æ¥çœ‹çœ‹åº”ç”¨å®é™…ä½¿ç”¨çš„å®è·µã€‚</p><p>é€šå¸¸æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æ–¹å¼æ˜¯å…ˆæŸ¥è¯¢å¼‚å¸¸æ—¥å¿—ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ç³»ç»Ÿçš„é—®é¢˜ã€‚</p><p>å¦‚æœä¸æ˜¯ï¼Œåˆ™åœ¨æ—¥å¿—ä¸­æå‡º <code>trace_id</code> å†åˆ°é“¾è·¯æŸ¥è¯¢ç³»ç»Ÿä¸­æŸ¥è¯¢é“¾è·¯ï¼Œçœ‹çœ‹å…·ä½“æ˜¯å“ªä¸ªç³»ç»Ÿçš„é—®é¢˜ï¼Œç„¶åå†åšå…·ä½“çš„æ’æŸ¥ã€‚</p><p>ç±»ä¼¼äºè¿™æ ·ï¼š<br><img src="https://s2.loli.net/2024/08/05/mP97tShHKrGXge2.png"><br>æ—¥å¿—ä¸­ä¼šæ‰“å° <code>trace_id</code> å’Œ <code>span_id</code>ã€‚</p><blockquote><p>å¦‚æœæ—¥å¿—ç³»ç»Ÿåšçš„æ¯”è¾ƒå®Œå–„çš„è¯ï¼Œè¿˜å¯ä»¥ç›´æ¥ç‚¹å‡» <code>trace_id</code> è·³è½¬åˆ°é“¾è·¯ç³»ç»Ÿé‡Œç›´æ¥æŸ¥è¯¢é“¾è·¯ä¿¡æ¯ã€‚</p></blockquote><span id="more"></span><h1 id="MDC"><a href="#MDC" class="headerlink" title="MDC"></a>MDC</h1><p>è¿™é‡Œçš„æ—¥å¿—é‡Œå…³è” trace ä¿¡æ¯çš„åšæ³•æœ‰ä¸ªä¸“æœ‰åè¯ï¼šMDC:(Mapped Diagnostic Context)ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯ç”¨äºæ’æŸ¥é—®é¢˜çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œé€šå¸¸æ˜¯ç”±é”®å€¼å¯¹ç»„æˆï¼Œç±»ä¼¼äºè¿™æ ·çš„æ•°æ®ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2024-08-05 17:27:31.097&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;level&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;INFO&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;thread&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;http-nio-9191-exec-1&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;mdc&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">    <span class="attr">&quot;trace_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;26242f945af80b044a60226af00211fb&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;trace_flags&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;01&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;span_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;3a7842b3e28ed5c8&quot;</span>  </span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;logger&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;com.example.demo.DemoApplication&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;message&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;request: name: \&quot;1232\&quot;\n&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;context&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;default&quot;</span>  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>åœ¨ Java ä¸­çš„ Log4j å’Œ Logback éƒ½æœ‰æä¾›å¯¹åº”çš„å®ç°ã€‚</p><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº† OpenTelemetry æä¾›çš„ <code>javaagent</code> å†é…åˆ <code>logback</code> æˆ–è€… <code>Log4j</code> æ—¶å°±ä¼šè‡ªåŠ¨å…·å¤‡æ‰“å° <code>MDC</code> çš„èƒ½åŠ›ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:/Users/chenjie/Downloads/blog-img/demo/opentelemetry-javaagent-2.4.0-SNAPSHOT.jar xx.jar</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘ä»¬åªéœ€è¦è¿™æ ·é…ç½®è¿™æ ·ä¸€ä¸ªJSON è¾“å‡ºçš„ logback å³å¯ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;PROJECT_LOG&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;PATH&#125;/demo.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.FixedWindowRollingPolicy&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;PATH&#125;/demo_%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">maxIndex</span>&gt;</span>1<span class="tag">&lt;/<span class="name">maxIndex</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.contrib.json.classic.JsonLayout&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">jsonFormatter</span>  </span></span><br><span class="line"><span class="tag">                <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.contrib.jackson.JacksonJsonFormatter&quot;</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">prettyPrint</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prettyPrint</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">jsonFormatter</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">timestampFormat</span>&gt;</span>yyyy-MM-dd&#x27; &#x27;HH:mm:ss.SSS<span class="tag">&lt;/<span class="name">timestampFormat</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">layout</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;PROJECT_LOG&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/08/05/ba195iyS2hgnOVx.png"></p><p>å°±ä¼šåœ¨æ—¥å¿—æ–‡ä»¶ä¸­è¾“å‡º <code>JSON</code> æ ¼å¼çš„æ—¥å¿—ï¼Œå¹¶ä¸”å¸¦ä¸Š <code>MDC</code> çš„ä¿¡æ¯ã€‚</p><h1 id="è‡ªåŠ¨-MDC-çš„åŸç†"><a href="#è‡ªåŠ¨-MDC-çš„åŸç†" class="headerlink" title="è‡ªåŠ¨ MDC çš„åŸç†"></a>è‡ªåŠ¨ MDC çš„åŸç†</h1><p>æˆ‘ä¹Ÿæ¯”è¾ƒå¥½å¥‡ OpenTelemetry æ˜¯å¦‚ä½•è‡ªåŠ¨å†™å…¥ MDC ä¿¡æ¯çš„ï¼Œè¿™é‡Œä»¥ <code>logback</code> ä¸ºä¾‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> ElementMatcher&lt;TypeDescription&gt; <span class="title function_">typeMatcher</span><span class="params">()</span> &#123;  </span><br><span class="line">  <span class="keyword">return</span> implementsInterface(named(<span class="string">&quot;ch.qos.logback.classic.spi.ILoggingEvent&quot;</span>));  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(TypeTransformer transformer)</span> &#123;  </span><br><span class="line">  transformer.applyAdviceToMethod(  </span><br><span class="line">      isMethod()  </span><br><span class="line">          .and(isPublic())  </span><br><span class="line">          .and(namedOneOf(<span class="string">&quot;getMDCPropertyMap&quot;</span>, <span class="string">&quot;getMdc&quot;</span>))  </span><br><span class="line">          .and(takesArguments(<span class="number">0</span>)),  </span><br><span class="line">      LoggingEventInstrumentation.class.getName() + <span class="string">&quot;$GetMdcAdvice&quot;</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šåœ¨è°ƒç”¨ <code>ch.qos.logback.classic.spi.ILoggingEvent.getMDCPropertyMap()/getMdc()</code> è¿™ä¸¤ä¸ªå‡½æ•°ä¸­è¿›è¡ŒåŸ‹ç‚¹ã€‚</p><blockquote><p>è¿™äº›é€»è¾‘éƒ½æ˜¯å†™åœ¨ javaagent ä¸­çš„ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getMDCPropertyMap</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="comment">// populate mdcPropertyMap if null  </span></span><br><span class="line">    <span class="keyword">if</span> (mdcPropertyMap == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="type">MDCAdapter</span> <span class="variable">mdc</span> <span class="operator">=</span> MDC.getMDCAdapter();  </span><br><span class="line">        <span class="keyword">if</span> (mdc <span class="keyword">instanceof</span> LogbackMDCAdapter)  </span><br><span class="line">            mdcPropertyMap = ((LogbackMDCAdapter) mdc).getPropertyMap();  </span><br><span class="line">        <span class="keyword">else</span>  </span><br><span class="line">            mdcPropertyMap = mdc.getCopyOfContextMap();  </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="comment">// mdcPropertyMap still null, use emptyMap()  </span></span><br><span class="line">    <span class="keyword">if</span> (mdcPropertyMap == <span class="literal">null</span>)  </span><br><span class="line">        mdcPropertyMap = Collections.emptyMap();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> mdcPropertyMap;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å…¶å®é»˜è®¤æƒ…å†µä¸‹ä¼šè¿”å›ä¸€ä¸ª logback å†…ç½® MDC çš„ map æ•°æ®ï¼ˆè¿™é‡Œçš„æ•°æ®æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰é…ç½®ï¼‰ã€‚</p><p>è€Œè¿™é‡Œè¦åšçš„å°±æ˜¯å°† trace çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å†™å…¥è¿™ä¸ª mdcPropertyMap ä¸­ã€‚</p><p>ä»¥ä¸‹æ˜¯ OpenTelemetry agent ä¸­çš„æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; spanContextData = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">  </span><br><span class="line"><span class="type">SpanContext</span> <span class="variable">spanContext</span> <span class="operator">=</span> Java8BytecodeBridge.spanFromContext(context).getSpanContext();  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (spanContext.isValid()) &#123;  </span><br><span class="line">  spanContextData.put(traceIdKey(), spanContext.getTraceId());  </span><br><span class="line">  spanContextData.put(spanIdKey(), spanContext.getSpanId());  </span><br><span class="line">  spanContextData.put(traceFlagsKey(), spanContext.getTraceFlags().asHex());  </span><br><span class="line">&#125;  </span><br><span class="line">spanContextData.putAll(ConfiguredResourceAttributesHolder.getResourceAttributes());  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (LogbackSingletons.addBaggage()) &#123;  </span><br><span class="line">  <span class="type">Baggage</span> <span class="variable">baggage</span> <span class="operator">=</span> Java8BytecodeBridge.baggageFromContext(context);  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// using a lambda here does not play nicely with instrumentation bytecode process  </span></span><br><span class="line">  <span class="comment">// (Java 6 related errors are observed) so relying on for loop instead  for (Map.Entry&lt;String, BaggageEntry&gt; entry : baggage.asMap().entrySet()) &#123;  </span></span><br><span class="line">    spanContextData.put(  </span><br><span class="line">        <span class="comment">// prefix all baggage values to avoid clashes with existing context  </span></span><br><span class="line">        <span class="string">&quot;baggage.&quot;</span> + entry.getKey(), entry.getValue().getValue());  </span><br><span class="line">  &#125;&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (contextData == <span class="literal">null</span>) &#123;  </span><br><span class="line">  contextData = spanContextData;  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">  contextData = <span class="keyword">new</span> <span class="title class_">UnionMap</span>&lt;&gt;(contextData, spanContextData);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯æ ¸å¿ƒçš„å†™å…¥é€»è¾‘ï¼Œä»è¿™ä¸ªä»£ç ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºç›´æ¥ä»ä¸Šçº¿æ–‡ä¸­è·å–çš„ span çš„ contextï¼Œè€Œæˆ‘ä»¬æ‰€éœ€è¦çš„ <code>trace_id/span_id</code>  éƒ½æ˜¯å­˜æ”¾åœ¨ context ä¸­çš„ï¼Œåªéœ€è¦ get å‡ºæ¥ç„¶åå†™å…¥è¿› map ä¸­å³å¯ã€‚</p><p>ä»æºç é‡Œè¿˜å¾—çŸ¥ï¼Œåªè¦æˆ‘ä»¬å¼€å¯ <code>-Dotel.instrumentation.logback-mdc.add-baggage=true</code> é…ç½®è¿˜å¯ä»¥å°† baggage ä¸­çš„æ•°æ®ä¹Ÿå†™å…¥åˆ° MDC ä¸­ã€‚</p><p>è€Œå¾—æ˜“äº OpenTelemetry ä¸­çš„ trace æ˜¯å¯ä»¥è·¨çº¿ç¨‹ä¼ è¾“çš„ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯æˆ‘ä»¬åœ¨å¤šçº¿ç¨‹é‡Œæ‰“å°æ—¥å¿—æ—¶ MDC æ•°æ®ä¾ç„¶å¯ä»¥å‡†ç¡®æ— è¯¯çš„ä¼ é€’ã€‚</p><h2 id="MDC-çš„åŸç†"><a href="#MDC-çš„åŸç†" class="headerlink" title="MDC çš„åŸç†"></a>MDC çš„åŸç†</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MDC_ATTR_NAME</span> <span class="operator">=</span> <span class="string">&quot;mdc&quot;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/08/05/e7PIASyowDGO1sQ.png"></p><p>åœ¨ <code>logback</code> çš„å®ç°ä¸­æ˜¯ä¼šè°ƒç”¨åˆšæ‰çš„ <code>getMDCPropertyMap()</code> ç„¶åå†™å…¥åˆ°ä¸€ä¸ª key ä¸º <code>mdc</code> çš„ <code>map</code> é‡Œï¼Œæœ€ç»ˆå¯ä»¥å†™å…¥åˆ°æ–‡ä»¶æˆ–è€…æ§åˆ¶å°ã€‚</p><p>è¿™æ ·æ•´ä¸ªåŸç†å°±å¯ä»¥ä¸²èµ·æ¥äº†ã€‚</p><h2 id="è‡ªå®šä¹‰æ—¥å¿—-æ•°æ®"><a href="#è‡ªå®šä¹‰æ—¥å¿—-æ•°æ®" class="headerlink" title="è‡ªå®šä¹‰æ—¥å¿— æ•°æ®"></a>è‡ªå®šä¹‰æ—¥å¿— æ•°æ®</h2><p>æåˆ°å¯ä»¥è‡ªå®šä¹‰ MDC æ•°æ®å…¶å®ä¹Ÿæ˜¯æœ‰ä½¿ç”¨åœºæ™¯çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ä¸šåŠ¡ç³»ç»Ÿç»å¸¸æœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼Œéœ€è¦åœ¨æ—¥å¿—ä¸­æ‰“å°ä¸€äº›å¸¸ç”¨ä¸šåŠ¡æ•°æ®ï¼š</p><ul><li>userIdã€userName</li><li>å®¢æˆ·ç«¯ IPç­‰ä¿¡æ¯æ—¶</li></ul><p>æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>Layout</code> ç±»æ¥ç»§æ‰¿ <code>ch.qos.logback.contrib.json.classic.JsonLayout</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomJsonLayout</span> <span class="keyword">extends</span> <span class="title class_">JsonLayout</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomJsonLayout</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addCustomDataToJsonMap</span><span class="params">(Map&lt;String, Object&gt; map, ILoggingEvent event)</span> &#123;</span><br><span class="line">        map.put(<span class="string">&quot;user_name&quot;</span>, context.getProperty(<span class="string">&quot;userName&quot;</span>));</span><br><span class="line">        map.put(<span class="string">&quot;user_id&quot;</span>, context.getProperty(<span class="string">&quot;userId&quot;</span>));</span><br><span class="line">        map.put(<span class="string">&quot;trace_id&quot;</span>, TraceContext.traceId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomJsonLayoutEncoder</span> <span class="keyword">extends</span> <span class="title class_">LayoutWrappingEncoder</span>&lt;ILoggingEvent&gt; &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomJsonLayoutEncoder</span><span class="params">()</span> &#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="type">CustomJsonLayout</span> <span class="variable">jsonLayout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomJsonLayout</span>();  </span><br><span class="line">        jsonLayout.setContext(<span class="built_in">this</span>.context);  </span><br><span class="line">        jsonLayout.setIncludeContextName(<span class="literal">false</span>);  </span><br><span class="line">        jsonLayout.setAppendLineSeparator(<span class="literal">true</span>);  </span><br><span class="line">        jsonLayout.setJsonFormatter(<span class="keyword">new</span> <span class="title class_">JacksonJsonFormatter</span>());  </span><br><span class="line">        jsonLayout.start();  </span><br><span class="line">        <span class="built_in">super</span>.setCharset(StandardCharsets.UTF_8);  </span><br><span class="line">        <span class="built_in">super</span>.setLayout(jsonLayout);  </span><br><span class="line">        <span class="built_in">super</span>.start();  </span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œçš„ trace_id æ˜¯ä¹‹å‰ä½¿ç”¨ skywalking çš„æ—¶å€™ç”± skywalking æä¾›çš„å‡½æ•°ï¼šorg.apache.skywalking.apm.toolkit.trace.TraceContext#traceId</p></blockquote><p>æ¥ç€åªéœ€è¦åœ¨ <code>logback.xml</code> ä¸­é…ç½®è¿™ä¸ª <code>CustomJsonLayoutEncoder</code> å°±å¯ä»¥æŒ‰ç…§æˆ‘ä»¬è‡ªå®šä¹‰çš„æ•°æ®è¾“å‡ºæ—¥å¿—äº†ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;PROJECT_LOG&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;PATH&#125;/app.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.FixedWindowRollingPolicy&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;PATH&#125;/app_%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">maxIndex</span>&gt;</span>1<span class="tag">&lt;/<span class="name">maxIndex</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;xx.CustomJsonLayoutEncoder&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;PROJECT_LOG&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è™½ç„¶è¿™ä¸ªåŠŸèƒ½ä¹Ÿå¯ä»¥ä½¿ç”¨æ—¥å¿—åˆ‡é¢æ¥æ‰“å°ï¼Œä½†è¿˜æ˜¯æ²¡æœ‰ç›´æ¥åœ¨æ—¥å¿—ä¸­è¾“å‡ºæ›´åŠ æ–¹ä¾¿ï¼Œå®ƒå¯ä»¥ç›´æ¥å’Œæˆ‘ä»¬çš„æ—¥å¿—å…³è”åœ¨ä¸€èµ·ï¼Œåªæ˜¯å¤šåŠ äº†è¿™å‡ ä¸ªå­—æ®µè€Œå·²ã€‚</p><h2 id="Spring-Boot-ä½¿ç”¨"><a href="#Spring-Boot-ä½¿ç”¨" class="headerlink" title="Spring Boot ä½¿ç”¨"></a>Spring Boot ä½¿ç”¨</h2><p><code>OpenTelemetry</code> æœ‰ç»™ springboot åº”ç”¨æä¾›ä¸€ä¸ª <code>spring-boot-starter</code> åŒ…ï¼Œç”¨äºåœ¨ä¸ä½¿ç”¨  <code>javaagent</code> çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è‡ªåŠ¨åŸ‹ç‚¹ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry.instrumentation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>OPENTELEMETRY_VERSION<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä½†åœ¨æ—©<a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/discussions/7653">æœŸçš„ç‰ˆæœ¬</a>ä¸­è¿˜ä¸æ”¯æŒç›´æ¥æ‰“å° MDC æ—¥å¿—ï¼š<br><img src="https://s2.loli.net/2024/08/05/aunR8ApiMEoeJ1O.png" alt="image.png"></p><blockquote><p>æœ€æ–°çš„ç‰ˆæœ¬å·²ç»æ”¯æŒ</p></blockquote><p>å³ä¾¿å·²ç»æ”¯æŒé»˜è®¤è¾“å‡º MDC åï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥è‡ªå®šä¹‰çš„å†…å®¹ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³ä¿®æ”¹ä¸€ä¸‹ key çš„åç§°ï¼Œç”± <code>trace_id</code> ä¿®æ”¹ä¸º <code>otel_trace_id</code> ç­‰ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;OTEL&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.opentelemetry.instrumentation.logback.mdc.v1_0.OpenTelemetryAppender&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">traceIdKey</span>&gt;</span>otel_trace_id<span class="tag">&lt;/<span class="name">traceIdKey</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spanIdKey</span>&gt;</span>otel_span_id<span class="tag">&lt;/<span class="name">spanIdKey</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">traceFlagsKey</span>&gt;</span>otel_trace_flags<span class="tag">&lt;/<span class="name">traceFlagsKey</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯å’Œä¹‹å‰ç±»ä¼¼ï¼Œä¿®æ”¹ä¸‹ logback.xml å³å¯ã€‚</p><p><img src="https://s2.loli.net/2024/08/05/Y3zvfm6rUbxwtOK.png" alt="image.png"><br>ä»–çš„å®ç°é€»è¾‘å…¶å®å’Œä¹‹å‰çš„ auto instrument ä¸­çš„ç±»ä¼¼ï¼Œåªä¸è¿‡ä½¿ç”¨çš„ API ä¸åŒè€Œå·²ã€‚</p><p>auto instrument æ˜¯ç›´æ¥æ‹¦æˆªä»£ç é€»è¾‘ä¿®æ”¹ map çš„è¿”å›å€¼ï¼Œè€Œ <code>OpenTelemetryAppender</code> æ˜¯ç»§æ‰¿äº† <code>ch.qos.logback.core.UnsynchronizedAppenderBase</code> æ¥å£ï¼Œä»è€Œè·å¾—äº†é‡å†™ <code>MDC</code> çš„èƒ½åŠ›ï¼Œä½†æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p><p>ä¸è¿‡ä½¿ç”¨å®ƒçš„å‰ææ˜¯æˆ‘ä»¬éœ€è¦å¼•å…¥ä»¥ä¸‹ä¸€ä¸ªä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry.instrumentation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-logback-mdc-1.0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>OPENTELEMETRY_VERSION<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æƒ³ä¿®æ”¹ logback.yaml ï¼Œå¯¹äº <code>springboot</code> æ¥è¯´è¿˜æœ‰æ›´ç®€å•çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ä»¥ä¸‹é…ç½®å³å¯è‡ªå®šä¹‰ MDC æ•°æ®ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging.pattern.level</span> = <span class="string">trace_id=%mdc&#123;trace_id&#125; span_id=%mdc&#123;span_id&#125; trace_flags=%mdc&#123;trace_flags&#125; %5p</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ key ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼Œåªè¦å ä½ç¬¦æ²¡æœ‰å–é”™å³å¯ã€‚</p><blockquote><p>ä½¿ç”¨è¿™ä¸ªçš„å‰ææ˜¯éœ€è¦åŠ è½½  javaagentï¼Œå› ä¸ºè¿™é‡Œçš„æ•°æ®æ˜¯ javaagent é‡Œå†™è¿›å»çš„ã€‚</p></blockquote><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šå°±æ˜¯å…³äº <code>MDC</code> åœ¨ <code>OpenTelemetry</code> ä¸­çš„ä½¿ç”¨ï¼Œä»ä½¿ç”¨å’Œæºç é€»è¾‘ä¸Šéƒ½åˆ†æäº†ä¸€éï¼Œå¸Œæœ›å¯¹ <code>MDC</code> å’Œ <code>OpenTelemetry</code> çš„ç†è§£æ›´åŠ æ·±åˆ»ä¸€äº›ã€‚</p><p>å…³äº MDC ç›¸å…³çš„æ¦‚å¿µä¸ä½¿ç”¨è¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œæ˜¯æ—¥å¸¸æ’æŸ¥é—®é¢˜å¿…ä¸å¯å°‘çš„ä¸€ä¸ªå·¥å…·ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;åœ¨å‰é¢ä¸¤ç¯‡å®æˆ˜æ–‡ç« ä¸­ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7391744486979076146&quot;&gt;OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7394395254566846475&quot;&gt;OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åº”ç”¨æŒ‡æ ‡ç›‘æ§&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¦†ç›–äº†å¯è§‚æµ‹ä¸­çš„æŒ‡æ ‡è¿½è¸ªå’Œ &lt;code&gt;metrics&lt;/code&gt; ç›‘æ§ï¼Œä¸‹é¢ç†åº”å¼€å§‹ç¬¬ä¸‰éƒ¨åˆ†ï¼š&lt;strong&gt;æ—¥å¿—&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ä½†åœ¨å¼€å§‹æ—¥å¿—ä¹‹å‰è¿˜æ˜¯è¦å…ˆå°†é“¾è·¯è¿½è¸ªå’Œæ—¥å¿—ç»“åˆèµ·æ¥çœ‹çœ‹åº”ç”¨å®é™…ä½¿ç”¨çš„å®è·µã€‚&lt;/p&gt;
&lt;p&gt;é€šå¸¸æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æ–¹å¼æ˜¯å…ˆæŸ¥è¯¢å¼‚å¸¸æ—¥å¿—ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ç³»ç»Ÿçš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœä¸æ˜¯ï¼Œåˆ™åœ¨æ—¥å¿—ä¸­æå‡º &lt;code&gt;trace_id&lt;/code&gt; å†åˆ°é“¾è·¯æŸ¥è¯¢ç³»ç»Ÿä¸­æŸ¥è¯¢é“¾è·¯ï¼Œçœ‹çœ‹å…·ä½“æ˜¯å“ªä¸ªç³»ç»Ÿçš„é—®é¢˜ï¼Œç„¶åå†åšå…·ä½“çš„æ’æŸ¥ã€‚&lt;/p&gt;
&lt;p&gt;ç±»ä¼¼äºè¿™æ ·ï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/08/05/mP97tShHKrGXge2.png&quot;&gt;&lt;br&gt;æ—¥å¿—ä¸­ä¼šæ‰“å° &lt;code&gt;trace_id&lt;/code&gt; å’Œ &lt;code&gt;span_id&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¦‚æœæ—¥å¿—ç³»ç»Ÿåšçš„æ¯”è¾ƒå®Œå–„çš„è¯ï¼Œè¿˜å¯ä»¥ç›´æ¥ç‚¹å‡» &lt;code&gt;trace_id&lt;/code&gt; è·³è½¬åˆ°é“¾è·¯ç³»ç»Ÿé‡Œç›´æ¥æŸ¥è¯¢é“¾è·¯ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetry å®æˆ˜ï¼šgRPC ç›‘æ§çš„å®ç°åŸç†</title>
    <link href="http://crossoverjie.top/2024/08/29/ob/OpenTelemetry-grpc-principle/"/>
    <id>http://crossoverjie.top/2024/08/29/ob/OpenTelemetry-grpc-principle/</id>
    <published>2024-08-29T06:50:33.000Z</published>
    <updated>2024-09-03T15:08:51.463Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><img src="https://s2.loli.net/2024/07/29/uUTYr8lziEABk4d.png"></p><p>æœ€è¿‘åœ¨ç»™ <code>opentelemetry-java-instrumentation</code> æäº¤äº†ä¸€ä¸ª <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/11833">PR</a>ï¼Œæ˜¯å…³äºç»™ gRPC æ–°å¢å››ä¸ª metricsï¼š</p><ul><li><code>rpc.client.request.size</code>: å®¢æˆ·ç«¯è¯·æ±‚åŒ…å¤§å°</li><li><code>rpc.client.response.size</code>ï¼šå®¢æˆ·ç«¯æ”¶åˆ°çš„å“åº”åŒ…å¤§å°</li><li><code>rpc.server.request.size</code>ï¼šæœåŠ¡ç«¯æ”¶åˆ°çš„è¯·æ±‚åŒ…å¤§å°</li><li><code>rpc.server.response.size</code>ï¼šæœåŠ¡ç«¯å“åº”çš„è¯·æ±‚åŒ…å¤§å°</li></ul><p>è¿™ä¸ª PR çš„ä¸»è¦ç›®çš„å°±æ˜¯èƒ½å¤Ÿåœ¨æŒ‡æ ‡ç›‘æ§ä¸­æ‹¿åˆ° <code>RPC</code> è¯·æ±‚çš„åŒ…å¤§å°ï¼Œè€Œè¿™é‡Œçš„å…³é”®å°±æ˜¯å¦‚ä½•æ‰èƒ½æ‹¿åˆ°è¿™äº›åŒ…çš„å¤§å°ã€‚</p><span id="more"></span><p>é¦–å…ˆæ”¯æŒçš„æ˜¯ <code>gRPC</code>ï¼ˆç›®å‰åœ¨äº‘åŸç”Ÿé¢†åŸŸä½¿ç”¨çš„æœ€å¤šï¼‰ï¼Œå…¶ä½™çš„ RPC ç†è®ºä¸Šä¹Ÿæ˜¯å¯ä»¥æ”¯æŒçš„ï¼š<br><img src="https://s2.loli.net/2024/07/29/efGYRktoK8IESzP.png"></p><p>åœ¨å®ç°çš„è¿‡ç¨‹ä¸­æˆ‘ä¹Ÿæ¯”è¾ƒå¥½å¥‡ <code>OpenTelemetry</code> æ¡†æ¶æ˜¯å¦‚ä½•ç»™ <code>gRPC</code> è¯·æ±‚åˆ›å»º <code>span</code> è°ƒç”¨é“¾çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://s2.loli.net/2024/07/15/skNmSDJaPfHh3GB.png" alt="image.png"><br><img src="https://s2.loli.net/2024/07/15/xoG2finOmFlDReE.png" alt="image.png"></p><blockquote><p>è¿™æ˜¯ä¸€ä¸ª gRPC è¿œç¨‹è°ƒç”¨ï¼Œjava-demo æ˜¯ gRPC çš„å®¢æˆ·ç«¯ï¼Œk8s-combat æ˜¯ gRPC çš„æœåŠ¡ç«¯</p></blockquote><p>åœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬å¯ä»¥æ ¹æ® <code>OpenTelemetry</code> çš„è¿è¡ŒåŸç†å¤§æ¦‚çŒœæµ‹ä¸‹å®ƒçš„å®ç°è¿‡ç¨‹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬åº”ç”¨å¯ä»¥åˆ›å»ºè¿™äº›é“¾è·¯ä¿¡æ¯çš„å‰ææ˜¯ï¼šä½¿ç”¨äº† <code>OpenTelemetry</code> æä¾›çš„ <code>javaagent</code>ï¼Œè¿™ä¸ª agent çš„åŸç†æ˜¯åœ¨è¿è¡Œæ—¶ä½¿ç”¨äº† <a href="https://github.com/raphw/byte-buddy">byte-buddy</a> å¢å¼ºäº†æˆ‘ä»¬åº”ç”¨çš„å­—èŠ‚ç ï¼Œåœ¨è¿™äº›å­—èŠ‚ç ä¸­ä»£ç†ä¸šåŠ¡é€»è¾‘ï¼Œä»è€Œå¯ä»¥åœ¨ä¸å½±å“ä¸šåŠ¡çš„å‰æä¸‹å¢å¼ºæˆ‘ä»¬çš„ä»£ç ï¼ˆåªè¦å°±æ˜¯åˆ›å»º spanã€metrics ç­‰æ•°æ®ï¼‰</p><blockquote><p>Spring çš„ä¸€äº›ä»£ç†é€»è¾‘ä¹Ÿæ˜¯è¿™æ ·å®ç°çš„</p></blockquote><h1 id="gRPC-å¢å¼ºåŸç†"><a href="#gRPC-å¢å¼ºåŸç†" class="headerlink" title="gRPC å¢å¼ºåŸç†"></a>gRPC å¢å¼ºåŸç†</h1><p>è€Œåœ¨å·¥ç¨‹å®ç°ä¸Šï¼Œæˆ‘ä»¬æœ€å¥½æ˜¯ä¸èƒ½å¯¹ä¸šåŠ¡ä»£ç è¿›è¡Œå¢å¼ºï¼Œè€Œæ˜¯è¦æ‰¾åˆ°è¿™äº›æ¡†æ¶æä¾›çš„æ‰©å±•æ¥å£ã€‚</p><p>æ‹¿ <code>gRPC</code> æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ‰€æä¾›çš„ <code>io.grpc.ClientInterceptor</code> å’Œ <code>io.grpc.ServerInterceptor</code> æ¥å£æ¥å¢å¼ºä»£ç ã€‚</p><p>æ‰“å¼€ <code>io.opentelemetry.instrumentation.grpc.v1_6.TracingClientInterceptor</code> ç±»æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå°±æ˜¯å®ç°äº† <code>io.grpc.ClientInterceptor</code>ï¼š<br><img src="https://s2.loli.net/2024/07/29/dVaESmoXIwJC6Li.png"></p><p>è€Œå…¶ä¸­æœ€å…³é”®çš„å°±æ˜¯è¦å®ç° <code>io.grpc.ClientInterceptor#interceptCall</code> å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> &lt;REQUEST, RESPONSE&gt; ClientCall&lt;REQUEST, RESPONSE&gt; <span class="title function_">interceptCall</span><span class="params">(  </span></span><br><span class="line"><span class="params">    MethodDescriptor&lt;REQUEST, RESPONSE&gt; method, CallOptions callOptions, Channel next)</span> &#123;  </span><br><span class="line">  <span class="type">GrpcRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GrpcRequest</span>(method, <span class="literal">null</span>, <span class="literal">null</span>, next.authority());  </span><br><span class="line">  <span class="type">Context</span> <span class="variable">parentContext</span> <span class="operator">=</span> Context.current();  </span><br><span class="line">  <span class="keyword">if</span> (!instrumenter.shouldStart(parentContext, request)) &#123;  </span><br><span class="line">    <span class="keyword">return</span> next.newCall(method, callOptions);  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> instrumenter.start(parentContext, request);  </span><br><span class="line">  ClientCall&lt;REQUEST, RESPONSE&gt; result;  </span><br><span class="line">  <span class="keyword">try</span> (<span class="type">Scope</span> <span class="variable">ignored</span> <span class="operator">=</span> context.makeCurrent()) &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">      <span class="comment">// call other interceptors  </span></span><br><span class="line">      result = next.newCall(method, callOptions);  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </span><br><span class="line">      instrumenter.end(context, request, Status.UNKNOWN, e);  </span><br><span class="line">      <span class="keyword">throw</span> e;  </span><br><span class="line">    &#125;  &#125;  </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TracingClientCall</span>&lt;&gt;(result, parentContext, context, request);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ¥å£æ˜¯ <code>gRPC</code> æä¾›çš„æ‹¦æˆªå™¨æ¥å£ï¼Œå¯¹äº <code>gRPC</code> å®¢æˆ·ç«¯æ¥è¯´å°±æ˜¯åœ¨å‘èµ·çœŸæ­£çš„ç½‘ç»œè°ƒç”¨å‰åä¼šæ‰§è¡Œçš„æ–¹æ³•ã€‚</p><p>æ‰€ä»¥åœ¨è¿™ä¸ªæ¥å£ä¸­æˆ‘ä»¬å°±å¯ä»¥å®ç°åˆ›å»º span è·å–åŒ…å¤§å°ç­‰é€»è¾‘ã€‚</p><h2 id="ä½¿ç”¨-byte-buddy-å¢å¼ºä»£ç "><a href="#ä½¿ç”¨-byte-buddy-å¢å¼ºä»£ç " class="headerlink" title="ä½¿ç”¨ byte-buddy å¢å¼ºä»£ç "></a>ä½¿ç”¨ byte-buddy å¢å¼ºä»£ç </h2><p>ä¸è¿‡æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬å®ç°çš„ <code>io.grpc.ClientInterceptor</code> ç±»éœ€è¦åŠ å…¥åˆ°æ‹¦æˆªå™¨ä¸­æ‰å¯ä»¥ä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">managedChannel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(host, port) .intercept(<span class="keyword">new</span> <span class="title class_">TracingClientInterceptor</span>()) <span class="comment">// åŠ å…¥æ‹¦æˆªå™¨</span></span><br><span class="line">.usePlaintext()</span><br><span class="line">.build();</span><br></pre></td></tr></table></figure><p>ä½†åœ¨ <code>javaagent</code> ä¸­æ˜¯æ²¡æ³•ç»™ä¸šåŠ¡ä»£ç ä¸­åŠ ä¸Šè¿™æ ·çš„ä»£ç çš„ã€‚</p><p>æ­¤æ—¶å°±éœ€è¦ <a href="https://bytebuddy.net/#/">byte-buddy</a> ç™»åœºäº†ï¼Œå®ƒå¯ä»¥åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç ä»è€Œå®ç°ç±»ä¼¼äºä¿®æ”¹æºç çš„æ•ˆæœã€‚</p><p>åœ¨ <code>io.opentelemetry.javaagent.instrumentation.grpc.v1_6.GrpcClientBuilderBuildInstr umentation</code>  ç±»é‡Œå¯ä»¥çœ‹åˆ° <code>OpenTelemetry</code> æ˜¯å¦‚ä½•ä½¿ç”¨ <code>byte-buddy</code> çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ElementMatcher&lt;TypeDescription&gt; <span class="title function_">typeMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> extendsClass(named(<span class="string">&quot;io.grpc.ManagedChannelBuilder&quot;</span>))</span><br><span class="line">      .and(declaresField(named(<span class="string">&quot;interceptors&quot;</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(TypeTransformer transformer)</span> &#123;</span><br><span class="line">  transformer.applyAdviceToMethod(</span><br><span class="line">      isMethod().and(named(<span class="string">&quot;build&quot;</span>)),</span><br><span class="line">      GrpcClientBuilderBuildInstrumentation.class.getName() + <span class="string">&quot;$AddInterceptorAdvice&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unused&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AddInterceptorAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Advice</span>.OnMethodEnter(suppress = Throwable.class)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addInterceptor</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.This ManagedChannelBuilder&lt;?&gt; builder,</span></span><br><span class="line"><span class="params">      <span class="meta">@Advice</span>.FieldValue(<span class="string">&quot;interceptors&quot;</span>)</span> List&lt;ClientInterceptor&gt; interceptors) &#123;</span><br><span class="line">    VirtualField&lt;ManagedChannelBuilder&lt;?&gt;, Boolean&gt; instrumented =</span><br><span class="line">        VirtualField.find(ManagedChannelBuilder.class, Boolean.class);</span><br><span class="line">    <span class="keyword">if</span> (!Boolean.TRUE.equals(instrumented.get(builder))) &#123;</span><br><span class="line">      interceptors.add(<span class="number">0</span>, GrpcSingletons.CLIENT_INTERCEPTOR);</span><br><span class="line">      instrumented.set(builder, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™é‡Œçš„æºç å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨äº† <code>byte-buddy</code> æ‹¦æˆªäº† <code>io.grpc.ManagedChannelBuilder#intercept(java.util.List&lt;io.grpc.ClientInterceptor&gt;)</code> å‡½æ•°ã€‚</p><blockquote><p>io.opentelemetry.javaagent.extension.matcher.AgentElementMatchers#extendsClass&#x2F; isMethod ç­‰å‡½æ•°éƒ½æ˜¯ byte-buddy åº“æä¾›çš„å‡½æ•°ã€‚</p></blockquote><p>è€Œè¿™ä¸ªå‡½æ•°æ­£å¥½å°±æ˜¯æˆ‘ä»¬éœ€è¦åœ¨ä¸šåŠ¡ä»£ç é‡ŒåŠ å…¥æ‹¦æˆªå™¨çš„åœ°æ–¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">interceptors.add(<span class="number">0</span>, GrpcSingletons.CLIENT_INTERCEPTOR);</span><br><span class="line">GrpcSingletons.CLIENT_INTERCEPTOR = <span class="keyword">new</span> <span class="title class_">TracingClientInterceptor</span>(clientInstrumenter, propagators);</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™è¡Œä»£ç å¯ä»¥æ‰‹åŠ¨å°† <code>OpenTelemetry</code> é‡Œçš„ <code>TracingClientInterceptor</code> åŠ å…¥åˆ°æ‹¦æˆªå™¨åˆ—è¡¨ä¸­ï¼Œå¹¶ä¸”ä½œä¸ºç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ã€‚</p><p>è€Œè¿™é‡Œçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">extendsClass(named(<span class="string">&quot;io.grpc.ManagedChannelBuilder&quot;</span>))</span><br><span class="line">        .and(declaresField(named(<span class="string">&quot;interceptors&quot;</span>)))</span><br></pre></td></tr></table></figure><p>é€šè¿‡å‡½æ•°çš„åç§°ä¹Ÿå¯ä»¥çœ‹å‡ºæ˜¯ä¸ºäº†æ‰¾åˆ° ç»§æ‰¿äº†<code>io.grpc.ManagedChannelBuilder</code> ç±»ä¸­å­˜åœ¨æˆå‘˜å˜é‡ <code>interceptors</code> çš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">transformer.applyAdviceToMethod(  </span><br><span class="line">    isMethod().and(named(<span class="string">&quot;build&quot;</span>)),  </span><br><span class="line">    GrpcClientBuilderBuildInstrumentation.class.getName() + <span class="string">&quot;$AddInterceptorAdvice&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨è°ƒç”¨ <code>build</code> å‡½æ•°åå°±ä¼šè¿›å…¥è‡ªå®šä¹‰çš„ <code>AddInterceptorAdvice</code> ç±»ï¼Œä»è€Œå°±å¯ä»¥æ‹¦æˆªåˆ°æ·»åŠ æ‹¦æˆªå™¨çš„é€»è¾‘ï¼Œç„¶åæŠŠè‡ªå®šä¹‰çš„æ‹¦æˆªå™¨åŠ å…¥å…¶ä¸­ã€‚</p><h1 id="è·å–-span-çš„-attribute"><a href="#è·å–-span-çš„-attribute" class="headerlink" title="è·å– span çš„ attribute"></a>è·å– span çš„ attribute</h1><p><img src="https://s2.loli.net/2024/07/29/dawSY4uQGmJo6qi.png"></p><p>æˆ‘ä»¬åœ¨ gRPC çš„é“¾è·¯ä¸­è¿˜å¯ä»¥çœ‹åˆ°è¿™ä¸ªè¯·æ±‚çš„å…·ä½“å±æ€§ï¼Œæ¯”å¦‚ï¼š</p><ul><li>gRPC æœåŠ¡æä¾›çš„ IP ç«¯å£ã€‚</li><li>è¯·æ±‚çš„å“åº”ç </li><li>è¯·æ±‚çš„ service å’Œ method</li><li>çº¿ç¨‹ç­‰ä¿¡æ¯ã€‚<blockquote><p>è¿™äº›ä¿¡æ¯åœ¨é—®é¢˜æ’æŸ¥è¿‡ç¨‹ä¸­éƒ½æ˜¯è‡³å…³é‡è¦çš„ã€‚</p></blockquote></li></ul><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ–°çš„ <code>attribute</code> ä¸»è¦æ˜¯åˆ†ä¸ºäº†ä¸‰ç±»ï¼š</p><ul><li><code>net.*</code> æ˜¯ç½‘ç»œç›¸å…³çš„å±æ€§</li><li><code>rpc.*</code> æ˜¯å’Œ grpc ç›¸å…³çš„å±æ€§</li><li><code>thread.*</code> æ˜¯çº¿ç¨‹ç›¸å…³çš„å±æ€§</li></ul><p>æ‰€ä»¥ç†è®ºä¸Šæˆ‘ä»¬åœ¨è®¾è®¡ API æ—¶æœ€å¥½å¯ä»¥å°†è¿™äº›ä¸åŒåˆ†ç»„çš„å±æ€§è§£è€¦å¼€ï¼Œå¦‚æœæ˜¯ MQ ç›¸å…³çš„å¯èƒ½è¿˜æœ‰ä¸€äº› topic ç­‰æ•°æ®ï¼Œæ‰€ä»¥å„ä¸ªå±æ€§ä¹‹é—´æ˜¯äº’ä¸å½±å“çš„ã€‚</p><p>å¸¦ç€è¿™ä¸ªæ€è·¯æˆ‘ä»¬æ¥çœ‹çœ‹ gRPC è¿™é‡Œæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">clientInstrumenterBuilder</span><br><span class="line">.setSpanStatusExtractor(GrpcSpanStatusExtractor.CLIENT)</span><br><span class="line">.addAttributesExtractors(additionalExtractors)</span><br><span class="line">        .addAttributesExtractor(RpcClientAttributesExtractor.create(rpcAttributesGetter))</span><br><span class="line">        .addAttributesExtractor(ServerAttributesExtractor.create(netClientAttributesGetter))</span><br><span class="line">        .addAttributesExtractor(NetworkAttributesExtractor.create(netClientAttributesGetter))</span><br></pre></td></tr></table></figure><p><code>OpenTelemetry</code> ä¼šæä¾›ä¸€ä¸ª <code>io.opentelemetry.instrumentation.api.instrumenter.InstrumenterBuilder#addAttributesExtractor</code>æ„å»ºå™¨å‡½æ•°ï¼Œç”¨äºå­˜æ”¾è‡ªå®šä¹‰çš„å±æ€§è§£æå™¨ã€‚</p><p>ä»è¿™é‡Œçš„æºç å¯ä»¥çœ‹å‡ºåˆ†åˆ«ä¼ å…¥äº†ç½‘ç»œç›¸å…³ã€RPC ç›¸å…³çš„è§£æå™¨ï¼›æ­£å¥½ä¹Ÿå°±å¯¹åº”äº†å›¾ä¸­çš„é‚£äº›å±æ€§ï¼Œä¹Ÿæ»¡è¶³äº†æˆ‘ä»¬åˆšæ‰æåˆ°çš„è§£è€¦ç‰¹æ€§ã€‚</p><p>è€Œæ¯ä¸€ä¸ªè‡ªå®šä¹‰å±æ€§è§£æå™¨éƒ½éœ€è¦å®ç°æ¥å£ <code>io.opentelemetry.instrumentation.api.instrumenter.AttributesExtractor</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AttributesExtractor</span>&lt;REQUEST, RESPONSE&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä»¥ <code>GrpcRpcAttributesGetter</code> ä¸ºä¾‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">GrpcRpcAttributesGetter</span> <span class="keyword">implements</span> <span class="title class_">RpcAttributesGetter</span>&lt;GrpcRequest&gt; &#123;</span><br><span class="line">  INSTANCE;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getSystem</span><span class="params">(GrpcRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;grpc&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getService</span><span class="params">(GrpcRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullMethodName</span> <span class="operator">=</span> request.getMethod().getFullMethodName();</span><br><span class="line">    <span class="type">int</span> <span class="variable">slashIndex</span> <span class="operator">=</span> fullMethodName.lastIndexOf(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (slashIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fullMethodName.substring(<span class="number">0</span>, slashIndex);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° system æ˜¯å†™æ­»çš„ <code>grpc</code>ï¼Œä¹Ÿå°±æ˜¯å¯¹äºåˆ°é¡µé¢ä¸Šçš„ <code>rpc.system</code> å±æ€§ã€‚</p><p>è€Œè¿™é‡Œçš„ <code>getService</code> å‡½æ•°åˆ™æ˜¯æ‹¿æ¥è·å– <code>rpc.service</code> å±æ€§çš„ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯é€šè¿‡ <code>gRPC</code> <code>çš„method</code> ä¿¡æ¯æ¥è·å– <code>service</code> çš„ã€‚</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RpcAttributesGetter</span>&lt;REQUEST&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Nullable</span>  </span><br><span class="line">  String <span class="title function_">getService</span><span class="params">(REQUEST request)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œè¿™é‡Œ <code>REQUEST</code> å…¶å®æ˜¯ä¸€ä¸ªæ³›å‹ï¼Œåœ¨ gRPC é‡Œæ˜¯ <code>GrpcRequest</code>ï¼Œåœ¨å…¶ä»– RPC é‡Œè¿™æ˜¯å¯¹åº”çš„ RPC çš„æ•°æ®ã€‚</p><p>è¿™ä¸ª <code>GrpcRequest</code> æ˜¯åœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨ä¸­åˆ›å»ºå¹¶ä¼ é€’çš„ã€‚<br><img src="https://s2.loli.net/2024/07/29/46mOv7XMoT81Bxl.png"></p><p>è€Œæˆ‘è¿™é‡Œéœ€è¦çš„è¯·æ±‚åŒ…å¤§å°ä¹Ÿæ˜¯åœ¨æ‹¦æˆªä¸­è·å–åˆ°æ•°æ®ç„¶åå†™å…¥è¿› GrpcRequestã€‚</p><p><img src="https://s2.loli.net/2024/07/29/A1zk79tVOr3DxnQ.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;T&gt; Long <span class="title function_">getBodySize</span><span class="params">(T message)</span> &#123;  </span><br><span class="line">  <span class="keyword">if</span> (message <span class="keyword">instanceof</span> MessageLite) &#123;  </span><br><span class="line">    <span class="keyword">return</span> (<span class="type">long</span>) ((MessageLite) message).getSerializedSize();  </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    <span class="comment">// Message is not a protobuf message  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥å®ç°ä¸åŒçš„ RPC ä¸­è·å–è‡ªå·±çš„ <code>attribute</code>ï¼ŒåŒæ—¶æ¯ä¸€ç»„ <code>attribute</code> ä¹Ÿéƒ½æ˜¯éš”ç¦»çš„ï¼Œäº’ç›¸è§£è€¦ã€‚</p><h1 id="è‡ªå®šä¹‰-metrics"><a href="#è‡ªå®šä¹‰-metrics" class="headerlink" title="è‡ªå®šä¹‰ metrics"></a>è‡ªå®šä¹‰ metrics</h1><p>æ¯ä¸ªæ’ä»¶è‡ªå®šä¹‰ Metrics çš„é€»è¾‘ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œéœ€è¦ç”±æ¡†æ¶å±‚é¢æä¾› API æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> InstrumenterBuilder&lt;REQUEST, RESPONSE&gt; <span class="title function_">addOperationMetrics</span><span class="params">(OperationMetrics factory)</span> &#123;  </span><br><span class="line">  operationMetrics.add(requireNonNull(factory, <span class="string">&quot;operationMetrics&quot;</span>));  </span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å®¢æˆ·ç«¯çš„ metrics</span></span><br><span class="line">.addOperationMetrics(RpcClientMetrics.get());</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœåŠ¡ç«¯çš„ metrics</span></span><br><span class="line">.addOperationMetrics(RpcServerMetrics.get());</span><br></pre></td></tr></table></figure><p>ä¹‹åä¹Ÿä¼šåœ¨æ¡†æ¶å±‚é¢å›è°ƒè¿™äº›è‡ªå®šä¹‰çš„ <code>OperationMetrics</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> (operationListeners.length != <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="comment">// operation listeners run after span start, so that they have access to the current span</span></span><br><span class="line">     <span class="comment">// for capturing exemplars</span></span><br><span class="line">     <span class="type">long</span> <span class="variable">startNanos</span> <span class="operator">=</span> getNanos(startTime);</span><br><span class="line">     <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; operationListeners.length; i++) &#123;</span><br><span class="line">       context = operationListeners[i].onStart(context, attributes, startNanos);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (operationListeners.length != <span class="number">0</span>) &#123;  </span><br><span class="line">  <span class="type">long</span> <span class="variable">endNanos</span> <span class="operator">=</span> getNanos(endTime);  </span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> operationListeners.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;  </span><br><span class="line">    operationListeners[i].onEnd(context, attributes, endNanos);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å…¶ä¸­æœ€å…³é”®çš„å°±æ˜¯ä¸¤ä¸ªå‡½æ•° onStart å’Œ onEndï¼Œåˆ†åˆ«ä¼šåœ¨å½“å‰è¿™ä¸ª span çš„å¼€å§‹å’Œç»“æŸæ—¶è¿›è¡Œå›è°ƒã€‚</p><p>æ‰€ä»¥é€šå¸¸çš„åšæ³•æ˜¯åœ¨ <code>onStart</code> å‡½æ•°ä¸­åˆå§‹åŒ–æ•°æ®ï¼Œç„¶ååœ¨ <code>onEnd</code> ç»“æŸæ—¶ç»Ÿè®¡ç»“æœï¼Œæœ€ç»ˆå¯ä»¥æ‹¿åˆ° metrics æ‰€éœ€è¦çš„æ•°æ®ã€‚</p><p>ä»¥è¿™ä¸ª <code>rpc.client.duration</code> å®¢æˆ·ç«¯çš„è¯·æ±‚è€—æ—¶æŒ‡æ ‡ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Context <span class="title function_">onStart</span><span class="params">(Context context, Attributes startAttributes, <span class="type">long</span> startNanos)</span> &#123;  </span><br><span class="line">  <span class="keyword">return</span> context.with(  </span><br><span class="line">      RPC_CLIENT_REQUEST_METRICS_STATE,  </span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AutoValue_RpcClientMetrics_State</span>(startAttributes, startNanos));  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEnd</span><span class="params">(Context context, Attributes endAttributes, <span class="type">long</span> endNanos)</span> &#123;  </span><br><span class="line">  <span class="type">State</span> <span class="variable">state</span> <span class="operator">=</span> context.get(RPC_CLIENT_REQUEST_METRICS_STATE);</span><br><span class="line"><span class="type">Attributes</span> <span class="variable">attributes</span> <span class="operator">=</span> state.startAttributes().toBuilder().putAll(endAttributes).build();  </span><br><span class="line">clientDurationHistogram.record(  </span><br><span class="line">    (endNanos - state.startTimeNanos()) / NANOS_PER_MS, attributes, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¼€å§‹æ—¶è®°å½•ä¸‹å½“å‰çš„æ—¶é—´ï¼Œç»“æŸæ—¶è·å–å½“å‰æ—¶é—´å’Œç»“æŸæ—¶é—´çš„å·®å€¼æ­£å¥½å°±æ˜¯è¿™ä¸ª span çš„æ‰§è¡Œæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯ rpc client çš„å¤„ç†æ—¶é—´ã€‚</p><p>åœ¨ <code>OpenTelemetry</code> ä¸­ç»å¤§å¤šæ•°çš„è¯·æ±‚æ—¶é—´éƒ½æ˜¯è¿™ä¹ˆè®°å½•çš„ã€‚</p><h1 id="Golang-å¢å¼º"><a href="#Golang-å¢å¼º" class="headerlink" title="Golang å¢å¼º"></a>Golang å¢å¼º</h1><p>è€Œåœ¨ <code>Golang</code> ä¸­å› ä¸ºæ²¡æœ‰ <a href="https://bytebuddy.net/#/">byte-buddy</a> è¿™ç§é­”æ³•åº“çš„å­˜åœ¨ï¼Œä¸å¯ä»¥ç›´æ¥ä¿®æ”¹æºç ï¼Œæ‰€ä»¥é€šå¸¸çš„åšæ³•è¿˜æ˜¯å¾—ç¡¬ç¼–ç æ‰è¡Œã€‚</p><p>è¿˜æ˜¯ä»¥ <code>gRPC</code> ä¸ºä¾‹ï¼Œæˆ‘ä»¬åœ¨åˆ›å»º gRPC server æ—¶å°±å¾—æŒ‡å®šä¸€ä¸ª <code>OpenTelemetry</code> æä¾›çš„å‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s := grpc.NewServer(  </span><br><span class="line">    grpc.StatsHandler(otelgrpc.NewServerHandler()),  </span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/07/29/RP9LWQVKSOF1d4Z.png"></p><p> åœ¨è¿™ä¸ª SDK ä¸­ä¹Ÿä¼šå®ç°åˆšæ‰åœ¨ Java é‡Œç±»ä¼¼çš„é€»è¾‘ï¼Œé™äºç¯‡å¹…å…·ä½“é€»è¾‘å°±ä¸ç»†è®²äº†ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šå°±æ˜¯ <code>gRPC</code> åœ¨ <code>OpenTelemetry</code> ä¸­çš„å…·ä½“å®ç°ï¼Œä¸»è¦å°±æ˜¯åœ¨æ‰¾åˆ°éœ€è¦å¢å¼ºæ¡†æ¶æ˜¯å¦æœ‰æä¾›æ‰©å±•çš„æ¥å£ï¼Œå¦‚æœæœ‰å°±ç›´æ¥ä½¿ç”¨è¯¥æ¥å£è¿›è¡ŒåŸ‹ç‚¹ã€‚</p><p>å¦‚æœæ²¡æœ‰é‚£å°±éœ€è¦æŸ¥çœ‹æºç ï¼Œæ‰¾åˆ°æ ¸å¿ƒé€»è¾‘ï¼Œå†ä½¿ç”¨ <code>byte-buddy</code> è¿›è¡ŒåŸ‹ç‚¹ã€‚</p><p><img src="https://s2.loli.net/2024/07/30/h1uvr3EjA9fGmzR.png"></p><p>æ¯”å¦‚ Pulsar å¹¶æ²¡æœ‰åœ¨å®¢æˆ·ç«¯æä¾›ä¸€äº›æ‰©å±•æ¥å£ï¼Œåªèƒ½æ‰¾åˆ°å®ƒçš„æ ¸å¿ƒå‡½æ•°è¿›è¡ŒåŸ‹ç‚¹ã€‚</p><p>è€Œåœ¨å…·ä½“åŸ‹ç‚¹è¿‡ç¨‹ä¸­ <code>OpenTelemetry</code> æä¾›äº†è®¸å¤šè§£è€¦çš„ APIï¼Œæ–¹ä¾¿æˆ‘ä»¬å®ç°åŸ‹ç‚¹æ‰€éœ€è¦çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¹Ÿä¼šåœ¨åç»­çš„æ–‡ç« ç»§ç»­åˆ†æ <code>OpenTelemetry</code> çš„ä¸€äº›è®¾è®¡åŸç†å’Œæ ¸å¿ƒ API çš„ä½¿ç”¨ã€‚</p><p>è¿™éƒ¨åˆ† API çš„è®¾è®¡æˆ‘è§‰å¾—æ˜¯ <code>OpenTelemetry</code> ä¸­æœ€å€¼å¾—å­¦ä¹ çš„åœ°æ–¹ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://bytebuddy.net/#/">https://bytebuddy.net/#/</a></li><li><a href="https://opentelemetry.io/docs/specs/semconv/rpc/rpc-metrics/#metric-rpcserverrequestsize">https://opentelemetry.io/docs/specs/semconv/rpc/rpc-metrics/#metric-rpcserverrequestsize</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/07/29/uUTYr8lziEABk4d.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æœ€è¿‘åœ¨ç»™ &lt;code&gt;opentelemetry-java-instrumentation&lt;/code&gt; æäº¤äº†ä¸€ä¸ª &lt;a href=&quot;https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/11833&quot;&gt;PR&lt;/a&gt;ï¼Œæ˜¯å…³äºç»™ gRPC æ–°å¢å››ä¸ª metricsï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;rpc.client.request.size&lt;/code&gt;: å®¢æˆ·ç«¯è¯·æ±‚åŒ…å¤§å°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;rpc.client.response.size&lt;/code&gt;ï¼šå®¢æˆ·ç«¯æ”¶åˆ°çš„å“åº”åŒ…å¤§å°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;rpc.server.request.size&lt;/code&gt;ï¼šæœåŠ¡ç«¯æ”¶åˆ°çš„è¯·æ±‚åŒ…å¤§å°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;rpc.server.response.size&lt;/code&gt;ï¼šæœåŠ¡ç«¯å“åº”çš„è¯·æ±‚åŒ…å¤§å°&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™ä¸ª PR çš„ä¸»è¦ç›®çš„å°±æ˜¯èƒ½å¤Ÿåœ¨æŒ‡æ ‡ç›‘æ§ä¸­æ‹¿åˆ° &lt;code&gt;RPC&lt;/code&gt; è¯·æ±‚çš„åŒ…å¤§å°ï¼Œè€Œè¿™é‡Œçš„å…³é”®å°±æ˜¯å¦‚ä½•æ‰èƒ½æ‹¿åˆ°è¿™äº›åŒ…çš„å¤§å°ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åº”ç”¨æŒ‡æ ‡ç›‘æ§</title>
    <link href="http://crossoverjie.top/2024/08/27/ob/OpenTelemetry-02-metrics/"/>
    <id>http://crossoverjie.top/2024/08/27/ob/OpenTelemetry-02-metrics/</id>
    <published>2024-08-27T06:53:35.000Z</published>
    <updated>2024-08-27T14:42:10.419Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ï¼š<a href="https://juejin.cn/post/7391744486979076146">OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª</a>è®²è§£äº†é“¾è·¯ç›¸å…³çš„å®æˆ˜ï¼Œæœ¬æ¬¡æˆ‘ä»¬ç»§ç»­è·Ÿè¿›å¦‚ä½•ä½¿ç”¨ OpenTelemetry é›†æˆ metrics ç›‘æ§ã€‚</p><blockquote><p>å»ºè®®å¯¹æŒ‡æ ‡ç›‘æ§ä¸å¤ªç†Ÿçš„æœ‹å‹å¯ä»¥å…ˆæŸ¥çœ‹è¿™ç¯‡å‰èœæ–‡ç« ï¼š<a href="https://crossoverjie.top/2024/06/13/ob/OpenTelemetry-metrics-concept/">ä» Prometheus åˆ° OpenTelemetryï¼šæŒ‡æ ‡ç›‘æ§çš„æ¼”è¿›ä¸å®è·µ</a></p></blockquote><span id="more"></span><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th><th>è¯­è¨€</th><th>ç‰ˆæœ¬</th></tr></thead><tbody><tr><td>java-demo</td><td>å‘é€ gRPC è¯·æ±‚çš„å®¢æˆ·ç«¯</td><td>Java</td><td>opentelemetry-agent: 2.4.0&#x2F;SpringBoot: 2.7.14</td></tr><tr><td><a href="https://github.com/crossoverJie/k8s-combat">k8s-combat</a></td><td>æä¾› gRPC æœåŠ¡çš„æœåŠ¡ç«¯</td><td>Golang</td><td>go.opentelemetry.io&#x2F;otel: 1.28&#x2F; Go: 1.22</td></tr><tr><td><a href="https://www.jaegertracing.io/">Jaeger</a></td><td>trace å­˜å‚¨çš„æœåŠ¡ç«¯ä»¥åŠ TraceUI å±•ç¤º</td><td>Golang</td><td>jaegertracing&#x2F;all-in-one:1.56</td></tr><tr><td><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib">opentelemetry-collector-contrib</a></td><td>OpenTelemetry çš„ collector æœåŠ¡ç«¯ï¼Œç”¨äºæ”¶é›† trace&#x2F;metrics&#x2F;logs ç„¶åå†™å…¥åˆ°è¿œç«¯å­˜å‚¨</td><td>Golang</td><td>otel&#x2F;opentelemetry-collector-contrib:0.98.0</td></tr><tr><td><a href="https://prometheus.io/">Prometheus</a></td><td>ä½œä¸º metrics çš„å­˜å‚¨å’Œå±•ç¤ºç»„ä»¶ï¼Œä¹Ÿå¯ä»¥ç”¨ <a href="https://github.com/VictoriaMetrics/VictoriaMetrics">VictoriaMetrics</a> ç­‰å…¼å®¹ Prometheus çš„å­˜å‚¨æ›¿ä»£ã€‚</td><td>Golang</td><td>quay.io&#x2F;prometheus&#x2F;prometheus:v2.49.1</td></tr></tbody></table><p><img src="https://s2.loli.net/2024/07/22/oUPjd4KlX7niBaI.png" alt="image.png"></p><h1 id="å¿«é€Ÿå¼€å§‹"><a href="#å¿«é€Ÿå¼€å§‹" class="headerlink" title="å¿«é€Ÿå¼€å§‹"></a>å¿«é€Ÿå¼€å§‹</h1><p>ä»¥ä¸Šæ˜¯åŠ å…¥ metrics ä¹‹åçš„æµç¨‹å›¾ï¼Œåœ¨åŸæœ‰çš„åŸºç¡€ä¸Šä¼šæ–°å¢ä¸€ä¸ª <code>Prometheus</code> ç»„ä»¶ï¼Œcollector ä¼šå°† metrics æŒ‡æ ‡æ•°æ®é€šè¿‡è¿œç¨‹çš„ remote write çš„æ–¹å¼å†™å…¥åˆ° Prometheus ä¸­ã€‚</p><p>Prometheus ä¸ºäº†èƒ½å…¼å®¹ OpenTelemetry å†™å…¥è¿‡æ¥çš„æ•°æ®ï¼Œéœ€è¦å¼€å¯ç›¸å…³<a href="https://prometheus.io/docs/prometheus/latest/feature_flags/#otlp-receiver">ç‰¹æ€§</a>æ‰å¯ä»¥ã€‚</p><p>å¦‚æœæ˜¯ docker å¯åŠ¨çš„è¯éœ€è¦ä¼ å…¥ç›¸å…³å‚æ•°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run  -d -p 9292:9090 --name prometheus \</span><br><span class="line">-v /prometheus/prometheus.yml:/etc/prometheus/prometheus.yml \</span><br><span class="line">quay.io/prometheus/prometheus:v2.49.1 \</span><br><span class="line">--config.file=/etc/prometheus/prometheus.yml \</span><br><span class="line">--storage.tsdb.path=/prometheus \</span><br><span class="line">--web.console.libraries=/etc/prometheus/console_libraries \</span><br><span class="line">--web.console.templates=/etc/prometheus/consoles \</span><br><span class="line">--enable-feature=exemplar-storage \</span><br><span class="line">--enable-feature=otlp-write-receiver</span><br></pre></td></tr></table></figure><p><code>--enable-feature=otlp-write-receiver</code> æœ€ä¸»è¦çš„å°±æ˜¯è¿™ä¸ªå‚æ•°ï¼Œç”¨äºå¼€å¯æ¥æ”¶ OTLP æ ¼å¼çš„æ•°æ®ã€‚</p><p>ä½†ä½¿ç”¨è¿™ä¸ª Push ç‰¹æ€§å°±ä¼šä¸§å¤±æ‰ Prometheus çš„è®¸å¤š Pull ç‰¹æ€§ï¼Œæ¯”å¦‚æœåŠ¡å‘ç°ï¼Œå®šæ—¶æŠ“å–ç­‰ï¼Œä¸è¿‡ä¹Ÿè¿˜å¥½ï¼ŒPush å’Œ Pull å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼ŒåŸæœ¬ä½¿ç”¨ Pull æŠ“å–çš„ç»„ä»¶ä¾ç„¶ä¸å—å½±å“ã€‚</p><h2 id="ä¿®æ”¹-OpenTelemetry-Collector"><a href="#ä¿®æ”¹-OpenTelemetry-Collector" class="headerlink" title="ä¿®æ”¹ OpenTelemetry-Collector"></a>ä¿®æ”¹ OpenTelemetry-Collector</h2><p>æ¥ç€æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸‹ Collector çš„é…ç½®:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">debug:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">&quot;jaeger:4317&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">otlphttp/prometheus:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">http://prometheus:9292/api/v1/otlp</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span>      </span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="attr">batch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">traces:</span></span><br><span class="line">      <span class="attr">receivers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlp</span></span><br><span class="line">      <span class="attr">processors:</span> [<span class="string">batch</span>]</span><br><span class="line">      <span class="attr">exporters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">debug</span>        </span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">exporters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlphttp/prometheus</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">debug</span></span><br><span class="line">      <span class="attr">processors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">      <span class="attr">receivers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlp</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬åœ¨ <code>exporter</code> ä¸­æ–°å¢äº†ä¸€ä¸ª <code>otlphttp/prometheus</code> çš„èŠ‚ç‚¹ï¼Œç”¨äºæŒ‡å®šå¯¼å‡º <code>prometheus</code> çš„ <code>endpoint</code> åœ°å€ã€‚</p><p>åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦åœ¨ <code>server.metrics.exporters</code> ä¸­é…ç½®ç›¸åŒçš„ key: <code>otlphttp/prometheus</code>ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œæˆ‘ä»¬ä¸€å®šå¾—æ˜¯é…ç½®åœ¨ <code>metrics.exporters</code> è¿™ä¸ªèŠ‚ç‚¹ä¸‹ï¼Œå¦‚æœé…ç½®åœ¨ <code>traces.exporters</code> ä¸‹æ—¶ï¼Œç›¸å½“äºæ˜¯å‘Šè¯‰ collector è®² trace çš„æ•°æ®å¯¼å‡ºåˆ° <code>otlphttp/prometheus.endpoint</code> è¿™ä¸ª endpoint é‡Œäº†ã€‚</p><blockquote><p>æ‰€ä»¥é‡ç‚¹æ˜¯éœ€è¦ç†è§£è¿™é‡Œçš„é…å¯¹å…³ç³»ã€‚</p></blockquote><h2 id="è¿è¡Œæ•ˆæœ"><a href="#è¿è¡Œæ•ˆæœ" class="headerlink" title="è¿è¡Œæ•ˆæœ"></a>è¿è¡Œæ•ˆæœ</h2><p>è¿™æ ·æˆ‘ä»¬åªéœ€è¦å°†åº”ç”¨å¯åŠ¨ä¹‹åå°±å¯ä»¥åœ¨ Prometheus ä¸­æŸ¥è¯¢åˆ°åº”ç”¨ä¸ŠæŠ¥çš„æŒ‡æ ‡äº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.traces.exporter=otlp \</span><br><span class="line">-Dotel.metrics.exporter=otlp \</span><br><span class="line">-Dotel.logs.exporter=none \</span><br><span class="line">-Dotel.service.name=java-demo \</span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \</span><br><span class="line">-Dotel.propagators=tracecontext,baggage \</span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 -jar target/demo-0.0.1-SNAPSHOT.jar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Run go app</span></span><br><span class="line">export OTEL_EXPORTER_OTLP_ENDPOINT=http://127.0.0.1:5317 OTEL_RESOURCE_ATTRIBUTES=service.name=k8s-combat</span><br><span class="line">./k8s-combat</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬åœ¨ collector ä¸­å¼€å¯äº† Debug çš„ exporterï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2024-07-22T06:34:08.060ZinfoMetricsExporter&#123;&quot;kind&quot;: &quot;exporter&quot;, &quot;data_type&quot;: &quot;metrics&quot;, &quot;name&quot;: &quot;debug&quot;, &quot;resource metrics&quot;: 1, &quot;metrics&quot;: 18, &quot;data points&quot;: 44&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æ˜¯å¯ä»¥è¯´æ˜æŒ‡æ ‡ä¸Šä¼ æˆåŠŸçš„ã€‚</p><p>ç„¶åæˆ‘ä»¬æ‰“å¼€ <code>Prometheus</code> çš„åœ°å€ï¼š<a href="http://127.0.0.1:9292/graph">http://127.0.0.1:9292/graph</a><br>ä¾¿å¯ä»¥æŸ¥è¯¢åˆ° Java åº”ç”¨å’Œ Go åº”ç”¨ä¸ŠæŠ¥çš„æŒ‡æ ‡ã€‚<br><img src="https://s2.loli.net/2024/07/22/O4TuE5WlFJ8Gyk1.png"></p><blockquote><p>OpenTelemetry çš„ javaagent ä¼šè‡ªåŠ¨ä¸ŠæŠ¥ JVM ç›¸å…³çš„æŒ‡æ ‡ã€‚</p></blockquote><hr><p>è€Œåœ¨ Go ç¨‹åºä¸­æˆ‘ä»¬è¿˜æ˜¯éœ€è¦æ˜¾å¼çš„é…ç½®ä¸€äº›åŸ‹ç‚¹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMeterProvider</span><span class="params">()</span></span> *sdkmetric.MeterProvider &#123;  </span><br><span class="line">    ctx := context.Background()  </span><br><span class="line">  </span><br><span class="line">    exporter, err := otlpmetricgrpc.New(ctx)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Printf(<span class="string">&quot;new otlp metric grpc exporter failed: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    mp := sdkmetric.NewMeterProvider(  </span><br><span class="line">       sdkmetric.WithReader(sdkmetric.NewPeriodicReader(exporter)),  </span><br><span class="line">       sdkmetric.WithResource(initResource()),  </span><br><span class="line">    )    otel.SetMeterProvider(mp)  </span><br><span class="line">    <span class="keyword">return</span> mp  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mp := initMeterProvider()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := mp.Shutdown(context.Background()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Error shutting down meter provider: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>å’Œ Tracer ç±»ä¼¼ï¼Œæˆ‘ä»¬é¦–å…ˆä¹Ÿå¾—åœ¨ main å‡½æ•°ä¸­è°ƒç”¨ <code>initMeterProvider()</code> å‡½æ•°æ¥åˆå§‹åŒ– Meterï¼Œæ­¤æ—¶å®ƒä¼šè¿”å›ä¸€ä¸ª <code>sdkmetric.MeterProvider</code> å¯¹è±¡ã€‚</p><p>OpenTelemetry Go çš„ SDK ä¸­å·²ç»æä¾›äº†å¯¹ go runtime çš„è‡ªåŠ¨åŸ‹ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ç›¸å…³å‡½æ•°å³å¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">err := runtime.Start(runtime.WithMinimumReadMemStatsInterval(time.Second))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬å¯åŠ¨åº”ç”¨ï¼Œåœ¨ Prometheus ä¸­å°±å¯ä»¥çœ‹åˆ°  Go  åº”ç”¨ä¸ŠæŠ¥çš„ç›¸å…³æŒ‡æ ‡äº†ã€‚<br><img src="https://s2.loli.net/2024/07/21/FAHrsZ5ap6SWNU7.png" alt="image.png"><br><img src="https://s2.loli.net/2024/07/22/pxWu4UREZ5PXng1.png"></p><blockquote><p>runtime_uptime_milliseconds_total  Go çš„è¿è¡Œæ—¶æŒ‡æ ‡</p></blockquote><p><code>Prometheus</code> ä¸­å±•ç¤ºæŒ‡æ ‡çš„ UI èƒ½åŠ›æœ‰é™ï¼Œé€šå¸¸æˆ‘ä»¬éƒ½æ˜¯é…åˆ <code>grafana</code> è¿›è¡Œå±•ç¤ºçš„ã€‚<br><img src="https://s2.loli.net/2024/07/22/A7HNl1zbfeI4JuR.png" alt="image.png"></p><h2 id="æ‰‹åŠ¨ä¸ŠæŠ¥æŒ‡æ ‡"><a href="#æ‰‹åŠ¨ä¸ŠæŠ¥æŒ‡æ ‡" class="headerlink" title="æ‰‹åŠ¨ä¸ŠæŠ¥æŒ‡æ ‡"></a>æ‰‹åŠ¨ä¸ŠæŠ¥æŒ‡æ ‡</h2><p>å½“ç„¶é™¤äº† SDK è‡ªåŠ¨ä¸ŠæŠ¥çš„æŒ‡æ ‡ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç±»ä¼¼äº trace é‚£æ ·æ‰‹åŠ¨ä¸ŠæŠ¥ä¸€äº›æŒ‡æ ‡ï¼›</p><p>æ¯”å¦‚æˆ‘å°±æƒ³è®°å½•æŸä¸ªå‡½æ•°è°ƒç”¨çš„æ¬¡æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> meter =  otel.Meter(<span class="string">&quot;test.io/k8s/combat&quot;</span>)  </span><br><span class="line">apiCounter, err = meter.Int64Counter(  </span><br><span class="line">    <span class="string">&quot;api.counter&quot;</span>,  </span><br><span class="line">    metric.WithDescription(<span class="string">&quot;Number of API calls.&quot;</span>),  </span><br><span class="line">    metric.WithUnit(<span class="string">&quot;&#123;call&#125;&quot;</span>),  </span><br><span class="line">)  </span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Err(err)  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">defer</span> apiCounter.Add(ctx, <span class="number">1</span>)  </span><br><span class="line">    <span class="keyword">return</span> &amp;pb.HelloReply&#123;Message: fmt.Sprintf(<span class="string">&quot;hostname:%s, in:%s, md:%v&quot;</span>, name, in.Name, md)&#125;, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªéœ€è¦åˆ›å»ºä¸€ä¸ª <code>Int64Counter</code> ç±»å‹çš„æŒ‡æ ‡ï¼Œç„¶ååœ¨éœ€è¦åŸ‹ç‚¹å¤„è°ƒç”¨å®ƒçš„å‡½æ•° <code>apiCounter.Add(ctx, 1)</code> å³å¯ã€‚</p><p><img src="https://s2.loli.net/2024/07/21/cSwCa4U7WuoJ82n.png" alt="image.png"><br>ä¹‹åä¾¿å¯ä»¥åœ¨ <code>Prometheus</code> ä¸­æŸ¥åˆ°è¿™ä¸ªæŒ‡æ ‡äº†ã€‚</p><p>é™¤æ­¤ä¹‹å¤– OpenTelemetry ä¸­çš„ metrics å®šä¹‰å’Œ Prometheus ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œè¿˜æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p><ul><li><strong>Counter</strong>ï¼šå•è°ƒé€’å¢è®¡æ•°å™¨ï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥è®°å½•è®¢å•æ•°ã€æ€»çš„è¯·æ±‚æ•°ã€‚</li><li><strong>UpDownCounter</strong>ï¼šä¸ Counter ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒå¯ä»¥é€’å‡ã€‚</li><li><strong>Gauge</strong>ï¼šç”¨äºè®°å½•éšæ—¶åœ¨å˜åŒ–çš„å€¼ï¼Œæ¯”å¦‚å†…å­˜ä½¿ç”¨é‡ã€CPU ä½¿ç”¨é‡ç­‰ã€‚</li><li><strong>Histogram</strong>ï¼šé€šå¸¸ç”¨äºè®°å½•è¯·æ±‚å»¶è¿Ÿã€å“åº”æ—¶é—´ç­‰ã€‚</li></ul><p>åœ¨ Java ä¸­ä¹Ÿæä¾›æœ‰ç±»ä¼¼çš„ API å¯ä»¥å®Œæˆè‡ªå®šä¹‰æŒ‡æ ‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">messageInCounter = meter    </span><br><span class="line">        .counterBuilder(MESSAGE_IN_COUNTER)    </span><br><span class="line">        .setUnit(<span class="string">&quot;&#123;message&#125;&quot;</span>)    </span><br><span class="line">        .setDescription(<span class="string">&quot;The total number of messages received for this topic.&quot;</span>)    </span><br><span class="line">        .buildObserver();</span><br></pre></td></tr></table></figure><p>å¯¹äº Gauge ç±»å‹çš„æ•°æ®ç”¨æ³•å¦‚ä¸‹ï¼Œä½¿ç”¨ <code>buildWithCallback</code> å›è°ƒå‡½æ•°ä¸ŠæŠ¥æ•°æ®ï¼Œ<code>OpenTelemetry</code> ä¼šåœ¨æ¡†æ¶å±‚é¢æ¯ 30s å›è°ƒä¸€æ¬¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerObservers</span><span class="params">()</span> &#123;      </span><br><span class="line">    <span class="type">Meter</span> <span class="variable">meter</span> <span class="operator">=</span> MetricsRegistration.getMeter();      </span><br><span class="line">      </span><br><span class="line">    meter.gaugeBuilder(<span class="string">&quot;pulsar_producer_num_msg_send&quot;</span>)      </span><br><span class="line">            .setDescription(<span class="string">&quot;The number of messages published in the last interval&quot;</span>)      </span><br><span class="line">            .ofLongs()      </span><br><span class="line">            .buildWithCallback(      </span><br><span class="line">                    r -&gt; recordProducerMetrics(r, ProducerStats::getNumMsgsSent));  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recordProducerMetrics</span><span class="params">(ObservableLongMeasurement observableLongMeasurement, Function&lt;ProducerStats, Long&gt; getter)</span> &#123;      </span><br><span class="line">    <span class="keyword">for</span> (Producer producer : CollectionHelper.PRODUCER_COLLECTION.list()) &#123;      </span><br><span class="line">        <span class="type">ProducerStats</span> <span class="variable">stats</span> <span class="operator">=</span> producer.getStats();      </span><br><span class="line">        <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> producer.getTopic();      </span><br><span class="line">        <span class="keyword">if</span> (topic.endsWith(RetryMessageUtil.RETRY_GROUP_TOPIC_SUFFIX)) &#123;      </span><br><span class="line">            <span class="keyword">continue</span>;      </span><br><span class="line">        &#125;        observableLongMeasurement.record(getter.apply(stats),      </span><br><span class="line">                Attributes.of(PRODUCER_NAME, producer.getProducerName(), TOPIC, topic));      </span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure><p>æ›´å¤šå…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£é“¾æ¥ï¼š<br><a href="https://opentelemetry.io/docs/languages/java/instrumentation/#metrics">https://opentelemetry.io/docs/languages/java/instrumentation/#metrics</a></p><p>å¦‚æœæˆ‘ä»¬ä¸æƒ³å°†æ•°æ®é€šè¿‡ collector è€Œæ˜¯ç›´æ¥ä¸ŠæŠ¥åˆ° Prometheus ä¸­ï¼Œä½¿ç”¨ OpenTelemetry æ¡†æ¶ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„ã€‚</p><p>æˆ‘ä»¬åªéœ€è¦é…ç½®ä¸‹ç¯å¢ƒå˜é‡:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export OTEL_METRICS_EXPORTER=prometheus</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è®¿é—® <a href="http://127.0.0.1:9464/metrics">http://127.0.0.1:9464/metrics</a> è·å–åˆ°å½“å‰åº”ç”¨æš´éœ²å‡ºæ¥çš„æŒ‡æ ‡ï¼Œæ­¤æ—¶å°±å¯ä»¥åœ¨ <code>Prometheus</code> é‡Œé…ç½®å¥½é‡‡é›† job æ¥è·å–æ•°æ®ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;k8s-combat&quot;</span></span><br><span class="line">    <span class="comment"># metrics_path defaults to &#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="comment"># scheme defaults to &#x27;http&#x27;.</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;k8s-combat:9464&quot;</span>]   </span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯å…¸å‹çš„ Pull æ¨¡å‹ï¼Œè€Œ OpenTelemetry æ¨èä½¿ç”¨çš„æ˜¯ Push æ¨¡å‹ï¼Œæ•°æ®ç”± OpenTelemetry è¿›è¡Œé‡‡é›†ç„¶åæ¨é€åˆ° Prometheusã€‚</p><p>è¿™ä¸¤ç§æ¨¡å¼å„æœ‰å¥½å¤„ï¼š</p><table><thead><tr><th></th><th>Pullæ¨¡å‹</th><th>Push æ¨¡å‹</th></tr></thead><tbody><tr><td>ä¼˜ç‚¹</td><td>å¯ä»¥åœ¨ä¸€ä¸ªé›†ä¸­çš„é…ç½®é‡Œç®¡ç†æ‰€æœ‰çš„æŠ“å–ç«¯ç‚¹ï¼Œä¹Ÿå¯ä»¥ä¸ºæ¯ä¸€ä¸ªåº”ç”¨å•ç‹¬é…ç½®æŠ“å–é¢‘æ¬¡ç­‰æ•°æ®ã€‚</td><td>åœ¨ OpenTelemetry çš„ collectorä¸­å¯ä»¥é›†ä¸­å¯¹æŒ‡æ ‡åšé¢„å¤„ç†ä¹‹åå†å°†è¿‡æ»¤åçš„æ•°æ®å†™å…¥ Prometheusï¼Œæ›´åŠ çš„çµæ´»ã€‚</td></tr><tr><td>ç¼ºç‚¹</td><td>1. é¢„å¤„ç†æŒ‡æ ‡æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€æœ‰çš„æ•°æ®æ˜¯åˆ°äº† Prometheus åå†ç»è¿‡relabelå¤„ç†åå†å†™å…¥å­˜å‚¨ã€‚<br>2. éœ€è¦é…ç½®æœåŠ¡å‘ç°</td><td>1. é¢å¤–éœ€è¦ç»´æŠ¤ä¸€ä¸ªç±»ä¼¼äº collector è¿™æ ·çš„æŒ‡æ ‡ç½‘å…³çš„ç»„ä»¶</td></tr></tbody></table><p>æ¯”å¦‚æˆ‘ä»¬æ˜¯ç”¨å’Œ Prometheus å…¼å®¹çš„ VictoriaMetrics é‡‡é›†äº† istio çš„ç›¸å…³æŒ‡æ ‡ï¼Œä½†é‡Œé¢çš„æŒ‡æ ‡å¤ªå¤šäº†ï¼Œæˆ‘ä»¬éœ€è¦åˆ é™¤æ‰ä¸€éƒ¨åˆ†ã€‚</p><p>å°±éœ€è¦åœ¨é‡‡é›†ä»»åŠ¡é‡Œç¼–å†™è§„åˆ™ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMPodScrape</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">isito-pod-scrape</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">podMetricsEndpoints:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">scheme:</span> <span class="string">http</span>  </span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">&quot;30s&quot;</span>  </span><br><span class="line">      <span class="attr">scrapeTimeout:</span> <span class="string">&quot;30s&quot;</span>  </span><br><span class="line">      <span class="attr">path:</span> <span class="string">/stats/prometheus</span>  </span><br><span class="line">      <span class="attr">metricRelabelConfigs:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">^envoy_.*|^url\_\_\_\_.*|istio_request_bytes_sum|istio_request_bytes_count|istio_response_bytes_sum|istio_request_bytes_sum|istio_request_duration_milliseconds_sum|istio_response_bytes_count|istio_request_duration_milliseconds_count|^ostrich_apigateway.*|istio_request_messages_total|istio_response_messages_total</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">drop_metrics</span>  </span><br><span class="line">  <span class="attr">namespaceSelector:</span>  </span><br><span class="line">    <span class="attr">any:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>æ¢æˆåœ¨ collector ä¸­å¤„ç†åï¼Œè¿™äº›é€»è¾‘éƒ½å¯ä»¥å…¨éƒ¨ç§»åŠ¨åˆ° collector ä¸­é›†ä¸­å¤„ç†ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>metrics çš„ä½¿ç”¨ç›¸å¯¹äº trace æ›´ç®€å•ä¸€äº›ï¼Œä¸éœ€è¦ç†è§£å¤æ‚çš„ contextã€span ç­‰æ¦‚å¿µï¼Œåªéœ€è¦ææ¸…æ¥šæœ‰å“ªå‡ ç§ metrics ç±»å‹ï¼Œåˆ†åˆ«åº”ç”¨åœ¨å“ªäº›ä¸åŒçš„åœºæ™¯å³å¯ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://prometheus.io/docs/prometheus/latest/feature_flags/#otlp-receiver">https://prometheus.io/docs/prometheus/latest/feature_flags/#otlp-receiver</a></li><li><a href="https://opentelemetry.io/docs/languages/java/instrumentation/#metrics">https://opentelemetry.io/docs/languages/java/instrumentation/#metrics</a></li><li><a href="https://opentelemetry.io/docs/languages/go/instrumentation/#metrics">https://opentelemetry.io/docs/languages/go/instrumentation/#metrics</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ï¼š&lt;a href=&quot;https://juejin.cn/post/7391744486979076146&quot;&gt;OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª&lt;/a&gt;è®²è§£äº†é“¾è·¯ç›¸å…³çš„å®æˆ˜ï¼Œæœ¬æ¬¡æˆ‘ä»¬ç»§ç»­è·Ÿè¿›å¦‚ä½•ä½¿ç”¨ OpenTelemetry é›†æˆ metrics ç›‘æ§ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å»ºè®®å¯¹æŒ‡æ ‡ç›‘æ§ä¸å¤ªç†Ÿçš„æœ‹å‹å¯ä»¥å…ˆæŸ¥çœ‹è¿™ç¯‡å‰èœæ–‡ç« ï¼š&lt;a href=&quot;https://crossoverjie.top/2024/06/13/ob/OpenTelemetry-metrics-concept/&quot;&gt;ä» Prometheus åˆ° OpenTelemetryï¼šæŒ‡æ ‡ç›‘æ§çš„æ¼”è¿›ä¸å®è·µ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª</title>
    <link href="http://crossoverjie.top/2024/08/20/ob/OpenTelemetry-01-trace/"/>
    <id>http://crossoverjie.top/2024/08/20/ob/OpenTelemetry-01-trace/</id>
    <published>2024-08-20T06:53:35.000Z</published>
    <updated>2024-08-20T06:35:59.105Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡ <a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</a>çš„æ–‡ç« ï¼Œä¸»è¦æ˜¯ä»æ¦‚å¿µä¸Šè®²è§£äº† Trace åœ¨ OpenTelemetry çš„ä¸­çš„åœºæ™¯å’Œä½¿ç”¨ã€‚</p><p>ä¹Ÿå†™è¿‡ä¸€ç¯‡ <a href="https://crossoverjie.top/2024/05/26/ob/OTel-demo/">å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯</a>ï¼šå¦‚ä½•ä»ä¸€ä¸ª demo å¼€å§‹é›†æˆ OpenTelemetryã€‚</p><p>ä½†è¿˜æ˜¯æœ‰ä¸å°‘å°ä¼™ä¼´åé¦ˆè¯´æ— æ³•å¿«é€Ÿä¸Šæ‰‹ï¼ˆå¯èƒ½ä¹Ÿæ˜¯è¿™ä¸ª demo çš„é¡¹ç›®æ¯”è¾ƒå¤šï¼‰ï¼Œäºæ˜¯æˆ‘å‡†å¤‡ä» 0 å¼€å§‹ä»çœŸå®çš„ä»£ç ä¸€æ­¥æ­¥å¸¦å¤§å®¶é›†æˆ <code>OpenTelemetry</code>ï¼Œå› ä¸º OpenTelemetry æœ¬èº«æ˜¯è·¨å¤šç§è¯­è¨€çš„ï¼Œæ‰€ä»¥ä¹Ÿä¼šä»¥ä¸¤ç§è¯­è¨€ä¸ºï¼ˆJavaã€Golangï¼‰ä¸»è¿›è¡Œè®²è§£ã€‚</p><blockquote><p>ä½¿ç”¨è¿™ä¸¤ç§è¯­è¨€ä¸»è¦æ˜¯å› ä¸º Java å‡ ä¹å…¨æ˜¯è‡ªåŠ¨åŸ‹ç‚¹ï¼Œè€Œ Golang å› ä¸ºè¯­è¨€ç‰¹æ€§ï¼Œå¤§éƒ¨åˆ†éƒ½å¾—ç¡¬ç¼–ç åŸ‹ç‚¹ï¼›è¦†ç›–åˆ°è¿™ä¸¤ç§åœºæ™¯åå…¶ä»–è¯­è¨€ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œé¡¶å¤šåªæ˜¯ API åç§°æœ‰äº›è®¸åŒºåˆ«ã€‚</p></blockquote><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿä¼šç©¿æ’ä¸€äº› OpenTelemetry çš„åŸç†ï¼Œå¸Œæœ›æ•´ä¸ªè¿‡ç¨‹ä¸‹æ¥å¤§å®¶å¯ä»¥åœ¨é¡¹ç›®ä¸­å®é™…è¿ç”¨èµ·æ¥ï¼ŒåŒæ—¶ä¹Ÿèƒ½çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p><span id="more"></span><h1 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h1><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹é¡¹ç›®ï¼š</p><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th><th>è¯­è¨€</th><th>ç‰ˆæœ¬</th></tr></thead><tbody><tr><td>java-demo</td><td>å‘é€ gRPC è¯·æ±‚çš„å®¢æˆ·ç«¯</td><td>Java</td><td>opentelemetry-agent: 2.4.0&#x2F;SpringBoot: 2.7.14</td></tr><tr><td>k8s-combat</td><td>æä¾› gRPC æœåŠ¡çš„æœåŠ¡ç«¯</td><td>Golang</td><td>go.opentelemetry.io&#x2F;otel: 1.28&#x2F; Go: 1.22</td></tr><tr><td>Jaeger</td><td>trace å­˜å‚¨çš„æœåŠ¡ç«¯ä»¥åŠ TraceUI å±•ç¤º</td><td>Golang</td><td>jaegertracing&#x2F;all-in-one:1.56</td></tr><tr><td>opentelemetry-collector-contrib</td><td>OpenTelemetry çš„ collector æœåŠ¡ç«¯ï¼Œç”¨äºæ”¶é›† trace&#x2F;metrics&#x2F;logs ç„¶åå†™å…¥åˆ°è¿œç«¯å­˜å‚¨</td><td>Golang</td><td>otel&#x2F;opentelemetry-collector-contrib:0.98.0</td></tr></tbody></table><p><img src="https://s2.loli.net/2024/07/15/u4BYXOkztqyUoEK.png" alt="image.png"></p><p>åœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹çœ‹å®é™…çš„æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŠŠ collector å’Œ Jaeger éƒ¨ç½²å¥½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -d --name jaeger \</span><br><span class="line">  -e COLLECTOR_ZIPKIN_HOST_PORT=:9411 \</span><br><span class="line">  -p 6831:6831/udp \</span><br><span class="line">  -p 6832:6832/udp \</span><br><span class="line">  -p 5778:5778 \</span><br><span class="line">  -p 16686:16686 \</span><br><span class="line">  -p 4317:4317 \</span><br><span class="line">  -p 4318:4318 \</span><br><span class="line">  -p 14250:14250 \</span><br><span class="line">  -p 14268:14268 \</span><br><span class="line">  -p 14269:14269 \</span><br><span class="line">  -p 9411:9411 \</span><br><span class="line">  jaegertracing/all-in-one:1.56</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run --rm -d -v $(pwd)/coll-config.yaml:/etc/otelcol-contrib/config.yaml --name coll \</span><br><span class="line">-p 5318:4318 \</span><br><span class="line">-p 5317:4317 \</span><br><span class="line">otel/opentelemetry-collector-contrib:0.98.0</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ª <code>coll-config</code> çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">protocols:</span></span><br><span class="line">      <span class="attr">grpc:</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">debug:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">&quot;127.0.0.1:4317&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="attr">batch:</span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">traces:</span></span><br><span class="line">      <span class="attr">receivers:</span> [<span class="string">otlp</span>]</span><br><span class="line">      <span class="attr">processors:</span> [<span class="string">batch</span>]</span><br><span class="line">      <span class="attr">exporters:</span> [<span class="string">otlp</span>, <span class="string">debug</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é‡ç‚¹æ˜¯è¿™é‡Œçš„ <code>endpoint: &quot;127.0.0.1:4317&quot;</code> æˆ‘ä»¬éœ€è¦é…ç½®ä½ Jaeger çš„ IP å’Œç«¯å£ã€‚</p><blockquote><p>æ›´å¤šå…³äºè¿™é‡Œçš„é…ç½®ä¼šåœ¨åç»­å•ç‹¬çš„ collector ç« èŠ‚ä¸­è®²è§£ã€‚</p></blockquote><p>è¿™ä¸¤ä¸ªæœåŠ¡éƒ½å¯åŠ¨æˆåŠŸåå†å¯åŠ¨æˆ‘ä»¬çš„ Java å®¢æˆ·ç«¯å’Œ  Go  æœåŠ¡ç«¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.traces.exporter=otlp \</span><br><span class="line">-Dotel.metrics.exporter=otlp \</span><br><span class="line">-Dotel.logs.exporter=none \</span><br><span class="line">-Dotel.service.name=demo \</span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \</span><br><span class="line">-Dotel.propagators=tracecontext,baggage \</span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Golang</span></span><br><span class="line">export OTEL_EXPORTER_OTLP_ENDPOINT=http://127.0.0.1:5317</span><br><span class="line">export OTEL_RESOURCE_ATTRIBUTES=service.name=k8s-combat</span><br><span class="line">./k8s-combat</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸ç®¡æ˜¯ Java è¿˜æ˜¯ Golang åº”ç”¨éƒ½æ˜¯éœ€è¦é…ç½® <code>OTEL_EXPORTER_OTLP_ENDPOINT</code> å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ <code>opentelemetry-collector-contrib</code> çš„åœ°å€ã€‚</p><blockquote><p>å…¶ä½™çš„ä¸€äº›é…ç½®åœ¨åé¢ä¼šè®²åˆ°ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:9191/request\?name\=1232</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è§¦å‘ä¸€ä¸‹ Java å®¢æˆ·ç«¯çš„å…¥å£ï¼Œå°±å¯ä»¥åœ¨ JaegerUI ä¸­æŸ¥è¯¢åˆ°åˆšæ‰çš„é“¾è·¯äº†ã€‚<br><code>http://localhost:16686/search</code></p><p><img src="https://s2.loli.net/2024/07/15/skNmSDJaPfHh3GB.png" alt="image.png"><br><img src="https://s2.loli.net/2024/07/15/xoG2finOmFlDReE.png" alt="image.png"><br>è¿™æ ·æ•´ä¸ª <code>trace</code> é“¾è·¯å°±ä¸²èµ·æ¥äº†ã€‚</p><h1 id="Java-åº”ç”¨"><a href="#Java-åº”ç”¨" class="headerlink" title="Java åº”ç”¨"></a>Java åº”ç”¨</h1><p>ä¸‹é¢æ¥çœ‹çœ‹å…·ä½“çš„åº”ç”¨ä»£ç é‡Œæ˜¯å¦‚ä½•ç¼–å†™çš„ã€‚</p><blockquote><p>Java æ˜¯åŸºäº springboot ç¼–å†™çš„ï¼Œå…·ä½“ springboot çš„ä½¿ç”¨å°±ä¸å†èµ˜è¿°äº†ã€‚</p></blockquote><p>å› ä¸ºæˆ‘ä»¬åº”ç”¨æ˜¯ä½¿ç”¨ gRPC é€šä¿¡çš„ï¼Œæ‰€ä»¥éœ€è¦æä¾›ä¸€ä¸ª <code>helloworld.proto</code> çš„ pb æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;  </span><br><span class="line">  </span><br><span class="line">option go_package = &quot;google.golang.org/grpc/examples/helloworld/helloworld&quot;;  </span><br><span class="line">option java_multiple_files = true;  </span><br><span class="line">option java_package = &quot;io.grpc.examples.helloworld&quot;;  </span><br><span class="line">option java_outer_classname = &quot;HelloWorldProto&quot;;  </span><br><span class="line">  </span><br><span class="line">package helloworld;  </span><br><span class="line">  </span><br><span class="line">// The greeting service definition.  </span><br><span class="line">service Greeter &#123;  </span><br><span class="line">  // Sends a greeting  </span><br><span class="line">  rpc SayHello (HelloRequest) returns (HelloReply) &#123;&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// The request message containing the user&#x27;s name.  </span><br><span class="line">message HelloRequest &#123;  </span><br><span class="line">  string name = 1;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// The response message containing the greetings  </span><br><span class="line">message HelloReply &#123;  </span><br><span class="line">  string message = 1;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶ä¹Ÿæ²¡å•¥å¥½è¯´çš„ï¼Œå°±å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„ <code>SayHello</code> æ¥å£ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.devh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨ Java ä¸­ä½¿ç”¨äº† <code>grpc-spring-boot-starter</code> è¿™ä¸ªåº“æ¥å¤„ç† gRPC çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¯·æ±‚ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">grpc:</span>  </span><br><span class="line">  <span class="attr">server:</span>  </span><br><span class="line">    <span class="attr">port:</span> <span class="number">9192</span>  </span><br><span class="line">  <span class="attr">client:</span>  </span><br><span class="line">    <span class="attr">greeter:</span>  </span><br><span class="line">      <span class="attr">address:</span> <span class="string">&#x27;static://127.0.0.1:50051&#x27;</span>  </span><br><span class="line">      <span class="attr">enableKeepAlive:</span> <span class="literal">true</span>  </span><br><span class="line">      <span class="attr">keepAliveWithoutCalls:</span> <span class="literal">true</span>  </span><br><span class="line">      <span class="attr">negotiationType:</span> <span class="string">plaintext</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ¥å£ç”¨äºæ¥æ”¶è¯·æ±‚è§¦å‘ <code>gRPC</code> çš„è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line">   log.info(<span class="string">&quot;request: &#123;&#125;&quot;</span>, request);    </span><br><span class="line">   <span class="type">HelloReply</span> <span class="variable">abc</span> <span class="operator">=</span> greeterStub.sayHello(io.grpc.examples.helloworld.HelloRequest.newBuilder().setName(request.getName()).build());   </span><br><span class="line">   <span class="keyword">return</span> abc.getMessage();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Java åº”ç”¨çš„å®ç°éå¸¸ç®€å•ï¼Œå’Œæˆ‘ä»¬æ—¥å¸¸æ—¥å¸¸å¼€å‘æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼›å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯åœ¨å¯åŠ¨æ—¶éœ€è¦åŠ å…¥ä¸€ä¸ª <code>javaagent</code>ä»¥åŠä¸€äº›å¯åŠ¨å‚æ•°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.traces.exporter=otlp \</span><br><span class="line">-Dotel.metrics.exporter=otlp \</span><br><span class="line">-Dotel.logs.exporter=none \</span><br><span class="line">-Dotel.service.name=demo \</span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \</span><br><span class="line">-Dotel.propagators=tracecontext,baggage \</span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ¥ä»”ç»†çœ‹çœ‹è¿™äº›å‚æ•°</p><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar</td><td>è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼ŒæŒ‡å®šä¸€ä¸ª javaagent</td></tr><tr><td>otel.traces.exporter</td><td>æŒ‡å®š trace ä»¥ä»€ä¹ˆæ ¼å¼ä¼ è¾“ï¼ˆé»˜è®¤æ˜¯è¿™é‡Œçš„ <code>otlp</code>)ï¼›å½“ç„¶è¿˜æœ‰å…¶ä»–çš„å€¼ï¼š<code>logging/jaeger/zipkin</code> ç­‰ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨ otlp ä¼šå°†æ•°æ®ä¼ è¾“åˆ° collector ä¸­ã€‚</td></tr><tr><td>otel.metrics.exporter</td><td>åŒä¸Šï¼Œåªæ˜¯æŒ‡å®šçš„æ˜¯ metrics çš„ä¼ è¾“æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ä¹‹åè®²è§£æŒ‡æ ‡çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</td></tr><tr><td>otel.service.name</td><td>å®šä¹‰åœ¨ trace ä¸­çš„åº”ç”¨åç§°ï¼Œspringboot ä¼šé»˜è®¤ä½¿ç”¨ <code>spring.application.name</code> è¿™ä¸ªå˜é‡ã€‚</td></tr><tr><td>otel.exporter.otlp.protocol</td><td>æŒ‡å®šä¼ è¾“åè®®ï¼›é™¤äº† grpc ä¹‹å¤–è¿˜æœ‰ <code>http/protobuf</code>ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ® trace å’Œ metrics åˆ†å¼€æŒ‡å®šï¼š<code>otel.exporter.otlp.traces.protocol/otel.exporter.otlp.metrics.protocol</code></td></tr><tr><td>otel.propagators</td><td>æŒ‡å®šæˆ‘ä»¬è·¨æœåŠ¡ä¼ æ’­ä¸Šä¸‹æ–‡çš„æ—¶å€™ä½¿ç”¨å“ªç§æ ¼å¼ï¼Œé»˜è®¤æ˜¯ <a href="https://www.w3.org/TR/trace-context/">W3C Trace Context</a>,<a href="https://www.w3.org/TR/baggage/">baggage</a>ï¼Œå½“ç„¶ä¹Ÿæœ‰å…¶ä»–çš„- <code>&quot;b3&quot;</code>:Â <a href="https://github.com/openzipkin/b3-propagation#single-header">B3 Single</a>ï¼Œ- <code>&quot;xray&quot;</code>:Â <a href="https://docs.aws.amazon.com/xray/latest/devguide/xray-concepts.html#xray-concepts-tracingheader">AWS X-Ray</a>ï¼Œ<code>&quot;jaeger&quot;</code>:Â <a href="https://www.jaegertracing.io/docs/1.21/client-libraries/#propagation-format">Jaeger</a>ç­‰</td></tr><tr><td>otel.exporter.otlp.endpoint</td><td>æŒ‡å®š collector çš„ endpoint</td></tr><tr><td>æ›´å¤šç»†èŠ‚çš„å‚æ•°å¤§å®¶å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼š</td><td></td></tr><tr><td><a href="https://opentelemetry.io/docs/languages/java/configuration/">https://opentelemetry.io/docs/languages/java/configuration/</a></td><td></td></tr></tbody></table><h1 id="Golang-åº”ç”¨"><a href="#Golang-åº”ç”¨" class="headerlink" title="Golang åº”ç”¨"></a>Golang åº”ç”¨</h1><p>æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹ Go æ˜¯å¦‚ä½•é›†æˆ <code>OpenTelemetry</code> çš„ã€‚</p><p>åœ¨åˆ›å»ºå¥½é¡¹ç›®ä¹‹åæˆ‘ä»¬éœ€è¦æ·»åŠ  <code>OpenTelemetry</code> æ‰€æä¾›çš„åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">go get &quot;go.opentelemetry.io/otel&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/exporters/otlp/otlpmetric/otlpmetricgrpc&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/propagation&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/sdk/metric&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/sdk/resource&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/sdk/trace&quot; \       &quot;go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc&quot;\</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªåˆå§‹åŒ– <code>tracer</code> çš„å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initTracerProvider</span><span class="params">()</span></span> *sdktrace.TracerProvider &#123;</span><br><span class="line">ctx := context.Background()</span><br><span class="line"></span><br><span class="line">exporter, err := otlptracegrpc.New(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;new otlp trace grpc exporter failed: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">tp := sdktrace.NewTracerProvider(</span><br><span class="line">sdktrace.WithBatcher(exporter),</span><br><span class="line">sdktrace.WithResource(initResource()),</span><br><span class="line">)</span><br><span class="line">otel.SetTracerProvider(tp)</span><br><span class="line">otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(propagation.TraceContext&#123;&#125;, propagation.Baggage&#123;&#125;))</span><br><span class="line"><span class="keyword">return</span> tp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <code>grpc</code> åè®®ä¸ŠæŠ¥ <code>otlp</code> æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>exporter, err := otlptracegrpc.New(ctx)</code>  åˆ›å»ºäº†ä¸€ä¸ª <code>exporter</code>ã€‚</p><p><code>otel.SetTextMapPropagator()</code> è¿™ä¸ªå‡½æ•°é‡Œé…ç½®æ•°æ®å’Œåˆšæ‰ Java é‡Œé…ç½®çš„ <code>-Dotel.propagators=tracecontext,baggage</code> æ˜¯ä¸€æ ·çš„æ•ˆæœã€‚</p><p>ä¸æ­¤åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦æä¾›ä¸€ä¸ª <code>initResource()</code> çš„å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initResource</span><span class="params">()</span></span> *sdkresource.Resource &#123;</span><br><span class="line">initResourcesOnce.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">extraResources, _ := sdkresource.New(</span><br><span class="line">context.Background(),</span><br><span class="line">sdkresource.WithOS(),</span><br><span class="line">sdkresource.WithProcess(),</span><br><span class="line">sdkresource.WithContainer(),</span><br><span class="line">sdkresource.WithHost(),</span><br><span class="line">)</span><br><span class="line">resource, _ = sdkresource.Merge(</span><br><span class="line">sdkresource.Default(),</span><br><span class="line">extraResources,</span><br><span class="line">)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> resource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ç”¨æ¥å‘Šè¯‰ trace éœ€è¦æš´éœ²é‚£äº› resourceï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°è¿›ç¨‹ç›¸å…³çš„å±æ€§ï¼š<br><img src="https://s2.loli.net/2024/07/15/Gveu4hNjWdYLiBo.png" alt="image.png"><br>æ¯”å¦‚è¿™é‡Œçš„ <code>sdkresource.WithOS(),</code> å°±ä¼šæ˜¾ç¤º OS çš„ç±»å‹å’Œæè¿°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithOS</span><span class="params">()</span></span> Option &#123;  </span><br><span class="line">    <span class="keyword">return</span> WithDetectors(  </span><br><span class="line">       osTypeDetector&#123;&#125;,  </span><br><span class="line">       osDescriptionDetector&#123;&#125;,  </span><br><span class="line">    )&#125;</span><br></pre></td></tr></table></figure><p>è€Œ <code>sdkresource.WithProcess(),</code> æ˜¾ç¤ºçš„æ•°æ®å°±æ›´å¤šäº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithProcess</span><span class="params">()</span></span> Option &#123;  </span><br><span class="line">    <span class="keyword">return</span> WithDetectors(  </span><br><span class="line">       processPIDDetector&#123;&#125;,  </span><br><span class="line">       processExecutableNameDetector&#123;&#125;,  </span><br><span class="line">       processExecutablePathDetector&#123;&#125;,  </span><br><span class="line">       processCommandArgsDetector&#123;&#125;,  </span><br><span class="line">       processOwnerDetector&#123;&#125;,  </span><br><span class="line">       processRuntimeNameDetector&#123;&#125;,  </span><br><span class="line">       processRuntimeVersionDetector&#123;&#125;,  </span><br><span class="line">       processRuntimeDescriptionDetector&#123;&#125;,  </span><br><span class="line">    )&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä»¥ä¸Šè¿™äº›ä»£ç åœ¨ Java ä¸­éƒ½æ˜¯ç”± agent æŒ‡å®šåˆ›å»ºçš„ã€‚</p></blockquote><hr><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Init OpenTelemetry start  </span></span><br><span class="line">tp := initTracerProvider()  </span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> err := tp.Shutdown(context.Background()); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Printf(<span class="string">&quot;Error shutting down tracer provider: %v&quot;</span>, err)  </span><br><span class="line">    &#125;&#125;()  </span><br><span class="line">   </span><br><span class="line">err := runtime.Start(runtime.WithMinimumReadMemStatsInterval(time.Second))  </span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Err(err)  </span><br><span class="line">&#125;</span><br><span class="line">tracer = tp.Tracer(<span class="string">&quot;k8s-combat&quot;</span>)</span><br><span class="line"><span class="comment">// Init OpenTelemetry end</span></span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬éœ€è¦åœ¨ main å‡½æ•°ä¸€å¼€å§‹å°±åˆå§‹åŒ– <code>traceProvider</code>ã€‚</p><p>å¯¹äº <code>grpc</code> æ¥è¯´ï¼Œ<code>OpenTelemetry</code> çš„ Go-SDK æä¾›äº†è‡ªåŠ¨åŸ‹ç‚¹ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¾—æ‰‹åŠ¨é…ç½®ä¸€ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s := grpc.NewServer(  </span><br><span class="line">    grpc.StatsHandler(otelgrpc.NewServerHandler()),  </span><br><span class="line">)  </span><br><span class="line">pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>grpc.StatsHandler(otelgrpc.NewServerHandler()),</code>  å°† <code>OTel</code> çš„ <code>serverHandle</code> åŠ å…¥è¿›å»ï¼Œè¿™ä¸ª handle ä¼šè‡ªåŠ¨åˆ›å»º <code>grpc</code> æœåŠ¡ç«¯çš„ <code>span</code>ã€‚</p><blockquote><p>å¯¹ trace&#x2F;span æ¦‚å¿µè¿˜æœ‰ä¸äº†è§£çš„æœ‹å‹å¯ä»¥æŸ¥çœ‹è¿™ç¯‡<a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">æ–‡ç« </a>ã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> port = <span class="string">&quot;:50051&quot;</span>  </span><br><span class="line">lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, port)  </span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Fatal().Msgf(<span class="string">&quot;failed to listen: %v&quot;</span>, err)  </span><br><span class="line">&#125;  </span><br><span class="line">s := grpc.NewServer(  </span><br><span class="line">    grpc.StatsHandler(otelgrpc.NewServerHandler()),  </span><br><span class="line">)  </span><br><span class="line">pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)  </span><br><span class="line"><span class="keyword">if</span> err := s.Serve(lis); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Fatal().Msgf(<span class="string">&quot;failed to serve: %v&quot;</span>, err)  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    log.Printf(<span class="string">&quot;served on %s \n&quot;</span>, port)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬åªéœ€è¦å¯åŠ¨è¿™ä¸ª grpc æœåŠ¡å³å¯ï¼Œå°±ç®—å®Œæˆäº† Go æœåŠ¡çš„é›†æˆã€‚</p><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡º Java ç›¸å¯¹äº Go æ¥è¯´ä¼šç®€å•è®¸å¤šï¼Œåªéœ€è¦é…ç½®ä¸€ä¸ª agent å°±å¯ä»¥ä¸è¯¥ä¸€è¡Œä»£ç æ”¯æŒç›®å‰å¸‚é¢ä¸Šæµè¡Œçš„ç»å¤§å¤šæ•°æ¡†æ¶ã€‚<br><img src="https://s2.loli.net/2024/04/17/kMDcrPwxJy4oZYe.png"></p><h1 id="è‡ªå®šä¹‰-span-çš„-attribute"><a href="#è‡ªå®šä¹‰-span-çš„-attribute" class="headerlink" title="è‡ªå®šä¹‰  span çš„ attribute"></a>è‡ªå®šä¹‰  span çš„ attribute</h1><p>æˆ‘ä»¬åœ¨çœ‹é“¾è·¯ä¿¡æ¯çš„æ—¶å€™å…¶å®çœ‹çš„æœ€å¤šçš„æ˜¯æŸä¸ª <code>span</code> é‡Œçš„ <code>attribute</code> æ•°æ®ï¼ˆæœ‰äº›åœ°æ–¹åˆç§°ä¸º <code>tag</code>)<br>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://s2.loli.net/2024/07/15/jrdkNCAZhi6UIvP.png"></p><p>è¿™é‡Œä¼šå±•ç¤ºå½“å‰ <code>span</code> çš„å„ç§ä¿¡æ¯ï¼Œä½†å¦‚æœæˆ‘ä»¬æƒ³è¦é¢å¤–åŠ ä¸€äº›è‡ªå·±å…³å¿ƒçš„æ•°æ®åº”è¯¥å¦‚ä½•æ·»åŠ å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">message HelloRequest &#123;  </span><br><span class="line">  string name = 1;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘ä»¬æƒ³çŸ¥é“è¿™ä¸ª grpc æ¥å£é‡Œçš„ name å‚æ•°ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºé‚£æ ·å±•ç¤ºåœ¨ span ä¸­ã€‚</p><p>å¥½åœ¨ <code>OpenTelemetry</code> å·²ç»è€ƒè™‘åˆ°ç±»ä¼¼çš„éœ€æ±‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">span := trace.SpanFromContext(ctx)  </span><br><span class="line">span.SetAttributes(attribute.String(<span class="string">&quot;request.name&quot;</span>, in.Name))</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ <code>span := trace.SpanFromContext(ctx)</code>  è·å–åˆ°å½“å‰çš„ spanï¼Œç„¶åè°ƒç”¨ <code>SetAttributes</code> å°±å¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„æ•°æ®äº†ã€‚</p><blockquote><p>å¯¹åº”çš„ Java ä¹Ÿæœ‰ç±»ä¼¼çš„å‡½æ•°ã€‚</p></blockquote><p>é™¤äº†æ–°å¢ <code>attribute</code> ä¹‹å¤–è¿˜å¯ä»¥æ–°å¢ Eventï¼ŒLink ç­‰æ•°æ®ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AddEvent adds an event with the provided name and options.  </span></span><br><span class="line">AddEvent(name <span class="type">string</span>, options ...EventOption)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// AddLink adds a link.  </span></span><br><span class="line"><span class="comment">// Adding links at span creation using WithLinks is preferred to calling AddLink  </span></span><br><span class="line"><span class="comment">// later, for contexts that are available during span creation, because head  </span></span><br><span class="line"><span class="comment">// sampling decisions can only consider information present during span creation.  </span></span><br><span class="line">AddLink(link Link)</span><br></pre></td></tr></table></figure><h1 id="è‡ªå®šä¹‰æ–°å¢-span"><a href="#è‡ªå®šä¹‰æ–°å¢-span" class="headerlink" title="è‡ªå®šä¹‰æ–°å¢ span"></a>è‡ªå®šä¹‰æ–°å¢ span</h1><p>åŒç†æˆ‘ä»¬å¯èƒ½ä¸å±€é™äºä¸ºæŸä¸ª span æ–°å¢ attributeï¼Œä¹Ÿæœ‰å¯èƒ½æƒ³è¦æ–°å¢ä¸€ä¸ªæ–°çš„ span æ¥è®°å½•å…³é”®çš„è°ƒç”¨ä¿¡æ¯ã€‚</p><blockquote><p>é»˜è®¤æƒ…å†µä¸‹åªæœ‰ OpenTelemetry å®ç°è¿‡çš„ç»„ä»¶çš„æ ¸å¿ƒå‡½æ•°æ‰ä¼šæœ‰ spanï¼Œè‡ªå·±ä»£ç é‡Œçš„å‡½æ•°è°ƒç”¨æ˜¯ä¸ä¼šåˆ›å»ºspan çš„ã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> span(ctx context.Context) &#123;  </span><br><span class="line">    ctx, span := tracer.Start(ctx, <span class="string">&quot;hello-span&quot;</span>)  </span><br><span class="line">    <span class="keyword">defer</span> span.End()  </span><br><span class="line">    <span class="comment">// do some work  </span></span><br><span class="line">    log.Printf(<span class="string">&quot;create span&quot;</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨  Go ä¸­åªéœ€è¦æ‰‹åŠ¨ Start ä¸€ä¸ª span å³å¯ã€‚</p><p>å¯¹åº”åˆ° <code>Java</code> ç¨å¾®ç®€å•ä¸€äº›ï¼Œåªéœ€è¦ä¸ºå‡½æ•°æ·»åŠ ä¸€ä¸ªæ³¨è§£å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WithSpan(&quot;span&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">span</span><span class="params">(<span class="meta">@SpanAttribute(&quot;request.name&quot;)</span> String name)</span> &#123;  </span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>);  </span><br><span class="line">    log.info(<span class="string">&quot;span:&#123;&#125;&quot;</span>, name);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªä¸è¿‡å¾—å•ç‹¬å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry.instrumentation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-instrumentation-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæˆ‘ä»¬åœ¨ Jaeger UI ä¸Šçœ‹åˆ°çš„æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2024/07/15/1tLlYezQwInZWDX.png"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><img src="https://s2.loli.net/2024/07/15/WXPp1MUkdHo4zam.png"></p><p>æœ€åæ€»ç»“ä¸€ä¸‹ï¼ŒOpenTelemetry æ”¯æŒè®¸å¤šæµè¡Œçš„è¯­è¨€ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šæ˜¯å¦æ”¯æŒè‡ªåŠ¨åŸ‹ç‚¹ã€‚</p><p><img src="https://s2.loli.net/2024/07/15/fvu67rdoxtZkq5m.png"></p><blockquote><p>è¿™é‡Œ Go ä¹Ÿå¯ä»¥é›¶ä»£ç åŸ‹ç‚¹ï¼Œæ˜¯ä½¿ç”¨äº† eBPFï¼Œæœ¬æ–‡æš‚ä¸åšä»‹ç»ã€‚</p></blockquote><p>å¯¹äºæ”¯æŒè‡ªåŠ¨åŸ‹ç‚¹çš„è¯­è¨€å°±å¾ˆç®€å•ï¼Œåªéœ€è¦é…ç½®ä¸‹ agent å³å¯ï¼›è€ŒåŸç”Ÿçš„ Go è¯­è¨€ä¸æ”¯æŒè‡ªåŠ¨åŸ‹ç‚¹å°±å¾—æ‰‹åŠ¨ä½¿ç”¨ OpenTelemetry æä¾›çš„ SDK å¤„ç†ä¸€äº›å…³é”®æ­¥éª¤ï¼›æ€»ä½“æ¥è¯´ä¹Ÿä¸ç®—å¤æ‚ã€‚</p><p>ä¸‹ä¸€æœŸä¼šé‡ç‚¹è®²è§£å¦‚ä½•ä½¿ç”¨ Metricsã€‚</p><p>æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ Go ç›¸å…³çš„æºç ï¼š</p><ul><li><a href="https://github.com/crossoverJie/k8s-combat">https://github.com/crossoverJie/k8s-combat</a></li></ul><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://opentelemetry.io/docs/languages/java/configuration/">https://opentelemetry.io/docs/languages/java/configuration/</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md</a></li><li><a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;ä¹‹å‰å†™è¿‡ä¸€ç¯‡ &lt;a href=&quot;https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/&quot;&gt;ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…&lt;/a&gt;çš„æ–‡ç« ï¼Œä¸»è¦æ˜¯ä»æ¦‚å¿µä¸Šè®²è§£äº† Trace åœ¨ OpenTelemetry çš„ä¸­çš„åœºæ™¯å’Œä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ä¹Ÿå†™è¿‡ä¸€ç¯‡ &lt;a href=&quot;https://crossoverjie.top/2024/05/26/ob/OTel-demo/&quot;&gt;å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯&lt;/a&gt;ï¼šå¦‚ä½•ä»ä¸€ä¸ª demo å¼€å§‹é›†æˆ OpenTelemetryã€‚&lt;/p&gt;
&lt;p&gt;ä½†è¿˜æ˜¯æœ‰ä¸å°‘å°ä¼™ä¼´åé¦ˆè¯´æ— æ³•å¿«é€Ÿä¸Šæ‰‹ï¼ˆå¯èƒ½ä¹Ÿæ˜¯è¿™ä¸ª demo çš„é¡¹ç›®æ¯”è¾ƒå¤šï¼‰ï¼Œäºæ˜¯æˆ‘å‡†å¤‡ä» 0 å¼€å§‹ä»çœŸå®çš„ä»£ç ä¸€æ­¥æ­¥å¸¦å¤§å®¶é›†æˆ &lt;code&gt;OpenTelemetry&lt;/code&gt;ï¼Œå› ä¸º OpenTelemetry æœ¬èº«æ˜¯è·¨å¤šç§è¯­è¨€çš„ï¼Œæ‰€ä»¥ä¹Ÿä¼šä»¥ä¸¤ç§è¯­è¨€ä¸ºï¼ˆJavaã€Golangï¼‰ä¸»è¿›è¡Œè®²è§£ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ä½¿ç”¨è¿™ä¸¤ç§è¯­è¨€ä¸»è¦æ˜¯å› ä¸º Java å‡ ä¹å…¨æ˜¯è‡ªåŠ¨åŸ‹ç‚¹ï¼Œè€Œ Golang å› ä¸ºè¯­è¨€ç‰¹æ€§ï¼Œå¤§éƒ¨åˆ†éƒ½å¾—ç¡¬ç¼–ç åŸ‹ç‚¹ï¼›è¦†ç›–åˆ°è¿™ä¸¤ç§åœºæ™¯åå…¶ä»–è¯­è¨€ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œé¡¶å¤šåªæ˜¯ API åç§°æœ‰äº›è®¸åŒºåˆ«ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿä¼šç©¿æ’ä¸€äº› OpenTelemetry çš„åŸç†ï¼Œå¸Œæœ›æ•´ä¸ªè¿‡ç¨‹ä¸‹æ¥å¤§å®¶å¯ä»¥åœ¨é¡¹ç›®ä¸­å®é™…è¿ç”¨èµ·æ¥ï¼ŒåŒæ—¶ä¹Ÿèƒ½çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£å•å…ƒæµ‹è¯•ï¼šæŠ€å·§ä¸æœ€ä½³å®è·µ</title>
    <link href="http://crossoverjie.top/2024/08/15/ob/unit-test/"/>
    <id>http://crossoverjie.top/2024/08/15/ob/unit-test/</id>
    <published>2024-08-15T02:43:09.000Z</published>
    <updated>2024-08-14T13:55:07.855Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰åˆ†äº«è¿‡å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹å¼€æºé¡¹ç›®ä»¥åŠå¦‚ä½•åœ¨å¼€æºé¡¹ç›®é‡Œåšé›†æˆæµ‹è¯•ï¼Œä½†è¿˜æ²¡æœ‰è®²è¿‡å…·ä½“çš„å®æ“ã€‚</p><p>ä»Šå¤©æ¥è¯¦ç»†è®²è®²å¦‚ä½•å†™å•å…ƒæµ‹è¯•ã€‚</p><h1 id="ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•"><a href="#ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•" class="headerlink" title="ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•"></a>ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•</h1><p>è¿™ä¸ªå¤§å®¶åº”è¯¥æ˜¯æœ‰å…±è¯†çš„ï¼Œå¯¹äºä¸€äº›åŠŸèƒ½å•ä¸€ã€æ ¸å¿ƒé€»è¾‘ã€åŒæ—¶å˜åŒ–ä¸é¢‘ç¹çš„å…¬å¼€å‡½æ•°æ‰æœ‰å¿…è¦åšå•å…ƒæµ‹è¯•ã€‚</p><p>å¯¹äºä¸šåŠ¡å¤æ‚ã€é“¾è·¯ç¹çä½†ä¹Ÿæ˜¯æ ¸å¿ƒæµç¨‹çš„åŠŸèƒ½é€šå¸¸å»ºè®®åš e2e æµ‹è¯•ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æœ€ç»ˆæµ‹è¯•ç»“æœçš„ä¸€è‡´æ€§ã€‚</p><span id="more"></span><h1 id="ğŸ’€å…·ä½“æ¡ˆä¾‹"><a href="#ğŸ’€å…·ä½“æ¡ˆä¾‹" class="headerlink" title="ğŸ’€å…·ä½“æ¡ˆä¾‹"></a>ğŸ’€å…·ä½“æ¡ˆä¾‹</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“å•æµ‹çš„ä¸»è¦ç›®çš„æ˜¯æ¨¡æ‹Ÿæ‰§è¡Œä½ å†™è¿‡çš„æ¯ä¸€è¡Œä»£ç ï¼Œç›®çš„å°±æ˜¯è¦è¦†ç›–åˆ°ä¸»è¦åˆ†æ”¯ï¼Œåšåˆ°è‡ªå·±çš„æ¯ä¸€è¡Œä»£ç éƒ½å¿ƒä¸­æœ‰æ•°ã€‚</p><p>ä¸‹é¢ä»¥ <code>Apache HertzBeat</code> çš„ä¸€äº›å•æµ‹ä¸ºä¾‹ï¼Œè®²è§£å¦‚ä½•ç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•ã€‚</p><p><img src="https://s2.loli.net/2024/07/02/SbqCvHVZk6f5tB1.png"><br>å…ˆä»¥ä¸€ä¸ªæœ€ç®€å•çš„ <code>org.apache.hertzbeat.collector.collect.udp.UdpCollectImpl#preCheck</code> å‡½æ•°æµ‹è¯•ä¸ºä¾‹ã€‚<br>è¿™é‡Œçš„ <code>preCheck</code> å‡½æ•°å°±æ˜¯ç®€å•çš„æ£€æµ‹åšå‚æ•°æ ¡éªŒã€‚<br>æµ‹è¯•æ—¶åªè¦æˆ‘ä»¬æ‰‹åŠ¨å°† <code>metrics</code> è®¾ç½®ä¸º <code>null</code> å°±å¯ä»¥è¿›å…¥è¿™ä¸ª if æ¡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UdpCollectImplTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> UdpCollectImpl udpCollect;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testPreCheck</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; aliasField = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        aliasField.add(<span class="string">&quot;responseTime&quot;</span>);</span><br><span class="line">        <span class="type">Metrics</span> <span class="variable">metrics</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Metrics</span>();</span><br><span class="line">        metrics.setAliasFields(aliasField);</span><br><span class="line">        assertThrows(IllegalArgumentException.class, () -&gt; udpCollect.preCheck(metrics));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><p>æ¥çœ‹å…·ä½“çš„å•æµ‹ä»£ç ï¼Œæˆ‘ä»¬ä¸€è¡Œè¡Œçš„æ¥çœ‹ï¼š</p><p><code>@ExtendWith(MockitoExtension.class)</code> æ˜¯ <code>Junit5</code> æä¾›çš„ä¸€ä¸ªæ³¨è§£ï¼Œé‡Œé¢ä¼ å…¥çš„ <code>MockitoExtension.class</code> æ˜¯æˆ‘ä»¬å•æµ‹ mock å¸¸ç”¨çš„æ¡†æ¶ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯å‘Šè¯‰ <code>Junit5</code> ï¼Œå½“å‰çš„æµ‹è¯•ç±»ä¼šä½¿ç”¨ mockito ä½œä¸ºæ‰©å±•è¿è¡Œï¼Œä»è€Œå¯ä»¥ <code>mock</code> æˆ‘ä»¬è¿è¡Œæ—¶çš„ä¸€äº›å¯¹è±¡ã€‚</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@InjectMocks</span>  </span><br><span class="line"><span class="keyword">private</span> UdpCollectImpl udpCollect;</span><br></pre></td></tr></table></figure><p><code>@InjectMocks</code> ä¹Ÿæ˜¯ <code>mockito</code> è¿™ä¸ªåº“æä¾›çš„æ³¨è§£ï¼Œé€šå¸¸ç”¨äºå£°æ˜éœ€è¦æµ‹è¯•çš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@InjectMocks</span>  </span><br><span class="line"><span class="keyword">private</span> AbstractCollect udpCollect;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/07/02/zSocET9f5y6lqC3.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ³¨è§£å¿…é¡»æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»ï¼Œä¸å¯ä»¥æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»æˆ–è€…æ˜¯æ¥å£ã€‚</p><p>å…¶å®å½“æˆ‘ä»¬äº†è§£äº†ä»–çš„åŸç†å°±èƒ½çŸ¥é“å…·ä½“çš„åŸå› ï¼š<br><img src="https://s2.loli.net/2024/07/02/5DwRyVsBHd1EmpA.png"></p><p>å½“æˆ‘ä»¬ debug è¿è¡Œæ—¶ä¼šå‘ç° <code>udpCollect</code> å¯¹è±¡æ˜¯æœ‰å€¼çš„ï¼Œè€Œå¦‚æœæˆ‘ä»¬å»æ‰è¿™ä¸ªæ³¨è§£ <code>@InjectMocks</code> å†è¿è¡Œå°±ä¼šæŠ›ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p><blockquote><p>å› ä¸ºå¹¶æ²¡æœ‰åˆå§‹åŒ– udpCollect</p></blockquote><p>è€Œä½¿ç”¨ <code>@InjectMocks</code>æ³¨è§£åï¼Œ<code>mockito</code> æ¡†æ¶ä¼šè‡ªåŠ¨ç»™ <code>udpCollect</code> æ³¨å…¥ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼›è€Œå¦‚æœæ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…æ˜¯æŠ½è±¡ç±»ï¼Œmockito æ¡†æ¶æ˜¯æ— æ³•çŸ¥é“åˆ›å»ºå…·ä½“å“ªä¸ªå¯¹è±¡ã€‚</p><p>å½“ç„¶åœ¨è¿™ä¸ªç®€å•åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ç›´æ¥ <code>udpCollect = new UdpCollectImpl()</code> è¿›è¡Œæµ‹è¯•ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><h1 id="ğŸ”¥é…åˆ-jacoco-è¾“å‡ºå•æµ‹è¦†ç›–ç‡"><a href="#ğŸ”¥é…åˆ-jacoco-è¾“å‡ºå•æµ‹è¦†ç›–ç‡" class="headerlink" title="ğŸ”¥é…åˆ jacoco è¾“å‡ºå•æµ‹è¦†ç›–ç‡"></a>ğŸ”¥é…åˆ jacoco è¾“å‡ºå•æµ‹è¦†ç›–ç‡</h1><p><img src="https://s2.loli.net/2024/07/02/fgv3O4RbnHsQTWV.png"><br><img src="https://s2.loli.net/2024/07/02/coXOGkjyE2zKsYa.png"></p><p>åœ¨ IDEA ä¸­æˆ‘ä»¬å¯ä»¥ä»¥ <code>Coverage</code> çš„æ–¹å¼è¿è¡Œï¼Œ<code>IDEA</code> å°±å°†æˆ‘ä»¬çš„å•æµ‹è¦†ç›–æƒ…å†µæ˜¾ç¤ºåœ¨æºä»£ç ä¸­ï¼Œç»¿è‰²çš„éƒ¨åˆ†å°±ä»£è¡¨åœ¨å®é™…åœ¨è¿è¡Œæ—¶æ‰§è¡Œåˆ°çš„åœ°æ–¹ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ <code>maven</code> é¡¹ç›®ä¸­é›†æˆ <code>jacoco</code>ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªæ ¹ç›®å½•çš„ <code>pom.xml</code> ä¸­æ·»åŠ ä¸€ä¸ª <code>plugin</code> å°±å¯ä»¥äº†ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jacoco<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jacoco-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jacoco-maven-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>prepare-agent<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>report<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test<span class="tag">&lt;/<span class="name">phase</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>report<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¹‹åè¿è¡Œ <code>mvn test</code> å°±ä¼šåœ¨ target ç›®å½•ä¸‹ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šäº†ã€‚</p><p><img src="https://s2.loli.net/2024/07/02/GiBrPjtLcXhgDbp.png"></p><p>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨ GitHub çš„ CI ä¸­é›†æˆ <code>Codecov</code>ï¼Œä»–ä¼šç›´æ¥è¯»å– jacoco çš„æµ‹è¯•æ•°æ®ï¼Œå¹¶ä¸”åœ¨ PR çš„è¯„è®ºåŒºåŠ ä¸Šæµ‹è¯•æŠ¥å‘Šã€‚<br><img src="https://s2.loli.net/2024/07/02/ujdGke4gf5mAW3x.png"></p><p><img src="https://s2.loli.net/2024/07/02/nFt5SukAjMPZ96W.png"></p><p><img src="https://s2.loli.net/2024/07/02/KcXJUs3mehxFAYz.png"></p><p>éœ€è¦ä» <code>Codecov</code> é‡Œå°†ä½ é¡¹ç›®çš„ token æ·»åŠ åˆ° repo çš„ ç¯å¢ƒå˜é‡ä¸­å³å¯ã€‚</p><p>å…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ª PRï¼š<a href="https://github.com/apache/hertzbeat/pull/1985">https://github.com/apache/hertzbeat/pull/1985</a></p><h1 id="â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹"><a href="#â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹" class="headerlink" title="â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹"></a>â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹</h1><p>åˆšæ‰å±•ç¤ºçš„æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„åœºæ™¯ï¼Œä¸‹é¢æ¥çœ‹çœ‹ç¨å¾®å¤æ‚çš„ã€‚</p><p>æˆ‘ä»¬ä»¥è¿™ä¸ªå•æµ‹ä¸ºä¾‹ï¼š<br><code>org.apache.hertzbeat.collector.collect.redis.RedisClusterCollectImplTest</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClusterCollectImplTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> RedisCommonCollectImpl redisClusterCollect;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> StatefulRedisClusterConnection&lt;String, String&gt; connection;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> RedisAdvancedClusterCommands&lt;String, String&gt; cmd;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> RedisClusterClient client;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå•æµ‹åœ¨åˆšæ‰çš„åŸºç¡€ä¸Šå¤šäº†ä¸€ä¸ª <code>@Mock</code> çš„æ³¨è§£ã€‚</p><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦æµ‹è¯•çš„ <code>RedisCommonCollectImpl</code> ç±»ä¸­éœ€è¦ä¾èµ– <code>StatefulRedisClusterConnection/RedisAdvancedClusterCommands/RedisClusterClient</code> è¿™å‡ ä¸ªç±»æ‰€æä¾›çš„æœåŠ¡ã€‚</p><p>å•æµ‹çš„æ—¶å€™éœ€è¦ä½¿ç”¨ <code>mockito</code> åˆ›å»ºä¸€ä¸ªä»–ä»¬çš„å¯¹è±¡ï¼Œå¹¶ä¸”æ³¨å…¥åˆ°éœ€è¦è¢«æµ‹è¯•çš„ <code>RedisCommonCollectImpl</code>ç±»ä¸­ã€‚</p><blockquote><p>ä¸ç„¶æˆ‘ä»¬å°±éœ€è¦å‡†å¤‡å•æµ‹æ‰€éœ€è¦çš„èµ„æºï¼Œæ¯”å¦‚å¯ä»¥ä½¿ç”¨çš„ Redisã€MySQL ç­‰ã€‚</p></blockquote><h2 id="ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º"><a href="#ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º" class="headerlink" title="ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º"></a>ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º</h2><p>åªæ˜¯æ³¨å…¥è¿›å»è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ¨¡æ‹Ÿå®ƒçš„è¡Œä¸ºï¼š</p><ul><li>æ¯”å¦‚è°ƒç”¨æŸä¸ªå‡½æ•°å¯ä»¥æ¨¡æ‹Ÿè¿”å›æ•°æ®</li><li>æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨æŠ›å‡ºå¼‚å¸¸</li><li>æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨è€—æ—¶</li></ul><p>è¿™é‡Œä»¥æœ€å¸¸è§çš„æ¨¡æ‹Ÿå‡½æ•°è¿”å›ä¸ºä¾‹ï¼š</p><p><img src="https://s2.loli.net/2024/07/02/3lnFxsQmcWqao5u.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">clusterNodes</span> <span class="operator">=</span> connection.sync().clusterInfo();</span><br></pre></td></tr></table></figure><p>åœ¨æºç é‡Œçœ‹åˆ°ä¼šä½¿ç”¨ connection çš„ <code>clusterInfo()</code> å‡½æ•°è¿”å›é›†ç¾¤ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">clusterKnownNodes</span> <span class="operator">=</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">clusterInfoTemp</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        cluster_slots_fail:0</span></span><br><span class="line"><span class="string">        cluster_known_nodes:%s</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">clusterInfo</span> <span class="operator">=</span> String.format(clusterInfoTemp, clusterKnownNodes);</span><br><span class="line">Mockito.when(cmd.clusterInfo()).thenReturn(clusterInfo);        </span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code>Mockito.when().thenReturn()</code> æ¥æ¨¡æ‹Ÿè¿™ä¸ªå‡½æ•°çš„è¿”å›æ•°æ®ã€‚</p><p>è€Œå…¶ä¸­çš„ <code>cmd</code> è‡ªç„¶ä¹Ÿæ˜¯éœ€è¦æ¨¡æ‹Ÿè¿”å›çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Mockito.mockStatic(RedisClusterClient.class).when(()-&gt;RedisClusterClient.create(Mockito.any(ClientResources.class),</span><br><span class="line">        Mockito.any(RedisURI.class))).thenReturn(client);</span><br><span class="line">Mockito.when(client.connect()).thenReturn(connection);</span><br><span class="line"></span><br><span class="line">Mockito.when(connection.sync()).thenReturn(cmd);</span><br><span class="line">Mockito.when(cmd.info(metrics.getName())).thenReturn(info);</span><br><span class="line">Mockito.when(cmd.clusterInfo()).thenReturn(clusterInfo);</span><br></pre></td></tr></table></figure><p><code>cmd</code> æ˜¯é€šè¿‡ <code>Mockito.when(connection.sync()).thenReturn(cmd);</code>è¿”å›çš„ï¼Œè€Œ <code>connection</code> åˆæ˜¯ä» <code>client.connect()</code> è¿”å›çš„ã€‚</p><p>æœ€ç»ˆå°±åƒæ˜¯å¥—å¨ƒä¸€æ ·ï¼Œ<code>client</code> åœ¨æºç ä¸­æ˜¯é€šè¿‡ä¸€ä¸ªé™æ€å‡½æ•°åˆ›å»ºçš„ã€‚</p><h3 id="âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°"><a href="#âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°" class="headerlink" title="âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°"></a>âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°</h3><p>æˆ‘ä¾ç¨€è®°å¾—åœ¨æˆ‘åˆšæ¥è§¦ <code>mockito</code> çš„ 16ï½17 å¹´é‚£æ®µæ—¶é—´è¿˜ä¸æ”¯æŒæ¨¡æ‹Ÿè°ƒç”¨é™æ€å‡½æ•°ï¼Œä¸è¿‡å¦‚ä»Šå·²ç»æ”¯æŒäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mock</span>  </span><br><span class="line"><span class="keyword">private</span> RedisClusterClient client;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mockito.mockStatic(RedisClusterClient.class).when(()-&gt;RedisClusterClient.create(Mockito.any(ClientResources.class),  </span><br><span class="line">        Mockito.any(RedisURI.class))).thenReturn(client);</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥æ¨¡æ‹Ÿé™æ€å‡½æ•°çš„è¿”å›å€¼äº†ï¼Œä½†å‰ææ˜¯è¿”å›çš„ <code>client</code> éœ€è¦ä½¿ç”¨ <code>@Mock</code> æ³¨è§£ã€‚</p><h3 id="ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°"><a href="#ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°" class="headerlink" title="ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°"></a>ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°</h3><p><img src="https://s2.loli.net/2024/07/02/aFiCLRyYh4IU83o.png"><br>æœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿéœ€è¦æ¨¡æ‹Ÿæ„é€ å‡½æ•°ï¼Œä»è€Œå¯ä»¥æ¨¡æ‹Ÿåç»­è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MockedConstruction&lt;FTPClient&gt; mocked = Mockito.mockConstruction(FTPClient.class,</span><br><span class="line">        (ftpClient, context) -&gt; &#123;</span><br><span class="line">            Mockito.doNothing().when(ftpClient).connect(ftpProtocol.getHost(),</span><br><span class="line">                    Integer.parseInt(ftpProtocol.getPort()));</span><br><span class="line"></span><br><span class="line">            Mockito.doAnswer(invocationOnMock -&gt; <span class="literal">true</span>).when(ftpClient)</span><br><span class="line">                    .login(ftpProtocol.getUsername(), ftpProtocol.getPassword());</span><br><span class="line">            Mockito.when(ftpClient.changeWorkingDirectory(ftpProtocol.getDirection())).thenReturn(isActive);</span><br><span class="line">            Mockito.doNothing().when(ftpClient).disconnect();</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ <code>Mockito.mockConstruction</code> æ¥è¿›è¡Œæ¨¡æ‹Ÿï¼Œè¯¥å¯¹è±¡çš„ä¸€äº›è¡Œä¸ºå°±ç›´æ¥å†™åœ¨è¿™ä¸ªæ¨¡æ‹Ÿå‡½æ•°å†…ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿”å›çš„ <code>mocked</code> å¯¹è±¡éœ€è¦è®°å¾—å…³é—­ã€‚</p><h3 id="ä¸éœ€è¦-Mock"><a href="#ä¸éœ€è¦-Mock" class="headerlink" title="ä¸éœ€è¦ Mock"></a>ä¸éœ€è¦ Mock</h3><p>å½“ç„¶ä¹Ÿä¸æ˜¯æ‰€æœ‰çš„åœºæ™¯éƒ½éœ€è¦ <code>mock</code>ã€‚</p><p>æ¯”å¦‚åˆšæ‰ç¬¬ä¸€ä¸ªåœºæ™¯ï¼Œæ²¡æœ‰ä¾èµ–ä»»ä½•å¤–éƒ¨æœåŠ¡æ—¶å°±ä¸éœ€è¦ <code>mock</code>ã€‚</p><p><img src="https://s2.loli.net/2024/07/02/mW3gxERBc4qoz2L.png"></p><p>ç±»ä¼¼äºè¿™ä¸ª <a href="https://github.com/apache/hertzbeat/pull/2021">PR</a> é‡Œçš„æµ‹è¯•ï¼Œåªæ˜¯ä¾èµ–ä¸€ä¸ªåŸºç¡€çš„å†…å­˜ç¼“å­˜ç»„ä»¶ï¼Œå°±æ²¡å¿…è¦ mockï¼Œä½†å¦‚æœä¾èµ–çš„æ˜¯ <code>Redis</code> ç¼“å­˜ç»„ä»¶è¿˜æ˜¯éœ€è¦ mock çš„ã€‚<br><a href="https://github.com/apache/hertzbeat/pull/2021">https://github.com/apache/hertzbeat/pull/2021</a></p><h3 id="âš™ï¸ä¿®æ”¹æºç "><a href="#âš™ï¸ä¿®æ”¹æºç " class="headerlink" title="âš™ï¸ä¿®æ”¹æºç "></a>âš™ï¸ä¿®æ”¹æºç </h3><p>å¦‚æœæœ‰äº›æµ‹è¯•åœºæ™¯ä¸‹éœ€è¦è·å–å†…éƒ¨å˜é‡æ–¹ä¾¿åç»­çš„æµ‹è¯•ï¼Œä½†æ˜¯è¯¥æµ‹è¯•ç±»ä¹Ÿæ²¡æœ‰æä¾›è·å–å˜é‡çš„å‡½æ•°ï¼Œæˆ‘ä»¬å°±åªæœ‰ä¿®æ”¹æºç æ¥é…åˆæµ‹è¯•äº†ã€‚</p><p>æ¯”å¦‚è¿™ä¸ª <a href="https://github.com/apache/hertzbeat/pull/">PR</a>ï¼š<br><img src="https://s2.loli.net/2024/07/02/bxfQgsymWVcnawE.png"></p><p>å½“ç„¶å¦‚æœåªæ˜¯ç»™æµ‹è¯•ç¯å¢ƒä¸‹ä½¿ç”¨çš„å‡½æ•°æˆ–å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸Š <code>@VisibleForTesting</code>æ³¨è§£æ ‡æ˜ä¸€ä¸‹ï¼Œè¿™ä¸ªæ³¨è§£æ²¡æœ‰å…¶ä»–ä½œç”¨ï¼Œå¯ä»¥è®©åç»­çš„ç»´æŠ¤è€…æ›´æ¸…æ¥šçš„çŸ¥é“è¿™æ˜¯åšä»€ä¹ˆç”¨çš„ã€‚</p><h1 id="ğŸ“ˆé›†æˆæµ‹è¯•"><a href="#ğŸ“ˆé›†æˆæµ‹è¯•" class="headerlink" title="ğŸ“ˆé›†æˆæµ‹è¯•"></a>ğŸ“ˆé›†æˆæµ‹è¯•</h1><p>å•å…ƒæµ‹è¯•åªèƒ½æµ‹è¯•ä¸€äº›åŠŸèƒ½å•ä¸€çš„å‡½æ•°ï¼Œè¦ä¿è¯æ•´ä¸ªè½¯ä»¶çš„è´¨é‡ä»…ä¾èµ–å•æµ‹æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é›†æˆæµ‹è¯•ã€‚</p><p>é€šå¸¸æ˜¯éœ€è¦å¯¹å¤–æä¾›æœåŠ¡çš„å¼€æºé¡¹ç›®éƒ½éœ€è¦é›†æˆæµ‹è¯•ï¼š</p><ul><li>Pulsar</li><li>Kafka</li><li>Dubbo ç­‰</li></ul><p>ä»¥æˆ‘æ¥è§¦åˆ°çš„æœåŠ¡å‹åº”ç”¨ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ä¸ªæ˜¯ Java åº”ç”¨ä¸€ä¸ªæ˜¯ Golang åº”ç”¨ã€‚</p><h1 id="ğŸ³Golang"><a href="#ğŸ³Golang" class="headerlink" title="ğŸ³Golang"></a>ğŸ³Golang</h1><p><img src="https://s2.loli.net/2024/07/11/vZISu9Qg3foKhsU.png"></p><p><code>Golang</code> å› ä¸ºå·¥å…·é“¾æ²¡æœ‰ Java é‚£ä¹ˆå¼ºå¤§ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†çš„é›†æˆæµ‹è¯•çš„åŠŸèƒ½éƒ½æ˜¯é€šè¿‡ç¼–å†™ Makefile å’Œ shell è„šæœ¬å®ç°çš„ã€‚</p><p>è¿˜æ˜¯ä»¥æˆ‘ç†Ÿæ‚‰çš„ Pulsar çš„ <code>go-client</code> ä¸ºä¾‹ï¼Œå®ƒåœ¨ GitHub çš„é›†æˆæµ‹è¯•æ˜¯é€šè¿‡ GitHub action è§¦å‘çš„ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/05/20/f2196pujo8m7KRe.png"><br>æœ€ç»ˆè°ƒç”¨çš„æ˜¯ Makefile ä¸­çš„ test å‘½ä»¤ï¼Œå¹¶ä¸”æŠŠéœ€è¦æµ‹è¯•çš„ Golang ç‰ˆæœ¬ä¼ å…¥è¿›å»ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/YpwtSHnLXqU1xQj.png"></p><p><code>Dockerfile</code>ï¼š<br><img src="https://s2.loli.net/2024/05/20/1ySGWF46U7EC2rk.png"></p><p>è¿™ä¸ªé•œåƒç®€å•æ¥è¯´å°±æ˜¯å°† Pulsar çš„é•œåƒä½œä¸ºåŸºç¡€è¿è¡Œé•œåƒï¼ˆè¿™é‡Œé¢åŒ…å«äº† Pulsar çš„æœåŠ¡ç«¯ï¼‰ï¼Œç„¶åå°†è¿™ä¸ª pulsar-client-go çš„ä»£ç å¤åˆ¶è¿›å»ç¼–è¯‘ã€‚</p><p>æ¥ç€è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /pulsar/pulsar-client-go &amp;&amp; ./scripts/run-ci.sh</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯æµ‹è¯•è„šæœ¬ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/2Afmdu8ozRvH9FC.png"></p><p>æµ‹è¯•è„šæœ¬çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼š</p><ul><li>å¯åŠ¨ pulsar æœåŠ¡ç«¯</li><li>è¿è¡Œæµ‹è¯•ä»£ç <br>å› ä¸ºæ‰€æœ‰çš„æµ‹è¯•ä»£ç é‡Œè¿æ¥æœåŠ¡ç«¯çš„åœ°å€éƒ½æ˜¯ <code>localhost</code>ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿æ¥ã€‚<br><img src="https://s2.loli.net/2024/05/20/C1RHxTkuz25Mlj8.png"></li></ul><p>é€šè¿‡è¿™é‡Œçš„ <a href="https://github.com/apache/pulsar-client-go/actions/runs/9014510238/job/24768797555">action</a> æ—¥å¿—å¯ä»¥è·Ÿè¸ªæ‰€æœ‰çš„è¿è¡Œæƒ…å†µã€‚</p><h1 id="â˜•Java"><a href="#â˜•Java" class="headerlink" title="â˜•Java"></a>â˜•Java</h1><p><img src="https://s2.loli.net/2024/07/11/KlqzSwJ6f895A4n.png"></p><p>Java å› ä¸ºå·¥å…·é“¾å¼ºå¤§ï¼Œæ‰€ä»¥é›†æˆæµ‹è¯•å‡ ä¹ä¸éœ€è¦ç”¨ Makefile å’Œè„šæœ¬é…åˆæ‰§è¡Œã€‚</p><p>è¿˜æ˜¯ä»¥ Pulsar ä¸ºä¾‹ï¼Œå®ƒçš„é›†æˆæµ‹è¯•æ˜¯éœ€è¦æ¨¡æ‹Ÿåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼ˆå› ä¸º Pulsar çš„æœåŠ¡ç«¯æºç å’Œæµ‹è¯•ä»£ç éƒ½æ˜¯ Java å†™çš„ï¼Œæ›´æ–¹ä¾¿åšæµ‹è¯•ï¼‰ï¼Œç„¶åå†è¿è¡Œæµ‹è¯•ä»£ç ã€‚</p><blockquote><p>è¿™ä¸ªçš„å¥½å¤„æ˜¯ä»»ä½•ä¸€ä¸ªå•æµ‹éƒ½å¯ä»¥åœ¨æœ¬åœ°ç›´æ¥è¿è¡Œï¼Œè€Œ  Go çš„ä»£ç è¿˜éœ€è¦å…ˆåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œæµ‹è¯•èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚</p></blockquote><p>æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Œæˆ‘ä»¥å…¶ä¸­ä¸€ä¸ª <a href="https://github.com/apache/pulsar/blob/631b13ad23d7e48c6e82d38f97c23d129062cb7c/pulsar-broker/src/test/java/org/apache/pulsar/client/impl/BrokerClientIntegrationTest.java#L117">BrokerClientIntegrationTest</a>ä¸ºä¾‹ï¼š<br><img src="https://s2.loli.net/2024/05/20/9PbioA3RQLMBy6J.png"><br><img src="https://s2.loli.net/2024/05/20/blKePdxTUIkgRD3.png"><br>ä¼šåœ¨å•æµ‹å¯åŠ¨çš„æ—¶å€™å…ˆå¯åŠ¨æœåŠ¡ç«¯ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/gzY3lyTGuEDUwZF.png"></p><p>æœ€ç»ˆä¼šè°ƒç”¨ <code>PulsarTestContext</code> çš„ <code>build</code> å‡½æ•°å¯åŠ¨ <code>broker</code>ï¼ˆæœåŠ¡ç«¯ï¼‰ï¼Œè€Œæ‰§è¡Œå•æµ‹ä¹Ÿåªéœ€è¦ä½¿ç”¨ <code>mvn test</code> å°±å¯ä»¥è‡ªåŠ¨è§¦å‘è¿™äº›å•å…ƒæµ‹è¯•ã€‚<br><img src="https://s2.loli.net/2024/05/20/N15amZihWI73Qyw.png"><br>åªæ˜¯æ¯ä¸€ä¸ªå•æµ‹éƒ½éœ€è¦å¯åœæœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¦æŠŠ Pulsar çš„æ‰€æœ‰å•æµ‹è·‘å®Œé€šå¸¸éœ€è¦ 1ï½2 ä¸ªå°æ—¶ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯æ—¥å¸¸ç¼–å†™å•æµ‹å¯èƒ½ä¼šç¢°åˆ°çš„åœºæ™¯ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰åˆ†äº«è¿‡å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹å¼€æºé¡¹ç›®ä»¥åŠå¦‚ä½•åœ¨å¼€æºé¡¹ç›®é‡Œåšé›†æˆæµ‹è¯•ï¼Œä½†è¿˜æ²¡æœ‰è®²è¿‡å…·ä½“çš„å®æ“ã€‚&lt;/p&gt;
&lt;p&gt;ä»Šå¤©æ¥è¯¦ç»†è®²è®²å¦‚ä½•å†™å•å…ƒæµ‹è¯•ã€‚&lt;/p&gt;
&lt;h1 id=&quot;ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&quot;&gt;&lt;a href=&quot;#ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&quot; class=&quot;headerlink&quot; title=&quot;ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&quot;&gt;&lt;/a&gt;ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&lt;/h1&gt;&lt;p&gt;è¿™ä¸ªå¤§å®¶åº”è¯¥æ˜¯æœ‰å…±è¯†çš„ï¼Œå¯¹äºä¸€äº›åŠŸèƒ½å•ä¸€ã€æ ¸å¿ƒé€»è¾‘ã€åŒæ—¶å˜åŒ–ä¸é¢‘ç¹çš„å…¬å¼€å‡½æ•°æ‰æœ‰å¿…è¦åšå•å…ƒæµ‹è¯•ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºä¸šåŠ¡å¤æ‚ã€é“¾è·¯ç¹çä½†ä¹Ÿæ˜¯æ ¸å¿ƒæµç¨‹çš„åŠŸèƒ½é€šå¸¸å»ºè®®åš e2e æµ‹è¯•ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æœ€ç»ˆæµ‹è¯•ç»“æœçš„ä¸€è‡´æ€§ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="å•æµ‹" scheme="http://crossoverjie.top/tags/%E5%8D%95%E6%B5%8B/"/>
    
  </entry>
  
  <entry>
    <title>Pulsarå‡çº§è‡ªåŠ¨åŒ–ï¼šä¸€é”®æå®šé›†ç¾¤å‡çº§ä¸æµ‹è¯•</title>
    <link href="http://crossoverjie.top/2024/08/06/ob/Pulsar%20test%20framework/"/>
    <id>http://crossoverjie.top/2024/08/06/ob/Pulsar%20test%20framework/</id>
    <published>2024-08-06T03:15:50.000Z</published>
    <updated>2024-08-06T02:22:27.446Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2024/07/01/xZSMlpJPWTRGkge.png"></p><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ç”±äºæˆ‘åœ¨å…¬å¸å†…éƒ¨è´Ÿè´£ç»´æŠ¤ <code>Pulsar</code>ï¼Œéœ€è¦æ—¶ä¸æ—¶çš„å‡çº§ <code>Pulsar</code> ç‰ˆæœ¬ä»è€Œå’Œç¤¾åŒºä¿æŒä¸€è‡´ã€‚</p><p>è€Œæ¯æ¬¡å‡çº§è¿‡ç¨‹éƒ½éœ€è¦åšç›¸åŒçš„æ­¥éª¤ï¼š</p><ul><li>å®‰è£…ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„é›†ç¾¤</li><li>è§¦å‘åŠŸèƒ½æ€§æµ‹è¯•</li><li>è§¦å‘æ€§èƒ½æµ‹è¯•</li><li>æŸ¥çœ‹ç›‘æ§æ˜¯å¦æ­£å¸¸<ul><li>åº”ç”¨æœ‰æ— å¼‚å¸¸æ—¥å¿—</li><li>æµé‡æ˜¯å¦æ­£å¸¸</li><li>å„ä¸ªç»„ä»¶çš„å†…å­˜å ç”¨æ˜¯å¦æ­£å¸¸</li><li>å†™å…¥å»¶è¿Ÿæ˜¯å¦æ­£å¸¸</li></ul></li></ul><span id="more"></span><h1 id="å‘½ä»¤è¡Œå·¥å…·"><a href="#å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="å‘½ä»¤è¡Œå·¥å…·"></a>å‘½ä»¤è¡Œå·¥å…·</h1><p>ä»¥ä¸Šçš„æµç¨‹æ­¥éª¤æœ€å¥½æ˜¯å…¨éƒ¨ä¸€é”®å®Œæˆï¼Œæˆ‘ä»¬åªéœ€è¦äººå·¥æ£€æµ‹ä¸‹ç›‘æ§æ˜¯å¦æ­£å¸¸å³å¯ã€‚</p><p>äºæ˜¯æˆ‘ä¾¿å†™äº†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/07/01/cmXCqk6nyj2DpZA.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pulsar-upgrade-cli -h                                                                                                  ok | at 10:33:18 </span><br><span class="line">A cli app for upgrading Pulsar</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  pulsar-upgrade-cli [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  completion  Generate the autocompletion script for the specified shell</span><br><span class="line">  help        Help about any command</span><br><span class="line">  install     install a target version</span><br><span class="line">  scale       scale statefulSet of the cluster</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --burst-limit int                 client-side default throttling limit (default 100)</span><br><span class="line">      --debug                           enable verbose output</span><br><span class="line">  -h, --help                            help for pulsar-upgrade-cli</span><br><span class="line">      --kube-apiserver string           the address and the port for the Kubernetes API server</span><br><span class="line">      --kube-as-group stringArray       group to impersonate for the operation, this flag can be repeated to specify multiple groups.</span><br><span class="line">      --kube-as-user string             username to impersonate for the operation</span><br></pre></td></tr></table></figure><p>çœŸå®ä½¿ç”¨çš„ <code>example</code> å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pulsar-upgrade-cli install \                                                   </span><br><span class="line">        --values ./charts/pulsar/values.yaml \</span><br><span class="line">        --set namespace=pulsar-test \</span><br><span class="line">        --set initialize=true \</span><br><span class="line">        --debug \</span><br><span class="line">        --test-case-schema=http \</span><br><span class="line">        --test-case-host=127.0.0.1 \</span><br><span class="line">        --test-case-port=9999 \</span><br><span class="line">    pulsar-test ./charts/pulsar -n pulsar-test</span><br></pre></td></tr></table></figure><p>å®ƒçš„å®‰è£…å‘½ä»¤éå¸¸ç±»ä¼¼äº <code>helm</code>ï¼Œä¹Ÿæ˜¯ç›´æ¥ä½¿ç”¨ helm çš„ <code>value.yaml</code> è¿›è¡Œå®‰è£…ï¼›åªæ˜¯åœ¨å®‰è£…æˆåŠŸåï¼ˆç­‰å¾…æ‰€æœ‰çš„ Pod éƒ½å¤„äº Running çŠ¶æ€ï¼‰ä¼šå†è§¦å‘ test-case æµ‹è¯•ï¼Œä¹Ÿå°±æ˜¯è¯·æ±‚ä¸€ä¸ª endpointã€‚</p><blockquote><p>è¿™ä¸ª endpoint ä¼šåœ¨å†…éƒ¨å¤„ç†æ‰€æœ‰çš„åŠŸèƒ½æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ï¼Œå…·ä½“ç»†èŠ‚å°±åœ¨åæ–‡åˆ†æã€‚</p></blockquote><p>åŒæ—¶è¿˜æä¾›äº†ä¸€ä¸ª scaleï¼ˆæ‰©ã€ç¼©å®¹ï¼‰ å‘½ä»¤ï¼Œå¯ä»¥ç”¨ä¿®æ”¹é›†ç¾¤è§„æ¨¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼©å®¹é›†ç¾¤è§„æ¨¡ä¸º0</span></span><br><span class="line">./pulsar-upgrade-cli scale --replicase 0 -n pulsar-test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼©å®¹ä¸ºæœ€å°é›†ç¾¤</span></span><br><span class="line">./pulsar-upgrade-cli scale --replicase 1 -n pulsar-test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¢å¤ä¸ºæœ€æ»¡é›†ç¾¤</span></span><br><span class="line">./pulsar-upgrade-cli scale --replicase 2 -n pulsar-test</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªéœ€æ±‚æ˜¯å› ä¸ºæˆ‘ä»¬çš„ <code>Pulsar</code> æµ‹è¯•é›†ç¾¤éƒ¨ç½²åœ¨äº†ä¸€ä¸ª <code>servless</code> çš„ <code>kubernetes</code> é›†ç¾¤é‡Œï¼Œå®ƒæ˜¯æŒ‰ç…§ä½¿ç”¨é‡æ”¶è´¹çš„ï¼Œæ‰€ä»¥åœ¨æˆ‘ä¸éœ€è¦çš„ä½¿ç”¨çš„æ—¶å€™å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤å°†æ‰€æœ‰çš„å‰¯æœ¬æ•°é‡ä¿®æ”¹ä¸º 0ï¼Œä»è€Œå‡å°‘ä½¿ç”¨æˆæœ¬ã€‚</p><p>å½“åªéœ€è¦åšç®€å•çš„åŠŸèƒ½æµ‹è¯•æ—¶ä¾¿å›å°†é›†ç¾¤ä¿®æ”¹ä¸ºæœ€å°é›†ç¾¤ï¼Œå°†å‰¯æœ¬æ•°ä¿®æ”¹ä¸ºåªå¯ä»¥æä¾›æœåŠ¡å³å¯ã€‚</p><p>è€Œå½“éœ€è¦åšæ€§èƒ½æµ‹è¯•æ—¶å°±éœ€è¦å°†é›†ç¾¤ä¿®æ”¹ä¸ºæœ€é«˜é…ç½®ã€‚</p><p>è¿™æ ·å¯ä»¥é¿å…æ¯æ¬¡éƒ½å®‰è£…æ–°é›†ç¾¤ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æœ‰æ•ˆçš„å‡å°‘æµ‹è¯•æˆæœ¬ã€‚</p><h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">require (  </span><br><span class="line">    github.com/spf13/cobra v1<span class="number">.6</span><span class="number">.1</span>  </span><br><span class="line">    github.com/spf13/pflag v1<span class="number">.0</span><span class="number">.5</span>   </span><br><span class="line">    helm.sh/helm/v3 v3<span class="number">.10</span><span class="number">.2</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤è¡Œå·¥å…·æœ¬è´¨ä¸Šæ˜¯å‚è€ƒäº† helm çš„å‘½ä»¤è¡Œå®ç°çš„ï¼Œæ‰€æœ‰ä¸»è¦ä¹Ÿæ˜¯ä¾èµ–äº† <code>helm</code> å’Œ <code>cobra</code>ã€‚</p><p><img src="https://s2.loli.net/2024/07/01/rouTSUBDIWciElx.png"><br>ä¸‹é¢ä»¥æœ€ä¸»è¦çš„å®‰è£…å‘½ä»¤ä¸ºä¾‹ï¼Œæ ¸å¿ƒçš„æ˜¯ä»¥ä¸‹çš„æ­¥éª¤ï¼š</p><ul><li>æ‰§è¡Œ <code>helm</code> å®‰è£…ï¼ˆè¿™é‡Œæ˜¯ç›´æ¥ä½¿ç”¨çš„ helm çš„æºç é€»è¾‘è¿›è¡Œå®‰è£…ï¼‰</li><li>ç­‰å¾…æ‰€æœ‰çš„ <code>Pod</code> æˆåŠŸè¿è¡Œ</li><li>è§¦å‘ <code>test-case</code> æ‰§è¡Œ</li><li>ç­‰å¾…æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå®Œæ¯•</li><li>æ£€æµ‹æ˜¯å¦éœ€è¦å¸è½½å®‰è£…çš„é›†ç¾¤</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *installEvent)</span></span> FinishInstall(cfg *action.Configuration, name <span class="type">string</span>) <span class="type">error</span> &#123;  </span><br><span class="line">    bar.Increment()  </span><br><span class="line">    bar.Finish()  </span><br><span class="line">  </span><br><span class="line">    clientSet, err := cfg.KubernetesClientSet()  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">    ctx := context.Background()  </span><br><span class="line">    ip, err := GetServiceExternalIp(ctx, clientSet, settings.Namespace(), fmt.Sprintf(<span class="string">&quot;%s-proxy&quot;</span>, name))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    token, err := GetPulsarProxyToken(ctx, clientSet, settings.Namespace(), fmt.Sprintf(<span class="string">&quot;%s-token-proxy-admin&quot;</span>, name))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// trigger testcase  </span></span><br><span class="line">    err = e.client.Trigger(context.Background(), ip, token)  </span><br><span class="line">    <span class="keyword">return</span> err  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>FinishInstall</code> éœ€è¦è·å–åˆ°æ–°å®‰è£…çš„ Pulsar é›†ç¾¤çš„ proxy IP åœ°å€å’Œé‰´æƒæ‰€ä½¿ç”¨çš„ <code>token</code>(<code>GetServiceExternalIp()</code>&#x2F;<code>GetPulsarProxyToken()</code>)ã€‚</p><p>å°†è¿™ä¸¤ä¸ªå‚æ•°ä¼ é€’ç»™ <code>test-case</code> æ‰å¯ä»¥æ„å»ºå‡º <code>pulsar-client</code>.</p><p>è¿™ä¸ªå‘½ä»¤çš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯å®‰è£…é›†ç¾¤å’Œè§¦å‘æµ‹è¯•ï¼Œä»¥åŠä¸€äº›é›†ç¾¤çš„åŸºæœ¬è¿ç»´èƒ½åŠ›ã€‚</p><h1 id="æµ‹è¯•æ¡†æ¶"><a href="#æµ‹è¯•æ¡†æ¶" class="headerlink" title="æµ‹è¯•æ¡†æ¶"></a>æµ‹è¯•æ¡†æ¶</h1><p>è€Œå…³äºè¿™é‡Œçš„æµ‹è¯•ç”¨ä¾‹ä¹Ÿæœ‰ä¸€äº›å°ä¼™ä¼´å’¨è¯¢è¿‡ï¼Œå¦‚ä½•å¯¹ Pulsar è¿›è¡ŒåŠŸèƒ½æµ‹è¯•ã€‚</p><p>å…¶å® Pulsar æºç ä¸­å·²ç»åŒ…å«äº†å‡ ä¹æ‰€æœ‰æˆ‘ä»¬ä¼šä½¿ç”¨åˆ°çš„æµ‹è¯•ä»£ç ï¼Œç†è®ºä¸Šåªè¦æ–°ç‰ˆæœ¬çš„å®˜æ–¹é•œåƒå·²ç»æ¨é€äº†é‚£å°±æ˜¯è·‘äº†æ‰€æœ‰çš„å•æµ‹ï¼Œè´¨é‡æ˜¯å¯ä»¥ä¿è¯çš„ã€‚</p><p>é‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦åšåŠŸèƒ½æµ‹è¯•å‘¢ï¼Ÿ</p><p>å…¶å®å¾ˆå¾ˆç®€å•ï¼Œ<code>Pulsar</code> è¿™ç±»åŸºç¡€ç»„ä»¶å®˜æ–¹éƒ½æœ‰æä¾›åŸºå‡†æµ‹è¯•ï¼Œä½†æˆ‘ä»¬æƒ³è¦ç”¨äºç”Ÿäº§ç¯å¢ƒä¾ç„¶éœ€è¦è‡ªå·±åšå‹æµ‹å¾—å‡ºä¸€ä»½å±äºè‡ªå·±ç¯å¢ƒä¸‹çš„æ€§èƒ½æµ‹è¯•æŠ¥å‘Šï¼›</p><p>æ ¹æœ¬ç›®çš„æ˜¯è¦çœ‹åœ¨è‡ªå·±çš„ä¸šåŠ¡åœºæ™¯ä¸‹æ˜¯å¦å¯ä»¥æ»¡è¶³ï¼ˆåŒ…æ‹¬å…¬å¸çš„è½¯ç¡¬ä»¶ï¼Œä¸åŒçš„ä¸šåŠ¡ä»£ç ï¼‰ã€‚</p><p>æ‰€ä»¥è¿™é‡Œçš„åŠŸèƒ½æµ‹è¯•ä»£ç æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å‰æå°±æ˜¯ï¼š<strong>éœ€è¦ä½¿ç”¨çœŸå®çš„ä¸šåŠ¡ä»£ç è¿›è¡Œæµ‹è¯•</strong>ã€‚</p><p>ä¹Ÿå°±æ˜¯ä¸šåŠ¡åœ¨çº¿ä¸Šä½¿ç”¨ä¸ Pulsar ç›¸å…³çš„ä»£ç éœ€è¦å‚è€ƒåŠŸèƒ½æµ‹è¯•é‡Œçš„ä»£ç å®ç°ï¼Œä¸ç„¶æœ‰äº›é—®é¢˜å°±æ— æ³•åœ¨æµ‹è¯•ç¯èŠ‚è¦†ç›–åˆ°ã€‚</p><blockquote><p>è¿™é‡Œæˆ‘å°±è¸©è¿‡å‘ï¼Œå› ä¸ºåœ¨åŠŸèƒ½æµ‹è¯•é‡Œç”¨çš„æ˜¯å®˜æ–¹çš„ example ä»£ç è¿›è¡Œæµ‹è¯•çš„ï¼Œè‡ªç„¶æ˜¯æ²¡æœ‰é—®é¢˜ï¼›ä½†ä¸šåŠ¡åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œä½¿ç”¨åˆ°äº†ä¸€ä¸ª Schema çš„åœºæ™¯ï¼Œå¹¶æ²¡æœ‰åœ¨åŠŸèƒ½æµ‹è¯•é‡Œè¦†ç›–åˆ°ï¼ˆå®˜æ–¹çš„æµ‹è¯•ç”¨ä¾‹é‡Œä¹Ÿæ²¡æœ‰ğŸ˜‚ï¼‰ï¼Œå°±å¯¼è‡´å‡çº§åˆ°æŸä¸ªç‰ˆæœ¬åä¸šåŠ¡åŠŸèƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼ˆè™½ç„¶ç”¨æ³•ç¡®å®æ˜¯æœ‰é—®é¢˜ï¼‰ï¼Œä½†åº”è¯¥åœ¨æˆ‘æµ‹è¯•é˜¶æ®µå°±æš´éœ²å‡ºæ¥ã€‚</p></blockquote><h2 id="å®ç°åŸç†-1"><a href="#å®ç°åŸç†-1" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p><img src="https://s2.loli.net/2024/07/01/3vZiGABjkYh5LUJ.png"><br>ä»¥ä¸Šæ˜¯ä¸€ä¸ªé›†ç¾¤çš„åŠŸèƒ½æµ‹è¯•æŠ¥å‘Šï¼Œè¿™é‡Œæˆ‘åªæœ‰ 8 ä¸ªæµ‹è¯•åœºæ™¯ï¼ˆç»“åˆå®é™…ä¸šåŠ¡ä½¿ç”¨ï¼‰ï¼Œè€ƒè™‘åˆ°æœªæ¥å¯èƒ½ä¼šæœ‰æ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæ‰€ä»¥åœ¨è®¾è®¡è¿™ä¸ªæµ‹è¯•æ¡†æ¶æ—¶å°±å¾—è€ƒè™‘åˆ°æ‰©å±•æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AbstractJobDefine</span> <span class="variable">job5</span> <span class="operator">=</span>  </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">FailoverConsumerTest</span>(event, <span class="string">&quot;æ•…éšœè½¬ç§»æ¶ˆè´¹æµ‹è¯•&quot;</span>, pulsarClient, <span class="number">20</span>, admin);  </span><br><span class="line">CompletableFuture&lt;Void&gt; c5 = CompletableFuture.runAsync(job5::start, EXECUTOR);  </span><br><span class="line"><span class="type">AbstractJobDefine</span> <span class="variable">job6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchemaTest</span>(event,<span class="string">&quot;schemaæµ‹è¯•&quot;</span>,pulsarClient,<span class="number">20</span>,prestoService);  </span><br><span class="line">CompletableFuture&lt;Void&gt; c6 = CompletableFuture.runAsync(job6::start, EXECUTOR);  </span><br><span class="line"><span class="type">AbstractJobDefine</span> <span class="variable">job7</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VlogsTest</span>(event,<span class="string">&quot;vlogs test&quot;</span>,pulsarClient,<span class="number">20</span>, vlogsUrl);  </span><br><span class="line">CompletableFuture&lt;Void&gt; c7 = CompletableFuture.runAsync(job7::start, EXECUTOR);  </span><br><span class="line">  </span><br><span class="line">CompletableFuture&lt;Void&gt; all = CompletableFuture.allOf(c1, c2, c3, c4, c5, c6, c7);  </span><br><span class="line">all.whenComplete((___, __) -&gt; &#123;  </span><br><span class="line">    event.finishAll();  </span><br><span class="line">    pulsarClient.closeAsync();  </span><br><span class="line">    admin.close();  </span><br><span class="line">&#125;).get();</span><br></pre></td></tr></table></figure><p>å¯¹å¤–æä¾›çš„ trigger æ¥å£å°±ä¸è´´ä»£ç äº†ï¼Œé‡ç‚¹å°±æ˜¯åœ¨è¿™é‡Œæ„å»ºæµ‹è¯•ä»»åŠ¡ï¼Œç„¶åç­‰å¾…ä»–ä»¬å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractJobDefine</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Event event;</span><br><span class="line">    <span class="keyword">private</span> String jobName;</span><br><span class="line">    <span class="keyword">private</span> PulsarClient pulsarClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> timeout;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PulsarAdmin admin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbstractJobDefine</span><span class="params">(Event event, String jobName, PulsarClient pulsarClient, <span class="type">int</span> timeout, PulsarAdmin admin)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.event = event;</span><br><span class="line">        <span class="built_in">this</span>.jobName = jobName;</span><br><span class="line">        <span class="built_in">this</span>.pulsarClient = pulsarClient;</span><br><span class="line">        <span class="built_in">this</span>.timeout = timeout;</span><br><span class="line">        <span class="built_in">this</span>.admin = admin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        event.addJob();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">                <span class="type">StopWatch</span> <span class="variable">watch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    watch.start(jobName);</span><br><span class="line">                    run(pulsarClient, admin);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    event.oneException(<span class="built_in">this</span>, e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    watch.stop();</span><br><span class="line">                    event.finishOne(jobName, StrUtil.format(<span class="string">&quot;cost: &#123;&#125;s&quot;</span>, watch.getTotalTimeSeconds()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, TestCase.EXECUTOR).get(timeout, TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            event.oneException(<span class="built_in">this</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** run busy code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pulsarClient pulsar client</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> admin pulsar admin client</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception e</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(PulsarClient pulsarClient, PulsarAdmin admin)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒä»£ç å°±æ˜¯è¿™ä¸ªæŠ½è±¡çš„ä»»åŠ¡å®šä¹‰ç±»ï¼Œå…¶ä¸­çš„ start å‡½æ•°ç”¨äºå®šä¹‰ä»»åŠ¡æ‰§è¡Œçš„æ¨¡ç‰ˆï¼š</p><ul><li>æ·»åŠ ä»»åŠ¡ï¼šå…·ä½“å®ç°æ˜¯ä»»åŠ¡è®¡æ•°å™¨+1</li><li>å¼€å§‹è®¡æ—¶</li><li>æ‰§è¡ŒæŠ½è¡€çš„ run å‡½æ•°ï¼Œå…·ä½“å®ç°äº¤ç»™å­ç±»</li><li>å¼‚å¸¸æ—¶è®°å½•äº‹ä»¶</li><li>æ­£å¸¸æ‰§è¡Œå®Œæ¯•åä¹Ÿè®°å½•äº‹ä»¶</li></ul><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸ªæ™®é€šç”¨ä¾‹çš„å®ç°æƒ…å†µï¼š<br><img src="https://s2.loli.net/2024/07/01/rdU5mPbfOJxv4TL.png"></p><p>å°±æ˜¯é‡å†™äº† <code>run()</code> å‡½æ•°ï¼Œç„¶ååœ¨å…¶ä¸­å®ç°å…·ä½“çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæ–­è¨€æµ‹è¯•ç»“æœã€‚</p><p>è¿™æ ·å½“æˆ‘ä»¬éœ€è¦å†æ·»åŠ ç”¨ä¾‹çš„æ—¶å€™åªéœ€è¦å†æ–°å¢ä¸€ä¸ªå­ç±»å®ç°å³å¯ã€‚</p><p>åŒæ—¶è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªäº‹ä»¶æ¥å£ï¼Œç”¨äºå¤„ç†ä¸€äº›å…³é”®çš„èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Event</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * æ–°å¢ä¸€ä¸ªä»»åŠ¡  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addJob</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** è·å–è¿è¡Œä¸­çš„ä»»åŠ¡æ•°é‡  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è·å–è¿è¡Œä¸­çš„ä»»åŠ¡æ•°é‡  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    TestCaseRuntimeResponse <span class="title function_">getRuntime</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * å•ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•  </span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobName    ä»»åŠ¡åç§°  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> finishCost ä»»åŠ¡å®Œæˆè€—æ—¶  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">finishOne</span><span class="params">(String jobName, String finishCost)</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**å•ä¸ªä»»åŠ¡æ‰§è¡Œå¼‚å¸¸  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobDefine ä»»åŠ¡  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e å¼‚å¸¸  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">oneException</span><span class="params">(AbstractJobDefine jobDefine, Exception e)</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">finishAll</span><span class="params">()</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>getRuntime</code> æ¥å£æ˜¯ç”¨äºåœ¨ cli é‚£è¾¹æŸ¥è¯¢ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæ¯•çš„æ¥å£ï¼Œåªæœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰èƒ½é€€å‡º <code>cli</code>ã€‚</p><h1 id="ç›‘æ§æŒ‡æ ‡"><a href="#ç›‘æ§æŒ‡æ ‡" class="headerlink" title="ç›‘æ§æŒ‡æ ‡"></a>ç›‘æ§æŒ‡æ ‡</h1><p>å½“è¿™äº›ä»»åŠ¡è¿è¡Œå®Œæ¯•åæˆ‘ä»¬éœ€è¦é‡ç‚¹æŸ¥çœ‹åº”ç”¨å®¢æˆ·ç«¯å’Œ Pulsar broker ç«¯æ˜¯å¦æœ‰å¼‚å¸¸æ—¥å¿—ã€‚</p><p>åŒæ—¶è¿˜éœ€è¦è§‚å¯Ÿä¸€äº›å…³é”®çš„ç›‘æ§é¢æ¿ï¼š</p><p><img src="https://s2.loli.net/2024/07/01/sGxOjRWnScPl5oZ.png"><br><img src="https://s2.loli.net/2024/07/01/E6hcSxHrRmNVFoi.png"><br><img src="https://s2.loli.net/2024/07/01/UeFZ73yRbpkAsEH.png"></p><p>åŒ…å«ä½†ä¸é™äºï¼š</p><ul><li>æ¶ˆæ¯ååé‡</li><li><code>broker</code> å†™å…¥å»¶è¿Ÿ</li><li><code>Bookkeeper</code> çš„å†™å…¥ã€è¯»å–æˆåŠŸç‡ï¼Œä»¥åŠå»¶è¿Ÿã€‚</li></ul><p>å½“ç„¶è¿˜æœ‰ <code>zookeeper</code> çš„è¿è¡Œæƒ…å†µä¹Ÿéœ€è¦ç›‘æ§ï¼Œé™äºç¯‡å¹…å°±ä¸ä¸€ä¸€ç²˜è´´äº†ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯æµ‹è¯•æ•´ä¸ª Pulsar é›†ç¾¤çš„æµç¨‹ï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹ã€‚</p><p>æ¯”å¦‚ä½¿ç”¨å‘½ä»¤è¡Œè¿˜æ˜¯æœ‰äº›ä¸ä¾¿ï¼Œåç»­å¯èƒ½ä¼šåˆ‡æ¢åˆ°ç½‘é¡µä¸Šå°±å¯ä»¥æ“ä½œã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/07/01/xZSMlpJPWTRGkge.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;ç”±äºæˆ‘åœ¨å…¬å¸å†…éƒ¨è´Ÿè´£ç»´æŠ¤ &lt;code&gt;Pulsar&lt;/code&gt;ï¼Œéœ€è¦æ—¶ä¸æ—¶çš„å‡çº§ &lt;code&gt;Pulsar&lt;/code&gt; ç‰ˆæœ¬ä»è€Œå’Œç¤¾åŒºä¿æŒä¸€è‡´ã€‚&lt;/p&gt;
&lt;p&gt;è€Œæ¯æ¬¡å‡çº§è¿‡ç¨‹éƒ½éœ€è¦åšç›¸åŒçš„æ­¥éª¤ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®‰è£…ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„é›†ç¾¤&lt;/li&gt;
&lt;li&gt;è§¦å‘åŠŸèƒ½æ€§æµ‹è¯•&lt;/li&gt;
&lt;li&gt;è§¦å‘æ€§èƒ½æµ‹è¯•&lt;/li&gt;
&lt;li&gt;æŸ¥çœ‹ç›‘æ§æ˜¯å¦æ­£å¸¸&lt;ul&gt;
&lt;li&gt;åº”ç”¨æœ‰æ— å¼‚å¸¸æ—¥å¿—&lt;/li&gt;
&lt;li&gt;æµé‡æ˜¯å¦æ­£å¸¸&lt;/li&gt;
&lt;li&gt;å„ä¸ªç»„ä»¶çš„å†…å­˜å ç”¨æ˜¯å¦æ­£å¸¸&lt;/li&gt;
&lt;li&gt;å†™å…¥å»¶è¿Ÿæ˜¯å¦æ­£å¸¸&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/tags/Pulsar/"/>
    
  </entry>
  
  <entry>
    <title>Pulsarå®¢æˆ·ç«¯æ¶ˆè´¹æ¨¡å¼æ­ç§˜ï¼šGo è¯­è¨€å®ç° ZeroQueueConsumer</title>
    <link href="http://crossoverjie.top/2024/07/29/ob/pulsar-client-zero-consumer/"/>
    <id>http://crossoverjie.top/2024/07/29/ob/pulsar-client-zero-consumer/</id>
    <published>2024-07-29T14:31:57.000Z</published>
    <updated>2024-07-29T03:08:42.394Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ®µæ—¶é—´åœ¨ <a href="https://github.com/apache/pulsar-client-go">pulsar-client-go</a> ç¤¾åŒºé‡Œçœ‹åˆ°è¿™ä¹ˆä¸€ä¸ª <a href="https://github.com/apache/pulsar-client-go/issues/1223">issue</a>ï¼š<br><img src="https://s2.loli.net/2024/06/24/KNsvV7jeZYSaiPq.png"></p><span id="more"></span><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/apache/pulsar-client-go/pulsar&quot;</span></span><br><span class="line"></span><br><span class="line">client, err := pulsar.NewClient(pulsar.ClientOptions&#123;</span><br><span class="line">    URL: <span class="string">&quot;pulsar://localhost:6650&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">consumer, err := client.Subscribe(pulsar.ConsumerOptions&#123;</span><br><span class="line">    Topic:             <span class="string">&quot;persistent://public/default/mq-topic-1&quot;</span>,</span><br><span class="line">    SubscriptionName:  <span class="string">&quot;sub-1&quot;</span>,</span><br><span class="line">    Type:              pulsar.Shared,</span><br><span class="line">    ReceiverQueueSize: <span class="number">0</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°äºç­‰äº 0 æ—¶ä¼šè®¾ç½®ä¸º 1000</span></span><br><span class="line"><span class="keyword">const</span> (  </span><br><span class="line">    defaultReceiverQueueSize = <span class="number">1000</span>  </span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> options.ReceiverQueueSize &lt;= <span class="number">0</span> &#123;  </span><br><span class="line">    options.ReceiverQueueSize = defaultReceiverQueueSize  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»–å‘ç°æ‰‹åŠ¨å°† pulsar-client-go å®¢æˆ·ç«¯çš„ <code>ReceiverQueueSize</code> è®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯åœ¨åˆå§‹åŒ–æ—¶ä¼šå†å°†å…¶è°ƒæ•´ä¸º 1000.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> options.ReceiverQueueSize &lt; <span class="number">0</span> &#123;  </span><br><span class="line">    options.ReceiverQueueSize = defaultReceiverQueueSize  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œå¦‚æœæ‰‹åŠ¨å°†æºç ä¿®æ”¹ä¸ºå¯ä»¥è®¾ç½®ä¸º 0 æ—¶ï¼Œå´ä¸èƒ½æ­£å¸¸æ¶ˆè´¹ï¼Œæ¶ˆè´¹è€…ä¼šä¸€ç›´å¤„äº waiting çŠ¶æ€ï¼Œè·å–ä¸åˆ°ä»»ä½•æ•°æ®ã€‚</p><p>ç»è¿‡æˆ‘çš„æ’æŸ¥å‘ç°æ˜¯ Pulsar çš„  Go  å®¢æˆ·ç«¯ç¼ºå°‘äº†ä¸€ä¸ª <a href="https://github.com/apache/pulsar/blob/83b86abcb74595d7e8aa31b238a7dbb19a04dde2/pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerImpl.java#L268-L272">ZeroQueueConsumerImpl</a>çš„å®ç°ç±»ï¼Œè¿™ä¸ªç±»ä¸»è¦ç”¨äºå¯ä»¥ç²¾ç»†æ§åˆ¶æ¶ˆè´¹é€»è¾‘ã€‚</p><blockquote><p>If youâ€™d like to have tight control over message dispatching across consumers, set the <strong>consumersâ€™Â receiver queueÂ size very low (potentially even to 0 if necessary)</strong>. Each consumer has a receiver queue that determines how many messages the consumer attempts to fetch at a time. For example, a receiver queue of 1000 (the default) means that the consumer attempts to process 1000 messages from the topicâ€™s backlogÂ uponÂ connection. Setting the receiver queue to 0 essentiallyÂ means ensuring that each consumer is only doing one thing at a time.</p></blockquote><p><a href="https://pulsar.apache.org/docs/next/cookbooks-message-queue/#client-configuration-changes">https://pulsar.apache.org/docs/next/cookbooks-message-queue/#client-configuration-changes</a></p><p>æ­£å¦‚å®˜æ–¹æ–‡æ¡£é‡Œæåˆ°çš„é‚£æ ·ï¼Œå¯ä»¥å°† ReceiverQueueSize è®¾ç½®ä¸º 0ï¼›è¿™æ ·æ¶ˆè´¹è€…å°±å¯ä»¥ä¸€æ¡æ¡çš„æ¶ˆè´¹æ•°æ®ï¼Œè€Œä¸ä¼šå°†æ¶ˆæ¯å †ç§¯åœ¨å®¢æˆ·ç«¯é˜Ÿåˆ—é‡Œã€‚</p><h1 id="å®¢æˆ·ç«¯æ¶ˆè´¹é€»è¾‘"><a href="#å®¢æˆ·ç«¯æ¶ˆè´¹é€»è¾‘" class="headerlink" title="å®¢æˆ·ç«¯æ¶ˆè´¹é€»è¾‘"></a>å®¢æˆ·ç«¯æ¶ˆè´¹é€»è¾‘</h1><p>å€Ÿæ­¤æœºä¼šéœ€è¦å†å›é¡¾ä¸‹ pulsar å®¢æˆ·ç«¯çš„æ¶ˆè´¹é€»è¾‘ï¼Œè¿™æ ·æ‰èƒ½ç†è§£ <code>ReceiverQueueSize</code> çš„ä½œç”¨ä»¥åŠå¦‚ä½•åœ¨ pulsar-client-go å¦‚ä½•å®ç°è¿™ä¸ª <code>ZeroQueueConsumerImpl</code>ã€‚</p><p>Pulsar å®¢æˆ·ç«¯çš„æ¶ˆè´¹æ¨¡å¼æ˜¯åŸºäºæ¨æ‹‰ç»“åˆçš„ï¼š</p><p><img src="https://s2.loli.net/2024/06/24/bTP1WGVJUR9wzYe.png"><br>å¦‚è¿™å¼ å›¾æ‰€æè¿°çš„æµç¨‹ï¼Œæ¶ˆè´¹è€…åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šä¸»åŠ¨å‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ª Flow çš„å‘½ä»¤ï¼Œå‘Šè¯‰æœåŠ¡ç«¯éœ€è¦ä¸‹å‘å¤šå°‘æ¡æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ã€‚</p><p>åŒæ—¶ä¼šä½¿ç”¨åˆšæ‰çš„é‚£ä¸ª <code>ReceiverQueueSize</code>å‚æ•°ä½œä¸ºå†…éƒ¨é˜Ÿåˆ—çš„å¤§å°ï¼Œå°†å®¢æˆ·ç«¯ä¸‹å‘çš„æ¶ˆæ¯å­˜å‚¨åœ¨å†…éƒ¨é˜Ÿåˆ—é‡Œã€‚</p><p>ç„¶ååœ¨è°ƒç”¨ <code>receive</code> å‡½æ•°çš„æ—¶å€™ä¼šç›´æ¥ä»è¿™ä¸ªé˜Ÿåˆ—é‡Œè·å–æ•°æ®ã€‚</p><p><img src="https://s2.loli.net/2024/06/24/e3AabLk4FqB8VTo.png"><br><img src="https://s2.loli.net/2024/06/24/ZGHiaXBJfEyxh5d.png"></p><p>æ¯æ¬¡æ¶ˆè´¹æˆåŠŸåéƒ½ä¼šå°†å†…éƒ¨çš„ä¸€ä¸ª <code>AvailablePermit+1</code>ï¼Œç›´åˆ°å¤§äº <code>MaxReceiveQueueSize / 2</code> å°±ä¼šå†æ¬¡å‘ broker å‘é€ flow å‘½ä»¤ï¼Œå‘Šè¯‰ broker å†æ¬¡ä¸‹å‘æ¶ˆæ¯ã€‚</p><p>æ‰€ä»¥è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆå…³é”®çš„äº‹ä»¶ï¼šå°±æ˜¯å‘ broker å‘é€ <code>flow</code> å‘½ä»¤ï¼Œè¿™æ ·æ‰ä¼šæœ‰æ–°çš„æ¶ˆæ¯ä¸‹å‘ç»™å®¢æˆ·ç«¯ã€‚</p><p>ä¹‹å‰ç»å¸¸éƒ½ä¼šæœ‰ç ”å‘åŒå­¦è®©æˆ‘æ’æŸ¥æ— æ³•æ¶ˆè´¹çš„é—®é¢˜ï¼Œæœ€ç»ˆå®šä½åˆ°çš„åŸå› å‡ ä¹éƒ½æ˜¯æ¶ˆè´¹ç¼“æ…¢ï¼Œå¯¼è‡´è¿™é‡Œçš„ <code>AvailablePermit</code> æ²¡æœ‰å¢é•¿ï¼Œä»è€Œä¹Ÿå°±ä¸ä¼šè§¦å‘ broker ç»™å®¢æˆ·ç«¯æ¨é€æ–°çš„æ¶ˆæ¯ã€‚</p><p>çœ‹åˆ°çš„ç°è±¡å°±æ˜¯æ¶ˆè´¹éå¸¸ç¼“æ…¢ã€‚</p><h1 id="ZeroQueueConsumerImpl-åŸç†"><a href="#ZeroQueueConsumerImpl-åŸç†" class="headerlink" title="ZeroQueueConsumerImpl åŸç†"></a>ZeroQueueConsumerImpl åŸç†</h1><p>ä¸‹é¢æ¥çœ‹çœ‹ <code>ZeroQueueConsumerImpl</code> æ˜¯å¦‚ä½•å®ç°é˜Ÿåˆ—å¤§å°ä¸º 0 ä¾ç„¶æ˜¯å¯ä»¥æ¶ˆè´¹çš„ã€‚</p><p><img src="https://s2.loli.net/2024/06/24/Vmk9l2nucP31bNX.png"><br>åœ¨æ„å»º consumer çš„æ—¶å€™ï¼Œå°±ä¼šæ ¹æ®é˜Ÿåˆ—å¤§å°ä»è€Œæ¥åˆ›å»ºæ™®é€šæ¶ˆè´¹è€…è¿˜æ˜¯ <code>ZeroQueueConsumerImpl</code> æ¶ˆè´¹è€…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">protected</span> CompletableFuture&lt;Message&lt;T&gt;&gt; <span class="title function_">internalReceiveAsync</span><span class="params">()</span> &#123;  </span><br><span class="line">    CompletableFuture&lt;Message&lt;T&gt;&gt; future = <span class="built_in">super</span>.internalReceiveAsync();  </span><br><span class="line">    <span class="keyword">if</span> (!future.isDone()) &#123;  </span><br><span class="line">        <span class="comment">// We expect the message to be not in the queue yet  </span></span><br><span class="line">        increaseAvailablePermits(cnx());  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> future;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ <code>ZeroQueueConsumerImpl</code> é‡å†™çš„ä¸€ä¸ªæ¶ˆè´¹å‡½æ•°ï¼Œå…¶ä¸­å…³é”®çš„å°±æ˜¯ <code>increaseAvailablePermits(cnx());</code>.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">increaseAvailablePermits</span><span class="params">(ClientCnx currentCnx)</span> &#123;</span><br><span class="line">    increaseAvailablePermits(currentCnx, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">increaseAvailablePermits</span><span class="params">(ClientCnx currentCnx, <span class="type">int</span> delta)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">available</span> <span class="operator">=</span> AVAILABLE_PERMITS_UPDATER.addAndGet(<span class="built_in">this</span>, delta);</span><br><span class="line">    <span class="keyword">while</span> (available &gt;= getCurrentReceiverQueueSize() / <span class="number">2</span> &amp;&amp; !paused) &#123;</span><br><span class="line">        <span class="keyword">if</span> (AVAILABLE_PERMITS_UPDATER.compareAndSet(<span class="built_in">this</span>, available, <span class="number">0</span>)) &#123;</span><br><span class="line">            sendFlowPermitsToBroker(currentCnx, available);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            available = AVAILABLE_PERMITS_UPDATER.get(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æºç é‡Œå¯ä»¥å¾—çŸ¥è¿™é‡Œçš„é€»è¾‘å°±æ˜¯å°† AvailablePermit è‡ªå¢ï¼Œè¾¾åˆ°é˜ˆå€¼åè¯·æ±‚ broker ä¸‹å‘æ¶ˆæ¯ã€‚</p><p>å› ä¸ºåœ¨ <code>ZeroQueueConsumerImpl</code> ä¸­é˜Ÿåˆ—å¤§å°ä¸º 0ï¼Œæ‰€ä»¥ <code>available &gt;= getCurrentReceiverQueueSize() / 2</code>æ°¸è¿œéƒ½ä¼šä¸º trueã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´æ¯æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯éƒ½ä¼šè¯·æ±‚ broker è®©å®ƒå†ä¸‹å‘ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†æ¯ä¸€æ¡æ¶ˆæ¯éƒ½ç²¾ç¡®æ§åˆ¶çš„æ•ˆæœã€‚</p><h1 id="pulsar-client-go-ä¸­çš„å®ç°"><a href="#pulsar-client-go-ä¸­çš„å®ç°" class="headerlink" title="pulsar-client-go ä¸­çš„å®ç°"></a>pulsar-client-go ä¸­çš„å®ç°</h1><p>ä¸ºäº†åœ¨ pulsar-client-go å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘æäº¤äº†ä¸€ä¸ª <a href="https://github.com/apache/pulsar-client-go/pull/1225">PR</a> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>å…¶å®ä»ä¸Šé¢çš„åˆ†æå·²ç»å¾—çŸ¥ä¸ºå•¥æ‰‹åŠ¨å°† <code>ReceiverQueueSize</code> è®¾ç½®ä¸º 0 æ— æ³•æ¶ˆè´¹æ¶ˆæ¯äº†ã€‚</p><p>æ ¹æœ¬åŸå› è¿˜æ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼˜äºé˜Ÿåˆ—ä¸º 0ï¼Œå¯¼è‡´ä¸ä¼šç»™ broker å‘é€ flow å‘½ä»¤ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰æ¶ˆæ¯æ¨é€åˆ°å®¢æˆ·ç«¯ï¼Œä¹Ÿå°±æ— æ³•æ¶ˆè´¹åˆ°æ•°æ®äº†ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬ä¾ç„¶å¾—å‚è€ƒ Java çš„ <code>ZeroQueueConsumerImpl</code> åœ¨æ¯æ¬¡æ¶ˆè´¹çš„æ—¶å€™éƒ½æ‰‹åŠ¨å¢åŠ   <code>availablePermits</code>ã€‚</p><p>ä¸ºæ­¤æˆ‘ä¹Ÿæ–°å¢äº†ä¸€ä¸ªæ¶ˆè´¹è€… <code>zeroQueueConsumer</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EnableZeroQueueConsumer, if enabled, the ReceiverQueueSize will be 0.  </span></span><br><span class="line"><span class="comment">// Notice: only non-partitioned topic is supported.  </span></span><br><span class="line"><span class="comment">// Default is false.  </span></span><br><span class="line">EnableZeroQueueConsumer <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">consumer, err := client.Subscribe(ConsumerOptions&#123;  </span><br><span class="line">    Topic:                   topicName,  </span><br><span class="line">    SubscriptionName:        <span class="string">&quot;sub-1&quot;</span>,  </span><br><span class="line">    Type:                    Shared,  </span><br><span class="line">    NackRedeliveryDelay:     <span class="number">1</span> * time.Second,  </span><br><span class="line">    EnableZeroQueueConsumer: <span class="literal">true</span>,  </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> options.EnableZeroQueueConsumer &#123;  </span><br><span class="line">    options.ReceiverQueueSize = <span class="number">0</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆ›å»ºæ¶ˆè´¹è€…çš„æ—¶å€™éœ€è¦æŒ‡å®šæ˜¯å¦å¼€å¯ <code>ZeroQueueConsumer</code>ï¼Œå½“å¼€å¯åä¼šæ‰‹åŠ¨å°† ReceiverQueueSize è®¾ç½®ä¸º 0.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ä»¥è®¾ç½®é»˜è®¤å€¼ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">receiverQueueSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨ Go ä¸­æ— æ³•åƒ Java é‚£æ ·åœ¨ç»“æ„ä½“åˆå§‹åŒ–åŒ–çš„æ—¶å€™å°±æŒ‡å®šé»˜è®¤å€¼ï¼Œå†åŠ ä¸Š Go çš„ int ç±»å‹å…·å¤‡é›¶å€¼ï¼ˆä¹Ÿå°±æ˜¯0ï¼‰ï¼Œæ‰€ä»¥æ— æ³•åŒºåˆ†å‡º ReceiverQueueSize&#x3D;0 æ˜¯ç”¨æˆ·ä¸»åŠ¨è®¾ç½®çš„ï¼Œè¿˜æ˜¯æ²¡æœ‰ä¼ å…¥è¿™ä¸ªå‚æ•°ä½¿ç”¨çš„é›¶å€¼ã€‚</p></blockquote><p>æ‰€ä»¥æ‰éœ€è¦æ–°å¢ä¸€ä¸ªå‚æ•°æ¥æ‰‹åŠ¨åŒºåˆ†æ˜¯å¦ä½¿ç”¨ <code>ZeroQueueConsumer</code>ã€‚</p><p><img src="https://s2.loli.net/2024/06/24/TK2fJVEFlnL4dIy.png"><br>ä¹‹ååœ¨åˆ›å»º <code>consumer</code> çš„æ—¶å€™è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰ä½¿ç”¨çš„æ˜¯å•åˆ†åŒºçš„ <code>topic</code> å¹¶ä¸”å¼€å¯äº† <code>EnableZeroQueueConsumer</code> æ‰èƒ½åˆ›å»º  <code>zeroQueueConsumer</code>ã€‚</p><hr><p><img src="https://s2.loli.net/2024/06/24/Aq5onPKOjIgserx.png"></p><blockquote><p>ä½¿ç”¨ PARTITIONED_METADATA å‘½ä»¤å¯ä»¥è®© broker è¿”å›åˆ†åŒºæ•°é‡ã€‚</p></blockquote><hr><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(z *zeroQueueConsumer)</span></span> Receive(ctx context.Context) (Message, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> state := z.pc.getConsumerState(); state == consumerClosed || state == consumerClosing &#123;</span><br><span class="line">z.log.WithField(<span class="string">&quot;state&quot;</span>, state).Error(<span class="string">&quot;Failed to ack by closing or closed consumer&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;consumer state is closed&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">z.Lock()</span><br><span class="line"><span class="keyword">defer</span> z.Unlock()</span><br><span class="line">z.pc.availablePermits.inc()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-z.closeCh:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, newError(ConsumerClosed, <span class="string">&quot;consumer closed&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> cm, ok := &lt;-z.messageCh:</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, newError(ConsumerClosed, <span class="string">&quot;consumer closed&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> cm.Message, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, ctx.Err()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„å…³é”®ä»£ç ï¼š<code>z.pc.availablePermits.inc()</code></p><p>æ¶ˆè´¹æ—¶çš„é€»è¾‘å…¶å®å’Œ Java çš„ <code>ZeroQueueConsumerImpl</code> é€»è¾‘ä¿æŒäº†ä¸€è‡´ï¼Œä¹Ÿæ˜¯æ¯æ¶ˆè´¹ä¸€æ¡æ•°æ®ä¹‹å‰å°±å¢åŠ ä¸€æ¬¡ <code>availablePermits</code>ã€‚</p><p>pulsar-client-go çš„è¿è¡ŒåŸç†ä¸ Java å®¢æˆ·ç«¯çš„ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å°†æ¶ˆæ¯å­˜æ”¾åœ¨äº†ä¸€ä¸ªå†…éƒ¨é˜Ÿåˆ—é‡Œï¼Œæ‰€ä»¥æ¯æ¬¡æ¶ˆè´¹æ¶ˆæ¯åªéœ€è¦ä»è¿™ä¸ªé˜Ÿåˆ— <code>messageCh</code> é‡Œè·å–å³å¯ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ pulsar-client-go ç‰ˆæœ¬çš„ <code>zeroQueueConsumer</code> å°±ä¸æ”¯æŒç›´æ¥è¯»å–å†…éƒ¨çš„é˜Ÿåˆ—äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(z *zeroQueueConsumer)</span></span> Chan() &lt;-<span class="keyword">chan</span> ConsumerMessage &#123;  </span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">&quot;zeroQueueConsumer cannot support Chan method&quot;</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šç›´æ¥ panicï¼Œå› ä¸ºç›´æ¥æ¶ˆè´¹ channel åœ¨å®¢æˆ·ç«¯å±‚é¢å°±æ²¡æ³•å¸®ç”¨æˆ·ä¸»åŠ¨å‘é€ flow å‘½ä»¤äº†ï¼Œæ‰€ä»¥è¿™ä¸ªåŠŸèƒ½å°±åªèƒ½å±è”½æ‰äº†ï¼Œåªå¯ä»¥ä¸»åŠ¨çš„ <code>receive</code> æ¶ˆæ¯ã€‚</p><p><img src="https://s2.loli.net/2024/06/24/dDlr3RWM6iYHFbc.png"></p><p>è®¸ä¹…ä¹‹å‰æˆ‘ä¹Ÿç”»è¿‡ä¸€ä¸ªå…³äº pulsar client çš„æ¶ˆè´¹æµç¨‹å›¾ï¼Œåç»­è€ƒè™‘ä¼šå†å†™ä¸€ç¯‡å…³äº pulsar client çš„åŸç†åˆ†ææ–‡ç« ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/apache/pulsar-client-go/issues/1223">https://github.com/apache/pulsar-client-go/issues/1223</a></li><li><a href="https://cloud.tencent.com/developer/article/2307608">https://cloud.tencent.com/developer/article/2307608</a></li><li><a href="https://pulsar.apache.org/docs/next/cookbooks-message-queue/#client-configuration-changes">https://pulsar.apache.org/docs/next/cookbooks-message-queue/#client-configuration-changes</a></li><li><a href="https://github.com/apache/pulsar-client-go/pull/1225">https://github.com/apache/pulsar-client-go/pull/1225</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰æ®µæ—¶é—´åœ¨ &lt;a href=&quot;https://github.com/apache/pulsar-client-go&quot;&gt;pulsar-client-go&lt;/a&gt; ç¤¾åŒºé‡Œçœ‹åˆ°è¿™ä¹ˆä¸€ä¸ª &lt;a href=&quot;https://github.com/apache/pulsar-client-go/issues/1223&quot;&gt;issue&lt;/a&gt;ï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/06/24/KNsvV7jeZYSaiPq.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="Pulsar" scheme="http://crossoverjie.top/categories/OB/Pulsar/"/>
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/tags/Pulsar/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ç›‘æ§ Nginx</title>
    <link href="http://crossoverjie.top/2024/07/23/ob/how-to-monitoring-nginx/"/>
    <id>http://crossoverjie.top/2024/07/23/ob/how-to-monitoring-nginx/</id>
    <published>2024-07-23T02:46:30.000Z</published>
    <updated>2024-07-23T03:18:06.688Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ®µæ—¶é—´æ¥åˆ°ä¸€ä¸ªéœ€æ±‚ï¼Œå¸Œæœ›å¯ä»¥ç›‘æ§ Nginx çš„è¿è¡ŒçŠ¶æ€ã€‚</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ Nginx ä½œä¸ºä¸€ä¸ªæµè¡Œçš„ Web æœåŠ¡å™¨æä¾›äº†å¤šç§èƒ½åŠ›ï¼ŒåŒ…æ‹¬åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ï¼›ä¹Ÿæ”¯æŒäº†è®¸å¤šåè®®ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>gRPC</li><li>http</li><li>WebSocket ç­‰<br>ä½œä¸ºä¸€ä¸ªæµé‡å…¥å£çš„ä¸­é—´ä»¶ï¼Œå¯¹å…¶çš„ç›‘æ§å°±æ˜¾å¾—è‡³å…³é‡è¦äº†ã€‚</li></ul><span id="more"></span><p>å¸‚é¢ä¸Šä¹Ÿæœ‰ä¸€äº›ç°æˆçš„äº§å“å¯ä»¥ç›‘æ§ Nginxï¼Œæ¯”å¦‚çŸ¥åçš„ç›‘æ§æœåŠ¡å•† <code>datadog</code> ä¹Ÿæä¾›äº† Nginx çš„ç›‘æ§ã€‚</p><p><img src="https://s2.loli.net/2024/06/21/BEjyS4ZQHKCrPqx.png"></p><p>ä½†æ˜¯æˆ‘è¿™æ˜¯ä¸€ä¸ªå†…ç½‘æœåŠ¡ï¼Œå¹¶ä¸èƒ½ä½¿ç”¨è¿™äº›å¤–éƒ¨çš„äº‘å‚å•†ï¼Œæ‰€æœ‰å°±åªèƒ½åœ¨å†…éƒ¨æ­å»º Nginx çš„ç›‘æ§æœåŠ¡äº†ã€‚</p><p>ä¸è¿‡ Nginx é»˜è®¤æƒ…å†µä¸‹å¹¶æ²¡æœ‰æä¾› <code>/metrics</code> çš„ endpointï¼Œä½†å¥½åœ¨å®ƒæä¾›äº†ä¸€ä¸ªé¢å¤–çš„æ¨¡å—ï¼š<code>stub_status</code> å¯ä»¥ç”¨äºè·å–ç›‘æ§æ•°æ®ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">  <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line">  <span class="string">server_name</span> <span class="string">_;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">location</span> <span class="string">/status</span> &#123;</span><br><span class="line">    <span class="string">stub_status</span> <span class="string">on;</span></span><br><span class="line">    <span class="string">access_log</span> <span class="string">off;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">      <span class="string">root</span> <span class="string">/usr/share/nginx/html;</span></span><br><span class="line">      <span class="string">index</span> <span class="string">index.html</span> <span class="string">index.htm;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/06/21/ZRIPyN2UxXuiCdE.png"><br>è¿™æ ·è®¿é—® <code>http://127.0.0.1:80/status</code> å°±å¯ä»¥æ‹¿åˆ°ä¸€äº›åŸºæœ¬çš„è¿è¡Œæ•°æ®ã€‚</p><p>ä½†è¿™ä¸ªæ ¼å¼æ˜æ˜¾ä¸æ˜¯ Prometheus æ‰€æ”¯æŒçš„ metrics æ ¼å¼ï¼Œæ— æ³•ç›´æ¥å°†æ•°æ®é‡‡é›†åˆ° Prometheus ä¸­ç„¶åé€šè¿‡ Grafana è¿›è¡ŒæŸ¥çœ‹ã€‚</p><p>æ‰€ä»¥è¿˜å¾—éœ€è¦ä¸€ä¸ªä¸­é—´å±‚æ¥å°†è¿™äº›æ•°æ®è½¬æ¢ä¸º Prometheus å¯ä»¥æ¥æ”¶çš„ metrics æ•°æ®ã€‚</p><h1 id="nginx-prometheus-exporter"><a href="#nginx-prometheus-exporter" class="headerlink" title="nginx-prometheus-exporter"></a>nginx-prometheus-exporter</h1><p>å¥½åœ¨ç¤¾åŒºå·²ç»æä¾›äº†ç±»ä¼¼çš„å·¥å…·ï¼š<a href="https://github.com/nginxinc/nginx-prometheus-exporter">nginx-prometheus-exporter</a> å®ƒè¯»å–åˆšæ‰ status endpoint æ‰€æš´éœ²çš„æ•°æ®ï¼Œç„¶åè½¬æ¢ä¸º Prometheus æ ¼å¼ï¼Œå¹¶å¯¹å¤–æä¾›äº†ä¸€ä¸ª <code>/metrics</code> çš„ endpoint ä¾› Prometheus æ¥é‡‡é›†ã€‚</p><h2 id="è½¬æ¢æ•°æ®"><a href="#è½¬æ¢æ•°æ®" class="headerlink" title="è½¬æ¢æ•°æ®"></a>è½¬æ¢æ•°æ®</h2><p>æˆ‘ä»¬åœ¨å¯åŠ¨è¿™ä¸ª <code>nginx-exporter</code> æ—¶éœ€è¦ä¼ å…¥åˆšæ‰ <code>Nginx</code> æš´éœ²çš„ <code>/status</code> endpointã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 9113:9113 nginx/nginx-prometheus-exporter:1.1.0 --nginx.scrape-uri=http://&lt;nginx&gt;:8080/stub_status</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> templateMetrics <span class="type">string</span> = <span class="string">`Active connections: %d</span></span><br><span class="line"><span class="string">server accepts handled requests</span></span><br><span class="line"><span class="string">%d %d %d</span></span><br><span class="line"><span class="string">Reading: %d Writing: %d Waiting: %d</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å– Nginx status æ•°æ®</span></span><br><span class="line">body, err := io.ReadAll(resp.Body)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to read the response body: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r := bytes.NewReader(body)</span><br><span class="line">stats, err := parseStubStats(r)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to parse response body %q: %w&quot;</span>, <span class="type">string</span>(body), err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£æ Nginx status æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseStubStats</span><span class="params">(r io.Reader)</span></span> (*StubStats, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> s StubStats</span><br><span class="line"><span class="keyword">if</span> _, err := fmt.Fscanf(r, templateMetrics,</span><br><span class="line">&amp;s.Connections.Active,</span><br><span class="line">&amp;s.Connections.Accepted,</span><br><span class="line">&amp;s.Connections.Handled,</span><br><span class="line">&amp;s.Requests,</span><br><span class="line">&amp;s.Connections.Reading,</span><br><span class="line">&amp;s.Connections.Writing,</span><br><span class="line">&amp;s.Connections.Waiting); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to scan template metrics: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¼šæŠŠåˆšæ‰è§£æåˆ°çš„æ•°æ®ç”Ÿæˆ metricsï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_active&quot;</span>],  </span><br><span class="line">    prometheus.GaugeValue, <span class="type">float64</span>(stats.Connections.Active))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_accepted&quot;</span>],  </span><br><span class="line">    prometheus.CounterValue, <span class="type">float64</span>(stats.Connections.Accepted))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_handled&quot;</span>],  </span><br><span class="line">    prometheus.CounterValue, <span class="type">float64</span>(stats.Connections.Handled))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_reading&quot;</span>],  </span><br><span class="line">    prometheus.GaugeValue, <span class="type">float64</span>(stats.Connections.Reading))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_writing&quot;</span>],  </span><br><span class="line">    prometheus.GaugeValue, <span class="type">float64</span>(stats.Connections.Writing))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_waiting&quot;</span>],  </span><br><span class="line">    prometheus.GaugeValue, <span class="type">float64</span>(stats.Connections.Waiting))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;http_requests_total&quot;</span>],  </span><br><span class="line">    prometheus.CounterValue, <span class="type">float64</span>(stats.Requests))</span><br></pre></td></tr></table></figure><p>è¿™äº› metrics æ˜¯ä¸€å¼€å§‹å°±å®šä¹‰å¥½çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewNginxCollector creates an NginxCollector.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNginxCollector</span><span class="params">(nginxClient *client.NginxClient, namespace <span class="type">string</span>, constLabels <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>, logger log.Logger)</span></span> *NginxCollector &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;NginxCollector&#123;</span><br><span class="line">nginxClient: nginxClient,</span><br><span class="line">logger:      logger,</span><br><span class="line">metrics: <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc&#123;</span><br><span class="line"><span class="string">&quot;connections_active&quot;</span>:   newGlobalMetric(namespace, <span class="string">&quot;connections_active&quot;</span>, <span class="string">&quot;Active client connections&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;connections_accepted&quot;</span>: newGlobalMetric(namespace, <span class="string">&quot;connections_accepted&quot;</span>, <span class="string">&quot;Accepted client connections&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;connections_handled&quot;</span>:  newGlobalMetric(namespace, <span class="string">&quot;connections_handled&quot;</span>, <span class="string">&quot;Handled client connections&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;connections_reading&quot;</span>:  newGlobalMetric(namespace, <span class="string">&quot;connections_reading&quot;</span>, <span class="string">&quot;Connections where NGINX is reading the request header&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;connections_writing&quot;</span>:  newGlobalMetric(namespace, <span class="string">&quot;connections_writing&quot;</span>, <span class="string">&quot;Connections where NGINX is writing the response back to the client&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;connections_waiting&quot;</span>:  newGlobalMetric(namespace, <span class="string">&quot;connections_waiting&quot;</span>, <span class="string">&quot;Idle client connections&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;http_requests_total&quot;</span>:  newGlobalMetric(namespace, <span class="string">&quot;http_requests_total&quot;</span>, <span class="string">&quot;Total http requests&quot;</span>, constLabels),</span><br><span class="line">&#125;,</span><br><span class="line">upMetric: newUpMetric(namespace, constLabels),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¸ªå‡½æ•°æ˜¯åœ¨ exporter å¯åŠ¨æ—¶å€™ä¼šè°ƒç”¨ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;github.com/prometheus/client_golang/prometheus&quot;</span></span><br><span class="line"></span><br><span class="line">prometheus.MustRegister(collector.NewNginxCollector(ossClient, <span class="string">&quot;nginx&quot;</span>, labels, logger))</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨çš„æ˜¯ <code>prometheus</code> åŒ…æä¾›çš„æ³¨å†Œå‡½æ•°ï¼Œå°†æˆ‘ä»¬åˆšæ‰è‡ªå®šä¹‰çš„è·å– <code>metrics</code> çš„é€»è¾‘æ³¨å†Œè¿›å»ï¼Œè¿™æ ·å½“æˆ‘ä»¬åœ¨ Prometheus ä¸­é…ç½®å¥½é‡‡é›†ä»»åŠ¡ä¹‹åå°±å¯ä»¥å®šæœŸæ‰«æ <code>/status</code> çš„æ•°æ®ç„¶åè½¬æ¢ä¸º Prometheus æŒ‡æ ‡è¿”å›ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">nginx-exportor</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;127.0.0.1:9113&#x27;</span>]</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥å°† nginx status çš„æ•°æ®å®šæœŸé‡‡é›†åˆ° Prometheus ä¸­äº†ï¼Œæœ€åä½¿ç”¨ç¤¾åŒºæä¾›çš„ grafana é¢æ¿ä¾¿å¯ä»¥å¯è§†åŒ–çš„æŸ¥çœ‹è¿™äº›ç›‘æ§æ•°æ®ï¼š<br><img src="https://s2.loli.net/2024/06/21/NvlwuAdDZHUznrC.png"></p><h2 id="Nginx-Plus"><a href="#Nginx-Plus" class="headerlink" title="Nginx Plus"></a>Nginx Plus</h2><p>åŒæ—¶è¿™ä¸ª nginx-exporter è¿˜æ”¯æŒ <code>Nginx Plus</code>(è¿™æ˜¯ Nginx çš„å•†ç”¨å¢å¼ºç‰ˆ)ï¼Œå®ƒçš„å®ç°åŸç†ç±»ä¼¼ï¼Œåªæ˜¯å®ƒæ”¯æŒçš„æŒ‡æ ‡æ›´å¤šä¸€äº›è€Œå·²ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NginxPlusCollector <span class="keyword">struct</span> &#123;  </span><br><span class="line">    upMetric                       prometheus.Gauge  </span><br><span class="line">    logger                         log.Logger  </span><br><span class="line">    cacheZoneMetrics               <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    workerMetrics                  <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    nginxClient                    *plusclient.NginxClient  </span><br><span class="line">    streamServerZoneMetrics        <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    streamZoneSyncMetrics          <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    streamUpstreamMetrics          <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    streamUpstreamServerMetrics    <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    locationZoneMetrics            <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    resolverMetrics                <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    limitRequestMetrics            <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    limitConnectionMetrics         <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    streamLimitConnectionMetrics   <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    upstreamServerMetrics          <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    upstreamMetrics                <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    streamUpstreamServerPeerLabels <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    serverZoneMetrics              <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    upstreamServerLabels           <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    streamUpstreamServerLabels     <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    serverZoneLabels               <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    streamServerZoneLabels         <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    upstreamServerPeerLabels       <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    workerLabels                   <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    cacheZoneLabels                <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    totalMetrics                   <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    variableLabelNames             VariableLabelNames  </span><br><span class="line">    variableLabelsMutex            sync.RWMutex  </span><br><span class="line">    mutex                          sync.Mutex  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://prometheus.io/docs/instrumenting/exporters/">Prometheus</a> ç¤¾åŒºä¸­æä¾›ä¸å°‘è¿™ç±» <code>exporter</code>ï¼š<br><img src="https://s2.loli.net/2024/06/21/ztuCr8FgJvcSbis.png"></p><p>è¿™äº› <code>exporter</code> è¦è§£å†³çš„é—®é¢˜éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œå¯¹äºä¸€äº›æ²¡æœ‰æš´éœ² <code>/metrics</code> çš„ä¸­é—´ä»¶é€šè¿‡ä»–ä»¬æä¾›çš„å®¢æˆ·ç«¯ç›´è¿ï¼Œç„¶åå°†è·å–åˆ°çš„æ•°æ®è½¬æ¢ä¸º Prometheus æ‰€æ”¯æŒçš„æ ¼å¼ã€‚</p><blockquote><p>éœ€è¦å•ç‹¬çš„ exporter æ”¯æŒçš„ä¸­é—´ä»¶å¤§éƒ¨åˆ†éƒ½æ˜¯ä¸€äº›è€ç‰Œäº§å“ï¼Œåœ¨è®¾è®¡ä¹‹åˆå°±æ²¡æœ‰è€ƒè™‘å¯è§‚æµ‹æ€§çš„éœ€æ±‚ï¼Œç°åœ¨ä¸€äº›æ–°çš„ä¸­é—´ä»¶å‡ ä¹éƒ½åŸç”Ÿæ”¯æŒ metricsï¼Œè¿™ç§äº§å“åªéœ€è¦åœ¨ Prometheus ä¸­é…ç½®é‡‡é›†ä»»åŠ¡å³å¯ã€‚</p></blockquote><h1 id="Cprobe"><a href="#Cprobe" class="headerlink" title="Cprobe"></a>Cprobe</h1><p>ä¸çŸ¥é“å¤§å®¶å‘ç°æ²¡æœ‰ï¼Œç¤¾åŒºä¸­æä¾›çš„ <code>exporter</code> è¿˜æ˜¯æŒºå¤šçš„ï¼Œä½†å¦‚æœæˆ‘ä»¬éƒ½éœ€è¦åœ¨è‡ªå·±çš„ç”Ÿäº§ç¯å¢ƒå°†è¿™äº› exporter éƒ¨ç½²èµ·æ¥å¤šå°‘ä¼šæœ‰äº›ç¹çï¼š</p><ul><li>ä¸åŒçš„ exporter éœ€è¦çš„å‚æ•°å¯èƒ½ä¸åŒ</li><li>æš´éœ²çš„ç«¯å£å¯èƒ½ä¸åŒ</li><li>é…ç½®æ–‡ä»¶éš¾ä»¥ç»Ÿä¸€ç®¡ç†</li></ul><p>åœ¨è¿™ä¸ªèƒŒæ™¯ä¸‹ç¤¾åŒºæœ‰å¤§ä½¬å‘èµ·äº†ä¸€ä¸ª <a href="https://github.com/cprobe/cprobe">cprobe</a> é¡¹ç›®ï¼Œè¿™æ˜¯ä¸€ä¸ªå¤§è€Œå…¨çš„é¡¹ç›®ï¼Œå¯ä»¥å°†æ•£è½åœ¨å„å¤„çš„ <code>exporter</code> éƒ½æ•´åˆåœ¨ä¸€èµ·ã€‚</p><p>å¹¶ä¸”ç»Ÿä¸€æŠ½è±¡äº†æ¥å…¥æ–¹å¼ï¼Œä½¿å¾—æ‰€æœ‰çš„æ’ä»¶éƒ½å¯ä»¥ç”¨ç±»ä¼¼çš„é…ç½®ä¹¦å†™æ–¹å¼æ¥ç»´æŠ¤è¿™äº›æ’ä»¶ã€‚</p><p>ç›®å‰å·²ç»æ”¯æŒä»¥ä¸‹ä¸€äº›å¸¸ç”¨çš„ä¸­é—´ä»¶ï¼š</p><p><img src="https://s2.loli.net/2024/06/21/eC75lpg2fBmstjS.png"></p><p>è¿™é‡Œçš„ Nginx å°±æ˜¯æœ¬æ¬¡ç›‘æ§çš„éœ€æ±‚è´¡çŒ®çš„ï¼Œå› ä¸ºè¿˜éœ€è¦ç›‘æ§è¿™é‡Œæ”¯æŒçš„ä¸€äº›å…¶ä»–ä¸­é—´ä»¶ï¼Œæ‰€ä»¥æœ€ç»ˆä¹Ÿæ˜¯ä½¿ç”¨ cprobe æ¥éƒ¨ç½²ç›‘æ§ã€‚</p><h2 id="æ•´åˆ-Nginx-exporter-åˆ°-Cprobe-ä¸­"><a href="#æ•´åˆ-Nginx-exporter-åˆ°-Cprobe-ä¸­" class="headerlink" title="æ•´åˆ Nginx exporter åˆ° Cprobe ä¸­"></a>æ•´åˆ Nginx exporter åˆ° Cprobe ä¸­</h2><p>ä¸‹é¢æ¥çœ‹çœ‹å¦‚ä½•å°†ç¤¾åŒºä¸­å·²ç»å­˜åœ¨çš„ Nginx exporter æ•´åˆåˆ°  cprobe ä¸­ï¼š</p><p>åœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆè¦æŠ½è±¡å‡ºè¿™ä¸ªæ’ä»¶éœ€è¦å“ªäº›é…ç½®ï¼Ÿ</p><p>è¿™ä¸ªå…¶å®å¾ˆå¥½è§£å†³ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹çœ‹éœ€è¦å®ç°çš„ exporter ä¸­æä¾›äº†å“ªäº›å‚æ•°ï¼Œè¿™é‡Œä»¥ Nginx çš„ä¸ºä¾‹ï¼š<br><img src="https://s2.loli.net/2024/06/21/zsY2F563pPglNcS.png"></p><p>æ’é™¤æ‰ä¸€äº›æˆ‘ä»¬ä¸éœ€è¦çš„ï¼Œæ¯”å¦‚ç«¯å£ã€æ—¥å¿—çº§åˆ«ã€endpointç­‰é…ç½®ä¹‹å¤–ï¼Œå°±åªéœ€è¦ä¸€äº›å…³äº SSL çš„é…ç½®ï¼Œæ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬éœ€è¦çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nginx_plus</span> = <span class="literal">false</span>  </span><br><span class="line"><span class="comment"># Path to the PEM encoded CA certificate file used to validate the servers SSL certificate.  </span></span><br><span class="line"><span class="attr">ssl_ca_cert</span> = <span class="string">&#x27;&#x27;</span>  </span><br><span class="line"><span class="comment"># Path to the PEM encoded client certificate file to use when connecting to the server.  </span></span><br><span class="line"><span class="attr">ssl_client_cert</span> = <span class="string">&#x27;&#x27;</span>  </span><br><span class="line"><span class="comment"># Path to the PEM encoded client certificate key file to use when connecting to the server.  </span></span><br><span class="line"><span class="attr">ssl_client_key</span> = <span class="string">&#x27;&#x27;</span>  </span><br><span class="line"><span class="comment"># Perform SSL certificate verification.  </span></span><br><span class="line"><span class="attr">ssl_verify</span> = <span class="literal">false</span>  </span><br><span class="line"><span class="attr">timeout</span> = <span class="string">&#x27;5s&#x27;</span></span><br></pre></td></tr></table></figure><p>ç„¶åå°†è¿™ä¸ª toml é‡Œçš„é…ç½®è½¬æ¢ä¸ºä¸€ä¸ª structã€‚</p><p>åœ¨ cprobe ä¸­æœ‰ä¸€ä¸ªæ ¸å¿ƒçš„æ¥å£ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// ParseConfig is used to parse config</span></span><br><span class="line">ParseConfig(baseDir <span class="type">string</span>, bs []<span class="type">byte</span>) (any, <span class="type">error</span>)</span><br><span class="line"><span class="comment">// Scrape is used to scrape metrics, cfg need to be cast specific cfg</span></span><br><span class="line">Scrape(ctx context.Context, target <span class="type">string</span>, cfg any, ss *types.Samples) <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ParseConfig</code> ç”¨äºå°†åˆšæ‰çš„é…ç½®æ–‡ä»¶æµæ ¼å¼åŒ–ä¸ºæ’ä»¶æ‰€éœ€è¦çš„é…ç½®ã€‚</p><p><code>Scrape</code> å‡½æ•°åˆ™æ˜¯ç”± cprobe å®šæ—¶è°ƒç”¨çš„å‡½æ•°ï¼Œä¼šä¼ å…¥æŠ“å–çš„ç›®æ ‡åœ°å€ï¼Œæ¯ä¸ªæ’ä»¶å°†æŠ“åˆ°çš„æ•°æ®å†™å…¥ <code>*types.Samples</code> ä¸­å³å¯ã€‚</p><p><code>cprobe</code> ä¼šå°† <code>*types.Samples</code> çš„æ•°æ®å‘é€åˆ° remote çš„ Prometheus ä¸­ã€‚</p><p>æ¥ä¸‹æ¥çœ‹çœ‹ Nginx æ’ä»¶çš„å®ç°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">NginxPlus     <span class="type">bool</span>          <span class="string">`toml:&quot;nginx_plus&quot;`</span></span><br><span class="line">SSLCACert     <span class="type">string</span>        <span class="string">`toml:&quot;ssl_ca_cert&quot;`</span></span><br><span class="line">SSLClientCert <span class="type">string</span>        <span class="string">`toml:&quot;ssl_client_cert&quot;`</span></span><br><span class="line">SSLClientKey  <span class="type">string</span>        <span class="string">`toml:&quot;ssl_client_key&quot;`</span></span><br><span class="line">SSLVerify     <span class="type">bool</span>          <span class="string">`toml:&quot;ssl_verify&quot;`</span></span><br><span class="line">Timeout       time.Duration <span class="string">`toml:&quot;timeout&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Nginx)</span></span> ParseConfig(baseDir <span class="type">string</span>, bs []<span class="type">byte</span>) (any, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> c Config</span><br><span class="line">err := toml.Unmarshal(bs, &amp;c)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> c.Timeout == <span class="number">0</span> &#123;</span><br><span class="line">c.Timeout = time.Millisecond * <span class="number">500</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;c, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ParseConfig</code> å¾ˆç®€å•ï¼Œå°±æ˜¯å°†é…ç½®æ–‡ä»¶è½¬æ¢ä¸º structã€‚</p><p>æŠ“å–å‡½æ•° <code>Scrape</code> ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">collect, err := registerCollector(transport, target, <span class="literal">nil</span>, conf)  </span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> err  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> prometheus.Metric)  </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    collect.Collect(ch)  </span><br><span class="line">    <span class="built_in">close</span>(ch)  </span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>å°±æ˜¯æ„å»ºä¹‹å‰åœ¨ <code>nginx exporter</code> ä¸­çš„ <code>prometheus.Collector</code>ï¼Œå…¶å®ä»£ç å¤§éƒ¨åˆ†ä¹Ÿæ˜¯ä»é‚£è¾¹å¤åˆ¶è¿‡æ¥çš„ã€‚<br><img src="https://s2.loli.net/2024/06/21/4yHQgL1EAiZXwju.png"><br><img src="https://s2.loli.net/2024/06/21/1OloLxpEnbqiaXA.png"><br>æ‰€ä»¥å…¶å®è¿ç§»ä¸€ä¸ª exporter åˆ° cprobe ä¸­éå¸¸ç®€å•ï¼Œåªéœ€è¦ï¼š</p><ul><li>å®šä¹‰å¥½éœ€è¦çš„é…ç½®ã€‚</li><li>å»æ‰ä¸éœ€è¦çš„ä»£ç ï¼Œæ¯”å¦‚æ—¥å¿—ã€ç«¯å£ä¹‹ç±»çš„ã€‚</li><li>é€‚é…å¥½åˆšæ‰é‚£ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•° <code>ParseConfig/Scrape</code> å³å¯ã€‚</li></ul><p>ä½†è¿™æ ·ä¹Ÿæœ‰äº›å°é—®é¢˜ï¼Œç°æœ‰çš„ä¸€äº› exporter è¿˜åœ¨è¿­ä»£ï¼Œé‚£è¾¹æ›´æ–°çš„ç‰ˆæœ¬éœ€è¦æœ‰äººåŠæ—¶åŒæ­¥è¿‡æ¥ã€‚</p><p>é™¤éæœ‰ä¸€å¤© cprobe å¯ä»¥ä½œä¸ºä¸€ä¸ªæ ‡å‡†ï¼Œç‰ˆæœ¬æ›´æ–°éƒ½åœ¨ cprobe è¿™è¾¹å®Œæˆï¼Œè¿™æ ·å°±çœŸçš„æ˜¯åšå¤§åšå¼ºäº†ã€‚</p><p>ä¸è¿‡è¿™äº›ä¾æ—§æ˜¯é€‚é…è€ä¸€ä»£çš„ä¸­é—´ä»¶äº§å“ï¼Œé€æ­¥éƒ½ä¼šé€‚é…ç°ä»£çš„å¯è§‚æµ‹ä½“ç³»ï¼Œè¿™äº› exporter ä¹Ÿä¼šé€æ¸èµ°ä¸‹å†å²èˆå°ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a></li><li><a href="https://github.com/nginxinc/nginx-prometheus-exporter">https://github.com/nginxinc/nginx-prometheus-exporter</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰æ®µæ—¶é—´æ¥åˆ°ä¸€ä¸ªéœ€æ±‚ï¼Œå¸Œæœ›å¯ä»¥ç›‘æ§ Nginx çš„è¿è¡ŒçŠ¶æ€ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬éƒ½çŸ¥é“ Nginx ä½œä¸ºä¸€ä¸ªæµè¡Œçš„ Web æœåŠ¡å™¨æä¾›äº†å¤šç§èƒ½åŠ›ï¼ŒåŒ…æ‹¬åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ï¼›ä¹Ÿæ”¯æŒäº†è®¸å¤šåè®®ï¼ŒåŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;gRPC&lt;/li&gt;
&lt;li&gt;http&lt;/li&gt;
&lt;li&gt;WebSocket ç­‰&lt;br&gt;ä½œä¸ºä¸€ä¸ªæµé‡å…¥å£çš„ä¸­é—´ä»¶ï¼Œå¯¹å…¶çš„ç›‘æ§å°±æ˜¾å¾—è‡³å…³é‡è¦äº†ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="Nginx" scheme="http://crossoverjie.top/tags/Nginx/"/>
    
    <category term="Monitor" scheme="http://crossoverjie.top/tags/Monitor/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼ç³»ç»Ÿå¦‚ä½•åšè´Ÿè½½å‡è¡¡</title>
    <link href="http://crossoverjie.top/2024/07/15/ob/Pulsar-loadbalance/"/>
    <id>http://crossoverjie.top/2024/07/15/ob/Pulsar-loadbalance/</id>
    <published>2024-07-15T02:22:14.000Z</published>
    <updated>2024-07-15T14:03:51.478Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>Pulsar æœ‰æä¾›ä¸€ä¸ªæŸ¥è¯¢ Broker è´Ÿè½½çš„æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get load for this broker.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> PulsarAdminException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">LoadManagerReport <span class="title function_">getLoadReport</span><span class="params">()</span> <span class="keyword">throws</span> PulsarAdminException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoadManagerReport</span> <span class="keyword">extends</span> <span class="title class_">ServiceLookupData</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    ResourceUsage <span class="title function_">getCpu</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    ResourceUsage <span class="title function_">getMemory</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    ResourceUsage <span class="title function_">getDirectMemory</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    ResourceUsage <span class="title function_">getBandwidthIn</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    ResourceUsage <span class="title function_">getBandwidthOut</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥è¿”å›ä¸€äº› broker çš„è´Ÿè½½æ•°æ®ï¼Œæ¯”å¦‚ CPUã€å†…å­˜ã€æµé‡ä¹‹ç±»çš„æ•°æ®ã€‚</p><span id="more"></span><blockquote><p>æˆ‘ç›®å‰ç¢°åˆ°çš„é—®é¢˜æ˜¯ç›®å‰ä¼šé‡åˆ°éƒ¨åˆ†èŠ‚ç‚¹çš„è´Ÿå€ºä¸å¹³è¡¡ï¼Œå¯¼è‡´èµ„æºå ç”¨ä¸å‡è¡¡ï¼Œæ‰€ä»¥æƒ³è¦æ‰‹åŠ¨æŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼Œç„¶åäººå·¥è¿›è¡Œè´Ÿè½½ã€‚</p></blockquote><p>ç†è®ºä¸Šè¿™äº›æ•°æ®æ˜¯åœ¨è¿è¡Œæ—¶å®æ—¶è®¡ç®—çš„æ•°æ®ï¼Œå¦‚æœå¯¹äºå•æœºçš„å€’è¿˜å¥½è¯´ï¼Œæ¯æ¬¡è¯·æ±‚è¿™ä¸ªæ¥å£ç›´æ¥å®æ—¶è®¡ç®—ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p><p>ä½†å¯¹äºé›†ç¾¤çš„æœåŠ¡æ¥è¯´ä¼šæœ‰å¤šä¸ªèŠ‚ç‚¹ï¼Œç›®å‰ Pulsar æä¾›çš„è¿™ä¸ªæ¥å£åªèƒ½æŸ¥è¯¢æŒ‡å®šèŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡å¾—ä¼ å…¥ç›®æ ‡èŠ‚ç‚¹çš„ IP å’Œç«¯å£ã€‚</p><p><img src="https://s2.loli.net/2024/06/07/ephIgndx54sFlLa.png"></p><p>æ‰€ä»¥æˆ‘çš„é¢„æœŸæ˜¯å¯ä»¥æä¾›ä¸€ä¸ªæŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹è´Ÿè½½çš„æ¥å£ï¼Œå·²ç»æäº† <code>issue</code>ï¼Œæœ€è¿‘å‡†å¤‡å†™ Purpose æŠŠè¿™ä¸ªéœ€æ±‚è§£å†³äº†ã€‚</p><p>å®ç°è¿™ä¸ªéœ€æ±‚çš„æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p><ol><li>æ‹¿åˆ°æ‰€æœ‰ broker ä¹Ÿå°±æ˜¯æœåŠ¡èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¾æ¬¡éå†è°ƒç”¨æ¥å£ï¼Œç„¶åè‡ªå·±ç»„è£…ä¿¡æ¯ã€‚</li><li>ä» zookeeper ä¸­è·å–è´Ÿè½½ä¿¡æ¯ã€‚</li></ol><p>ç†è®ºä¸Šç¬¬äºŒç§æ›´å¥½ï¼Œç¬¬ä¸€ç§å®ç°è™½ç„¶æ›´ç®€å•ï¼Œä½†æ¯æ¬¡éƒ½å‘èµ·ä¸€æ¬¡ http è¯·æ±‚ï¼Œå¤šå°‘æœ‰äº›æµªè´¹ã€‚</p><p>ç¬¬äºŒç§æ–¹æ¡ˆç›´æ¥ä»æºå¤´è·å–è´Ÿè½½ä¿¡æ¯ï¼Œåªéœ€è¦è¯·æ±‚ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p><p>è€Œæ­£å¥½ç¤¾åŒºæä¾›äº†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·å¯ä»¥ç›´æ¥æ‰“å°æ‰€æœ‰çš„ <code>broker</code> è´Ÿè½½æ•°æ®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pulsar-perf monitor-brokers --connect-string &lt;zookeeper host:port&gt;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/06/07/UN8gpW915RfcODb.png"></p><h1 id="åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨ç»„ä»¶"><a href="#åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨ç»„ä»¶" class="headerlink" title="åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨ç»„ä»¶"></a>åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨ç»„ä»¶</h1><p>æä¾›çš„å‘½ä»¤è¡Œå·¥å…·å…¶å®å°±æ˜¯ç›´æ¥ä» zookeeper ä¸­æŸ¥è¯¢çš„æ•°æ®ã€‚</p><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éœ€è¦ä¸€ä¸ªé›†ä¸­çš„ç»„ä»¶æ¥ç®¡ç†å„ç§æ•°æ®ï¼Œæ¯”å¦‚ï¼š</p><ol><li>å¯ä»¥åˆ©ç”¨è¯¥ç»„ä»¶æ¥é€‰ä¸¾ leader èŠ‚ç‚¹</li><li>ä½¿ç”¨è¯¥ç»„ä»¶æ¥åšåˆ†å¸ƒå¼é”</li><li>ä¸ºåˆ†å¸ƒå¼ç³»ç»ŸåŒæ­¥æ•°æ®</li><li>ç»Ÿä¸€çš„å­˜æ”¾å’Œè¯»å–æŸäº›æ•°æ®</li></ol><p>å¯ä»¥æä¾›è¯¥åŠŸèƒ½çš„ç»„ä»¶å…¶å®ä¹Ÿä¸å°‘ï¼š</p><ul><li><a href="https://zookeeper.apache.org/">zookeeper</a></li><li><a href="https://etcd.io/">etcd</a></li><li><a href="https://github.com/streamnative/oxia">oxia</a></li></ul><p>Zookeeper æ˜¯è€ç‰Œçš„åˆ†å¸ƒå¼åè°ƒç»„ä»¶ï¼Œå¯ä»¥åš leader é€‰ä¸¾ã€é…ç½®ä¸­å¿ƒã€åˆ†å¸ƒå¼é”ã€æœåŠ¡æ³¨å†Œä¸å‘ç°ç­‰åŠŸèƒ½ã€‚</p><p>åœ¨è®¸å¤šä¸­é—´ä»¶å’Œç³»ç»Ÿä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ï¼š</p><ul><li><a href="https://github.com/apache/pulsar">Apache Pulsar</a> ä¸­ä½œä¸ºåè°ƒä¸­å¿ƒ</li><li><a href="https://github.com/apache/kafka">Kafka</a> ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„ä½œç”¨ã€‚</li><li>åœ¨ <a href="https://github.com/apache/dubbo">Dubbo</a> ä¸­ä½œä¸ºæœåŠ¡æ³¨å†Œå‘ç°ç»„ä»¶ã€‚</li></ul><hr><p>etcd çš„åŠŸèƒ½ä¸ zookeeper ç±»ä¼¼ï¼Œå¯ä»¥ç”¨ä½œæœåŠ¡æ³¨å†Œå‘ç°ï¼Œä¹Ÿå¯ä»¥ä½œä¸º Key Value é”®å€¼å¯¹å­˜å‚¨ç³»ç»Ÿï¼›åœ¨ kubernetes ä¸­æ‰®æ¼”äº†å·¨å¤§ä½œç”¨ï¼Œç»å†äº†å„ç§è€ƒéªŒï¼Œç¨³å®šæ€§å·²ç»éå¸¸å¯é äº†ã€‚</p><hr><p><a href="https://github.com/streamnative/oxia">Oxia</a> åˆ™æ˜¯ StreamNative å¼€å‘çš„ä¸€ä¸ªç”¨äºæ›¿æ¢ Zookeeper çš„ä¸­é—´ä»¶ï¼ŒåŠŸèƒ½ä¹Ÿä¸ Zookeeper ç±»ä¼¼ï¼›ç›®å‰å·²ç»å¯ä»¥åœ¨ Pulsar ä¸­æ›¿æ¢ Zookeeperï¼Œåªæ˜¯è¿˜æ²¡æœ‰å¤§è§„æ¨¡çš„ä½¿ç”¨ã€‚</p><h1 id="Pulsar-ä¸­çš„åº”ç”¨"><a href="#Pulsar-ä¸­çš„åº”ç”¨" class="headerlink" title="Pulsar ä¸­çš„åº”ç”¨"></a>Pulsar ä¸­çš„åº”ç”¨</h1><p>ä¸‹é¢ä»¥ Pulsar ä¸ºä¾‹ï¼ˆä½¿ç”¨ zookeeperï¼‰ï¼Œçœ‹çœ‹åœ¨è¿™ç±»å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ˜¯å¦‚ä½•å¤„ç†è´Ÿè½½å‡è¡¡çš„ã€‚</p><p>å†å¼€å§‹ä¹‹å‰å…ˆæ˜ç¡®ä¸‹è´Ÿè½½å‡è¡¡å¤§ä½“ä¸Šä¼šåšå“ªäº›äº‹æƒ…ã€‚</p><ol><li>é¦–å…ˆä¸ŠæŠ¥è‡ªå·±èŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®</li><li>Leader èŠ‚ç‚¹éœ€è¦å®šæ—¶æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ã€‚<ol><li>è¿™äº›è´Ÿè½½æ•°æ®ä¸­åŒ…æ‹¬ï¼š<ol><li><code>CPU</code>ã€å †å†…å­˜ã€å †å¤–å†…å­˜ç­‰é€šç”¨æ•°æ®çš„ä½¿ç”¨é‡</li><li>æµå‡ºã€æµå…¥æµé‡</li><li>ä¸€äº›ç³»ç»Ÿç‰¹æœ‰çš„æ•°æ®ï¼Œæ¯”å¦‚åœ¨ <code>Pulsar</code> ä¸­å°±æ˜¯ï¼š<ol><li>æ¯ä¸ª <code>broker</code> ä¸­çš„ <code>topic</code>ã€<code>consumer</code>ã€<code>producer</code>ã€<code>bundle</code> ç­‰æ•°æ®ã€‚</li></ol></li></ol></li></ol></li><li>å†ç”± leader èŠ‚ç‚¹è¯»å–åˆ°è¿™äº›æ•°æ®åé€‰æ‹©è´Ÿè½½è¾ƒé«˜çš„èŠ‚ç‚¹ï¼Œå°†æ•°æ®è¿ç§»åˆ°è´Ÿè½½è¾ƒä½çš„èŠ‚ç‚¹ã€‚</li></ol><p>ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„è´Ÿè½½å‡è¡¡çš„æµç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬ä¾æ¬¡çœ‹çœ‹åœ¨ <code>Pulsar</code> ä¸­æ˜¯å¦‚ä½•å®ç°è¿™äº›é€»è¾‘çš„ã€‚</p><p>åœ¨ Pulsar ä¸­æä¾›äº†å¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä»¥ä¸‹æ˜¯åŠ è½½è´Ÿè½½å‡è¡¡å™¨çš„é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> LoadManager <span class="title function_">create</span><span class="params">(<span class="keyword">final</span> PulsarService pulsar)</span> &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServiceConfiguration</span> <span class="variable">conf</span> <span class="operator">=</span> pulsar.getConfiguration();  </span><br><span class="line">        <span class="comment">// Assume there is a constructor with one argument of PulsarService.  </span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">loadManagerInstance</span> <span class="operator">=</span> Reflections.createInstance(conf.getLoadManagerClassName(),  </span><br><span class="line">                Thread.currentThread().getContextClassLoader());  </span><br><span class="line">        <span class="keyword">if</span> (loadManagerInstance <span class="keyword">instanceof</span> LoadManager) &#123;  </span><br><span class="line">            <span class="keyword">final</span> <span class="type">LoadManager</span> <span class="variable">casted</span> <span class="operator">=</span> (LoadManager) loadManagerInstance;  </span><br><span class="line">            casted.initialize(pulsar);  </span><br><span class="line">            <span class="keyword">return</span> casted;  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loadManagerInstance <span class="keyword">instanceof</span> ModularLoadManager) &#123;  </span><br><span class="line">            <span class="keyword">final</span> <span class="type">LoadManager</span> <span class="variable">casted</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModularLoadManagerWrapper</span>((ModularLoadManager) loadManagerInstance);  </span><br><span class="line">            casted.initialize(pulsar);  </span><br><span class="line">            <span class="keyword">return</span> casted;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        LOG.warn(<span class="string">&quot;Error when trying to create load manager: &quot;</span>, e);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// If we failed to create a load manager, default to SimpleLoadManagerImpl.  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleLoadManagerImpl</span>(pulsar);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤ä½¿ç”¨çš„æ˜¯ <code>ModularLoadManagerImpl</code>ï¼Œ å¦‚æœå‡ºç°å¼‚å¸¸é‚£å°±ä¼šä½¿ç”¨ <code>SimpleLoadManagerImpl</code> ä½œä¸ºå…œåº•ã€‚</p><p>ä»–ä»¬ä¸¤ä¸ªçš„åŒºåˆ«æ˜¯ <code>ModularLoadManagerImpl</code> çš„åŠŸèƒ½æ›´å…¨ï¼Œå¯ä»¥åšæ›´ä¸ºç»†è‡´çš„è´Ÿè½½ç­–ç•¥ã€‚</p><p>æ¥ä¸‹æ¥ä»¥é»˜è®¤çš„ <code>ModularLoadManagerImpl</code> ä¸ºä¾‹è®²è§£ä¸Šè¿°çš„æµç¨‹ã€‚</p><h2 id="ä¸ŠæŠ¥è´Ÿè½½æ•°æ®"><a href="#ä¸ŠæŠ¥è´Ÿè½½æ•°æ®" class="headerlink" title="ä¸ŠæŠ¥è´Ÿè½½æ•°æ®"></a>ä¸ŠæŠ¥è´Ÿè½½æ•°æ®</h2><p>åœ¨è´Ÿè½½å‡è¡¡å™¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šæ”¶é›†èŠ‚ç‚¹æ•°æ®ç„¶åè¿›è¡Œä¸ŠæŠ¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> PulsarServerException &#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">         <span class="type">String</span> <span class="variable">brokerId</span> <span class="operator">=</span> pulsar.getBrokerId();</span><br><span class="line">         brokerZnodePath = LoadManager.LOADBALANCE_BROKERS_ROOT + <span class="string">&quot;/&quot;</span> + brokerId;</span><br><span class="line">         <span class="comment">// æ”¶é›†æœ¬åœ°è´Ÿè½½æ•°æ®</span></span><br><span class="line">         updateLocalBrokerData();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ŠæŠ¥ zookeeper</span></span><br><span class="line">         brokerDataLock = brokersData.acquireLock(brokerZnodePath, localData).join();</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         log.error(<span class="string">&quot;Unable to acquire lock for broker: [&#123;&#125;]&quot;</span>, brokerZnodePath, e);</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PulsarServerException</span>(e);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–åˆ°å½“å‰ broker çš„ Id ç„¶åæ‹¼æ¥ä¸€ä¸ª zookeeper èŠ‚ç‚¹çš„è·¯å¾„ï¼Œå°†ç”Ÿæˆçš„ localData ä¸Šä¼ åˆ° zookeeper ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// å­˜æ”¾ broker çš„èŠ‚ç‚¹ä¿¡æ¯</span><br><span class="line">ls /loadbalance/brokers</span><br><span class="line"></span><br><span class="line">[broker-1:8080, broker-2:8080]</span><br><span class="line"></span><br><span class="line">// æ ¹æ®èŠ‚ç‚¹ä¿¡æ¯æŸ¥è¯¢è´Ÿè½½æ•°æ®</span><br><span class="line">get /loadbalance/brokers/broker-1:8080</span><br></pre></td></tr></table></figure><p>ä¸ŠæŠ¥çš„æ•°æ®ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;webServiceUrl&quot;</span><span class="punctuation">:</span><span class="string">&quot;http://broker-1:8080&quot;</span><span class="punctuation">,</span><span class="attr">&quot;pulsarServiceUrl&quot;</span><span class="punctuation">:</span><span class="string">&quot;pulsar://broker-1:6650&quot;</span><span class="punctuation">,</span><span class="attr">&quot;persistentTopicsEnabled&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;nonPersistentTopicsEnabled&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;cpu&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span><span class="number">7.311714728372232</span><span class="punctuation">,</span><span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span><span class="number">800.0</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;memory&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span><span class="number">124.0</span><span class="punctuation">,</span><span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span><span class="number">2096.0</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;directMemory&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span><span class="number">36.0</span><span class="punctuation">,</span><span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span><span class="number">256.0</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;bandwidthIn&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span><span class="number">0.8324254085661579</span><span class="punctuation">,</span><span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span><span class="number">1.0E7</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;bandwidthOut&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span><span class="number">0.7155446715644209</span><span class="punctuation">,</span><span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span><span class="number">1.0E7</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;msgThroughputIn&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgThroughputOut&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgRateIn&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgRateOut&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;lastUpdate&quot;</span><span class="punctuation">:</span><span class="number">1690979816792</span><span class="punctuation">,</span><span class="attr">&quot;lastStats&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;my-tenant/my-namespace/0x4ccccccb_0x66666664&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;msgRateIn&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgThroughputIn&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgRateOut&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgThroughputOut&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;consumerCount&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;producerCount&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;topics&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;cacheSize&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;numTopics&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;numBundles&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;numConsumers&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;numProducers&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;bundles&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;my-tenant/my-namespace/0x4ccccccb_0x66666664&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;lastBundleGains&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;lastBundleLosses&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;brokerVersionString&quot;</span><span class="punctuation">:</span><span class="string">&quot;3.1.0-SNAPSHOT&quot;</span><span class="punctuation">,</span><span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;advertisedListeners&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;internal&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;brokerServiceUrl&quot;</span><span class="punctuation">:</span><span class="string">&quot;pulsar://broker-1:6650&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;loadManagerClassName&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.pulsar.broker.loadbalance.impl.ModularLoadManagerImpl&quot;</span><span class="punctuation">,</span><span class="attr">&quot;startTimestamp&quot;</span><span class="punctuation">:</span><span class="number">1690940955211</span><span class="punctuation">,</span><span class="attr">&quot;maxResourceUsage&quot;</span><span class="punctuation">:</span><span class="number">0.140625</span><span class="punctuation">,</span><span class="attr">&quot;loadReportType&quot;</span><span class="punctuation">:</span><span class="string">&quot;LocalBrokerData&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="é‡‡é›†æ•°æ®"><a href="#é‡‡é›†æ•°æ®" class="headerlink" title="é‡‡é›†æ•°æ®"></a>é‡‡é›†æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SystemResourceUsage <span class="title function_">getSystemResourceUsage</span><span class="params">(<span class="keyword">final</span> BrokerHostUsage brokerHostUsage)</span> &#123;  </span><br><span class="line">    <span class="type">SystemResourceUsage</span> <span class="variable">systemResourceUsage</span> <span class="operator">=</span> brokerHostUsage.getBrokerHostUsage();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Override System memory usage and limit with JVM heap usage and limit  </span></span><br><span class="line">    <span class="type">double</span> <span class="variable">maxHeapMemoryInBytes</span> <span class="operator">=</span> Runtime.getRuntime().maxMemory();  </span><br><span class="line">    <span class="type">double</span> <span class="variable">memoryUsageInBytes</span> <span class="operator">=</span> Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();  </span><br><span class="line">    <span class="type">double</span> <span class="variable">memoryUsage</span> <span class="operator">=</span> memoryUsageInBytes / MIBI;  </span><br><span class="line">    <span class="type">double</span> <span class="variable">memoryLimit</span> <span class="operator">=</span> maxHeapMemoryInBytes / MIBI;  </span><br><span class="line">    systemResourceUsage.setMemory(<span class="keyword">new</span> <span class="title class_">ResourceUsage</span>(memoryUsage, memoryLimit));  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Collect JVM direct memory  </span></span><br><span class="line">    systemResourceUsage.setDirectMemory(<span class="keyword">new</span> <span class="title class_">ResourceUsage</span>((<span class="type">double</span>) (getJvmDirectMemoryUsed() / MIBI),  </span><br><span class="line">            (<span class="type">double</span>) (DirectMemoryUtils.jvmMaxDirectMemory() / MIBI)));  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> systemResourceUsage;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šåœ¨è¿è¡Œæ—¶è·å–ä¸€äº› JVM å’Œ å †å¤–å†…å­˜çš„æ•°æ®ã€‚</p><h2 id="æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹æ•°æ®"><a href="#æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹æ•°æ®" class="headerlink" title="æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹æ•°æ®"></a>æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹æ•°æ®</h2><p>ä½œä¸º <code>leader</code> èŠ‚ç‚¹è¿˜éœ€è¦æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼Œç„¶åæ ¹æ®ä¸€äº›è§„åˆ™é€‰æ‹©å°†è´Ÿè½½è¾ƒé«˜çš„èŠ‚ç‚¹ç§»åŠ¨åˆ°è´Ÿå€ºè¾ƒä½çš„èŠ‚ç‚¹ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateAllBrokerData</span><span class="params">()</span> &#123;</span><br><span class="line"> <span class="comment">// ä» zookeeper ä¸­è·å–æ‰€æœ‰èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Set&lt;String&gt; activeBrokers = getAvailableBrokers();</span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, BrokerData&gt; brokerDataMap = loadData.getBrokerData();</span><br><span class="line">    <span class="keyword">for</span> (String broker : activeBrokers) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s/%s&quot;</span>, LoadManager.LOADBALANCE_BROKERS_ROOT, broker);</span><br><span class="line">            <span class="comment">// ä¾æ¬¡è¯»å–å„ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®</span></span><br><span class="line">            Optional&lt;LocalBrokerData&gt; localData = brokersData.readLock(key).get();</span><br><span class="line">            <span class="keyword">if</span> (!localData.isPresent()) &#123;</span><br><span class="line">                brokerDataMap.remove(broker);</span><br><span class="line">                log.info(<span class="string">&quot;[&#123;&#125;] Broker load report is not present&quot;</span>, broker);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (brokerDataMap.containsKey(broker)) &#123;</span><br><span class="line">                <span class="comment">// Replace previous local broker data.</span></span><br><span class="line">                brokerDataMap.get(broker).setLocalData(localData.get());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Initialize BrokerData object for previously unseen</span></span><br><span class="line">                <span class="comment">// brokers.</span></span><br><span class="line">                <span class="comment">// å°†æ•°æ®å†™å…¥åˆ°æœ¬åœ°ç¼“å­˜</span></span><br><span class="line">                brokerDataMap.put(broker, <span class="keyword">new</span> <span class="title class_">BrokerData</span>(localData.get()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Error reading broker data from cache for broker - [&#123;&#125;], [&#123;&#125;]&quot;</span>, broker, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Remove obsolete brokers.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> String broker : brokerDataMap.keySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!activeBrokers.contains(broker)) &#123;</span><br><span class="line">            brokerDataMap.remove(broker);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šä» zookeeper çš„èŠ‚ç‚¹ä¸­è·å–åˆ°æ‰€æœ‰çš„ broker åˆ—è¡¨ï¼ˆbroker ä¼šåœ¨å¯åŠ¨æ—¶å°†è‡ªèº«çš„ä¿¡æ¯æ³¨å†Œåˆ° zookeeper ä¸­ã€‚ï¼‰</p><p>ç„¶åä¾æ¬¡è¯»å–å„è‡ªèŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼Œä¹Ÿå°±æ˜¯åœ¨è´Ÿè½½å‡è¡¡å™¨å¯åŠ¨çš„æ—¶å€™ä¸ŠæŠ¥çš„æ•°æ®ã€‚</p><h2 id="ç­›é€‰å‡ºæ‰€æœ‰-broker-ä¸­éœ€è¦-unload-çš„-bundle"><a href="#ç­›é€‰å‡ºæ‰€æœ‰-broker-ä¸­éœ€è¦-unload-çš„-bundle" class="headerlink" title="ç­›é€‰å‡ºæ‰€æœ‰ broker ä¸­éœ€è¦ unload çš„ bundle"></a>ç­›é€‰å‡ºæ‰€æœ‰ broker ä¸­éœ€è¦ unload çš„ bundle</h2><p>åœ¨ Pulsar ä¸­ topic æ˜¯æœ€æ ¸å¿ƒçš„æ¦‚å¿µï¼Œè€Œä¸ºäº†æ–¹ä¾¿ç®¡ç†å¤§é‡ topicï¼Œæå‡ºäº†ä¸€ä¸ª Bundle çš„æ¦‚å¿µï¼› Bundle æ˜¯ä¸€æ‰¹ topic çš„é›†åˆï¼Œç®¡ç† Bundle è‡ªç„¶ä¼šæ¯” topic æ›´ä½³å®¹æ˜“ã€‚</p><p>æ‰€ä»¥åœ¨ Pulsar ä¸­åšè´Ÿè½½å‡è¡¡æœ€ä¸»è¦çš„å°±æ˜¯å°†è´Ÿè½½è¾ƒé«˜èŠ‚ç‚¹ä¸­çš„ bundle è½¬ç§»åˆ°ä½è´Ÿè½½çš„ broker ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateAllBrokerData</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Set&lt;String&gt; activeBrokers = getAvailableBrokers();</span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, BrokerData&gt; brokerDataMap = loadData.getBrokerData();</span><br><span class="line">    <span class="keyword">for</span> (String broker : activeBrokers) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s/%s&quot;</span>, LoadManager.LOADBALANCE_BROKERS_ROOT, broker);</span><br><span class="line">            Optional&lt;LocalBrokerData&gt; localData = brokersData.readLock(key).get();</span><br><span class="line">            <span class="keyword">if</span> (!localData.isPresent()) &#123;</span><br><span class="line">                brokerDataMap.remove(broker);</span><br><span class="line">                log.info(<span class="string">&quot;[&#123;&#125;] Broker load report is not present&quot;</span>, broker);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (brokerDataMap.containsKey(broker)) &#123;</span><br><span class="line">                <span class="comment">// Replace previous local broker data.</span></span><br><span class="line">                brokerDataMap.get(broker).setLocalData(localData.get());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Initialize BrokerData object for previously unseen</span></span><br><span class="line">                <span class="comment">// brokers.</span></span><br><span class="line">                brokerDataMap.put(broker, <span class="keyword">new</span> <span class="title class_">BrokerData</span>(localData.get()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Error reading broker data from cache for broker - [&#123;&#125;], [&#123;&#125;]&quot;</span>, broker, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Remove obsolete brokers.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> String broker : brokerDataMap.keySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!activeBrokers.contains(broker)) &#123;</span><br><span class="line">            brokerDataMap.remove(broker);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è´Ÿè½½å‡è¡¡å™¨åœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šæŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®ï¼Œç„¶åå†™å…¥åˆ° <code>brokerDataMap</code> ä¸­ã€‚</p><p><img src="https://s2.loli.net/2024/06/12/ASoLedKVlgRbCFO.png"><br>åŒæ—¶ä¹Ÿä¼šæ³¨å†Œç›¸å…³çš„ zookeeper äº‹ä»¶ï¼Œå½“æ³¨å†Œçš„èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆä¸€èˆ¬æ˜¯æ–°å¢æˆ–è€…åˆ å‡äº† broker èŠ‚ç‚¹ï¼‰å°±ä¼šæ›´æ–°å†…å­˜ä¸­ç¼“å­˜çš„è´Ÿè½½æ•°æ®ã€‚</p><p>ä¹‹å leader èŠ‚ç‚¹ä¼šå®šæœŸè°ƒç”¨ <code>org.apache.pulsar.broker.loadbalance.impl.ModularLoadManagerImpl#doLoadShedding</code> å‡½æ•°æŸ¥è¯¢å“ªäº›æ•°æ®éœ€è¦å¸è½½ï¼Œç„¶åè¿›è¡Œé‡æ–°è´Ÿè½½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Multimap&lt;String, String&gt; bundlesToUnload = loadSheddingStrategy.findBundlesForUnloading(loadData, conf);</span><br></pre></td></tr></table></figure><p>æœ€æ ¸å¿ƒçš„å°±æ˜¯è°ƒç”¨è¿™ä¸ª <code>findBundlesForUnloading</code> å‡½æ•°ï¼Œä¼šè¿”å›éœ€è¦å¸è½½ bundle é›†åˆï¼Œæœ€ç»ˆä¼šéå†è¿™ä¸ªé›†åˆè°ƒç”¨ admin API è¿›è¡Œå¸è½½å’Œé‡å¹³è¡¡ã€‚</p><p>è€Œè¿™ä¸ªå‡½æ•°ä¼šæœ‰å¤šç§å®ç°ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æ ¹æ®ä¼ å…¥çš„å„ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼Œç„¶åæ ¹æ®è‡ªå®šä¹‰çš„è§„åˆ™è¿”å›ä¸€æ‰¹éœ€è¦å¸è½½çš„æ•°æ®ã€‚</p><p>ä»¥é»˜è®¤çš„ <code>org.apache.pulsar.broker.loadbalance.impl.ThresholdShedder</code> è§„åˆ™ä¸ºä¾‹ï¼š</p><p><img src="https://s2.loli.net/2024/06/12/hg751LtwZMrUyFb.png"><br>å®ƒæ˜¯æ ¹æ®å¸¦å®½ã€å†…å­˜ã€æµé‡ç­‰å„ä¸ªæŒ‡æ ‡çš„æƒé‡ç®—å‡ºæ¯ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½å€¼ï¼Œä¹‹åä¸ºæ•´ä¸ªé›†ç¾¤è®¡ç®—å‡ºä¸€ä¸ªå¹³å‡è´Ÿè½½å€¼ã€‚</p><p>ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼šè¶…è¿‡ <code>ShedBundles</code> çš„æ•°æ®å°±éœ€è¦è¢«å¸è½½æ‰ï¼Œç„¶åè½¬ç§»åˆ°ä½è´Ÿè½½çš„èŠ‚ç‚¹ä¸­ã€‚</p><p>æ‰€ä»¥æœ€å·¦è¾¹èŠ‚ç‚¹å’Œè¶…å‡ºçš„ bundle éƒ¨åˆ†å°±éœ€è¦è¢«è¿”å›ã€‚</p><p>å…·ä½“çš„è®¡ç®—é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">filterAndSelectBundle</span><span class="params">(LoadData loadData, Map&lt;String, Long&gt; recentlyUnloadedBundles, String broker,</span></span><br><span class="line"><span class="params">                                   LocalBrokerData localData, <span class="type">double</span> minimumThroughputToOffload)</span> &#123;</span><br><span class="line">    <span class="type">MutableDouble</span> <span class="variable">trafficMarkedToOffload</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutableDouble</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="type">MutableBoolean</span> <span class="variable">atLeastOneBundleSelected</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutableBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">    loadData.getBundleDataForLoadShedding().entrySet().stream()</span><br><span class="line">            .map((e) -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">bundle</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">                <span class="type">BundleData</span> <span class="variable">bundleData</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">                <span class="type">TimeAverageMessageData</span> <span class="variable">shortTermData</span> <span class="operator">=</span> bundleData.getShortTermData();</span><br><span class="line">                <span class="type">double</span> <span class="variable">throughput</span> <span class="operator">=</span> shortTermData.getMsgThroughputIn() + shortTermData.getMsgThroughputOut();</span><br><span class="line">                <span class="keyword">return</span> Pair.of(bundle, throughput);</span><br><span class="line">            &#125;).filter(e -&gt;</span><br><span class="line">                    !recentlyUnloadedBundles.containsKey(e.getLeft())</span><br><span class="line">            ).filter(e -&gt;</span><br><span class="line">                    localData.getBundles().contains(e.getLeft())</span><br><span class="line">            ).sorted((e1, e2) -&gt;</span><br><span class="line">                    Double.compare(e2.getRight(), e1.getRight())</span><br><span class="line">            ).forEach(e -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (trafficMarkedToOffload.doubleValue() &lt; minimumThroughputToOffload</span><br><span class="line">                        || atLeastOneBundleSelected.isFalse()) &#123;</span><br><span class="line">                    selectedBundlesCache.put(broker, e.getLeft());</span><br><span class="line">                    trafficMarkedToOffload.add(e.getRight());</span><br><span class="line">                    atLeastOneBundleSelected.setTrue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç é‡Œçœ‹çš„å‡ºæ¥å°±æ˜¯åœ¨ä¸€ä¸ªå¤‡é€‰é›†åˆä¸­æ ¹æ®å„ç§é˜ˆå€¼å’Œåˆ¤æ–­æ¡ä»¶ç­›é€‰å‡ºéœ€è¦å¸è½½çš„ bundleã€‚</p><hr><p>è€Œ <code>SimpleLoadManagerImpl</code> çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (currentLoadReports) &#123;</span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;ResourceUnit, LoadReport&gt; entry : currentLoadReports.entrySet()) &#123;</span><br><span class="line"><span class="type">ResourceUnit</span> <span class="variable">overloadedRU</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line"><span class="type">LoadReport</span> <span class="variable">lr</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line"><span class="comment">// æ‰€æœ‰æ•°æ®åšä¸€ä¸ªç®€å•çš„ç­›é€‰ï¼Œè¶…è¿‡é˜ˆå€¼çš„æ•°æ®éœ€è¦è¢« unload</span></span><br><span class="line"><span class="keyword">if</span> (isAboveLoadLevel(lr.getSystemResourceUsage(), overloadThreshold)) &#123;</span><br><span class="line"><span class="type">ResourceType</span> <span class="variable">bottleneckResourceType</span> <span class="operator">=</span> lr.getBottleneckResourceType();</span><br><span class="line">Map&lt;String, NamespaceBundleStats&gt; bundleStats = lr.getSortedBundleStats(bottleneckResourceType);</span><br><span class="line"><span class="keyword">if</span> (bundleStats == <span class="literal">null</span>) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Null bundle stats for bundle &#123;&#125;&quot;</span>, lr.getName());</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯å¾ˆç®€å•çš„é€šè¿‡å°†åˆ¤æ–­èŠ‚ç‚¹çš„è´Ÿè½½æ˜¯å¦è¶…è¿‡äº†é˜ˆå€¼ <code>isAboveLoadLevel</code>ï¼Œç„¶ååšä¸€ä¸ªç®€å•çš„æ’åºå°±è¿”å›äº†ã€‚</p><p>ä»è¿™é‡Œä¹Ÿçœ‹å¾—å‡ºæ¥ <code>SimpleLoadManagerImpl</code> å’Œ <code>ModularLoadManager</code> çš„åŒºåˆ«ï¼Œ<code>SimpleLoadManagerImpl</code> æ›´ç®€å•ï¼Œå¹¶æ²¡æœ‰æä¾›å¤šä¸ª <code>doLoadShedding</code> çš„ç­›é€‰å®ç°ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ€»çš„æ¥è¯´å¯¹äºæ— çŠ¶æ€çš„æœåŠ¡æ¥è¯´ï¼Œç†è®ºä¸Šæˆ‘ä»¬åªéœ€è¦åšå¥½è´Ÿè½½ç®—æ³•å³å¯ï¼ˆè½®è®­ã€ä¸€è‡´æ€§å“ˆå¸Œã€ä½è´Ÿè½½ä¼˜å…ˆç­‰ï¼‰å°±å¯ä»¥å¾ˆå¥½çš„å¹³è¡¡å„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è´Ÿè½½ã€‚</p><p>è€Œå¯¹äºæœ‰çŠ¶æ€çš„æœåŠ¡æ¥è¯´ï¼Œè´Ÿè½½å‡è¡¡å°±æ˜¯å°†è´Ÿè½½è¾ƒé«˜èŠ‚ç‚¹ä¸­çš„æ•°æ®è½¬ç§»åˆ°è´Ÿè½½ä½çš„èŠ‚ç‚¹ä¸­ã€‚</p><p>å…¶ä¸­çš„å…³é”®å°±æ˜¯éœ€è¦å­˜å‚¨å„ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼ˆä¸šç•Œå¸¸ç”¨çš„æ˜¯å­˜å‚¨åˆ° zookeeper ä¸­ï¼‰ï¼Œç„¶åå†ç”±ä¸€ä¸ª leader èŠ‚ç‚¹ä»è¿™äº›èŠ‚ç‚¹ä¸­æ ¹æ®æŸç§è´Ÿè½½ç®—æ³•é€‰æ‹©å‡ºè´Ÿè½½è¾ƒé«˜çš„èŠ‚ç‚¹ä»¥åŠè´Ÿè½½è¾ƒä½çš„èŠ‚ç‚¹ï¼Œæœ€ç»ˆæŠŠæ•°æ®è¿ç§»è¿‡å»å³å¯ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;Pulsar æœ‰æä¾›ä¸€ä¸ªæŸ¥è¯¢ Broker è´Ÿè½½çš„æ¥å£ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     * Get load for this broker.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     *&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     * &lt;span class=&quot;doctag&quot;&gt;@return&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     * &lt;span class=&quot;doctag&quot;&gt;@throws&lt;/span&gt; PulsarAdminException&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LoadManagerReport &lt;span class=&quot;title function_&quot;&gt;getLoadReport&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; PulsarAdminException;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;LoadManagerReport&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;ServiceLookupData&lt;/span&gt; &amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ResourceUsage &lt;span class=&quot;title function_&quot;&gt;getCpu&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ResourceUsage &lt;span class=&quot;title function_&quot;&gt;getMemory&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ResourceUsage &lt;span class=&quot;title function_&quot;&gt;getDirectMemory&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ResourceUsage &lt;span class=&quot;title function_&quot;&gt;getBandwidthIn&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ResourceUsage &lt;span class=&quot;title function_&quot;&gt;getBandwidthOut&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;å¯ä»¥è¿”å›ä¸€äº› broker çš„è´Ÿè½½æ•°æ®ï¼Œæ¯”å¦‚ CPUã€å†…å­˜ã€æµé‡ä¹‹ç±»çš„æ•°æ®ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="Pulsar" scheme="http://crossoverjie.top/categories/OB/Pulsar/"/>
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/tags/Pulsar/"/>
    
  </entry>
  
  <entry>
    <title>ğŸ‰æˆ‘æ˜¯å¦‚ä½•ä»é›¶åˆ°æˆä¸º Apache é¡¶çº§é¡¹ç›®çš„ Committer</title>
    <link href="http://crossoverjie.top/2024/07/11/ob/%F0%9F%8E%89how-to-be-committer/"/>
    <id>http://crossoverjie.top/2024/07/11/ob/%F0%9F%8E%89how-to-be-committer/</id>
    <published>2024-07-11T15:45:32.000Z</published>
    <updated>2024-07-11T15:46:29.320Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2024/07/07/bj8NHqYFegTx1WU.png" alt="image.png"><br><img src="https://s2.loli.net/2024/07/07/a86fbuopri9mDeS.png"></p><p>æœ€è¿‘æ”¶åˆ°äº† <a href="https://github.com/apache/pulsar/">Apache Pulsar</a> å’Œ <a href="https://github.com/apache/hertzbeat/">Apache HertzBeat</a>ç¤¾åŒºçš„é‚€è¯·é‚®ä»¶ï¼Œæˆä¸ºäº†è¿™ä¸¤ä¸ªé¡¹ç›®çš„ <code>Committer</code>ã€‚</p><span id="more"></span><p>ä¸€è·¯èµ°æ¥æˆ‘ä»æœ€å¼€å§‹çš„æ‰“æ¸¸å‡»æˆ˜çš„é—²æ•£äººå‘˜åˆ°å¦‚ä»Šæ´»è·ƒåœ¨å„ä¸ªå¼€æºé¡¹ç›®é‡Œçš„â€œè€å…µâ€ï¼Œç”¨ç°åœ¨æµè¡Œçš„è¯æ¥è¯´ <code>Apache</code> çš„è¿™ä¸¤ä¸ª <code>Committer</code> å°±ç›¸å½“äºæ˜¯æ‹¿åˆ°äº†ç¼–åˆ¶ï¼Œè¿›å…¥äº†æ­£è§„å†›ã€‚</p><p>ä¸‹é¢å°±åˆ†äº«ä¸€ä¸‹æˆ‘çš„ä¸ªäººå¼€æºç»å†ï¼Œå¸Œæœ›å¯¹æƒ³è¦å‚ä¸å¼€æºæˆ–è€…å·²ç»åœ¨å…¶ä¸­çš„å¼€å‘è€…æœ‰æ‰€å¸®åŠ©ã€‚</p><h1 id="æˆ‘çš„-GitHub-å¼€æºæ•…äº‹"><a href="#æˆ‘çš„-GitHub-å¼€æºæ•…äº‹" class="headerlink" title="æˆ‘çš„ GitHub å¼€æºæ•…äº‹"></a>æˆ‘çš„ GitHub å¼€æºæ•…äº‹</h1><h2 id="åˆè¯†-GitHub"><a href="#åˆè¯†-GitHub" class="headerlink" title="åˆè¯† GitHub"></a>åˆè¯† GitHub</h2><p><img src="https://s2.loli.net/2024/07/08/CylX9TKcQY12MWI.png"><br>æˆ‘è¿™ä¸ª <code>Github</code> è´¦å·æ˜¯åœ¨ 15 å¹´ 9æœˆä»½æ³¨å†Œçš„ï¼Œé‚£æ—¶å€™åˆšå‡ºæ¥å‚ä¸å·¥ä½œã€‚</p><p>å…¶å®åœ¨è¿™ä¹‹å‰æˆ‘å‹æ ¹æ²¡æœ‰å¬è¯´è¿‡ GitHubã€å¯¹å¼€æºä¹Ÿæ˜¯çŸ¥ä¹‹ç”šå°‘ï¼›åªæ˜¯çŸ¥é“è€å¸ˆå’ŒåŒäº‹ç»å¸¸è®©æˆ‘åœ¨ç½‘ä¸Šå¯ä»¥ä¸‹è½½åˆ°ä¸€äº›ç¬¬ä¸‰æ–¹åŒ…ï¼ˆç°åœ¨å›æƒ³èµ·æ¥å‡ ä¹éƒ½æ˜¯å¥½ Apache çš„æä¾›çš„åŒ…ï¼‰æ¥è§£å†³æ—¥å¸¸çš„ä¸€äº›å¸¸è§éœ€æ±‚ã€‚</p><p>å½“æ—¶åªæ˜¯è§‰å¾—éå¸¸æ–¹ä¾¿ï¼Œæ²¡æƒ³åˆ°å¤§éƒ¨åˆ†çš„å·¥ä½œäº’è”ç½‘ä¸Šéƒ½æœ‰ç›¸å…³çš„è§£å†³æ–¹æ¡ˆã€‚</p><p>ç›´åˆ°ç¬¬äºŒå¹´ä¹Ÿå°±æ˜¯ 16 å¹´æˆ‘æ‰æäº¤ç¬¬ä¸€è¡Œä»£ç ï¼Œè®°å¾—å½“æ—¶æ˜¯éœ€è¦å’ŒåŒå­¦å…±äº«ä¸€äº›ä»£ç ã€‚</p><p>åœ¨å­¦æ ¡çš„æ—¶å€™å¤§å®¶éƒ½æ˜¯æŠŠæ–‡ä»¶æ‰“åŒ…ç„¶åé€šè¿‡ QQ å‘é€çš„ï¼Œå› ä¸ºæˆ‘ä¹‹å‰åœ¨ GitHub ä¸Šçœ‹åˆ°å¤§å®¶éƒ½æ˜¯æŠŠæºç å…¬å¼€çš„ï¼Œæ‰€ä»¥å½“æ—¶çš„æƒ³æ³•æ˜¯ä¸æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨ GitHub æŠŠä»£ç å‘ç»™åŒå­¦ï¼Œè¿™æ ·å°±çœå»äº†æ‰“åŒ…è§£å‹çš„æ­¥éª¤äº†ã€‚</p><blockquote><p>ç°åœ¨æƒ³æƒ³è¿˜å¥½éƒ½æ˜¯ä¸€äº›éä¸šåŠ¡ä»£ç ï¼Œä¸ç„¶å°±è¿åå…¬å¸å®‰å…¨è§„å®šäº†ã€‚</p></blockquote><p>æ‰€ä»¥å…¶å®è‡ªå·±æ²¡æœ‰ä»»ä½•å¼€æºçš„æ¦‚å¿µï¼Œåªæ˜¯è§‰å¾—åˆ†äº«ä»£ç å¾ˆæ–¹ä¾¿ã€‚</p><p>åç»­åœ¨ç½‘ä¸Šçœ‹äº† <code>RichardÂ Matthew Stallman</code> å‘èµ·çš„<a href="https://zh.wikipedia.org/zh-hans/%E8%87%AA%E7%94%B1%E8%BD%AF%E4%BB%B6%E8%BF%90%E5%8A%A8">è‡ªç”±è½¯ä»¶è¿åŠ¨</a>æ‰å¯¹å¼€æºçš„ç”±æ¥æœ‰äº†æ›´å¤šçš„è®¤è¯†ï¼Œä¹Ÿè¶Šå‘ä½©æœè¿™äº›å‚ä¸å¼€æºçš„å¤§ä½¬ä»¬ã€‚</p><h2 id="æ‰˜ç®¡-Blog"><a href="#æ‰˜ç®¡-Blog" class="headerlink" title="æ‰˜ç®¡ Blog"></a>æ‰˜ç®¡ Blog</h2><p><img src="https://s2.loli.net/2024/07/08/zhYcH9RmxkpWEA2.png" alt="image.png"><br><img src="https://s2.loli.net/2024/07/08/Cv86gmrlhxoDqBK.png" alt="image.png"></p><p>å½“æ—¶è¿˜éå¸¸æµè¡Œåœ¨ GitHub ä¸Šæ­å»ºä¸ªäººåšå®¢ï¼Œæˆ‘è‡ªç„¶ä¹Ÿè·Ÿä¸Šäº†è¿™ä¸ªæ½®æµï¼›ç›´åˆ°ç°åœ¨ä¹Ÿæ²¡æœ‰æ–­æ›´ã€‚<br>é™†ç»­å†™äº† 240+ ç¯‡åšå®¢ã€‚</p><blockquote><p>è®°å¾—å½“æ—¶æœ€å–œæ¬¢å¹²çš„äº‹å°±æ˜¯æŠ˜è…¾å„ç§ä¸»é¢˜ï¼Œå¯ä»¥åœ¨ GitHub å…è´¹æ‰˜ç®¡ä¸€ä¸ªåšå®¢ï¼Œå¯¹å½“æ—¶çš„æˆ‘ä¹Ÿæ˜¯éœ‡æ’¼è›®å¤§çš„ã€‚</p></blockquote><p>å…³äºåšå®¢çš„è¯é¢˜è¿˜æœ‰ä¸å°‘å†…å®¹å¯ä»¥è®²ï¼Œæ”¾åˆ°åé¢ç»§ç»­åˆ†äº«ã€‚</p><h2 id="æäº¤ç¬¬ä¸€ä¸ªé¡¹ç›®"><a href="#æäº¤ç¬¬ä¸€ä¸ªé¡¹ç›®" class="headerlink" title="æäº¤ç¬¬ä¸€ä¸ªé¡¹ç›®"></a>æäº¤ç¬¬ä¸€ä¸ªé¡¹ç›®</h2><p><img src="https://s2.loli.net/2024/07/08/NtExsU8Z2ryWdzT.png"><br>å› ä¸ºå½“æ—¶åœ¨å…¬å¸åˆšå¼€å§‹æ¥è§¦åˆ° SSM(spring+springmvc+mybatis)ï¼Œæ‰€ä»¥å°±æƒ³æŠŠæ—¥å¸¸å­¦åˆ°çš„ä¸œè¥¿æ²‰æ·€ä¸‹æ¥ã€‚</p><p>äºæ˜¯å°±æŠŠä¸€äº›éä¸šåŠ¡ä»£ç æ•´ç†åæäº¤äº†ç¬¬ä¸€ä¸ªé¡¹ç›®ï¼Œä»¥æ›´æ–°åšå®¢çš„æ–¹å¼é™†ç»­æ›´æ–°äº†å„ç§è§£å†³æ–¹æ¡ˆï¼š<br><img src="https://s2.loli.net/2024/07/08/BITYfjNS7oaEpJl.png"><br>è‡³ä»Šå·²ç»å…¨éƒ¨æ›´æ–°å®Œæ¯•ï¼Œæ‰€ä»¥æˆ‘å°±å°†å®ƒå½’æ¡£äº†ã€‚</p><p>è¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ­£å„¿å…«ç»åšå¼€æºé¡¹ç›®ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿç»“å®åˆ°äº†ä¸å°‘æœ‹å‹ï¼Œæ²‰æ·€äº†è®¸å¤šå†…å®¹ï¼›å¯¹äºåˆšå·¥ä½œä¸€ä¸¤å¹´çš„æˆ‘æ¥è¯´æ„ä¹‰è¿˜æ˜¯å¾ˆé‡å¤§çš„ã€‚</p><h1 id="å‚ä¸æ­£è§„å†›-Apache"><a href="#å‚ä¸æ­£è§„å†›-Apache" class="headerlink" title="å‚ä¸æ­£è§„å†›(Apache)"></a>å‚ä¸æ­£è§„å†›(Apache)</h1><p>æ—¶é—´ç‚¹å›åˆ°ç°åœ¨ï¼Œå› ä¸ºå·¥ä½œåŸå› æˆ‘éœ€è¦åœ¨å…¬å¸å†…éƒ¨ç»´æŠ¤ Pulsar æ¶ˆæ¯é˜Ÿåˆ—ï¼›å½“æ—¶ Pulsar åœ¨å…¬å¸è¿˜æœ‰ç€ä¸€äº›ç»†ææœ«èŠ‚çš„é—®é¢˜éœ€è¦è§£å†³ã€‚</p><p>åœ¨è§£å†³è¿™äº›é—®é¢˜çš„è¿‡ç¨‹ä¸­å°±æƒ³ç€çœ‹èƒ½ä¸èƒ½ç»™ç¤¾åŒºè´¡çŒ®äº›ä»£ç ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æ›´ç†Ÿæ‚‰æ•´ä¸ªé¡¹ç›®ã€‚</p><blockquote><p>å…¶å® 20 å¹´å·¦å³åœ¨ä¹‹å‰çš„å…¬å¸å°±æœ‰ä½¿ç”¨ Pulsarï¼Œåªæ˜¯å½“æ—¶è¿˜æ²¡æœ‰æ„è¯†åˆ°è¦å‘ç¤¾åŒºè´¡çŒ®ä»£ç ã€‚</p></blockquote><p>äºæ˜¯æˆ‘å…ˆå°è¯•åšä¸€äº›æ— å…³ç´§è¦çš„ä¿®æ”¹ï¼š<br><img src="https://s2.loli.net/2024/07/08/WLkOP5KhvBHmg7E.png"><br>å› ä¸ºè¿™ä¸ªè¿˜è¢«å¤§ä½¬æ‹’è¿‡å‡ ä¸ª PRï¼Œä¸æ­¤åŒæ—¶æˆ‘ä¹Ÿåœ¨æŒç»­è¾“å‡ºä¸€ä¸ª Pulsar ç›¸å…³çš„åšå®¢ï¼Œå½“æ—¶ä¹Ÿå¾—åˆ°äº†å¤§ä½¬çš„è®¤å¯ï¼š<br><img src="https://s2.loli.net/2024/07/08/spUaV8yPZMYbHAe.png"></p><p>ä¹‹åæˆ‘åˆæ ¹æ®æ—¥å¸¸å·¥ä½œä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜æˆ–è€…ä¼˜åŒ–æŒç»­ç»™ç¤¾åŒºæäº¤ PRï¼š<br><img src="https://s2.loli.net/2024/07/08/LPQ2RSHNotfJclY.png"></p><p>è¿™ä¸ªè¿‡ç¨‹ä»ç¬¬ä¸€ä¸ª PR åˆ°ç¤¾åŒºå¤§ä½¬æåæˆ‘å¤§æ¦‚ç»å†äº†ä¸€å¹´åŠçš„æ—¶é—´ã€‚</p><p>è¶Šå¤§å‹ã€ä¸¥è°¨çš„é¡¹ç›®åœ¨å¤„ç†è¿™äº› PR æ—¶å°±æ˜¯ç¼“æ…¢çš„ï¼Œæ‰€ä»¥å¦‚æœä½ çœŸçš„æƒ³æ·±åº¦å‚ä¸æŸä¸ªé¡¹ç›®æ—¶å°±ä¸€å®šè¦æœ‰å……åˆ†çš„è€å¿ƒã€‚</p><p>é¦–å…ˆåšæŒä¸‹å»ï¼Œæ”¶è·è‡ªç„¶å°±æ¥äº†ã€‚</p><hr><h3 id="Apache-HertzBeat"><a href="#Apache-HertzBeat" class="headerlink" title="Apache HertzBeat"></a>Apache HertzBeat</h3><p>ä»Šå¹´å››æœˆä»½çš„æ—¶å€™æˆ‘åœ¨æœ‹å‹åœˆè¿˜çœ‹åˆ°å¦å¤–ä¸€ä¸ªé¡¹ç›®ï¼š<a href="https://github.com/apache/hertzbeat">Apache HertzBeat</a>ã€‚</p><p>å› ä¸ºå½“æ—¶æˆ‘ä¹Ÿåœ¨åšä¸€äº›å¯è§‚æµ‹æ€§çš„å†…å®¹ï¼Œæ­£å¥½è¿™ä¸ªé¡¹ç›®æ˜¯å’Œç›‘æ§ç›¸å…³çš„ï¼›äºæ˜¯æˆ‘å°±è·Ÿç€æ–‡æ¡£èµ°äº†ä¸€éã€‚</p><p>å‘ç°åŠŸèƒ½å¾ˆå¼ºä¹Ÿå¾ˆå…¨ï¼Œå½“æ—¶ä¹Ÿæ˜¯åˆšåŠ å…¥ Apache çš„å­µåŒ–å™¨ï¼Œæ‰€ä»¥è¿˜æ˜¯æœ‰è®¸å¤šå¯ä»¥å®Œå–„çš„åœ°æ–¹ã€‚</p><p>æˆ‘å°±å¼€å§‹ä»¥å•æµ‹ä½œä¸ºåˆ‡å…¥ç‚¹å°è¯•è´¡çŒ®æºç ï¼Œç¤¾åŒºçš„å“åº”é€Ÿåº¦ä¹Ÿéå¸¸å¿«ã€‚</p><p>ä¹‹åé€æ¸å°†æˆ‘åœ¨å…¶ä»–ç¤¾åŒºå­¦åˆ°ä¸€äº›ç»éªŒä¹Ÿå¤åˆ¶åˆ° HertzBeat ä¸­ï¼Œæ…¢æ…¢çš„è´¡çŒ®çš„ä»£ç è¶Šå¤šï¼Œå¯¹ HertzBeat ä¹Ÿå°±æ›´åŠ ç†Ÿæ‚‰äº†ã€‚</p><p>ä¸¤ä¸ªå¤šæœˆçš„æ—¶é—´æˆ‘è´¡çŒ®äº† 30 ä¸ªå·¦å³çš„ PRï¼Œåæ¥ä¹Ÿå—åˆ°é¡¹ç›®å‘èµ·è€…çš„é‚€è¯·ï¼š<br><img src="https://s2.loli.net/2024/07/08/L9SI6rO17TxkDaH.png" alt="image.png"></p><p>å› ä¸ºæ˜¯ç›¸å¯¹æ›´å¹´è½»çš„é¡¹ç›®ï¼Œæ‰æ›´éœ€è¦å¤§å®¶ç¾¤ç­–ç¾¤åŠ›ï¼›æ‰€ä»¥å¦‚æœä½ ä¹Ÿå¯¹ç›‘æ§ç³»ç»Ÿæ„Ÿå…´è¶£ï¼Œæˆ–è€…æ¯”è¾ƒç†Ÿæ‚‰å‰ç«¯æŠ€æœ¯æ ˆï¼ˆHertzBeat æœ‰åå°ç®¡ç†ç•Œé¢ï¼‰éƒ½æ¬¢è¿å‰æ¥è´¡çŒ®ï¼Œåç»­è·å¾—æåçš„æœºä¼šè¦æ¯”å·²ç»å‘å±•ç¨³å®šçš„é¡¹ç›®æ›´å¤§ä¸€äº›ã€‚</p><h1 id="æˆä¸º-Committer-çš„å¥½å¤„"><a href="#æˆä¸º-Committer-çš„å¥½å¤„" class="headerlink" title="æˆä¸º Committer çš„å¥½å¤„"></a>æˆä¸º Committer çš„å¥½å¤„</h1><p>è®²åˆ°è¿™é‡Œé¡ºä¾¿å†è®²è®²æˆä¸º  Committer çš„ä¸€äº›å¥½å¤„äº†ï¼Œè™½ç„¶å¼€æºç»å¸¸å’Œå…è´¹ç™½å«–åˆ’ç­‰å·ï¼Œå¤§éƒ¨åˆ†äººéƒ½æ˜¯ç”¨çˆ±å‘ç”µçš„ï¼Œä½†å› ä¸ºä¹Ÿæœ‰è®¸å¤šå¤§å…¬å¸å¾—åˆ°äº†å¼€æºçš„å¥½å¤„ï¼Œæ‰€ä»¥ä¹Ÿç»™æ´»è·ƒåœ¨ç¤¾åŒºé‡Œçš„è´¡çŒ®è€…æä¾›äº†ä¸€äº›å…è´¹ç¦åˆ©ã€‚</p><p>å½“ç„¶è¦æ‹¿åˆ°è¿™äº›ç¦åˆ©è‚¯å®šæ˜¯å¾—æœ‰ä¸€ä¸ªè¯„åˆ¤æ ‡å‡†ï¼Œæœ€ç®€å•ä¹Ÿæœ€ç›´è§‚çš„å°±æ˜¯ä½ æ˜¯å¦å·²ç»æ˜¯ Apache ç»„ç»‡çš„ Committerã€‚</p><h2 id="Github-Copilot"><a href="#Github-Copilot" class="headerlink" title="Github Copilot"></a>Github Copilot</h2><p>é¦–å…ˆç¬¬ä¸€ä¸ªå¥½å¤„æ˜¯æä¾›å…è´¹ä¸ªäººä½¿ç”¨ Copilotï¼Œå½“ç„¶è¿™ä¸å…¨æ˜¯ Committer çš„æƒç›Šï¼Œå¦‚æœä½ æ˜¯æŸä¸ªå¼€æºé¡¹ç›®çš„æ´»è·ƒè´¡çŒ®è€…ä¹Ÿæ˜¯å¯ä»¥ç”³è¯·çš„ï¼ˆä¸ä¸€å®šèƒ½ç”³è¯·è¿‡ï¼Œç›®å‰å¥½åƒæ²¡çœ‹åˆ°é€šè¿‡çš„æ ‡å‡†ï¼‰ï¼Œåªæ˜¯å·²ç»æ˜¯ Committer åè‚¯å®šæ˜¯èƒ½äº«å—è¿™ä¸ªæƒç›Šã€‚</p><h2 id="Jetbrains-å…¨å®¶æ¡¶-IDE"><a href="#Jetbrains-å…¨å®¶æ¡¶-IDE" class="headerlink" title="Jetbrains å…¨å®¶æ¡¶ IDE"></a>Jetbrains å…¨å®¶æ¡¶ IDE</h2><p><img src="https://s2.loli.net/2024/07/08/kc9Ovp1u7M4DxWE.png"></p><p>JB ä½œä¸ºä¸€ä¸ªå’Œå¼€å‘è€…å¼ºç»‘å®šçš„å…¬å¸ï¼Œä¹Ÿæä¾›äº†å¯¹åº”çš„ç¦åˆ©ï¼Œåªè¦ä½¿ç”¨ Apache çš„é‚®ç®±å°±å¯ä»¥å…è´¹ä½¿ç”¨ä»–ä»¬çš„å…¨å®¶æ¡¶ã€‚</p><h2 id="Apache-é‚®ç®±"><a href="#Apache-é‚®ç®±" class="headerlink" title="Apache é‚®ç®±"></a>Apache é‚®ç®±</h2><p>æåˆ°äº†é‚®ç®±é‚£å°±ä¸å¾—ä¸æåˆ° Apache ç»™æ¯ä¸ª Committer éƒ½ä¼šæä¾›ä¸€ä¸ªä¸“å±é‚®ç®±ï¼š<br><img src="https://s2.loli.net/2024/07/08/TQVkIhbUcAtpfCX.png"><br>è™½ç„¶å¸‚é¢ä¸Šæœ‰å„ç§çš„å…è´¹é‚®ç®±æ³¨å†ŒæœåŠ¡ï¼Œä½†å½“ä½ ä½¿ç”¨ Apache çš„é‚®ç®±å’Œå…¶ä»–äººæ²Ÿé€šäº¤æµæ—¶ï¼Œå¤§æ¦‚ç‡å¯¹æ–¹æ½œæ„è¯†é‡Œéƒ½ä¼šå¯¹ä½ é«˜çœ‹ä¸€ç‚¹ã€‚</p><p>è¿™è™½ç„¶æ˜¯ä¸€äº›è™šæ— ç¼¥ç¼ˆçš„ä¸œè¥¿ï¼Œä½†æœ‰æ—¶å€™å°±æ˜¯ä¼šè®©æ²Ÿé€šæ›´åŠ é¡ºç•…ï¼ˆæ¯”å¦‚æ±‚èŒé¢è¯•æ—¶ï¼‰ã€‚</p><h2 id="é¡¹ç›®çš„å†™æƒé™"><a href="#é¡¹ç›®çš„å†™æƒé™" class="headerlink" title="é¡¹ç›®çš„å†™æƒé™"></a>é¡¹ç›®çš„å†™æƒé™</h2><p>è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯æœ‰äº†é¡¹ç›®çš„å†™æƒé™ï¼Œå½“ä½ å‚ä¸è¿‡å¼€æºé¡¹ç›®å°±çŸ¥é“è¿™ä¸ªçš„é‡è¦æ€§äº†ï¼Œæœ‰äº›æ—¶å€™ä¸€äº› PR è¿Ÿè¿Ÿå¾—ä¸åˆ°å›å¤å’Œåˆå¹¶ï¼Œè‡ªå·±åªèƒ½å¹²ç€æ€¥ã€‚</p><p>æœ‰äº†è¿™ä¸ªæƒé™ä¹‹åï¼Œåªè¦ä½ çš„ PR æœ‰äºº <code>Approve</code> ä¹‹åï¼Œåœ¨é£é™©å¯æ§çš„æƒ…å†µä¸‹ä¸ç”¨ç­‰ç€ maintainer æ¥åˆå¹¶ï¼Œè‡ªå·±å°±å¯ä»¥æ“ä½œã€‚</p><p>åŒæ—¶å¾—ç›Šäºåœ¨ç¤¾åŒºçš„æ´»è·ƒç¨‹åº¦ï¼Œä½ å†æäº¤åˆ° PR ä¼šæ›´å¾—åˆ°é‡è§†ï¼ŒåŒæ—¶ä¹Ÿèƒ½æ›´å¥½çš„æ¨è¿›æŸäº› featureï¼›è¿™å¯¹äºä¾èµ–æŸä¸ªå¼€æºé¡¹ç›®çš„å…¬å¸æ¥è¯´å—ç›Šéå¸¸å¤§ã€‚</p><h1 id="Apache-è´¡çŒ®é˜¶æ¢¯"><a href="#Apache-è´¡çŒ®é˜¶æ¢¯" class="headerlink" title="Apache è´¡çŒ®é˜¶æ¢¯"></a>Apache è´¡çŒ®é˜¶æ¢¯</h1><p>ç›¸ä¿¡çœ‹åˆ°è¿™é‡Œåº”è¯¥æœ‰ä¸å°‘äººå¯¹æˆä¸º Apache Committer æ„Ÿå…´è¶£äº†ï¼Œä¹Ÿæ¯”è¾ƒå¥½å¥‡ä»€ä¹ˆæ ·çš„æ ‡å‡†æ‰èƒ½æˆä¸º Committerã€‚</p><p>ä»¥ä¸‹æ˜¯æˆ‘æ ¹æ®ä¸€äº›å·²ç»æ˜¯ Committer çš„å¤§ä½¬å’Œ Apache å®˜æ–¹ç»™çš„ä¸€ä¸ªè´¡çŒ®é˜¶æ¢¯ä½œä¸ºå‚è€ƒæ€»ç»“å‡ºæ¥çš„ã€‚</p><p><img src="https://s2.loli.net/2024/07/08/tlEuhMR85AmLasn.png"></p><p>å‚ä¸å¼€æºçš„äººä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§è§’è‰²ï¼š</p><ul><li>æ™®é€šç”¨æˆ·</li><li>è´¡çŒ®è€…</li><li>Committer</li><li>PMC é¡¹ç›®ç®¡ç†äººå‘˜</li><li>åŸºé‡‘ä¼šç®¡ç†äººå‘˜</li><li>åŸºé‡‘ä¼šè‘£äº‹</li></ul><p>æ•´ä¸ªè·¯å¾„è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œåªæ˜¯ä» PMC å¼€å§‹åˆ°åé¢çš„è‘£äº‹éš¾åº¦éƒ½æ˜¯æŒ‡æ•°çº§å¢åŠ ã€‚</p><blockquote><p>ç›®å‰æ•´ä¸ªå›½å†…å½“é€‰è¿‡è‘£äº‹çš„éƒ½æ˜¯å±ˆæŒ‡å¯æ•°ã€‚</p></blockquote><p>è€Œå…³äºæˆä¸º Committer çš„è¦æ±‚æŸäº›ç¤¾åŒºä¼šæœ‰æ˜æ˜¾çš„æ ‡å‡†ï¼š<br><img src="https://s2.loli.net/2024/07/08/qdfeaXc6gRlF5tN.png"></p><p>å½“ç„¶è¿™ä¸ªæ ‡å‡†ä¹Ÿä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œåªè¦æŒç»­çš„åœ¨ç¤¾åŒºæ´»è·ƒï¼Œæœ‰è„¸ç†Ÿä¹‹åè‡ªç„¶ä¼šæœ‰ç›¸å…³çš„ PMC ä¸ºä½ æåï¼›å½“ç„¶è¿™é‡Œçš„å‰ææ¡ä»¶éƒ½æ˜¯â€œæŒç»­æ´»è·ƒâ€ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ€åå†æ€»ç»“ä¸‹ï¼Œä¸ºçˆ±å‘ç”µçš„å¼€æºé¡¹ç›®ä¹Ÿæ˜¯å¯ä»¥è·å¾—å›æŠ¥çš„ï¼›ç‰¹åˆ«æ˜¯å½“ä½ åˆå¹¶ä¸€ä¸ª PR è¿›å…¥æŸä¸ªé¡¹ç›®æ—¶å¸¦æ¥çš„æ„‰æ‚¦æ„Ÿéå¸¸å¼ºçƒˆã€‚</p><p>éšç€æ—¶é—´æ¨è¿›ï¼Œåœ¨ä¹‹ååˆå¹¶çš„ PR å¯èƒ½æ²¡æœ‰å‰å‡ æ¬¡é‚£ä¹ˆå¼ºçƒˆï¼Œä½†åªè¦è¾¾åˆ°ä¸€ä¸ªèŒƒå›´ï¼Œç¤¾åŒºå¼€å§‹æåä½ ä¸º Committer æ—¶ï¼Œè¿™ä¸ªå¤šå·´èƒºåˆä¼šæŒç»­åˆ†æ³Œã€‚</p><p>åŒæ ·çš„åç»­æˆä¸º PMCã€ç®¡ç†äººå‘˜ã€è‘£äº‹åˆä¼šæŒç»­å¸¦æ¥æ„‰æ‚¦ï¼Œå½“ç„¶éš¾åº¦ä¹Ÿä¸€ä¸ªæ¯”ä¸€ä¸ªå¤§ã€‚</p><p>åé¢çš„å±‚çº§ç¦»æˆ‘è¿˜å¾ˆè¿œï¼Œå¦‚æœä»Šåæœ‰è¾¾åˆ°çš„ä¸€å¤©å†æ¥å’Œå¤§å®¶åˆ†äº«ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://community.apache.org/contributor-ladder.html">https://community.apache.org/contributor-ladder.html</a></li><li><a href="https://hertzbeat.apache.org/zh-cn/docs/community/become_committer">https://hertzbeat.apache.org/zh-cn/docs/community/become_committer</a></li><li><a href="https://zh.wikipedia.org/wiki/%E8%87%AA%E7%94%B1%E8%BD%AF%E4%BB%B6%E8%BF%90%E5%8A%A8">https://zh.wikipedia.org/wiki/%E8%87%AA%E7%94%B1%E8%BD%AF%E4%BB%B6%E8%BF%90%E5%8A%A8</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/07/07/bj8NHqYFegTx1WU.png&quot; alt=&quot;image.png&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/07/07/a86fbuopri9mDeS.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æœ€è¿‘æ”¶åˆ°äº† &lt;a href=&quot;https://github.com/apache/pulsar/&quot;&gt;Apache Pulsar&lt;/a&gt; å’Œ &lt;a href=&quot;https://github.com/apache/hertzbeat/&quot;&gt;Apache HertzBeat&lt;/a&gt;ç¤¾åŒºçš„é‚€è¯·é‚®ä»¶ï¼Œæˆä¸ºäº†è¿™ä¸¤ä¸ªé¡¹ç›®çš„ &lt;code&gt;Committer&lt;/code&gt;ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
  </entry>
  
  <entry>
    <title>âœ…å¼€æºé¡¹ç›®å¦‚ä½•åšé›†æˆæµ‹è¯•</title>
    <link href="http://crossoverjie.top/2024/07/09/ob/%E2%9C%85%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%A6%82%E4%BD%95%E5%81%9A%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95/"/>
    <id>http://crossoverjie.top/2024/07/09/ob/%E2%9C%85%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%A6%82%E4%BD%95%E5%81%9A%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95/</id>
    <published>2024-07-09T03:15:25.000Z</published>
    <updated>2024-07-09T03:16:37.821Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰æœ‰æœ‹å‹é—®å¦‚ä½•åšé›†æˆæµ‹è¯•ï¼Œä»Šå¤©å°±é‡ç‚¹è®²è®²è¿™ä¸ªé›†æˆæµ‹è¯•åœ¨å¼€æºé¡¹ç›®ä¸­æ˜¯å¦‚ä½•åšçš„ã€‚</p><p>é€šå¸¸æ˜¯éœ€è¦å¯¹å¤–æä¾›æœåŠ¡çš„å¼€æºé¡¹ç›®éƒ½éœ€è¦é›†æˆæµ‹è¯•ï¼š</p><ul><li>Pulsar</li><li>Kafka</li><li>Dubbo ç­‰<span id="more"></span></li></ul><p>è€Œåªæä¾›æœ¬åœ°ç±»åº“çš„é¡¹ç›®é€šå¸¸åªéœ€è¦ç¼–å†™å•å…ƒæµ‹è¯•å³å¯ï¼š</p><ul><li>Hutool</li><li>Apache Commmon</li></ul><p>ä»¥æˆ‘æ¥è§¦åˆ°çš„æœåŠ¡å‹åº”ç”¨ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ä¸ªæ˜¯ Java åº”ç”¨ä¸€ä¸ªæ˜¯ Golang åº”ç”¨ã€‚</p><h1 id="ğŸ³Golang"><a href="#ğŸ³Golang" class="headerlink" title="ğŸ³Golang"></a>ğŸ³Golang</h1><p>Golang å› ä¸ºå·¥å…·é“¾æ²¡æœ‰ Java é‚£ä¹ˆå¼ºå¤§ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†çš„é›†æˆæµ‹è¯•çš„åŠŸèƒ½éƒ½æ˜¯é€šè¿‡ç¼–å†™ Makefile å’Œ shell è„šæœ¬å®ç°çš„ã€‚</p><p>è¿˜æ˜¯ä»¥æˆ‘ç†Ÿæ‚‰çš„ Pulsar çš„ go-client ä¸ºä¾‹ï¼Œå®ƒåœ¨ GitHub çš„é›†æˆæµ‹è¯•æ˜¯é€šè¿‡ GitHub action è§¦å‘çš„ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/05/20/f2196pujo8m7KRe.png"><br>æœ€ç»ˆè°ƒç”¨çš„æ˜¯ Makefile ä¸­çš„ test å‘½ä»¤ï¼Œå¹¶ä¸”æŠŠéœ€è¦æµ‹è¯•çš„ Golang ç‰ˆæœ¬ä¼ å…¥è¿›å»ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/YpwtSHnLXqU1xQj.png"></p><p><code>Dockerfile</code>ï¼š<br><img src="https://s2.loli.net/2024/05/20/1ySGWF46U7EC2rk.png"></p><p>è¿™ä¸ªé•œåƒç®€å•æ¥è¯´å°±æ˜¯å°† Pulsar çš„é•œåƒä½œä¸ºåŸºç¡€è¿è¡Œé•œåƒï¼ˆè¿™é‡Œé¢åŒ…å«äº† Pulsar çš„æœåŠ¡ç«¯ï¼‰ï¼Œç„¶åå°†è¿™ä¸ª pulsar-client-go çš„ä»£ç å¤åˆ¶è¿›å»ç¼–è¯‘ã€‚</p><p>æ¥ç€è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /pulsar/pulsar-client-go &amp;&amp; ./scripts/run-ci.sh</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯æµ‹è¯•è„šæœ¬ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/2Afmdu8ozRvH9FC.png"></p><p>æµ‹è¯•è„šæœ¬çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼š</p><ul><li>å¯åŠ¨ pulsar æœåŠ¡ç«¯</li><li>è¿è¡Œæµ‹è¯•ä»£ç <br>å› ä¸ºæ‰€æœ‰çš„æµ‹è¯•ä»£ç é‡Œè¿æ¥æœåŠ¡ç«¯çš„åœ°å€éƒ½æ˜¯ <code>localhost</code>ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿æ¥ã€‚<br><img src="https://s2.loli.net/2024/05/20/C1RHxTkuz25Mlj8.png"></li></ul><p>é€šè¿‡è¿™é‡Œçš„ <a href="https://github.com/apache/pulsar-client-go/actions/runs/9014510238/job/24768797555">action</a> æ—¥å¿—å¯ä»¥è·Ÿè¸ªæ‰€æœ‰çš„è¿è¡Œæƒ…å†µã€‚</p><h1 id="â˜•Java"><a href="#â˜•Java" class="headerlink" title="â˜•Java"></a>â˜•Java</h1><p>Java å› ä¸ºå·¥å…·é“¾å¼ºå¤§ï¼Œæ‰€ä»¥é›†æˆæµ‹è¯•å‡ ä¹ä¸éœ€è¦ç”¨ Makefile å’Œè„šæœ¬é…åˆæ‰§è¡Œã€‚</p><p>è¿˜æ˜¯ä»¥ Pulsar ä¸ºä¾‹ï¼Œå®ƒçš„é›†æˆæµ‹è¯•æ˜¯éœ€è¦æ¨¡æ‹Ÿåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œç„¶åå†è¿è¡Œæµ‹è¯•ä»£ç ã€‚</p><blockquote><p>è¿™ä¸ªçš„å¥½å¤„æ˜¯ä»»ä½•ä¸€ä¸ªå•æµ‹éƒ½å¯ä»¥åœ¨æœ¬åœ°ç›´æ¥è¿è¡Œï¼Œè€Œ  Go çš„ä»£ç è¿˜éœ€è¦å…ˆåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œæµ‹è¯•èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚</p></blockquote><p>æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Œæˆ‘ä»¥å…¶ä¸­ä¸€ä¸ª <a href="https://github.com/apache/pulsar/blob/631b13ad23d7e48c6e82d38f97c23d129062cb7c/pulsar-broker/src/test/java/org/apache/pulsar/client/impl/BrokerClientIntegrationTest.java#L117">BrokerClientIntegrationTest</a>ä¸ºä¾‹ï¼š<br><img src="https://s2.loli.net/2024/05/20/9PbioA3RQLMBy6J.png"><br><img src="https://s2.loli.net/2024/05/20/blKePdxTUIkgRD3.png"><br>ä¼šåœ¨å•æµ‹å¯åŠ¨çš„æ—¶å€™å…ˆå¯åŠ¨æœåŠ¡ç«¯ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/gzY3lyTGuEDUwZF.png"></p><p>æœ€ç»ˆä¼šè°ƒç”¨ PulsarTestContext çš„ build å‡½æ•°å¯åŠ¨ brokerï¼ˆæœåŠ¡ç«¯ï¼‰ï¼Œè€Œæ‰§è¡Œå•æµ‹ä¹Ÿåªéœ€è¦ä½¿ç”¨ mvn å°±å¯ä»¥è‡ªåŠ¨è§¦å‘è¿™äº›å•å…ƒæµ‹è¯•ã€‚<br><img src="https://s2.loli.net/2024/05/20/N15amZihWI73Qyw.png"><br>åªæ˜¯æ¯ä¸€ä¸ªå•æµ‹éƒ½éœ€è¦å¯åœæœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¦æŠŠ Pulsar çš„æ‰€æœ‰å•æµ‹è·‘å®Œé€šå¸¸éœ€è¦ 1ï½2 ä¸ªå°æ—¶ã€‚</p><p>æ‰€ä»¥è¿™äº›é›†æˆæµ‹è¯•æœ¬è´¨ä¸Šéƒ½æ˜¯å…ˆè¦æŠŠæµ‹è¯•ç¯å¢ƒæ„å»ºå‡ºæ¥ï¼Œå†è·‘å¯¹åº”çš„æµ‹è¯•ä»£ç ï¼›åç»­ä¹Ÿæ‰“ç®—ç»™ <a href="https://github.com/crossoverJie/cim">cim</a> åŠ ä¸Šé›†æˆæµ‹è¯•å®æ“ä¸€ä¸‹ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰æœ‰æœ‹å‹é—®å¦‚ä½•åšé›†æˆæµ‹è¯•ï¼Œä»Šå¤©å°±é‡ç‚¹è®²è®²è¿™ä¸ªé›†æˆæµ‹è¯•åœ¨å¼€æºé¡¹ç›®ä¸­æ˜¯å¦‚ä½•åšçš„ã€‚&lt;/p&gt;
&lt;p&gt;é€šå¸¸æ˜¯éœ€è¦å¯¹å¤–æä¾›æœåŠ¡çš„å¼€æºé¡¹ç›®éƒ½éœ€è¦é›†æˆæµ‹è¯•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pulsar&lt;/li&gt;
&lt;li&gt;Kafka&lt;/li&gt;
&lt;li&gt;Dubbo ç­‰</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
  </entry>
  
  <entry>
    <title>ä» Helm åˆ° Operatorï¼šKubernetesåº”ç”¨ç®¡ç†çš„è¿›åŒ–</title>
    <link href="http://crossoverjie.top/2024/07/08/ob/how-operator-working/"/>
    <id>http://crossoverjie.top/2024/07/08/ob/how-operator-working/</id>
    <published>2024-07-08T03:19:51.000Z</published>
    <updated>2024-07-07T07:45:26.500Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ğŸ§°Helm-çš„ä½œç”¨"><a href="#ğŸ§°Helm-çš„ä½œç”¨" class="headerlink" title="ğŸ§°Helm çš„ä½œç”¨"></a>ğŸ§°Helm çš„ä½œç”¨</h1><p>åœ¨å¼€å§‹å‰éœ€è¦å…ˆå¯¹ kubernetes  Operator æœ‰ä¸ªç®€å•çš„è®¤è¯†ã€‚</p><p>ä»¥ä¸ºæˆ‘ä»¬åœ¨ç¼–å†™éƒ¨ç½²ä¸€äº›ç®€å• <code>Deployment</code> çš„æ—¶å€™åªéœ€è¦è‡ªå·±ç¼–å†™ä¸€ä¸ª yaml æ–‡ä»¶ç„¶å <code>kubectl apply</code> å³å¯ã€‚</p><span id="more"></span><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">app:</span> <span class="string">k8s-combat</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-combat</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span>  </span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">matchLabels:</span>  </span><br><span class="line">      <span class="attr">app:</span> <span class="string">k8s-combat</span>  </span><br><span class="line">  <span class="attr">template:</span>  </span><br><span class="line">    <span class="attr">metadata:</span>  </span><br><span class="line">      <span class="attr">labels:</span>  </span><br><span class="line">        <span class="attr">app:</span> <span class="string">k8s-combat</span>  </span><br><span class="line">    <span class="attr">spec:</span>  </span><br><span class="line">      <span class="attr">containers:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s-combat</span>  </span><br><span class="line">          <span class="attr">image:</span> <span class="string">crossoverjie/k8s-combat:v1</span>  </span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span>  </span><br><span class="line">          <span class="attr">resources:</span>  </span><br><span class="line">            <span class="attr">limits:</span>  </span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span>  </span><br><span class="line">              <span class="attr">memory:</span> <span class="string">300Mi</span>  </span><br><span class="line">            <span class="attr">requests:</span>  </span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;0.1&quot;</span>  </span><br><span class="line">              <span class="attr">memory:</span> <span class="string">30Mi</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deployment.yaml</span><br></pre></td></tr></table></figure><p>è¿™å¯¹äºä¸€äº›å¹¶ä¸å¤æ‚çš„é¡¹ç›®æ¥è¯´å®Œå…¨å¤Ÿç”¨äº†ï¼Œä½†ç»„ä»¶ä¸€å¤šå°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚</p><p><img src="https://s2.loli.net/2024/06/01/9EtzrfIAvcXm4aJ.png"><br>è¿™é‡Œä»¥ Apache Pulsar ä¸ºä¾‹ï¼šå®ƒçš„æ ¸å¿ƒç»„ä»¶æœ‰:</p><ul><li>Broker</li><li>Proxy</li><li>Zookeeper</li><li>Bookkeeper</li><li>Prometheus(å¯é€‰)</li><li>Grafana(å¯é€‰)<br>ç­‰ç»„ä»¶ï¼Œæ¯ä¸ªç»„ä»¶çš„å¯åŠ¨è¿˜æœ‰è¿™ä¾èµ–å…³ç³»ã€‚<blockquote><p>å¿…é¡»éœ€è¦ç­‰ Zookeeper å’Œ Bookkeeper å¯åŠ¨ä¹‹åæ‰èƒ½å°†æµé‡æ”¾è¿›æ¥ã€‚</p></blockquote></li></ul><p>æ­¤æ—¶å¦‚ä½•è¿˜ç»§ç»­ä½¿ç”¨ yaml æ–‡ä»¶ä¸€ä¸ªä¸ªéƒ¨ç½²å°±ä¼šéå¸¸ç¹çï¼Œå¥½åœ¨ç¤¾åŒºæœ‰æä¾› Helm ä¸€é”®å®‰è£…ç¨‹åºï¼Œä½¿ç”¨å®ƒæˆ‘ä»¬åªéœ€è¦åœ¨ä¸€ä¸ªåŒæ„çš„ yaml é‡Œç®€å•çš„é…ç½®ä¸€äº›ç»„ä»¶ï¼Œé…ç½®å°±å¯ä»¥ç”± helm æ¥éƒ¨ç½²æ•´ä¸ªå¤æ‚çš„ Pulsar ç³»ç»Ÿã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">components:</span>  </span><br><span class="line">  <span class="comment"># zookeeper  </span></span><br><span class="line">  <span class="attr">zookeeper:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># bookkeeper  </span></span><br><span class="line">  <span class="attr">bookkeeper:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># bookkeeper - autorecovery  </span></span><br><span class="line">  <span class="attr">autorecovery:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># broker  </span></span><br><span class="line">  <span class="attr">broker:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># functions  </span></span><br><span class="line">  <span class="attr">functions:</span> <span class="literal">false</span>  </span><br><span class="line">  <span class="comment"># proxy  </span></span><br><span class="line">  <span class="attr">proxy:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># toolset  </span></span><br><span class="line">  <span class="attr">toolset:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># pulsar manager  </span></span><br><span class="line">  <span class="attr">pulsar_manager:</span> <span class="literal">false</span>  </span><br><span class="line"><span class="attr">monitoring:</span>  </span><br><span class="line">  <span class="comment"># monitoring - prometheus  </span></span><br><span class="line">  <span class="attr">prometheus:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># monitoring - grafana  </span></span><br><span class="line">  <span class="attr">grafana:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># monitoring - node_exporter  </span></span><br><span class="line">  <span class="attr">node_exporter:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># alerting - alert-manager  </span></span><br><span class="line">  <span class="attr">alert_manager:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>æ¯”å¦‚åœ¨ helm çš„ yaml ä¸­æˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨å“ªäº› componentsï¼Œä»¥åŠæ˜¯å¦å¯ç”¨ç›‘æ§ç»„ä»¶ã€‚</p><p>æœ€åç›´æ¥ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm install pulsar apache/pulsar \</span><br><span class="line">--values charts/pulsar/values.yaml \</span><br><span class="line">--<span class="built_in">set</span> namespace=pulsar \</span><br><span class="line">    --<span class="built_in">set</span> initialize=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>å®ƒå°±ä¼šè‡ªåŠ¨ç”Ÿæˆå„ä¸ªç»„ä»¶çš„ yaml æ–‡ä»¶ï¼Œç„¶åç»Ÿä¸€æ‰§è¡Œã€‚</p><p>æ‰€ä»¥ helm çš„æœ¬è´¨ä¸Šå’Œ <code>kubectl apply yaml</code> ä¸€æ ·çš„ï¼Œåªæ˜¯æˆ‘ä»¬åœ¨å®šä¹‰ value.yaml æ—¶å¸®æˆ‘ä»¬å¤„ç†äº†è®¸å¤šä¸éœ€è¦ç”¨æˆ·ä½é¢‘ä¿®æ”¹çš„å‚æ•°ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ helm å°†è¦æ‰§è¡Œçš„ yaml è¾“å‡ºåäººå·¥å®¡æ ¸</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install pulsar apache/pulsar --dry-run --debug &gt; debug.yaml</span><br></pre></td></tr></table></figure><h1 id="ğŸ¤”Operator-æ˜¯ä»€ä¹ˆ"><a href="#ğŸ¤”Operator-æ˜¯ä»€ä¹ˆ" class="headerlink" title="ğŸ¤”Operator æ˜¯ä»€ä¹ˆ"></a>ğŸ¤”Operator æ˜¯ä»€ä¹ˆ</h1><h2 id="ğŸ’”Helm-çš„ç—›ç‚¹"><a href="#ğŸ’”Helm-çš„ç—›ç‚¹" class="headerlink" title="ğŸ’”Helm çš„ç—›ç‚¹"></a>ğŸ’”Helm çš„ç—›ç‚¹</h2><p>Helm è™½ç„¶å¯ä»¥å¸®æˆ‘ä»¬éƒ¨ç½²æˆ–è€…å‡çº§ä¸€ä¸ªå¤§å‹åº”ç”¨ï¼Œä½†ä»–å´æ²¡æ³•å¸®æˆ‘ä»¬è¿ç»´è¿™ä¸ªåº”ç”¨ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼šæ¯”å¦‚æˆ‘å¸Œæœ›å½“ Pulsar Broker çš„æµé‡æˆ–è€…å†…å­˜è¾¾åˆ°æŸä¸ªé˜ˆå€¼åå°±æŒ‡å®šæ‰©å®¹ Brokerï¼Œé—²æ—¶å†è‡ªåŠ¨å›æ”¶ã€‚</p><p>æˆ–è€…æŸä¸ª Bookkeeper çš„ç£ç›˜ä½¿ç”¨ç‡è¾¾åˆ°é˜ˆå€¼åå¯ä»¥è‡ªåŠ¨æ‰©å®¹ç£ç›˜ï¼Œè¿™äº›ä»…ä»…ä½¿ç”¨ Helm æ—¶éƒ½æ˜¯æ— æ³•å®ç°çš„ã€‚</p><p>ä»¥ä¸Šè¿™äº›éœ€æ±‚æˆ‘ä»¬ç›®å‰ä¹Ÿæ˜¯é€šè¿‡ç›‘æ§ç³»ç»Ÿå‘å‡ºæŠ¥è­¦ï¼Œç„¶åå†ç”±äººå·¥å¤„ç†ã€‚</p><p>å…¶ä¸­æœ€å¤§çš„ç—›ç‚¹å°±æ˜¯è¿›è¡Œå‡çº§ï¼š</p><ul><li>å‡çº§ZK</li><li>å…³é—­auto recovery</li><li>å‡çº§Bookkeeper</li><li>å‡çº§Broker</li><li>å‡çº§Proxy</li><li>å¼€å¯auto recovery</li></ul><p>å› ä¸ºæ¯æ¬¡å‡çº§æ˜¯æœ‰å…ˆåé¡ºåºçš„ï¼Œéœ€è¦ä¾æ¬¡è§‚å¯Ÿæ¯ä¸ªç»„ä»¶è¿è¡Œæ˜¯å¦æ­£å¸¸æ‰èƒ½å¾€åæ“ä½œã€‚</p><p>å¦‚æœæœ‰ Operator ç†æ€§æƒ…å†µä¸‹ä¸‹æˆ‘ä»¬åªéœ€è¦æ›´æ–°ä¸€ä¸‹é•œåƒç‰ˆæœ¬ï¼Œå®ƒå°±å¯ä»¥è‡ªåŠ¨æ‰§è¡Œä»¥ä¸Šçš„æ‰€æœ‰æ­¥éª¤æœ€åå°†é›†ç¾¤å‡çº§å®Œæ¯•ã€‚</p><p>æ‰€ä»¥ç›¸å¯¹äº Helm æ¥è¯´ Operator æ˜¯å¯ä»¥ç«™åœ¨ä¸€ä¸ªæ›´é«˜çš„è§†è§’ä¿¯è§†æ•´ä¸ªåº”ç”¨ç³»ç»Ÿï¼Œå®ƒèƒ½å‘ç°ç³»ç»Ÿå“ªä¸ªåœ°æ–¹éœ€è¦å®ƒä»è€Œç›´æ¥ä¿®å¤ã€‚</p><h2 id="ğŸ’CRD-Custom-Resource-Definitions"><a href="#ğŸ’CRD-Custom-Resource-Definitions" class="headerlink" title="ğŸ’CRD(Custom Resource Definitions)"></a>ğŸ’CRD(Custom Resource Definitions)</h2><p>è€Œæåˆ° Operator é‚£å°±ä¸å¾—ä¸æåˆ° CRD(Custom Resource Definitions)ç¿»è¯‘è¿‡æ¥å°±æ˜¯è‡ªå®šä¹‰èµ„æºã€‚</p><p>è¿™æ˜¯ kubernetes æä¾›çš„ä¸€ä¸ª API æ‰©å±•æœºåˆ¶ï¼Œç±»ä¼¼äºå†…ç½®çš„ <code>Deployment/StatefulSet/Services</code> èµ„æºï¼ŒCRD æ˜¯ä¸€ç§è‡ªå®šä¹‰çš„èµ„æºã€‚</p><p>è¿™é‡Œä»¥æˆ‘ä»¬å¸¸ç”¨çš„ <code>prometheus-operator</code> å’Œ <code>VictoriaMetrics-operator</code> ä¸ºä¾‹ï¼š</p><p>Prometheusï¼š</p><ul><li>**<code>Prometheus</code>**ï¼šç”¨äºå®šä¹‰ Prometheus çš„ Deployment</li><li>**<code>Alertmanager</code>**ï¼šç”¨äºå®šä¹‰ <strong><code>Alertmanager</code></strong></li><li>**<code>ScrapeConfig</code>**ï¼šç”¨äºå®šä¼šæŠ“å–è§„åˆ™</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ScrapeConfig</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">static-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">my-namespace</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">system-monitoring-prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">staticConfigs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">job:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">targets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">prometheus.demo.do.prometheus.io:9090</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ—¶çš„ä¸€ä¸ªå¾ˆå¤§åŒºåˆ«å°±æ˜¯èµ„æºçš„ <code>kind: ScrapeConfig</code> ä¸ºè‡ªå®šä¹‰çš„ç±»å‹ã€‚</p><p>VictoriaMetrics çš„ CRDï¼š</p><ul><li>VMPodScrapeï¼šPod çš„æŠ“å–è§„åˆ™</li><li>VMClusterï¼šé…ç½® VM é›†ç¾¤</li><li>VMAlertï¼šé…ç½® VM çš„å‘Šè­¦è§„åˆ™</li><li>ç­‰ç­‰</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vmcluster.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMCluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">retentionPeriod:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="attr">replicationFactor:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">vmstorage:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">storageDataPath:</span> <span class="string">&quot;/vm-data&quot;</span></span><br><span class="line">    <span class="attr">storage:</span></span><br><span class="line">      <span class="attr">volumeClaimTemplate:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">storage:</span> <span class="string">&quot;10Gi&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">  <span class="attr">vmselect:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">cacheMountPath:</span> <span class="string">&quot;/select-cache&quot;</span></span><br><span class="line">    <span class="attr">storage:</span></span><br><span class="line">      <span class="attr">volumeClaimTemplate:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">storage:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;0.5&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;500Mi&quot;</span></span><br><span class="line">  <span class="attr">vminsert:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯ç”¨äºåˆ›å»ºä¸€ä¸ª VM é›†ç¾¤çš„ CRD èµ„æºï¼Œåº”ç”¨ä¹‹åå°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé›†ç¾¤ã€‚</p><h1 id="Operator-åŸç†"><a href="#Operator-åŸç†" class="headerlink" title="Operator åŸç†"></a>Operator åŸç†</h1><p><img src="https://s2.loli.net/2024/06/01/t4ZnXcS9wokMPER.png"><br>Operator é€šå¸¸æ˜¯è¿è¡Œåœ¨ kubernetes API server çš„ <code>webhook</code> ä¹‹ä¸Šï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨ä¸€äº›å†…ç½®èµ„æºçš„å…³é”®èŠ‚ç‚¹ API-server ä¼šè°ƒç”¨æˆ‘ä»¬æ³¨å†Œçš„ä¸€ä¸ª <code>webhook</code>ï¼Œåœ¨è¿™ä¸ª <code>webhook</code> ä¸­æˆ‘ä»¬æ ¹æ®æˆ‘ä»¬çš„ CRD åšä¸€äº›è‡ªå®šä¹‰çš„æ“ä½œã€‚</p><p>ç†è®ºä¸Šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»»ä½•è¯­è¨€éƒ½å¯ä»¥å†™ Operatorï¼Œåªéœ€è¦èƒ½å¤„ç† api-server çš„å›è°ƒå³å¯ã€‚</p><p>åªæ˜¯ Go è¯­è¨€æœ‰å¾ˆå¤šæˆç†Ÿçš„å·¥å…·ï¼Œæ¯”å¦‚å¸¸ç”¨çš„ <a href="https://kubebuilder.io/">kubebuilder</a> å’Œ <a href="https://sdk.operatorframework.io/">operator-sdk</a>.</p><p>ä»–ä»¬å†…ç½®äº†è®¸å¤šå‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥å¸®æˆ‘ä»¬èŠ‚çœéœ€è¦å·¥ä½œé‡ã€‚</p><p>è¿™é‡Œä»¥ operator-sdk ä¸ºä¾‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ operator-sdk create webhook --group cache --version v1alpha1 --kind Memcached --defaulting --programmatic-validation</span><br></pre></td></tr></table></figure><p>ä¼šç›´æ¥å¸®æˆ‘ä»¬åˆ›å»ºå¥½ä¸€ä¸ªæ ‡å‡†çš„ operator é¡¹ç›®:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â”œâ”€â”€ PROJECT</span><br><span class="line">â”œâ”€â”€ api</span><br><span class="line">â”‚Â Â  â””â”€â”€ v1alpha1</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ memcached_webhook.go</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ webhook_suite_test.go</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ certmanager</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ certificate.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ default</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ manager_webhook_patch.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ webhookcainjection_patch.yaml</span><br><span class="line">â”‚Â Â  â””â”€â”€ webhook</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚Â Â      â””â”€â”€ service.yaml</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â””â”€â”€ main.go</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ Makefile ä¸­åŒ…å«äº†å¼€å‘è¿‡ç¨‹ä¸­å¸¸ç”¨çš„å·¥å…·é“¾ï¼ˆåŒ…æ‹¬æ ¹æ®å£°æ˜çš„ç»“æ„ä½“è‡ªåŠ¨ç”Ÿæˆ CRD èµ„æºã€éƒ¨ç½²k8s ç¯å¢ƒæµ‹è¯•ç­‰ç­‰ï¼‰ã€Dockerfile ç­‰ç­‰ã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±åªéœ€è¦ä¸“æ³¨äºå¼€å‘ä¸šåŠ¡é€»è¾‘å³å¯ã€‚</p><p>å› ä¸ºæˆ‘å‰æ®µæ—¶é—´ç»™ <a href="https://github.com/open-telemetry/opentelemetry-operator">https://github.com/open-telemetry/opentelemetry-operator</a> è´¡çŒ®è¿‡ä¸¤ä¸ª featureï¼Œæ‰€ä»¥å°±ä»¥è¿™ä¸ª Operator ä¸ºä¾‹ï¼š</p><p>å®ƒæœ‰ä¸€ä¸ª CRD: <code>kind: Instrumentation</code>ï¼Œåœ¨è¿™ä¸ª CRD ä¸­å¯ä»¥å°† OpenTelemetry çš„ agent æ³¨å…¥åˆ°åº”ç”¨ä¸­ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Instrumentation</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">instrumentation-test-order</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">env:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_SERVICE_NAME</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">order</span></span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">matchLabels:</span>  </span><br><span class="line">      <span class="attr">app:</span> <span class="string">order</span>  </span><br><span class="line">  <span class="attr">java:</span>  </span><br><span class="line">    <span class="attr">image:</span> <span class="string">autoinstrumentation-java:2.4.0-release</span>  </span><br><span class="line">    <span class="attr">extensions:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">autoinstrumentation-java:2.4.0-release</span>  </span><br><span class="line">        <span class="attr">dir:</span> <span class="string">/extensions</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="attr">env:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_RESOURCE_ATTRIBUTES</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">service.name=order</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_INSTRUMENTATION_MESSAGING_EXPERIMENTAL_RECEIVE_TELEMETRY_ENABLED</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_EXPORTER</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">otlp</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_METRICS_EXPORTER</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">otlp</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_LOGS_EXPORTER</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">none</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">http://open-telemetry-opentelemetry-collector.otel.svc.cluster.local:4317</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_COMPRESSION</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">gzip</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPERIMENTAL_EXPORTER_OTLP_RETRY_ENABLED</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure><p>å®ƒçš„è¿è¡Œè§„åˆ™æ˜¯å½“æˆ‘ä»¬çš„ Pod åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šåˆ¤æ–­ Pod çš„æ³¨è§£ä¸­æ˜¯å¦å¼€å¯äº†æ³¨å…¥ OpenTelemetry çš„é…ç½®ã€‚</p><p>å¦‚æœå¼€å¯åˆ™ä¼šå°†æˆ‘ä»¬åœ¨ CRD ä¸­è‡ªå®šä¹‰çš„é•œåƒé‡Œçš„ javaagent å¤åˆ¶åˆ°ä¸šåŠ¡å®¹å™¨ä¸­ï¼ŒåŒæ—¶ä¼šå°†ä¸‹é¢çš„é‚£äº›ç¯å¢ƒå˜é‡ä¹Ÿä¸€èµ·åŠ å…¥çš„ä¸šåŠ¡å®¹å™¨ä¸­ã€‚</p><p>è¦è¾¾åˆ°è¿™æ ·çš„æ•ˆæœå°±éœ€è¦æˆ‘ä»¬æ³¨å†Œä¸€ä¸ªå›è°ƒ endpointã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mgr.GetWebhookServer().Register(<span class="string">&quot;/mutate-v1-pod&quot;</span>, &amp;webhook.Admission&#123;  </span><br><span class="line">    Handler: podmutation.NewWebhookHandler(cfg, ctrl.Log.WithName(<span class="string">&quot;pod-webhook&quot;</span>), decoder, mgr.GetClient(),  </span><br><span class="line">       []podmutation.PodMutator&#123;  </span><br><span class="line">          sidecar.NewMutator(logger, cfg, mgr.GetClient()),  </span><br><span class="line">          instrumentation.NewMutator(logger, mgr.GetClient(), mgr.GetEventRecorderFor(<span class="string">&quot;opentelemetry-operator&quot;</span>), cfg),  </span><br><span class="line">       &#125;),&#125;)</span><br></pre></td></tr></table></figure><p>å½“ Pod åˆ›å»ºæˆ–æœ‰æ–°çš„å˜æ›´è¯·æ±‚æ—¶å°±ä¼šå›è°ƒæˆ‘ä»¬çš„æ¥å£ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *instPodMutator)</span></span> Mutate(ctx context.Context, ns corev1.Namespace, pod corev1.Pod) (corev1.Pod, <span class="type">error</span>) &#123;  </span><br><span class="line">    logger := pm.Logger.WithValues(<span class="string">&quot;namespace&quot;</span>, pod.Namespace, <span class="string">&quot;name&quot;</span>, pod.Name)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ¥å£ä¸­æˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ° Pod çš„ä¿¡æ¯ï¼Œç„¶åå†è·å– CRD <code>Instrumentation</code> åšæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> otelInsts v1alpha1.InstrumentationList  </span><br><span class="line"><span class="keyword">if</span> err := pm.Client.List(ctx, &amp;otelInsts, client.InNamespace(ns.Name)); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä» CRD ä¸­å°†æ•°æ®å¤åˆ¶åˆ°ä¸šåŠ¡å®¹å™¨ä¸­ã€‚</span></span><br><span class="line">pod.Spec.InitContainers = <span class="built_in">append</span>(pod.Spec.InitContainers, corev1.Container&#123;</span><br><span class="line">Name:      javaInitContainerName,</span><br><span class="line">Image:     javaSpec.Image,</span><br><span class="line">Command:   []<span class="type">string</span>&#123;<span class="string">&quot;cp&quot;</span>, <span class="string">&quot;/javaagent.jar&quot;</span>, javaInstrMountPath + <span class="string">&quot;/javaagent.jar&quot;</span>&#125;,</span><br><span class="line">Resources: javaSpec.Resources,</span><br><span class="line">VolumeMounts: []corev1.VolumeMount&#123;&#123;</span><br><span class="line">Name:      javaVolumeName,</span><br><span class="line">MountPath: javaInstrMountPath,</span><br><span class="line">&#125;&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, extension := <span class="keyword">range</span> javaSpec.Extensions &#123;</span><br><span class="line">pod.Spec.InitContainers = <span class="built_in">append</span>(pod.Spec.InitContainers, corev1.Container&#123;</span><br><span class="line">Name:      initContainerName + fmt.Sprintf(<span class="string">&quot;-extension-%d&quot;</span>, i),</span><br><span class="line">Image:     extension.Image,</span><br><span class="line">Command:   []<span class="type">string</span>&#123;<span class="string">&quot;cp&quot;</span>, <span class="string">&quot;-r&quot;</span>, extension.Dir + <span class="string">&quot;/.&quot;</span>, javaInstrMountPath + <span class="string">&quot;/extensions&quot;</span>&#125;,</span><br><span class="line">Resources: javaSpec.Resources,</span><br><span class="line">VolumeMounts: []corev1.VolumeMount&#123;&#123;</span><br><span class="line">Name:      javaVolumeName,</span><br><span class="line">MountPath: javaInstrMountPath,</span><br><span class="line">&#125;&#125;,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯æƒ³è¦åœ¨æµ‹è¯•ç¯å¢ƒä¸­æµ‹è¯• operator æ˜¯éœ€è¦å®‰è£…ä¸€ä¸ª <a href="https://kubebuilder.io/quick-start">cert-manage</a>ï¼Œè¿™æ · <code>webhook</code> æ‰èƒ½æ­£å¸¸çš„å›è°ƒã€‚</p></blockquote><p><img src="https://s2.loli.net/2024/06/01/IUjriqye6EMFCT8.png"><br>è¦ä½¿å¾— CRD ç”Ÿæ•ˆï¼Œæˆ‘ä»¬è¿˜å¾—å…ˆå°† CRD å®‰è£…è¿› kubernetes é›†ç¾¤ä¸­ï¼Œä¸è¿‡è¿™äº› operator-sdk è¿™ç±»æ ¹æ®å·²ç»è€ƒè™‘å‘¨åˆ°äº†ã€‚</p><p>æˆ‘ä»¬åªéœ€è¦å®šä¹‰å¥½ CRD çš„ç»“æ„ä½“ï¼š<br><img src="https://s2.loli.net/2024/06/01/RBKp15lhkHsbeEY.png"></p><p>ç„¶åä½¿ç”¨ Makefile ä¸­çš„å·¥å…· <code>make bundle</code> å°±ä¼šè‡ªåŠ¨å°†ç»“æ„ä½“è½¬æ¢ä¸º CRDã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/VictoriaMetrics/operator">https://github.com/VictoriaMetrics/operator</a></li><li><a href="https://github.com/prometheus-operator/prometheus-operator">https://github.com/prometheus-operator/prometheus-operator</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ğŸ§°Helm-çš„ä½œç”¨&quot;&gt;&lt;a href=&quot;#ğŸ§°Helm-çš„ä½œç”¨&quot; class=&quot;headerlink&quot; title=&quot;ğŸ§°Helm çš„ä½œç”¨&quot;&gt;&lt;/a&gt;ğŸ§°Helm çš„ä½œç”¨&lt;/h1&gt;&lt;p&gt;åœ¨å¼€å§‹å‰éœ€è¦å…ˆå¯¹ kubernetes  Operator æœ‰ä¸ªç®€å•çš„è®¤è¯†ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸ºæˆ‘ä»¬åœ¨ç¼–å†™éƒ¨ç½²ä¸€äº›ç®€å• &lt;code&gt;Deployment&lt;/code&gt; çš„æ—¶å€™åªéœ€è¦è‡ªå·±ç¼–å†™ä¸€ä¸ª yaml æ–‡ä»¶ç„¶å &lt;code&gt;kubectl apply&lt;/code&gt; å³å¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="kubernetes" scheme="http://crossoverjie.top/categories/OB/kubernetes/"/>
    
    <category term="kubernetes" scheme="http://crossoverjie.top/categories/OB/kubernetes/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="http://crossoverjie.top/tags/kubernetes/"/>
    
    <category term="Operator" scheme="http://crossoverjie.top/tags/Operator/"/>
    
  </entry>
  
  <entry>
    <title>ã€è¯‘ã€‘äº”ä¸ªæˆ‘æœ€è¿‘åœ¨ Go é‡Œå­¦åˆ°çš„å°æŠ€å·§</title>
    <link href="http://crossoverjie.top/2024/07/02/ob/go-5-tips/"/>
    <id>http://crossoverjie.top/2024/07/02/ob/go-5-tips/</id>
    <published>2024-07-02T10:42:39.000Z</published>
    <updated>2024-07-02T11:11:48.928Z</updated>
    
    <content type="html"><![CDATA[<p>åŸæ–‡é“¾æ¥ï¼š<a href="https://medium.com/@andreiboar/5-small-tips-i-recently-learned-in-go-cf52d50cf129">https:&#x2F;&#x2F;medium.com&#x2F;@andreiboar&#x2F;5-small-tips-i-recently-learned-in-go-cf52d50cf129</a></p><h1 id="è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡"><a href="#è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡" class="headerlink" title="è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡"></a>è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡</h1><p>æˆ‘ä»¬åœ¨ Go é€šå¸¸å¾ˆå°‘ä½¿ç”¨æ•°ç»„ arraysï¼Œä¸€èˆ¬ä½¿ç”¨åˆ‡ç‰‡ Slice æ¥ä»£æ›¿ï¼›</p><p>ä½†æ˜¯å½“ä½ éœ€è¦ä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æœä½ å¯¹éœ€è¦æŒ‡å®šæ•°é‡å¤§å°æ„Ÿåˆ°å¾ˆçƒ¦æ—¶å¯ä»¥ä½¿ç”¨ <code>[...]</code> è®©ç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬è®¡ç®—æ•°ç»„å¤§å°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">arr := [<span class="number">3</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;  </span><br><span class="line">sameArr := [...]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125; <span class="comment">// Use ... instead of 3  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// Arrays are equivalent  </span></span><br><span class="line">fmt.Println(arr)  </span><br><span class="line">fmt.Println(sameArr)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><span id="more"></span><h1 id="ä½¿ç”¨-go-run-æ›¿æ¢-go-run-main-go"><a href="#ä½¿ç”¨-go-run-æ›¿æ¢-go-run-main-go" class="headerlink" title="ä½¿ç”¨ go run . æ›¿æ¢ go run main.go"></a>ä½¿ç”¨ go run . æ›¿æ¢ go run main.go</h1><p>æ¯å½“æˆ‘ç”¨ Go å†™ç¬¬ä¸€è¡Œä»£ç æ—¶ï¼Œæˆ‘éƒ½ä¹ æƒ¯äºå¼€å§‹å†™ <code>main.go</code>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sayHello()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sayHello</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Hello!&quot;</span>)</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å½“ <code>main.go</code> å˜å¾—è¶Šæ¥è¶Šå¤§æ—¶ï¼Œæˆ‘å–œæ¬¢æŠŠä¸€äº›ç»“æ„ä½“ç§»åŠ¨åˆ°æ–°çš„æ–‡ä»¶é‡Œï¼Œè¿˜æ˜¯åœ¨ main è¿™ä¸ªåŒ…ä¸­ã€‚</p><p>main.go:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">sayHello()  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>say_hello.go:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sayHello</span><span class="params">()</span></span> &#123;  </span><br><span class="line">fmt.Println(<span class="string">&quot;Hello!&quot;</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ä½¿ç”¨ <code>go run main.go</code> å°†ä¼šå¾—åˆ°ä»¥ä¸‹çš„é”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">command-line-arguments</span>  </span><br><span class="line">./main.go:4:2: undefined: sayHello</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å¯ä»¥ä½¿ç”¨ <code>go run .</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h1 id="ä½¿ç”¨ä¸‹åˆ’çº¿è®©ä½ çš„æ•°å­—å˜å¾—æ›´æ˜“è¯»"><a href="#ä½¿ç”¨ä¸‹åˆ’çº¿è®©ä½ çš„æ•°å­—å˜å¾—æ›´æ˜“è¯»" class="headerlink" title="ä½¿ç”¨ä¸‹åˆ’çº¿è®©ä½ çš„æ•°å­—å˜å¾—æ›´æ˜“è¯»"></a>ä½¿ç”¨ä¸‹åˆ’çº¿è®©ä½ çš„æ•°å­—å˜å¾—æ›´æ˜“è¯»</h1><p>ä½ çŸ¥é“å¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿ä½¿å¾—ä½ çš„é•¿æ•°å­—æ›´æ˜“è¯»å—ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    number := <span class="number">10000000</span></span><br><span class="line">    better := <span class="number">10</span>_000_000</span><br><span class="line"></span><br><span class="line">    fmt.Println(number == better)</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h1 id="å¯ä»¥åœ¨åŒä¸€ä¸ªåŒ…ä¸‹æœ‰ä¸åŒçš„æµ‹è¯•åŒ…"><a href="#å¯ä»¥åœ¨åŒä¸€ä¸ªåŒ…ä¸‹æœ‰ä¸åŒçš„æµ‹è¯•åŒ…" class="headerlink" title="å¯ä»¥åœ¨åŒä¸€ä¸ªåŒ…ä¸‹æœ‰ä¸åŒçš„æµ‹è¯•åŒ…"></a>å¯ä»¥åœ¨åŒä¸€ä¸ªåŒ…ä¸‹æœ‰ä¸åŒçš„æµ‹è¯•åŒ…</h1><p>åœ¨ Go ä¸­æˆ‘é€šå¸¸è®¤ä¸ºä¸€ä¸ªç›®å½•ä¸‹åªèƒ½æœ‰ä¸€ä¸ªåŒ…ï¼Œä½†ä¹Ÿä¸æ˜¯å®Œå…¨æ­£ç¡®çš„ã€‚</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªåŒ…åä¸ºï¼š<code>yourpackage</code> æ­¤æ—¶ä½ å¯ä»¥è¿˜å¯ä»¥åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º <code>yourpackage_test</code> çš„åŒ…ï¼ŒåŒæ—¶åœ¨è¿™ä¸ªåŒ…é‡Œç¼–å†™ä½ çš„æµ‹è¯•ä»£ç ã€‚</p><p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œé‚£äº›æ²¡æœ‰è¢« exporter çš„å‡½æ•°åœ¨ <code>yourpackage_test</code> åŒ…ä¸‹æ˜¯ä¸èƒ½ç›´æ¥è®¿é—®çš„ï¼Œç¡®ä¿æµ‹è¯•çš„æ˜¯è¢«æš´éœ²çš„å‡½æ•°ã€‚</p><h1 id="å¤šæ¬¡ä¼ é€’ç›¸åŒå‚æ•°çš„ç®€å•æ–¹æ³•"><a href="#å¤šæ¬¡ä¼ é€’ç›¸åŒå‚æ•°çš„ç®€å•æ–¹æ³•" class="headerlink" title="å¤šæ¬¡ä¼ é€’ç›¸åŒå‚æ•°çš„ç®€å•æ–¹æ³•"></a>å¤šæ¬¡ä¼ é€’ç›¸åŒå‚æ•°çš„ç®€å•æ–¹æ³•</h1><p>åœ¨ä½¿ç”¨å­—ç¬¦ä¸²æ ¼å¼åŒ–å‡½æ•°æ—¶ï¼Œæˆ‘æ€»æ˜¯è§‰å¾—å¿…é¡»é‡å¤ä¸€ä¸ªå¤šæ¬¡ä½¿ç”¨çš„å‚æ•°å¾ˆçƒ¦äººï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    name := <span class="string">&quot;Bob&quot;</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;My name is %s. Yes, you heard that right: %s\n&quot;</span>, name, name)</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>è¿˜å¥½è¿˜æœ‰æ›´ç®€ä¾¿çš„æ–¹æ³•ï¼Œè¿™æ ·åªéœ€è¦ä¼ é€’ä¸€æ¬¡å‚æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">name := <span class="string">&quot;Bob&quot;</span>  </span><br><span class="line">fmt.Printf(<span class="string">&quot;My name is %[1]s. Yes, you heard that right: %[1]s\n&quot;</span>, name)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ª Twitter é‡Œå‘ç°çš„ï¼š<br><img src="https://s2.loli.net/2024/07/02/vaMP9CXwTEFcGKI.png"></p><p>å¸Œæœ›ä½ ä»Šå¤©å­¦åˆ°äº†ä¸€äº›æ–°ä¸œè¥¿ï¼Œæœ€è¿‘æœ‰æ²¡æœ‰å‘ç°ä¸€äº›ä½ ä»æ¥ä¸çŸ¥é“çš„ Golang å°æŠ€å·§ï¼Ÿ</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åŸæ–‡é“¾æ¥ï¼š&lt;a href=&quot;https://medium.com/@andreiboar/5-small-tips-i-recently-learned-in-go-cf52d50cf129&quot;&gt;https:&amp;#x2F;&amp;#x2F;medium.com&amp;#x2F;@andreiboar&amp;#x2F;5-small-tips-i-recently-learned-in-go-cf52d50cf129&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡&quot;&gt;&lt;a href=&quot;#è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡&quot; class=&quot;headerlink&quot; title=&quot;è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡&quot;&gt;&lt;/a&gt;è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡&lt;/h1&gt;&lt;p&gt;æˆ‘ä»¬åœ¨ Go é€šå¸¸å¾ˆå°‘ä½¿ç”¨æ•°ç»„ arraysï¼Œä¸€èˆ¬ä½¿ç”¨åˆ‡ç‰‡ Slice æ¥ä»£æ›¿ï¼›&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯å½“ä½ éœ€è¦ä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æœä½ å¯¹éœ€è¦æŒ‡å®šæ•°é‡å¤§å°æ„Ÿåˆ°å¾ˆçƒ¦æ—¶å¯ä»¥ä½¿ç”¨ &lt;code&gt;[...]&lt;/code&gt; è®©ç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬è®¡ç®—æ•°ç»„å¤§å°ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;fmt&amp;quot;&lt;/span&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;arr := [&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&amp;#125;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sameArr := [...]&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&amp;#125; &lt;span class=&quot;comment&quot;&gt;// Use ... instead of 3  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Arrays are equivalent  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(arr)  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(sameArr)  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/"/>
    
    <category term="Go" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/Go/"/>
    
    
    <category term="Go" scheme="http://crossoverjie.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•æ‰¾åˆ°å¹¶å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®</title>
    <link href="http://crossoverjie.top/2024/07/01/ob/how-to-involve-OpenSource/"/>
    <id>http://crossoverjie.top/2024/07/01/ob/how-to-involve-OpenSource/</id>
    <published>2024-07-01T02:55:00.000Z</published>
    <updated>2024-07-31T02:19:26.123Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥å‰æœ‰å†™è¿‡ä¸¤ç¯‡æ–‡ç« æ¥ç®€å•èŠè¿‡å¦‚ä½•åšå¼€æºçš„äº‹æƒ…ï¼Œæœ€è¿‘æˆ‘è‡ªå·±ç»„äº†ä¸€ä¸ªç¤¾åŒºé‡Œé¢ä¹Ÿæœ‰ä¸å°‘æœ‹å‹å¯¹å¼€æºæ„Ÿå…´è¶£ï¼Œäºæ˜¯æˆ‘ä¾¿æ ¹æ®è‡ªå·±çš„ç»éªŒç³»ç»Ÿçš„æ¢³ç†äº†ä¸€äº›å…³äºå¼€æºçš„äº‹æƒ…ã€‚</p><ul><li><a href="https://crossoverjie.top/2023/08/05/ob/novice-contribute-open-source/">æ–°æ‰‹å¦‚ä½•å¿«é€Ÿå‚ä¸å¼€æºé¡¹ç›®</a></li><li><a href="https://crossoverjie.top/2024/01/25/ob/create-a-plugin-for-cprobe/">æ‰‹æŠŠæ‰‹æ•™ä½ ä¸ºå¼€æºé¡¹ç›®è´¡çŒ®ä»£ç </a></li></ul><blockquote><p>æœ‰å…´è¶£çš„å¯ä»¥å…ˆçœ‹çœ‹ä¹‹å‰è¿™ä¸¤ç¯‡ã€‚</p></blockquote><span id="more"></span><h1 id="ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®"><a href="#ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®" class="headerlink" title="ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®"></a>ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®</h1><p>é¦–å…ˆç¬¬ä¸€æ­¥å…ˆæƒ³æ¸…æ¥šè‡ªå·±æå¼€æºçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼š</p><ul><li>å‚è€ƒç¤¾åŒºå¤§ä½¬çš„ä»£ç ï¼Œæå‡æŠ€æœ¯</li><li>ä¸°å¯Œä¸ªäººå±¥å†ï¼Œæé«˜é¢è¯•é€šè¿‡ç‡<ul><li>æ›´åŠŸåˆ©ä¸€ç‚¹å°±æ˜¯æƒ³æˆä¸ºæŸä¸ªé¡¹ç›®çš„ <code>Committer</code>&#x2F;<code>PMC</code></li></ul></li><li>å•çº¯å–œæ¬¢åˆ†äº«ï¼Œçƒ­çˆ±å¼€æºï¼Œè®¤å¯å¼€æºæ”¹å˜ä¸–ç•ŒğŸ’ªã€‚</li></ul><p>æˆ‘è®¤ä¸ºå‰é¢ä¸‰ç§éƒ½æ˜¯ä¸€ä¸ªç›®çš„ï¼Œæå‡è‡ªå·±è·å¾—åç»­çš„å¥½å¤„ï¼›æœ€åä¸€ç§åˆ™æ˜¯å¦¥å¦¥çš„çº¯çƒ­çˆ±ã€‚</p><p>ä»¥æˆ‘ä¸ªäººæ¥è¯´ï¼Œæˆ‘ä¸¤è€…éƒ½æ²¾ä¸€ç‚¹ï¼›æˆ‘ç›¸ä¿¡å¤§éƒ¨åˆ†äººéƒ½æ˜¯å‰é¢ä¸‰ç±»çš„ç›®çš„ï¼Œåˆ°è¿™é‡Œæˆ‘å¯èƒ½è¦å…ˆæµ‡ç‚¹å†·æ°´ã€‚</p><blockquote><p>å¾€å¾€ä¸€ä¸ªå¼€æºé¡¹ç›®ä»ä½ ç†Ÿæ‚‰å®ƒå¼€å§‹åˆ°æç¬¬ä¸€ä¸ª PR ç„¶ååˆ°åˆå¹¶ä¸­é—´ç»å†çš„æ—¶é—´å¯èƒ½æ˜¯å¤§å¤§è¶…å‡ºä½ çš„é¢„æœŸçš„ã€‚</p></blockquote><p>ç‰¹åˆ«æ˜¯è¶Šå¤§å‹è¶Šä¸“ä¸šçš„é¡¹ç›®ï¼ˆæˆ‘ç›¸ä¿¡ä½ ä¹Ÿæ˜¯æƒ³åŠ å…¥è¿™ç±»æœ‰ä¸€å®šçŸ¥ååº¦çš„é¡¹ç›®ï¼‰ã€‚</p><p>å› ä¸ºå¼€æºç¤¾åŒºå¤§éƒ¨åˆ†éƒ½æ˜¯æ‰§è¡Œå¼‚æ­¥æ²Ÿé€šï¼Œä¸å³æ—¶é€šè®¯çš„å¿«é€Ÿåé¦ˆä¸åŒï¼Œç”šè‡³è¿˜æœ‰ä¸å°‘ reviewer å¤„äºä¸åŒçš„æ—¶åŒºã€‚</p><p>æ‰€ä»¥ä¸€å¼€å§‹å°±æƒ³åšå¥½å¿ƒç†é¢„æœŸï¼Œä¸è¦æŒ‡æœ›ç€æˆ‘ç»™æŸä¸ªé¡¹ç›®æäº¤ä¸€ä¸ªå¾ˆç‰›é€¼çš„åŠŸèƒ½ï¼Œç„¶åä»–ä»¬å¿«é€Ÿ review åˆå¹¶ï¼Œç„¶åç»™ä½  commit æƒé™ã€‚</p><p>è€Œä¸”æœ‰ä¸å°‘å¼€æºé¡¹ç›®æ˜¯ç”±æŸä¸€ä¸ªå…¬å¸ä¸»å¯¼çš„ï¼Œæ¯”å¦‚ï¼ˆPulsarã€Golangã€Kafkaï¼‰ï¼Œä»–ä»¬å¯èƒ½å¯¹äºå¤–éƒ¨ç¤¾åŒºæ¥çš„æ–°æ‰‹å¹¶ä¸é‚£ä¹ˆä¸Šå¿ƒï¼Œä¸€ä¸ª PR æ™¾åœ¨é‚£é‡Œå‡ ä¸ªæœˆæ²¡äººç†éƒ½æ˜¯å¾ˆæ­£å¸¸çš„ã€‚</p><p>æ‰€ä»¥æˆ‘å»ºè®®ä¸€å¼€å§‹é€‰æ‹©çš„é¡¹ç›®æœ‰ä»¥ä¸‹å‡ ä¸ªç­›é€‰æ ‡å‡†ï¼š</p><ul><li>å°½é‡æ˜¯è‡ªå·±æ—¥å¸¸åœ¨ç”¨ï¼Œç†Ÿæ‚‰çš„é¡¹ç›®ã€‚</li><li>æœ€è¿‘æœ‰åœ¨åŠæ—¶æ›´æ–°ç»´æŠ¤çš„é¡¹ç›®ã€‚</li><li>å¯¹ç¤¾åŒºæ–°äººçš„æ¥çº³ç¨‹åº¦æ˜¯å¦è¶³å¤ŸåŒ…å®¹ã€‚<ul><li>è¿™ç‚¹å¯ä»¥åœ¨ Github é‡ŒæŸ¥æ‰¾æ ‡ç­¾ä¸º <code>help want/contribution welcome</code> çš„ issue æˆ–è€…æ˜¯ PRã€‚</li><li>æŸ¥çœ‹è¿™äº› issue&#x2F; PR æœ€è¿‘çš„æ´»è·ƒæ—¶é—´ï¼Œè´¡çŒ®è€…æ˜¯å¦ä¸ºæ–°äººã€‚</li><li>å¾€å¾€ä¸€ä¸ªåŒ…å®¹åº¦è¾ƒé«˜çš„é¡¹ç›®ä»¥ä¸Šä¿¡æ¯éƒ½æ˜¯å¾ˆæ´»è·ƒçš„ã€‚</li></ul></li><li>é¡¹ç›®ä¸»è¦ç»´æŠ¤è€…æ˜¯å¦æ¥ç€ä¸åŒçš„å…¬å¸ï¼Œæ˜¯å¦è¶³å¤Ÿæ´»è·ƒã€‚</li></ul><p><img src="https://s2.loli.net/2024/05/25/PIL8a5CoMbxRiwJ.png"><br><img src="https://s2.loli.net/2024/05/25/7CQaVFiAR4tyMbs.png"></p><p>æ¨èå‡ ä¸ªæˆ‘è®¤ä¸ºæ¯”è¾ƒç¬¦åˆæˆ‘åˆšæ‰æåˆ°çš„æ¡ä»¶çš„é¡¹ç›®ï¼š</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/7195">https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/7195</a></li><li><a href="https://github.com/apache/pulsar-client-go/issues?q=is:open+label:type/feature+sort:updated-desc">https://github.com/apache/pulsar-client-go/issues?q=is%3Aopen+label%3Atype%2Ffeature+sort%3Aupdated-desc</a></li><li><a href="https://github.com/apache/hertzbeat/">https://github.com/apache/hertzbeat/</a></li></ul><h1 id="ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®"><a href="#ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®" class="headerlink" title="ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®"></a>ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®</h1><p>å¦‚æœæ‰¾åˆ°äº†è‡ªå·±æƒ³è´¡çŒ®çš„é¡¹ç›®ï¼Œå¦‚æœè‡ªå·±è¿˜ä¸å¤ªç†Ÿæ‚‰çš„è¯ï¼Œé‚£å°±å¯ä»¥å°è¯•ä»¥ä¸‹æ­¥éª¤æ¥å¿«é€Ÿä¸Šæ‰‹å®ƒã€‚</p><h2 id="âœ…å•å…ƒæµ‹è¯•"><a href="#âœ…å•å…ƒæµ‹è¯•" class="headerlink" title="âœ…å•å…ƒæµ‹è¯•"></a>âœ…å•å…ƒæµ‹è¯•</h2><p>é¦–å…ˆç¬¬ä¸€ä¸ªå°±æ˜¯å•å…ƒæµ‹è¯•ï¼Œå•å…ƒæµ‹è¯•æ˜¯ä¸€ä¸ªéå¸¸ä¸é”™çš„æ–¹å¼æ¥ä¸Šæ‰‹ä¸€ä¸ªæ–°çš„å¼€æºé¡¹ç›®ï¼Œ<strong>ä½†é‡ç‚¹ä¸æ˜¯å»çœ‹ç°æœ‰çš„å•æµ‹ï¼Œè€Œæ˜¯è‡ªå·±å»å†™âœï¸</strong>ã€‚</p><p>å†™è¿‡å•å…ƒæµ‹è¯•çš„å°ä¼™ä¼´å°±çŸ¥é“ï¼Œå¦‚æœè¦è¾¾åˆ° 90% ä»¥ä¸Šçš„è¦†ç›–ç‡æ—¶éœ€è¦å¯¹è‡ªå·±å†™çš„æ¯ä¸€è¡Œä»£ç éƒ½å¾—äº†è§£ï¼Œç”šè‡³åœ¨å†™çš„è¿‡ç¨‹ä¸­ä¼šå‘ç°éƒ¨åˆ†ä»£ç æ˜¯ä¸æ˜¯æ²¡æœ‰å¿…è¦ï¼Œä»è€Œå†å¸®åŠ©è‡ªå·±æ¢³ç†ä¸€éä¸šåŠ¡ã€‚</p><p>æ‰€ä»¥å†™å•æµ‹ç¡®å®æ˜¯å¿«é€Ÿç†Ÿæ‚‰æŸä¸ªé¡¹ç›®çš„æ–¹æ³•ï¼Œä½†è¿™é’ˆå¯¹äºä¸€äº›é€»è¾‘ç®€å•çš„é¡¹ç›®ï¼›å¯¹äºä¸€äº›ä¸šåŠ¡å¤æ‚çš„é¡¹ç›®å»ºè®®è¿˜æ˜¯å¿«é€Ÿè·‘é€šå®˜æ–¹æ¨èä¸€ä¸ªåŠŸèƒ½ã€‚</p><h2 id="ğŸŒŸä»¥-Pulsar-ä¸ºä¾‹"><a href="#ğŸŒŸä»¥-Pulsar-ä¸ºä¾‹" class="headerlink" title="ğŸŒŸä»¥ Pulsar ä¸ºä¾‹"></a>ğŸŒŸä»¥ Pulsar ä¸ºä¾‹</h2><p>ä»¥ <a href="https://pulsar.apache.org/">Apache Pulsar</a>ä¸ºä¾‹ï¼Œé‚£å°±å…ˆè·‘ä¸€ä¸ªæ¶ˆæ¯çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€… demoï¼›è·‘é€šäº†ä¹‹åå†å°è¯•çœ‹çœ‹å®ƒå®¢æˆ·ç«¯å·²æœ‰çš„å•æµ‹ä»£ç ï¼Œç„¶åå°è¯•æ”¹ä¸€äº›æ–­è¨€ï¼Œæ­¤æ—¶å°±ä¼šå‘ç°é¢„æœŸå€¼ä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆå®šä¹‰ã€‚<br><a href="https://github.com/apache/pulsar/blob/631b13ad23d7e48c6e82d38f97c23d129062cb7c/pulsar-broker/src/test/java/org/apache/pulsar/client/impl/BrokerClientIntegrationTest.java#L1077">https://github.com/apache/pulsar/blob/631b13ad23d7e48c6e82d38f97c23d129062cb7c/pulsar-broker/src/test/java/org/apache/pulsar/client/impl/BrokerClientIntegrationTest.java#L1077</a><br><img src="https://s2.loli.net/2024/05/17/CrITHSWeY1sP8dL.png"></p><p><img src="https://s2.loli.net/2024/05/17/J6DmLxQMZvuAqW7.png"></p><p>æ¯”å¦‚è¿™é‡Œçš„ä¸€ä¸ª consumer å–æ¶ˆè®¢é˜…ä¸¤æ¬¡æ—¶å€™å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å¼‚å¸¸çš„åœ°æ–¹æ‰¾åˆ°æºç é‡Œå¯¹è¿æ¥çŠ¶æ€çš„åˆ¤æ–­æ¡ä»¶ã€‚</p><p>å°±å¯ä»¥å¾—çŸ¥ï¼šå½“å®¢æˆ·ç«¯å–æ¶ˆè®¢é˜…æ—¶ä¼šä¿®æ”¹è¿æ¥çŠ¶æ€ã€‚</p><h2 id="ğŸ’“HertzBeat"><a href="#ğŸ’“HertzBeat" class="headerlink" title="ğŸ’“HertzBeat"></a>ğŸ’“HertzBeat</h2><p>ä¸‹é¢ä»¥ <a href="https://hertzbeat.apache.org/">Apache HertzBeat</a>ä¸ºä¾‹æ¥çœ‹çœ‹å½“æ—¶æˆ‘æ˜¯å¦‚ä½•è´¡çŒ®å•å…ƒæµ‹è¯•çš„ã€‚</p><p><img src="https://s2.loli.net/2024/05/17/dixDGIQO2sZfh98.png"><br>é€šè¿‡å®˜æ–¹çš„æ¶æ„å›¾å¯ä»¥å¾—çŸ¥ HertzBeat æ˜¯é€šè¿‡ä¸€ä¸ª collector å»ç›´è¿ç›®æ ‡é‡‡é›†æ•°æ®çš„ã€‚</p><p>æ¯”å¦‚é€šè¿‡ Redis çš„å®¢æˆ·ç«¯å»è·å–ç›‘æ§æ•°æ®ï¼Œç„¶åå†å­˜æ”¾åˆ°è‡ªå·±çš„æ—¶åºæ•°æ®åº“ä¸­è¿›è¡Œå±•ç¤ºã€‚</p><p>æ‰€ä»¥è¿™ä¸ªé‡‡é›†çš„è¿‡ç¨‹å°±æ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä»–çš„æ¥å£å®šä¹‰ã€‚</p><p><img src="https://s2.loli.net/2024/05/17/3quVop5vSr6KzPY.png"><br>ä¸€å…±å°±ä¸‰ä¸ªæ¥å£ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>collecté‡‡é›†æ¥å£ï¼šåœ¨ Metrics ä¸­å®šä¹‰äº†é‡‡é›†çš„ç›®æ ‡ä¿¡æ¯ï¼ˆåœ°å€ã€ç«¯å£ç­‰ï¼‰<ul><li>é‡‡é›†å®Œåçš„æ•°æ®å†™å…¥åˆ° Builder ä¾›åç»­çš„å†™å…¥å­˜å‚¨</li></ul></li><li>preCheckï¼šæå‰åšä¸€äº›å‚æ•°æ ¡éªŒ</li><li>supportProtocolï¼šè¿”å›å®šä¹‰çš„åè®®ç±»å‹ï¼Œé€šè¿‡è¿™ä¸ªç±»å‹æ‰¾åˆ°å¯¹åº”é‡‡é›†å™¨</li></ul><p><img src="https://s2.loli.net/2024/05/17/hQZaFV2qo3176uf.png"></p><p>ç„¶åå°±äº¤ç”±ä¸åŒçš„å®ç°ç±»å»é‡‡é›†ä¸åŒçš„æŒ‡æ ‡ã€‚</p><p>è¿™é‡Œæˆ‘ä»¥ <code>RedisCommonCollectImpl</code>ä¸ºä¾‹ï¼Œä¸»è¦çš„å•æµ‹é€»è¾‘å°±æ˜¯æ¨¡æ‹Ÿ Redis å®¢æˆ·ç«¯çš„è¿”å›æ•°æ®ï¼Œç„¶ååœ¨ Collect çš„ä»£ç é‡ŒæŸ¥çœ‹ä¸åŒçš„å¤„ç†é€»è¾‘ï¼Œå…¶å®å°±æ˜¯è¦è¦†ç›–å„ç§åˆ†æ”¯ä»¥åŠå¼‚å¸¸çš„æƒ…å†µã€‚</p><p>æœ€åå†æ–­è¨€é‡‡é›†åˆ°çš„æ•°æ®ä¸é¢„æœŸæ˜¯å¦åŒ¹é…å³å¯ï¼Œè´´ä¸€æ®µæ ¸å¿ƒé€»è¾‘ï¼š<br><img src="https://s2.loli.net/2024/05/17/EnrZxdDR5kLtMIG.png"></p><p>è‡³äºåº”è¯¥è¿”å›ä»€ä¹ˆé¢„æœŸç»“æœï¼Œæœ‰äº› collector å¯èƒ½ä¼šåœ¨ä»£ç æ³¨é‡Šé‡Œå†™æ¸…æ¥šï¼Œä½†è¿™ä¸ª Redis æ²¡æœ‰å†™ã€‚</p><p>ä¸è¿‡ä¹Ÿæœ‰åŠæ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»£ç åœ¨æœ¬åœ°è·‘èµ·æ¥ä¹‹åè¿›å…¥ç®¡ç†å°æŸ¥çœ‹å†…ç½®çš„ç›‘æ§æ¨¡ç‰ˆã€‚</p><p><img src="https://s2.loli.net/2024/05/17/g4EL7AdGfbrpXKU.png"><br>è¿™é‡Œæ˜¯ç”¨äºå®šä¹‰ä¼šç›‘æ§å“ªäº›å­—æ®µçš„åœ°æ–¹ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä»£ç é¢„å…ˆç”Ÿæˆå¥½é¢„æœŸè¿”å›å€¼äº†ã€‚</p><p><img src="https://s2.loli.net/2024/05/17/OCEYUZHscP6waI3.png"></p><p>å…·ä½“çš„å•æµ‹ä»£ç è¯·çœ‹è¿™é‡Œï¼š<br><a href="https://github.com/apache/hertzbeat/blob/master/collector/src/test/java/org/apache/hertzbeat/collector/collect/redis/RedisClusterCollectImplTest.java#L46">https://github.com/apache/hertzbeat/blob/master/collector/src/test/java/org/apache/hertzbeat/collector/collect/redis/RedisClusterCollectImplTest.java#L46</a></p><h1 id="ğŸ“æ€»ç»“"><a href="#ğŸ“æ€»ç»“" class="headerlink" title="ğŸ“æ€»ç»“"></a>ğŸ“æ€»ç»“</h1><p>å‚ä¸ä¸€ä¸ªæˆç†Ÿç¤¾åŒºçš„å¼€æºæœ‰ä¸€ç‚¹ä¸€å®šè¦è®°ä½ï¼Œ<strong>å°±æ˜¯è¦ä»”ç»†é˜…è¯»<a href="https://hertzbeat.apache.org/zh-cn/docs/community/contribution">è´¡çŒ®è€…æ–‡æ¡£</a>ã€‚</strong></p><p>é‡Œé¢å¾€å¾€ä¼šå†™æ¸…æ¥šå¦‚ä½•æ„å»ºä»£ç ã€ä»£ç è§„èŒƒã€æäº¤è§„èŒƒç­‰ä¿¡æ¯ï¼Œè¿™äº›éƒ½æ‹æ¸…æ¥šåæäº¤çš„ PR æ‰æ›´å®¹æ˜“è¢«ç¤¾åŒºæ¥å—ã€‚</p><p>åé¢ä¼šç»§ç»­æ›´æ–°é›†æˆæµ‹è¯•ä¸ <code>e2e</code> æµ‹è¯•ç­‰å†…å®¹ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»¥å‰æœ‰å†™è¿‡ä¸¤ç¯‡æ–‡ç« æ¥ç®€å•èŠè¿‡å¦‚ä½•åšå¼€æºçš„äº‹æƒ…ï¼Œæœ€è¿‘æˆ‘è‡ªå·±ç»„äº†ä¸€ä¸ªç¤¾åŒºé‡Œé¢ä¹Ÿæœ‰ä¸å°‘æœ‹å‹å¯¹å¼€æºæ„Ÿå…´è¶£ï¼Œäºæ˜¯æˆ‘ä¾¿æ ¹æ®è‡ªå·±çš„ç»éªŒç³»ç»Ÿçš„æ¢³ç†äº†ä¸€äº›å…³äºå¼€æºçš„äº‹æƒ…ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://crossoverjie.top/2023/08/05/ob/novice-contribute-open-source/&quot;&gt;æ–°æ‰‹å¦‚ä½•å¿«é€Ÿå‚ä¸å¼€æºé¡¹ç›®&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://crossoverjie.top/2024/01/25/ob/create-a-plugin-for-cprobe/&quot;&gt;æ‰‹æŠŠæ‰‹æ•™ä½ ä¸ºå¼€æºé¡¹ç›®è´¡çŒ®ä»£ç &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ‰å…´è¶£çš„å¯ä»¥å…ˆçœ‹çœ‹ä¹‹å‰è¿™ä¸¤ç¯‡ã€‚&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
  </entry>
  
  <entry>
    <title>OpenTelemetry æ·±åº¦å®šåˆ¶ï¼šè·¨æœåŠ¡è¿½è¸ªçš„å®æˆ˜æŠ€å·§</title>
    <link href="http://crossoverjie.top/2024/06/26/ob/OpenTelemetry-custom-instrument/"/>
    <id>http://crossoverjie.top/2024/06/26/ob/OpenTelemetry-custom-instrument/</id>
    <published>2024-06-26T11:58:03.000Z</published>
    <updated>2024-07-01T01:33:40.464Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p><img src="https://s2.loli.net/2024/05/19/7CnOFegSu4TLbhd.png"></p><p>åœ¨ä¸Šä¸€ç¯‡<a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">ã€Šä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…ã€‹</a>ä¸­åœ¨æœ€åæåˆ°åœ¨åšä¸€äº› Trace çš„å®šåˆ¶å¼€å‘ã€‚</p><p>åˆ°ç°åœ¨å·®ä¸å¤šç®—æ˜¯å®Œæˆäº†ï¼Œå¯ä»¥å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚</p><p>æˆ‘ä»¬çš„éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://s2.loli.net/2024/05/19/qex6IFcOnQ591gT.png"><br>å‡è®¾ç°åœ¨æœ‰ä¸‰ä¸ªæœåŠ¡ï¼šServiceAã€ServiceBã€ServiceC</p><span id="more"></span><p><code>ServiceA</code> å¯¹å¤–æä¾›äº†ä¸€ä¸ª http æ¥å£ <code>request</code>ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¼šè°ƒç”¨ <code>ServiceB</code> çš„ <code>order</code> è®¢å•æ¥å£åˆ›å»ºè®¢å•ï¼ŒåŒæ—¶ <code>serviceB</code> è°ƒç”¨ <code>serviceC</code> çš„ pay æ¥å£ã€‚</p><p><img src="https://s2.loli.net/2024/05/19/GtljX3BLVcePWFn.png"><br>æ•´ä¸ªè°ƒç”¨å…³ç³»å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ span ä¸­çš„ attribute ä¼šè®°å½•å½“å‰ span çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š<br><img src="https://s2.loli.net/2024/05/19/tvgdT1Mke7OjPGp.png"><br>è¿™äº›éƒ½æ˜¯å½“å‰ä¸€äº›å½“å‰ span å†…ç½®çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å½“å‰ gRPC æ¥å£çš„ä¸€äº›åŸºæœ¬æ•°æ®ï¼šæœåŠ¡åã€ipã€ç«¯å£ç­‰ä¿¡æ¯ã€‚</p><p>ä½†è¿™é‡Œå¹¶æ²¡æœ‰ä¸Šæ¸¸çš„ä¸€äº›ä¿¡æ¯ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ Jaeger çš„æ ‘çŠ¶å›¾å¾—çŸ¥ä¸Šæ¸¸æ˜¯å“ªä¸ªåº”ç”¨è°ƒç”¨è¿‡æ¥çš„ï¼Œä½†æ˜¯ä¸€æ—¦æŸä¸ª span ä¸‹æœ‰å¤šä¸ªå­ span çš„è°ƒç”¨ï¼Œå°±æ²¡åŠæ³•å¾ˆç›´è§‚çŸ¥é“è¿™ä¸ªå­ span çš„ä¸Šæ¸¸æ˜¯ç”±è°å‘èµ·çš„è°ƒç”¨ã€‚</p><p>æ¯”å¦‚å¦‚ä¸‹è¿™ä¸ªé“¾è·¯ï¼š<br><img src="https://s2.loli.net/2024/05/19/3rOdKfBmhSjz1GF.png"><br>å½“ä¸€ä¸ªè°ƒç”¨é“¾éå¸¸é•¿ï¼ŒåŒæ—¶ä¹Ÿéå¸¸å¤æ‚æ—¶ï¼Œæ²¡åŠæ³•ç¬¬ä¸€æ—¶é—´çŸ¥é“æŸä¸€ä¸ª span çš„ä¸Šæ¸¸åˆ°åº•æ˜¯è°å‘èµ·çš„ï¼Œéœ€è¦æ‰‹åŠ¨ä¸€å±‚å±‚çš„å»æŠ˜å ï¼Œæˆ–è€…å…¨é çœ¼ç›å»æ‰¾ã€‚</p><h2 id="é¢„æœŸæ•ˆæœ"><a href="#é¢„æœŸæ•ˆæœ" class="headerlink" title="é¢„æœŸæ•ˆæœ"></a>é¢„æœŸæ•ˆæœ</h2><p><img src="https://s2.loli.net/2024/05/19/9v3cGMrez8XA2ZH.png"></p><p>ä¸ºæ­¤æˆ‘ä»¬å¸Œæœ›çš„æ•ˆæœæ˜¯å¯ä»¥é€šè¿‡ç»™æ¯ä¸€ä¸ªå­ span ä¸­åŠ å…¥ä¸¤ä¸ª attributeï¼Œæ¥æ ‡æ˜å®ƒçš„çˆ¶è°ƒç”¨æ¥æºã€‚</p><p>æ¯”å¦‚åœ¨ serviceB ä¸­çš„æ‰€æœ‰ span ä¸­éƒ½ä¼šåŠ ä¸Šä¸¤ä¸ªæ ‡ç­¾ï¼šæ¥æºæ˜¯ serviceAï¼ŒåŒæ—¶æ˜¯ serviceA çš„ request æ¥å£å‘èµ·çš„è¯·æ±‚ã€‚</p><p>è€Œåœ¨ serviceC ä¸­åŒæ ·å¯ä»¥çŸ¥é“æ¥æºæ˜¯ serviceB çš„ Order æ¥å£å‘èµ·çš„è°ƒç”¨ã€‚</p><p>æˆ‘å¯åŠ¨äº†ä¸‰ä¸ª demo åº”ç”¨ï¼Œåˆ†åˆ«æ˜¯ create1ï¼Œcreate2ï¼Œcreate3.</p><p>create1 ä¸­ä¼šæä¾›ä¸€ä¸ª <code>request</code> æ¥å£ï¼Œåœ¨è¿™é‡Œé¢è°ƒç”¨ create2 çš„ <code>create2</code> æ¥å£ï¼Œ<code>create2</code> çš„æ¥å£é‡Œæ¥ç€è°ƒç”¨ create3 çš„ <code>create3</code> æ¥å£ã€‚</p><p>create1ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line">   <span class="type">HelloRequest</span> <span class="variable">request</span> <span class="operator">=</span> HelloRequest.newBuilder()  </span><br><span class="line">         .setName(name)  </span><br><span class="line">         .build();  </span><br><span class="line">   log.info(<span class="string">&quot;request: &#123;&#125;&quot;</span>, request);  </span><br><span class="line">   <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> myServiceStub.create2(request).getMessage();  </span><br><span class="line">   Executors.newFixedThreadPool(<span class="number">1</span>).execute(() -&gt; &#123;  </span><br><span class="line">      myServiceStub.create2(request).getMessage();  </span><br><span class="line">   &#125;);       <span class="keyword">return</span> message;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>create2:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create2</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> &#123;  </span><br><span class="line">    <span class="type">HelloReply</span> <span class="variable">reply</span> <span class="operator">=</span> HelloReply.newBuilder()  </span><br><span class="line">            .setMessage(<span class="string">&quot;Create2 ==&gt; &quot;</span> + request.getName())  </span><br><span class="line">            .build();  </span><br><span class="line">    log.info(<span class="string">&quot;Create2: &#123;&#125;&quot;</span>, reply.getMessage());  </span><br><span class="line">    myMethod(request.getName());  </span><br><span class="line">    myServiceStub.create3(request);</span><br><span class="line">    responseObserver.onNext(reply);  </span><br><span class="line">    responseObserver.onCompleted();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>create3:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create3</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> &#123;  </span><br><span class="line">    <span class="type">HelloReply</span> <span class="variable">reply</span> <span class="operator">=</span> HelloReply.newBuilder()  </span><br><span class="line">            .setMessage(<span class="string">&quot;Create3 ==&gt; &quot;</span> + request.getName())  </span><br><span class="line">            .build();  </span><br><span class="line">    log.info(<span class="string">&quot;Create3: &#123;&#125;&quot;</span>, reply.getMessage());  </span><br><span class="line">    myMethod(request.getName());  </span><br><span class="line">    responseObserver.onNext(reply);  </span><br><span class="line">    responseObserver.onCompleted();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.javaagent.extensions=otel-extensions-custom-context-1.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.traces.exporter=otlp \</span><br><span class="line">-Dotel.logs.exporter=none \</span><br><span class="line">-Dotel.service.name=create2 \</span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \</span><br><span class="line">-Dotel.propagators=tracecontext,baggage,demo \</span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar --spring.application.name=create2 --server.port=9191 --grpc.server.port=9292 --grpc.client.myService.address=static://127.0.0.1:9393</span><br></pre></td></tr></table></figure><p>åªæ˜¯æ¯ä¸ªåº”ç”¨éƒ½éœ€è¦ä½¿ç”¨æˆ‘è¿™è¾¹å•ç‹¬æ‰“çš„ agent åŒ…ä»¥åŠä¸€ä¸ª <code>extension</code>(tel-extensions-custom-context-1.0-SNAPSHOT.jar) æ‰èƒ½ç”Ÿæ•ˆã€‚</p><p>æœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/05/19/4o5mEhjnMbZWL62.png"></p><h1 id="Baggage"><a href="#Baggage" class="headerlink" title="Baggage"></a>Baggage</h1><p>åœ¨è®²å…·ä½“çš„å®ç°ä¹‹å‰éœ€è¦å…ˆäº†è§£å‡ ä¸ª Trace ä¸­çš„æ¦‚å¿µï¼Œåœ¨è¿™é‡Œä¸»è¦ç”¨åˆ°çš„æ˜¯ä¸€ä¸ªç§°ä¸º Baggage çš„å¯¹è±¡ã€‚</p><p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å…¶å®æåˆ°è¿‡å®ƒçš„åŸç†ä»¥åŠä½¿ç”¨åœºæ™¯ï¼š<br><a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/?highlight=%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E6%97%85#Baggage">ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</a></p><p><img src="https://s2.loli.net/2024/05/19/gv2YEoO6LkiGIF9.png"></p><p>Baggage çš„ä¸­æ–‡ç¿»è¯‘æ˜¯ï¼šåŒ…è£¹ğŸ“¦ï¼›ç®€å•æ¥è¯´å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ baggage å¯ä»¥å°†æˆ‘ä»¬æƒ³è¦çš„æ•°æ®å­˜æ”¾åœ¨å…¶ä¸­ï¼Œè¿™æ ·å†æ•´ä¸ª Trace çš„ä»»æ„ä¸€ä¸ª Span ä¸­éƒ½å¯ä»¥è¯»å–åˆ°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line"><span class="comment">// å†™å…¥</span></span><br><span class="line">    Baggage.current().toBuilder().  </span><br><span class="line">          put(<span class="string">&quot;request.name&quot;</span>, name).build()  </span><br><span class="line">          .storeInContext(Context.current()).makeCurrent();</span><br><span class="line">&#125;         </span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–</span></span><br><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> Baggage.current().getEntryValue(<span class="string">&quot;request.name&quot;</span>);  </span><br><span class="line">log.info(<span class="string">&quot;request.name: &#123;&#125;&quot;</span>, value);</span><br></pre></td></tr></table></figure><p>ç†è§£äº†è¿™ä¸ªä¹‹åï¼Œæˆ‘ä»¬è¦å®ç°çš„å°†ä¸Šæ¸¸çš„ä¿¡æ¯ä¼ é€’åˆ°ä¸‹æ¸¸å°±å¯ä»¥é€šè¿‡è¿™ä¸ªç»„ä»¶å®ç°äº†ã€‚</p><p>åªéœ€è¦åœ¨ä¸Šæ¸¸åˆ›å»º span æ—¶å°†å®ƒè‡ªèº«æ•°æ®å†™å…¥åˆ° Baggage ä¸­ï¼Œå†åˆ°ä¸‹æ¸¸ span å–å‡ºæ¥å†™å…¥åˆ° attribute ä¸­å³å¯ã€‚</p><h1 id="ContextCustomizer"><a href="#ContextCustomizer" class="headerlink" title="ContextCustomizer"></a>ContextCustomizer</h1><p>è¿™é‡Œçš„å…³é”®å°±æ˜¯åœ¨å“ªé‡Œå†™å…¥è¿™ä¸ª Baggageï¼Œå› ä¸ºå¯¹ç¬¬ä¸‰æ–¹ç»„ä»¶çš„ Instrumentation çš„å®ç°éƒ½æ˜¯åœ¨ <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation">opentelemetry-java-instrumentation</a>é¡¹ç›®ä¸­ã€‚</p><blockquote><p>javaagent.jar åŒ…ä¹Ÿæ˜¯é€šè¿‡è¯¥é¡¹ç›®æ‰“åŒ…å‡ºæ¥çš„ã€‚</p></blockquote><p>æ‰€ä»¥åœ¨è¯¥é¡¹ç›®çš„ <code>io.opentelemetry.instrumentation.api.instrumenter.Instrumenter#doStart</code> è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å‘ç°ä¸€æ®µé€»è¾‘ï¼š</p><p><img src="https://s2.loli.net/2024/05/20/FYiAnq2G3voIyR4.png"></p><hr><blockquote><p>è¿™ä¸ªå‡½æ•°æ˜¯åœ¨åˆ›å»ºä¸€ä¸ª span çš„æ—¶å€™è°ƒç”¨çš„ï¼Œé€šå¸¸è¿™ä¸ªåˆ›å»ºå‡½æ•°æ˜¯åœ¨è¿™äº›ç¬¬ä¸‰æ–¹åº“çš„æ‹¦æˆªå™¨ä¸­åˆ›å»ºçš„ã€‚</p></blockquote><p><img src="https://s2.loli.net/2024/05/20/b3cxYekiUGaSlO9.png"><br>æ¯”å¦‚è¿™æ˜¯åœ¨ grpc çš„æ‹¦æˆªå™¨ä¸­è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context customizers run before span start, so that they can have access to the parent span  </span></span><br><span class="line"><span class="comment">// context, and so that their additions to the context will be visible to span processors  </span></span><br><span class="line"><span class="keyword">for</span> (ContextCustomizer&lt;? <span class="built_in">super</span> REQUEST&gt; contextCustomizer : contextCustomizers) &#123;  </span><br><span class="line">  context = contextCustomizer.onStart(context, request, attributes);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ContextCustomizer</code> æ˜¯ä¸€ä¸ªæ¥å£åªæä¾›äº†ä¸€ä¸ªå‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ContextCustomizer</span>&lt;REQUEST&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** Allows to customize the operation &#123;<span class="doctag">@link</span> Context&#125;. */</span>  </span><br><span class="line">  Context <span class="title function_">onStart</span><span class="params">(Context parentContext, REQUEST request, Attributes startAttributes)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>Context</code> æ˜¯ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯ä»¥åœ¨è‡ªå®šä¹‰çš„ ContextCustomizer ç»§ç»­å¾€ä¸Šä¸‹æ–‡ä¸­è¿½åŠ ä¿¡æ¯ã€‚</li><li><code>REQUEST</code> æ˜¯ä¸€ä¸ªæ³›å‹ï¼šä¸€èˆ¬æ˜¯å½“å‰ç¬¬ä¸‰æ–¹ç»„ä»¶çš„è¯·æ±‚ä¿¡æ¯ï¼š<ul><li>æ¯”å¦‚æ˜¯ <code>HTTP</code> æ—¶ï¼Œè¿™ä¸ª <code>request</code> å°±æ˜¯ HTTP çš„è¯·æ±‚ä¿¡æ¯ã€‚</li><li>è€Œå¦‚æœæ˜¯ <code>gRPC</code> ï¼Œåˆ™æ˜¯ <code>gRPC</code> çš„è¯·æ±‚ä¿¡æ¯ã€‚</li><li>å…¶ä»–çš„è¯·æ±‚ç±»å‹åŒç†ã€‚</li></ul></li><li><code>startAttributes</code> åˆ™æ˜¯é¢„å…ˆå†™å…¥çš„ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚åœ¨ä¸Šå›¾ä¸­çœ‹åˆ°çš„ä¸€äº› <code>rpc.service/rpc.method</code>ç­‰å­—æ®µã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context customizers run before span start, so that they can have access to the parent span  </span></span><br><span class="line"><span class="comment">// context, and so that their additions to the context will be visible to span processors</span></span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸ªæ¥å£çš„è°ƒç”¨æ³¨é‡Šå¯ä»¥çœ‹å‡ºï¼š<br>è¿™ä¸ªè‡ªå®šä¹‰çš„ context ä¼šåœ¨ span å¼€å§‹ä¹‹å‰è°ƒç”¨ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæ˜¯å¯ä»¥è®¿é—®åˆ°å½“å‰åˆ›å»ºçš„ span çš„çˆ¶ contextï¼ŒåŒæ—¶åœ¨è¿™é‡Œçš„ context ä¸­æ–°å¢çš„æ•°æ®å¯ä»¥åœ¨ <code>SpanProcessor</code> è®¿é—®åˆ°ã€‚</p><h1 id="SpanProcessor"><a href="#SpanProcessor" class="headerlink" title="SpanProcessor"></a>SpanProcessor</h1><p>è€Œ SpanProcessor åˆæ˜¯ä¸€ä¸ªéå¸¸çš„é‡è¦çš„ç»„ä»¶ï¼Œæˆ‘ä»¬æ¥ç€åˆšæ‰çš„ <code>contextCustomizer</code> å¤„å¾€åè·Ÿè¸ªä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">context = contextCustomizer.onStart(context, request, attributes);</span><br><span class="line">---&gt;<span class="type">Span</span> <span class="variable">span</span> <span class="operator">=</span> spanBuilder.setParent(context).startSpan();</span><br><span class="line">---&gt;io.opentelemetry.sdk.trace.SdkSpanBuilder#startSpan</span><br><span class="line">---&gt;io.opentelemetry.sdk.trace.SdkSpan#startSpan</span><br><span class="line">---&gt;spanProcessor.onStart(parentContext, span);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>spanProcessor.onStart</code> è¿™ä¸ªå‡½æ•°ä¼šåœ¨ contextCustomizer ä¹‹åè°ƒç”¨ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/vpxHt34TUbgfShz.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * SpanProcessor is the interface &#123;<span class="doctag">@link</span> SdkTracer&#125; uses to allow synchronous hooks for when a  </span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> Span&#125; is started or when a &#123;<span class="doctag">@code</span> Span&#125; is ended.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//==========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Called when a &#123;<span class="doctag">@link</span> io.opentelemetry.api.trace.Span&#125; is started, if the &#123;<span class="doctag">@link</span>  </span></span><br><span class="line"><span class="comment"> * Span#isRecording()&#125; returns true.  </span></span><br><span class="line"><span class="comment"> * * &lt;p&gt;This method is called synchronously on the execution thread, should not throw or block the  </span></span><br><span class="line"><span class="comment"> * execution thread. * * <span class="doctag">@param</span> parentContext the parent &#123;<span class="doctag">@code</span> Context&#125; of the span that just started.  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> span the &#123;<span class="doctag">@code</span> Span&#125; that just started.  </span></span><br><span class="line"><span class="comment"> */</span><span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(Context parentContext, ReadWriteSpan span)</span>;</span><br></pre></td></tr></table></figure><p>ä»æ³¨é‡Šä¸­å¯ä»¥çŸ¥é“ SpanProcessor æ˜¯ä½œä¸ºä¸€ä¸ª span çš„ç”Ÿå‘½å‘¨æœŸä¸­çš„å…³é”®èŠ‚ç‚¹çš„ hook å‡½æ•°ã€‚</p><p>åœ¨è¿™äº›å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€äº› span çš„æ•°æ®ï¼Œæ¯”å¦‚åœ¨ <code>onStart</code> è¿˜å¯ä»¥å¾€ span ä¸­å†™å…¥ä¸€äº›è‡ªå®šä¹‰çš„ attributeã€‚</p><p>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¿™æ¬¡ä¼šç”¨åˆ°çš„ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯ï¼š</p><p>åœ¨ gRPC æ„å»º Instrument æ—¶è‡ªå®šä¹‰ä¸€ä¸ª <code>GrpcServerContextCustomizer</code> ï¼Œåœ¨è¿™ä¸ªè‡ªå®šä¹‰çš„ <code>ContextCustomizer</code> ä¸­å†™å…¥ä¸€ä¸ª <code>Baggage</code>ã€‚</p><p>ç„¶ååœ¨ <code>io.opentelemetry.sdk.trace.SpanProcessor#onStart</code> æ¥å£ä¸­å–å‡ºè¿™ä¸ª <code>Baggage</code> å†™å…¥åˆ°å½“å‰ span çš„ attribute ä¸­ã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ä¹‹å‰æåˆ°çš„é‚£äº›æ•°æ®ä¸Šæ¸¸ä¿¡æ¯äº†ã€‚<br><img src="https://s2.loli.net/2024/05/19/4o5mEhjnMbZWL62.png"></p><h1 id="ä¸º-gRPC-æ·»åŠ ä¸Šä¸‹æ–‡"><a href="#ä¸º-gRPC-æ·»åŠ ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸º gRPC æ·»åŠ ä¸Šä¸‹æ–‡"></a>ä¸º gRPC æ·»åŠ ä¸Šä¸‹æ–‡</h1><p>å…ˆæ¥çœ‹çœ‹å¦‚ä½•ä¸º gRPC æ·»åŠ  <code>Baggage</code>ï¼š</p><p>æˆ‘ä»¬å…ˆè‡ªå®šä¹‰ä¸€ä¸ª <code>GrpcServerContextCustomizer</code> å®ç°ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcServerContextCustomizer</span> <span class="keyword">implements</span> <span class="title class_">ContextCustomizer</span>&lt;GrpcRequest&gt; &#123;  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String currentServiceName;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARENT_RPC_KEY</span> <span class="operator">=</span> <span class="string">&quot;parent_rpc&quot;</span>;  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CURRENT_RPC_KEY</span> <span class="operator">=</span> <span class="string">&quot;current_rpc&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CURRENT_HTTP_URL_PATH</span> <span class="operator">=</span> <span class="string">&quot;current_http_url_path&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">GrpcServerContextCustomizer</span><span class="params">(String serviceName)</span> &#123;  </span><br><span class="line">    <span class="built_in">this</span>.currentServiceName = serviceName;  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> Context <span class="title function_">onStart</span><span class="params">(Context parentContext, GrpcRequest grpcRequest,  </span></span><br><span class="line"><span class="params">      Attributes startAttributeds)</span> &#123;  </span><br><span class="line">    <span class="type">BaggageBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Baggage.fromContext(parentContext).toBuilder();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">currentRpc</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(CURRENT_RPC_KEY);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">fullMethodName</span> <span class="operator">=</span> startAttributeds.get(AttributeKey.stringKey(<span class="string">&quot;rpc.method&quot;</span>));  </span><br><span class="line">    <span class="type">String</span> <span class="variable">rpcService</span> <span class="operator">=</span> startAttributeds.get(AttributeKey.stringKey(<span class="string">&quot;rpc.service&quot;</span>));  </span><br><span class="line">    <span class="comment">// call from grpc  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> rpcService + <span class="string">&quot;:&quot;</span> + fullMethodName;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">baggageInfo</span> <span class="operator">=</span> getBaggageInfo(currentServiceName, method);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">httpUrlPath</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(CURRENT_HTTP_URL_PATH);  </span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(httpUrlPath)) &#123;  </span><br><span class="line">      <span class="comment">// call from http  </span></span><br><span class="line">      <span class="comment">// currentRpc = currentRpc;  currentRpc = create1|GET:/request      // clear current_http_url_path      builder.put(CURRENT_HTTP_URL_PATH, &quot;&quot;);  </span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="type">Baggage</span> <span class="variable">baggage</span> <span class="operator">=</span> builder  </span><br><span class="line">        .put(PARENT_RPC_KEY, currentRpc)  </span><br><span class="line">        .put(CURRENT_RPC_KEY, baggageInfo)  </span><br><span class="line">        .build();  </span><br><span class="line">    <span class="keyword">return</span> parentContext.with(baggage);  </span><br><span class="line">  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getBaggageInfo</span><span class="params">(String serviceName, String method)</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNullOrEmpty(serviceName)) &#123;  </span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">    &#125;    <span class="keyword">return</span> serviceName + <span class="string">&quot;|&quot;</span> + method;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸ªä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬éœ€è¦å…ˆä»ä¸Šä¸‹æ–‡ä¸­è·å– <code>CURRENT_RPC_KEY</code> ï¼Œä»è€Œå¾—çŸ¥å½“å‰çš„ span æ˜¯ä¸æ˜¯ root spanã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å…¶å®æ˜¯æŠŠå½“å‰çš„ span ä¿¡æ¯ä½œä¸ºä¸€ä¸ª <code>PARENT_RPC_KEY</code> å†™å…¥åˆ° Baggage ä¸­ã€‚</p><p>è¿™æ ·åœ¨ <code>SpanProcessor</code> ä¸­ä¾¿å¯ä»¥ç›´æ¥å–å‡º <code>PARENT_RPC_KEY</code> ä½œä¸ºä¸Šæ¸¸çš„ä¿¡æ¯å†™å…¥ span çš„ attribute ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(Context parentContext, ReadWriteSpan span)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">parentRpc</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(<span class="string">&quot;parent_rpc&quot;</span>);  </span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(parentRpc)) &#123;  </span><br><span class="line">        String[] split = parentRpc.split(<span class="string">&quot;\\|&quot;</span>);  </span><br><span class="line">        span.setAttribute(<span class="string">&quot;parent_rpc&quot;</span>, parentRpc);  </span><br><span class="line">        span.setAttribute(<span class="string">&quot;parent_service_name&quot;</span>, split[<span class="number">0</span>]);  </span><br><span class="line">        span.setAttribute(<span class="string">&quot;parent_service_method&quot;</span>, split[<span class="number">1</span>]); </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ Baggage éœ€è¦ä½¿ç”¨ <code>Baggage.fromContext(parentContext)</code> æ‰èƒ½æ‹¿åˆ°åˆšæ‰å†™å…¥ Baggage ä¿¡æ¯ã€‚</p></blockquote><p>ä¹‹åæˆ‘ä»¬æ‰¾åˆ°æ„å»º <a href="https://github.com/crossoverjie/opentelemetry-java-instrumentation/blob/715220c8d5e52001f9af9afbeb00bb87b4db0197/instrumentation/grpc-1.6/library/src/main/java/io/opentelemetry/instrumentation/grpc/v1_6/GrpcTelemetryBuilder.java#L31">gRPCServerInstrumenterBuilder</a> çš„åœ°æ–¹ï¼Œå†™å…¥æˆ‘ä»¬åˆšæ‰è‡ªå®šä¹‰çš„ <code>GrpcServerContextCustomizer</code> å³å¯ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/rwSc8HmvqKL9ZQl.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.addContextCustomizer(<span class="keyword">new</span> <span class="title class_">GrpcServerContextCustomizer</span>(serviceName))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©å†™å…¥åˆ°æ˜¯ <code>serverInstrumenterBuilder</code> è€Œä¸æ˜¯<code>clientInstrumenterBuilder</code>ï¼Œå› ä¸ºåœ¨æœåŠ¡ç«¯çš„å…¥å£å°±çŸ¥é“æ˜¯ä»å“ªä¸ªæ¥å£è¿›æ¥çš„è¯·æ±‚ã€‚</p><h1 id="ä¸º-spring-boot-çš„-http-æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡"><a href="#ä¸º-spring-boot-çš„-http-æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸º spring boot çš„ http æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡"></a>ä¸º spring boot çš„ http æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡</h1><p>å¦‚æœåªå­˜åœ¨ gRPC è°ƒç”¨æ—¶åªæ·»åŠ  <code>gRPC</code> çš„ä¸Šä¸‹æ–‡ä¹Ÿå¤Ÿç”¨äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿä¸æ’é™¤ç”±å¤–éƒ¨æ¥å£æ˜¯é€šè¿‡ HTTP è®¿é—®è¿›æ¥çš„ï¼Œç„¶åå†è°ƒç”¨å†…éƒ¨çš„ <code>gRPC</code> æ¥å£ï¼›è¿™ä¹Ÿæ˜¯éå¸¸å¸¸è§çš„æ¶æ„æ¨¡å¼ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åœ¨ HTTP ä¸­å¢åŠ  <code>ContextCustomizer</code> å°†è‡ªèº«çš„æ•°æ®å†™å…¥åˆ° <code>Baggage</code> ä¸­ã€‚</p><p>å¥½åœ¨ <code>HttpServerRouteBuilder</code> è‡ªèº«æ˜¯å®ç°äº† <code>ContextCustomizer</code> æ¥å£çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å¾€é‡Œé¢å†™å…¥ <code>Baggage</code> æ•°æ®å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ContextCustomizer&lt;REQUEST&gt; <span class="title function_">build</span><span class="params">()</span> &#123;  </span><br><span class="line">  Set&lt;String&gt; knownMethods = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(<span class="built_in">this</span>.knownMethods);  </span><br><span class="line">  <span class="keyword">return</span> (context, request, startAttributes) -&gt; &#123;  </span><br><span class="line">    <span class="keyword">if</span> (HttpRouteState.fromContextOrNull(context) != <span class="literal">null</span>) &#123;  </span><br><span class="line">      <span class="keyword">return</span> context;  </span><br><span class="line">    &#125;    <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> getter.getHttpRequestMethod(request);  </span><br><span class="line">    <span class="keyword">if</span> (method == <span class="literal">null</span> || !knownMethods.contains(method)) &#123;  </span><br><span class="line">      method = <span class="string">&quot;HTTP&quot;</span>;  </span><br><span class="line">    &#125;    <span class="type">String</span> <span class="variable">urlPath</span> <span class="operator">=</span> getter.getUrlPath(request);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">methodPath</span> <span class="operator">=</span> method + <span class="string">&quot;:&quot;</span> + urlPath;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">currentRpc</span> <span class="operator">=</span> Baggage.fromContext(context).getEntryValue(CURRENT_RPC_KEY);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">baggageInfo</span> <span class="operator">=</span> getBaggageInfo(serviceName, methodPath);  </span><br><span class="line">    <span class="type">Baggage</span> <span class="variable">baggage</span> <span class="operator">=</span> Baggage.fromContext(context).toBuilder()  </span><br><span class="line">        .put(PARENT_RPC_KEY, currentRpc)  </span><br><span class="line">        .put(CURRENT_RPC_KEY, baggageInfo)  </span><br><span class="line">        .put(CURRENT_HTTP_URL_PATH, methodPath)  </span><br><span class="line">        .build();   </span><br><span class="line">    <span class="keyword">return</span> context.with(HttpRouteState.create(method, <span class="literal">null</span>, <span class="number">0</span>))  </span><br><span class="line">        .with(baggage);  </span><br><span class="line">  &#125;;&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ–°å¢äº† <code>CURRENT_HTTP_URL_PATH</code> ç”¨äºæ ‡è®°å½“å‰çš„è¯·æ±‚æ¥æºæ˜¯ HTTPï¼Œåœ¨ grpc çš„ <code>ContextCustomizer</code> è§£ææ—¶ä¼šåˆ¤æ–­è¿™ä¸ªå€¼æ˜¯å¦ä¸ºç©ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">httpUrlPath</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(CURRENT_HTTP_URL_PATH);  </span><br><span class="line"><span class="keyword">if</span> (!StringUtils.isNullOrEmpty(httpUrlPath)) &#123;  </span><br><span class="line">  <span class="comment">// call from http  </span></span><br><span class="line">  <span class="comment">// currentRpc = currentRpc;  currentRpc = create1|GET:/request  // clear current_http_url_path  builder.put(CURRENT_HTTP_URL_PATH, &quot;&quot;);  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p><img src="https://s2.loli.net/2024/05/20/ionwTD9EAr3CROL.png"></p><p>è¿™æ ·å°±å¯ä»¥åœ¨ grpc çš„ä¸‹æ¸¸æ¥å£æ‹¿åˆ°å…¥å£çš„ HTTP æ¥å£æ•°æ®äº†ã€‚</p><hr><p>å½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯åœ¨ grpc æ¥å£ä¸­è°ƒç”¨ HTTP çš„æ¥å£çš„åœºæ™¯ï¼Œåªæ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡ä¸­æ²¡æœ‰è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥å°±æ²¡æœ‰é€‚é…è¿™ç±»çš„åœºæ™¯ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><code>ContextCustomizer</code> æ¥å£æ²¡æœ‰æä¾›å¯¹åº”çš„æ‰©å±•ï¼Œä½†æ˜¯ <code>SpanProcessor</code> æ˜¯æä¾›äº†æ‰©å±•æ¥å£çš„ã€‚</p><blockquote><p>åŸæœ¬æ˜¯æƒ³å°½é‡åˆ«ç»´æŠ¤è‡ªå·±çš„ javaagentï¼Œä½†ä¹Ÿå¥½åœ¨ OpenTelemetry æ˜¯æä¾›çš„æ¥å£ï¼Œæ‰€ä»¥ä¹Ÿå¹¶ä¸ä¼šå»ä¿®æ”¹åŸæœ¬çš„ä»£ç ã€‚</p></blockquote><p>æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ª extensions çš„é¡¹ç›®åœ¨å®ç° <code>SpanProcessor</code>ï¼Œè¿™ä¸ªåœ¨ä¹‹å‰çš„ <a href="https://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/">ã€Šå®æˆ˜ï¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª OpenTelemetry Extensionsã€‹</a>æœ‰è¯¦ç»†è®²åˆ°ã€‚</p><p>æ‰€ä»¥æœ€åçš„åº”ç”¨å¯åŠ¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.javaagent.extensions=otel-extensions-custom-context-1.0-SNAPSHOT.jar \</span><br></pre></td></tr></table></figure><p>éœ€è¦ä½¿ç”¨æˆ‘ä»¬æ‰‹åŠ¨æ‰“åŒ…çš„ javaagent ä»¥åŠä¸€ä¸ªè‡ªå®šä¹‰æ‰©å±•åŒ…ã€‚</p><p>æ‰“åŒ…æ–¹å¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew assemble</span><br></pre></td></tr></table></figure><blockquote><p><code>opentelemetry-java-instrumentation</code> é¡¹ç›®æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥æ‰“åŒ…è¿‡ç¨‹å¯èƒ½æ¯”è¾ƒä¹…ã€‚</p></blockquote><p>å› ä¸ºè¿™å…¶å®æ˜¯ä¸€äº›å®šåˆ¶éœ€æ±‚ï¼Œæ‰€ä»¥å°±æ²¡æäº¤åˆ°ä¸Šæ¸¸ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œåˆå¹¶ä»£ç æµ‹è¯•ã€‚</p><p>æœ€åå¯ä»¥è¿™ä¸ªåˆ†æ”¯ä¸­æŸ¥çœ‹åˆ°ä¿®æ”¹çš„éƒ¨åˆ†ï¼š<br><a href="https://github.com/crossoverJie/opentelemetry-java-instrumentation/compare/main...add-grpc-context">https://github.com/crossoverJie/opentelemetry-java-instrumentation/compare/main...add-grpc-context</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/05/19/7CnOFegSu4TLbhd.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡&lt;a href=&quot;https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/&quot;&gt;ã€Šä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…ã€‹&lt;/a&gt;ä¸­åœ¨æœ€åæåˆ°åœ¨åšä¸€äº› Trace çš„å®šåˆ¶å¼€å‘ã€‚&lt;/p&gt;
&lt;p&gt;åˆ°ç°åœ¨å·®ä¸å¤šç®—æ˜¯å®Œæˆäº†ï¼Œå¯ä»¥å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬çš„éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/05/19/qex6IFcOnQ591gT.png&quot;&gt;&lt;br&gt;å‡è®¾ç°åœ¨æœ‰ä¸‰ä¸ªæœåŠ¡ï¼šServiceAã€ServiceBã€ServiceC&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>ä» Prometheus åˆ° OpenTelemetryï¼šæŒ‡æ ‡ç›‘æ§çš„æ¼”è¿›ä¸å®è·µ</title>
    <link href="http://crossoverjie.top/2024/06/13/ob/OpenTelemetry-metrics-concept/"/>
    <id>http://crossoverjie.top/2024/06/13/ob/OpenTelemetry-metrics-concept/</id>
    <published>2024-06-13T10:22:48.000Z</published>
    <updated>2024-07-21T14:36:43.951Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡ï¼š<a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</a>æˆ‘ä»¬è®²è§£äº† Trace çš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µï¼š</p><ul><li>Trace</li><li>Span</li><li>Context</li><li>Baggage ç­‰</li></ul><p>è¿™æ¬¡æˆ‘ä»¬æ¥è®²å¦ä¸€ä¸ªè¯é¢˜ <code>Metrics</code>ã€‚</p><span id="more"></span><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å…³äº metrics æˆ‘æœ€æ—©æ¥è§¦ç›¸å…³æ¦‚å¿µçš„å°±æ˜¯ prometheusï¼Œå®ƒæ˜¯ç¬¬äºŒä¸ªåŠ å…¥ CNCFï¼ˆäº‘åŸç”Ÿï¼‰ç¤¾åŒºçš„é¡¹ç›®ï¼ˆç¬¬ä¸€ä¸ªæ˜¯ kubernetesï¼‰ï¼Œå¯è§åœ¨äº‘åŸç”Ÿé¢†åŸŸ Metrics æŒ‡æ ‡ç›‘æ§ä»è¯ç”Ÿä¹‹åˆå°±æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ã€‚</p><p>ç°å®ä¹Ÿç¡®å®å¦‚æ­¤ï¼Œå¦‚ä»Šåªè¦ä½¿ç”¨åˆ°äº† kubernetes ç›¸å…³çš„é¡¹ç›®ï¼Œå¯¹å…¶ç›‘æ§å°±æ˜¯å¿…ä¸å¯å°‘çš„ã€‚</p><p>å½“ç„¶ä¹Ÿä¸æ­¢æ˜¯äº‘åŸç”Ÿçš„é¡¹ç›®æ‰éœ€è¦ Metrics æŒ‡æ ‡ç›‘æ§ï¼Œæˆ‘ä»¬ä»»ä½•ä¸€ä¸ªä¸šåŠ¡éƒ½æ˜¯éœ€è¦çš„ï¼Œä¸ç„¶æˆ‘ä»¬çš„æœåŠ¡è¿è¡Œå¯¹å¼€å‘è¿ç»´æ¥è¯´éƒ½æ˜¯ä¸€ä¸ªé»‘ç›’ï¼Œæ— æ³•çŸ¥é“æ­¤æ—¶ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µï¼Œå› æ­¤æ‰éœ€è¦æˆ‘ä»¬çš„ä¸šåŠ¡ç³»ç»Ÿå°†ä¸€äº›å…³é”®è¿è¡ŒæŒ‡æ ‡æš´éœ²å‡ºæ¥ã€‚</p><p><img src="https://s2.loli.net/2024/05/12/1QWEAdFHqYzhl4g.png"></p><p>ä¸šåŠ¡æ•°æ®ï¼šæ¯”å¦‚è®¢å•çš„å¢é•¿ç‡ã€é”€å”®é‡‘é¢ç­‰ä¸šåŠ¡æ•°æ®ï¼›åŒæ—¶è¿˜æœ‰åº”ç”¨è‡ªèº«çš„èµ„æºå ç”¨æƒ…å†µï¼š</p><ul><li>QPS</li><li>Latency</li><li>å†…å­˜</li><li>CPU ç­‰ä¿¡æ¯ã€‚</li></ul><p> åœ¨ä½¿ç”¨ OpenTelemetry ä¹‹å‰ï¼Œå› ä¸º prometheus æ˜¯è¿™éƒ¨åˆ†çš„ç»å¯¹æ ‡å‡†ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šå¸¸éƒ½ä¼šä½¿ç”¨ prometheus çš„åŒ…æ¥æš´éœ²è¿™äº›æŒ‡æ ‡ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- The client --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Hotspot JVM metrics--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient_hotspot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æš´éœ²ä¸€ä¸ªè‡ªå®šä¹‰çš„æŒ‡æ ‡ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.prometheus.client.Counter;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">YourClass</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">requests</span> <span class="operator">=</span> Counter.build()</span><br><span class="line">     .name(<span class="string">&quot;requests_total&quot;</span>).help(<span class="string">&quot;Total requests.&quot;</span>).register();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">processRequest</span><span class="params">()</span> &#123;</span><br><span class="line">    requests.inc();</span><br><span class="line">    <span class="comment">// Your code here.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ˜¯æš´éœ²ä¸€ä¸ªå•è°ƒé€’å¢çš„æŒ‡æ ‡ï¼Œprometheus è¿˜æä¾›äº†å…¶ä»–å‡ ç§æŒ‡æ ‡ç±»å‹ï¼š</p></blockquote><ul><li>Counter</li><li>Gauge</li><li>Histogram</li></ul><p>ä¹‹åæˆ‘ä»¬åªéœ€è¦åœ¨ prometheus ä¸­é…ç½®ä¸€äº›æŠ“å–è§„åˆ™å³å¯ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;springboot&#x27;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8080&#x27;</span>] <span class="comment"># Spring Boot ip+port</span></span><br></pre></td></tr></table></figure><blockquote><p>å½“ç„¶å¦‚æœæ˜¯è¿è¡Œåœ¨ kubernetes ç¯å¢ƒï¼Œprometheus ä¹Ÿå¯ä»¥åŸºäºæœåŠ¡å‘ç°é…ç½®ä¸€äº›è§„åˆ™ï¼Œè‡ªåŠ¨æŠ“å–æˆ‘ä»¬çš„ Pod çš„æ•°æ®ï¼Œç”±äºä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹å°±ä¸è¿‡å¤šä»‹ç»ã€‚</p></blockquote><h1 id="åŸºæœ¬ç»„ä»¶"><a href="#åŸºæœ¬ç»„ä»¶" class="headerlink" title="åŸºæœ¬ç»„ä»¶"></a>åŸºæœ¬ç»„ä»¶</h1><p>åœ¨ OpenTelemetry ä¸­è‡ªç„¶ä¹Ÿæä¾›äº† Metrics è¿™ä¸ªç»„ä»¶ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯å®Œå…¨å…¼å®¹ Prometheusï¼Œæ‰€ä»¥æˆ‘ä»¬ç†è§£å’Œä½¿ç”¨èµ·æ¥å¹¶ä¸å¤æ‚ã€‚</p><h2 id="MeterProvider"><a href="#MeterProvider" class="headerlink" title="MeterProvider"></a>MeterProvider</h2><p>ä¸åŒäº prometheus å®¢æˆ·ç«¯ä¸­ç›´æ¥æä¾›äº† Counter å°±å¯ä»¥åˆ›å»ºæŒ‡æ ‡äº†ï¼Œåœ¨ OpenTelemetry ä¸­ä¼šæä¾›ä¸€ä¸ª <code>MeterProvider</code> çš„æ¥å£ï¼Œä½¿ç”¨è¿™ä¸ªæ¥å£å¯ä»¥è·å– Meterï¼Œå†ä½¿ç”¨ Meter æ‰å¯ä»¥åˆ›å»º Counterã€Gaugeã€Histogram ç­‰æ•°æ®ã€‚</p><p>ä¸‹é¢æ¥çœ‹çœ‹å…·ä½“å¦‚ä½•ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¥ Pulsar æºç çš„ä»£ç è¿›è¡Œæ¼”ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InstrumentProvider</span><span class="params">(OpenTelemetry otel)</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (otel == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="comment">// By default, metrics are disabled, unless the OTel java agent is configured.  </span></span><br><span class="line">        <span class="comment">// This allows to enable metrics without any code change.        otel = GlobalOpenTelemetry.get();  </span></span><br><span class="line">    &#125;    <span class="built_in">this</span>.meter = otel.getMeterProvider()  </span><br><span class="line">            .meterBuilder(<span class="string">&quot;org.apache.pulsar.client&quot;</span>)  </span><br><span class="line">            .setInstrumentationVersion(PulsarVersion.getVersion())  </span><br><span class="line">            .build();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">LongCounterBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> meter.counterBuilder(name)  </span><br><span class="line">        .setDescription(description)  </span><br><span class="line">        .setUnit(unit.toString());</span><br></pre></td></tr></table></figure><h2 id="Meter-Exporter"><a href="#Meter-Exporter" class="headerlink" title="Meter Exporter"></a>Meter Exporter</h2><p>Meter Exporter åˆ™æ˜¯ä¸€ä¸ª OpenTelemetry ç‹¬æœ‰çš„æ¦‚å¿µï¼Œä¸æˆ‘ä»¬ä¹‹å‰è®²åˆ°çš„ä¸€æ ·ï¼šOpenTelemetry ä½œä¸ºå‚å•†æ— å…³çš„å¹³å°ï¼Œå…è®¸æˆ‘ä»¬å°†æ•°æ®å†™å…¥åˆ°ä»»ä½•å…¼å®¹çš„äº§å“é‡Œã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨ Metrics æ—¶éœ€è¦æŒ‡å®šä¸€ä¸ª exporterï¼š</p><table><thead><tr><th>Exporter ç±»å‹</th><th>ä½œç”¨</th><th>å¤‡æ³¨</th><th>å‚æ•°</th></tr></thead><tbody><tr><td>OTLP Exporter</td><td>é€šè¿‡ OpenTelemetry Protocolï¼ˆOTLPï¼‰ å‘é€æŒ‡æ ‡æ•°æ®åˆ° collectã€‚</td><td>é»˜è®¤ç”Ÿäº§ç¯å¢ƒä¸­æ¨èä½¿ç”¨ï¼Œéœ€è¦å°†æ•°æ®å‘é€åˆ°æ”¯æŒ OTLP çš„åç«¯ï¼Œå¦‚ OpenTelemetry Collectorã€‚</td><td>-Dotel.metrics.exporter&#x3D;otlp (default)</td></tr><tr><td>Console Exporter</td><td>å°†æŒ‡æ ‡æ•°æ®æ‰“å°åˆ°æ§åˆ¶å°çš„å¯¼å‡ºå™¨ã€‚</td><td>å¼€å‘å’Œè°ƒè¯•ï¼Œå¿«é€ŸæŸ¥çœ‹æŒ‡æ ‡æ•°æ®ã€‚</td><td>-Dotel.metrics.exporter&#x3D;console</td></tr><tr><td>Prometheus Exporter</td><td>å°†æŒ‡æ ‡æ•°æ®ä»¥ Prometheus æŠ“å–çš„æ ¼å¼æš´éœ²ç»™ Prometheus æœåŠ¡ã€‚</td><td>ä¸ Prometheus é›†æˆï¼Œé€‚ç”¨äºéœ€è¦ Prometheus ç›‘æ§çš„åœºæ™¯ï¼Œè¿™ä¸ªå¯ä»¥æ— ç¼å’Œä»¥å¾€ä½¿ç”¨ prometheus çš„åœºæ™¯å…¼å®¹</td><td>-Dotel.metrics.exporter&#x3D;prometheus</td></tr></tbody></table><h2 id="Metric-Instruments"><a href="#Metric-Instruments" class="headerlink" title="Metric Instruments"></a>Metric Instruments</h2><p>ä¸ prometheus ç±»ä¼¼ï¼ŒOpenTelemetry ä¹Ÿæä¾›äº†ä»¥ä¸‹å‡ ç§æŒ‡æ ‡ç±»å‹ï¼š</p><ul><li><strong>Counter</strong>ï¼šå•è°ƒé€’å¢è®¡æ•°å™¨ï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥è®°å½•è®¢å•æ•°ã€æ€»çš„è¯·æ±‚æ•°ã€‚</li><li><strong>UpDownCounter</strong>ï¼šä¸ Counter ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒå¯ä»¥é€’å‡ã€‚</li><li><strong>Gauge</strong>ï¼šç”¨äºè®°å½•éšæ—¶åœ¨å˜åŒ–çš„å€¼ï¼Œæ¯”å¦‚å†…å­˜ä½¿ç”¨é‡ã€CPU ä½¿ç”¨é‡ç­‰ã€‚</li><li><strong>Histogram</strong>ï¼šé€šå¸¸ç”¨äºè®°å½•è¯·æ±‚å»¶è¿Ÿã€å“åº”æ—¶é—´ç­‰ã€‚</li></ul><p>åŒæ—¶æ¯ä¸ªæŒ‡æ ‡è¿˜æœ‰ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š</p><ul><li>Nameï¼šåç§°ï¼Œå¿…å¡«ã€‚</li><li>Kindï¼šç±»å‹ï¼Œå¿…å¡«ã€‚</li><li>Unitï¼šå•ä½ï¼Œå¯é€‰ã€‚</li><li>Descriptionï¼šæè¿°ï¼Œå¯é€‰ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">messageInCounter = meter  </span><br><span class="line">        .counterBuilder(MESSAGE_IN_COUNTER)  </span><br><span class="line">        .setUnit(<span class="string">&quot;&#123;message&#125;&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;The total number of messages received for this topic.&quot;</span>)  </span><br><span class="line">        .buildObserver();</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯ä»¥ Pulsar çš„ä¸ºä¾‹ï¼Œ<code>messageInCounter</code> æ˜¯ä¸€ä¸ªè®°å½•æ€»çš„æ¶ˆæ¯æ¥æ”¶æ•°é‡çš„ Counter ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">subscriptionCounter = meter  </span><br><span class="line">        .upDownCounterBuilder(SUBSCRIPTION_COUNTER)  </span><br><span class="line">        .setUnit(<span class="string">&quot;&#123;subscription&#125;&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;The number of Pulsar subscriptions of the topic served by this broker.&quot;</span>)  </span><br><span class="line">        .buildObserver();</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯è®°å½•ä¸€ä¸ªè®¢é˜…è€…æ•°é‡çš„æŒ‡æ ‡ï¼Œç±»å‹æ˜¯ UpDownCounterï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¢åŠ å‡å°‘çš„æŒ‡æ ‡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Double&gt; latencyHistogramBuckets =  </span><br><span class="line">        Lists.newArrayList(<span class="number">.0005</span>, <span class="number">.001</span>, <span class="number">.0025</span>, <span class="number">.005</span>, <span class="number">.01</span>, <span class="number">.025</span>, <span class="number">.05</span>, <span class="number">.1</span>, <span class="number">.25</span>, <span class="number">.5</span>, <span class="number">1.0</span>, <span class="number">2.5</span>, <span class="number">5.0</span>, <span class="number">10.0</span>, <span class="number">30.0</span>, <span class="number">60.0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">DoubleHistogramBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> meter.histogramBuilder(<span class="string">&quot;pulsar.client.producer.message.send.duration&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;Publish latency experienced by the application, includes client batching time&quot;</span>)  </span><br><span class="line">        .setUnit(Unit.Seconds.toString())  </span><br><span class="line">        .setExplicitBucketBoundariesAdvice(latencyHistogramBuckets);</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªè®°å½• Pulsar producer å‘é€å»¶è¿Ÿçš„æŒ‡æ ‡ï¼Œç±»å‹æ˜¯ <code>Histogram</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">backlogQuotaAge = meter  </span><br><span class="line">        .gaugeBuilder(BACKLOG_QUOTA_AGE)  </span><br><span class="line">        .ofLongs()  </span><br><span class="line">        .setUnit(<span class="string">&quot;s&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;The age of the oldest unacknowledged message (backlog).&quot;</span>)  </span><br><span class="line">        .buildObserver();</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªè®°å½•æœ€å¤§ unack ä¹Ÿå°±æ˜¯ backlog æ—¶é—´çš„æŒ‡æ ‡ï¼Œç±»å‹æ˜¯ <code>Gauge</code>ã€‚</p><h1 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h1><p>åœ¨ä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/">å®æˆ˜ï¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª OpenTelemetry Extensions</a>ä¸­è®²è¿‡å¦‚ä½•å¼€å‘ä¸€ä¸ª OpenTelemetry çš„ extensionï¼Œå…¶å®å½“æ—¶æˆ‘å°±æ˜¯å¼€å‘äº†ä¸€ä¸ªç”¨äºåœ¨ Pulsar å®¢æˆ·ç«¯ä¸­æš´éœ²æŒ‡æ ‡çš„ä¸€ä¸ªæ’ä»¶ã€‚</p><blockquote><p>ä¸è¿‡ç›®å‰ Pulsar ç¤¾åŒºå·²ç»é›†æˆäº†è¯¥åŠŸèƒ½ã€‚</p></blockquote><p>å…¶ä¸­çš„æ ¸å¿ƒä»£ç ä¸ä¸Šé¢è®²åˆ°çš„ç±»ä¼¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerObservers</span><span class="params">()</span> &#123;    </span><br><span class="line">    <span class="type">Meter</span> <span class="variable">meter</span> <span class="operator">=</span> MetricsRegistration.getMeter();    </span><br><span class="line">    </span><br><span class="line">    meter.gaugeBuilder(<span class="string">&quot;pulsar_producer_num_msg_send&quot;</span>)    </span><br><span class="line">            .setDescription(<span class="string">&quot;The number of messages published in the last interval&quot;</span>)    </span><br><span class="line">            .ofLongs()    </span><br><span class="line">            .buildWithCallback(    </span><br><span class="line">                    r -&gt; recordProducerMetrics(r, ProducerStats::getNumMsgsSent));</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recordProducerMetrics</span><span class="params">(ObservableLongMeasurement observableLongMeasurement, Function&lt;ProducerStats, Long&gt; getter)</span> &#123;    </span><br><span class="line">    <span class="keyword">for</span> (Producer producer : CollectionHelper.PRODUCER_COLLECTION.list()) &#123;    </span><br><span class="line">        <span class="type">ProducerStats</span> <span class="variable">stats</span> <span class="operator">=</span> producer.getStats();    </span><br><span class="line">        <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> producer.getTopic();    </span><br><span class="line">        <span class="keyword">if</span> (topic.endsWith(RetryMessageUtil.RETRY_GROUP_TOPIC_SUFFIX)) &#123;    </span><br><span class="line">            <span class="keyword">continue</span>;    </span><br><span class="line">        &#125;        observableLongMeasurement.record(getter.apply(stats),    </span><br><span class="line">                Attributes.of(PRODUCER_NAME, producer.getProducerName(), TOPIC, topic));    </span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure><p>åªæ˜¯è¿™é‡Œä½¿ç”¨äº† <code>buildWithCallback</code> å›è°ƒå‡½æ•°ï¼ŒOpenTelemetry ä¼šæ¯éš” 30s è°ƒç”¨ä¸€æ¬¡è¿™ä¸ªå‡½æ•°ï¼Œé€šå¸¸é€‚ç”¨äº Gauge ç±»å‹çš„æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent.jar \  </span><br><span class="line">     -Dotel.javaagent.extensions=ext.jar  \</span><br><span class="line">     -Dotel.metrics.exporter=prometheus \</span><br><span class="line">     -Dotel.exporter.prometheus.port=<span class="number">18180</span> \</span><br><span class="line">     -jar myapp.jar</span><br></pre></td></tr></table></figure><p>é…åˆä¸Š Prometheus çš„ä¸¤ä¸ªå¯åŠ¨å‚æ•°å°±å¯ä»¥åœ¨æœ¬åœ° 18180 ä¸­è·å–åˆ°æŒ‡æ ‡æ•°æ®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:18180/metrics</span><br></pre></td></tr></table></figure><p>å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å‘å¾€ OpenTelemetry-Collector ä¸­ï¼Œå†ç”±å®ƒå‘å¾€ prometheusï¼Œåªæ˜¯è¿™æ ·éœ€è¦é¢å¤–åœ¨ collector ä¸­é…ç½®ä¸€ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">debug:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">otlphttp:</span></span><br><span class="line">    <span class="attr">metrics_endpoint:</span> <span class="string">http://promethus:8480/insert/0/opentelemetry/api/v1/push</span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">exporters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlphttp</span></span><br><span class="line">      <span class="attr">processors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">k8sattributes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">      <span class="attr">receivers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlp</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/05/12/4iMpax5Ptod2Nws.png"></p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ Grafana ä¸­é€šè¿‡ prometheus æŸ¥è¯¢åˆ°æ•°æ®äº†ã€‚</p><p>æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰çš„æŒ‡æ ‡æœ€å¥½æ˜¯å‚è€ƒå®˜æ–¹çš„<a href="https://opentelemetry.io/docs/specs/semconv/general/metrics/">è¯­ä¹‰å’Œå‘½åè§„èŒƒ</a>æ¥å®šä¹‰è¿™äº›æŒ‡æ ‡åç§°ã€‚</p><p><img src="https://s2.loli.net/2024/05/12/vCDZY3ygX7MrzGH.png"></p><p>æ¯”å¦‚ OpenTelemetry çš„è§„èŒƒä¸­åç§°æ˜¯ç”¨ <strong>.</strong> æ¥è¿›è¡Œåˆ†éš”çš„ã€‚</p><blockquote><p>åˆ‡æ¢ä¸º OpenTelemetry ä¹‹åè‡ªç„¶å°±ä¸éœ€è¦ä¾èµ– prometheus çš„åŒ…ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ OTel çš„åŒ…ï¼š</p></blockquote><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compileOnly <span class="string">&#x27;io.opentelemetry:opentelemetry-sdk-extension-autoconfigure-spi:1.34.1&#x27;</span>  </span><br><span class="line">compileOnly <span class="string">&#x27;io.opentelemetry.instrumentation:opentelemetry-instrumentation-api:1.32.0&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç›¸å¯¹æ¥è¯´ Metrics çš„ä½¿ç”¨æ¯” Trace ç®€å•çš„å¤šï¼ŒåŒæ—¶ Metrics å…¶å®ä¹Ÿå¯ä»¥å’Œ Trace è¿›è¡Œå…³è”ï¼Œä¹Ÿå°±æ˜¯ <a href="https://opentelemetry.io/docs/specs/otel/metrics/data-model/#exemplars">Exemplars</a>ï¼Œé™äºç¯‡å¹…å°±ä¸åœ¨æœ¬æ–‡å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/apache/pulsar/blob/master/pulsar-client/src/main/java/org/apache/pulsar/client/impl/metrics/InstrumentProvider.java">https://github.com/apache/pulsar/blob/master/pulsar-client/src/main/java/org/apache/pulsar/client/impl/metrics/InstrumentProvider.java</a></li><li><a href="https://opentelemetry.io/docs/specs/semconv/general/metrics/">https://opentelemetry.io/docs/specs/semconv/general/metrics/</a></li><li><a href="https://opentelemetry.io/docs/specs/otel/metrics/data-model/#exemplars">https://opentelemetry.io/docs/specs/otel/metrics/data-model/#exemplars</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡ï¼š&lt;a href=&quot;https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/&quot;&gt;ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…&lt;/a&gt;æˆ‘ä»¬è®²è§£äº† Trace çš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Trace&lt;/li&gt;
&lt;li&gt;Span&lt;/li&gt;
&lt;li&gt;Context&lt;/li&gt;
&lt;li&gt;Baggage ç­‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™æ¬¡æˆ‘ä»¬æ¥è®²å¦ä¸€ä¸ªè¯é¢˜ &lt;code&gt;Metrics&lt;/code&gt;ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</title>
    <link href="http://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/"/>
    <id>http://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/</id>
    <published>2024-06-05T16:55:16.000Z</published>
    <updated>2024-06-06T13:00:48.174Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¹‹å‰å†™è¿‡ä¸¤ç¯‡æ¯”è¾ƒç³»ç»Ÿçš„å…³äº OpenTelemetry çš„æ–‡ç« ï¼š</p><ul><li><a href="https://juejin.cn/post/7358450927110357026">OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ</a></li><li><a href="https://juejin.cn/post/7360216766373068837">å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯</a></li></ul><p>ä»åŸºæœ¬æ¦‚å¿µåˆ°å¦‚ä½•éƒ¨ç½² demo å®æˆ˜äº†è§£ OpenTelemetryï¼Œä»é‚£ä¸ª demo ä¸­ä¹Ÿå¯ä»¥å¾—çŸ¥æ•´ä¸ª OpenTelemetry ä½“ç³»çš„å¤æ‚æ€§ï¼ŒåŒ…å«äº†å¤ªå¤šçš„ç»„ä»¶å’Œæ¦‚å¿µã€‚</p><p>ä¸ºäº†èƒ½æ›´æ¸…æ™°çš„äº†è§£æ¯ä¸ªå…³é”®ç»„ä»¶çš„ä½œç”¨ä»¥åŠåŸç†ï¼Œæˆ‘æ‰“ç®—åˆ†ä¸ºå‡ æœŸæ¥è®²è§£ OpenTelemetry çš„ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p><ul><li>Trace</li><li>Metrics</li><li>Logs</li></ul><p>é¦–å…ˆä»¥ Trace è®²èµ·ã€‚</p><span id="more"></span><h1 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h1><p>å¼€å§‹ä¹‹å‰è¿˜æ˜¯å…ˆå¤ä¹ ä¸€ä¸‹ Trace çš„å†å²èƒŒæ™¯ã€‚</p><p>å¦‚ä»Šç°ä»£çš„åˆ†å¸ƒå¼è¿½è¸ªçš„èµ·æºæºè‡ªäº Google åœ¨ 2010 å¹´å‘å¸ƒçš„ä¸€ç¯‡è®ºæ–‡ï¼š</p><ul><li><a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/papers/dapper-2010-1.pdf">Dapper, a Large-Scale Distributed Systems Tracing Infrastructure</a></li></ul><p>åœ¨è¿™ç¯‡è®ºæ–‡ä¸­æå‡ºäº†åˆ†å¸ƒå¼è¿½è¸ªçš„å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š</p><ul><li>Trace</li><li>Span<ul><li>Span çš„ä¸€äº›åŸºç¡€æ•°æ®ç»“æ„</li></ul></li><li>å¯è§†åŒ–è¿½è¸ªä»¥åŠå±•ç¤º</li></ul><p>ä¹‹å Twitter å—åˆ°äº† Dapper çš„å¯å‘å¼€æºäº†ç°åœ¨æˆ‘ä»¬ç†ŸçŸ¥çš„ <a href="https://zipkin.io/">Zipkin</a>ï¼ŒåŒ…å«äº†å­˜å‚¨å’Œå¯è§†åŒ– UI å±•ç¤ºæˆ‘ä»¬çš„è¿½è¸ªé“¾è·¯ã€‚</p><p>Uber ä¹Ÿåœ¨ 2015 å¹´å¼€æºäº† <a href="https://www.jaegertracing.io/">Jaeger</a> é¡¹ç›®ï¼Œå®ƒçš„åŠŸèƒ½å’Œ Zipkin ç±»ä¼¼ï¼Œä½†ç›®å‰æˆ‘ä»¬ç”¨çš„è¾ƒå¤šçš„è¿˜æ˜¯ Jaegerï¼›ç°åœ¨å·²ç»æˆä¸º CNCF çš„æ‰˜ç®¡é¡¹ç›®ã€‚</p><p>ä¹‹åé™†ç»­å‡ºç°è¿‡ <strong>OpenTracing</strong> å’Œ <strong>OpenCensus</strong> é¡¹ç›®ï¼Œä»–ä»¬éƒ½ä¼å›¾ç»Ÿä¸€åˆ†å¸ƒå¼è¿½è¸ªè¿™ä¸€é¢†åŸŸã€‚</p><p>ç›´åˆ° <code>OpenTelemetry</code> çš„å‡ºç°æ•´åˆäº†ä»¥ä¸Šä¸¤ä¸ªé¡¹ç›®ï¼Œå¹¶ä¸”é€æ¸æˆä¸ºå¯è§‚æµ‹é¢†åŸŸçš„æ ‡å‡†ã€‚</p><blockquote><p>æ›´å¤šå†å²èƒŒæ™¯å¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://juejin.cn/post/7358450927110357026">OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ</a></p></blockquote><p><img src="https://s2.loli.net/2024/05/05/ljQ6yNhKzn3b1c9.png"></p><p><img src="https://s2.loli.net/2024/05/05/NOEbTamR67x83nS.png"></p><p>è¿™é‡Œæˆ‘ä»¬ç»“åˆ Dapper è®ºæ–‡ä¸­çš„èµ„æ–™è¿›è¡Œåˆ†æï¼Œåœ¨è¿™ä¸ªè°ƒç”¨ä¸­ç”¨æˆ·å‘èµ·äº†ä¸€æ¬¡è¯·æ±‚ï¼Œå†…éƒ¨ç³»ç»Ÿç»å†äº† 4 æ¬¡ RPC è°ƒç”¨ã€‚</p><p>ä»ç¬¬äºŒå¼ å›¾ä¼šçœ‹åˆ°ä¸€äº›å…³é”®ä¿¡æ¯ï¼š</p><ul><li>spanName</li><li>parentId</li><li>spanId</li></ul><p>parentId å¾ˆå¥½ç†è§£ï¼Œä¸»è¦æ˜¯å®šä¹‰è°ƒç”¨çš„ä¸»æ¬¡å…³ç³»ï¼›è¦æ³¨æ„çš„æ˜¯å¹¶è¡Œè°ƒç”¨æ—¶ parentId æ˜¯åŒä¸€ä¸ªã€‚</p><p>spanId åœ¨å¯ä»¥ç†è§£ä¸ºæ¯ä¸€ä¸ªç‹¬ç«‹çš„æ“ä½œï¼Œåœ¨è¿™é‡Œå°±æ˜¯ä¸€æ¬¡ RPC è°ƒç”¨ï¼›åŒç†ä¸€æ¬¡æ•°æ®åº“æ“ä½œã€æ¶ˆæ¯çš„æ”¶å‘éƒ½æ˜¯ä¸€ä¸ª spanã€‚</p><blockquote><p>span çš„æ›´å¤šå†…å®¹åœ¨åæ–‡ç»§ç»­è®²è§£ã€‚</p></blockquote><h1 id="Span"><a href="#Span" class="headerlink" title="Span"></a>Span</h1><p><img src="https://s2.loli.net/2024/05/05/wyzLpbhYkjOUFav.png"><br>å½“æˆ‘ä»¬æŠŠæŸä¸€ä¸ªå…·ä½“çš„ span æ”¾å¤§ä¼šçœ‹åˆ°æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯ï¼Œå…¶ä¸­æœ€å…³é”®çš„å¦‚ä¸‹ï¼š</p><ul><li>traceId</li><li>spanName</li><li>spanId</li><li>parentId</li><li>å¼€å§‹æ—¶é—´</li><li>ç»“æŸæ—¶é—´</li></ul><p>ç”±äºä¸€ä¸ªå®Œæ•´çš„ trace é“¾è·¯ç”± N ä¸ª span ç»„æˆï¼Œæ‰€ä»¥è¿™ä¸ªé“¾è·¯å¿…é¡»å¾—æœ‰ä¸€ä¸ªå”¯ä¸€çš„ traceId å°†è¿™äº› span ä¸²è”èµ·æ¥ã€‚<br>è¿™æ ·æ‰å¯ä»¥åœ¨å¯è§†åŒ–çš„æ—¶å€™æ›´å¥½çš„å±•ç¤ºé“¾è·¯ä¿¡æ¯ã€‚</p><p>ä»¥ä¸Šçš„è¿™äº›å­—æ®µå¾ˆå®¹æ˜“ç†è§£ï¼Œéƒ½æ˜¯ä¸€äº›å¿…é¡»çš„ä¿¡æ¯ã€‚</p><p>åœ¨ Dapper è®ºæ–‡ä¸­ä½¿ç”¨ Annotations æ¥å­˜æ”¾ span çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯åˆšæ‰é‚£äº›å­—æ®µï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å­˜æ”¾ä¸€äº›æ•°æ®ï¼Œæ¯”å¦‚å›¾ä¸­çš„ <code>&quot;foo&quot;</code>ã€‚</p><h2 id="OpenTelemetry-ä¸­çš„-Span"><a href="#OpenTelemetry-ä¸­çš„-Span" class="headerlink" title="OpenTelemetry ä¸­çš„ Span"></a>OpenTelemetry ä¸­çš„ Span</h2><p>OpenTelemetry çš„ trace è‡ªç„¶ä¹Ÿæ˜¯åŸºäº Dapper çš„ï¼Œåªæ˜¯é¢å¤–åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚åœ¨åˆšæ‰é‚£äº›å­—æ®µçš„åŸºç¡€ä¸Šæ–°å¢äº†ä¸€äº›æ¦‚å¿µï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/v1/sys/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;context&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;trace_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7bba9f33312b3dbb8b2c2c62bb7abe2d&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;span_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;086e83747d0e381e&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;parent_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-10-22 16:04:01.209458162 +0000 UTC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;end_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-10-22 16:04:01.209514132 +0000 UTC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status_code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;STATUS_CODE_OK&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status_message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;net.transport&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IP.TCP&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.peer.ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.17.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.peer.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;51820&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.host.ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.177.2.152&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.host.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;26040&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/v1/sys/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.server_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mortar-gateway&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.route&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/v1/sys/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.user_agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Consul Health Check&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.scheme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.177.2.152:26040&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.flavor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;OK&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-10-22 16:04:01.209512872 +0000 UTC&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä»¥è¿™ä¸ª JSON ä¸ºä¾‹ï¼Œæ–°å¢äº†ï¼š</p><ul><li><input disabled="" type="checkbox"> <code>Span Context</code><ul><li><code>Span</code> çš„ä¸Šä¸‹æ–‡ï¼Œå­˜æ”¾çš„éƒ½æ˜¯ä¸å¯å˜çš„æ•°æ®ï¼Œå› ä¸ºæ¯ä¸ª Span ä¹‹é—´æ˜¯å­˜åœ¨å…³è”å…³ç³»çš„ï¼Œè¿™äº›å…³è”å…³ç³»éƒ½æ˜¯å­˜æ”¾åœ¨ context ä¸­ï¼Œä¸»è¦å°±æ˜¯ trace_id, span_id.</li></ul></li><li><code>Attributes</code>: å¯ä»¥ç†è§£ä¸º Dapper ä¸­çš„ Annotationsï¼Œå­˜æ”¾çš„æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„é”®å€¼å¯¹ï¼Œé€šå¸¸æ˜¯ç”±æˆ‘ä»¬å¸¸ç”¨ç¬¬ä¸‰æ–¹å¼€æº Instrumentation å†…ç½®çš„ä¸€äº›å±æ€§ã€‚</li><li><code>Span Events</code>: Span çš„ä¸€äº›å…³é”®äº‹ä»¶ã€‚</li></ul><p><img src="https://s2.loli.net/2024/05/05/3C49thIJOZTuf82.png"><br>æ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„ Redis å®¢æˆ·ç«¯ lettuceï¼Œå®ƒå°±ä¼šè‡ªå·±è®°å½•ä¸€äº› Attributesã€‚</p><hr><p>å¦‚æœæœ‰å¤šä¸ª span å­˜åœ¨ä¾èµ–å…³ç³»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">       [Span A]  â†â†â†(the root span)</span><br><span class="line">           |</span><br><span class="line">    +------+------+</span><br><span class="line">    |             |</span><br><span class="line">[Span B]      [Span C] â†â†â†(Span C is a `child` of Span A)</span><br><span class="line">    |             |</span><br><span class="line">[Span D]      +---+-------+</span><br><span class="line">              |           |</span><br><span class="line">          [Span E]    [Span F]</span><br></pre></td></tr></table></figure><p>å¤§éƒ¨åˆ†çš„å¯è§†åŒ–å·¥å…·éƒ½æ˜¯ä»¥æ—¶é—´çº¿çš„æ–¹å¼è¿›è¡Œå±•ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“&gt; time</span><br><span class="line"></span><br><span class="line"> [Span AÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">   [Span BÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">      [Span DÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">    [Span CÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">         [Span EÂ·Â·Â·Â·Â·Â·Â·]        [Span FÂ·Â·]</span><br></pre></td></tr></table></figure><p>è¿™äº›å’Œ Dapper ä¸­æè¿°çš„æ¦‚å¿µæ²¡æœ‰æœ¬è´¨åŒºåˆ«ã€‚</p><hr><h3 id="Span-Status"><a href="#Span-Status" class="headerlink" title="Span Status"></a>Span Status</h3><p>Span è¿˜å†…ç½®äº†ä¸€äº› Statusï¼š</p><ul><li><code>Unset</code></li><li><code>Error</code></li><li><code>Ok</code></li></ul><p>é»˜è®¤æƒ…å†µä¸‹æ˜¯ Unsetï¼Œå‡ºç°é”™è¯¯æ—¶åˆ™æ˜¯ Errorï¼Œä¸€åˆ‡æ­£å¸¸æ—¶åˆ™æ˜¯ Okã€‚</p><p><img src="https://s2.loli.net/2024/05/05/glkIuxbFDBcai36.png"><br>é€šè¿‡å¯è§†åŒ–é¡µé¢å¾ˆå®¹æ˜“å¾—çŸ¥æŸä¸ª trace ä¸­ span çš„å¼‚å¸¸æƒ…å†µï¼Œç‚¹è¿›å»åå¯ä»¥çœ‹åˆ°å…·ä½“çš„å¼‚å¸¸ span ä»¥åŠå®ƒçš„é”™è¯¯æ—¥å¿—ã€‚</p><h3 id="Span-Kind"><a href="#Span-Kind" class="headerlink" title="Span Kind"></a>Span Kind</h3><p>æœ€åæ˜¯ Span çš„ç±»å‹ï¼š</p><ul><li>Client</li><li>Server</li><li>Internal</li><li>Producer</li><li>Consumer</li></ul><p><img src="https://s2.loli.net/2024/05/05/rMjV9qsveNEKORW.png"></p><p>Client å’Œ Server éå¸¸å¥½ç†è§£ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª gRPC æ¥å£ï¼Œè°ƒç”¨æ–¹çš„ Span æ˜¯ clientï¼Œè€ŒæœåŠ¡ç«¯çš„ Span è‡ªç„¶å°±æ˜¯ Serverã€‚</p><p>Internal åˆ™æ˜¯å†…éƒ¨ç»„ä»¶è°ƒç”¨äº§ç”Ÿçš„ Spanï¼Œè¿™ç±» Span ç›¸å¯¹ä¼šå°‘ä¸€äº›ã€‚</p><p>Producer å’Œ Consumer ä¸€èˆ¬æŒ‡çš„æ˜¯å‘èµ·å¼‚æ­¥è°ƒç”¨æ—¶çš„ Spanï¼Œæˆ‘ä»¬å¸¸è§çš„å°±æ˜¯å¾€æ¶ˆæ¯é˜Ÿåˆ—é‡Œç”Ÿäº§å’Œæ¶ˆè´¹æ¶ˆæ¯ã€‚</p><p>é€šè¿‡è¿™å‡ ç§ç±»å‹çš„ Span ä¹Ÿå¯ä»¥äº†è§£åˆ°ä»€ä¹ˆæƒ…å†µä¸‹ä¼šåˆ›å»º Spanï¼Œé€šå¸¸æ˜¯ä»¥ä¸‹å‡ ç§åœºæ™¯ï¼š</p><ul><li>RPC è°ƒç”¨</li><li>æ•°æ®åº“ï¼ˆRedisã€MySQLã€Mongo ç­‰ç­‰ï¼‰æ“ä½œ</li><li>ç”Ÿäº§å’Œæ¶ˆè´¹æ¶ˆæ¯</li><li>æœ‰æ„ä¹‰çš„å†…éƒ¨è°ƒç”¨</li></ul><p>é€šå¸¸åœ¨ä¸€ä¸ªå‡½æ•°å†…éƒ¨å†è°ƒç”¨å…¶ä»–çš„æœ¬åœ°å‡½æ•°æ˜¯ä¸ç”¨åˆ›å»º span çš„ï¼Œä¸ç„¶è¿™ä¸ªé“¾è·¯ä¼šéå¸¸çš„é•¿ã€‚</p><h2 id="Annotations"><a href="#Annotations" class="headerlink" title="Annotations"></a>Annotations</h2><p>å½“ç„¶ä¹Ÿæœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚æˆ‘çš„æŸä¸ªå†…éƒ¨å‡½æ•°éå¸¸é‡è¦ï¼Œéœ€è¦å•ç‹¬å…³å¿ƒå®ƒçš„è°ƒç”¨æ—¶é•¿ã€‚</p><p>æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Annotations æ¥å•ç‹¬åˆ›å»ºè‡ªå·±çš„ Spanã€‚</p><blockquote><p>è¿™ä¸ª Annotations å’Œ Dapper ä¸­çš„ä¸æ˜¯åŒä¸€ä¸ªï¼Œåªæ˜¯ Java ä¸­çš„æ³¨è§£ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> &#123;  </span><br><span class="line">    Executors.newFixedThreadPool(<span class="number">1</span>).execute(() -&gt; &#123;  </span><br><span class="line">        myMethod(request.getName());  </span><br><span class="line">    &#125;);    </span><br><span class="line">    </span><br><span class="line">    <span class="type">HelloReply</span> <span class="variable">reply</span> <span class="operator">=</span> HelloReply.newBuilder()  </span><br><span class="line">            .setMessage(<span class="string">&quot;Hello ==&gt; &quot;</span> + request.getName())  </span><br><span class="line">            .build();  </span><br><span class="line">    responseObserver.onNext(reply);  </span><br><span class="line">    responseObserver.onCompleted();  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@SneakyThrows</span>  </span><br><span class="line"><span class="meta">@WithSpan</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myMethod</span><span class="params">(<span class="meta">@SpanAttribute(&quot;request.name&quot;)</span> String name)</span> &#123;  </span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>);  </span><br><span class="line">    log.info(<span class="string">&quot;myMethod:&#123;&#125;&quot;</span>, name);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥è¿™æ®µä»£ç ä¸ºä¾‹ï¼Œè¿™æ˜¯ä¸€ä¸ª gRPC çš„æœåŠ¡ç«¯æ¥å£ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¸­è°ƒç”¨äº†ä¸€ä¸ªå‡½æ•° <code>myMethod</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹å¹¶ä¸ä¼šä¸ºå®ƒå•ç‹¬åˆ›å»ºä¸€ä¸ª Spanã€‚</p><p>ä½†å¦‚æœæˆ‘ä»¬æƒ³å•ç‹¬è®°å½•å®ƒï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>@WithSpan</code> è¿™ä¸ªæ³¨è§£ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨  <code>@SpanAttribute</code> æ¥è‡ªå®šä¹‰ attributeã€‚</p><p>æœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/05/05/aBd1ubsS2kxMzGf.png"><br>æ­¤æ—¶å°±ä¼šå•ç‹¬ä¸ºè¿™ä¸ªå‡½æ•°åˆ›å»ºä¸€ä¸ª Spanã€‚</p><blockquote><p>éœ€è¦å•ç‹¬å¼•å…¥ä¸€ä¸ªä¾èµ–:</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry.instrumentation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-instrumentation-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="Context-Propagation"><a href="#Context-Propagation" class="headerlink" title="Context Propagation"></a>Context Propagation</h1><p>ä¸Šä¸‹æ–‡ä¼ æ’­ä¹Ÿæ˜¯ Trace ä¸­éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œåˆšæ‰æåˆ°äº†æ¯ä¸ª Span éƒ½æœ‰è‡ªå·±ä¸å¯å˜çš„ä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆåç»­çš„ Span å¦‚ä½•å’Œä¸Šæ¸¸çš„ Span è¿›è¡Œå…³è”å‘¢ï¼Ÿ</p><p>è¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>åŒä¸€è¿›ç¨‹</li><li>å®è¿›ç¨‹</li></ul><h2 id="åŒä¸€è¿›ç¨‹"><a href="#åŒä¸€è¿›ç¨‹" class="headerlink" title="åŒä¸€è¿›ç¨‹"></a>åŒä¸€è¿›ç¨‹</h2><p>åŒä¸€ä¸ªè¿›ç¨‹ä¹Ÿåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ul><li>å•çº¿ç¨‹</li><li>å¤šçº¿ç¨‹</li></ul><p>å•çº¿ç¨‹çš„æ¯”è¾ƒå¥½å¤„ç†ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠæ•°æ®å†™å…¥ <code>ThreadLocal</code> ä¸­å°±å¯ä»¥åšåˆ°çº¿ç¨‹éš”ç¦»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Context&gt; THREAD_LOCAL_STORAGE = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="meta">@Nullable</span>  </span><br><span class="line"><span class="keyword">public</span> Context <span class="title function_">current</span><span class="params">()</span> &#123;  </span><br><span class="line">  <span class="keyword">return</span> THREAD_LOCAL_STORAGE.get();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç‚¹æˆ‘ä»¬å¯ä»¥é€šè¿‡æºç  <code>io.opentelemetry.context.ThreadLocalContextStorage</code>çœ‹åˆ°å…·ä½“çš„å®ç°è¿‡ç¨‹ã€‚</p><p>è€Œå¦‚æœæ˜¯å¤šçº¿ç¨‹æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Executors.newFixedThreadPool(<span class="number">1</span>).execute(() -&gt; &#123;  </span><br><span class="line">    myMethod(request.getName());  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>åˆ™éœ€è¦å¯¹ä½¿ç”¨çš„çº¿ç¨‹æ± è¿›è¡Œå•ç‹¬å¤„ç†ï¼Œå°†çˆ¶çº¿ç¨‹ä¸­ threadlocal ä¸­çš„æ•°æ®æ‹·è´å‡ºæ¥è¿›è¡Œä¼ é€’ï¼Œæ¯”å¦‚æœ‰é˜¿é‡Œæä¾›çš„ <code>TransmittableThreadLocal</code>ï¼Œå¯ä»¥æä¾›å¯¹çº¿ç¨‹æ± çš„æ”¯æŒã€‚</p><h2 id="è·¨è¿›ç¨‹"><a href="#è·¨è¿›ç¨‹" class="headerlink" title="è·¨è¿›ç¨‹"></a>è·¨è¿›ç¨‹</h2><p>è€Œå¦‚æœæ˜¯å®è¿›ç¨‹çš„åœºæ™¯ï¼Œå°±éœ€è¦å°† context çš„ä¿¡æ¯è¿›è¡Œåºåˆ—åŒ–ä¼ é€’ã€‚</p><p>å¦‚æœæ˜¯ gRPC è°ƒç”¨ä¼šå°†ä¿¡æ¯å­˜æ”¾åˆ° metadata ä¸­ã€‚</p><p>HTTP è°ƒç”¨åˆ™æ˜¯å­˜æ”¾åœ¨ header ä¸­ã€‚</p><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯”å¦‚ Pulsar ä¹Ÿå¯ä»¥å°†æ•°æ®å­˜æ”¾åœ¨æ¶ˆæ¯ä¸­çš„ header ä¸­è¿›è¡Œä¼ é€’ã€‚</p><p>æ•°æ®ä¸€æ—¦è·¨è¿›ç¨‹ä¼ è¾“æˆåŠŸåï¼Œå°±å’Œå•è¿›ç¨‹ä¸€æ ·çš„å¤„ç†æ–¹å¼äº†ã€‚</p><h2 id="Baggage"><a href="#Baggage" class="headerlink" title="Baggage"></a>Baggage</h2><p><img src="https://s2.loli.net/2024/05/05/3c6LNtIbSkpQlRU.png"></p><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦é€šè¿‡å® Span ä¼ é€’ä¿¡æ¯ï¼Œæ¯”å¦‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š<br>æˆ‘ä»¬éœ€è¦åœ¨ serverB ä¸­æ‹¿åˆ° serverA ä¸­æ”¶åˆ°çš„ä¸€ä¸ªè¯·æ±‚å‚æ•°ï¼š <code>http://127.0.0.1:8181/request\?name\=1232</code></p><p><img src="https://s2.loli.net/2024/05/05/hISQNv91KP85WFC.png"></p><p>è¿™ä¸ªæ•°æ®é»˜è®¤ä¼šä½œä¸º span çš„ attribute ï¼Œä½†åªä¼šå­˜åœ¨äºç¬¬ä¸€ä¸ª spanã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨åç»­çš„ span ä¸­ä¹Ÿèƒ½æ‹¿åˆ°è¿™ä¸ªæ•°æ®ï¼Œç”šè‡³æ˜¯å®è¿›ç¨‹ä¹Ÿèƒ½è·å–åˆ°ã€‚</p><p>é‚£å°±éœ€è¦ä½¿ç”¨ <code>Baggage</code> è¿™ä¸ªå¯¹è±¡äº†ã€‚</p><p>å®ƒçš„ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line"><span class="comment">// å†™å…¥</span></span><br><span class="line">    Baggage.current().toBuilder().  </span><br><span class="line">          put(<span class="string">&quot;request.name&quot;</span>, name).build()  </span><br><span class="line">          .storeInContext(Context.current()).makeCurrent();</span><br><span class="line">&#125;         </span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–</span></span><br><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> Baggage.current().getEntryValue(<span class="string">&quot;request.name&quot;</span>);  </span><br><span class="line">log.info(<span class="string">&quot;request.name: &#123;&#125;&quot;</span>, value);</span><br></pre></td></tr></table></figure><p>åªè¦æ˜¯å±äºåŒä¸€ä¸ª trace çš„è°ƒç”¨å°±å¯ä»¥ç›´æ¥è·å–åˆ°æ•°æ®ã€‚<br><img src="https://s2.loli.net/2024/05/05/Lz1hY8pflRebANx.png"></p><blockquote><p>traceId ä¹Ÿæ˜¯å® Span ä¼ é€’çš„ã€‚</p></blockquote><p>è€Œå®ƒçš„åŸç†ä¹Ÿæ˜¯é€šè¿‡å¾€ context ä¸­å†™å…¥æ•°æ®å®ç°çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Immutable</span>  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaggageContextKey</span> &#123;  </span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> ContextKey&lt;Baggage&gt; KEY = ContextKey.named(<span class="string">&quot;opentelemetry-baggage-key&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">BaggageContextKey</span><span class="params">()</span> &#123;&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/05/05/vIHtBxGATKOg13l.png"><br>è€Œè¿™ä¸ª context æ˜¯é€šè¿‡ä¸€ä¸ª entries æ•°æ®å­˜å‚¨æ•°æ®çš„ï¼Œä¸ç®¡æ˜¯åœ¨å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨çš„è·¨è¿›ç¨‹è°ƒç”¨ï¼ŒOpenTelemetry éƒ½ä¼šå°† context é€šè¿‡ <code>Context Propagation</code> ä¼ é€’å‡ºå»ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>Trace è¿™éƒ¨åˆ†çš„å†…å®¹æˆ‘è§‰å¾—æ¯” Metrics å’Œ Logs æ›´åŠ å¤æ‚ä¸€äº›ï¼Œæ¯•ç«Ÿå¤šäº†ä¸€äº›æ•°æ®ç»“æ„ï¼›ç°åœ¨çš„å†…å®¹ä¹Ÿåªæ˜¯å†°å±±ä¸€è§’ï¼Œç°åœ¨ä¹Ÿåœ¨åš trace çš„ä¸€äº›å®šåˆ¶åŒ–å¼€å‘ï¼Œåç»­æœ‰æ–°çš„è¿›å±•ä¼šæ¥ç€æ›´æ–°ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/papers/dapper-2010-1.pdf">https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/papers/dapper-2010-1.pdf</a></li><li><a href="https://opentelemetry.io/docs/languages/java/automatic/annotations/">https://opentelemetry.io/docs/languages/java/automatic/annotations/</a></li><li><a href="https://opentelemetry.io/docs/specs/otel/overview/#tracing-signal">https://opentelemetry.io/docs/specs/otel/overview/#tracing-signal</a></li><li><a href="https://opentelemetry.io/docs/concepts/context-propagation/">https://opentelemetry.io/docs/concepts/context-propagation/</a></li><li><a href="https://opentelemetry.io/docs/concepts/observability-primer/#distributed-traces">https://opentelemetry.io/docs/concepts/observability-primer/#distributed-traces</a></li><li><a href="https://tech.meituan.com/2023/04/20/traceid-google-dapper-mtrace.html">https://tech.meituan.com/2023/04/20/traceid-google-dapper-mtrace.html</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨ä¹‹å‰å†™è¿‡ä¸¤ç¯‡æ¯”è¾ƒç³»ç»Ÿçš„å…³äº OpenTelemetry çš„æ–‡ç« ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7358450927110357026&quot;&gt;OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7360216766373068837&quot;&gt;å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»åŸºæœ¬æ¦‚å¿µåˆ°å¦‚ä½•éƒ¨ç½² demo å®æˆ˜äº†è§£ OpenTelemetryï¼Œä»é‚£ä¸ª demo ä¸­ä¹Ÿå¯ä»¥å¾—çŸ¥æ•´ä¸ª OpenTelemetry ä½“ç³»çš„å¤æ‚æ€§ï¼ŒåŒ…å«äº†å¤ªå¤šçš„ç»„ä»¶å’Œæ¦‚å¿µã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†èƒ½æ›´æ¸…æ™°çš„äº†è§£æ¯ä¸ªå…³é”®ç»„ä»¶çš„ä½œç”¨ä»¥åŠåŸç†ï¼Œæˆ‘æ‰“ç®—åˆ†ä¸ºå‡ æœŸæ¥è®²è§£ OpenTelemetry çš„ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Trace&lt;/li&gt;
&lt;li&gt;Metrics&lt;/li&gt;
&lt;li&gt;Logs&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é¦–å…ˆä»¥ Trace è®²èµ·ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
</feed>
