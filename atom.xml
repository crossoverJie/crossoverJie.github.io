<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>crossoverJie&#39;s Blog</title>
  
  <subtitle>baller</subtitle>
  <link href="http://crossoverjie.top/atom.xml" rel="self"/>
  
  <link href="http://crossoverjie.top/"/>
  <updated>2024-08-20T06:30:43.708Z</updated>
  <id>http://crossoverjie.top/</id>
  
  <author>
    <name>crossoverJie</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>OpenTelemetry å®æˆ˜ï¼šä»é›¶å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª</title>
    <link href="http://crossoverjie.top/2024/08/20/ob/OpenTelemetry-01-trace/"/>
    <id>http://crossoverjie.top/2024/08/20/ob/OpenTelemetry-01-trace/</id>
    <published>2024-08-20T06:53:35.000Z</published>
    <updated>2024-08-20T06:30:43.708Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡ <a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</a>çš„æ–‡ç« ï¼Œä¸»è¦æ˜¯ä»æ¦‚å¿µä¸Šè®²è§£äº† Trace åœ¨ OpenTelemetry çš„ä¸­çš„åœºæ™¯å’Œä½¿ç”¨ã€‚</p><p>ä¹Ÿå†™è¿‡ä¸€ç¯‡ <a href="https://crossoverjie.top/2024/05/26/ob/OTel-demo/">å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯</a>ï¼šå¦‚ä½•ä»ä¸€ä¸ª demo å¼€å§‹é›†æˆ OpenTelemetryã€‚</p><p>ä½†è¿˜æ˜¯æœ‰ä¸å°‘å°ä¼™ä¼´åé¦ˆè¯´æ— æ³•å¿«é€Ÿä¸Šæ‰‹ï¼ˆå¯èƒ½ä¹Ÿæ˜¯è¿™ä¸ª demo çš„é¡¹ç›®æ¯”è¾ƒå¤šï¼‰ï¼Œäºæ˜¯æˆ‘å‡†å¤‡ä» 0 å¼€å§‹ä»çœŸå®çš„ä»£ç ä¸€æ­¥æ­¥å¸¦å¤§å®¶é›†æˆ <code>OpenTelemetry</code>ï¼Œå› ä¸º OpenTelemetry æœ¬èº«æ˜¯è·¨å¤šç§è¯­è¨€çš„ï¼Œæ‰€ä»¥ä¹Ÿä¼šä»¥ä¸¤ç§è¯­è¨€ä¸ºï¼ˆJavaã€Golangï¼‰ä¸»è¿›è¡Œè®²è§£ã€‚</p><blockquote><p>ä½¿ç”¨è¿™ä¸¤ç§è¯­è¨€ä¸»è¦æ˜¯å› ä¸º Java å‡ ä¹å…¨æ˜¯è‡ªåŠ¨åŸ‹ç‚¹ï¼Œè€Œ Golang å› ä¸ºè¯­è¨€ç‰¹æ€§ï¼Œå¤§éƒ¨åˆ†éƒ½å¾—ç¡¬ç¼–ç åŸ‹ç‚¹ï¼›è¦†ç›–åˆ°è¿™ä¸¤ç§åœºæ™¯åå…¶ä»–è¯­è¨€ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œé¡¶å¤šåªæ˜¯ API åç§°æœ‰äº›è®¸åŒºåˆ«ã€‚</p></blockquote><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿä¼šç©¿æ’ä¸€äº› OpenTelemetry çš„åŸç†ï¼Œå¸Œæœ›æ•´ä¸ªè¿‡ç¨‹ä¸‹æ¥å¤§å®¶å¯ä»¥åœ¨é¡¹ç›®ä¸­å®é™…è¿ç”¨èµ·æ¥ï¼ŒåŒæ—¶ä¹Ÿèƒ½çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p><h1 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h1><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹é¡¹ç›®ï¼š</p><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th><th>è¯­è¨€</th><th>ç‰ˆæœ¬</th></tr></thead><tbody><tr><td>java-demo</td><td>å‘é€ gRPC è¯·æ±‚çš„å®¢æˆ·ç«¯</td><td>Java</td><td>opentelemetry-agent: 2.4.0&#x2F;SpringBoot: 2.7.14</td></tr><tr><td>k8s-combat</td><td>æä¾› gRPC æœåŠ¡çš„æœåŠ¡ç«¯</td><td>Golang</td><td>go.opentelemetry.io&#x2F;otel: 1.28&#x2F; Go: 1.22</td></tr><tr><td>Jaeger</td><td>trace å­˜å‚¨çš„æœåŠ¡ç«¯ä»¥åŠ TraceUI å±•ç¤º</td><td>Golang</td><td>jaegertracing&#x2F;all-in-one:1.56</td></tr><tr><td>opentelemetry-collector-contrib</td><td>OpenTelemetry çš„ collector æœåŠ¡ç«¯ï¼Œç”¨äºæ”¶é›† trace&#x2F;metrics&#x2F;logs ç„¶åå†™å…¥åˆ°è¿œç«¯å­˜å‚¨</td><td>Golang</td><td>otel&#x2F;opentelemetry-collector-contrib:0.98.0</td></tr></tbody></table><p><img src="https://s2.loli.net/2024/07/15/u4BYXOkztqyUoEK.png" alt="image.png"></p><p>åœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹çœ‹å®é™…çš„æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŠŠ collector å’Œ Jaeger éƒ¨ç½²å¥½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -d --name jaeger \</span><br><span class="line">  -e COLLECTOR_ZIPKIN_HOST_PORT=:9411 \</span><br><span class="line">  -p 6831:6831/udp \</span><br><span class="line">  -p 6832:6832/udp \</span><br><span class="line">  -p 5778:5778 \</span><br><span class="line">  -p 16686:16686 \</span><br><span class="line">  -p 4317:4317 \</span><br><span class="line">  -p 4318:4318 \</span><br><span class="line">  -p 14250:14250 \</span><br><span class="line">  -p 14268:14268 \</span><br><span class="line">  -p 14269:14269 \</span><br><span class="line">  -p 9411:9411 \</span><br><span class="line">  jaegertracing/all-in-one:1.56</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run --rm -d -v $(pwd)/coll-config.yaml:/etc/otelcol-contrib/config.yaml --name coll \</span><br><span class="line">-p 5318:4318 \</span><br><span class="line">-p 5317:4317 \</span><br><span class="line">otel/opentelemetry-collector-contrib:0.98.0</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ª <code>coll-config</code> çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">protocols:</span></span><br><span class="line">      <span class="attr">grpc:</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">debug:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">&quot;127.0.0.1:4317&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="attr">batch:</span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">traces:</span></span><br><span class="line">      <span class="attr">receivers:</span> [<span class="string">otlp</span>]</span><br><span class="line">      <span class="attr">processors:</span> [<span class="string">batch</span>]</span><br><span class="line">      <span class="attr">exporters:</span> [<span class="string">otlp</span>, <span class="string">debug</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é‡ç‚¹æ˜¯è¿™é‡Œçš„ <code>endpoint: &quot;127.0.0.1:4317&quot;</code> æˆ‘ä»¬éœ€è¦é…ç½®ä½ Jaeger çš„ IP å’Œç«¯å£ã€‚</p><blockquote><p>æ›´å¤šå…³äºè¿™é‡Œçš„é…ç½®ä¼šåœ¨åç»­å•ç‹¬çš„ collector ç« èŠ‚ä¸­è®²è§£ã€‚</p></blockquote><p>è¿™ä¸¤ä¸ªæœåŠ¡éƒ½å¯åŠ¨æˆåŠŸåå†å¯åŠ¨æˆ‘ä»¬çš„ Java å®¢æˆ·ç«¯å’Œ  Go  æœåŠ¡ç«¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.traces.exporter=otlp \</span><br><span class="line">-Dotel.metrics.exporter=otlp \</span><br><span class="line">-Dotel.logs.exporter=none \</span><br><span class="line">-Dotel.service.name=demo \</span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \</span><br><span class="line">-Dotel.propagators=tracecontext,baggage \</span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Golang</span></span><br><span class="line">export OTEL_EXPORTER_OTLP_ENDPOINT=http://127.0.0.1:5317</span><br><span class="line">export OTEL_RESOURCE_ATTRIBUTES=service.name=k8s-combat</span><br><span class="line">./k8s-combat</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸ç®¡æ˜¯ Java è¿˜æ˜¯ Golang åº”ç”¨éƒ½æ˜¯éœ€è¦é…ç½® <code>OTEL_EXPORTER_OTLP_ENDPOINT</code> å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ <code>opentelemetry-collector-contrib</code> çš„åœ°å€ã€‚</p><blockquote><p>å…¶ä½™çš„ä¸€äº›é…ç½®åœ¨åé¢ä¼šè®²åˆ°ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:9191/request\?name\=1232</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è§¦å‘ä¸€ä¸‹ Java å®¢æˆ·ç«¯çš„å…¥å£ï¼Œå°±å¯ä»¥åœ¨ JaegerUI ä¸­æŸ¥è¯¢åˆ°åˆšæ‰çš„é“¾è·¯äº†ã€‚<br><code>http://localhost:16686/search</code></p><p><img src="https://s2.loli.net/2024/07/15/skNmSDJaPfHh3GB.png" alt="image.png"><br><img src="https://s2.loli.net/2024/07/15/xoG2finOmFlDReE.png" alt="image.png"><br>è¿™æ ·æ•´ä¸ª <code>trace</code> é“¾è·¯å°±ä¸²èµ·æ¥äº†ã€‚</p><h1 id="Java-åº”ç”¨"><a href="#Java-åº”ç”¨" class="headerlink" title="Java åº”ç”¨"></a>Java åº”ç”¨</h1><p>ä¸‹é¢æ¥çœ‹çœ‹å…·ä½“çš„åº”ç”¨ä»£ç é‡Œæ˜¯å¦‚ä½•ç¼–å†™çš„ã€‚</p><blockquote><p>Java æ˜¯åŸºäº springboot ç¼–å†™çš„ï¼Œå…·ä½“ springboot çš„ä½¿ç”¨å°±ä¸å†èµ˜è¿°äº†ã€‚</p></blockquote><p>å› ä¸ºæˆ‘ä»¬åº”ç”¨æ˜¯ä½¿ç”¨ gRPC é€šä¿¡çš„ï¼Œæ‰€ä»¥éœ€è¦æä¾›ä¸€ä¸ª <code>helloworld.proto</code> çš„ pb æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;  </span><br><span class="line">  </span><br><span class="line">option go_package = &quot;google.golang.org/grpc/examples/helloworld/helloworld&quot;;  </span><br><span class="line">option java_multiple_files = true;  </span><br><span class="line">option java_package = &quot;io.grpc.examples.helloworld&quot;;  </span><br><span class="line">option java_outer_classname = &quot;HelloWorldProto&quot;;  </span><br><span class="line">  </span><br><span class="line">package helloworld;  </span><br><span class="line">  </span><br><span class="line">// The greeting service definition.  </span><br><span class="line">service Greeter &#123;  </span><br><span class="line">  // Sends a greeting  </span><br><span class="line">  rpc SayHello (HelloRequest) returns (HelloReply) &#123;&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// The request message containing the user&#x27;s name.  </span><br><span class="line">message HelloRequest &#123;  </span><br><span class="line">  string name = 1;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// The response message containing the greetings  </span><br><span class="line">message HelloReply &#123;  </span><br><span class="line">  string message = 1;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶ä¹Ÿæ²¡å•¥å¥½è¯´çš„ï¼Œå°±å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„ <code>SayHello</code> æ¥å£ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.devh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨ Java ä¸­ä½¿ç”¨äº† <code>grpc-spring-boot-starter</code> è¿™ä¸ªåº“æ¥å¤„ç† gRPC çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¯·æ±‚ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">grpc:</span>  </span><br><span class="line">  <span class="attr">server:</span>  </span><br><span class="line">    <span class="attr">port:</span> <span class="number">9192</span>  </span><br><span class="line">  <span class="attr">client:</span>  </span><br><span class="line">    <span class="attr">greeter:</span>  </span><br><span class="line">      <span class="attr">address:</span> <span class="string">&#x27;static://127.0.0.1:50051&#x27;</span>  </span><br><span class="line">      <span class="attr">enableKeepAlive:</span> <span class="literal">true</span>  </span><br><span class="line">      <span class="attr">keepAliveWithoutCalls:</span> <span class="literal">true</span>  </span><br><span class="line">      <span class="attr">negotiationType:</span> <span class="string">plaintext</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ¥å£ç”¨äºæ¥æ”¶è¯·æ±‚è§¦å‘ <code>gRPC</code> çš„è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line">   log.info(<span class="string">&quot;request: &#123;&#125;&quot;</span>, request);    </span><br><span class="line">   <span class="type">HelloReply</span> <span class="variable">abc</span> <span class="operator">=</span> greeterStub.sayHello(io.grpc.examples.helloworld.HelloRequest.newBuilder().setName(request.getName()).build());   </span><br><span class="line">   <span class="keyword">return</span> abc.getMessage();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Java åº”ç”¨çš„å®ç°éå¸¸ç®€å•ï¼Œå’Œæˆ‘ä»¬æ—¥å¸¸æ—¥å¸¸å¼€å‘æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼›å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯åœ¨å¯åŠ¨æ—¶éœ€è¦åŠ å…¥ä¸€ä¸ª <code>javaagent</code>ä»¥åŠä¸€äº›å¯åŠ¨å‚æ•°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.traces.exporter=otlp \</span><br><span class="line">-Dotel.metrics.exporter=otlp \</span><br><span class="line">-Dotel.logs.exporter=none \</span><br><span class="line">-Dotel.service.name=demo \</span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \</span><br><span class="line">-Dotel.propagators=tracecontext,baggage \</span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ¥ä»”ç»†çœ‹çœ‹è¿™äº›å‚æ•°</p><table><thead><tr><th>åç§°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar</td><td>è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼ŒæŒ‡å®šä¸€ä¸ª javaagent</td></tr><tr><td>otel.traces.exporter</td><td>æŒ‡å®š trace ä»¥ä»€ä¹ˆæ ¼å¼ä¼ è¾“ï¼ˆé»˜è®¤æ˜¯è¿™é‡Œçš„ <code>otlp</code>)ï¼›å½“ç„¶è¿˜æœ‰å…¶ä»–çš„å€¼ï¼š<code>logging/jaeger/zipkin</code> ç­‰ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨ otlp ä¼šå°†æ•°æ®ä¼ è¾“åˆ° collector ä¸­ã€‚</td></tr><tr><td>otel.metrics.exporter</td><td>åŒä¸Šï¼Œåªæ˜¯æŒ‡å®šçš„æ˜¯ metrics çš„ä¼ è¾“æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ä¹‹åè®²è§£æŒ‡æ ‡çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</td></tr><tr><td>otel.service.name</td><td>å®šä¹‰åœ¨ trace ä¸­çš„åº”ç”¨åç§°ï¼Œspringboot ä¼šé»˜è®¤ä½¿ç”¨ <code>spring.application.name</code> è¿™ä¸ªå˜é‡ã€‚</td></tr><tr><td>otel.exporter.otlp.protocol</td><td>æŒ‡å®šä¼ è¾“åè®®ï¼›é™¤äº† grpc ä¹‹å¤–è¿˜æœ‰ <code>http/protobuf</code>ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ® trace å’Œ metrics åˆ†å¼€æŒ‡å®šï¼š<code>otel.exporter.otlp.traces.protocol/otel.exporter.otlp.metrics.protocol</code></td></tr><tr><td>otel.propagators</td><td>æŒ‡å®šæˆ‘ä»¬è·¨æœåŠ¡ä¼ æ’­ä¸Šä¸‹æ–‡çš„æ—¶å€™ä½¿ç”¨å“ªç§æ ¼å¼ï¼Œé»˜è®¤æ˜¯ <a href="https://www.w3.org/TR/trace-context/">W3C Trace Context</a>,<a href="https://www.w3.org/TR/baggage/">baggage</a>ï¼Œå½“ç„¶ä¹Ÿæœ‰å…¶ä»–çš„- <code>&quot;b3&quot;</code>:Â <a href="https://github.com/openzipkin/b3-propagation#single-header">B3 Single</a>ï¼Œ- <code>&quot;xray&quot;</code>:Â <a href="https://docs.aws.amazon.com/xray/latest/devguide/xray-concepts.html#xray-concepts-tracingheader">AWS X-Ray</a>ï¼Œ<code>&quot;jaeger&quot;</code>:Â <a href="https://www.jaegertracing.io/docs/1.21/client-libraries/#propagation-format">Jaeger</a>ç­‰</td></tr><tr><td>otel.exporter.otlp.endpoint</td><td>æŒ‡å®š collector çš„ endpoint</td></tr><tr><td>æ›´å¤šç»†èŠ‚çš„å‚æ•°å¤§å®¶å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼š</td><td></td></tr><tr><td><a href="https://opentelemetry.io/docs/languages/java/configuration/">https://opentelemetry.io/docs/languages/java/configuration/</a></td><td></td></tr></tbody></table><h1 id="Golang-åº”ç”¨"><a href="#Golang-åº”ç”¨" class="headerlink" title="Golang åº”ç”¨"></a>Golang åº”ç”¨</h1><p>æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹ Go æ˜¯å¦‚ä½•é›†æˆ <code>OpenTelemetry</code> çš„ã€‚</p><p>åœ¨åˆ›å»ºå¥½é¡¹ç›®ä¹‹åæˆ‘ä»¬éœ€è¦æ·»åŠ  <code>OpenTelemetry</code> æ‰€æä¾›çš„åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">go get &quot;go.opentelemetry.io/otel&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/exporters/otlp/otlpmetric/otlpmetricgrpc&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/propagation&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/sdk/metric&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/sdk/resource&quot; \</span><br><span class="line">  &quot;go.opentelemetry.io/otel/sdk/trace&quot; \       &quot;go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc&quot;\</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªåˆå§‹åŒ– <code>tracer</code> çš„å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initTracerProvider</span><span class="params">()</span></span> *sdktrace.TracerProvider &#123;</span><br><span class="line">ctx := context.Background()</span><br><span class="line"></span><br><span class="line">exporter, err := otlptracegrpc.New(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;new otlp trace grpc exporter failed: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">tp := sdktrace.NewTracerProvider(</span><br><span class="line">sdktrace.WithBatcher(exporter),</span><br><span class="line">sdktrace.WithResource(initResource()),</span><br><span class="line">)</span><br><span class="line">otel.SetTracerProvider(tp)</span><br><span class="line">otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(propagation.TraceContext&#123;&#125;, propagation.Baggage&#123;&#125;))</span><br><span class="line"><span class="keyword">return</span> tp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <code>grpc</code> åè®®ä¸ŠæŠ¥ <code>otlp</code> æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>exporter, err := otlptracegrpc.New(ctx)</code>  åˆ›å»ºäº†ä¸€ä¸ª <code>exporter</code>ã€‚</p><p><code>otel.SetTextMapPropagator()</code> è¿™ä¸ªå‡½æ•°é‡Œé…ç½®æ•°æ®å’Œåˆšæ‰ Java é‡Œé…ç½®çš„ <code>-Dotel.propagators=tracecontext,baggage</code> æ˜¯ä¸€æ ·çš„æ•ˆæœã€‚</p><p>ä¸æ­¤åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦æä¾›ä¸€ä¸ª <code>initResource()</code> çš„å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initResource</span><span class="params">()</span></span> *sdkresource.Resource &#123;</span><br><span class="line">initResourcesOnce.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">extraResources, _ := sdkresource.New(</span><br><span class="line">context.Background(),</span><br><span class="line">sdkresource.WithOS(),</span><br><span class="line">sdkresource.WithProcess(),</span><br><span class="line">sdkresource.WithContainer(),</span><br><span class="line">sdkresource.WithHost(),</span><br><span class="line">)</span><br><span class="line">resource, _ = sdkresource.Merge(</span><br><span class="line">sdkresource.Default(),</span><br><span class="line">extraResources,</span><br><span class="line">)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> resource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ç”¨æ¥å‘Šè¯‰ trace éœ€è¦æš´éœ²é‚£äº› resourceï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°è¿›ç¨‹ç›¸å…³çš„å±æ€§ï¼š<br><img src="https://s2.loli.net/2024/07/15/Gveu4hNjWdYLiBo.png" alt="image.png"><br>æ¯”å¦‚è¿™é‡Œçš„ <code>sdkresource.WithOS(),</code> å°±ä¼šæ˜¾ç¤º OS çš„ç±»å‹å’Œæè¿°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithOS</span><span class="params">()</span></span> Option &#123;  </span><br><span class="line">    <span class="keyword">return</span> WithDetectors(  </span><br><span class="line">       osTypeDetector&#123;&#125;,  </span><br><span class="line">       osDescriptionDetector&#123;&#125;,  </span><br><span class="line">    )&#125;</span><br></pre></td></tr></table></figure><p>è€Œ <code>sdkresource.WithProcess(),</code> æ˜¾ç¤ºçš„æ•°æ®å°±æ›´å¤šäº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithProcess</span><span class="params">()</span></span> Option &#123;  </span><br><span class="line">    <span class="keyword">return</span> WithDetectors(  </span><br><span class="line">       processPIDDetector&#123;&#125;,  </span><br><span class="line">       processExecutableNameDetector&#123;&#125;,  </span><br><span class="line">       processExecutablePathDetector&#123;&#125;,  </span><br><span class="line">       processCommandArgsDetector&#123;&#125;,  </span><br><span class="line">       processOwnerDetector&#123;&#125;,  </span><br><span class="line">       processRuntimeNameDetector&#123;&#125;,  </span><br><span class="line">       processRuntimeVersionDetector&#123;&#125;,  </span><br><span class="line">       processRuntimeDescriptionDetector&#123;&#125;,  </span><br><span class="line">    )&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä»¥ä¸Šè¿™äº›ä»£ç åœ¨ Java ä¸­éƒ½æ˜¯ç”± agent æŒ‡å®šåˆ›å»ºçš„ã€‚</p></blockquote><hr><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Init OpenTelemetry start  </span></span><br><span class="line">tp := initTracerProvider()  </span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> err := tp.Shutdown(context.Background()); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Printf(<span class="string">&quot;Error shutting down tracer provider: %v&quot;</span>, err)  </span><br><span class="line">    &#125;&#125;()  </span><br><span class="line">   </span><br><span class="line">err := runtime.Start(runtime.WithMinimumReadMemStatsInterval(time.Second))  </span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Err(err)  </span><br><span class="line">&#125;</span><br><span class="line">tracer = tp.Tracer(<span class="string">&quot;k8s-combat&quot;</span>)</span><br><span class="line"><span class="comment">// Init OpenTelemetry end</span></span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬éœ€è¦åœ¨ main å‡½æ•°ä¸€å¼€å§‹å°±åˆå§‹åŒ– <code>traceProvider</code>ã€‚</p><p>å¯¹äº <code>grpc</code> æ¥è¯´ï¼Œ<code>OpenTelemetry</code> çš„ Go-SDK æä¾›äº†è‡ªåŠ¨åŸ‹ç‚¹ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¾—æ‰‹åŠ¨é…ç½®ä¸€ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s := grpc.NewServer(  </span><br><span class="line">    grpc.StatsHandler(otelgrpc.NewServerHandler()),  </span><br><span class="line">)  </span><br><span class="line">pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>grpc.StatsHandler(otelgrpc.NewServerHandler()),</code>  å°† <code>OTel</code> çš„ <code>serverHandle</code> åŠ å…¥è¿›å»ï¼Œè¿™ä¸ª handle ä¼šè‡ªåŠ¨åˆ›å»º <code>grpc</code> æœåŠ¡ç«¯çš„ <code>span</code>ã€‚</p><blockquote><p>å¯¹ trace&#x2F;span æ¦‚å¿µè¿˜æœ‰ä¸äº†è§£çš„æœ‹å‹å¯ä»¥æŸ¥çœ‹è¿™ç¯‡<a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">æ–‡ç« </a>ã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> port = <span class="string">&quot;:50051&quot;</span>  </span><br><span class="line">lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, port)  </span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Fatal().Msgf(<span class="string">&quot;failed to listen: %v&quot;</span>, err)  </span><br><span class="line">&#125;  </span><br><span class="line">s := grpc.NewServer(  </span><br><span class="line">    grpc.StatsHandler(otelgrpc.NewServerHandler()),  </span><br><span class="line">)  </span><br><span class="line">pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)  </span><br><span class="line"><span class="keyword">if</span> err := s.Serve(lis); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Fatal().Msgf(<span class="string">&quot;failed to serve: %v&quot;</span>, err)  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    log.Printf(<span class="string">&quot;served on %s \n&quot;</span>, port)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬åªéœ€è¦å¯åŠ¨è¿™ä¸ª grpc æœåŠ¡å³å¯ï¼Œå°±ç®—å®Œæˆäº† Go æœåŠ¡çš„é›†æˆã€‚</p><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡º Java ç›¸å¯¹äº Go æ¥è¯´ä¼šç®€å•è®¸å¤šï¼Œåªéœ€è¦é…ç½®ä¸€ä¸ª agent å°±å¯ä»¥ä¸è¯¥ä¸€è¡Œä»£ç æ”¯æŒç›®å‰å¸‚é¢ä¸Šæµè¡Œçš„ç»å¤§å¤šæ•°æ¡†æ¶ã€‚<br><img src="https://s2.loli.net/2024/04/17/kMDcrPwxJy4oZYe.png"></p><h1 id="è‡ªå®šä¹‰-span-çš„-attribute"><a href="#è‡ªå®šä¹‰-span-çš„-attribute" class="headerlink" title="è‡ªå®šä¹‰  span çš„ attribute"></a>è‡ªå®šä¹‰  span çš„ attribute</h1><p>æˆ‘ä»¬åœ¨çœ‹é“¾è·¯ä¿¡æ¯çš„æ—¶å€™å…¶å®çœ‹çš„æœ€å¤šçš„æ˜¯æŸä¸ª <code>span</code> é‡Œçš„ <code>attribute</code> æ•°æ®ï¼ˆæœ‰äº›åœ°æ–¹åˆç§°ä¸º <code>tag</code>)<br>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://s2.loli.net/2024/07/15/jrdkNCAZhi6UIvP.png"></p><p>è¿™é‡Œä¼šå±•ç¤ºå½“å‰ <code>span</code> çš„å„ç§ä¿¡æ¯ï¼Œä½†å¦‚æœæˆ‘ä»¬æƒ³è¦é¢å¤–åŠ ä¸€äº›è‡ªå·±å…³å¿ƒçš„æ•°æ®åº”è¯¥å¦‚ä½•æ·»åŠ å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">message HelloRequest &#123;  </span><br><span class="line">  string name = 1;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘ä»¬æƒ³çŸ¥é“è¿™ä¸ª grpc æ¥å£é‡Œçš„ name å‚æ•°ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºé‚£æ ·å±•ç¤ºåœ¨ span ä¸­ã€‚</p><p>å¥½åœ¨ <code>OpenTelemetry</code> å·²ç»è€ƒè™‘åˆ°ç±»ä¼¼çš„éœ€æ±‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">span := trace.SpanFromContext(ctx)  </span><br><span class="line">span.SetAttributes(attribute.String(<span class="string">&quot;request.name&quot;</span>, in.Name))</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ <code>span := trace.SpanFromContext(ctx)</code>  è·å–åˆ°å½“å‰çš„ spanï¼Œç„¶åè°ƒç”¨ <code>SetAttributes</code> å°±å¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„æ•°æ®äº†ã€‚</p><blockquote><p>å¯¹åº”çš„ Java ä¹Ÿæœ‰ç±»ä¼¼çš„å‡½æ•°ã€‚</p></blockquote><p>é™¤äº†æ–°å¢ <code>attribute</code> ä¹‹å¤–è¿˜å¯ä»¥æ–°å¢ Eventï¼ŒLink ç­‰æ•°æ®ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AddEvent adds an event with the provided name and options.  </span></span><br><span class="line">AddEvent(name <span class="type">string</span>, options ...EventOption)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// AddLink adds a link.  </span></span><br><span class="line"><span class="comment">// Adding links at span creation using WithLinks is preferred to calling AddLink  </span></span><br><span class="line"><span class="comment">// later, for contexts that are available during span creation, because head  </span></span><br><span class="line"><span class="comment">// sampling decisions can only consider information present during span creation.  </span></span><br><span class="line">AddLink(link Link)</span><br></pre></td></tr></table></figure><h1 id="è‡ªå®šä¹‰æ–°å¢-span"><a href="#è‡ªå®šä¹‰æ–°å¢-span" class="headerlink" title="è‡ªå®šä¹‰æ–°å¢ span"></a>è‡ªå®šä¹‰æ–°å¢ span</h1><p>åŒç†æˆ‘ä»¬å¯èƒ½ä¸å±€é™äºä¸ºæŸä¸ª span æ–°å¢ attributeï¼Œä¹Ÿæœ‰å¯èƒ½æƒ³è¦æ–°å¢ä¸€ä¸ªæ–°çš„ span æ¥è®°å½•å…³é”®çš„è°ƒç”¨ä¿¡æ¯ã€‚</p><blockquote><p>é»˜è®¤æƒ…å†µä¸‹åªæœ‰ OpenTelemetry å®ç°è¿‡çš„ç»„ä»¶çš„æ ¸å¿ƒå‡½æ•°æ‰ä¼šæœ‰ spanï¼Œè‡ªå·±ä»£ç é‡Œçš„å‡½æ•°è°ƒç”¨æ˜¯ä¸ä¼šåˆ›å»ºspan çš„ã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> span(ctx context.Context) &#123;  </span><br><span class="line">    ctx, span := tracer.Start(ctx, <span class="string">&quot;hello-span&quot;</span>)  </span><br><span class="line">    <span class="keyword">defer</span> span.End()  </span><br><span class="line">    <span class="comment">// do some work  </span></span><br><span class="line">    log.Printf(<span class="string">&quot;create span&quot;</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨  Go ä¸­åªéœ€è¦æ‰‹åŠ¨ Start ä¸€ä¸ª span å³å¯ã€‚</p><p>å¯¹åº”åˆ° <code>Java</code> ç¨å¾®ç®€å•ä¸€äº›ï¼Œåªéœ€è¦ä¸ºå‡½æ•°æ·»åŠ ä¸€ä¸ªæ³¨è§£å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WithSpan(&quot;span&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">span</span><span class="params">(<span class="meta">@SpanAttribute(&quot;request.name&quot;)</span> String name)</span> &#123;  </span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>);  </span><br><span class="line">    log.info(<span class="string">&quot;span:&#123;&#125;&quot;</span>, name);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªä¸è¿‡å¾—å•ç‹¬å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry.instrumentation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-instrumentation-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæˆ‘ä»¬åœ¨ Jaeger UI ä¸Šçœ‹åˆ°çš„æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2024/07/15/1tLlYezQwInZWDX.png"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><img src="https://s2.loli.net/2024/07/15/WXPp1MUkdHo4zam.png"></p><p>æœ€åæ€»ç»“ä¸€ä¸‹ï¼ŒOpenTelemetry æ”¯æŒè®¸å¤šæµè¡Œçš„è¯­è¨€ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šæ˜¯å¦æ”¯æŒè‡ªåŠ¨åŸ‹ç‚¹ã€‚</p><p><img src="https://s2.loli.net/2024/07/15/fvu67rdoxtZkq5m.png"></p><blockquote><p>è¿™é‡Œ Go ä¹Ÿå¯ä»¥é›¶ä»£ç åŸ‹ç‚¹ï¼Œæ˜¯ä½¿ç”¨äº† eBPFï¼Œæœ¬æ–‡æš‚ä¸åšä»‹ç»ã€‚</p></blockquote><p>å¯¹äºæ”¯æŒè‡ªåŠ¨åŸ‹ç‚¹çš„è¯­è¨€å°±å¾ˆç®€å•ï¼Œåªéœ€è¦é…ç½®ä¸‹ agent å³å¯ï¼›è€ŒåŸç”Ÿçš„ Go è¯­è¨€ä¸æ”¯æŒè‡ªåŠ¨åŸ‹ç‚¹å°±å¾—æ‰‹åŠ¨ä½¿ç”¨ OpenTelemetry æä¾›çš„ SDK å¤„ç†ä¸€äº›å…³é”®æ­¥éª¤ï¼›æ€»ä½“æ¥è¯´ä¹Ÿä¸ç®—å¤æ‚ã€‚</p><p>ä¸‹ä¸€æœŸä¼šé‡ç‚¹è®²è§£å¦‚ä½•ä½¿ç”¨ Metricsã€‚</p><p>æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ Go ç›¸å…³çš„æºç ï¼š</p><ul><li><a href="https://github.com/crossoverJie/k8s-combat">https://github.com/crossoverJie/k8s-combat</a></li></ul><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://opentelemetry.io/docs/languages/java/configuration/">https://opentelemetry.io/docs/languages/java/configuration/</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md</a></li><li><a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;ä¹‹å‰å†™è¿‡ä¸€ç¯‡ &lt;a href=&quot;https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-t</summary>
      
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£å•å…ƒæµ‹è¯•ï¼šæŠ€å·§ä¸æœ€ä½³å®è·µ</title>
    <link href="http://crossoverjie.top/2024/08/15/ob/unit-test/"/>
    <id>http://crossoverjie.top/2024/08/15/ob/unit-test/</id>
    <published>2024-08-15T02:43:09.000Z</published>
    <updated>2024-08-14T13:55:07.855Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰åˆ†äº«è¿‡å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹å¼€æºé¡¹ç›®ä»¥åŠå¦‚ä½•åœ¨å¼€æºé¡¹ç›®é‡Œåšé›†æˆæµ‹è¯•ï¼Œä½†è¿˜æ²¡æœ‰è®²è¿‡å…·ä½“çš„å®æ“ã€‚</p><p>ä»Šå¤©æ¥è¯¦ç»†è®²è®²å¦‚ä½•å†™å•å…ƒæµ‹è¯•ã€‚</p><h1 id="ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•"><a href="#ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•" class="headerlink" title="ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•"></a>ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•</h1><p>è¿™ä¸ªå¤§å®¶åº”è¯¥æ˜¯æœ‰å…±è¯†çš„ï¼Œå¯¹äºä¸€äº›åŠŸèƒ½å•ä¸€ã€æ ¸å¿ƒé€»è¾‘ã€åŒæ—¶å˜åŒ–ä¸é¢‘ç¹çš„å…¬å¼€å‡½æ•°æ‰æœ‰å¿…è¦åšå•å…ƒæµ‹è¯•ã€‚</p><p>å¯¹äºä¸šåŠ¡å¤æ‚ã€é“¾è·¯ç¹çä½†ä¹Ÿæ˜¯æ ¸å¿ƒæµç¨‹çš„åŠŸèƒ½é€šå¸¸å»ºè®®åš e2e æµ‹è¯•ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æœ€ç»ˆæµ‹è¯•ç»“æœçš„ä¸€è‡´æ€§ã€‚</p><span id="more"></span><h1 id="ğŸ’€å…·ä½“æ¡ˆä¾‹"><a href="#ğŸ’€å…·ä½“æ¡ˆä¾‹" class="headerlink" title="ğŸ’€å…·ä½“æ¡ˆä¾‹"></a>ğŸ’€å…·ä½“æ¡ˆä¾‹</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“å•æµ‹çš„ä¸»è¦ç›®çš„æ˜¯æ¨¡æ‹Ÿæ‰§è¡Œä½ å†™è¿‡çš„æ¯ä¸€è¡Œä»£ç ï¼Œç›®çš„å°±æ˜¯è¦è¦†ç›–åˆ°ä¸»è¦åˆ†æ”¯ï¼Œåšåˆ°è‡ªå·±çš„æ¯ä¸€è¡Œä»£ç éƒ½å¿ƒä¸­æœ‰æ•°ã€‚</p><p>ä¸‹é¢ä»¥ <code>Apache HertzBeat</code> çš„ä¸€äº›å•æµ‹ä¸ºä¾‹ï¼Œè®²è§£å¦‚ä½•ç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•ã€‚</p><p><img src="https://s2.loli.net/2024/07/02/SbqCvHVZk6f5tB1.png"><br>å…ˆä»¥ä¸€ä¸ªæœ€ç®€å•çš„ <code>org.apache.hertzbeat.collector.collect.udp.UdpCollectImpl#preCheck</code> å‡½æ•°æµ‹è¯•ä¸ºä¾‹ã€‚<br>è¿™é‡Œçš„ <code>preCheck</code> å‡½æ•°å°±æ˜¯ç®€å•çš„æ£€æµ‹åšå‚æ•°æ ¡éªŒã€‚<br>æµ‹è¯•æ—¶åªè¦æˆ‘ä»¬æ‰‹åŠ¨å°† <code>metrics</code> è®¾ç½®ä¸º <code>null</code> å°±å¯ä»¥è¿›å…¥è¿™ä¸ª if æ¡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UdpCollectImplTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> UdpCollectImpl udpCollect;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testPreCheck</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; aliasField = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        aliasField.add(<span class="string">&quot;responseTime&quot;</span>);</span><br><span class="line">        <span class="type">Metrics</span> <span class="variable">metrics</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Metrics</span>();</span><br><span class="line">        metrics.setAliasFields(aliasField);</span><br><span class="line">        assertThrows(IllegalArgumentException.class, () -&gt; udpCollect.preCheck(metrics));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><p>æ¥çœ‹å…·ä½“çš„å•æµ‹ä»£ç ï¼Œæˆ‘ä»¬ä¸€è¡Œè¡Œçš„æ¥çœ‹ï¼š</p><p><code>@ExtendWith(MockitoExtension.class)</code> æ˜¯ <code>Junit5</code> æä¾›çš„ä¸€ä¸ªæ³¨è§£ï¼Œé‡Œé¢ä¼ å…¥çš„ <code>MockitoExtension.class</code> æ˜¯æˆ‘ä»¬å•æµ‹ mock å¸¸ç”¨çš„æ¡†æ¶ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯å‘Šè¯‰ <code>Junit5</code> ï¼Œå½“å‰çš„æµ‹è¯•ç±»ä¼šä½¿ç”¨ mockito ä½œä¸ºæ‰©å±•è¿è¡Œï¼Œä»è€Œå¯ä»¥ <code>mock</code> æˆ‘ä»¬è¿è¡Œæ—¶çš„ä¸€äº›å¯¹è±¡ã€‚</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@InjectMocks</span>  </span><br><span class="line"><span class="keyword">private</span> UdpCollectImpl udpCollect;</span><br></pre></td></tr></table></figure><p><code>@InjectMocks</code> ä¹Ÿæ˜¯ <code>mockito</code> è¿™ä¸ªåº“æä¾›çš„æ³¨è§£ï¼Œé€šå¸¸ç”¨äºå£°æ˜éœ€è¦æµ‹è¯•çš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@InjectMocks</span>  </span><br><span class="line"><span class="keyword">private</span> AbstractCollect udpCollect;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/07/02/zSocET9f5y6lqC3.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ³¨è§£å¿…é¡»æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»ï¼Œä¸å¯ä»¥æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»æˆ–è€…æ˜¯æ¥å£ã€‚</p><p>å…¶å®å½“æˆ‘ä»¬äº†è§£äº†ä»–çš„åŸç†å°±èƒ½çŸ¥é“å…·ä½“çš„åŸå› ï¼š<br><img src="https://s2.loli.net/2024/07/02/5DwRyVsBHd1EmpA.png"></p><p>å½“æˆ‘ä»¬ debug è¿è¡Œæ—¶ä¼šå‘ç° <code>udpCollect</code> å¯¹è±¡æ˜¯æœ‰å€¼çš„ï¼Œè€Œå¦‚æœæˆ‘ä»¬å»æ‰è¿™ä¸ªæ³¨è§£ <code>@InjectMocks</code> å†è¿è¡Œå°±ä¼šæŠ›ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p><blockquote><p>å› ä¸ºå¹¶æ²¡æœ‰åˆå§‹åŒ– udpCollect</p></blockquote><p>è€Œä½¿ç”¨ <code>@InjectMocks</code>æ³¨è§£åï¼Œ<code>mockito</code> æ¡†æ¶ä¼šè‡ªåŠ¨ç»™ <code>udpCollect</code> æ³¨å…¥ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼›è€Œå¦‚æœæ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…æ˜¯æŠ½è±¡ç±»ï¼Œmockito æ¡†æ¶æ˜¯æ— æ³•çŸ¥é“åˆ›å»ºå…·ä½“å“ªä¸ªå¯¹è±¡ã€‚</p><p>å½“ç„¶åœ¨è¿™ä¸ªç®€å•åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ç›´æ¥ <code>udpCollect = new UdpCollectImpl()</code> è¿›è¡Œæµ‹è¯•ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><h1 id="ğŸ”¥é…åˆ-jacoco-è¾“å‡ºå•æµ‹è¦†ç›–ç‡"><a href="#ğŸ”¥é…åˆ-jacoco-è¾“å‡ºå•æµ‹è¦†ç›–ç‡" class="headerlink" title="ğŸ”¥é…åˆ jacoco è¾“å‡ºå•æµ‹è¦†ç›–ç‡"></a>ğŸ”¥é…åˆ jacoco è¾“å‡ºå•æµ‹è¦†ç›–ç‡</h1><p><img src="https://s2.loli.net/2024/07/02/fgv3O4RbnHsQTWV.png"><br><img src="https://s2.loli.net/2024/07/02/coXOGkjyE2zKsYa.png"></p><p>åœ¨ IDEA ä¸­æˆ‘ä»¬å¯ä»¥ä»¥ <code>Coverage</code> çš„æ–¹å¼è¿è¡Œï¼Œ<code>IDEA</code> å°±å°†æˆ‘ä»¬çš„å•æµ‹è¦†ç›–æƒ…å†µæ˜¾ç¤ºåœ¨æºä»£ç ä¸­ï¼Œç»¿è‰²çš„éƒ¨åˆ†å°±ä»£è¡¨åœ¨å®é™…åœ¨è¿è¡Œæ—¶æ‰§è¡Œåˆ°çš„åœ°æ–¹ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ <code>maven</code> é¡¹ç›®ä¸­é›†æˆ <code>jacoco</code>ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªæ ¹ç›®å½•çš„ <code>pom.xml</code> ä¸­æ·»åŠ ä¸€ä¸ª <code>plugin</code> å°±å¯ä»¥äº†ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jacoco<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jacoco-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jacoco-maven-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>prepare-agent<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>report<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test<span class="tag">&lt;/<span class="name">phase</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>report<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¹‹åè¿è¡Œ <code>mvn test</code> å°±ä¼šåœ¨ target ç›®å½•ä¸‹ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šäº†ã€‚</p><p><img src="https://s2.loli.net/2024/07/02/GiBrPjtLcXhgDbp.png"></p><p>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨ GitHub çš„ CI ä¸­é›†æˆ <code>Codecov</code>ï¼Œä»–ä¼šç›´æ¥è¯»å– jacoco çš„æµ‹è¯•æ•°æ®ï¼Œå¹¶ä¸”åœ¨ PR çš„è¯„è®ºåŒºåŠ ä¸Šæµ‹è¯•æŠ¥å‘Šã€‚<br><img src="https://s2.loli.net/2024/07/02/ujdGke4gf5mAW3x.png"></p><p><img src="https://s2.loli.net/2024/07/02/nFt5SukAjMPZ96W.png"></p><p><img src="https://s2.loli.net/2024/07/02/KcXJUs3mehxFAYz.png"></p><p>éœ€è¦ä» <code>Codecov</code> é‡Œå°†ä½ é¡¹ç›®çš„ token æ·»åŠ åˆ° repo çš„ ç¯å¢ƒå˜é‡ä¸­å³å¯ã€‚</p><p>å…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ª PRï¼š<a href="https://github.com/apache/hertzbeat/pull/1985">https://github.com/apache/hertzbeat/pull/1985</a></p><h1 id="â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹"><a href="#â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹" class="headerlink" title="â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹"></a>â˜€ï¸å¤æ‚ä¸€ç‚¹çš„å•æµ‹</h1><p>åˆšæ‰å±•ç¤ºçš„æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„åœºæ™¯ï¼Œä¸‹é¢æ¥çœ‹çœ‹ç¨å¾®å¤æ‚çš„ã€‚</p><p>æˆ‘ä»¬ä»¥è¿™ä¸ªå•æµ‹ä¸ºä¾‹ï¼š<br><code>org.apache.hertzbeat.collector.collect.redis.RedisClusterCollectImplTest</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClusterCollectImplTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> RedisCommonCollectImpl redisClusterCollect;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> StatefulRedisClusterConnection&lt;String, String&gt; connection;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> RedisAdvancedClusterCommands&lt;String, String&gt; cmd;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> RedisClusterClient client;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå•æµ‹åœ¨åˆšæ‰çš„åŸºç¡€ä¸Šå¤šäº†ä¸€ä¸ª <code>@Mock</code> çš„æ³¨è§£ã€‚</p><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦æµ‹è¯•çš„ <code>RedisCommonCollectImpl</code> ç±»ä¸­éœ€è¦ä¾èµ– <code>StatefulRedisClusterConnection/RedisAdvancedClusterCommands/RedisClusterClient</code> è¿™å‡ ä¸ªç±»æ‰€æä¾›çš„æœåŠ¡ã€‚</p><p>å•æµ‹çš„æ—¶å€™éœ€è¦ä½¿ç”¨ <code>mockito</code> åˆ›å»ºä¸€ä¸ªä»–ä»¬çš„å¯¹è±¡ï¼Œå¹¶ä¸”æ³¨å…¥åˆ°éœ€è¦è¢«æµ‹è¯•çš„ <code>RedisCommonCollectImpl</code>ç±»ä¸­ã€‚</p><blockquote><p>ä¸ç„¶æˆ‘ä»¬å°±éœ€è¦å‡†å¤‡å•æµ‹æ‰€éœ€è¦çš„èµ„æºï¼Œæ¯”å¦‚å¯ä»¥ä½¿ç”¨çš„ Redisã€MySQL ç­‰ã€‚</p></blockquote><h2 id="ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º"><a href="#ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º" class="headerlink" title="ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º"></a>ğŸš¤æ¨¡æ‹Ÿè¡Œä¸º</h2><p>åªæ˜¯æ³¨å…¥è¿›å»è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ¨¡æ‹Ÿå®ƒçš„è¡Œä¸ºï¼š</p><ul><li>æ¯”å¦‚è°ƒç”¨æŸä¸ªå‡½æ•°å¯ä»¥æ¨¡æ‹Ÿè¿”å›æ•°æ®</li><li>æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨æŠ›å‡ºå¼‚å¸¸</li><li>æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨è€—æ—¶</li></ul><p>è¿™é‡Œä»¥æœ€å¸¸è§çš„æ¨¡æ‹Ÿå‡½æ•°è¿”å›ä¸ºä¾‹ï¼š</p><p><img src="https://s2.loli.net/2024/07/02/3lnFxsQmcWqao5u.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">clusterNodes</span> <span class="operator">=</span> connection.sync().clusterInfo();</span><br></pre></td></tr></table></figure><p>åœ¨æºç é‡Œçœ‹åˆ°ä¼šä½¿ç”¨ connection çš„ <code>clusterInfo()</code> å‡½æ•°è¿”å›é›†ç¾¤ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">clusterKnownNodes</span> <span class="operator">=</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">clusterInfoTemp</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        cluster_slots_fail:0</span></span><br><span class="line"><span class="string">        cluster_known_nodes:%s</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">clusterInfo</span> <span class="operator">=</span> String.format(clusterInfoTemp, clusterKnownNodes);</span><br><span class="line">Mockito.when(cmd.clusterInfo()).thenReturn(clusterInfo);        </span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code>Mockito.when().thenReturn()</code> æ¥æ¨¡æ‹Ÿè¿™ä¸ªå‡½æ•°çš„è¿”å›æ•°æ®ã€‚</p><p>è€Œå…¶ä¸­çš„ <code>cmd</code> è‡ªç„¶ä¹Ÿæ˜¯éœ€è¦æ¨¡æ‹Ÿè¿”å›çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Mockito.mockStatic(RedisClusterClient.class).when(()-&gt;RedisClusterClient.create(Mockito.any(ClientResources.class),</span><br><span class="line">        Mockito.any(RedisURI.class))).thenReturn(client);</span><br><span class="line">Mockito.when(client.connect()).thenReturn(connection);</span><br><span class="line"></span><br><span class="line">Mockito.when(connection.sync()).thenReturn(cmd);</span><br><span class="line">Mockito.when(cmd.info(metrics.getName())).thenReturn(info);</span><br><span class="line">Mockito.when(cmd.clusterInfo()).thenReturn(clusterInfo);</span><br></pre></td></tr></table></figure><p><code>cmd</code> æ˜¯é€šè¿‡ <code>Mockito.when(connection.sync()).thenReturn(cmd);</code>è¿”å›çš„ï¼Œè€Œ <code>connection</code> åˆæ˜¯ä» <code>client.connect()</code> è¿”å›çš„ã€‚</p><p>æœ€ç»ˆå°±åƒæ˜¯å¥—å¨ƒä¸€æ ·ï¼Œ<code>client</code> åœ¨æºç ä¸­æ˜¯é€šè¿‡ä¸€ä¸ªé™æ€å‡½æ•°åˆ›å»ºçš„ã€‚</p><h3 id="âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°"><a href="#âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°" class="headerlink" title="âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°"></a>âš¡æ¨¡æ‹Ÿé™æ€å‡½æ•°</h3><p>æˆ‘ä¾ç¨€è®°å¾—åœ¨æˆ‘åˆšæ¥è§¦ <code>mockito</code> çš„ 16ï½17 å¹´é‚£æ®µæ—¶é—´è¿˜ä¸æ”¯æŒæ¨¡æ‹Ÿè°ƒç”¨é™æ€å‡½æ•°ï¼Œä¸è¿‡å¦‚ä»Šå·²ç»æ”¯æŒäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mock</span>  </span><br><span class="line"><span class="keyword">private</span> RedisClusterClient client;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mockito.mockStatic(RedisClusterClient.class).when(()-&gt;RedisClusterClient.create(Mockito.any(ClientResources.class),  </span><br><span class="line">        Mockito.any(RedisURI.class))).thenReturn(client);</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥æ¨¡æ‹Ÿé™æ€å‡½æ•°çš„è¿”å›å€¼äº†ï¼Œä½†å‰ææ˜¯è¿”å›çš„ <code>client</code> éœ€è¦ä½¿ç”¨ <code>@Mock</code> æ³¨è§£ã€‚</p><h3 id="ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°"><a href="#ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°" class="headerlink" title="ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°"></a>ğŸ’¥æ¨¡æ‹Ÿæ„é€ å‡½æ•°</h3><p><img src="https://s2.loli.net/2024/07/02/aFiCLRyYh4IU83o.png"><br>æœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿéœ€è¦æ¨¡æ‹Ÿæ„é€ å‡½æ•°ï¼Œä»è€Œå¯ä»¥æ¨¡æ‹Ÿåç»­è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MockedConstruction&lt;FTPClient&gt; mocked = Mockito.mockConstruction(FTPClient.class,</span><br><span class="line">        (ftpClient, context) -&gt; &#123;</span><br><span class="line">            Mockito.doNothing().when(ftpClient).connect(ftpProtocol.getHost(),</span><br><span class="line">                    Integer.parseInt(ftpProtocol.getPort()));</span><br><span class="line"></span><br><span class="line">            Mockito.doAnswer(invocationOnMock -&gt; <span class="literal">true</span>).when(ftpClient)</span><br><span class="line">                    .login(ftpProtocol.getUsername(), ftpProtocol.getPassword());</span><br><span class="line">            Mockito.when(ftpClient.changeWorkingDirectory(ftpProtocol.getDirection())).thenReturn(isActive);</span><br><span class="line">            Mockito.doNothing().when(ftpClient).disconnect();</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ <code>Mockito.mockConstruction</code> æ¥è¿›è¡Œæ¨¡æ‹Ÿï¼Œè¯¥å¯¹è±¡çš„ä¸€äº›è¡Œä¸ºå°±ç›´æ¥å†™åœ¨è¿™ä¸ªæ¨¡æ‹Ÿå‡½æ•°å†…ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿”å›çš„ <code>mocked</code> å¯¹è±¡éœ€è¦è®°å¾—å…³é—­ã€‚</p><h3 id="ä¸éœ€è¦-Mock"><a href="#ä¸éœ€è¦-Mock" class="headerlink" title="ä¸éœ€è¦ Mock"></a>ä¸éœ€è¦ Mock</h3><p>å½“ç„¶ä¹Ÿä¸æ˜¯æ‰€æœ‰çš„åœºæ™¯éƒ½éœ€è¦ <code>mock</code>ã€‚</p><p>æ¯”å¦‚åˆšæ‰ç¬¬ä¸€ä¸ªåœºæ™¯ï¼Œæ²¡æœ‰ä¾èµ–ä»»ä½•å¤–éƒ¨æœåŠ¡æ—¶å°±ä¸éœ€è¦ <code>mock</code>ã€‚</p><p><img src="https://s2.loli.net/2024/07/02/mW3gxERBc4qoz2L.png"></p><p>ç±»ä¼¼äºè¿™ä¸ª <a href="https://github.com/apache/hertzbeat/pull/2021">PR</a> é‡Œçš„æµ‹è¯•ï¼Œåªæ˜¯ä¾èµ–ä¸€ä¸ªåŸºç¡€çš„å†…å­˜ç¼“å­˜ç»„ä»¶ï¼Œå°±æ²¡å¿…è¦ mockï¼Œä½†å¦‚æœä¾èµ–çš„æ˜¯ <code>Redis</code> ç¼“å­˜ç»„ä»¶è¿˜æ˜¯éœ€è¦ mock çš„ã€‚<br><a href="https://github.com/apache/hertzbeat/pull/2021">https://github.com/apache/hertzbeat/pull/2021</a></p><h3 id="âš™ï¸ä¿®æ”¹æºç "><a href="#âš™ï¸ä¿®æ”¹æºç " class="headerlink" title="âš™ï¸ä¿®æ”¹æºç "></a>âš™ï¸ä¿®æ”¹æºç </h3><p>å¦‚æœæœ‰äº›æµ‹è¯•åœºæ™¯ä¸‹éœ€è¦è·å–å†…éƒ¨å˜é‡æ–¹ä¾¿åç»­çš„æµ‹è¯•ï¼Œä½†æ˜¯è¯¥æµ‹è¯•ç±»ä¹Ÿæ²¡æœ‰æä¾›è·å–å˜é‡çš„å‡½æ•°ï¼Œæˆ‘ä»¬å°±åªæœ‰ä¿®æ”¹æºç æ¥é…åˆæµ‹è¯•äº†ã€‚</p><p>æ¯”å¦‚è¿™ä¸ª <a href="https://github.com/apache/hertzbeat/pull/">PR</a>ï¼š<br><img src="https://s2.loli.net/2024/07/02/bxfQgsymWVcnawE.png"></p><p>å½“ç„¶å¦‚æœåªæ˜¯ç»™æµ‹è¯•ç¯å¢ƒä¸‹ä½¿ç”¨çš„å‡½æ•°æˆ–å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸Š <code>@VisibleForTesting</code>æ³¨è§£æ ‡æ˜ä¸€ä¸‹ï¼Œè¿™ä¸ªæ³¨è§£æ²¡æœ‰å…¶ä»–ä½œç”¨ï¼Œå¯ä»¥è®©åç»­çš„ç»´æŠ¤è€…æ›´æ¸…æ¥šçš„çŸ¥é“è¿™æ˜¯åšä»€ä¹ˆç”¨çš„ã€‚</p><h1 id="ğŸ“ˆé›†æˆæµ‹è¯•"><a href="#ğŸ“ˆé›†æˆæµ‹è¯•" class="headerlink" title="ğŸ“ˆé›†æˆæµ‹è¯•"></a>ğŸ“ˆé›†æˆæµ‹è¯•</h1><p>å•å…ƒæµ‹è¯•åªèƒ½æµ‹è¯•ä¸€äº›åŠŸèƒ½å•ä¸€çš„å‡½æ•°ï¼Œè¦ä¿è¯æ•´ä¸ªè½¯ä»¶çš„è´¨é‡ä»…ä¾èµ–å•æµ‹æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é›†æˆæµ‹è¯•ã€‚</p><p>é€šå¸¸æ˜¯éœ€è¦å¯¹å¤–æä¾›æœåŠ¡çš„å¼€æºé¡¹ç›®éƒ½éœ€è¦é›†æˆæµ‹è¯•ï¼š</p><ul><li>Pulsar</li><li>Kafka</li><li>Dubbo ç­‰</li></ul><p>ä»¥æˆ‘æ¥è§¦åˆ°çš„æœåŠ¡å‹åº”ç”¨ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ä¸ªæ˜¯ Java åº”ç”¨ä¸€ä¸ªæ˜¯ Golang åº”ç”¨ã€‚</p><h1 id="ğŸ³Golang"><a href="#ğŸ³Golang" class="headerlink" title="ğŸ³Golang"></a>ğŸ³Golang</h1><p><img src="https://s2.loli.net/2024/07/11/vZISu9Qg3foKhsU.png"></p><p><code>Golang</code> å› ä¸ºå·¥å…·é“¾æ²¡æœ‰ Java é‚£ä¹ˆå¼ºå¤§ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†çš„é›†æˆæµ‹è¯•çš„åŠŸèƒ½éƒ½æ˜¯é€šè¿‡ç¼–å†™ Makefile å’Œ shell è„šæœ¬å®ç°çš„ã€‚</p><p>è¿˜æ˜¯ä»¥æˆ‘ç†Ÿæ‚‰çš„ Pulsar çš„ <code>go-client</code> ä¸ºä¾‹ï¼Œå®ƒåœ¨ GitHub çš„é›†æˆæµ‹è¯•æ˜¯é€šè¿‡ GitHub action è§¦å‘çš„ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/05/20/f2196pujo8m7KRe.png"><br>æœ€ç»ˆè°ƒç”¨çš„æ˜¯ Makefile ä¸­çš„ test å‘½ä»¤ï¼Œå¹¶ä¸”æŠŠéœ€è¦æµ‹è¯•çš„ Golang ç‰ˆæœ¬ä¼ å…¥è¿›å»ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/YpwtSHnLXqU1xQj.png"></p><p><code>Dockerfile</code>ï¼š<br><img src="https://s2.loli.net/2024/05/20/1ySGWF46U7EC2rk.png"></p><p>è¿™ä¸ªé•œåƒç®€å•æ¥è¯´å°±æ˜¯å°† Pulsar çš„é•œåƒä½œä¸ºåŸºç¡€è¿è¡Œé•œåƒï¼ˆè¿™é‡Œé¢åŒ…å«äº† Pulsar çš„æœåŠ¡ç«¯ï¼‰ï¼Œç„¶åå°†è¿™ä¸ª pulsar-client-go çš„ä»£ç å¤åˆ¶è¿›å»ç¼–è¯‘ã€‚</p><p>æ¥ç€è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /pulsar/pulsar-client-go &amp;&amp; ./scripts/run-ci.sh</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯æµ‹è¯•è„šæœ¬ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/2Afmdu8ozRvH9FC.png"></p><p>æµ‹è¯•è„šæœ¬çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼š</p><ul><li>å¯åŠ¨ pulsar æœåŠ¡ç«¯</li><li>è¿è¡Œæµ‹è¯•ä»£ç <br>å› ä¸ºæ‰€æœ‰çš„æµ‹è¯•ä»£ç é‡Œè¿æ¥æœåŠ¡ç«¯çš„åœ°å€éƒ½æ˜¯ <code>localhost</code>ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿æ¥ã€‚<br><img src="https://s2.loli.net/2024/05/20/C1RHxTkuz25Mlj8.png"></li></ul><p>é€šè¿‡è¿™é‡Œçš„ <a href="https://github.com/apache/pulsar-client-go/actions/runs/9014510238/job/24768797555">action</a> æ—¥å¿—å¯ä»¥è·Ÿè¸ªæ‰€æœ‰çš„è¿è¡Œæƒ…å†µã€‚</p><h1 id="â˜•Java"><a href="#â˜•Java" class="headerlink" title="â˜•Java"></a>â˜•Java</h1><p><img src="https://s2.loli.net/2024/07/11/KlqzSwJ6f895A4n.png"></p><p>Java å› ä¸ºå·¥å…·é“¾å¼ºå¤§ï¼Œæ‰€ä»¥é›†æˆæµ‹è¯•å‡ ä¹ä¸éœ€è¦ç”¨ Makefile å’Œè„šæœ¬é…åˆæ‰§è¡Œã€‚</p><p>è¿˜æ˜¯ä»¥ Pulsar ä¸ºä¾‹ï¼Œå®ƒçš„é›†æˆæµ‹è¯•æ˜¯éœ€è¦æ¨¡æ‹Ÿåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼ˆå› ä¸º Pulsar çš„æœåŠ¡ç«¯æºç å’Œæµ‹è¯•ä»£ç éƒ½æ˜¯ Java å†™çš„ï¼Œæ›´æ–¹ä¾¿åšæµ‹è¯•ï¼‰ï¼Œç„¶åå†è¿è¡Œæµ‹è¯•ä»£ç ã€‚</p><blockquote><p>è¿™ä¸ªçš„å¥½å¤„æ˜¯ä»»ä½•ä¸€ä¸ªå•æµ‹éƒ½å¯ä»¥åœ¨æœ¬åœ°ç›´æ¥è¿è¡Œï¼Œè€Œ  Go çš„ä»£ç è¿˜éœ€è¦å…ˆåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œæµ‹è¯•èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚</p></blockquote><p>æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Œæˆ‘ä»¥å…¶ä¸­ä¸€ä¸ª <a href="https://github.com/apache/pulsar/blob/631b13ad23d7e48c6e82d38f97c23d129062cb7c/pulsar-broker/src/test/java/org/apache/pulsar/client/impl/BrokerClientIntegrationTest.java#L117">BrokerClientIntegrationTest</a>ä¸ºä¾‹ï¼š<br><img src="https://s2.loli.net/2024/05/20/9PbioA3RQLMBy6J.png"><br><img src="https://s2.loli.net/2024/05/20/blKePdxTUIkgRD3.png"><br>ä¼šåœ¨å•æµ‹å¯åŠ¨çš„æ—¶å€™å…ˆå¯åŠ¨æœåŠ¡ç«¯ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/gzY3lyTGuEDUwZF.png"></p><p>æœ€ç»ˆä¼šè°ƒç”¨ <code>PulsarTestContext</code> çš„ <code>build</code> å‡½æ•°å¯åŠ¨ <code>broker</code>ï¼ˆæœåŠ¡ç«¯ï¼‰ï¼Œè€Œæ‰§è¡Œå•æµ‹ä¹Ÿåªéœ€è¦ä½¿ç”¨ <code>mvn test</code> å°±å¯ä»¥è‡ªåŠ¨è§¦å‘è¿™äº›å•å…ƒæµ‹è¯•ã€‚<br><img src="https://s2.loli.net/2024/05/20/N15amZihWI73Qyw.png"><br>åªæ˜¯æ¯ä¸€ä¸ªå•æµ‹éƒ½éœ€è¦å¯åœæœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¦æŠŠ Pulsar çš„æ‰€æœ‰å•æµ‹è·‘å®Œé€šå¸¸éœ€è¦ 1ï½2 ä¸ªå°æ—¶ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯æ—¥å¸¸ç¼–å†™å•æµ‹å¯èƒ½ä¼šç¢°åˆ°çš„åœºæ™¯ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰åˆ†äº«è¿‡å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹å¼€æºé¡¹ç›®ä»¥åŠå¦‚ä½•åœ¨å¼€æºé¡¹ç›®é‡Œåšé›†æˆæµ‹è¯•ï¼Œä½†è¿˜æ²¡æœ‰è®²è¿‡å…·ä½“çš„å®æ“ã€‚&lt;/p&gt;
&lt;p&gt;ä»Šå¤©æ¥è¯¦ç»†è®²è®²å¦‚ä½•å†™å•å…ƒæµ‹è¯•ã€‚&lt;/p&gt;
&lt;h1 id=&quot;ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&quot;&gt;&lt;a href=&quot;#ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&quot; class=&quot;headerlink&quot; title=&quot;ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&quot;&gt;&lt;/a&gt;ğŸ¤”ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å•å…ƒæµ‹è¯•&lt;/h1&gt;&lt;p&gt;è¿™ä¸ªå¤§å®¶åº”è¯¥æ˜¯æœ‰å…±è¯†çš„ï¼Œå¯¹äºä¸€äº›åŠŸèƒ½å•ä¸€ã€æ ¸å¿ƒé€»è¾‘ã€åŒæ—¶å˜åŒ–ä¸é¢‘ç¹çš„å…¬å¼€å‡½æ•°æ‰æœ‰å¿…è¦åšå•å…ƒæµ‹è¯•ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºä¸šåŠ¡å¤æ‚ã€é“¾è·¯ç¹çä½†ä¹Ÿæ˜¯æ ¸å¿ƒæµç¨‹çš„åŠŸèƒ½é€šå¸¸å»ºè®®åš e2e æµ‹è¯•ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æœ€ç»ˆæµ‹è¯•ç»“æœçš„ä¸€è‡´æ€§ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="å•æµ‹" scheme="http://crossoverjie.top/tags/%E5%8D%95%E6%B5%8B/"/>
    
  </entry>
  
  <entry>
    <title>Pulsarå‡çº§è‡ªåŠ¨åŒ–ï¼šä¸€é”®æå®šé›†ç¾¤å‡çº§ä¸æµ‹è¯•</title>
    <link href="http://crossoverjie.top/2024/08/06/ob/Pulsar%20test%20framework/"/>
    <id>http://crossoverjie.top/2024/08/06/ob/Pulsar%20test%20framework/</id>
    <published>2024-08-06T03:15:50.000Z</published>
    <updated>2024-08-06T02:22:27.446Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2024/07/01/xZSMlpJPWTRGkge.png"></p><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ç”±äºæˆ‘åœ¨å…¬å¸å†…éƒ¨è´Ÿè´£ç»´æŠ¤ <code>Pulsar</code>ï¼Œéœ€è¦æ—¶ä¸æ—¶çš„å‡çº§ <code>Pulsar</code> ç‰ˆæœ¬ä»è€Œå’Œç¤¾åŒºä¿æŒä¸€è‡´ã€‚</p><p>è€Œæ¯æ¬¡å‡çº§è¿‡ç¨‹éƒ½éœ€è¦åšç›¸åŒçš„æ­¥éª¤ï¼š</p><ul><li>å®‰è£…ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„é›†ç¾¤</li><li>è§¦å‘åŠŸèƒ½æ€§æµ‹è¯•</li><li>è§¦å‘æ€§èƒ½æµ‹è¯•</li><li>æŸ¥çœ‹ç›‘æ§æ˜¯å¦æ­£å¸¸<ul><li>åº”ç”¨æœ‰æ— å¼‚å¸¸æ—¥å¿—</li><li>æµé‡æ˜¯å¦æ­£å¸¸</li><li>å„ä¸ªç»„ä»¶çš„å†…å­˜å ç”¨æ˜¯å¦æ­£å¸¸</li><li>å†™å…¥å»¶è¿Ÿæ˜¯å¦æ­£å¸¸</li></ul></li></ul><span id="more"></span><h1 id="å‘½ä»¤è¡Œå·¥å…·"><a href="#å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="å‘½ä»¤è¡Œå·¥å…·"></a>å‘½ä»¤è¡Œå·¥å…·</h1><p>ä»¥ä¸Šçš„æµç¨‹æ­¥éª¤æœ€å¥½æ˜¯å…¨éƒ¨ä¸€é”®å®Œæˆï¼Œæˆ‘ä»¬åªéœ€è¦äººå·¥æ£€æµ‹ä¸‹ç›‘æ§æ˜¯å¦æ­£å¸¸å³å¯ã€‚</p><p>äºæ˜¯æˆ‘ä¾¿å†™äº†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/07/01/cmXCqk6nyj2DpZA.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pulsar-upgrade-cli -h                                                                                                  ok | at 10:33:18 </span><br><span class="line">A cli app for upgrading Pulsar</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  pulsar-upgrade-cli [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  completion  Generate the autocompletion script for the specified shell</span><br><span class="line">  help        Help about any command</span><br><span class="line">  install     install a target version</span><br><span class="line">  scale       scale statefulSet of the cluster</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --burst-limit int                 client-side default throttling limit (default 100)</span><br><span class="line">      --debug                           enable verbose output</span><br><span class="line">  -h, --help                            help for pulsar-upgrade-cli</span><br><span class="line">      --kube-apiserver string           the address and the port for the Kubernetes API server</span><br><span class="line">      --kube-as-group stringArray       group to impersonate for the operation, this flag can be repeated to specify multiple groups.</span><br><span class="line">      --kube-as-user string             username to impersonate for the operation</span><br></pre></td></tr></table></figure><p>çœŸå®ä½¿ç”¨çš„ <code>example</code> å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pulsar-upgrade-cli install \                                                   </span><br><span class="line">        --values ./charts/pulsar/values.yaml \</span><br><span class="line">        --set namespace=pulsar-test \</span><br><span class="line">        --set initialize=true \</span><br><span class="line">        --debug \</span><br><span class="line">        --test-case-schema=http \</span><br><span class="line">        --test-case-host=127.0.0.1 \</span><br><span class="line">        --test-case-port=9999 \</span><br><span class="line">    pulsar-test ./charts/pulsar -n pulsar-test</span><br></pre></td></tr></table></figure><p>å®ƒçš„å®‰è£…å‘½ä»¤éå¸¸ç±»ä¼¼äº <code>helm</code>ï¼Œä¹Ÿæ˜¯ç›´æ¥ä½¿ç”¨ helm çš„ <code>value.yaml</code> è¿›è¡Œå®‰è£…ï¼›åªæ˜¯åœ¨å®‰è£…æˆåŠŸåï¼ˆç­‰å¾…æ‰€æœ‰çš„ Pod éƒ½å¤„äº Running çŠ¶æ€ï¼‰ä¼šå†è§¦å‘ test-case æµ‹è¯•ï¼Œä¹Ÿå°±æ˜¯è¯·æ±‚ä¸€ä¸ª endpointã€‚</p><blockquote><p>è¿™ä¸ª endpoint ä¼šåœ¨å†…éƒ¨å¤„ç†æ‰€æœ‰çš„åŠŸèƒ½æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ï¼Œå…·ä½“ç»†èŠ‚å°±åœ¨åæ–‡åˆ†æã€‚</p></blockquote><p>åŒæ—¶è¿˜æä¾›äº†ä¸€ä¸ª scaleï¼ˆæ‰©ã€ç¼©å®¹ï¼‰ å‘½ä»¤ï¼Œå¯ä»¥ç”¨ä¿®æ”¹é›†ç¾¤è§„æ¨¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼©å®¹é›†ç¾¤è§„æ¨¡ä¸º0</span></span><br><span class="line">./pulsar-upgrade-cli scale --replicase 0 -n pulsar-test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼©å®¹ä¸ºæœ€å°é›†ç¾¤</span></span><br><span class="line">./pulsar-upgrade-cli scale --replicase 1 -n pulsar-test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¢å¤ä¸ºæœ€æ»¡é›†ç¾¤</span></span><br><span class="line">./pulsar-upgrade-cli scale --replicase 2 -n pulsar-test</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªéœ€æ±‚æ˜¯å› ä¸ºæˆ‘ä»¬çš„ <code>Pulsar</code> æµ‹è¯•é›†ç¾¤éƒ¨ç½²åœ¨äº†ä¸€ä¸ª <code>servless</code> çš„ <code>kubernetes</code> é›†ç¾¤é‡Œï¼Œå®ƒæ˜¯æŒ‰ç…§ä½¿ç”¨é‡æ”¶è´¹çš„ï¼Œæ‰€ä»¥åœ¨æˆ‘ä¸éœ€è¦çš„ä½¿ç”¨çš„æ—¶å€™å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤å°†æ‰€æœ‰çš„å‰¯æœ¬æ•°é‡ä¿®æ”¹ä¸º 0ï¼Œä»è€Œå‡å°‘ä½¿ç”¨æˆæœ¬ã€‚</p><p>å½“åªéœ€è¦åšç®€å•çš„åŠŸèƒ½æµ‹è¯•æ—¶ä¾¿å›å°†é›†ç¾¤ä¿®æ”¹ä¸ºæœ€å°é›†ç¾¤ï¼Œå°†å‰¯æœ¬æ•°ä¿®æ”¹ä¸ºåªå¯ä»¥æä¾›æœåŠ¡å³å¯ã€‚</p><p>è€Œå½“éœ€è¦åšæ€§èƒ½æµ‹è¯•æ—¶å°±éœ€è¦å°†é›†ç¾¤ä¿®æ”¹ä¸ºæœ€é«˜é…ç½®ã€‚</p><p>è¿™æ ·å¯ä»¥é¿å…æ¯æ¬¡éƒ½å®‰è£…æ–°é›†ç¾¤ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æœ‰æ•ˆçš„å‡å°‘æµ‹è¯•æˆæœ¬ã€‚</p><h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">require (  </span><br><span class="line">    github.com/spf13/cobra v1<span class="number">.6</span><span class="number">.1</span>  </span><br><span class="line">    github.com/spf13/pflag v1<span class="number">.0</span><span class="number">.5</span>   </span><br><span class="line">    helm.sh/helm/v3 v3<span class="number">.10</span><span class="number">.2</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤è¡Œå·¥å…·æœ¬è´¨ä¸Šæ˜¯å‚è€ƒäº† helm çš„å‘½ä»¤è¡Œå®ç°çš„ï¼Œæ‰€æœ‰ä¸»è¦ä¹Ÿæ˜¯ä¾èµ–äº† <code>helm</code> å’Œ <code>cobra</code>ã€‚</p><p><img src="https://s2.loli.net/2024/07/01/rouTSUBDIWciElx.png"><br>ä¸‹é¢ä»¥æœ€ä¸»è¦çš„å®‰è£…å‘½ä»¤ä¸ºä¾‹ï¼Œæ ¸å¿ƒçš„æ˜¯ä»¥ä¸‹çš„æ­¥éª¤ï¼š</p><ul><li>æ‰§è¡Œ <code>helm</code> å®‰è£…ï¼ˆè¿™é‡Œæ˜¯ç›´æ¥ä½¿ç”¨çš„ helm çš„æºç é€»è¾‘è¿›è¡Œå®‰è£…ï¼‰</li><li>ç­‰å¾…æ‰€æœ‰çš„ <code>Pod</code> æˆåŠŸè¿è¡Œ</li><li>è§¦å‘ <code>test-case</code> æ‰§è¡Œ</li><li>ç­‰å¾…æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå®Œæ¯•</li><li>æ£€æµ‹æ˜¯å¦éœ€è¦å¸è½½å®‰è£…çš„é›†ç¾¤</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *installEvent)</span></span> FinishInstall(cfg *action.Configuration, name <span class="type">string</span>) <span class="type">error</span> &#123;  </span><br><span class="line">    bar.Increment()  </span><br><span class="line">    bar.Finish()  </span><br><span class="line">  </span><br><span class="line">    clientSet, err := cfg.KubernetesClientSet()  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">    ctx := context.Background()  </span><br><span class="line">    ip, err := GetServiceExternalIp(ctx, clientSet, settings.Namespace(), fmt.Sprintf(<span class="string">&quot;%s-proxy&quot;</span>, name))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    token, err := GetPulsarProxyToken(ctx, clientSet, settings.Namespace(), fmt.Sprintf(<span class="string">&quot;%s-token-proxy-admin&quot;</span>, name))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// trigger testcase  </span></span><br><span class="line">    err = e.client.Trigger(context.Background(), ip, token)  </span><br><span class="line">    <span class="keyword">return</span> err  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>FinishInstall</code> éœ€è¦è·å–åˆ°æ–°å®‰è£…çš„ Pulsar é›†ç¾¤çš„ proxy IP åœ°å€å’Œé‰´æƒæ‰€ä½¿ç”¨çš„ <code>token</code>(<code>GetServiceExternalIp()</code>&#x2F;<code>GetPulsarProxyToken()</code>)ã€‚</p><p>å°†è¿™ä¸¤ä¸ªå‚æ•°ä¼ é€’ç»™ <code>test-case</code> æ‰å¯ä»¥æ„å»ºå‡º <code>pulsar-client</code>.</p><p>è¿™ä¸ªå‘½ä»¤çš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯å®‰è£…é›†ç¾¤å’Œè§¦å‘æµ‹è¯•ï¼Œä»¥åŠä¸€äº›é›†ç¾¤çš„åŸºæœ¬è¿ç»´èƒ½åŠ›ã€‚</p><h1 id="æµ‹è¯•æ¡†æ¶"><a href="#æµ‹è¯•æ¡†æ¶" class="headerlink" title="æµ‹è¯•æ¡†æ¶"></a>æµ‹è¯•æ¡†æ¶</h1><p>è€Œå…³äºè¿™é‡Œçš„æµ‹è¯•ç”¨ä¾‹ä¹Ÿæœ‰ä¸€äº›å°ä¼™ä¼´å’¨è¯¢è¿‡ï¼Œå¦‚ä½•å¯¹ Pulsar è¿›è¡ŒåŠŸèƒ½æµ‹è¯•ã€‚</p><p>å…¶å® Pulsar æºç ä¸­å·²ç»åŒ…å«äº†å‡ ä¹æ‰€æœ‰æˆ‘ä»¬ä¼šä½¿ç”¨åˆ°çš„æµ‹è¯•ä»£ç ï¼Œç†è®ºä¸Šåªè¦æ–°ç‰ˆæœ¬çš„å®˜æ–¹é•œåƒå·²ç»æ¨é€äº†é‚£å°±æ˜¯è·‘äº†æ‰€æœ‰çš„å•æµ‹ï¼Œè´¨é‡æ˜¯å¯ä»¥ä¿è¯çš„ã€‚</p><p>é‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦åšåŠŸèƒ½æµ‹è¯•å‘¢ï¼Ÿ</p><p>å…¶å®å¾ˆå¾ˆç®€å•ï¼Œ<code>Pulsar</code> è¿™ç±»åŸºç¡€ç»„ä»¶å®˜æ–¹éƒ½æœ‰æä¾›åŸºå‡†æµ‹è¯•ï¼Œä½†æˆ‘ä»¬æƒ³è¦ç”¨äºç”Ÿäº§ç¯å¢ƒä¾ç„¶éœ€è¦è‡ªå·±åšå‹æµ‹å¾—å‡ºä¸€ä»½å±äºè‡ªå·±ç¯å¢ƒä¸‹çš„æ€§èƒ½æµ‹è¯•æŠ¥å‘Šï¼›</p><p>æ ¹æœ¬ç›®çš„æ˜¯è¦çœ‹åœ¨è‡ªå·±çš„ä¸šåŠ¡åœºæ™¯ä¸‹æ˜¯å¦å¯ä»¥æ»¡è¶³ï¼ˆåŒ…æ‹¬å…¬å¸çš„è½¯ç¡¬ä»¶ï¼Œä¸åŒçš„ä¸šåŠ¡ä»£ç ï¼‰ã€‚</p><p>æ‰€ä»¥è¿™é‡Œçš„åŠŸèƒ½æµ‹è¯•ä»£ç æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å‰æå°±æ˜¯ï¼š<strong>éœ€è¦ä½¿ç”¨çœŸå®çš„ä¸šåŠ¡ä»£ç è¿›è¡Œæµ‹è¯•</strong>ã€‚</p><p>ä¹Ÿå°±æ˜¯ä¸šåŠ¡åœ¨çº¿ä¸Šä½¿ç”¨ä¸ Pulsar ç›¸å…³çš„ä»£ç éœ€è¦å‚è€ƒåŠŸèƒ½æµ‹è¯•é‡Œçš„ä»£ç å®ç°ï¼Œä¸ç„¶æœ‰äº›é—®é¢˜å°±æ— æ³•åœ¨æµ‹è¯•ç¯èŠ‚è¦†ç›–åˆ°ã€‚</p><blockquote><p>è¿™é‡Œæˆ‘å°±è¸©è¿‡å‘ï¼Œå› ä¸ºåœ¨åŠŸèƒ½æµ‹è¯•é‡Œç”¨çš„æ˜¯å®˜æ–¹çš„ example ä»£ç è¿›è¡Œæµ‹è¯•çš„ï¼Œè‡ªç„¶æ˜¯æ²¡æœ‰é—®é¢˜ï¼›ä½†ä¸šåŠ¡åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œä½¿ç”¨åˆ°äº†ä¸€ä¸ª Schema çš„åœºæ™¯ï¼Œå¹¶æ²¡æœ‰åœ¨åŠŸèƒ½æµ‹è¯•é‡Œè¦†ç›–åˆ°ï¼ˆå®˜æ–¹çš„æµ‹è¯•ç”¨ä¾‹é‡Œä¹Ÿæ²¡æœ‰ğŸ˜‚ï¼‰ï¼Œå°±å¯¼è‡´å‡çº§åˆ°æŸä¸ªç‰ˆæœ¬åä¸šåŠ¡åŠŸèƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼ˆè™½ç„¶ç”¨æ³•ç¡®å®æ˜¯æœ‰é—®é¢˜ï¼‰ï¼Œä½†åº”è¯¥åœ¨æˆ‘æµ‹è¯•é˜¶æ®µå°±æš´éœ²å‡ºæ¥ã€‚</p></blockquote><h2 id="å®ç°åŸç†-1"><a href="#å®ç°åŸç†-1" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p><img src="https://s2.loli.net/2024/07/01/3vZiGABjkYh5LUJ.png"><br>ä»¥ä¸Šæ˜¯ä¸€ä¸ªé›†ç¾¤çš„åŠŸèƒ½æµ‹è¯•æŠ¥å‘Šï¼Œè¿™é‡Œæˆ‘åªæœ‰ 8 ä¸ªæµ‹è¯•åœºæ™¯ï¼ˆç»“åˆå®é™…ä¸šåŠ¡ä½¿ç”¨ï¼‰ï¼Œè€ƒè™‘åˆ°æœªæ¥å¯èƒ½ä¼šæœ‰æ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæ‰€ä»¥åœ¨è®¾è®¡è¿™ä¸ªæµ‹è¯•æ¡†æ¶æ—¶å°±å¾—è€ƒè™‘åˆ°æ‰©å±•æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AbstractJobDefine</span> <span class="variable">job5</span> <span class="operator">=</span>  </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">FailoverConsumerTest</span>(event, <span class="string">&quot;æ•…éšœè½¬ç§»æ¶ˆè´¹æµ‹è¯•&quot;</span>, pulsarClient, <span class="number">20</span>, admin);  </span><br><span class="line">CompletableFuture&lt;Void&gt; c5 = CompletableFuture.runAsync(job5::start, EXECUTOR);  </span><br><span class="line"><span class="type">AbstractJobDefine</span> <span class="variable">job6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchemaTest</span>(event,<span class="string">&quot;schemaæµ‹è¯•&quot;</span>,pulsarClient,<span class="number">20</span>,prestoService);  </span><br><span class="line">CompletableFuture&lt;Void&gt; c6 = CompletableFuture.runAsync(job6::start, EXECUTOR);  </span><br><span class="line"><span class="type">AbstractJobDefine</span> <span class="variable">job7</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VlogsTest</span>(event,<span class="string">&quot;vlogs test&quot;</span>,pulsarClient,<span class="number">20</span>, vlogsUrl);  </span><br><span class="line">CompletableFuture&lt;Void&gt; c7 = CompletableFuture.runAsync(job7::start, EXECUTOR);  </span><br><span class="line">  </span><br><span class="line">CompletableFuture&lt;Void&gt; all = CompletableFuture.allOf(c1, c2, c3, c4, c5, c6, c7);  </span><br><span class="line">all.whenComplete((___, __) -&gt; &#123;  </span><br><span class="line">    event.finishAll();  </span><br><span class="line">    pulsarClient.closeAsync();  </span><br><span class="line">    admin.close();  </span><br><span class="line">&#125;).get();</span><br></pre></td></tr></table></figure><p>å¯¹å¤–æä¾›çš„ trigger æ¥å£å°±ä¸è´´ä»£ç äº†ï¼Œé‡ç‚¹å°±æ˜¯åœ¨è¿™é‡Œæ„å»ºæµ‹è¯•ä»»åŠ¡ï¼Œç„¶åç­‰å¾…ä»–ä»¬å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractJobDefine</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Event event;</span><br><span class="line">    <span class="keyword">private</span> String jobName;</span><br><span class="line">    <span class="keyword">private</span> PulsarClient pulsarClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> timeout;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PulsarAdmin admin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbstractJobDefine</span><span class="params">(Event event, String jobName, PulsarClient pulsarClient, <span class="type">int</span> timeout, PulsarAdmin admin)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.event = event;</span><br><span class="line">        <span class="built_in">this</span>.jobName = jobName;</span><br><span class="line">        <span class="built_in">this</span>.pulsarClient = pulsarClient;</span><br><span class="line">        <span class="built_in">this</span>.timeout = timeout;</span><br><span class="line">        <span class="built_in">this</span>.admin = admin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        event.addJob();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">                <span class="type">StopWatch</span> <span class="variable">watch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    watch.start(jobName);</span><br><span class="line">                    run(pulsarClient, admin);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    event.oneException(<span class="built_in">this</span>, e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    watch.stop();</span><br><span class="line">                    event.finishOne(jobName, StrUtil.format(<span class="string">&quot;cost: &#123;&#125;s&quot;</span>, watch.getTotalTimeSeconds()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, TestCase.EXECUTOR).get(timeout, TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            event.oneException(<span class="built_in">this</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** run busy code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pulsarClient pulsar client</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> admin pulsar admin client</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception e</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(PulsarClient pulsarClient, PulsarAdmin admin)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒä»£ç å°±æ˜¯è¿™ä¸ªæŠ½è±¡çš„ä»»åŠ¡å®šä¹‰ç±»ï¼Œå…¶ä¸­çš„ start å‡½æ•°ç”¨äºå®šä¹‰ä»»åŠ¡æ‰§è¡Œçš„æ¨¡ç‰ˆï¼š</p><ul><li>æ·»åŠ ä»»åŠ¡ï¼šå…·ä½“å®ç°æ˜¯ä»»åŠ¡è®¡æ•°å™¨+1</li><li>å¼€å§‹è®¡æ—¶</li><li>æ‰§è¡ŒæŠ½è¡€çš„ run å‡½æ•°ï¼Œå…·ä½“å®ç°äº¤ç»™å­ç±»</li><li>å¼‚å¸¸æ—¶è®°å½•äº‹ä»¶</li><li>æ­£å¸¸æ‰§è¡Œå®Œæ¯•åä¹Ÿè®°å½•äº‹ä»¶</li></ul><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸ªæ™®é€šç”¨ä¾‹çš„å®ç°æƒ…å†µï¼š<br><img src="https://s2.loli.net/2024/07/01/rdU5mPbfOJxv4TL.png"></p><p>å°±æ˜¯é‡å†™äº† <code>run()</code> å‡½æ•°ï¼Œç„¶ååœ¨å…¶ä¸­å®ç°å…·ä½“çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæ–­è¨€æµ‹è¯•ç»“æœã€‚</p><p>è¿™æ ·å½“æˆ‘ä»¬éœ€è¦å†æ·»åŠ ç”¨ä¾‹çš„æ—¶å€™åªéœ€è¦å†æ–°å¢ä¸€ä¸ªå­ç±»å®ç°å³å¯ã€‚</p><p>åŒæ—¶è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªäº‹ä»¶æ¥å£ï¼Œç”¨äºå¤„ç†ä¸€äº›å…³é”®çš„èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Event</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * æ–°å¢ä¸€ä¸ªä»»åŠ¡  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addJob</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** è·å–è¿è¡Œä¸­çš„ä»»åŠ¡æ•°é‡  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è·å–è¿è¡Œä¸­çš„ä»»åŠ¡æ•°é‡  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    TestCaseRuntimeResponse <span class="title function_">getRuntime</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * å•ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•  </span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobName    ä»»åŠ¡åç§°  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> finishCost ä»»åŠ¡å®Œæˆè€—æ—¶  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">finishOne</span><span class="params">(String jobName, String finishCost)</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**å•ä¸ªä»»åŠ¡æ‰§è¡Œå¼‚å¸¸  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobDefine ä»»åŠ¡  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e å¼‚å¸¸  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">oneException</span><span class="params">(AbstractJobDefine jobDefine, Exception e)</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">finishAll</span><span class="params">()</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>getRuntime</code> æ¥å£æ˜¯ç”¨äºåœ¨ cli é‚£è¾¹æŸ¥è¯¢ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæ¯•çš„æ¥å£ï¼Œåªæœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰èƒ½é€€å‡º <code>cli</code>ã€‚</p><h1 id="ç›‘æ§æŒ‡æ ‡"><a href="#ç›‘æ§æŒ‡æ ‡" class="headerlink" title="ç›‘æ§æŒ‡æ ‡"></a>ç›‘æ§æŒ‡æ ‡</h1><p>å½“è¿™äº›ä»»åŠ¡è¿è¡Œå®Œæ¯•åæˆ‘ä»¬éœ€è¦é‡ç‚¹æŸ¥çœ‹åº”ç”¨å®¢æˆ·ç«¯å’Œ Pulsar broker ç«¯æ˜¯å¦æœ‰å¼‚å¸¸æ—¥å¿—ã€‚</p><p>åŒæ—¶è¿˜éœ€è¦è§‚å¯Ÿä¸€äº›å…³é”®çš„ç›‘æ§é¢æ¿ï¼š</p><p><img src="https://s2.loli.net/2024/07/01/sGxOjRWnScPl5oZ.png"><br><img src="https://s2.loli.net/2024/07/01/E6hcSxHrRmNVFoi.png"><br><img src="https://s2.loli.net/2024/07/01/UeFZ73yRbpkAsEH.png"></p><p>åŒ…å«ä½†ä¸é™äºï¼š</p><ul><li>æ¶ˆæ¯ååé‡</li><li><code>broker</code> å†™å…¥å»¶è¿Ÿ</li><li><code>Bookkeeper</code> çš„å†™å…¥ã€è¯»å–æˆåŠŸç‡ï¼Œä»¥åŠå»¶è¿Ÿã€‚</li></ul><p>å½“ç„¶è¿˜æœ‰ <code>zookeeper</code> çš„è¿è¡Œæƒ…å†µä¹Ÿéœ€è¦ç›‘æ§ï¼Œé™äºç¯‡å¹…å°±ä¸ä¸€ä¸€ç²˜è´´äº†ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯æµ‹è¯•æ•´ä¸ª Pulsar é›†ç¾¤çš„æµç¨‹ï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹ã€‚</p><p>æ¯”å¦‚ä½¿ç”¨å‘½ä»¤è¡Œè¿˜æ˜¯æœ‰äº›ä¸ä¾¿ï¼Œåç»­å¯èƒ½ä¼šåˆ‡æ¢åˆ°ç½‘é¡µä¸Šå°±å¯ä»¥æ“ä½œã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/07/01/xZSMlpJPWTRGkge.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;ç”±äºæˆ‘åœ¨å…¬å¸å†…éƒ¨è´Ÿè´£ç»´æŠ¤ &lt;code&gt;Pulsar&lt;/code&gt;ï¼Œéœ€è¦æ—¶ä¸æ—¶çš„å‡çº§ &lt;code&gt;Pulsar&lt;/code&gt; ç‰ˆæœ¬ä»è€Œå’Œç¤¾åŒºä¿æŒä¸€è‡´ã€‚&lt;/p&gt;
&lt;p&gt;è€Œæ¯æ¬¡å‡çº§è¿‡ç¨‹éƒ½éœ€è¦åšç›¸åŒçš„æ­¥éª¤ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®‰è£…ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„é›†ç¾¤&lt;/li&gt;
&lt;li&gt;è§¦å‘åŠŸèƒ½æ€§æµ‹è¯•&lt;/li&gt;
&lt;li&gt;è§¦å‘æ€§èƒ½æµ‹è¯•&lt;/li&gt;
&lt;li&gt;æŸ¥çœ‹ç›‘æ§æ˜¯å¦æ­£å¸¸&lt;ul&gt;
&lt;li&gt;åº”ç”¨æœ‰æ— å¼‚å¸¸æ—¥å¿—&lt;/li&gt;
&lt;li&gt;æµé‡æ˜¯å¦æ­£å¸¸&lt;/li&gt;
&lt;li&gt;å„ä¸ªç»„ä»¶çš„å†…å­˜å ç”¨æ˜¯å¦æ­£å¸¸&lt;/li&gt;
&lt;li&gt;å†™å…¥å»¶è¿Ÿæ˜¯å¦æ­£å¸¸&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/tags/Pulsar/"/>
    
  </entry>
  
  <entry>
    <title>Pulsarå®¢æˆ·ç«¯æ¶ˆè´¹æ¨¡å¼æ­ç§˜ï¼šGo è¯­è¨€å®ç° ZeroQueueConsumer</title>
    <link href="http://crossoverjie.top/2024/07/29/ob/pulsar-client-zero-consumer/"/>
    <id>http://crossoverjie.top/2024/07/29/ob/pulsar-client-zero-consumer/</id>
    <published>2024-07-29T14:31:57.000Z</published>
    <updated>2024-07-29T03:08:42.394Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ®µæ—¶é—´åœ¨ <a href="https://github.com/apache/pulsar-client-go">pulsar-client-go</a> ç¤¾åŒºé‡Œçœ‹åˆ°è¿™ä¹ˆä¸€ä¸ª <a href="https://github.com/apache/pulsar-client-go/issues/1223">issue</a>ï¼š<br><img src="https://s2.loli.net/2024/06/24/KNsvV7jeZYSaiPq.png"></p><span id="more"></span><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/apache/pulsar-client-go/pulsar&quot;</span></span><br><span class="line"></span><br><span class="line">client, err := pulsar.NewClient(pulsar.ClientOptions&#123;</span><br><span class="line">    URL: <span class="string">&quot;pulsar://localhost:6650&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">consumer, err := client.Subscribe(pulsar.ConsumerOptions&#123;</span><br><span class="line">    Topic:             <span class="string">&quot;persistent://public/default/mq-topic-1&quot;</span>,</span><br><span class="line">    SubscriptionName:  <span class="string">&quot;sub-1&quot;</span>,</span><br><span class="line">    Type:              pulsar.Shared,</span><br><span class="line">    ReceiverQueueSize: <span class="number">0</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°äºç­‰äº 0 æ—¶ä¼šè®¾ç½®ä¸º 1000</span></span><br><span class="line"><span class="keyword">const</span> (  </span><br><span class="line">    defaultReceiverQueueSize = <span class="number">1000</span>  </span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> options.ReceiverQueueSize &lt;= <span class="number">0</span> &#123;  </span><br><span class="line">    options.ReceiverQueueSize = defaultReceiverQueueSize  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»–å‘ç°æ‰‹åŠ¨å°† pulsar-client-go å®¢æˆ·ç«¯çš„ <code>ReceiverQueueSize</code> è®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯åœ¨åˆå§‹åŒ–æ—¶ä¼šå†å°†å…¶è°ƒæ•´ä¸º 1000.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> options.ReceiverQueueSize &lt; <span class="number">0</span> &#123;  </span><br><span class="line">    options.ReceiverQueueSize = defaultReceiverQueueSize  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œå¦‚æœæ‰‹åŠ¨å°†æºç ä¿®æ”¹ä¸ºå¯ä»¥è®¾ç½®ä¸º 0 æ—¶ï¼Œå´ä¸èƒ½æ­£å¸¸æ¶ˆè´¹ï¼Œæ¶ˆè´¹è€…ä¼šä¸€ç›´å¤„äº waiting çŠ¶æ€ï¼Œè·å–ä¸åˆ°ä»»ä½•æ•°æ®ã€‚</p><p>ç»è¿‡æˆ‘çš„æ’æŸ¥å‘ç°æ˜¯ Pulsar çš„  Go  å®¢æˆ·ç«¯ç¼ºå°‘äº†ä¸€ä¸ª <a href="https://github.com/apache/pulsar/blob/83b86abcb74595d7e8aa31b238a7dbb19a04dde2/pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerImpl.java#L268-L272">ZeroQueueConsumerImpl</a>çš„å®ç°ç±»ï¼Œè¿™ä¸ªç±»ä¸»è¦ç”¨äºå¯ä»¥ç²¾ç»†æ§åˆ¶æ¶ˆè´¹é€»è¾‘ã€‚</p><blockquote><p>If youâ€™d like to have tight control over message dispatching across consumers, set the <strong>consumersâ€™Â receiver queueÂ size very low (potentially even to 0 if necessary)</strong>. Each consumer has a receiver queue that determines how many messages the consumer attempts to fetch at a time. For example, a receiver queue of 1000 (the default) means that the consumer attempts to process 1000 messages from the topicâ€™s backlogÂ uponÂ connection. Setting the receiver queue to 0 essentiallyÂ means ensuring that each consumer is only doing one thing at a time.</p></blockquote><p><a href="https://pulsar.apache.org/docs/next/cookbooks-message-queue/#client-configuration-changes">https://pulsar.apache.org/docs/next/cookbooks-message-queue/#client-configuration-changes</a></p><p>æ­£å¦‚å®˜æ–¹æ–‡æ¡£é‡Œæåˆ°çš„é‚£æ ·ï¼Œå¯ä»¥å°† ReceiverQueueSize è®¾ç½®ä¸º 0ï¼›è¿™æ ·æ¶ˆè´¹è€…å°±å¯ä»¥ä¸€æ¡æ¡çš„æ¶ˆè´¹æ•°æ®ï¼Œè€Œä¸ä¼šå°†æ¶ˆæ¯å †ç§¯åœ¨å®¢æˆ·ç«¯é˜Ÿåˆ—é‡Œã€‚</p><h1 id="å®¢æˆ·ç«¯æ¶ˆè´¹é€»è¾‘"><a href="#å®¢æˆ·ç«¯æ¶ˆè´¹é€»è¾‘" class="headerlink" title="å®¢æˆ·ç«¯æ¶ˆè´¹é€»è¾‘"></a>å®¢æˆ·ç«¯æ¶ˆè´¹é€»è¾‘</h1><p>å€Ÿæ­¤æœºä¼šéœ€è¦å†å›é¡¾ä¸‹ pulsar å®¢æˆ·ç«¯çš„æ¶ˆè´¹é€»è¾‘ï¼Œè¿™æ ·æ‰èƒ½ç†è§£ <code>ReceiverQueueSize</code> çš„ä½œç”¨ä»¥åŠå¦‚ä½•åœ¨ pulsar-client-go å¦‚ä½•å®ç°è¿™ä¸ª <code>ZeroQueueConsumerImpl</code>ã€‚</p><p>Pulsar å®¢æˆ·ç«¯çš„æ¶ˆè´¹æ¨¡å¼æ˜¯åŸºäºæ¨æ‹‰ç»“åˆçš„ï¼š</p><p><img src="https://s2.loli.net/2024/06/24/bTP1WGVJUR9wzYe.png"><br>å¦‚è¿™å¼ å›¾æ‰€æè¿°çš„æµç¨‹ï¼Œæ¶ˆè´¹è€…åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šä¸»åŠ¨å‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ª Flow çš„å‘½ä»¤ï¼Œå‘Šè¯‰æœåŠ¡ç«¯éœ€è¦ä¸‹å‘å¤šå°‘æ¡æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ã€‚</p><p>åŒæ—¶ä¼šä½¿ç”¨åˆšæ‰çš„é‚£ä¸ª <code>ReceiverQueueSize</code>å‚æ•°ä½œä¸ºå†…éƒ¨é˜Ÿåˆ—çš„å¤§å°ï¼Œå°†å®¢æˆ·ç«¯ä¸‹å‘çš„æ¶ˆæ¯å­˜å‚¨åœ¨å†…éƒ¨é˜Ÿåˆ—é‡Œã€‚</p><p>ç„¶ååœ¨è°ƒç”¨ <code>receive</code> å‡½æ•°çš„æ—¶å€™ä¼šç›´æ¥ä»è¿™ä¸ªé˜Ÿåˆ—é‡Œè·å–æ•°æ®ã€‚</p><p><img src="https://s2.loli.net/2024/06/24/e3AabLk4FqB8VTo.png"><br><img src="https://s2.loli.net/2024/06/24/ZGHiaXBJfEyxh5d.png"></p><p>æ¯æ¬¡æ¶ˆè´¹æˆåŠŸåéƒ½ä¼šå°†å†…éƒ¨çš„ä¸€ä¸ª <code>AvailablePermit+1</code>ï¼Œç›´åˆ°å¤§äº <code>MaxReceiveQueueSize / 2</code> å°±ä¼šå†æ¬¡å‘ broker å‘é€ flow å‘½ä»¤ï¼Œå‘Šè¯‰ broker å†æ¬¡ä¸‹å‘æ¶ˆæ¯ã€‚</p><p>æ‰€ä»¥è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆå…³é”®çš„äº‹ä»¶ï¼šå°±æ˜¯å‘ broker å‘é€ <code>flow</code> å‘½ä»¤ï¼Œè¿™æ ·æ‰ä¼šæœ‰æ–°çš„æ¶ˆæ¯ä¸‹å‘ç»™å®¢æˆ·ç«¯ã€‚</p><p>ä¹‹å‰ç»å¸¸éƒ½ä¼šæœ‰ç ”å‘åŒå­¦è®©æˆ‘æ’æŸ¥æ— æ³•æ¶ˆè´¹çš„é—®é¢˜ï¼Œæœ€ç»ˆå®šä½åˆ°çš„åŸå› å‡ ä¹éƒ½æ˜¯æ¶ˆè´¹ç¼“æ…¢ï¼Œå¯¼è‡´è¿™é‡Œçš„ <code>AvailablePermit</code> æ²¡æœ‰å¢é•¿ï¼Œä»è€Œä¹Ÿå°±ä¸ä¼šè§¦å‘ broker ç»™å®¢æˆ·ç«¯æ¨é€æ–°çš„æ¶ˆæ¯ã€‚</p><p>çœ‹åˆ°çš„ç°è±¡å°±æ˜¯æ¶ˆè´¹éå¸¸ç¼“æ…¢ã€‚</p><h1 id="ZeroQueueConsumerImpl-åŸç†"><a href="#ZeroQueueConsumerImpl-åŸç†" class="headerlink" title="ZeroQueueConsumerImpl åŸç†"></a>ZeroQueueConsumerImpl åŸç†</h1><p>ä¸‹é¢æ¥çœ‹çœ‹ <code>ZeroQueueConsumerImpl</code> æ˜¯å¦‚ä½•å®ç°é˜Ÿåˆ—å¤§å°ä¸º 0 ä¾ç„¶æ˜¯å¯ä»¥æ¶ˆè´¹çš„ã€‚</p><p><img src="https://s2.loli.net/2024/06/24/Vmk9l2nucP31bNX.png"><br>åœ¨æ„å»º consumer çš„æ—¶å€™ï¼Œå°±ä¼šæ ¹æ®é˜Ÿåˆ—å¤§å°ä»è€Œæ¥åˆ›å»ºæ™®é€šæ¶ˆè´¹è€…è¿˜æ˜¯ <code>ZeroQueueConsumerImpl</code> æ¶ˆè´¹è€…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">protected</span> CompletableFuture&lt;Message&lt;T&gt;&gt; <span class="title function_">internalReceiveAsync</span><span class="params">()</span> &#123;  </span><br><span class="line">    CompletableFuture&lt;Message&lt;T&gt;&gt; future = <span class="built_in">super</span>.internalReceiveAsync();  </span><br><span class="line">    <span class="keyword">if</span> (!future.isDone()) &#123;  </span><br><span class="line">        <span class="comment">// We expect the message to be not in the queue yet  </span></span><br><span class="line">        increaseAvailablePermits(cnx());  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> future;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ <code>ZeroQueueConsumerImpl</code> é‡å†™çš„ä¸€ä¸ªæ¶ˆè´¹å‡½æ•°ï¼Œå…¶ä¸­å…³é”®çš„å°±æ˜¯ <code>increaseAvailablePermits(cnx());</code>.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">increaseAvailablePermits</span><span class="params">(ClientCnx currentCnx)</span> &#123;</span><br><span class="line">    increaseAvailablePermits(currentCnx, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">increaseAvailablePermits</span><span class="params">(ClientCnx currentCnx, <span class="type">int</span> delta)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">available</span> <span class="operator">=</span> AVAILABLE_PERMITS_UPDATER.addAndGet(<span class="built_in">this</span>, delta);</span><br><span class="line">    <span class="keyword">while</span> (available &gt;= getCurrentReceiverQueueSize() / <span class="number">2</span> &amp;&amp; !paused) &#123;</span><br><span class="line">        <span class="keyword">if</span> (AVAILABLE_PERMITS_UPDATER.compareAndSet(<span class="built_in">this</span>, available, <span class="number">0</span>)) &#123;</span><br><span class="line">            sendFlowPermitsToBroker(currentCnx, available);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            available = AVAILABLE_PERMITS_UPDATER.get(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æºç é‡Œå¯ä»¥å¾—çŸ¥è¿™é‡Œçš„é€»è¾‘å°±æ˜¯å°† AvailablePermit è‡ªå¢ï¼Œè¾¾åˆ°é˜ˆå€¼åè¯·æ±‚ broker ä¸‹å‘æ¶ˆæ¯ã€‚</p><p>å› ä¸ºåœ¨ <code>ZeroQueueConsumerImpl</code> ä¸­é˜Ÿåˆ—å¤§å°ä¸º 0ï¼Œæ‰€ä»¥ <code>available &gt;= getCurrentReceiverQueueSize() / 2</code>æ°¸è¿œéƒ½ä¼šä¸º trueã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´æ¯æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯éƒ½ä¼šè¯·æ±‚ broker è®©å®ƒå†ä¸‹å‘ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†æ¯ä¸€æ¡æ¶ˆæ¯éƒ½ç²¾ç¡®æ§åˆ¶çš„æ•ˆæœã€‚</p><h1 id="pulsar-client-go-ä¸­çš„å®ç°"><a href="#pulsar-client-go-ä¸­çš„å®ç°" class="headerlink" title="pulsar-client-go ä¸­çš„å®ç°"></a>pulsar-client-go ä¸­çš„å®ç°</h1><p>ä¸ºäº†åœ¨ pulsar-client-go å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘æäº¤äº†ä¸€ä¸ª <a href="https://github.com/apache/pulsar-client-go/pull/1225">PR</a> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>å…¶å®ä»ä¸Šé¢çš„åˆ†æå·²ç»å¾—çŸ¥ä¸ºå•¥æ‰‹åŠ¨å°† <code>ReceiverQueueSize</code> è®¾ç½®ä¸º 0 æ— æ³•æ¶ˆè´¹æ¶ˆæ¯äº†ã€‚</p><p>æ ¹æœ¬åŸå› è¿˜æ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼˜äºé˜Ÿåˆ—ä¸º 0ï¼Œå¯¼è‡´ä¸ä¼šç»™ broker å‘é€ flow å‘½ä»¤ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰æ¶ˆæ¯æ¨é€åˆ°å®¢æˆ·ç«¯ï¼Œä¹Ÿå°±æ— æ³•æ¶ˆè´¹åˆ°æ•°æ®äº†ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬ä¾ç„¶å¾—å‚è€ƒ Java çš„ <code>ZeroQueueConsumerImpl</code> åœ¨æ¯æ¬¡æ¶ˆè´¹çš„æ—¶å€™éƒ½æ‰‹åŠ¨å¢åŠ   <code>availablePermits</code>ã€‚</p><p>ä¸ºæ­¤æˆ‘ä¹Ÿæ–°å¢äº†ä¸€ä¸ªæ¶ˆè´¹è€… <code>zeroQueueConsumer</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EnableZeroQueueConsumer, if enabled, the ReceiverQueueSize will be 0.  </span></span><br><span class="line"><span class="comment">// Notice: only non-partitioned topic is supported.  </span></span><br><span class="line"><span class="comment">// Default is false.  </span></span><br><span class="line">EnableZeroQueueConsumer <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">consumer, err := client.Subscribe(ConsumerOptions&#123;  </span><br><span class="line">    Topic:                   topicName,  </span><br><span class="line">    SubscriptionName:        <span class="string">&quot;sub-1&quot;</span>,  </span><br><span class="line">    Type:                    Shared,  </span><br><span class="line">    NackRedeliveryDelay:     <span class="number">1</span> * time.Second,  </span><br><span class="line">    EnableZeroQueueConsumer: <span class="literal">true</span>,  </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> options.EnableZeroQueueConsumer &#123;  </span><br><span class="line">    options.ReceiverQueueSize = <span class="number">0</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆ›å»ºæ¶ˆè´¹è€…çš„æ—¶å€™éœ€è¦æŒ‡å®šæ˜¯å¦å¼€å¯ <code>ZeroQueueConsumer</code>ï¼Œå½“å¼€å¯åä¼šæ‰‹åŠ¨å°† ReceiverQueueSize è®¾ç½®ä¸º 0.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ä»¥è®¾ç½®é»˜è®¤å€¼ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">receiverQueueSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨ Go ä¸­æ— æ³•åƒ Java é‚£æ ·åœ¨ç»“æ„ä½“åˆå§‹åŒ–åŒ–çš„æ—¶å€™å°±æŒ‡å®šé»˜è®¤å€¼ï¼Œå†åŠ ä¸Š Go çš„ int ç±»å‹å…·å¤‡é›¶å€¼ï¼ˆä¹Ÿå°±æ˜¯0ï¼‰ï¼Œæ‰€ä»¥æ— æ³•åŒºåˆ†å‡º ReceiverQueueSize&#x3D;0 æ˜¯ç”¨æˆ·ä¸»åŠ¨è®¾ç½®çš„ï¼Œè¿˜æ˜¯æ²¡æœ‰ä¼ å…¥è¿™ä¸ªå‚æ•°ä½¿ç”¨çš„é›¶å€¼ã€‚</p></blockquote><p>æ‰€ä»¥æ‰éœ€è¦æ–°å¢ä¸€ä¸ªå‚æ•°æ¥æ‰‹åŠ¨åŒºåˆ†æ˜¯å¦ä½¿ç”¨ <code>ZeroQueueConsumer</code>ã€‚</p><p><img src="https://s2.loli.net/2024/06/24/TK2fJVEFlnL4dIy.png"><br>ä¹‹ååœ¨åˆ›å»º <code>consumer</code> çš„æ—¶å€™è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰ä½¿ç”¨çš„æ˜¯å•åˆ†åŒºçš„ <code>topic</code> å¹¶ä¸”å¼€å¯äº† <code>EnableZeroQueueConsumer</code> æ‰èƒ½åˆ›å»º  <code>zeroQueueConsumer</code>ã€‚</p><hr><p><img src="https://s2.loli.net/2024/06/24/Aq5onPKOjIgserx.png"></p><blockquote><p>ä½¿ç”¨ PARTITIONED_METADATA å‘½ä»¤å¯ä»¥è®© broker è¿”å›åˆ†åŒºæ•°é‡ã€‚</p></blockquote><hr><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(z *zeroQueueConsumer)</span></span> Receive(ctx context.Context) (Message, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> state := z.pc.getConsumerState(); state == consumerClosed || state == consumerClosing &#123;</span><br><span class="line">z.log.WithField(<span class="string">&quot;state&quot;</span>, state).Error(<span class="string">&quot;Failed to ack by closing or closed consumer&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;consumer state is closed&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">z.Lock()</span><br><span class="line"><span class="keyword">defer</span> z.Unlock()</span><br><span class="line">z.pc.availablePermits.inc()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-z.closeCh:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, newError(ConsumerClosed, <span class="string">&quot;consumer closed&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> cm, ok := &lt;-z.messageCh:</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, newError(ConsumerClosed, <span class="string">&quot;consumer closed&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> cm.Message, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, ctx.Err()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„å…³é”®ä»£ç ï¼š<code>z.pc.availablePermits.inc()</code></p><p>æ¶ˆè´¹æ—¶çš„é€»è¾‘å…¶å®å’Œ Java çš„ <code>ZeroQueueConsumerImpl</code> é€»è¾‘ä¿æŒäº†ä¸€è‡´ï¼Œä¹Ÿæ˜¯æ¯æ¶ˆè´¹ä¸€æ¡æ•°æ®ä¹‹å‰å°±å¢åŠ ä¸€æ¬¡ <code>availablePermits</code>ã€‚</p><p>pulsar-client-go çš„è¿è¡ŒåŸç†ä¸ Java å®¢æˆ·ç«¯çš„ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å°†æ¶ˆæ¯å­˜æ”¾åœ¨äº†ä¸€ä¸ªå†…éƒ¨é˜Ÿåˆ—é‡Œï¼Œæ‰€ä»¥æ¯æ¬¡æ¶ˆè´¹æ¶ˆæ¯åªéœ€è¦ä»è¿™ä¸ªé˜Ÿåˆ— <code>messageCh</code> é‡Œè·å–å³å¯ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ pulsar-client-go ç‰ˆæœ¬çš„ <code>zeroQueueConsumer</code> å°±ä¸æ”¯æŒç›´æ¥è¯»å–å†…éƒ¨çš„é˜Ÿåˆ—äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(z *zeroQueueConsumer)</span></span> Chan() &lt;-<span class="keyword">chan</span> ConsumerMessage &#123;  </span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">&quot;zeroQueueConsumer cannot support Chan method&quot;</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šç›´æ¥ panicï¼Œå› ä¸ºç›´æ¥æ¶ˆè´¹ channel åœ¨å®¢æˆ·ç«¯å±‚é¢å°±æ²¡æ³•å¸®ç”¨æˆ·ä¸»åŠ¨å‘é€ flow å‘½ä»¤äº†ï¼Œæ‰€ä»¥è¿™ä¸ªåŠŸèƒ½å°±åªèƒ½å±è”½æ‰äº†ï¼Œåªå¯ä»¥ä¸»åŠ¨çš„ <code>receive</code> æ¶ˆæ¯ã€‚</p><p><img src="https://s2.loli.net/2024/06/24/dDlr3RWM6iYHFbc.png"></p><p>è®¸ä¹…ä¹‹å‰æˆ‘ä¹Ÿç”»è¿‡ä¸€ä¸ªå…³äº pulsar client çš„æ¶ˆè´¹æµç¨‹å›¾ï¼Œåç»­è€ƒè™‘ä¼šå†å†™ä¸€ç¯‡å…³äº pulsar client çš„åŸç†åˆ†ææ–‡ç« ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/apache/pulsar-client-go/issues/1223">https://github.com/apache/pulsar-client-go/issues/1223</a></li><li><a href="https://cloud.tencent.com/developer/article/2307608">https://cloud.tencent.com/developer/article/2307608</a></li><li><a href="https://pulsar.apache.org/docs/next/cookbooks-message-queue/#client-configuration-changes">https://pulsar.apache.org/docs/next/cookbooks-message-queue/#client-configuration-changes</a></li><li><a href="https://github.com/apache/pulsar-client-go/pull/1225">https://github.com/apache/pulsar-client-go/pull/1225</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰æ®µæ—¶é—´åœ¨ &lt;a href=&quot;https://github.com/apache/pulsar-client-go&quot;&gt;pulsar-client-go&lt;/a&gt; ç¤¾åŒºé‡Œçœ‹åˆ°è¿™ä¹ˆä¸€ä¸ª &lt;a href=&quot;https://github.com/apache/pulsar-client-go/issues/1223&quot;&gt;issue&lt;/a&gt;ï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/06/24/KNsvV7jeZYSaiPq.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="Pulsar" scheme="http://crossoverjie.top/categories/OB/Pulsar/"/>
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/tags/Pulsar/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ç›‘æ§ Nginx</title>
    <link href="http://crossoverjie.top/2024/07/23/ob/how-to-monitoring-nginx/"/>
    <id>http://crossoverjie.top/2024/07/23/ob/how-to-monitoring-nginx/</id>
    <published>2024-07-23T02:46:30.000Z</published>
    <updated>2024-07-23T03:18:06.688Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ®µæ—¶é—´æ¥åˆ°ä¸€ä¸ªéœ€æ±‚ï¼Œå¸Œæœ›å¯ä»¥ç›‘æ§ Nginx çš„è¿è¡ŒçŠ¶æ€ã€‚</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ Nginx ä½œä¸ºä¸€ä¸ªæµè¡Œçš„ Web æœåŠ¡å™¨æä¾›äº†å¤šç§èƒ½åŠ›ï¼ŒåŒ…æ‹¬åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ï¼›ä¹Ÿæ”¯æŒäº†è®¸å¤šåè®®ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>gRPC</li><li>http</li><li>WebSocket ç­‰<br>ä½œä¸ºä¸€ä¸ªæµé‡å…¥å£çš„ä¸­é—´ä»¶ï¼Œå¯¹å…¶çš„ç›‘æ§å°±æ˜¾å¾—è‡³å…³é‡è¦äº†ã€‚</li></ul><span id="more"></span><p>å¸‚é¢ä¸Šä¹Ÿæœ‰ä¸€äº›ç°æˆçš„äº§å“å¯ä»¥ç›‘æ§ Nginxï¼Œæ¯”å¦‚çŸ¥åçš„ç›‘æ§æœåŠ¡å•† <code>datadog</code> ä¹Ÿæä¾›äº† Nginx çš„ç›‘æ§ã€‚</p><p><img src="https://s2.loli.net/2024/06/21/BEjyS4ZQHKCrPqx.png"></p><p>ä½†æ˜¯æˆ‘è¿™æ˜¯ä¸€ä¸ªå†…ç½‘æœåŠ¡ï¼Œå¹¶ä¸èƒ½ä½¿ç”¨è¿™äº›å¤–éƒ¨çš„äº‘å‚å•†ï¼Œæ‰€æœ‰å°±åªèƒ½åœ¨å†…éƒ¨æ­å»º Nginx çš„ç›‘æ§æœåŠ¡äº†ã€‚</p><p>ä¸è¿‡ Nginx é»˜è®¤æƒ…å†µä¸‹å¹¶æ²¡æœ‰æä¾› <code>/metrics</code> çš„ endpointï¼Œä½†å¥½åœ¨å®ƒæä¾›äº†ä¸€ä¸ªé¢å¤–çš„æ¨¡å—ï¼š<code>stub_status</code> å¯ä»¥ç”¨äºè·å–ç›‘æ§æ•°æ®ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">  <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line">  <span class="string">server_name</span> <span class="string">_;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">location</span> <span class="string">/status</span> &#123;</span><br><span class="line">    <span class="string">stub_status</span> <span class="string">on;</span></span><br><span class="line">    <span class="string">access_log</span> <span class="string">off;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">      <span class="string">root</span> <span class="string">/usr/share/nginx/html;</span></span><br><span class="line">      <span class="string">index</span> <span class="string">index.html</span> <span class="string">index.htm;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/06/21/ZRIPyN2UxXuiCdE.png"><br>è¿™æ ·è®¿é—® <code>http://127.0.0.1:80/status</code> å°±å¯ä»¥æ‹¿åˆ°ä¸€äº›åŸºæœ¬çš„è¿è¡Œæ•°æ®ã€‚</p><p>ä½†è¿™ä¸ªæ ¼å¼æ˜æ˜¾ä¸æ˜¯ Prometheus æ‰€æ”¯æŒçš„ metrics æ ¼å¼ï¼Œæ— æ³•ç›´æ¥å°†æ•°æ®é‡‡é›†åˆ° Prometheus ä¸­ç„¶åé€šè¿‡ Grafana è¿›è¡ŒæŸ¥çœ‹ã€‚</p><p>æ‰€ä»¥è¿˜å¾—éœ€è¦ä¸€ä¸ªä¸­é—´å±‚æ¥å°†è¿™äº›æ•°æ®è½¬æ¢ä¸º Prometheus å¯ä»¥æ¥æ”¶çš„ metrics æ•°æ®ã€‚</p><h1 id="nginx-prometheus-exporter"><a href="#nginx-prometheus-exporter" class="headerlink" title="nginx-prometheus-exporter"></a>nginx-prometheus-exporter</h1><p>å¥½åœ¨ç¤¾åŒºå·²ç»æä¾›äº†ç±»ä¼¼çš„å·¥å…·ï¼š<a href="https://github.com/nginxinc/nginx-prometheus-exporter">nginx-prometheus-exporter</a> å®ƒè¯»å–åˆšæ‰ status endpoint æ‰€æš´éœ²çš„æ•°æ®ï¼Œç„¶åè½¬æ¢ä¸º Prometheus æ ¼å¼ï¼Œå¹¶å¯¹å¤–æä¾›äº†ä¸€ä¸ª <code>/metrics</code> çš„ endpoint ä¾› Prometheus æ¥é‡‡é›†ã€‚</p><h2 id="è½¬æ¢æ•°æ®"><a href="#è½¬æ¢æ•°æ®" class="headerlink" title="è½¬æ¢æ•°æ®"></a>è½¬æ¢æ•°æ®</h2><p>æˆ‘ä»¬åœ¨å¯åŠ¨è¿™ä¸ª <code>nginx-exporter</code> æ—¶éœ€è¦ä¼ å…¥åˆšæ‰ <code>Nginx</code> æš´éœ²çš„ <code>/status</code> endpointã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 9113:9113 nginx/nginx-prometheus-exporter:1.1.0 --nginx.scrape-uri=http://&lt;nginx&gt;:8080/stub_status</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> templateMetrics <span class="type">string</span> = <span class="string">`Active connections: %d</span></span><br><span class="line"><span class="string">server accepts handled requests</span></span><br><span class="line"><span class="string">%d %d %d</span></span><br><span class="line"><span class="string">Reading: %d Writing: %d Waiting: %d</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å– Nginx status æ•°æ®</span></span><br><span class="line">body, err := io.ReadAll(resp.Body)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to read the response body: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r := bytes.NewReader(body)</span><br><span class="line">stats, err := parseStubStats(r)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to parse response body %q: %w&quot;</span>, <span class="type">string</span>(body), err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£æ Nginx status æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseStubStats</span><span class="params">(r io.Reader)</span></span> (*StubStats, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> s StubStats</span><br><span class="line"><span class="keyword">if</span> _, err := fmt.Fscanf(r, templateMetrics,</span><br><span class="line">&amp;s.Connections.Active,</span><br><span class="line">&amp;s.Connections.Accepted,</span><br><span class="line">&amp;s.Connections.Handled,</span><br><span class="line">&amp;s.Requests,</span><br><span class="line">&amp;s.Connections.Reading,</span><br><span class="line">&amp;s.Connections.Writing,</span><br><span class="line">&amp;s.Connections.Waiting); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to scan template metrics: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¼šæŠŠåˆšæ‰è§£æåˆ°çš„æ•°æ®ç”Ÿæˆ metricsï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_active&quot;</span>],  </span><br><span class="line">    prometheus.GaugeValue, <span class="type">float64</span>(stats.Connections.Active))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_accepted&quot;</span>],  </span><br><span class="line">    prometheus.CounterValue, <span class="type">float64</span>(stats.Connections.Accepted))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_handled&quot;</span>],  </span><br><span class="line">    prometheus.CounterValue, <span class="type">float64</span>(stats.Connections.Handled))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_reading&quot;</span>],  </span><br><span class="line">    prometheus.GaugeValue, <span class="type">float64</span>(stats.Connections.Reading))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_writing&quot;</span>],  </span><br><span class="line">    prometheus.GaugeValue, <span class="type">float64</span>(stats.Connections.Writing))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;connections_waiting&quot;</span>],  </span><br><span class="line">    prometheus.GaugeValue, <span class="type">float64</span>(stats.Connections.Waiting))  </span><br><span class="line">ch &lt;- prometheus.MustNewConstMetric(c.metrics[<span class="string">&quot;http_requests_total&quot;</span>],  </span><br><span class="line">    prometheus.CounterValue, <span class="type">float64</span>(stats.Requests))</span><br></pre></td></tr></table></figure><p>è¿™äº› metrics æ˜¯ä¸€å¼€å§‹å°±å®šä¹‰å¥½çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewNginxCollector creates an NginxCollector.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNginxCollector</span><span class="params">(nginxClient *client.NginxClient, namespace <span class="type">string</span>, constLabels <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>, logger log.Logger)</span></span> *NginxCollector &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;NginxCollector&#123;</span><br><span class="line">nginxClient: nginxClient,</span><br><span class="line">logger:      logger,</span><br><span class="line">metrics: <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc&#123;</span><br><span class="line"><span class="string">&quot;connections_active&quot;</span>:   newGlobalMetric(namespace, <span class="string">&quot;connections_active&quot;</span>, <span class="string">&quot;Active client connections&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;connections_accepted&quot;</span>: newGlobalMetric(namespace, <span class="string">&quot;connections_accepted&quot;</span>, <span class="string">&quot;Accepted client connections&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;connections_handled&quot;</span>:  newGlobalMetric(namespace, <span class="string">&quot;connections_handled&quot;</span>, <span class="string">&quot;Handled client connections&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;connections_reading&quot;</span>:  newGlobalMetric(namespace, <span class="string">&quot;connections_reading&quot;</span>, <span class="string">&quot;Connections where NGINX is reading the request header&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;connections_writing&quot;</span>:  newGlobalMetric(namespace, <span class="string">&quot;connections_writing&quot;</span>, <span class="string">&quot;Connections where NGINX is writing the response back to the client&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;connections_waiting&quot;</span>:  newGlobalMetric(namespace, <span class="string">&quot;connections_waiting&quot;</span>, <span class="string">&quot;Idle client connections&quot;</span>, constLabels),</span><br><span class="line"><span class="string">&quot;http_requests_total&quot;</span>:  newGlobalMetric(namespace, <span class="string">&quot;http_requests_total&quot;</span>, <span class="string">&quot;Total http requests&quot;</span>, constLabels),</span><br><span class="line">&#125;,</span><br><span class="line">upMetric: newUpMetric(namespace, constLabels),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¸ªå‡½æ•°æ˜¯åœ¨ exporter å¯åŠ¨æ—¶å€™ä¼šè°ƒç”¨ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;github.com/prometheus/client_golang/prometheus&quot;</span></span><br><span class="line"></span><br><span class="line">prometheus.MustRegister(collector.NewNginxCollector(ossClient, <span class="string">&quot;nginx&quot;</span>, labels, logger))</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨çš„æ˜¯ <code>prometheus</code> åŒ…æä¾›çš„æ³¨å†Œå‡½æ•°ï¼Œå°†æˆ‘ä»¬åˆšæ‰è‡ªå®šä¹‰çš„è·å– <code>metrics</code> çš„é€»è¾‘æ³¨å†Œè¿›å»ï¼Œè¿™æ ·å½“æˆ‘ä»¬åœ¨ Prometheus ä¸­é…ç½®å¥½é‡‡é›†ä»»åŠ¡ä¹‹åå°±å¯ä»¥å®šæœŸæ‰«æ <code>/status</code> çš„æ•°æ®ç„¶åè½¬æ¢ä¸º Prometheus æŒ‡æ ‡è¿”å›ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">nginx-exportor</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;127.0.0.1:9113&#x27;</span>]</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥å°† nginx status çš„æ•°æ®å®šæœŸé‡‡é›†åˆ° Prometheus ä¸­äº†ï¼Œæœ€åä½¿ç”¨ç¤¾åŒºæä¾›çš„ grafana é¢æ¿ä¾¿å¯ä»¥å¯è§†åŒ–çš„æŸ¥çœ‹è¿™äº›ç›‘æ§æ•°æ®ï¼š<br><img src="https://s2.loli.net/2024/06/21/NvlwuAdDZHUznrC.png"></p><h2 id="Nginx-Plus"><a href="#Nginx-Plus" class="headerlink" title="Nginx Plus"></a>Nginx Plus</h2><p>åŒæ—¶è¿™ä¸ª nginx-exporter è¿˜æ”¯æŒ <code>Nginx Plus</code>(è¿™æ˜¯ Nginx çš„å•†ç”¨å¢å¼ºç‰ˆ)ï¼Œå®ƒçš„å®ç°åŸç†ç±»ä¼¼ï¼Œåªæ˜¯å®ƒæ”¯æŒçš„æŒ‡æ ‡æ›´å¤šä¸€äº›è€Œå·²ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NginxPlusCollector <span class="keyword">struct</span> &#123;  </span><br><span class="line">    upMetric                       prometheus.Gauge  </span><br><span class="line">    logger                         log.Logger  </span><br><span class="line">    cacheZoneMetrics               <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    workerMetrics                  <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    nginxClient                    *plusclient.NginxClient  </span><br><span class="line">    streamServerZoneMetrics        <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    streamZoneSyncMetrics          <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    streamUpstreamMetrics          <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    streamUpstreamServerMetrics    <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    locationZoneMetrics            <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    resolverMetrics                <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    limitRequestMetrics            <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    limitConnectionMetrics         <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    streamLimitConnectionMetrics   <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    upstreamServerMetrics          <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    upstreamMetrics                <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    streamUpstreamServerPeerLabels <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    serverZoneMetrics              <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    upstreamServerLabels           <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    streamUpstreamServerLabels     <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    serverZoneLabels               <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    streamServerZoneLabels         <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    upstreamServerPeerLabels       <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    workerLabels                   <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    cacheZoneLabels                <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>  </span><br><span class="line">    totalMetrics                   <span class="keyword">map</span>[<span class="type">string</span>]*prometheus.Desc  </span><br><span class="line">    variableLabelNames             VariableLabelNames  </span><br><span class="line">    variableLabelsMutex            sync.RWMutex  </span><br><span class="line">    mutex                          sync.Mutex  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://prometheus.io/docs/instrumenting/exporters/">Prometheus</a> ç¤¾åŒºä¸­æä¾›ä¸å°‘è¿™ç±» <code>exporter</code>ï¼š<br><img src="https://s2.loli.net/2024/06/21/ztuCr8FgJvcSbis.png"></p><p>è¿™äº› <code>exporter</code> è¦è§£å†³çš„é—®é¢˜éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œå¯¹äºä¸€äº›æ²¡æœ‰æš´éœ² <code>/metrics</code> çš„ä¸­é—´ä»¶é€šè¿‡ä»–ä»¬æä¾›çš„å®¢æˆ·ç«¯ç›´è¿ï¼Œç„¶åå°†è·å–åˆ°çš„æ•°æ®è½¬æ¢ä¸º Prometheus æ‰€æ”¯æŒçš„æ ¼å¼ã€‚</p><blockquote><p>éœ€è¦å•ç‹¬çš„ exporter æ”¯æŒçš„ä¸­é—´ä»¶å¤§éƒ¨åˆ†éƒ½æ˜¯ä¸€äº›è€ç‰Œäº§å“ï¼Œåœ¨è®¾è®¡ä¹‹åˆå°±æ²¡æœ‰è€ƒè™‘å¯è§‚æµ‹æ€§çš„éœ€æ±‚ï¼Œç°åœ¨ä¸€äº›æ–°çš„ä¸­é—´ä»¶å‡ ä¹éƒ½åŸç”Ÿæ”¯æŒ metricsï¼Œè¿™ç§äº§å“åªéœ€è¦åœ¨ Prometheus ä¸­é…ç½®é‡‡é›†ä»»åŠ¡å³å¯ã€‚</p></blockquote><h1 id="Cprobe"><a href="#Cprobe" class="headerlink" title="Cprobe"></a>Cprobe</h1><p>ä¸çŸ¥é“å¤§å®¶å‘ç°æ²¡æœ‰ï¼Œç¤¾åŒºä¸­æä¾›çš„ <code>exporter</code> è¿˜æ˜¯æŒºå¤šçš„ï¼Œä½†å¦‚æœæˆ‘ä»¬éƒ½éœ€è¦åœ¨è‡ªå·±çš„ç”Ÿäº§ç¯å¢ƒå°†è¿™äº› exporter éƒ¨ç½²èµ·æ¥å¤šå°‘ä¼šæœ‰äº›ç¹çï¼š</p><ul><li>ä¸åŒçš„ exporter éœ€è¦çš„å‚æ•°å¯èƒ½ä¸åŒ</li><li>æš´éœ²çš„ç«¯å£å¯èƒ½ä¸åŒ</li><li>é…ç½®æ–‡ä»¶éš¾ä»¥ç»Ÿä¸€ç®¡ç†</li></ul><p>åœ¨è¿™ä¸ªèƒŒæ™¯ä¸‹ç¤¾åŒºæœ‰å¤§ä½¬å‘èµ·äº†ä¸€ä¸ª <a href="https://github.com/cprobe/cprobe">cprobe</a> é¡¹ç›®ï¼Œè¿™æ˜¯ä¸€ä¸ªå¤§è€Œå…¨çš„é¡¹ç›®ï¼Œå¯ä»¥å°†æ•£è½åœ¨å„å¤„çš„ <code>exporter</code> éƒ½æ•´åˆåœ¨ä¸€èµ·ã€‚</p><p>å¹¶ä¸”ç»Ÿä¸€æŠ½è±¡äº†æ¥å…¥æ–¹å¼ï¼Œä½¿å¾—æ‰€æœ‰çš„æ’ä»¶éƒ½å¯ä»¥ç”¨ç±»ä¼¼çš„é…ç½®ä¹¦å†™æ–¹å¼æ¥ç»´æŠ¤è¿™äº›æ’ä»¶ã€‚</p><p>ç›®å‰å·²ç»æ”¯æŒä»¥ä¸‹ä¸€äº›å¸¸ç”¨çš„ä¸­é—´ä»¶ï¼š</p><p><img src="https://s2.loli.net/2024/06/21/eC75lpg2fBmstjS.png"></p><p>è¿™é‡Œçš„ Nginx å°±æ˜¯æœ¬æ¬¡ç›‘æ§çš„éœ€æ±‚è´¡çŒ®çš„ï¼Œå› ä¸ºè¿˜éœ€è¦ç›‘æ§è¿™é‡Œæ”¯æŒçš„ä¸€äº›å…¶ä»–ä¸­é—´ä»¶ï¼Œæ‰€ä»¥æœ€ç»ˆä¹Ÿæ˜¯ä½¿ç”¨ cprobe æ¥éƒ¨ç½²ç›‘æ§ã€‚</p><h2 id="æ•´åˆ-Nginx-exporter-åˆ°-Cprobe-ä¸­"><a href="#æ•´åˆ-Nginx-exporter-åˆ°-Cprobe-ä¸­" class="headerlink" title="æ•´åˆ Nginx exporter åˆ° Cprobe ä¸­"></a>æ•´åˆ Nginx exporter åˆ° Cprobe ä¸­</h2><p>ä¸‹é¢æ¥çœ‹çœ‹å¦‚ä½•å°†ç¤¾åŒºä¸­å·²ç»å­˜åœ¨çš„ Nginx exporter æ•´åˆåˆ°  cprobe ä¸­ï¼š</p><p>åœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆè¦æŠ½è±¡å‡ºè¿™ä¸ªæ’ä»¶éœ€è¦å“ªäº›é…ç½®ï¼Ÿ</p><p>è¿™ä¸ªå…¶å®å¾ˆå¥½è§£å†³ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹çœ‹éœ€è¦å®ç°çš„ exporter ä¸­æä¾›äº†å“ªäº›å‚æ•°ï¼Œè¿™é‡Œä»¥ Nginx çš„ä¸ºä¾‹ï¼š<br><img src="https://s2.loli.net/2024/06/21/zsY2F563pPglNcS.png"></p><p>æ’é™¤æ‰ä¸€äº›æˆ‘ä»¬ä¸éœ€è¦çš„ï¼Œæ¯”å¦‚ç«¯å£ã€æ—¥å¿—çº§åˆ«ã€endpointç­‰é…ç½®ä¹‹å¤–ï¼Œå°±åªéœ€è¦ä¸€äº›å…³äº SSL çš„é…ç½®ï¼Œæ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬éœ€è¦çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nginx_plus</span> = <span class="literal">false</span>  </span><br><span class="line"><span class="comment"># Path to the PEM encoded CA certificate file used to validate the servers SSL certificate.  </span></span><br><span class="line"><span class="attr">ssl_ca_cert</span> = <span class="string">&#x27;&#x27;</span>  </span><br><span class="line"><span class="comment"># Path to the PEM encoded client certificate file to use when connecting to the server.  </span></span><br><span class="line"><span class="attr">ssl_client_cert</span> = <span class="string">&#x27;&#x27;</span>  </span><br><span class="line"><span class="comment"># Path to the PEM encoded client certificate key file to use when connecting to the server.  </span></span><br><span class="line"><span class="attr">ssl_client_key</span> = <span class="string">&#x27;&#x27;</span>  </span><br><span class="line"><span class="comment"># Perform SSL certificate verification.  </span></span><br><span class="line"><span class="attr">ssl_verify</span> = <span class="literal">false</span>  </span><br><span class="line"><span class="attr">timeout</span> = <span class="string">&#x27;5s&#x27;</span></span><br></pre></td></tr></table></figure><p>ç„¶åå°†è¿™ä¸ª toml é‡Œçš„é…ç½®è½¬æ¢ä¸ºä¸€ä¸ª structã€‚</p><p>åœ¨ cprobe ä¸­æœ‰ä¸€ä¸ªæ ¸å¿ƒçš„æ¥å£ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// ParseConfig is used to parse config</span></span><br><span class="line">ParseConfig(baseDir <span class="type">string</span>, bs []<span class="type">byte</span>) (any, <span class="type">error</span>)</span><br><span class="line"><span class="comment">// Scrape is used to scrape metrics, cfg need to be cast specific cfg</span></span><br><span class="line">Scrape(ctx context.Context, target <span class="type">string</span>, cfg any, ss *types.Samples) <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ParseConfig</code> ç”¨äºå°†åˆšæ‰çš„é…ç½®æ–‡ä»¶æµæ ¼å¼åŒ–ä¸ºæ’ä»¶æ‰€éœ€è¦çš„é…ç½®ã€‚</p><p><code>Scrape</code> å‡½æ•°åˆ™æ˜¯ç”± cprobe å®šæ—¶è°ƒç”¨çš„å‡½æ•°ï¼Œä¼šä¼ å…¥æŠ“å–çš„ç›®æ ‡åœ°å€ï¼Œæ¯ä¸ªæ’ä»¶å°†æŠ“åˆ°çš„æ•°æ®å†™å…¥ <code>*types.Samples</code> ä¸­å³å¯ã€‚</p><p><code>cprobe</code> ä¼šå°† <code>*types.Samples</code> çš„æ•°æ®å‘é€åˆ° remote çš„ Prometheus ä¸­ã€‚</p><p>æ¥ä¸‹æ¥çœ‹çœ‹ Nginx æ’ä»¶çš„å®ç°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">NginxPlus     <span class="type">bool</span>          <span class="string">`toml:&quot;nginx_plus&quot;`</span></span><br><span class="line">SSLCACert     <span class="type">string</span>        <span class="string">`toml:&quot;ssl_ca_cert&quot;`</span></span><br><span class="line">SSLClientCert <span class="type">string</span>        <span class="string">`toml:&quot;ssl_client_cert&quot;`</span></span><br><span class="line">SSLClientKey  <span class="type">string</span>        <span class="string">`toml:&quot;ssl_client_key&quot;`</span></span><br><span class="line">SSLVerify     <span class="type">bool</span>          <span class="string">`toml:&quot;ssl_verify&quot;`</span></span><br><span class="line">Timeout       time.Duration <span class="string">`toml:&quot;timeout&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Nginx)</span></span> ParseConfig(baseDir <span class="type">string</span>, bs []<span class="type">byte</span>) (any, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> c Config</span><br><span class="line">err := toml.Unmarshal(bs, &amp;c)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> c.Timeout == <span class="number">0</span> &#123;</span><br><span class="line">c.Timeout = time.Millisecond * <span class="number">500</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;c, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ParseConfig</code> å¾ˆç®€å•ï¼Œå°±æ˜¯å°†é…ç½®æ–‡ä»¶è½¬æ¢ä¸º structã€‚</p><p>æŠ“å–å‡½æ•° <code>Scrape</code> ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">collect, err := registerCollector(transport, target, <span class="literal">nil</span>, conf)  </span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> err  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> prometheus.Metric)  </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    collect.Collect(ch)  </span><br><span class="line">    <span class="built_in">close</span>(ch)  </span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>å°±æ˜¯æ„å»ºä¹‹å‰åœ¨ <code>nginx exporter</code> ä¸­çš„ <code>prometheus.Collector</code>ï¼Œå…¶å®ä»£ç å¤§éƒ¨åˆ†ä¹Ÿæ˜¯ä»é‚£è¾¹å¤åˆ¶è¿‡æ¥çš„ã€‚<br><img src="https://s2.loli.net/2024/06/21/4yHQgL1EAiZXwju.png"><br><img src="https://s2.loli.net/2024/06/21/1OloLxpEnbqiaXA.png"><br>æ‰€ä»¥å…¶å®è¿ç§»ä¸€ä¸ª exporter åˆ° cprobe ä¸­éå¸¸ç®€å•ï¼Œåªéœ€è¦ï¼š</p><ul><li>å®šä¹‰å¥½éœ€è¦çš„é…ç½®ã€‚</li><li>å»æ‰ä¸éœ€è¦çš„ä»£ç ï¼Œæ¯”å¦‚æ—¥å¿—ã€ç«¯å£ä¹‹ç±»çš„ã€‚</li><li>é€‚é…å¥½åˆšæ‰é‚£ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•° <code>ParseConfig/Scrape</code> å³å¯ã€‚</li></ul><p>ä½†è¿™æ ·ä¹Ÿæœ‰äº›å°é—®é¢˜ï¼Œç°æœ‰çš„ä¸€äº› exporter è¿˜åœ¨è¿­ä»£ï¼Œé‚£è¾¹æ›´æ–°çš„ç‰ˆæœ¬éœ€è¦æœ‰äººåŠæ—¶åŒæ­¥è¿‡æ¥ã€‚</p><p>é™¤éæœ‰ä¸€å¤© cprobe å¯ä»¥ä½œä¸ºä¸€ä¸ªæ ‡å‡†ï¼Œç‰ˆæœ¬æ›´æ–°éƒ½åœ¨ cprobe è¿™è¾¹å®Œæˆï¼Œè¿™æ ·å°±çœŸçš„æ˜¯åšå¤§åšå¼ºäº†ã€‚</p><p>ä¸è¿‡è¿™äº›ä¾æ—§æ˜¯é€‚é…è€ä¸€ä»£çš„ä¸­é—´ä»¶äº§å“ï¼Œé€æ­¥éƒ½ä¼šé€‚é…ç°ä»£çš„å¯è§‚æµ‹ä½“ç³»ï¼Œè¿™äº› exporter ä¹Ÿä¼šé€æ¸èµ°ä¸‹å†å²èˆå°ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a></li><li><a href="https://github.com/nginxinc/nginx-prometheus-exporter">https://github.com/nginxinc/nginx-prometheus-exporter</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰æ®µæ—¶é—´æ¥åˆ°ä¸€ä¸ªéœ€æ±‚ï¼Œå¸Œæœ›å¯ä»¥ç›‘æ§ Nginx çš„è¿è¡ŒçŠ¶æ€ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬éƒ½çŸ¥é“ Nginx ä½œä¸ºä¸€ä¸ªæµè¡Œçš„ Web æœåŠ¡å™¨æä¾›äº†å¤šç§èƒ½åŠ›ï¼ŒåŒ…æ‹¬åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ï¼›ä¹Ÿæ”¯æŒäº†è®¸å¤šåè®®ï¼ŒåŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;gRPC&lt;/li&gt;
&lt;li&gt;http&lt;/li&gt;
&lt;li&gt;WebSocket ç­‰&lt;br&gt;ä½œä¸ºä¸€ä¸ªæµé‡å…¥å£çš„ä¸­é—´ä»¶ï¼Œå¯¹å…¶çš„ç›‘æ§å°±æ˜¾å¾—è‡³å…³é‡è¦äº†ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="Nginx" scheme="http://crossoverjie.top/tags/Nginx/"/>
    
    <category term="Monitor" scheme="http://crossoverjie.top/tags/Monitor/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼ç³»ç»Ÿå¦‚ä½•åšè´Ÿè½½å‡è¡¡</title>
    <link href="http://crossoverjie.top/2024/07/15/ob/Pulsar-loadbalance/"/>
    <id>http://crossoverjie.top/2024/07/15/ob/Pulsar-loadbalance/</id>
    <published>2024-07-15T02:22:14.000Z</published>
    <updated>2024-07-15T14:03:51.478Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>Pulsar æœ‰æä¾›ä¸€ä¸ªæŸ¥è¯¢ Broker è´Ÿè½½çš„æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get load for this broker.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> PulsarAdminException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">LoadManagerReport <span class="title function_">getLoadReport</span><span class="params">()</span> <span class="keyword">throws</span> PulsarAdminException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoadManagerReport</span> <span class="keyword">extends</span> <span class="title class_">ServiceLookupData</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    ResourceUsage <span class="title function_">getCpu</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    ResourceUsage <span class="title function_">getMemory</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    ResourceUsage <span class="title function_">getDirectMemory</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    ResourceUsage <span class="title function_">getBandwidthIn</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line">    ResourceUsage <span class="title function_">getBandwidthOut</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥è¿”å›ä¸€äº› broker çš„è´Ÿè½½æ•°æ®ï¼Œæ¯”å¦‚ CPUã€å†…å­˜ã€æµé‡ä¹‹ç±»çš„æ•°æ®ã€‚</p><span id="more"></span><blockquote><p>æˆ‘ç›®å‰ç¢°åˆ°çš„é—®é¢˜æ˜¯ç›®å‰ä¼šé‡åˆ°éƒ¨åˆ†èŠ‚ç‚¹çš„è´Ÿå€ºä¸å¹³è¡¡ï¼Œå¯¼è‡´èµ„æºå ç”¨ä¸å‡è¡¡ï¼Œæ‰€ä»¥æƒ³è¦æ‰‹åŠ¨æŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼Œç„¶åäººå·¥è¿›è¡Œè´Ÿè½½ã€‚</p></blockquote><p>ç†è®ºä¸Šè¿™äº›æ•°æ®æ˜¯åœ¨è¿è¡Œæ—¶å®æ—¶è®¡ç®—çš„æ•°æ®ï¼Œå¦‚æœå¯¹äºå•æœºçš„å€’è¿˜å¥½è¯´ï¼Œæ¯æ¬¡è¯·æ±‚è¿™ä¸ªæ¥å£ç›´æ¥å®æ—¶è®¡ç®—ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p><p>ä½†å¯¹äºé›†ç¾¤çš„æœåŠ¡æ¥è¯´ä¼šæœ‰å¤šä¸ªèŠ‚ç‚¹ï¼Œç›®å‰ Pulsar æä¾›çš„è¿™ä¸ªæ¥å£åªèƒ½æŸ¥è¯¢æŒ‡å®šèŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡å¾—ä¼ å…¥ç›®æ ‡èŠ‚ç‚¹çš„ IP å’Œç«¯å£ã€‚</p><p><img src="https://s2.loli.net/2024/06/07/ephIgndx54sFlLa.png"></p><p>æ‰€ä»¥æˆ‘çš„é¢„æœŸæ˜¯å¯ä»¥æä¾›ä¸€ä¸ªæŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹è´Ÿè½½çš„æ¥å£ï¼Œå·²ç»æäº† <code>issue</code>ï¼Œæœ€è¿‘å‡†å¤‡å†™ Purpose æŠŠè¿™ä¸ªéœ€æ±‚è§£å†³äº†ã€‚</p><p>å®ç°è¿™ä¸ªéœ€æ±‚çš„æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p><ol><li>æ‹¿åˆ°æ‰€æœ‰ broker ä¹Ÿå°±æ˜¯æœåŠ¡èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¾æ¬¡éå†è°ƒç”¨æ¥å£ï¼Œç„¶åè‡ªå·±ç»„è£…ä¿¡æ¯ã€‚</li><li>ä» zookeeper ä¸­è·å–è´Ÿè½½ä¿¡æ¯ã€‚</li></ol><p>ç†è®ºä¸Šç¬¬äºŒç§æ›´å¥½ï¼Œç¬¬ä¸€ç§å®ç°è™½ç„¶æ›´ç®€å•ï¼Œä½†æ¯æ¬¡éƒ½å‘èµ·ä¸€æ¬¡ http è¯·æ±‚ï¼Œå¤šå°‘æœ‰äº›æµªè´¹ã€‚</p><p>ç¬¬äºŒç§æ–¹æ¡ˆç›´æ¥ä»æºå¤´è·å–è´Ÿè½½ä¿¡æ¯ï¼Œåªéœ€è¦è¯·æ±‚ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p><p>è€Œæ­£å¥½ç¤¾åŒºæä¾›äº†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·å¯ä»¥ç›´æ¥æ‰“å°æ‰€æœ‰çš„ <code>broker</code> è´Ÿè½½æ•°æ®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pulsar-perf monitor-brokers --connect-string &lt;zookeeper host:port&gt;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/06/07/UN8gpW915RfcODb.png"></p><h1 id="åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨ç»„ä»¶"><a href="#åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨ç»„ä»¶" class="headerlink" title="åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨ç»„ä»¶"></a>åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨ç»„ä»¶</h1><p>æä¾›çš„å‘½ä»¤è¡Œå·¥å…·å…¶å®å°±æ˜¯ç›´æ¥ä» zookeeper ä¸­æŸ¥è¯¢çš„æ•°æ®ã€‚</p><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éœ€è¦ä¸€ä¸ªé›†ä¸­çš„ç»„ä»¶æ¥ç®¡ç†å„ç§æ•°æ®ï¼Œæ¯”å¦‚ï¼š</p><ol><li>å¯ä»¥åˆ©ç”¨è¯¥ç»„ä»¶æ¥é€‰ä¸¾ leader èŠ‚ç‚¹</li><li>ä½¿ç”¨è¯¥ç»„ä»¶æ¥åšåˆ†å¸ƒå¼é”</li><li>ä¸ºåˆ†å¸ƒå¼ç³»ç»ŸåŒæ­¥æ•°æ®</li><li>ç»Ÿä¸€çš„å­˜æ”¾å’Œè¯»å–æŸäº›æ•°æ®</li></ol><p>å¯ä»¥æä¾›è¯¥åŠŸèƒ½çš„ç»„ä»¶å…¶å®ä¹Ÿä¸å°‘ï¼š</p><ul><li><a href="https://zookeeper.apache.org/">zookeeper</a></li><li><a href="https://etcd.io/">etcd</a></li><li><a href="https://github.com/streamnative/oxia">oxia</a></li></ul><p>Zookeeper æ˜¯è€ç‰Œçš„åˆ†å¸ƒå¼åè°ƒç»„ä»¶ï¼Œå¯ä»¥åš leader é€‰ä¸¾ã€é…ç½®ä¸­å¿ƒã€åˆ†å¸ƒå¼é”ã€æœåŠ¡æ³¨å†Œä¸å‘ç°ç­‰åŠŸèƒ½ã€‚</p><p>åœ¨è®¸å¤šä¸­é—´ä»¶å’Œç³»ç»Ÿä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ï¼š</p><ul><li><a href="https://github.com/apache/pulsar">Apache Pulsar</a> ä¸­ä½œä¸ºåè°ƒä¸­å¿ƒ</li><li><a href="https://github.com/apache/kafka">Kafka</a> ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„ä½œç”¨ã€‚</li><li>åœ¨ <a href="https://github.com/apache/dubbo">Dubbo</a> ä¸­ä½œä¸ºæœåŠ¡æ³¨å†Œå‘ç°ç»„ä»¶ã€‚</li></ul><hr><p>etcd çš„åŠŸèƒ½ä¸ zookeeper ç±»ä¼¼ï¼Œå¯ä»¥ç”¨ä½œæœåŠ¡æ³¨å†Œå‘ç°ï¼Œä¹Ÿå¯ä»¥ä½œä¸º Key Value é”®å€¼å¯¹å­˜å‚¨ç³»ç»Ÿï¼›åœ¨ kubernetes ä¸­æ‰®æ¼”äº†å·¨å¤§ä½œç”¨ï¼Œç»å†äº†å„ç§è€ƒéªŒï¼Œç¨³å®šæ€§å·²ç»éå¸¸å¯é äº†ã€‚</p><hr><p><a href="https://github.com/streamnative/oxia">Oxia</a> åˆ™æ˜¯ StreamNative å¼€å‘çš„ä¸€ä¸ªç”¨äºæ›¿æ¢ Zookeeper çš„ä¸­é—´ä»¶ï¼ŒåŠŸèƒ½ä¹Ÿä¸ Zookeeper ç±»ä¼¼ï¼›ç›®å‰å·²ç»å¯ä»¥åœ¨ Pulsar ä¸­æ›¿æ¢ Zookeeperï¼Œåªæ˜¯è¿˜æ²¡æœ‰å¤§è§„æ¨¡çš„ä½¿ç”¨ã€‚</p><h1 id="Pulsar-ä¸­çš„åº”ç”¨"><a href="#Pulsar-ä¸­çš„åº”ç”¨" class="headerlink" title="Pulsar ä¸­çš„åº”ç”¨"></a>Pulsar ä¸­çš„åº”ç”¨</h1><p>ä¸‹é¢ä»¥ Pulsar ä¸ºä¾‹ï¼ˆä½¿ç”¨ zookeeperï¼‰ï¼Œçœ‹çœ‹åœ¨è¿™ç±»å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ˜¯å¦‚ä½•å¤„ç†è´Ÿè½½å‡è¡¡çš„ã€‚</p><p>å†å¼€å§‹ä¹‹å‰å…ˆæ˜ç¡®ä¸‹è´Ÿè½½å‡è¡¡å¤§ä½“ä¸Šä¼šåšå“ªäº›äº‹æƒ…ã€‚</p><ol><li>é¦–å…ˆä¸ŠæŠ¥è‡ªå·±èŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®</li><li>Leader èŠ‚ç‚¹éœ€è¦å®šæ—¶æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ã€‚<ol><li>è¿™äº›è´Ÿè½½æ•°æ®ä¸­åŒ…æ‹¬ï¼š<ol><li><code>CPU</code>ã€å †å†…å­˜ã€å †å¤–å†…å­˜ç­‰é€šç”¨æ•°æ®çš„ä½¿ç”¨é‡</li><li>æµå‡ºã€æµå…¥æµé‡</li><li>ä¸€äº›ç³»ç»Ÿç‰¹æœ‰çš„æ•°æ®ï¼Œæ¯”å¦‚åœ¨ <code>Pulsar</code> ä¸­å°±æ˜¯ï¼š<ol><li>æ¯ä¸ª <code>broker</code> ä¸­çš„ <code>topic</code>ã€<code>consumer</code>ã€<code>producer</code>ã€<code>bundle</code> ç­‰æ•°æ®ã€‚</li></ol></li></ol></li></ol></li><li>å†ç”± leader èŠ‚ç‚¹è¯»å–åˆ°è¿™äº›æ•°æ®åé€‰æ‹©è´Ÿè½½è¾ƒé«˜çš„èŠ‚ç‚¹ï¼Œå°†æ•°æ®è¿ç§»åˆ°è´Ÿè½½è¾ƒä½çš„èŠ‚ç‚¹ã€‚</li></ol><p>ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„è´Ÿè½½å‡è¡¡çš„æµç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬ä¾æ¬¡çœ‹çœ‹åœ¨ <code>Pulsar</code> ä¸­æ˜¯å¦‚ä½•å®ç°è¿™äº›é€»è¾‘çš„ã€‚</p><p>åœ¨ Pulsar ä¸­æä¾›äº†å¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä»¥ä¸‹æ˜¯åŠ è½½è´Ÿè½½å‡è¡¡å™¨çš„é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> LoadManager <span class="title function_">create</span><span class="params">(<span class="keyword">final</span> PulsarService pulsar)</span> &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServiceConfiguration</span> <span class="variable">conf</span> <span class="operator">=</span> pulsar.getConfiguration();  </span><br><span class="line">        <span class="comment">// Assume there is a constructor with one argument of PulsarService.  </span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">loadManagerInstance</span> <span class="operator">=</span> Reflections.createInstance(conf.getLoadManagerClassName(),  </span><br><span class="line">                Thread.currentThread().getContextClassLoader());  </span><br><span class="line">        <span class="keyword">if</span> (loadManagerInstance <span class="keyword">instanceof</span> LoadManager) &#123;  </span><br><span class="line">            <span class="keyword">final</span> <span class="type">LoadManager</span> <span class="variable">casted</span> <span class="operator">=</span> (LoadManager) loadManagerInstance;  </span><br><span class="line">            casted.initialize(pulsar);  </span><br><span class="line">            <span class="keyword">return</span> casted;  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loadManagerInstance <span class="keyword">instanceof</span> ModularLoadManager) &#123;  </span><br><span class="line">            <span class="keyword">final</span> <span class="type">LoadManager</span> <span class="variable">casted</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModularLoadManagerWrapper</span>((ModularLoadManager) loadManagerInstance);  </span><br><span class="line">            casted.initialize(pulsar);  </span><br><span class="line">            <span class="keyword">return</span> casted;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        LOG.warn(<span class="string">&quot;Error when trying to create load manager: &quot;</span>, e);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// If we failed to create a load manager, default to SimpleLoadManagerImpl.  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleLoadManagerImpl</span>(pulsar);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤ä½¿ç”¨çš„æ˜¯ <code>ModularLoadManagerImpl</code>ï¼Œ å¦‚æœå‡ºç°å¼‚å¸¸é‚£å°±ä¼šä½¿ç”¨ <code>SimpleLoadManagerImpl</code> ä½œä¸ºå…œåº•ã€‚</p><p>ä»–ä»¬ä¸¤ä¸ªçš„åŒºåˆ«æ˜¯ <code>ModularLoadManagerImpl</code> çš„åŠŸèƒ½æ›´å…¨ï¼Œå¯ä»¥åšæ›´ä¸ºç»†è‡´çš„è´Ÿè½½ç­–ç•¥ã€‚</p><p>æ¥ä¸‹æ¥ä»¥é»˜è®¤çš„ <code>ModularLoadManagerImpl</code> ä¸ºä¾‹è®²è§£ä¸Šè¿°çš„æµç¨‹ã€‚</p><h2 id="ä¸ŠæŠ¥è´Ÿè½½æ•°æ®"><a href="#ä¸ŠæŠ¥è´Ÿè½½æ•°æ®" class="headerlink" title="ä¸ŠæŠ¥è´Ÿè½½æ•°æ®"></a>ä¸ŠæŠ¥è´Ÿè½½æ•°æ®</h2><p>åœ¨è´Ÿè½½å‡è¡¡å™¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šæ”¶é›†èŠ‚ç‚¹æ•°æ®ç„¶åè¿›è¡Œä¸ŠæŠ¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> PulsarServerException &#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">         <span class="type">String</span> <span class="variable">brokerId</span> <span class="operator">=</span> pulsar.getBrokerId();</span><br><span class="line">         brokerZnodePath = LoadManager.LOADBALANCE_BROKERS_ROOT + <span class="string">&quot;/&quot;</span> + brokerId;</span><br><span class="line">         <span class="comment">// æ”¶é›†æœ¬åœ°è´Ÿè½½æ•°æ®</span></span><br><span class="line">         updateLocalBrokerData();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ŠæŠ¥ zookeeper</span></span><br><span class="line">         brokerDataLock = brokersData.acquireLock(brokerZnodePath, localData).join();</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         log.error(<span class="string">&quot;Unable to acquire lock for broker: [&#123;&#125;]&quot;</span>, brokerZnodePath, e);</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PulsarServerException</span>(e);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–åˆ°å½“å‰ broker çš„ Id ç„¶åæ‹¼æ¥ä¸€ä¸ª zookeeper èŠ‚ç‚¹çš„è·¯å¾„ï¼Œå°†ç”Ÿæˆçš„ localData ä¸Šä¼ åˆ° zookeeper ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// å­˜æ”¾ broker çš„èŠ‚ç‚¹ä¿¡æ¯</span><br><span class="line">ls /loadbalance/brokers</span><br><span class="line"></span><br><span class="line">[broker-1:8080, broker-2:8080]</span><br><span class="line"></span><br><span class="line">// æ ¹æ®èŠ‚ç‚¹ä¿¡æ¯æŸ¥è¯¢è´Ÿè½½æ•°æ®</span><br><span class="line">get /loadbalance/brokers/broker-1:8080</span><br></pre></td></tr></table></figure><p>ä¸ŠæŠ¥çš„æ•°æ®ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;webServiceUrl&quot;</span><span class="punctuation">:</span><span class="string">&quot;http://broker-1:8080&quot;</span><span class="punctuation">,</span><span class="attr">&quot;pulsarServiceUrl&quot;</span><span class="punctuation">:</span><span class="string">&quot;pulsar://broker-1:6650&quot;</span><span class="punctuation">,</span><span class="attr">&quot;persistentTopicsEnabled&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;nonPersistentTopicsEnabled&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;cpu&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span><span class="number">7.311714728372232</span><span class="punctuation">,</span><span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span><span class="number">800.0</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;memory&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span><span class="number">124.0</span><span class="punctuation">,</span><span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span><span class="number">2096.0</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;directMemory&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span><span class="number">36.0</span><span class="punctuation">,</span><span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span><span class="number">256.0</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;bandwidthIn&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span><span class="number">0.8324254085661579</span><span class="punctuation">,</span><span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span><span class="number">1.0E7</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;bandwidthOut&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span><span class="number">0.7155446715644209</span><span class="punctuation">,</span><span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span><span class="number">1.0E7</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;msgThroughputIn&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgThroughputOut&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgRateIn&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgRateOut&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;lastUpdate&quot;</span><span class="punctuation">:</span><span class="number">1690979816792</span><span class="punctuation">,</span><span class="attr">&quot;lastStats&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;my-tenant/my-namespace/0x4ccccccb_0x66666664&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;msgRateIn&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgThroughputIn&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgRateOut&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;msgThroughputOut&quot;</span><span class="punctuation">:</span><span class="number">0.0</span><span class="punctuation">,</span><span class="attr">&quot;consumerCount&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;producerCount&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;topics&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;cacheSize&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;numTopics&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;numBundles&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;numConsumers&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;numProducers&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;bundles&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;my-tenant/my-namespace/0x4ccccccb_0x66666664&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;lastBundleGains&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;lastBundleLosses&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;brokerVersionString&quot;</span><span class="punctuation">:</span><span class="string">&quot;3.1.0-SNAPSHOT&quot;</span><span class="punctuation">,</span><span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;advertisedListeners&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;internal&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;brokerServiceUrl&quot;</span><span class="punctuation">:</span><span class="string">&quot;pulsar://broker-1:6650&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;loadManagerClassName&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.pulsar.broker.loadbalance.impl.ModularLoadManagerImpl&quot;</span><span class="punctuation">,</span><span class="attr">&quot;startTimestamp&quot;</span><span class="punctuation">:</span><span class="number">1690940955211</span><span class="punctuation">,</span><span class="attr">&quot;maxResourceUsage&quot;</span><span class="punctuation">:</span><span class="number">0.140625</span><span class="punctuation">,</span><span class="attr">&quot;loadReportType&quot;</span><span class="punctuation">:</span><span class="string">&quot;LocalBrokerData&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="é‡‡é›†æ•°æ®"><a href="#é‡‡é›†æ•°æ®" class="headerlink" title="é‡‡é›†æ•°æ®"></a>é‡‡é›†æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SystemResourceUsage <span class="title function_">getSystemResourceUsage</span><span class="params">(<span class="keyword">final</span> BrokerHostUsage brokerHostUsage)</span> &#123;  </span><br><span class="line">    <span class="type">SystemResourceUsage</span> <span class="variable">systemResourceUsage</span> <span class="operator">=</span> brokerHostUsage.getBrokerHostUsage();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Override System memory usage and limit with JVM heap usage and limit  </span></span><br><span class="line">    <span class="type">double</span> <span class="variable">maxHeapMemoryInBytes</span> <span class="operator">=</span> Runtime.getRuntime().maxMemory();  </span><br><span class="line">    <span class="type">double</span> <span class="variable">memoryUsageInBytes</span> <span class="operator">=</span> Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();  </span><br><span class="line">    <span class="type">double</span> <span class="variable">memoryUsage</span> <span class="operator">=</span> memoryUsageInBytes / MIBI;  </span><br><span class="line">    <span class="type">double</span> <span class="variable">memoryLimit</span> <span class="operator">=</span> maxHeapMemoryInBytes / MIBI;  </span><br><span class="line">    systemResourceUsage.setMemory(<span class="keyword">new</span> <span class="title class_">ResourceUsage</span>(memoryUsage, memoryLimit));  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Collect JVM direct memory  </span></span><br><span class="line">    systemResourceUsage.setDirectMemory(<span class="keyword">new</span> <span class="title class_">ResourceUsage</span>((<span class="type">double</span>) (getJvmDirectMemoryUsed() / MIBI),  </span><br><span class="line">            (<span class="type">double</span>) (DirectMemoryUtils.jvmMaxDirectMemory() / MIBI)));  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> systemResourceUsage;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šåœ¨è¿è¡Œæ—¶è·å–ä¸€äº› JVM å’Œ å †å¤–å†…å­˜çš„æ•°æ®ã€‚</p><h2 id="æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹æ•°æ®"><a href="#æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹æ•°æ®" class="headerlink" title="æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹æ•°æ®"></a>æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹æ•°æ®</h2><p>ä½œä¸º <code>leader</code> èŠ‚ç‚¹è¿˜éœ€è¦æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼Œç„¶åæ ¹æ®ä¸€äº›è§„åˆ™é€‰æ‹©å°†è´Ÿè½½è¾ƒé«˜çš„èŠ‚ç‚¹ç§»åŠ¨åˆ°è´Ÿå€ºè¾ƒä½çš„èŠ‚ç‚¹ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateAllBrokerData</span><span class="params">()</span> &#123;</span><br><span class="line"> <span class="comment">// ä» zookeeper ä¸­è·å–æ‰€æœ‰èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Set&lt;String&gt; activeBrokers = getAvailableBrokers();</span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, BrokerData&gt; brokerDataMap = loadData.getBrokerData();</span><br><span class="line">    <span class="keyword">for</span> (String broker : activeBrokers) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s/%s&quot;</span>, LoadManager.LOADBALANCE_BROKERS_ROOT, broker);</span><br><span class="line">            <span class="comment">// ä¾æ¬¡è¯»å–å„ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®</span></span><br><span class="line">            Optional&lt;LocalBrokerData&gt; localData = brokersData.readLock(key).get();</span><br><span class="line">            <span class="keyword">if</span> (!localData.isPresent()) &#123;</span><br><span class="line">                brokerDataMap.remove(broker);</span><br><span class="line">                log.info(<span class="string">&quot;[&#123;&#125;] Broker load report is not present&quot;</span>, broker);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (brokerDataMap.containsKey(broker)) &#123;</span><br><span class="line">                <span class="comment">// Replace previous local broker data.</span></span><br><span class="line">                brokerDataMap.get(broker).setLocalData(localData.get());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Initialize BrokerData object for previously unseen</span></span><br><span class="line">                <span class="comment">// brokers.</span></span><br><span class="line">                <span class="comment">// å°†æ•°æ®å†™å…¥åˆ°æœ¬åœ°ç¼“å­˜</span></span><br><span class="line">                brokerDataMap.put(broker, <span class="keyword">new</span> <span class="title class_">BrokerData</span>(localData.get()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Error reading broker data from cache for broker - [&#123;&#125;], [&#123;&#125;]&quot;</span>, broker, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Remove obsolete brokers.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> String broker : brokerDataMap.keySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!activeBrokers.contains(broker)) &#123;</span><br><span class="line">            brokerDataMap.remove(broker);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šä» zookeeper çš„èŠ‚ç‚¹ä¸­è·å–åˆ°æ‰€æœ‰çš„ broker åˆ—è¡¨ï¼ˆbroker ä¼šåœ¨å¯åŠ¨æ—¶å°†è‡ªèº«çš„ä¿¡æ¯æ³¨å†Œåˆ° zookeeper ä¸­ã€‚ï¼‰</p><p>ç„¶åä¾æ¬¡è¯»å–å„è‡ªèŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼Œä¹Ÿå°±æ˜¯åœ¨è´Ÿè½½å‡è¡¡å™¨å¯åŠ¨çš„æ—¶å€™ä¸ŠæŠ¥çš„æ•°æ®ã€‚</p><h2 id="ç­›é€‰å‡ºæ‰€æœ‰-broker-ä¸­éœ€è¦-unload-çš„-bundle"><a href="#ç­›é€‰å‡ºæ‰€æœ‰-broker-ä¸­éœ€è¦-unload-çš„-bundle" class="headerlink" title="ç­›é€‰å‡ºæ‰€æœ‰ broker ä¸­éœ€è¦ unload çš„ bundle"></a>ç­›é€‰å‡ºæ‰€æœ‰ broker ä¸­éœ€è¦ unload çš„ bundle</h2><p>åœ¨ Pulsar ä¸­ topic æ˜¯æœ€æ ¸å¿ƒçš„æ¦‚å¿µï¼Œè€Œä¸ºäº†æ–¹ä¾¿ç®¡ç†å¤§é‡ topicï¼Œæå‡ºäº†ä¸€ä¸ª Bundle çš„æ¦‚å¿µï¼› Bundle æ˜¯ä¸€æ‰¹ topic çš„é›†åˆï¼Œç®¡ç† Bundle è‡ªç„¶ä¼šæ¯” topic æ›´ä½³å®¹æ˜“ã€‚</p><p>æ‰€ä»¥åœ¨ Pulsar ä¸­åšè´Ÿè½½å‡è¡¡æœ€ä¸»è¦çš„å°±æ˜¯å°†è´Ÿè½½è¾ƒé«˜èŠ‚ç‚¹ä¸­çš„ bundle è½¬ç§»åˆ°ä½è´Ÿè½½çš„ broker ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateAllBrokerData</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Set&lt;String&gt; activeBrokers = getAvailableBrokers();</span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, BrokerData&gt; brokerDataMap = loadData.getBrokerData();</span><br><span class="line">    <span class="keyword">for</span> (String broker : activeBrokers) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s/%s&quot;</span>, LoadManager.LOADBALANCE_BROKERS_ROOT, broker);</span><br><span class="line">            Optional&lt;LocalBrokerData&gt; localData = brokersData.readLock(key).get();</span><br><span class="line">            <span class="keyword">if</span> (!localData.isPresent()) &#123;</span><br><span class="line">                brokerDataMap.remove(broker);</span><br><span class="line">                log.info(<span class="string">&quot;[&#123;&#125;] Broker load report is not present&quot;</span>, broker);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (brokerDataMap.containsKey(broker)) &#123;</span><br><span class="line">                <span class="comment">// Replace previous local broker data.</span></span><br><span class="line">                brokerDataMap.get(broker).setLocalData(localData.get());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Initialize BrokerData object for previously unseen</span></span><br><span class="line">                <span class="comment">// brokers.</span></span><br><span class="line">                brokerDataMap.put(broker, <span class="keyword">new</span> <span class="title class_">BrokerData</span>(localData.get()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Error reading broker data from cache for broker - [&#123;&#125;], [&#123;&#125;]&quot;</span>, broker, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Remove obsolete brokers.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> String broker : brokerDataMap.keySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!activeBrokers.contains(broker)) &#123;</span><br><span class="line">            brokerDataMap.remove(broker);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è´Ÿè½½å‡è¡¡å™¨åœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šæŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®ï¼Œç„¶åå†™å…¥åˆ° <code>brokerDataMap</code> ä¸­ã€‚</p><p><img src="https://s2.loli.net/2024/06/12/ASoLedKVlgRbCFO.png"><br>åŒæ—¶ä¹Ÿä¼šæ³¨å†Œç›¸å…³çš„ zookeeper äº‹ä»¶ï¼Œå½“æ³¨å†Œçš„èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆä¸€èˆ¬æ˜¯æ–°å¢æˆ–è€…åˆ å‡äº† broker èŠ‚ç‚¹ï¼‰å°±ä¼šæ›´æ–°å†…å­˜ä¸­ç¼“å­˜çš„è´Ÿè½½æ•°æ®ã€‚</p><p>ä¹‹å leader èŠ‚ç‚¹ä¼šå®šæœŸè°ƒç”¨ <code>org.apache.pulsar.broker.loadbalance.impl.ModularLoadManagerImpl#doLoadShedding</code> å‡½æ•°æŸ¥è¯¢å“ªäº›æ•°æ®éœ€è¦å¸è½½ï¼Œç„¶åè¿›è¡Œé‡æ–°è´Ÿè½½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Multimap&lt;String, String&gt; bundlesToUnload = loadSheddingStrategy.findBundlesForUnloading(loadData, conf);</span><br></pre></td></tr></table></figure><p>æœ€æ ¸å¿ƒçš„å°±æ˜¯è°ƒç”¨è¿™ä¸ª <code>findBundlesForUnloading</code> å‡½æ•°ï¼Œä¼šè¿”å›éœ€è¦å¸è½½ bundle é›†åˆï¼Œæœ€ç»ˆä¼šéå†è¿™ä¸ªé›†åˆè°ƒç”¨ admin API è¿›è¡Œå¸è½½å’Œé‡å¹³è¡¡ã€‚</p><p>è€Œè¿™ä¸ªå‡½æ•°ä¼šæœ‰å¤šç§å®ç°ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æ ¹æ®ä¼ å…¥çš„å„ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼Œç„¶åæ ¹æ®è‡ªå®šä¹‰çš„è§„åˆ™è¿”å›ä¸€æ‰¹éœ€è¦å¸è½½çš„æ•°æ®ã€‚</p><p>ä»¥é»˜è®¤çš„ <code>org.apache.pulsar.broker.loadbalance.impl.ThresholdShedder</code> è§„åˆ™ä¸ºä¾‹ï¼š</p><p><img src="https://s2.loli.net/2024/06/12/hg751LtwZMrUyFb.png"><br>å®ƒæ˜¯æ ¹æ®å¸¦å®½ã€å†…å­˜ã€æµé‡ç­‰å„ä¸ªæŒ‡æ ‡çš„æƒé‡ç®—å‡ºæ¯ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½å€¼ï¼Œä¹‹åä¸ºæ•´ä¸ªé›†ç¾¤è®¡ç®—å‡ºä¸€ä¸ªå¹³å‡è´Ÿè½½å€¼ã€‚</p><p>ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼šè¶…è¿‡ <code>ShedBundles</code> çš„æ•°æ®å°±éœ€è¦è¢«å¸è½½æ‰ï¼Œç„¶åè½¬ç§»åˆ°ä½è´Ÿè½½çš„èŠ‚ç‚¹ä¸­ã€‚</p><p>æ‰€ä»¥æœ€å·¦è¾¹èŠ‚ç‚¹å’Œè¶…å‡ºçš„ bundle éƒ¨åˆ†å°±éœ€è¦è¢«è¿”å›ã€‚</p><p>å…·ä½“çš„è®¡ç®—é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">filterAndSelectBundle</span><span class="params">(LoadData loadData, Map&lt;String, Long&gt; recentlyUnloadedBundles, String broker,</span></span><br><span class="line"><span class="params">                                   LocalBrokerData localData, <span class="type">double</span> minimumThroughputToOffload)</span> &#123;</span><br><span class="line">    <span class="type">MutableDouble</span> <span class="variable">trafficMarkedToOffload</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutableDouble</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="type">MutableBoolean</span> <span class="variable">atLeastOneBundleSelected</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutableBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">    loadData.getBundleDataForLoadShedding().entrySet().stream()</span><br><span class="line">            .map((e) -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">bundle</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">                <span class="type">BundleData</span> <span class="variable">bundleData</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">                <span class="type">TimeAverageMessageData</span> <span class="variable">shortTermData</span> <span class="operator">=</span> bundleData.getShortTermData();</span><br><span class="line">                <span class="type">double</span> <span class="variable">throughput</span> <span class="operator">=</span> shortTermData.getMsgThroughputIn() + shortTermData.getMsgThroughputOut();</span><br><span class="line">                <span class="keyword">return</span> Pair.of(bundle, throughput);</span><br><span class="line">            &#125;).filter(e -&gt;</span><br><span class="line">                    !recentlyUnloadedBundles.containsKey(e.getLeft())</span><br><span class="line">            ).filter(e -&gt;</span><br><span class="line">                    localData.getBundles().contains(e.getLeft())</span><br><span class="line">            ).sorted((e1, e2) -&gt;</span><br><span class="line">                    Double.compare(e2.getRight(), e1.getRight())</span><br><span class="line">            ).forEach(e -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (trafficMarkedToOffload.doubleValue() &lt; minimumThroughputToOffload</span><br><span class="line">                        || atLeastOneBundleSelected.isFalse()) &#123;</span><br><span class="line">                    selectedBundlesCache.put(broker, e.getLeft());</span><br><span class="line">                    trafficMarkedToOffload.add(e.getRight());</span><br><span class="line">                    atLeastOneBundleSelected.setTrue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç é‡Œçœ‹çš„å‡ºæ¥å°±æ˜¯åœ¨ä¸€ä¸ªå¤‡é€‰é›†åˆä¸­æ ¹æ®å„ç§é˜ˆå€¼å’Œåˆ¤æ–­æ¡ä»¶ç­›é€‰å‡ºéœ€è¦å¸è½½çš„ bundleã€‚</p><hr><p>è€Œ <code>SimpleLoadManagerImpl</code> çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (currentLoadReports) &#123;</span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;ResourceUnit, LoadReport&gt; entry : currentLoadReports.entrySet()) &#123;</span><br><span class="line"><span class="type">ResourceUnit</span> <span class="variable">overloadedRU</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line"><span class="type">LoadReport</span> <span class="variable">lr</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line"><span class="comment">// æ‰€æœ‰æ•°æ®åšä¸€ä¸ªç®€å•çš„ç­›é€‰ï¼Œè¶…è¿‡é˜ˆå€¼çš„æ•°æ®éœ€è¦è¢« unload</span></span><br><span class="line"><span class="keyword">if</span> (isAboveLoadLevel(lr.getSystemResourceUsage(), overloadThreshold)) &#123;</span><br><span class="line"><span class="type">ResourceType</span> <span class="variable">bottleneckResourceType</span> <span class="operator">=</span> lr.getBottleneckResourceType();</span><br><span class="line">Map&lt;String, NamespaceBundleStats&gt; bundleStats = lr.getSortedBundleStats(bottleneckResourceType);</span><br><span class="line"><span class="keyword">if</span> (bundleStats == <span class="literal">null</span>) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Null bundle stats for bundle &#123;&#125;&quot;</span>, lr.getName());</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯å¾ˆç®€å•çš„é€šè¿‡å°†åˆ¤æ–­èŠ‚ç‚¹çš„è´Ÿè½½æ˜¯å¦è¶…è¿‡äº†é˜ˆå€¼ <code>isAboveLoadLevel</code>ï¼Œç„¶ååšä¸€ä¸ªç®€å•çš„æ’åºå°±è¿”å›äº†ã€‚</p><p>ä»è¿™é‡Œä¹Ÿçœ‹å¾—å‡ºæ¥ <code>SimpleLoadManagerImpl</code> å’Œ <code>ModularLoadManager</code> çš„åŒºåˆ«ï¼Œ<code>SimpleLoadManagerImpl</code> æ›´ç®€å•ï¼Œå¹¶æ²¡æœ‰æä¾›å¤šä¸ª <code>doLoadShedding</code> çš„ç­›é€‰å®ç°ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ€»çš„æ¥è¯´å¯¹äºæ— çŠ¶æ€çš„æœåŠ¡æ¥è¯´ï¼Œç†è®ºä¸Šæˆ‘ä»¬åªéœ€è¦åšå¥½è´Ÿè½½ç®—æ³•å³å¯ï¼ˆè½®è®­ã€ä¸€è‡´æ€§å“ˆå¸Œã€ä½è´Ÿè½½ä¼˜å…ˆç­‰ï¼‰å°±å¯ä»¥å¾ˆå¥½çš„å¹³è¡¡å„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è´Ÿè½½ã€‚</p><p>è€Œå¯¹äºæœ‰çŠ¶æ€çš„æœåŠ¡æ¥è¯´ï¼Œè´Ÿè½½å‡è¡¡å°±æ˜¯å°†è´Ÿè½½è¾ƒé«˜èŠ‚ç‚¹ä¸­çš„æ•°æ®è½¬ç§»åˆ°è´Ÿè½½ä½çš„èŠ‚ç‚¹ä¸­ã€‚</p><p>å…¶ä¸­çš„å…³é”®å°±æ˜¯éœ€è¦å­˜å‚¨å„ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½æ•°æ®ï¼ˆä¸šç•Œå¸¸ç”¨çš„æ˜¯å­˜å‚¨åˆ° zookeeper ä¸­ï¼‰ï¼Œç„¶åå†ç”±ä¸€ä¸ª leader èŠ‚ç‚¹ä»è¿™äº›èŠ‚ç‚¹ä¸­æ ¹æ®æŸç§è´Ÿè½½ç®—æ³•é€‰æ‹©å‡ºè´Ÿè½½è¾ƒé«˜çš„èŠ‚ç‚¹ä»¥åŠè´Ÿè½½è¾ƒä½çš„èŠ‚ç‚¹ï¼Œæœ€ç»ˆæŠŠæ•°æ®è¿ç§»è¿‡å»å³å¯ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;Pulsar æœ‰æä¾›ä¸€ä¸ªæŸ¥è¯¢ Broker è´Ÿè½½çš„æ¥å£ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     * Get load for this broker.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     *&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     * &lt;span class=&quot;doctag&quot;&gt;@return&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     * &lt;span class=&quot;doctag&quot;&gt;@throws&lt;/span&gt; PulsarAdminException&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LoadManagerReport &lt;span class=&quot;title function_&quot;&gt;getLoadReport&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; PulsarAdminException;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;LoadManagerReport&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;ServiceLookupData&lt;/span&gt; &amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ResourceUsage &lt;span class=&quot;title function_&quot;&gt;getCpu&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ResourceUsage &lt;span class=&quot;title function_&quot;&gt;getMemory&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ResourceUsage &lt;span class=&quot;title function_&quot;&gt;getDirectMemory&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ResourceUsage &lt;span class=&quot;title function_&quot;&gt;getBandwidthIn&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ResourceUsage &lt;span class=&quot;title function_&quot;&gt;getBandwidthOut&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;å¯ä»¥è¿”å›ä¸€äº› broker çš„è´Ÿè½½æ•°æ®ï¼Œæ¯”å¦‚ CPUã€å†…å­˜ã€æµé‡ä¹‹ç±»çš„æ•°æ®ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="Pulsar" scheme="http://crossoverjie.top/categories/OB/Pulsar/"/>
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/tags/Pulsar/"/>
    
  </entry>
  
  <entry>
    <title>ğŸ‰æˆ‘æ˜¯å¦‚ä½•ä»é›¶åˆ°æˆä¸º Apache é¡¶çº§é¡¹ç›®çš„ Committer</title>
    <link href="http://crossoverjie.top/2024/07/11/ob/%F0%9F%8E%89how-to-be-committer/"/>
    <id>http://crossoverjie.top/2024/07/11/ob/%F0%9F%8E%89how-to-be-committer/</id>
    <published>2024-07-11T15:45:32.000Z</published>
    <updated>2024-07-11T15:46:29.320Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2024/07/07/bj8NHqYFegTx1WU.png" alt="image.png"><br><img src="https://s2.loli.net/2024/07/07/a86fbuopri9mDeS.png"></p><p>æœ€è¿‘æ”¶åˆ°äº† <a href="https://github.com/apache/pulsar/">Apache Pulsar</a> å’Œ <a href="https://github.com/apache/hertzbeat/">Apache HertzBeat</a>ç¤¾åŒºçš„é‚€è¯·é‚®ä»¶ï¼Œæˆä¸ºäº†è¿™ä¸¤ä¸ªé¡¹ç›®çš„ <code>Committer</code>ã€‚</p><span id="more"></span><p>ä¸€è·¯èµ°æ¥æˆ‘ä»æœ€å¼€å§‹çš„æ‰“æ¸¸å‡»æˆ˜çš„é—²æ•£äººå‘˜åˆ°å¦‚ä»Šæ´»è·ƒåœ¨å„ä¸ªå¼€æºé¡¹ç›®é‡Œçš„â€œè€å…µâ€ï¼Œç”¨ç°åœ¨æµè¡Œçš„è¯æ¥è¯´ <code>Apache</code> çš„è¿™ä¸¤ä¸ª <code>Committer</code> å°±ç›¸å½“äºæ˜¯æ‹¿åˆ°äº†ç¼–åˆ¶ï¼Œè¿›å…¥äº†æ­£è§„å†›ã€‚</p><p>ä¸‹é¢å°±åˆ†äº«ä¸€ä¸‹æˆ‘çš„ä¸ªäººå¼€æºç»å†ï¼Œå¸Œæœ›å¯¹æƒ³è¦å‚ä¸å¼€æºæˆ–è€…å·²ç»åœ¨å…¶ä¸­çš„å¼€å‘è€…æœ‰æ‰€å¸®åŠ©ã€‚</p><h1 id="æˆ‘çš„-GitHub-å¼€æºæ•…äº‹"><a href="#æˆ‘çš„-GitHub-å¼€æºæ•…äº‹" class="headerlink" title="æˆ‘çš„ GitHub å¼€æºæ•…äº‹"></a>æˆ‘çš„ GitHub å¼€æºæ•…äº‹</h1><h2 id="åˆè¯†-GitHub"><a href="#åˆè¯†-GitHub" class="headerlink" title="åˆè¯† GitHub"></a>åˆè¯† GitHub</h2><p><img src="https://s2.loli.net/2024/07/08/CylX9TKcQY12MWI.png"><br>æˆ‘è¿™ä¸ª <code>Github</code> è´¦å·æ˜¯åœ¨ 15 å¹´ 9æœˆä»½æ³¨å†Œçš„ï¼Œé‚£æ—¶å€™åˆšå‡ºæ¥å‚ä¸å·¥ä½œã€‚</p><p>å…¶å®åœ¨è¿™ä¹‹å‰æˆ‘å‹æ ¹æ²¡æœ‰å¬è¯´è¿‡ GitHubã€å¯¹å¼€æºä¹Ÿæ˜¯çŸ¥ä¹‹ç”šå°‘ï¼›åªæ˜¯çŸ¥é“è€å¸ˆå’ŒåŒäº‹ç»å¸¸è®©æˆ‘åœ¨ç½‘ä¸Šå¯ä»¥ä¸‹è½½åˆ°ä¸€äº›ç¬¬ä¸‰æ–¹åŒ…ï¼ˆç°åœ¨å›æƒ³èµ·æ¥å‡ ä¹éƒ½æ˜¯å¥½ Apache çš„æä¾›çš„åŒ…ï¼‰æ¥è§£å†³æ—¥å¸¸çš„ä¸€äº›å¸¸è§éœ€æ±‚ã€‚</p><p>å½“æ—¶åªæ˜¯è§‰å¾—éå¸¸æ–¹ä¾¿ï¼Œæ²¡æƒ³åˆ°å¤§éƒ¨åˆ†çš„å·¥ä½œäº’è”ç½‘ä¸Šéƒ½æœ‰ç›¸å…³çš„è§£å†³æ–¹æ¡ˆã€‚</p><p>ç›´åˆ°ç¬¬äºŒå¹´ä¹Ÿå°±æ˜¯ 16 å¹´æˆ‘æ‰æäº¤ç¬¬ä¸€è¡Œä»£ç ï¼Œè®°å¾—å½“æ—¶æ˜¯éœ€è¦å’ŒåŒå­¦å…±äº«ä¸€äº›ä»£ç ã€‚</p><p>åœ¨å­¦æ ¡çš„æ—¶å€™å¤§å®¶éƒ½æ˜¯æŠŠæ–‡ä»¶æ‰“åŒ…ç„¶åé€šè¿‡ QQ å‘é€çš„ï¼Œå› ä¸ºæˆ‘ä¹‹å‰åœ¨ GitHub ä¸Šçœ‹åˆ°å¤§å®¶éƒ½æ˜¯æŠŠæºç å…¬å¼€çš„ï¼Œæ‰€ä»¥å½“æ—¶çš„æƒ³æ³•æ˜¯ä¸æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨ GitHub æŠŠä»£ç å‘ç»™åŒå­¦ï¼Œè¿™æ ·å°±çœå»äº†æ‰“åŒ…è§£å‹çš„æ­¥éª¤äº†ã€‚</p><blockquote><p>ç°åœ¨æƒ³æƒ³è¿˜å¥½éƒ½æ˜¯ä¸€äº›éä¸šåŠ¡ä»£ç ï¼Œä¸ç„¶å°±è¿åå…¬å¸å®‰å…¨è§„å®šäº†ã€‚</p></blockquote><p>æ‰€ä»¥å…¶å®è‡ªå·±æ²¡æœ‰ä»»ä½•å¼€æºçš„æ¦‚å¿µï¼Œåªæ˜¯è§‰å¾—åˆ†äº«ä»£ç å¾ˆæ–¹ä¾¿ã€‚</p><p>åç»­åœ¨ç½‘ä¸Šçœ‹äº† <code>RichardÂ Matthew Stallman</code> å‘èµ·çš„<a href="https://zh.wikipedia.org/zh-hans/%E8%87%AA%E7%94%B1%E8%BD%AF%E4%BB%B6%E8%BF%90%E5%8A%A8">è‡ªç”±è½¯ä»¶è¿åŠ¨</a>æ‰å¯¹å¼€æºçš„ç”±æ¥æœ‰äº†æ›´å¤šçš„è®¤è¯†ï¼Œä¹Ÿè¶Šå‘ä½©æœè¿™äº›å‚ä¸å¼€æºçš„å¤§ä½¬ä»¬ã€‚</p><h2 id="æ‰˜ç®¡-Blog"><a href="#æ‰˜ç®¡-Blog" class="headerlink" title="æ‰˜ç®¡ Blog"></a>æ‰˜ç®¡ Blog</h2><p><img src="https://s2.loli.net/2024/07/08/zhYcH9RmxkpWEA2.png" alt="image.png"><br><img src="https://s2.loli.net/2024/07/08/Cv86gmrlhxoDqBK.png" alt="image.png"></p><p>å½“æ—¶è¿˜éå¸¸æµè¡Œåœ¨ GitHub ä¸Šæ­å»ºä¸ªäººåšå®¢ï¼Œæˆ‘è‡ªç„¶ä¹Ÿè·Ÿä¸Šäº†è¿™ä¸ªæ½®æµï¼›ç›´åˆ°ç°åœ¨ä¹Ÿæ²¡æœ‰æ–­æ›´ã€‚<br>é™†ç»­å†™äº† 240+ ç¯‡åšå®¢ã€‚</p><blockquote><p>è®°å¾—å½“æ—¶æœ€å–œæ¬¢å¹²çš„äº‹å°±æ˜¯æŠ˜è…¾å„ç§ä¸»é¢˜ï¼Œå¯ä»¥åœ¨ GitHub å…è´¹æ‰˜ç®¡ä¸€ä¸ªåšå®¢ï¼Œå¯¹å½“æ—¶çš„æˆ‘ä¹Ÿæ˜¯éœ‡æ’¼è›®å¤§çš„ã€‚</p></blockquote><p>å…³äºåšå®¢çš„è¯é¢˜è¿˜æœ‰ä¸å°‘å†…å®¹å¯ä»¥è®²ï¼Œæ”¾åˆ°åé¢ç»§ç»­åˆ†äº«ã€‚</p><h2 id="æäº¤ç¬¬ä¸€ä¸ªé¡¹ç›®"><a href="#æäº¤ç¬¬ä¸€ä¸ªé¡¹ç›®" class="headerlink" title="æäº¤ç¬¬ä¸€ä¸ªé¡¹ç›®"></a>æäº¤ç¬¬ä¸€ä¸ªé¡¹ç›®</h2><p><img src="https://s2.loli.net/2024/07/08/NtExsU8Z2ryWdzT.png"><br>å› ä¸ºå½“æ—¶åœ¨å…¬å¸åˆšå¼€å§‹æ¥è§¦åˆ° SSM(spring+springmvc+mybatis)ï¼Œæ‰€ä»¥å°±æƒ³æŠŠæ—¥å¸¸å­¦åˆ°çš„ä¸œè¥¿æ²‰æ·€ä¸‹æ¥ã€‚</p><p>äºæ˜¯å°±æŠŠä¸€äº›éä¸šåŠ¡ä»£ç æ•´ç†åæäº¤äº†ç¬¬ä¸€ä¸ªé¡¹ç›®ï¼Œä»¥æ›´æ–°åšå®¢çš„æ–¹å¼é™†ç»­æ›´æ–°äº†å„ç§è§£å†³æ–¹æ¡ˆï¼š<br><img src="https://s2.loli.net/2024/07/08/BITYfjNS7oaEpJl.png"><br>è‡³ä»Šå·²ç»å…¨éƒ¨æ›´æ–°å®Œæ¯•ï¼Œæ‰€ä»¥æˆ‘å°±å°†å®ƒå½’æ¡£äº†ã€‚</p><p>è¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ­£å„¿å…«ç»åšå¼€æºé¡¹ç›®ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿç»“å®åˆ°äº†ä¸å°‘æœ‹å‹ï¼Œæ²‰æ·€äº†è®¸å¤šå†…å®¹ï¼›å¯¹äºåˆšå·¥ä½œä¸€ä¸¤å¹´çš„æˆ‘æ¥è¯´æ„ä¹‰è¿˜æ˜¯å¾ˆé‡å¤§çš„ã€‚</p><h1 id="å‚ä¸æ­£è§„å†›-Apache"><a href="#å‚ä¸æ­£è§„å†›-Apache" class="headerlink" title="å‚ä¸æ­£è§„å†›(Apache)"></a>å‚ä¸æ­£è§„å†›(Apache)</h1><p>æ—¶é—´ç‚¹å›åˆ°ç°åœ¨ï¼Œå› ä¸ºå·¥ä½œåŸå› æˆ‘éœ€è¦åœ¨å…¬å¸å†…éƒ¨ç»´æŠ¤ Pulsar æ¶ˆæ¯é˜Ÿåˆ—ï¼›å½“æ—¶ Pulsar åœ¨å…¬å¸è¿˜æœ‰ç€ä¸€äº›ç»†ææœ«èŠ‚çš„é—®é¢˜éœ€è¦è§£å†³ã€‚</p><p>åœ¨è§£å†³è¿™äº›é—®é¢˜çš„è¿‡ç¨‹ä¸­å°±æƒ³ç€çœ‹èƒ½ä¸èƒ½ç»™ç¤¾åŒºè´¡çŒ®äº›ä»£ç ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æ›´ç†Ÿæ‚‰æ•´ä¸ªé¡¹ç›®ã€‚</p><blockquote><p>å…¶å® 20 å¹´å·¦å³åœ¨ä¹‹å‰çš„å…¬å¸å°±æœ‰ä½¿ç”¨ Pulsarï¼Œåªæ˜¯å½“æ—¶è¿˜æ²¡æœ‰æ„è¯†åˆ°è¦å‘ç¤¾åŒºè´¡çŒ®ä»£ç ã€‚</p></blockquote><p>äºæ˜¯æˆ‘å…ˆå°è¯•åšä¸€äº›æ— å…³ç´§è¦çš„ä¿®æ”¹ï¼š<br><img src="https://s2.loli.net/2024/07/08/WLkOP5KhvBHmg7E.png"><br>å› ä¸ºè¿™ä¸ªè¿˜è¢«å¤§ä½¬æ‹’è¿‡å‡ ä¸ª PRï¼Œä¸æ­¤åŒæ—¶æˆ‘ä¹Ÿåœ¨æŒç»­è¾“å‡ºä¸€ä¸ª Pulsar ç›¸å…³çš„åšå®¢ï¼Œå½“æ—¶ä¹Ÿå¾—åˆ°äº†å¤§ä½¬çš„è®¤å¯ï¼š<br><img src="https://s2.loli.net/2024/07/08/spUaV8yPZMYbHAe.png"></p><p>ä¹‹åæˆ‘åˆæ ¹æ®æ—¥å¸¸å·¥ä½œä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜æˆ–è€…ä¼˜åŒ–æŒç»­ç»™ç¤¾åŒºæäº¤ PRï¼š<br><img src="https://s2.loli.net/2024/07/08/LPQ2RSHNotfJclY.png"></p><p>è¿™ä¸ªè¿‡ç¨‹ä»ç¬¬ä¸€ä¸ª PR åˆ°ç¤¾åŒºå¤§ä½¬æåæˆ‘å¤§æ¦‚ç»å†äº†ä¸€å¹´åŠçš„æ—¶é—´ã€‚</p><p>è¶Šå¤§å‹ã€ä¸¥è°¨çš„é¡¹ç›®åœ¨å¤„ç†è¿™äº› PR æ—¶å°±æ˜¯ç¼“æ…¢çš„ï¼Œæ‰€ä»¥å¦‚æœä½ çœŸçš„æƒ³æ·±åº¦å‚ä¸æŸä¸ªé¡¹ç›®æ—¶å°±ä¸€å®šè¦æœ‰å……åˆ†çš„è€å¿ƒã€‚</p><p>é¦–å…ˆåšæŒä¸‹å»ï¼Œæ”¶è·è‡ªç„¶å°±æ¥äº†ã€‚</p><hr><h3 id="Apache-HertzBeat"><a href="#Apache-HertzBeat" class="headerlink" title="Apache HertzBeat"></a>Apache HertzBeat</h3><p>ä»Šå¹´å››æœˆä»½çš„æ—¶å€™æˆ‘åœ¨æœ‹å‹åœˆè¿˜çœ‹åˆ°å¦å¤–ä¸€ä¸ªé¡¹ç›®ï¼š<a href="https://github.com/apache/hertzbeat">Apache HertzBeat</a>ã€‚</p><p>å› ä¸ºå½“æ—¶æˆ‘ä¹Ÿåœ¨åšä¸€äº›å¯è§‚æµ‹æ€§çš„å†…å®¹ï¼Œæ­£å¥½è¿™ä¸ªé¡¹ç›®æ˜¯å’Œç›‘æ§ç›¸å…³çš„ï¼›äºæ˜¯æˆ‘å°±è·Ÿç€æ–‡æ¡£èµ°äº†ä¸€éã€‚</p><p>å‘ç°åŠŸèƒ½å¾ˆå¼ºä¹Ÿå¾ˆå…¨ï¼Œå½“æ—¶ä¹Ÿæ˜¯åˆšåŠ å…¥ Apache çš„å­µåŒ–å™¨ï¼Œæ‰€ä»¥è¿˜æ˜¯æœ‰è®¸å¤šå¯ä»¥å®Œå–„çš„åœ°æ–¹ã€‚</p><p>æˆ‘å°±å¼€å§‹ä»¥å•æµ‹ä½œä¸ºåˆ‡å…¥ç‚¹å°è¯•è´¡çŒ®æºç ï¼Œç¤¾åŒºçš„å“åº”é€Ÿåº¦ä¹Ÿéå¸¸å¿«ã€‚</p><p>ä¹‹åé€æ¸å°†æˆ‘åœ¨å…¶ä»–ç¤¾åŒºå­¦åˆ°ä¸€äº›ç»éªŒä¹Ÿå¤åˆ¶åˆ° HertzBeat ä¸­ï¼Œæ…¢æ…¢çš„è´¡çŒ®çš„ä»£ç è¶Šå¤šï¼Œå¯¹ HertzBeat ä¹Ÿå°±æ›´åŠ ç†Ÿæ‚‰äº†ã€‚</p><p>ä¸¤ä¸ªå¤šæœˆçš„æ—¶é—´æˆ‘è´¡çŒ®äº† 30 ä¸ªå·¦å³çš„ PRï¼Œåæ¥ä¹Ÿå—åˆ°é¡¹ç›®å‘èµ·è€…çš„é‚€è¯·ï¼š<br><img src="https://s2.loli.net/2024/07/08/L9SI6rO17TxkDaH.png" alt="image.png"></p><p>å› ä¸ºæ˜¯ç›¸å¯¹æ›´å¹´è½»çš„é¡¹ç›®ï¼Œæ‰æ›´éœ€è¦å¤§å®¶ç¾¤ç­–ç¾¤åŠ›ï¼›æ‰€ä»¥å¦‚æœä½ ä¹Ÿå¯¹ç›‘æ§ç³»ç»Ÿæ„Ÿå…´è¶£ï¼Œæˆ–è€…æ¯”è¾ƒç†Ÿæ‚‰å‰ç«¯æŠ€æœ¯æ ˆï¼ˆHertzBeat æœ‰åå°ç®¡ç†ç•Œé¢ï¼‰éƒ½æ¬¢è¿å‰æ¥è´¡çŒ®ï¼Œåç»­è·å¾—æåçš„æœºä¼šè¦æ¯”å·²ç»å‘å±•ç¨³å®šçš„é¡¹ç›®æ›´å¤§ä¸€äº›ã€‚</p><h1 id="æˆä¸º-Committer-çš„å¥½å¤„"><a href="#æˆä¸º-Committer-çš„å¥½å¤„" class="headerlink" title="æˆä¸º Committer çš„å¥½å¤„"></a>æˆä¸º Committer çš„å¥½å¤„</h1><p>è®²åˆ°è¿™é‡Œé¡ºä¾¿å†è®²è®²æˆä¸º  Committer çš„ä¸€äº›å¥½å¤„äº†ï¼Œè™½ç„¶å¼€æºç»å¸¸å’Œå…è´¹ç™½å«–åˆ’ç­‰å·ï¼Œå¤§éƒ¨åˆ†äººéƒ½æ˜¯ç”¨çˆ±å‘ç”µçš„ï¼Œä½†å› ä¸ºä¹Ÿæœ‰è®¸å¤šå¤§å…¬å¸å¾—åˆ°äº†å¼€æºçš„å¥½å¤„ï¼Œæ‰€ä»¥ä¹Ÿç»™æ´»è·ƒåœ¨ç¤¾åŒºé‡Œçš„è´¡çŒ®è€…æä¾›äº†ä¸€äº›å…è´¹ç¦åˆ©ã€‚</p><p>å½“ç„¶è¦æ‹¿åˆ°è¿™äº›ç¦åˆ©è‚¯å®šæ˜¯å¾—æœ‰ä¸€ä¸ªè¯„åˆ¤æ ‡å‡†ï¼Œæœ€ç®€å•ä¹Ÿæœ€ç›´è§‚çš„å°±æ˜¯ä½ æ˜¯å¦å·²ç»æ˜¯ Apache ç»„ç»‡çš„ Committerã€‚</p><h2 id="Github-Copilot"><a href="#Github-Copilot" class="headerlink" title="Github Copilot"></a>Github Copilot</h2><p>é¦–å…ˆç¬¬ä¸€ä¸ªå¥½å¤„æ˜¯æä¾›å…è´¹ä¸ªäººä½¿ç”¨ Copilotï¼Œå½“ç„¶è¿™ä¸å…¨æ˜¯ Committer çš„æƒç›Šï¼Œå¦‚æœä½ æ˜¯æŸä¸ªå¼€æºé¡¹ç›®çš„æ´»è·ƒè´¡çŒ®è€…ä¹Ÿæ˜¯å¯ä»¥ç”³è¯·çš„ï¼ˆä¸ä¸€å®šèƒ½ç”³è¯·è¿‡ï¼Œç›®å‰å¥½åƒæ²¡çœ‹åˆ°é€šè¿‡çš„æ ‡å‡†ï¼‰ï¼Œåªæ˜¯å·²ç»æ˜¯ Committer åè‚¯å®šæ˜¯èƒ½äº«å—è¿™ä¸ªæƒç›Šã€‚</p><h2 id="Jetbrains-å…¨å®¶æ¡¶-IDE"><a href="#Jetbrains-å…¨å®¶æ¡¶-IDE" class="headerlink" title="Jetbrains å…¨å®¶æ¡¶ IDE"></a>Jetbrains å…¨å®¶æ¡¶ IDE</h2><p><img src="https://s2.loli.net/2024/07/08/kc9Ovp1u7M4DxWE.png"></p><p>JB ä½œä¸ºä¸€ä¸ªå’Œå¼€å‘è€…å¼ºç»‘å®šçš„å…¬å¸ï¼Œä¹Ÿæä¾›äº†å¯¹åº”çš„ç¦åˆ©ï¼Œåªè¦ä½¿ç”¨ Apache çš„é‚®ç®±å°±å¯ä»¥å…è´¹ä½¿ç”¨ä»–ä»¬çš„å…¨å®¶æ¡¶ã€‚</p><h2 id="Apache-é‚®ç®±"><a href="#Apache-é‚®ç®±" class="headerlink" title="Apache é‚®ç®±"></a>Apache é‚®ç®±</h2><p>æåˆ°äº†é‚®ç®±é‚£å°±ä¸å¾—ä¸æåˆ° Apache ç»™æ¯ä¸ª Committer éƒ½ä¼šæä¾›ä¸€ä¸ªä¸“å±é‚®ç®±ï¼š<br><img src="https://s2.loli.net/2024/07/08/TQVkIhbUcAtpfCX.png"><br>è™½ç„¶å¸‚é¢ä¸Šæœ‰å„ç§çš„å…è´¹é‚®ç®±æ³¨å†ŒæœåŠ¡ï¼Œä½†å½“ä½ ä½¿ç”¨ Apache çš„é‚®ç®±å’Œå…¶ä»–äººæ²Ÿé€šäº¤æµæ—¶ï¼Œå¤§æ¦‚ç‡å¯¹æ–¹æ½œæ„è¯†é‡Œéƒ½ä¼šå¯¹ä½ é«˜çœ‹ä¸€ç‚¹ã€‚</p><p>è¿™è™½ç„¶æ˜¯ä¸€äº›è™šæ— ç¼¥ç¼ˆçš„ä¸œè¥¿ï¼Œä½†æœ‰æ—¶å€™å°±æ˜¯ä¼šè®©æ²Ÿé€šæ›´åŠ é¡ºç•…ï¼ˆæ¯”å¦‚æ±‚èŒé¢è¯•æ—¶ï¼‰ã€‚</p><h2 id="é¡¹ç›®çš„å†™æƒé™"><a href="#é¡¹ç›®çš„å†™æƒé™" class="headerlink" title="é¡¹ç›®çš„å†™æƒé™"></a>é¡¹ç›®çš„å†™æƒé™</h2><p>è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯æœ‰äº†é¡¹ç›®çš„å†™æƒé™ï¼Œå½“ä½ å‚ä¸è¿‡å¼€æºé¡¹ç›®å°±çŸ¥é“è¿™ä¸ªçš„é‡è¦æ€§äº†ï¼Œæœ‰äº›æ—¶å€™ä¸€äº› PR è¿Ÿè¿Ÿå¾—ä¸åˆ°å›å¤å’Œåˆå¹¶ï¼Œè‡ªå·±åªèƒ½å¹²ç€æ€¥ã€‚</p><p>æœ‰äº†è¿™ä¸ªæƒé™ä¹‹åï¼Œåªè¦ä½ çš„ PR æœ‰äºº <code>Approve</code> ä¹‹åï¼Œåœ¨é£é™©å¯æ§çš„æƒ…å†µä¸‹ä¸ç”¨ç­‰ç€ maintainer æ¥åˆå¹¶ï¼Œè‡ªå·±å°±å¯ä»¥æ“ä½œã€‚</p><p>åŒæ—¶å¾—ç›Šäºåœ¨ç¤¾åŒºçš„æ´»è·ƒç¨‹åº¦ï¼Œä½ å†æäº¤åˆ° PR ä¼šæ›´å¾—åˆ°é‡è§†ï¼ŒåŒæ—¶ä¹Ÿèƒ½æ›´å¥½çš„æ¨è¿›æŸäº› featureï¼›è¿™å¯¹äºä¾èµ–æŸä¸ªå¼€æºé¡¹ç›®çš„å…¬å¸æ¥è¯´å—ç›Šéå¸¸å¤§ã€‚</p><h1 id="Apache-è´¡çŒ®é˜¶æ¢¯"><a href="#Apache-è´¡çŒ®é˜¶æ¢¯" class="headerlink" title="Apache è´¡çŒ®é˜¶æ¢¯"></a>Apache è´¡çŒ®é˜¶æ¢¯</h1><p>ç›¸ä¿¡çœ‹åˆ°è¿™é‡Œåº”è¯¥æœ‰ä¸å°‘äººå¯¹æˆä¸º Apache Committer æ„Ÿå…´è¶£äº†ï¼Œä¹Ÿæ¯”è¾ƒå¥½å¥‡ä»€ä¹ˆæ ·çš„æ ‡å‡†æ‰èƒ½æˆä¸º Committerã€‚</p><p>ä»¥ä¸‹æ˜¯æˆ‘æ ¹æ®ä¸€äº›å·²ç»æ˜¯ Committer çš„å¤§ä½¬å’Œ Apache å®˜æ–¹ç»™çš„ä¸€ä¸ªè´¡çŒ®é˜¶æ¢¯ä½œä¸ºå‚è€ƒæ€»ç»“å‡ºæ¥çš„ã€‚</p><p><img src="https://s2.loli.net/2024/07/08/tlEuhMR85AmLasn.png"></p><p>å‚ä¸å¼€æºçš„äººä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§è§’è‰²ï¼š</p><ul><li>æ™®é€šç”¨æˆ·</li><li>è´¡çŒ®è€…</li><li>Committer</li><li>PMC é¡¹ç›®ç®¡ç†äººå‘˜</li><li>åŸºé‡‘ä¼šç®¡ç†äººå‘˜</li><li>åŸºé‡‘ä¼šè‘£äº‹</li></ul><p>æ•´ä¸ªè·¯å¾„è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œåªæ˜¯ä» PMC å¼€å§‹åˆ°åé¢çš„è‘£äº‹éš¾åº¦éƒ½æ˜¯æŒ‡æ•°çº§å¢åŠ ã€‚</p><blockquote><p>ç›®å‰æ•´ä¸ªå›½å†…å½“é€‰è¿‡è‘£äº‹çš„éƒ½æ˜¯å±ˆæŒ‡å¯æ•°ã€‚</p></blockquote><p>è€Œå…³äºæˆä¸º Committer çš„è¦æ±‚æŸäº›ç¤¾åŒºä¼šæœ‰æ˜æ˜¾çš„æ ‡å‡†ï¼š<br><img src="https://s2.loli.net/2024/07/08/qdfeaXc6gRlF5tN.png"></p><p>å½“ç„¶è¿™ä¸ªæ ‡å‡†ä¹Ÿä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œåªè¦æŒç»­çš„åœ¨ç¤¾åŒºæ´»è·ƒï¼Œæœ‰è„¸ç†Ÿä¹‹åè‡ªç„¶ä¼šæœ‰ç›¸å…³çš„ PMC ä¸ºä½ æåï¼›å½“ç„¶è¿™é‡Œçš„å‰ææ¡ä»¶éƒ½æ˜¯â€œæŒç»­æ´»è·ƒâ€ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ€åå†æ€»ç»“ä¸‹ï¼Œä¸ºçˆ±å‘ç”µçš„å¼€æºé¡¹ç›®ä¹Ÿæ˜¯å¯ä»¥è·å¾—å›æŠ¥çš„ï¼›ç‰¹åˆ«æ˜¯å½“ä½ åˆå¹¶ä¸€ä¸ª PR è¿›å…¥æŸä¸ªé¡¹ç›®æ—¶å¸¦æ¥çš„æ„‰æ‚¦æ„Ÿéå¸¸å¼ºçƒˆã€‚</p><p>éšç€æ—¶é—´æ¨è¿›ï¼Œåœ¨ä¹‹ååˆå¹¶çš„ PR å¯èƒ½æ²¡æœ‰å‰å‡ æ¬¡é‚£ä¹ˆå¼ºçƒˆï¼Œä½†åªè¦è¾¾åˆ°ä¸€ä¸ªèŒƒå›´ï¼Œç¤¾åŒºå¼€å§‹æåä½ ä¸º Committer æ—¶ï¼Œè¿™ä¸ªå¤šå·´èƒºåˆä¼šæŒç»­åˆ†æ³Œã€‚</p><p>åŒæ ·çš„åç»­æˆä¸º PMCã€ç®¡ç†äººå‘˜ã€è‘£äº‹åˆä¼šæŒç»­å¸¦æ¥æ„‰æ‚¦ï¼Œå½“ç„¶éš¾åº¦ä¹Ÿä¸€ä¸ªæ¯”ä¸€ä¸ªå¤§ã€‚</p><p>åé¢çš„å±‚çº§ç¦»æˆ‘è¿˜å¾ˆè¿œï¼Œå¦‚æœä»Šåæœ‰è¾¾åˆ°çš„ä¸€å¤©å†æ¥å’Œå¤§å®¶åˆ†äº«ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://community.apache.org/contributor-ladder.html">https://community.apache.org/contributor-ladder.html</a></li><li><a href="https://hertzbeat.apache.org/zh-cn/docs/community/become_committer">https://hertzbeat.apache.org/zh-cn/docs/community/become_committer</a></li><li><a href="https://zh.wikipedia.org/wiki/%E8%87%AA%E7%94%B1%E8%BD%AF%E4%BB%B6%E8%BF%90%E5%8A%A8">https://zh.wikipedia.org/wiki/%E8%87%AA%E7%94%B1%E8%BD%AF%E4%BB%B6%E8%BF%90%E5%8A%A8</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/07/07/bj8NHqYFegTx1WU.png&quot; alt=&quot;image.png&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/07/07/a86fbuopri9mDeS.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æœ€è¿‘æ”¶åˆ°äº† &lt;a href=&quot;https://github.com/apache/pulsar/&quot;&gt;Apache Pulsar&lt;/a&gt; å’Œ &lt;a href=&quot;https://github.com/apache/hertzbeat/&quot;&gt;Apache HertzBeat&lt;/a&gt;ç¤¾åŒºçš„é‚€è¯·é‚®ä»¶ï¼Œæˆä¸ºäº†è¿™ä¸¤ä¸ªé¡¹ç›®çš„ &lt;code&gt;Committer&lt;/code&gt;ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
  </entry>
  
  <entry>
    <title>âœ…å¼€æºé¡¹ç›®å¦‚ä½•åšé›†æˆæµ‹è¯•</title>
    <link href="http://crossoverjie.top/2024/07/09/ob/%E2%9C%85%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%A6%82%E4%BD%95%E5%81%9A%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95/"/>
    <id>http://crossoverjie.top/2024/07/09/ob/%E2%9C%85%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%A6%82%E4%BD%95%E5%81%9A%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95/</id>
    <published>2024-07-09T03:15:25.000Z</published>
    <updated>2024-07-09T03:16:37.821Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰æœ‰æœ‹å‹é—®å¦‚ä½•åšé›†æˆæµ‹è¯•ï¼Œä»Šå¤©å°±é‡ç‚¹è®²è®²è¿™ä¸ªé›†æˆæµ‹è¯•åœ¨å¼€æºé¡¹ç›®ä¸­æ˜¯å¦‚ä½•åšçš„ã€‚</p><p>é€šå¸¸æ˜¯éœ€è¦å¯¹å¤–æä¾›æœåŠ¡çš„å¼€æºé¡¹ç›®éƒ½éœ€è¦é›†æˆæµ‹è¯•ï¼š</p><ul><li>Pulsar</li><li>Kafka</li><li>Dubbo ç­‰<span id="more"></span></li></ul><p>è€Œåªæä¾›æœ¬åœ°ç±»åº“çš„é¡¹ç›®é€šå¸¸åªéœ€è¦ç¼–å†™å•å…ƒæµ‹è¯•å³å¯ï¼š</p><ul><li>Hutool</li><li>Apache Commmon</li></ul><p>ä»¥æˆ‘æ¥è§¦åˆ°çš„æœåŠ¡å‹åº”ç”¨ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ä¸ªæ˜¯ Java åº”ç”¨ä¸€ä¸ªæ˜¯ Golang åº”ç”¨ã€‚</p><h1 id="ğŸ³Golang"><a href="#ğŸ³Golang" class="headerlink" title="ğŸ³Golang"></a>ğŸ³Golang</h1><p>Golang å› ä¸ºå·¥å…·é“¾æ²¡æœ‰ Java é‚£ä¹ˆå¼ºå¤§ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†çš„é›†æˆæµ‹è¯•çš„åŠŸèƒ½éƒ½æ˜¯é€šè¿‡ç¼–å†™ Makefile å’Œ shell è„šæœ¬å®ç°çš„ã€‚</p><p>è¿˜æ˜¯ä»¥æˆ‘ç†Ÿæ‚‰çš„ Pulsar çš„ go-client ä¸ºä¾‹ï¼Œå®ƒåœ¨ GitHub çš„é›†æˆæµ‹è¯•æ˜¯é€šè¿‡ GitHub action è§¦å‘çš„ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/05/20/f2196pujo8m7KRe.png"><br>æœ€ç»ˆè°ƒç”¨çš„æ˜¯ Makefile ä¸­çš„ test å‘½ä»¤ï¼Œå¹¶ä¸”æŠŠéœ€è¦æµ‹è¯•çš„ Golang ç‰ˆæœ¬ä¼ å…¥è¿›å»ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/YpwtSHnLXqU1xQj.png"></p><p><code>Dockerfile</code>ï¼š<br><img src="https://s2.loli.net/2024/05/20/1ySGWF46U7EC2rk.png"></p><p>è¿™ä¸ªé•œåƒç®€å•æ¥è¯´å°±æ˜¯å°† Pulsar çš„é•œåƒä½œä¸ºåŸºç¡€è¿è¡Œé•œåƒï¼ˆè¿™é‡Œé¢åŒ…å«äº† Pulsar çš„æœåŠ¡ç«¯ï¼‰ï¼Œç„¶åå°†è¿™ä¸ª pulsar-client-go çš„ä»£ç å¤åˆ¶è¿›å»ç¼–è¯‘ã€‚</p><p>æ¥ç€è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /pulsar/pulsar-client-go &amp;&amp; ./scripts/run-ci.sh</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯æµ‹è¯•è„šæœ¬ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/2Afmdu8ozRvH9FC.png"></p><p>æµ‹è¯•è„šæœ¬çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼š</p><ul><li>å¯åŠ¨ pulsar æœåŠ¡ç«¯</li><li>è¿è¡Œæµ‹è¯•ä»£ç <br>å› ä¸ºæ‰€æœ‰çš„æµ‹è¯•ä»£ç é‡Œè¿æ¥æœåŠ¡ç«¯çš„åœ°å€éƒ½æ˜¯ <code>localhost</code>ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿æ¥ã€‚<br><img src="https://s2.loli.net/2024/05/20/C1RHxTkuz25Mlj8.png"></li></ul><p>é€šè¿‡è¿™é‡Œçš„ <a href="https://github.com/apache/pulsar-client-go/actions/runs/9014510238/job/24768797555">action</a> æ—¥å¿—å¯ä»¥è·Ÿè¸ªæ‰€æœ‰çš„è¿è¡Œæƒ…å†µã€‚</p><h1 id="â˜•Java"><a href="#â˜•Java" class="headerlink" title="â˜•Java"></a>â˜•Java</h1><p>Java å› ä¸ºå·¥å…·é“¾å¼ºå¤§ï¼Œæ‰€ä»¥é›†æˆæµ‹è¯•å‡ ä¹ä¸éœ€è¦ç”¨ Makefile å’Œè„šæœ¬é…åˆæ‰§è¡Œã€‚</p><p>è¿˜æ˜¯ä»¥ Pulsar ä¸ºä¾‹ï¼Œå®ƒçš„é›†æˆæµ‹è¯•æ˜¯éœ€è¦æ¨¡æ‹Ÿåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œç„¶åå†è¿è¡Œæµ‹è¯•ä»£ç ã€‚</p><blockquote><p>è¿™ä¸ªçš„å¥½å¤„æ˜¯ä»»ä½•ä¸€ä¸ªå•æµ‹éƒ½å¯ä»¥åœ¨æœ¬åœ°ç›´æ¥è¿è¡Œï¼Œè€Œ  Go çš„ä»£ç è¿˜éœ€è¦å…ˆåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œæµ‹è¯•èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚</p></blockquote><p>æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Œæˆ‘ä»¥å…¶ä¸­ä¸€ä¸ª <a href="https://github.com/apache/pulsar/blob/631b13ad23d7e48c6e82d38f97c23d129062cb7c/pulsar-broker/src/test/java/org/apache/pulsar/client/impl/BrokerClientIntegrationTest.java#L117">BrokerClientIntegrationTest</a>ä¸ºä¾‹ï¼š<br><img src="https://s2.loli.net/2024/05/20/9PbioA3RQLMBy6J.png"><br><img src="https://s2.loli.net/2024/05/20/blKePdxTUIkgRD3.png"><br>ä¼šåœ¨å•æµ‹å¯åŠ¨çš„æ—¶å€™å…ˆå¯åŠ¨æœåŠ¡ç«¯ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/gzY3lyTGuEDUwZF.png"></p><p>æœ€ç»ˆä¼šè°ƒç”¨ PulsarTestContext çš„ build å‡½æ•°å¯åŠ¨ brokerï¼ˆæœåŠ¡ç«¯ï¼‰ï¼Œè€Œæ‰§è¡Œå•æµ‹ä¹Ÿåªéœ€è¦ä½¿ç”¨ mvn å°±å¯ä»¥è‡ªåŠ¨è§¦å‘è¿™äº›å•å…ƒæµ‹è¯•ã€‚<br><img src="https://s2.loli.net/2024/05/20/N15amZihWI73Qyw.png"><br>åªæ˜¯æ¯ä¸€ä¸ªå•æµ‹éƒ½éœ€è¦å¯åœæœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¦æŠŠ Pulsar çš„æ‰€æœ‰å•æµ‹è·‘å®Œé€šå¸¸éœ€è¦ 1ï½2 ä¸ªå°æ—¶ã€‚</p><p>æ‰€ä»¥è¿™äº›é›†æˆæµ‹è¯•æœ¬è´¨ä¸Šéƒ½æ˜¯å…ˆè¦æŠŠæµ‹è¯•ç¯å¢ƒæ„å»ºå‡ºæ¥ï¼Œå†è·‘å¯¹åº”çš„æµ‹è¯•ä»£ç ï¼›åç»­ä¹Ÿæ‰“ç®—ç»™ <a href="https://github.com/crossoverJie/cim">cim</a> åŠ ä¸Šé›†æˆæµ‹è¯•å®æ“ä¸€ä¸‹ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰æœ‰æœ‹å‹é—®å¦‚ä½•åšé›†æˆæµ‹è¯•ï¼Œä»Šå¤©å°±é‡ç‚¹è®²è®²è¿™ä¸ªé›†æˆæµ‹è¯•åœ¨å¼€æºé¡¹ç›®ä¸­æ˜¯å¦‚ä½•åšçš„ã€‚&lt;/p&gt;
&lt;p&gt;é€šå¸¸æ˜¯éœ€è¦å¯¹å¤–æä¾›æœåŠ¡çš„å¼€æºé¡¹ç›®éƒ½éœ€è¦é›†æˆæµ‹è¯•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pulsar&lt;/li&gt;
&lt;li&gt;Kafka&lt;/li&gt;
&lt;li&gt;Dubbo ç­‰</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
  </entry>
  
  <entry>
    <title>ä» Helm åˆ° Operatorï¼šKubernetesåº”ç”¨ç®¡ç†çš„è¿›åŒ–</title>
    <link href="http://crossoverjie.top/2024/07/08/ob/how-operator-working/"/>
    <id>http://crossoverjie.top/2024/07/08/ob/how-operator-working/</id>
    <published>2024-07-08T03:19:51.000Z</published>
    <updated>2024-07-07T07:45:26.500Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ğŸ§°Helm-çš„ä½œç”¨"><a href="#ğŸ§°Helm-çš„ä½œç”¨" class="headerlink" title="ğŸ§°Helm çš„ä½œç”¨"></a>ğŸ§°Helm çš„ä½œç”¨</h1><p>åœ¨å¼€å§‹å‰éœ€è¦å…ˆå¯¹ kubernetes  Operator æœ‰ä¸ªç®€å•çš„è®¤è¯†ã€‚</p><p>ä»¥ä¸ºæˆ‘ä»¬åœ¨ç¼–å†™éƒ¨ç½²ä¸€äº›ç®€å• <code>Deployment</code> çš„æ—¶å€™åªéœ€è¦è‡ªå·±ç¼–å†™ä¸€ä¸ª yaml æ–‡ä»¶ç„¶å <code>kubectl apply</code> å³å¯ã€‚</p><span id="more"></span><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">app:</span> <span class="string">k8s-combat</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-combat</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span>  </span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">matchLabels:</span>  </span><br><span class="line">      <span class="attr">app:</span> <span class="string">k8s-combat</span>  </span><br><span class="line">  <span class="attr">template:</span>  </span><br><span class="line">    <span class="attr">metadata:</span>  </span><br><span class="line">      <span class="attr">labels:</span>  </span><br><span class="line">        <span class="attr">app:</span> <span class="string">k8s-combat</span>  </span><br><span class="line">    <span class="attr">spec:</span>  </span><br><span class="line">      <span class="attr">containers:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s-combat</span>  </span><br><span class="line">          <span class="attr">image:</span> <span class="string">crossoverjie/k8s-combat:v1</span>  </span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span>  </span><br><span class="line">          <span class="attr">resources:</span>  </span><br><span class="line">            <span class="attr">limits:</span>  </span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span>  </span><br><span class="line">              <span class="attr">memory:</span> <span class="string">300Mi</span>  </span><br><span class="line">            <span class="attr">requests:</span>  </span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;0.1&quot;</span>  </span><br><span class="line">              <span class="attr">memory:</span> <span class="string">30Mi</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deployment.yaml</span><br></pre></td></tr></table></figure><p>è¿™å¯¹äºä¸€äº›å¹¶ä¸å¤æ‚çš„é¡¹ç›®æ¥è¯´å®Œå…¨å¤Ÿç”¨äº†ï¼Œä½†ç»„ä»¶ä¸€å¤šå°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚</p><p><img src="https://s2.loli.net/2024/06/01/9EtzrfIAvcXm4aJ.png"><br>è¿™é‡Œä»¥ Apache Pulsar ä¸ºä¾‹ï¼šå®ƒçš„æ ¸å¿ƒç»„ä»¶æœ‰:</p><ul><li>Broker</li><li>Proxy</li><li>Zookeeper</li><li>Bookkeeper</li><li>Prometheus(å¯é€‰)</li><li>Grafana(å¯é€‰)<br>ç­‰ç»„ä»¶ï¼Œæ¯ä¸ªç»„ä»¶çš„å¯åŠ¨è¿˜æœ‰è¿™ä¾èµ–å…³ç³»ã€‚<blockquote><p>å¿…é¡»éœ€è¦ç­‰ Zookeeper å’Œ Bookkeeper å¯åŠ¨ä¹‹åæ‰èƒ½å°†æµé‡æ”¾è¿›æ¥ã€‚</p></blockquote></li></ul><p>æ­¤æ—¶å¦‚ä½•è¿˜ç»§ç»­ä½¿ç”¨ yaml æ–‡ä»¶ä¸€ä¸ªä¸ªéƒ¨ç½²å°±ä¼šéå¸¸ç¹çï¼Œå¥½åœ¨ç¤¾åŒºæœ‰æä¾› Helm ä¸€é”®å®‰è£…ç¨‹åºï¼Œä½¿ç”¨å®ƒæˆ‘ä»¬åªéœ€è¦åœ¨ä¸€ä¸ªåŒæ„çš„ yaml é‡Œç®€å•çš„é…ç½®ä¸€äº›ç»„ä»¶ï¼Œé…ç½®å°±å¯ä»¥ç”± helm æ¥éƒ¨ç½²æ•´ä¸ªå¤æ‚çš„ Pulsar ç³»ç»Ÿã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">components:</span>  </span><br><span class="line">  <span class="comment"># zookeeper  </span></span><br><span class="line">  <span class="attr">zookeeper:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># bookkeeper  </span></span><br><span class="line">  <span class="attr">bookkeeper:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># bookkeeper - autorecovery  </span></span><br><span class="line">  <span class="attr">autorecovery:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># broker  </span></span><br><span class="line">  <span class="attr">broker:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># functions  </span></span><br><span class="line">  <span class="attr">functions:</span> <span class="literal">false</span>  </span><br><span class="line">  <span class="comment"># proxy  </span></span><br><span class="line">  <span class="attr">proxy:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># toolset  </span></span><br><span class="line">  <span class="attr">toolset:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># pulsar manager  </span></span><br><span class="line">  <span class="attr">pulsar_manager:</span> <span class="literal">false</span>  </span><br><span class="line"><span class="attr">monitoring:</span>  </span><br><span class="line">  <span class="comment"># monitoring - prometheus  </span></span><br><span class="line">  <span class="attr">prometheus:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># monitoring - grafana  </span></span><br><span class="line">  <span class="attr">grafana:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># monitoring - node_exporter  </span></span><br><span class="line">  <span class="attr">node_exporter:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="comment"># alerting - alert-manager  </span></span><br><span class="line">  <span class="attr">alert_manager:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>æ¯”å¦‚åœ¨ helm çš„ yaml ä¸­æˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨å“ªäº› componentsï¼Œä»¥åŠæ˜¯å¦å¯ç”¨ç›‘æ§ç»„ä»¶ã€‚</p><p>æœ€åç›´æ¥ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm install pulsar apache/pulsar \</span><br><span class="line">--values charts/pulsar/values.yaml \</span><br><span class="line">--<span class="built_in">set</span> namespace=pulsar \</span><br><span class="line">    --<span class="built_in">set</span> initialize=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>å®ƒå°±ä¼šè‡ªåŠ¨ç”Ÿæˆå„ä¸ªç»„ä»¶çš„ yaml æ–‡ä»¶ï¼Œç„¶åç»Ÿä¸€æ‰§è¡Œã€‚</p><p>æ‰€ä»¥ helm çš„æœ¬è´¨ä¸Šå’Œ <code>kubectl apply yaml</code> ä¸€æ ·çš„ï¼Œåªæ˜¯æˆ‘ä»¬åœ¨å®šä¹‰ value.yaml æ—¶å¸®æˆ‘ä»¬å¤„ç†äº†è®¸å¤šä¸éœ€è¦ç”¨æˆ·ä½é¢‘ä¿®æ”¹çš„å‚æ•°ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ helm å°†è¦æ‰§è¡Œçš„ yaml è¾“å‡ºåäººå·¥å®¡æ ¸</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install pulsar apache/pulsar --dry-run --debug &gt; debug.yaml</span><br></pre></td></tr></table></figure><h1 id="ğŸ¤”Operator-æ˜¯ä»€ä¹ˆ"><a href="#ğŸ¤”Operator-æ˜¯ä»€ä¹ˆ" class="headerlink" title="ğŸ¤”Operator æ˜¯ä»€ä¹ˆ"></a>ğŸ¤”Operator æ˜¯ä»€ä¹ˆ</h1><h2 id="ğŸ’”Helm-çš„ç—›ç‚¹"><a href="#ğŸ’”Helm-çš„ç—›ç‚¹" class="headerlink" title="ğŸ’”Helm çš„ç—›ç‚¹"></a>ğŸ’”Helm çš„ç—›ç‚¹</h2><p>Helm è™½ç„¶å¯ä»¥å¸®æˆ‘ä»¬éƒ¨ç½²æˆ–è€…å‡çº§ä¸€ä¸ªå¤§å‹åº”ç”¨ï¼Œä½†ä»–å´æ²¡æ³•å¸®æˆ‘ä»¬è¿ç»´è¿™ä¸ªåº”ç”¨ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼šæ¯”å¦‚æˆ‘å¸Œæœ›å½“ Pulsar Broker çš„æµé‡æˆ–è€…å†…å­˜è¾¾åˆ°æŸä¸ªé˜ˆå€¼åå°±æŒ‡å®šæ‰©å®¹ Brokerï¼Œé—²æ—¶å†è‡ªåŠ¨å›æ”¶ã€‚</p><p>æˆ–è€…æŸä¸ª Bookkeeper çš„ç£ç›˜ä½¿ç”¨ç‡è¾¾åˆ°é˜ˆå€¼åå¯ä»¥è‡ªåŠ¨æ‰©å®¹ç£ç›˜ï¼Œè¿™äº›ä»…ä»…ä½¿ç”¨ Helm æ—¶éƒ½æ˜¯æ— æ³•å®ç°çš„ã€‚</p><p>ä»¥ä¸Šè¿™äº›éœ€æ±‚æˆ‘ä»¬ç›®å‰ä¹Ÿæ˜¯é€šè¿‡ç›‘æ§ç³»ç»Ÿå‘å‡ºæŠ¥è­¦ï¼Œç„¶åå†ç”±äººå·¥å¤„ç†ã€‚</p><p>å…¶ä¸­æœ€å¤§çš„ç—›ç‚¹å°±æ˜¯è¿›è¡Œå‡çº§ï¼š</p><ul><li>å‡çº§ZK</li><li>å…³é—­auto recovery</li><li>å‡çº§Bookkeeper</li><li>å‡çº§Broker</li><li>å‡çº§Proxy</li><li>å¼€å¯auto recovery</li></ul><p>å› ä¸ºæ¯æ¬¡å‡çº§æ˜¯æœ‰å…ˆåé¡ºåºçš„ï¼Œéœ€è¦ä¾æ¬¡è§‚å¯Ÿæ¯ä¸ªç»„ä»¶è¿è¡Œæ˜¯å¦æ­£å¸¸æ‰èƒ½å¾€åæ“ä½œã€‚</p><p>å¦‚æœæœ‰ Operator ç†æ€§æƒ…å†µä¸‹ä¸‹æˆ‘ä»¬åªéœ€è¦æ›´æ–°ä¸€ä¸‹é•œåƒç‰ˆæœ¬ï¼Œå®ƒå°±å¯ä»¥è‡ªåŠ¨æ‰§è¡Œä»¥ä¸Šçš„æ‰€æœ‰æ­¥éª¤æœ€åå°†é›†ç¾¤å‡çº§å®Œæ¯•ã€‚</p><p>æ‰€ä»¥ç›¸å¯¹äº Helm æ¥è¯´ Operator æ˜¯å¯ä»¥ç«™åœ¨ä¸€ä¸ªæ›´é«˜çš„è§†è§’ä¿¯è§†æ•´ä¸ªåº”ç”¨ç³»ç»Ÿï¼Œå®ƒèƒ½å‘ç°ç³»ç»Ÿå“ªä¸ªåœ°æ–¹éœ€è¦å®ƒä»è€Œç›´æ¥ä¿®å¤ã€‚</p><h2 id="ğŸ’CRD-Custom-Resource-Definitions"><a href="#ğŸ’CRD-Custom-Resource-Definitions" class="headerlink" title="ğŸ’CRD(Custom Resource Definitions)"></a>ğŸ’CRD(Custom Resource Definitions)</h2><p>è€Œæåˆ° Operator é‚£å°±ä¸å¾—ä¸æåˆ° CRD(Custom Resource Definitions)ç¿»è¯‘è¿‡æ¥å°±æ˜¯è‡ªå®šä¹‰èµ„æºã€‚</p><p>è¿™æ˜¯ kubernetes æä¾›çš„ä¸€ä¸ª API æ‰©å±•æœºåˆ¶ï¼Œç±»ä¼¼äºå†…ç½®çš„ <code>Deployment/StatefulSet/Services</code> èµ„æºï¼ŒCRD æ˜¯ä¸€ç§è‡ªå®šä¹‰çš„èµ„æºã€‚</p><p>è¿™é‡Œä»¥æˆ‘ä»¬å¸¸ç”¨çš„ <code>prometheus-operator</code> å’Œ <code>VictoriaMetrics-operator</code> ä¸ºä¾‹ï¼š</p><p>Prometheusï¼š</p><ul><li>**<code>Prometheus</code>**ï¼šç”¨äºå®šä¹‰ Prometheus çš„ Deployment</li><li>**<code>Alertmanager</code>**ï¼šç”¨äºå®šä¹‰ <strong><code>Alertmanager</code></strong></li><li>**<code>ScrapeConfig</code>**ï¼šç”¨äºå®šä¼šæŠ“å–è§„åˆ™</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ScrapeConfig</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">static-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">my-namespace</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">system-monitoring-prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">staticConfigs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">job:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">targets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">prometheus.demo.do.prometheus.io:9090</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ—¶çš„ä¸€ä¸ªå¾ˆå¤§åŒºåˆ«å°±æ˜¯èµ„æºçš„ <code>kind: ScrapeConfig</code> ä¸ºè‡ªå®šä¹‰çš„ç±»å‹ã€‚</p><p>VictoriaMetrics çš„ CRDï¼š</p><ul><li>VMPodScrapeï¼šPod çš„æŠ“å–è§„åˆ™</li><li>VMClusterï¼šé…ç½® VM é›†ç¾¤</li><li>VMAlertï¼šé…ç½® VM çš„å‘Šè­¦è§„åˆ™</li><li>ç­‰ç­‰</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vmcluster.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMCluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">retentionPeriod:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="attr">replicationFactor:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">vmstorage:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">storageDataPath:</span> <span class="string">&quot;/vm-data&quot;</span></span><br><span class="line">    <span class="attr">storage:</span></span><br><span class="line">      <span class="attr">volumeClaimTemplate:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">storage:</span> <span class="string">&quot;10Gi&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">  <span class="attr">vmselect:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">cacheMountPath:</span> <span class="string">&quot;/select-cache&quot;</span></span><br><span class="line">    <span class="attr">storage:</span></span><br><span class="line">      <span class="attr">volumeClaimTemplate:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">storage:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;0.5&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;500Mi&quot;</span></span><br><span class="line">  <span class="attr">vminsert:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯ç”¨äºåˆ›å»ºä¸€ä¸ª VM é›†ç¾¤çš„ CRD èµ„æºï¼Œåº”ç”¨ä¹‹åå°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé›†ç¾¤ã€‚</p><h1 id="Operator-åŸç†"><a href="#Operator-åŸç†" class="headerlink" title="Operator åŸç†"></a>Operator åŸç†</h1><p><img src="https://s2.loli.net/2024/06/01/t4ZnXcS9wokMPER.png"><br>Operator é€šå¸¸æ˜¯è¿è¡Œåœ¨ kubernetes API server çš„ <code>webhook</code> ä¹‹ä¸Šï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨ä¸€äº›å†…ç½®èµ„æºçš„å…³é”®èŠ‚ç‚¹ API-server ä¼šè°ƒç”¨æˆ‘ä»¬æ³¨å†Œçš„ä¸€ä¸ª <code>webhook</code>ï¼Œåœ¨è¿™ä¸ª <code>webhook</code> ä¸­æˆ‘ä»¬æ ¹æ®æˆ‘ä»¬çš„ CRD åšä¸€äº›è‡ªå®šä¹‰çš„æ“ä½œã€‚</p><p>ç†è®ºä¸Šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»»ä½•è¯­è¨€éƒ½å¯ä»¥å†™ Operatorï¼Œåªéœ€è¦èƒ½å¤„ç† api-server çš„å›è°ƒå³å¯ã€‚</p><p>åªæ˜¯ Go è¯­è¨€æœ‰å¾ˆå¤šæˆç†Ÿçš„å·¥å…·ï¼Œæ¯”å¦‚å¸¸ç”¨çš„ <a href="https://kubebuilder.io/">kubebuilder</a> å’Œ <a href="https://sdk.operatorframework.io/">operator-sdk</a>.</p><p>ä»–ä»¬å†…ç½®äº†è®¸å¤šå‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥å¸®æˆ‘ä»¬èŠ‚çœéœ€è¦å·¥ä½œé‡ã€‚</p><p>è¿™é‡Œä»¥ operator-sdk ä¸ºä¾‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ operator-sdk create webhook --group cache --version v1alpha1 --kind Memcached --defaulting --programmatic-validation</span><br></pre></td></tr></table></figure><p>ä¼šç›´æ¥å¸®æˆ‘ä»¬åˆ›å»ºå¥½ä¸€ä¸ªæ ‡å‡†çš„ operator é¡¹ç›®:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â”œâ”€â”€ PROJECT</span><br><span class="line">â”œâ”€â”€ api</span><br><span class="line">â”‚Â Â  â””â”€â”€ v1alpha1</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ memcached_webhook.go</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ webhook_suite_test.go</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ certmanager</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ certificate.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ default</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ manager_webhook_patch.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ webhookcainjection_patch.yaml</span><br><span class="line">â”‚Â Â  â””â”€â”€ webhook</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚Â Â      â””â”€â”€ service.yaml</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â””â”€â”€ main.go</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ Makefile ä¸­åŒ…å«äº†å¼€å‘è¿‡ç¨‹ä¸­å¸¸ç”¨çš„å·¥å…·é“¾ï¼ˆåŒ…æ‹¬æ ¹æ®å£°æ˜çš„ç»“æ„ä½“è‡ªåŠ¨ç”Ÿæˆ CRD èµ„æºã€éƒ¨ç½²k8s ç¯å¢ƒæµ‹è¯•ç­‰ç­‰ï¼‰ã€Dockerfile ç­‰ç­‰ã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±åªéœ€è¦ä¸“æ³¨äºå¼€å‘ä¸šåŠ¡é€»è¾‘å³å¯ã€‚</p><p>å› ä¸ºæˆ‘å‰æ®µæ—¶é—´ç»™ <a href="https://github.com/open-telemetry/opentelemetry-operator">https://github.com/open-telemetry/opentelemetry-operator</a> è´¡çŒ®è¿‡ä¸¤ä¸ª featureï¼Œæ‰€ä»¥å°±ä»¥è¿™ä¸ª Operator ä¸ºä¾‹ï¼š</p><p>å®ƒæœ‰ä¸€ä¸ª CRD: <code>kind: Instrumentation</code>ï¼Œåœ¨è¿™ä¸ª CRD ä¸­å¯ä»¥å°† OpenTelemetry çš„ agent æ³¨å…¥åˆ°åº”ç”¨ä¸­ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Instrumentation</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">instrumentation-test-order</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">env:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_SERVICE_NAME</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">order</span></span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">matchLabels:</span>  </span><br><span class="line">      <span class="attr">app:</span> <span class="string">order</span>  </span><br><span class="line">  <span class="attr">java:</span>  </span><br><span class="line">    <span class="attr">image:</span> <span class="string">autoinstrumentation-java:2.4.0-release</span>  </span><br><span class="line">    <span class="attr">extensions:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">autoinstrumentation-java:2.4.0-release</span>  </span><br><span class="line">        <span class="attr">dir:</span> <span class="string">/extensions</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="attr">env:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_RESOURCE_ATTRIBUTES</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">service.name=order</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_INSTRUMENTATION_MESSAGING_EXPERIMENTAL_RECEIVE_TELEMETRY_ENABLED</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_EXPORTER</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">otlp</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_METRICS_EXPORTER</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">otlp</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_LOGS_EXPORTER</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">none</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">http://open-telemetry-opentelemetry-collector.otel.svc.cluster.local:4317</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_COMPRESSION</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">gzip</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPERIMENTAL_EXPORTER_OTLP_RETRY_ENABLED</span>  </span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure><p>å®ƒçš„è¿è¡Œè§„åˆ™æ˜¯å½“æˆ‘ä»¬çš„ Pod åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šåˆ¤æ–­ Pod çš„æ³¨è§£ä¸­æ˜¯å¦å¼€å¯äº†æ³¨å…¥ OpenTelemetry çš„é…ç½®ã€‚</p><p>å¦‚æœå¼€å¯åˆ™ä¼šå°†æˆ‘ä»¬åœ¨ CRD ä¸­è‡ªå®šä¹‰çš„é•œåƒé‡Œçš„ javaagent å¤åˆ¶åˆ°ä¸šåŠ¡å®¹å™¨ä¸­ï¼ŒåŒæ—¶ä¼šå°†ä¸‹é¢çš„é‚£äº›ç¯å¢ƒå˜é‡ä¹Ÿä¸€èµ·åŠ å…¥çš„ä¸šåŠ¡å®¹å™¨ä¸­ã€‚</p><p>è¦è¾¾åˆ°è¿™æ ·çš„æ•ˆæœå°±éœ€è¦æˆ‘ä»¬æ³¨å†Œä¸€ä¸ªå›è°ƒ endpointã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mgr.GetWebhookServer().Register(<span class="string">&quot;/mutate-v1-pod&quot;</span>, &amp;webhook.Admission&#123;  </span><br><span class="line">    Handler: podmutation.NewWebhookHandler(cfg, ctrl.Log.WithName(<span class="string">&quot;pod-webhook&quot;</span>), decoder, mgr.GetClient(),  </span><br><span class="line">       []podmutation.PodMutator&#123;  </span><br><span class="line">          sidecar.NewMutator(logger, cfg, mgr.GetClient()),  </span><br><span class="line">          instrumentation.NewMutator(logger, mgr.GetClient(), mgr.GetEventRecorderFor(<span class="string">&quot;opentelemetry-operator&quot;</span>), cfg),  </span><br><span class="line">       &#125;),&#125;)</span><br></pre></td></tr></table></figure><p>å½“ Pod åˆ›å»ºæˆ–æœ‰æ–°çš„å˜æ›´è¯·æ±‚æ—¶å°±ä¼šå›è°ƒæˆ‘ä»¬çš„æ¥å£ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *instPodMutator)</span></span> Mutate(ctx context.Context, ns corev1.Namespace, pod corev1.Pod) (corev1.Pod, <span class="type">error</span>) &#123;  </span><br><span class="line">    logger := pm.Logger.WithValues(<span class="string">&quot;namespace&quot;</span>, pod.Namespace, <span class="string">&quot;name&quot;</span>, pod.Name)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ¥å£ä¸­æˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ° Pod çš„ä¿¡æ¯ï¼Œç„¶åå†è·å– CRD <code>Instrumentation</code> åšæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> otelInsts v1alpha1.InstrumentationList  </span><br><span class="line"><span class="keyword">if</span> err := pm.Client.List(ctx, &amp;otelInsts, client.InNamespace(ns.Name)); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä» CRD ä¸­å°†æ•°æ®å¤åˆ¶åˆ°ä¸šåŠ¡å®¹å™¨ä¸­ã€‚</span></span><br><span class="line">pod.Spec.InitContainers = <span class="built_in">append</span>(pod.Spec.InitContainers, corev1.Container&#123;</span><br><span class="line">Name:      javaInitContainerName,</span><br><span class="line">Image:     javaSpec.Image,</span><br><span class="line">Command:   []<span class="type">string</span>&#123;<span class="string">&quot;cp&quot;</span>, <span class="string">&quot;/javaagent.jar&quot;</span>, javaInstrMountPath + <span class="string">&quot;/javaagent.jar&quot;</span>&#125;,</span><br><span class="line">Resources: javaSpec.Resources,</span><br><span class="line">VolumeMounts: []corev1.VolumeMount&#123;&#123;</span><br><span class="line">Name:      javaVolumeName,</span><br><span class="line">MountPath: javaInstrMountPath,</span><br><span class="line">&#125;&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, extension := <span class="keyword">range</span> javaSpec.Extensions &#123;</span><br><span class="line">pod.Spec.InitContainers = <span class="built_in">append</span>(pod.Spec.InitContainers, corev1.Container&#123;</span><br><span class="line">Name:      initContainerName + fmt.Sprintf(<span class="string">&quot;-extension-%d&quot;</span>, i),</span><br><span class="line">Image:     extension.Image,</span><br><span class="line">Command:   []<span class="type">string</span>&#123;<span class="string">&quot;cp&quot;</span>, <span class="string">&quot;-r&quot;</span>, extension.Dir + <span class="string">&quot;/.&quot;</span>, javaInstrMountPath + <span class="string">&quot;/extensions&quot;</span>&#125;,</span><br><span class="line">Resources: javaSpec.Resources,</span><br><span class="line">VolumeMounts: []corev1.VolumeMount&#123;&#123;</span><br><span class="line">Name:      javaVolumeName,</span><br><span class="line">MountPath: javaInstrMountPath,</span><br><span class="line">&#125;&#125;,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯æƒ³è¦åœ¨æµ‹è¯•ç¯å¢ƒä¸­æµ‹è¯• operator æ˜¯éœ€è¦å®‰è£…ä¸€ä¸ª <a href="https://kubebuilder.io/quick-start">cert-manage</a>ï¼Œè¿™æ · <code>webhook</code> æ‰èƒ½æ­£å¸¸çš„å›è°ƒã€‚</p></blockquote><p><img src="https://s2.loli.net/2024/06/01/IUjriqye6EMFCT8.png"><br>è¦ä½¿å¾— CRD ç”Ÿæ•ˆï¼Œæˆ‘ä»¬è¿˜å¾—å…ˆå°† CRD å®‰è£…è¿› kubernetes é›†ç¾¤ä¸­ï¼Œä¸è¿‡è¿™äº› operator-sdk è¿™ç±»æ ¹æ®å·²ç»è€ƒè™‘å‘¨åˆ°äº†ã€‚</p><p>æˆ‘ä»¬åªéœ€è¦å®šä¹‰å¥½ CRD çš„ç»“æ„ä½“ï¼š<br><img src="https://s2.loli.net/2024/06/01/RBKp15lhkHsbeEY.png"></p><p>ç„¶åä½¿ç”¨ Makefile ä¸­çš„å·¥å…· <code>make bundle</code> å°±ä¼šè‡ªåŠ¨å°†ç»“æ„ä½“è½¬æ¢ä¸º CRDã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/VictoriaMetrics/operator">https://github.com/VictoriaMetrics/operator</a></li><li><a href="https://github.com/prometheus-operator/prometheus-operator">https://github.com/prometheus-operator/prometheus-operator</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ğŸ§°Helm-çš„ä½œç”¨&quot;&gt;&lt;a href=&quot;#ğŸ§°Helm-çš„ä½œç”¨&quot; class=&quot;headerlink&quot; title=&quot;ğŸ§°Helm çš„ä½œç”¨&quot;&gt;&lt;/a&gt;ğŸ§°Helm çš„ä½œç”¨&lt;/h1&gt;&lt;p&gt;åœ¨å¼€å§‹å‰éœ€è¦å…ˆå¯¹ kubernetes  Operator æœ‰ä¸ªç®€å•çš„è®¤è¯†ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸ºæˆ‘ä»¬åœ¨ç¼–å†™éƒ¨ç½²ä¸€äº›ç®€å• &lt;code&gt;Deployment&lt;/code&gt; çš„æ—¶å€™åªéœ€è¦è‡ªå·±ç¼–å†™ä¸€ä¸ª yaml æ–‡ä»¶ç„¶å &lt;code&gt;kubectl apply&lt;/code&gt; å³å¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="kubernetes" scheme="http://crossoverjie.top/categories/OB/kubernetes/"/>
    
    <category term="kubernetes" scheme="http://crossoverjie.top/categories/OB/kubernetes/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="http://crossoverjie.top/tags/kubernetes/"/>
    
    <category term="Operator" scheme="http://crossoverjie.top/tags/Operator/"/>
    
  </entry>
  
  <entry>
    <title>ã€è¯‘ã€‘äº”ä¸ªæˆ‘æœ€è¿‘åœ¨ Go é‡Œå­¦åˆ°çš„å°æŠ€å·§</title>
    <link href="http://crossoverjie.top/2024/07/02/ob/go-5-tips/"/>
    <id>http://crossoverjie.top/2024/07/02/ob/go-5-tips/</id>
    <published>2024-07-02T10:42:39.000Z</published>
    <updated>2024-07-02T11:11:48.928Z</updated>
    
    <content type="html"><![CDATA[<p>åŸæ–‡é“¾æ¥ï¼š<a href="https://medium.com/@andreiboar/5-small-tips-i-recently-learned-in-go-cf52d50cf129">https:&#x2F;&#x2F;medium.com&#x2F;@andreiboar&#x2F;5-small-tips-i-recently-learned-in-go-cf52d50cf129</a></p><h1 id="è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡"><a href="#è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡" class="headerlink" title="è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡"></a>è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡</h1><p>æˆ‘ä»¬åœ¨ Go é€šå¸¸å¾ˆå°‘ä½¿ç”¨æ•°ç»„ arraysï¼Œä¸€èˆ¬ä½¿ç”¨åˆ‡ç‰‡ Slice æ¥ä»£æ›¿ï¼›</p><p>ä½†æ˜¯å½“ä½ éœ€è¦ä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æœä½ å¯¹éœ€è¦æŒ‡å®šæ•°é‡å¤§å°æ„Ÿåˆ°å¾ˆçƒ¦æ—¶å¯ä»¥ä½¿ç”¨ <code>[...]</code> è®©ç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬è®¡ç®—æ•°ç»„å¤§å°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">arr := [<span class="number">3</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;  </span><br><span class="line">sameArr := [...]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125; <span class="comment">// Use ... instead of 3  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// Arrays are equivalent  </span></span><br><span class="line">fmt.Println(arr)  </span><br><span class="line">fmt.Println(sameArr)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><span id="more"></span><h1 id="ä½¿ç”¨-go-run-æ›¿æ¢-go-run-main-go"><a href="#ä½¿ç”¨-go-run-æ›¿æ¢-go-run-main-go" class="headerlink" title="ä½¿ç”¨ go run . æ›¿æ¢ go run main.go"></a>ä½¿ç”¨ go run . æ›¿æ¢ go run main.go</h1><p>æ¯å½“æˆ‘ç”¨ Go å†™ç¬¬ä¸€è¡Œä»£ç æ—¶ï¼Œæˆ‘éƒ½ä¹ æƒ¯äºå¼€å§‹å†™ <code>main.go</code>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sayHello()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sayHello</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Hello!&quot;</span>)</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å½“ <code>main.go</code> å˜å¾—è¶Šæ¥è¶Šå¤§æ—¶ï¼Œæˆ‘å–œæ¬¢æŠŠä¸€äº›ç»“æ„ä½“ç§»åŠ¨åˆ°æ–°çš„æ–‡ä»¶é‡Œï¼Œè¿˜æ˜¯åœ¨ main è¿™ä¸ªåŒ…ä¸­ã€‚</p><p>main.go:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">sayHello()  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>say_hello.go:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sayHello</span><span class="params">()</span></span> &#123;  </span><br><span class="line">fmt.Println(<span class="string">&quot;Hello!&quot;</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ä½¿ç”¨ <code>go run main.go</code> å°†ä¼šå¾—åˆ°ä»¥ä¸‹çš„é”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">command-line-arguments</span>  </span><br><span class="line">./main.go:4:2: undefined: sayHello</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å¯ä»¥ä½¿ç”¨ <code>go run .</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h1 id="ä½¿ç”¨ä¸‹åˆ’çº¿è®©ä½ çš„æ•°å­—å˜å¾—æ›´æ˜“è¯»"><a href="#ä½¿ç”¨ä¸‹åˆ’çº¿è®©ä½ çš„æ•°å­—å˜å¾—æ›´æ˜“è¯»" class="headerlink" title="ä½¿ç”¨ä¸‹åˆ’çº¿è®©ä½ çš„æ•°å­—å˜å¾—æ›´æ˜“è¯»"></a>ä½¿ç”¨ä¸‹åˆ’çº¿è®©ä½ çš„æ•°å­—å˜å¾—æ›´æ˜“è¯»</h1><p>ä½ çŸ¥é“å¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿ä½¿å¾—ä½ çš„é•¿æ•°å­—æ›´æ˜“è¯»å—ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    number := <span class="number">10000000</span></span><br><span class="line">    better := <span class="number">10</span>_000_000</span><br><span class="line"></span><br><span class="line">    fmt.Println(number == better)</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h1 id="å¯ä»¥åœ¨åŒä¸€ä¸ªåŒ…ä¸‹æœ‰ä¸åŒçš„æµ‹è¯•åŒ…"><a href="#å¯ä»¥åœ¨åŒä¸€ä¸ªåŒ…ä¸‹æœ‰ä¸åŒçš„æµ‹è¯•åŒ…" class="headerlink" title="å¯ä»¥åœ¨åŒä¸€ä¸ªåŒ…ä¸‹æœ‰ä¸åŒçš„æµ‹è¯•åŒ…"></a>å¯ä»¥åœ¨åŒä¸€ä¸ªåŒ…ä¸‹æœ‰ä¸åŒçš„æµ‹è¯•åŒ…</h1><p>åœ¨ Go ä¸­æˆ‘é€šå¸¸è®¤ä¸ºä¸€ä¸ªç›®å½•ä¸‹åªèƒ½æœ‰ä¸€ä¸ªåŒ…ï¼Œä½†ä¹Ÿä¸æ˜¯å®Œå…¨æ­£ç¡®çš„ã€‚</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªåŒ…åä¸ºï¼š<code>yourpackage</code> æ­¤æ—¶ä½ å¯ä»¥è¿˜å¯ä»¥åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º <code>yourpackage_test</code> çš„åŒ…ï¼ŒåŒæ—¶åœ¨è¿™ä¸ªåŒ…é‡Œç¼–å†™ä½ çš„æµ‹è¯•ä»£ç ã€‚</p><p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œé‚£äº›æ²¡æœ‰è¢« exporter çš„å‡½æ•°åœ¨ <code>yourpackage_test</code> åŒ…ä¸‹æ˜¯ä¸èƒ½ç›´æ¥è®¿é—®çš„ï¼Œç¡®ä¿æµ‹è¯•çš„æ˜¯è¢«æš´éœ²çš„å‡½æ•°ã€‚</p><h1 id="å¤šæ¬¡ä¼ é€’ç›¸åŒå‚æ•°çš„ç®€å•æ–¹æ³•"><a href="#å¤šæ¬¡ä¼ é€’ç›¸åŒå‚æ•°çš„ç®€å•æ–¹æ³•" class="headerlink" title="å¤šæ¬¡ä¼ é€’ç›¸åŒå‚æ•°çš„ç®€å•æ–¹æ³•"></a>å¤šæ¬¡ä¼ é€’ç›¸åŒå‚æ•°çš„ç®€å•æ–¹æ³•</h1><p>åœ¨ä½¿ç”¨å­—ç¬¦ä¸²æ ¼å¼åŒ–å‡½æ•°æ—¶ï¼Œæˆ‘æ€»æ˜¯è§‰å¾—å¿…é¡»é‡å¤ä¸€ä¸ªå¤šæ¬¡ä½¿ç”¨çš„å‚æ•°å¾ˆçƒ¦äººï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    name := <span class="string">&quot;Bob&quot;</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;My name is %s. Yes, you heard that right: %s\n&quot;</span>, name, name)</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>è¿˜å¥½è¿˜æœ‰æ›´ç®€ä¾¿çš„æ–¹æ³•ï¼Œè¿™æ ·åªéœ€è¦ä¼ é€’ä¸€æ¬¡å‚æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">name := <span class="string">&quot;Bob&quot;</span>  </span><br><span class="line">fmt.Printf(<span class="string">&quot;My name is %[1]s. Yes, you heard that right: %[1]s\n&quot;</span>, name)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ª Twitter é‡Œå‘ç°çš„ï¼š<br><img src="https://s2.loli.net/2024/07/02/vaMP9CXwTEFcGKI.png"></p><p>å¸Œæœ›ä½ ä»Šå¤©å­¦åˆ°äº†ä¸€äº›æ–°ä¸œè¥¿ï¼Œæœ€è¿‘æœ‰æ²¡æœ‰å‘ç°ä¸€äº›ä½ ä»æ¥ä¸çŸ¥é“çš„ Golang å°æŠ€å·§ï¼Ÿ</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åŸæ–‡é“¾æ¥ï¼š&lt;a href=&quot;https://medium.com/@andreiboar/5-small-tips-i-recently-learned-in-go-cf52d50cf129&quot;&gt;https:&amp;#x2F;&amp;#x2F;medium.com&amp;#x2F;@andreiboar&amp;#x2F;5-small-tips-i-recently-learned-in-go-cf52d50cf129&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡&quot;&gt;&lt;a href=&quot;#è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡&quot; class=&quot;headerlink&quot; title=&quot;è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡&quot;&gt;&lt;/a&gt;è®©ç¼–è¯‘å™¨è®¡ç®—æ•°ç»„æ•°é‡&lt;/h1&gt;&lt;p&gt;æˆ‘ä»¬åœ¨ Go é€šå¸¸å¾ˆå°‘ä½¿ç”¨æ•°ç»„ arraysï¼Œä¸€èˆ¬ä½¿ç”¨åˆ‡ç‰‡ Slice æ¥ä»£æ›¿ï¼›&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯å½“ä½ éœ€è¦ä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æœä½ å¯¹éœ€è¦æŒ‡å®šæ•°é‡å¤§å°æ„Ÿåˆ°å¾ˆçƒ¦æ—¶å¯ä»¥ä½¿ç”¨ &lt;code&gt;[...]&lt;/code&gt; è®©ç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬è®¡ç®—æ•°ç»„å¤§å°ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;fmt&amp;quot;&lt;/span&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;arr := [&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&amp;#125;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sameArr := [...]&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&amp;#125; &lt;span class=&quot;comment&quot;&gt;// Use ... instead of 3  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Arrays are equivalent  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(arr)  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(sameArr)  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/"/>
    
    <category term="Go" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/Go/"/>
    
    
    <category term="Go" scheme="http://crossoverjie.top/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•æ‰¾åˆ°å¹¶å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®</title>
    <link href="http://crossoverjie.top/2024/07/01/ob/how-to-involve-OpenSource/"/>
    <id>http://crossoverjie.top/2024/07/01/ob/how-to-involve-OpenSource/</id>
    <published>2024-07-01T02:55:00.000Z</published>
    <updated>2024-07-31T02:19:26.123Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥å‰æœ‰å†™è¿‡ä¸¤ç¯‡æ–‡ç« æ¥ç®€å•èŠè¿‡å¦‚ä½•åšå¼€æºçš„äº‹æƒ…ï¼Œæœ€è¿‘æˆ‘è‡ªå·±ç»„äº†ä¸€ä¸ªç¤¾åŒºé‡Œé¢ä¹Ÿæœ‰ä¸å°‘æœ‹å‹å¯¹å¼€æºæ„Ÿå…´è¶£ï¼Œäºæ˜¯æˆ‘ä¾¿æ ¹æ®è‡ªå·±çš„ç»éªŒç³»ç»Ÿçš„æ¢³ç†äº†ä¸€äº›å…³äºå¼€æºçš„äº‹æƒ…ã€‚</p><ul><li><a href="https://crossoverjie.top/2023/08/05/ob/novice-contribute-open-source/">æ–°æ‰‹å¦‚ä½•å¿«é€Ÿå‚ä¸å¼€æºé¡¹ç›®</a></li><li><a href="https://crossoverjie.top/2024/01/25/ob/create-a-plugin-for-cprobe/">æ‰‹æŠŠæ‰‹æ•™ä½ ä¸ºå¼€æºé¡¹ç›®è´¡çŒ®ä»£ç </a></li></ul><blockquote><p>æœ‰å…´è¶£çš„å¯ä»¥å…ˆçœ‹çœ‹ä¹‹å‰è¿™ä¸¤ç¯‡ã€‚</p></blockquote><span id="more"></span><h1 id="ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®"><a href="#ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®" class="headerlink" title="ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®"></a>ğŸ”å¦‚ä½•æ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®</h1><p>é¦–å…ˆç¬¬ä¸€æ­¥å…ˆæƒ³æ¸…æ¥šè‡ªå·±æå¼€æºçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼š</p><ul><li>å‚è€ƒç¤¾åŒºå¤§ä½¬çš„ä»£ç ï¼Œæå‡æŠ€æœ¯</li><li>ä¸°å¯Œä¸ªäººå±¥å†ï¼Œæé«˜é¢è¯•é€šè¿‡ç‡<ul><li>æ›´åŠŸåˆ©ä¸€ç‚¹å°±æ˜¯æƒ³æˆä¸ºæŸä¸ªé¡¹ç›®çš„ <code>Committer</code>&#x2F;<code>PMC</code></li></ul></li><li>å•çº¯å–œæ¬¢åˆ†äº«ï¼Œçƒ­çˆ±å¼€æºï¼Œè®¤å¯å¼€æºæ”¹å˜ä¸–ç•ŒğŸ’ªã€‚</li></ul><p>æˆ‘è®¤ä¸ºå‰é¢ä¸‰ç§éƒ½æ˜¯ä¸€ä¸ªç›®çš„ï¼Œæå‡è‡ªå·±è·å¾—åç»­çš„å¥½å¤„ï¼›æœ€åä¸€ç§åˆ™æ˜¯å¦¥å¦¥çš„çº¯çƒ­çˆ±ã€‚</p><p>ä»¥æˆ‘ä¸ªäººæ¥è¯´ï¼Œæˆ‘ä¸¤è€…éƒ½æ²¾ä¸€ç‚¹ï¼›æˆ‘ç›¸ä¿¡å¤§éƒ¨åˆ†äººéƒ½æ˜¯å‰é¢ä¸‰ç±»çš„ç›®çš„ï¼Œåˆ°è¿™é‡Œæˆ‘å¯èƒ½è¦å…ˆæµ‡ç‚¹å†·æ°´ã€‚</p><blockquote><p>å¾€å¾€ä¸€ä¸ªå¼€æºé¡¹ç›®ä»ä½ ç†Ÿæ‚‰å®ƒå¼€å§‹åˆ°æç¬¬ä¸€ä¸ª PR ç„¶ååˆ°åˆå¹¶ä¸­é—´ç»å†çš„æ—¶é—´å¯èƒ½æ˜¯å¤§å¤§è¶…å‡ºä½ çš„é¢„æœŸçš„ã€‚</p></blockquote><p>ç‰¹åˆ«æ˜¯è¶Šå¤§å‹è¶Šä¸“ä¸šçš„é¡¹ç›®ï¼ˆæˆ‘ç›¸ä¿¡ä½ ä¹Ÿæ˜¯æƒ³åŠ å…¥è¿™ç±»æœ‰ä¸€å®šçŸ¥ååº¦çš„é¡¹ç›®ï¼‰ã€‚</p><p>å› ä¸ºå¼€æºç¤¾åŒºå¤§éƒ¨åˆ†éƒ½æ˜¯æ‰§è¡Œå¼‚æ­¥æ²Ÿé€šï¼Œä¸å³æ—¶é€šè®¯çš„å¿«é€Ÿåé¦ˆä¸åŒï¼Œç”šè‡³è¿˜æœ‰ä¸å°‘ reviewer å¤„äºä¸åŒçš„æ—¶åŒºã€‚</p><p>æ‰€ä»¥ä¸€å¼€å§‹å°±æƒ³åšå¥½å¿ƒç†é¢„æœŸï¼Œä¸è¦æŒ‡æœ›ç€æˆ‘ç»™æŸä¸ªé¡¹ç›®æäº¤ä¸€ä¸ªå¾ˆç‰›é€¼çš„åŠŸèƒ½ï¼Œç„¶åä»–ä»¬å¿«é€Ÿ review åˆå¹¶ï¼Œç„¶åç»™ä½  commit æƒé™ã€‚</p><p>è€Œä¸”æœ‰ä¸å°‘å¼€æºé¡¹ç›®æ˜¯ç”±æŸä¸€ä¸ªå…¬å¸ä¸»å¯¼çš„ï¼Œæ¯”å¦‚ï¼ˆPulsarã€Golangã€Kafkaï¼‰ï¼Œä»–ä»¬å¯èƒ½å¯¹äºå¤–éƒ¨ç¤¾åŒºæ¥çš„æ–°æ‰‹å¹¶ä¸é‚£ä¹ˆä¸Šå¿ƒï¼Œä¸€ä¸ª PR æ™¾åœ¨é‚£é‡Œå‡ ä¸ªæœˆæ²¡äººç†éƒ½æ˜¯å¾ˆæ­£å¸¸çš„ã€‚</p><p>æ‰€ä»¥æˆ‘å»ºè®®ä¸€å¼€å§‹é€‰æ‹©çš„é¡¹ç›®æœ‰ä»¥ä¸‹å‡ ä¸ªç­›é€‰æ ‡å‡†ï¼š</p><ul><li>å°½é‡æ˜¯è‡ªå·±æ—¥å¸¸åœ¨ç”¨ï¼Œç†Ÿæ‚‰çš„é¡¹ç›®ã€‚</li><li>æœ€è¿‘æœ‰åœ¨åŠæ—¶æ›´æ–°ç»´æŠ¤çš„é¡¹ç›®ã€‚</li><li>å¯¹ç¤¾åŒºæ–°äººçš„æ¥çº³ç¨‹åº¦æ˜¯å¦è¶³å¤ŸåŒ…å®¹ã€‚<ul><li>è¿™ç‚¹å¯ä»¥åœ¨ Github é‡ŒæŸ¥æ‰¾æ ‡ç­¾ä¸º <code>help want/contribution welcome</code> çš„ issue æˆ–è€…æ˜¯ PRã€‚</li><li>æŸ¥çœ‹è¿™äº› issue&#x2F; PR æœ€è¿‘çš„æ´»è·ƒæ—¶é—´ï¼Œè´¡çŒ®è€…æ˜¯å¦ä¸ºæ–°äººã€‚</li><li>å¾€å¾€ä¸€ä¸ªåŒ…å®¹åº¦è¾ƒé«˜çš„é¡¹ç›®ä»¥ä¸Šä¿¡æ¯éƒ½æ˜¯å¾ˆæ´»è·ƒçš„ã€‚</li></ul></li><li>é¡¹ç›®ä¸»è¦ç»´æŠ¤è€…æ˜¯å¦æ¥ç€ä¸åŒçš„å…¬å¸ï¼Œæ˜¯å¦è¶³å¤Ÿæ´»è·ƒã€‚</li></ul><p><img src="https://s2.loli.net/2024/05/25/PIL8a5CoMbxRiwJ.png"><br><img src="https://s2.loli.net/2024/05/25/7CQaVFiAR4tyMbs.png"></p><p>æ¨èå‡ ä¸ªæˆ‘è®¤ä¸ºæ¯”è¾ƒç¬¦åˆæˆ‘åˆšæ‰æåˆ°çš„æ¡ä»¶çš„é¡¹ç›®ï¼š</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/7195">https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/7195</a></li><li><a href="https://github.com/apache/pulsar-client-go/issues?q=is:open+label:type/feature+sort:updated-desc">https://github.com/apache/pulsar-client-go/issues?q=is%3Aopen+label%3Atype%2Ffeature+sort%3Aupdated-desc</a></li><li><a href="https://github.com/apache/hertzbeat/">https://github.com/apache/hertzbeat/</a></li></ul><h1 id="ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®"><a href="#ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®" class="headerlink" title="ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®"></a>ğŸ–å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªå¼€æºé¡¹ç›®</h1><p>å¦‚æœæ‰¾åˆ°äº†è‡ªå·±æƒ³è´¡çŒ®çš„é¡¹ç›®ï¼Œå¦‚æœè‡ªå·±è¿˜ä¸å¤ªç†Ÿæ‚‰çš„è¯ï¼Œé‚£å°±å¯ä»¥å°è¯•ä»¥ä¸‹æ­¥éª¤æ¥å¿«é€Ÿä¸Šæ‰‹å®ƒã€‚</p><h2 id="âœ…å•å…ƒæµ‹è¯•"><a href="#âœ…å•å…ƒæµ‹è¯•" class="headerlink" title="âœ…å•å…ƒæµ‹è¯•"></a>âœ…å•å…ƒæµ‹è¯•</h2><p>é¦–å…ˆç¬¬ä¸€ä¸ªå°±æ˜¯å•å…ƒæµ‹è¯•ï¼Œå•å…ƒæµ‹è¯•æ˜¯ä¸€ä¸ªéå¸¸ä¸é”™çš„æ–¹å¼æ¥ä¸Šæ‰‹ä¸€ä¸ªæ–°çš„å¼€æºé¡¹ç›®ï¼Œ<strong>ä½†é‡ç‚¹ä¸æ˜¯å»çœ‹ç°æœ‰çš„å•æµ‹ï¼Œè€Œæ˜¯è‡ªå·±å»å†™âœï¸</strong>ã€‚</p><p>å†™è¿‡å•å…ƒæµ‹è¯•çš„å°ä¼™ä¼´å°±çŸ¥é“ï¼Œå¦‚æœè¦è¾¾åˆ° 90% ä»¥ä¸Šçš„è¦†ç›–ç‡æ—¶éœ€è¦å¯¹è‡ªå·±å†™çš„æ¯ä¸€è¡Œä»£ç éƒ½å¾—äº†è§£ï¼Œç”šè‡³åœ¨å†™çš„è¿‡ç¨‹ä¸­ä¼šå‘ç°éƒ¨åˆ†ä»£ç æ˜¯ä¸æ˜¯æ²¡æœ‰å¿…è¦ï¼Œä»è€Œå†å¸®åŠ©è‡ªå·±æ¢³ç†ä¸€éä¸šåŠ¡ã€‚</p><p>æ‰€ä»¥å†™å•æµ‹ç¡®å®æ˜¯å¿«é€Ÿç†Ÿæ‚‰æŸä¸ªé¡¹ç›®çš„æ–¹æ³•ï¼Œä½†è¿™é’ˆå¯¹äºä¸€äº›é€»è¾‘ç®€å•çš„é¡¹ç›®ï¼›å¯¹äºä¸€äº›ä¸šåŠ¡å¤æ‚çš„é¡¹ç›®å»ºè®®è¿˜æ˜¯å¿«é€Ÿè·‘é€šå®˜æ–¹æ¨èä¸€ä¸ªåŠŸèƒ½ã€‚</p><h2 id="ğŸŒŸä»¥-Pulsar-ä¸ºä¾‹"><a href="#ğŸŒŸä»¥-Pulsar-ä¸ºä¾‹" class="headerlink" title="ğŸŒŸä»¥ Pulsar ä¸ºä¾‹"></a>ğŸŒŸä»¥ Pulsar ä¸ºä¾‹</h2><p>ä»¥ <a href="https://pulsar.apache.org/">Apache Pulsar</a>ä¸ºä¾‹ï¼Œé‚£å°±å…ˆè·‘ä¸€ä¸ªæ¶ˆæ¯çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€… demoï¼›è·‘é€šäº†ä¹‹åå†å°è¯•çœ‹çœ‹å®ƒå®¢æˆ·ç«¯å·²æœ‰çš„å•æµ‹ä»£ç ï¼Œç„¶åå°è¯•æ”¹ä¸€äº›æ–­è¨€ï¼Œæ­¤æ—¶å°±ä¼šå‘ç°é¢„æœŸå€¼ä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆå®šä¹‰ã€‚<br><a href="https://github.com/apache/pulsar/blob/631b13ad23d7e48c6e82d38f97c23d129062cb7c/pulsar-broker/src/test/java/org/apache/pulsar/client/impl/BrokerClientIntegrationTest.java#L1077">https://github.com/apache/pulsar/blob/631b13ad23d7e48c6e82d38f97c23d129062cb7c/pulsar-broker/src/test/java/org/apache/pulsar/client/impl/BrokerClientIntegrationTest.java#L1077</a><br><img src="https://s2.loli.net/2024/05/17/CrITHSWeY1sP8dL.png"></p><p><img src="https://s2.loli.net/2024/05/17/J6DmLxQMZvuAqW7.png"></p><p>æ¯”å¦‚è¿™é‡Œçš„ä¸€ä¸ª consumer å–æ¶ˆè®¢é˜…ä¸¤æ¬¡æ—¶å€™å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å¼‚å¸¸çš„åœ°æ–¹æ‰¾åˆ°æºç é‡Œå¯¹è¿æ¥çŠ¶æ€çš„åˆ¤æ–­æ¡ä»¶ã€‚</p><p>å°±å¯ä»¥å¾—çŸ¥ï¼šå½“å®¢æˆ·ç«¯å–æ¶ˆè®¢é˜…æ—¶ä¼šä¿®æ”¹è¿æ¥çŠ¶æ€ã€‚</p><h2 id="ğŸ’“HertzBeat"><a href="#ğŸ’“HertzBeat" class="headerlink" title="ğŸ’“HertzBeat"></a>ğŸ’“HertzBeat</h2><p>ä¸‹é¢ä»¥ <a href="https://hertzbeat.apache.org/">Apache HertzBeat</a>ä¸ºä¾‹æ¥çœ‹çœ‹å½“æ—¶æˆ‘æ˜¯å¦‚ä½•è´¡çŒ®å•å…ƒæµ‹è¯•çš„ã€‚</p><p><img src="https://s2.loli.net/2024/05/17/dixDGIQO2sZfh98.png"><br>é€šè¿‡å®˜æ–¹çš„æ¶æ„å›¾å¯ä»¥å¾—çŸ¥ HertzBeat æ˜¯é€šè¿‡ä¸€ä¸ª collector å»ç›´è¿ç›®æ ‡é‡‡é›†æ•°æ®çš„ã€‚</p><p>æ¯”å¦‚é€šè¿‡ Redis çš„å®¢æˆ·ç«¯å»è·å–ç›‘æ§æ•°æ®ï¼Œç„¶åå†å­˜æ”¾åˆ°è‡ªå·±çš„æ—¶åºæ•°æ®åº“ä¸­è¿›è¡Œå±•ç¤ºã€‚</p><p>æ‰€ä»¥è¿™ä¸ªé‡‡é›†çš„è¿‡ç¨‹å°±æ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä»–çš„æ¥å£å®šä¹‰ã€‚</p><p><img src="https://s2.loli.net/2024/05/17/3quVop5vSr6KzPY.png"><br>ä¸€å…±å°±ä¸‰ä¸ªæ¥å£ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>collecté‡‡é›†æ¥å£ï¼šåœ¨ Metrics ä¸­å®šä¹‰äº†é‡‡é›†çš„ç›®æ ‡ä¿¡æ¯ï¼ˆåœ°å€ã€ç«¯å£ç­‰ï¼‰<ul><li>é‡‡é›†å®Œåçš„æ•°æ®å†™å…¥åˆ° Builder ä¾›åç»­çš„å†™å…¥å­˜å‚¨</li></ul></li><li>preCheckï¼šæå‰åšä¸€äº›å‚æ•°æ ¡éªŒ</li><li>supportProtocolï¼šè¿”å›å®šä¹‰çš„åè®®ç±»å‹ï¼Œé€šè¿‡è¿™ä¸ªç±»å‹æ‰¾åˆ°å¯¹åº”é‡‡é›†å™¨</li></ul><p><img src="https://s2.loli.net/2024/05/17/hQZaFV2qo3176uf.png"></p><p>ç„¶åå°±äº¤ç”±ä¸åŒçš„å®ç°ç±»å»é‡‡é›†ä¸åŒçš„æŒ‡æ ‡ã€‚</p><p>è¿™é‡Œæˆ‘ä»¥ <code>RedisCommonCollectImpl</code>ä¸ºä¾‹ï¼Œä¸»è¦çš„å•æµ‹é€»è¾‘å°±æ˜¯æ¨¡æ‹Ÿ Redis å®¢æˆ·ç«¯çš„è¿”å›æ•°æ®ï¼Œç„¶ååœ¨ Collect çš„ä»£ç é‡ŒæŸ¥çœ‹ä¸åŒçš„å¤„ç†é€»è¾‘ï¼Œå…¶å®å°±æ˜¯è¦è¦†ç›–å„ç§åˆ†æ”¯ä»¥åŠå¼‚å¸¸çš„æƒ…å†µã€‚</p><p>æœ€åå†æ–­è¨€é‡‡é›†åˆ°çš„æ•°æ®ä¸é¢„æœŸæ˜¯å¦åŒ¹é…å³å¯ï¼Œè´´ä¸€æ®µæ ¸å¿ƒé€»è¾‘ï¼š<br><img src="https://s2.loli.net/2024/05/17/EnrZxdDR5kLtMIG.png"></p><p>è‡³äºåº”è¯¥è¿”å›ä»€ä¹ˆé¢„æœŸç»“æœï¼Œæœ‰äº› collector å¯èƒ½ä¼šåœ¨ä»£ç æ³¨é‡Šé‡Œå†™æ¸…æ¥šï¼Œä½†è¿™ä¸ª Redis æ²¡æœ‰å†™ã€‚</p><p>ä¸è¿‡ä¹Ÿæœ‰åŠæ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»£ç åœ¨æœ¬åœ°è·‘èµ·æ¥ä¹‹åè¿›å…¥ç®¡ç†å°æŸ¥çœ‹å†…ç½®çš„ç›‘æ§æ¨¡ç‰ˆã€‚</p><p><img src="https://s2.loli.net/2024/05/17/g4EL7AdGfbrpXKU.png"><br>è¿™é‡Œæ˜¯ç”¨äºå®šä¹‰ä¼šç›‘æ§å“ªäº›å­—æ®µçš„åœ°æ–¹ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä»£ç é¢„å…ˆç”Ÿæˆå¥½é¢„æœŸè¿”å›å€¼äº†ã€‚</p><p><img src="https://s2.loli.net/2024/05/17/OCEYUZHscP6waI3.png"></p><p>å…·ä½“çš„å•æµ‹ä»£ç è¯·çœ‹è¿™é‡Œï¼š<br><a href="https://github.com/apache/hertzbeat/blob/master/collector/src/test/java/org/apache/hertzbeat/collector/collect/redis/RedisClusterCollectImplTest.java#L46">https://github.com/apache/hertzbeat/blob/master/collector/src/test/java/org/apache/hertzbeat/collector/collect/redis/RedisClusterCollectImplTest.java#L46</a></p><h1 id="ğŸ“æ€»ç»“"><a href="#ğŸ“æ€»ç»“" class="headerlink" title="ğŸ“æ€»ç»“"></a>ğŸ“æ€»ç»“</h1><p>å‚ä¸ä¸€ä¸ªæˆç†Ÿç¤¾åŒºçš„å¼€æºæœ‰ä¸€ç‚¹ä¸€å®šè¦è®°ä½ï¼Œ<strong>å°±æ˜¯è¦ä»”ç»†é˜…è¯»<a href="https://hertzbeat.apache.org/zh-cn/docs/community/contribution">è´¡çŒ®è€…æ–‡æ¡£</a>ã€‚</strong></p><p>é‡Œé¢å¾€å¾€ä¼šå†™æ¸…æ¥šå¦‚ä½•æ„å»ºä»£ç ã€ä»£ç è§„èŒƒã€æäº¤è§„èŒƒç­‰ä¿¡æ¯ï¼Œè¿™äº›éƒ½æ‹æ¸…æ¥šåæäº¤çš„ PR æ‰æ›´å®¹æ˜“è¢«ç¤¾åŒºæ¥å—ã€‚</p><p>åé¢ä¼šç»§ç»­æ›´æ–°é›†æˆæµ‹è¯•ä¸ <code>e2e</code> æµ‹è¯•ç­‰å†…å®¹ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»¥å‰æœ‰å†™è¿‡ä¸¤ç¯‡æ–‡ç« æ¥ç®€å•èŠè¿‡å¦‚ä½•åšå¼€æºçš„äº‹æƒ…ï¼Œæœ€è¿‘æˆ‘è‡ªå·±ç»„äº†ä¸€ä¸ªç¤¾åŒºé‡Œé¢ä¹Ÿæœ‰ä¸å°‘æœ‹å‹å¯¹å¼€æºæ„Ÿå…´è¶£ï¼Œäºæ˜¯æˆ‘ä¾¿æ ¹æ®è‡ªå·±çš„ç»éªŒç³»ç»Ÿçš„æ¢³ç†äº†ä¸€äº›å…³äºå¼€æºçš„äº‹æƒ…ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://crossoverjie.top/2023/08/05/ob/novice-contribute-open-source/&quot;&gt;æ–°æ‰‹å¦‚ä½•å¿«é€Ÿå‚ä¸å¼€æºé¡¹ç›®&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://crossoverjie.top/2024/01/25/ob/create-a-plugin-for-cprobe/&quot;&gt;æ‰‹æŠŠæ‰‹æ•™ä½ ä¸ºå¼€æºé¡¹ç›®è´¡çŒ®ä»£ç &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ‰å…´è¶£çš„å¯ä»¥å…ˆçœ‹çœ‹ä¹‹å‰è¿™ä¸¤ç¯‡ã€‚&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
  </entry>
  
  <entry>
    <title>OpenTelemetry æ·±åº¦å®šåˆ¶ï¼šè·¨æœåŠ¡è¿½è¸ªçš„å®æˆ˜æŠ€å·§</title>
    <link href="http://crossoverjie.top/2024/06/26/ob/OpenTelemetry-custom-instrument/"/>
    <id>http://crossoverjie.top/2024/06/26/ob/OpenTelemetry-custom-instrument/</id>
    <published>2024-06-26T11:58:03.000Z</published>
    <updated>2024-07-01T01:33:40.464Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p><img src="https://s2.loli.net/2024/05/19/7CnOFegSu4TLbhd.png"></p><p>åœ¨ä¸Šä¸€ç¯‡<a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">ã€Šä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…ã€‹</a>ä¸­åœ¨æœ€åæåˆ°åœ¨åšä¸€äº› Trace çš„å®šåˆ¶å¼€å‘ã€‚</p><p>åˆ°ç°åœ¨å·®ä¸å¤šç®—æ˜¯å®Œæˆäº†ï¼Œå¯ä»¥å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚</p><p>æˆ‘ä»¬çš„éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://s2.loli.net/2024/05/19/qex6IFcOnQ591gT.png"><br>å‡è®¾ç°åœ¨æœ‰ä¸‰ä¸ªæœåŠ¡ï¼šServiceAã€ServiceBã€ServiceC</p><span id="more"></span><p><code>ServiceA</code> å¯¹å¤–æä¾›äº†ä¸€ä¸ª http æ¥å£ <code>request</code>ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¼šè°ƒç”¨ <code>ServiceB</code> çš„ <code>order</code> è®¢å•æ¥å£åˆ›å»ºè®¢å•ï¼ŒåŒæ—¶ <code>serviceB</code> è°ƒç”¨ <code>serviceC</code> çš„ pay æ¥å£ã€‚</p><p><img src="https://s2.loli.net/2024/05/19/GtljX3BLVcePWFn.png"><br>æ•´ä¸ªè°ƒç”¨å…³ç³»å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ span ä¸­çš„ attribute ä¼šè®°å½•å½“å‰ span çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š<br><img src="https://s2.loli.net/2024/05/19/tvgdT1Mke7OjPGp.png"><br>è¿™äº›éƒ½æ˜¯å½“å‰ä¸€äº›å½“å‰ span å†…ç½®çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å½“å‰ gRPC æ¥å£çš„ä¸€äº›åŸºæœ¬æ•°æ®ï¼šæœåŠ¡åã€ipã€ç«¯å£ç­‰ä¿¡æ¯ã€‚</p><p>ä½†è¿™é‡Œå¹¶æ²¡æœ‰ä¸Šæ¸¸çš„ä¸€äº›ä¿¡æ¯ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ Jaeger çš„æ ‘çŠ¶å›¾å¾—çŸ¥ä¸Šæ¸¸æ˜¯å“ªä¸ªåº”ç”¨è°ƒç”¨è¿‡æ¥çš„ï¼Œä½†æ˜¯ä¸€æ—¦æŸä¸ª span ä¸‹æœ‰å¤šä¸ªå­ span çš„è°ƒç”¨ï¼Œå°±æ²¡åŠæ³•å¾ˆç›´è§‚çŸ¥é“è¿™ä¸ªå­ span çš„ä¸Šæ¸¸æ˜¯ç”±è°å‘èµ·çš„è°ƒç”¨ã€‚</p><p>æ¯”å¦‚å¦‚ä¸‹è¿™ä¸ªé“¾è·¯ï¼š<br><img src="https://s2.loli.net/2024/05/19/3rOdKfBmhSjz1GF.png"><br>å½“ä¸€ä¸ªè°ƒç”¨é“¾éå¸¸é•¿ï¼ŒåŒæ—¶ä¹Ÿéå¸¸å¤æ‚æ—¶ï¼Œæ²¡åŠæ³•ç¬¬ä¸€æ—¶é—´çŸ¥é“æŸä¸€ä¸ª span çš„ä¸Šæ¸¸åˆ°åº•æ˜¯è°å‘èµ·çš„ï¼Œéœ€è¦æ‰‹åŠ¨ä¸€å±‚å±‚çš„å»æŠ˜å ï¼Œæˆ–è€…å…¨é çœ¼ç›å»æ‰¾ã€‚</p><h2 id="é¢„æœŸæ•ˆæœ"><a href="#é¢„æœŸæ•ˆæœ" class="headerlink" title="é¢„æœŸæ•ˆæœ"></a>é¢„æœŸæ•ˆæœ</h2><p><img src="https://s2.loli.net/2024/05/19/9v3cGMrez8XA2ZH.png"></p><p>ä¸ºæ­¤æˆ‘ä»¬å¸Œæœ›çš„æ•ˆæœæ˜¯å¯ä»¥é€šè¿‡ç»™æ¯ä¸€ä¸ªå­ span ä¸­åŠ å…¥ä¸¤ä¸ª attributeï¼Œæ¥æ ‡æ˜å®ƒçš„çˆ¶è°ƒç”¨æ¥æºã€‚</p><p>æ¯”å¦‚åœ¨ serviceB ä¸­çš„æ‰€æœ‰ span ä¸­éƒ½ä¼šåŠ ä¸Šä¸¤ä¸ªæ ‡ç­¾ï¼šæ¥æºæ˜¯ serviceAï¼ŒåŒæ—¶æ˜¯ serviceA çš„ request æ¥å£å‘èµ·çš„è¯·æ±‚ã€‚</p><p>è€Œåœ¨ serviceC ä¸­åŒæ ·å¯ä»¥çŸ¥é“æ¥æºæ˜¯ serviceB çš„ Order æ¥å£å‘èµ·çš„è°ƒç”¨ã€‚</p><p>æˆ‘å¯åŠ¨äº†ä¸‰ä¸ª demo åº”ç”¨ï¼Œåˆ†åˆ«æ˜¯ create1ï¼Œcreate2ï¼Œcreate3.</p><p>create1 ä¸­ä¼šæä¾›ä¸€ä¸ª <code>request</code> æ¥å£ï¼Œåœ¨è¿™é‡Œé¢è°ƒç”¨ create2 çš„ <code>create2</code> æ¥å£ï¼Œ<code>create2</code> çš„æ¥å£é‡Œæ¥ç€è°ƒç”¨ create3 çš„ <code>create3</code> æ¥å£ã€‚</p><p>create1ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line">   <span class="type">HelloRequest</span> <span class="variable">request</span> <span class="operator">=</span> HelloRequest.newBuilder()  </span><br><span class="line">         .setName(name)  </span><br><span class="line">         .build();  </span><br><span class="line">   log.info(<span class="string">&quot;request: &#123;&#125;&quot;</span>, request);  </span><br><span class="line">   <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> myServiceStub.create2(request).getMessage();  </span><br><span class="line">   Executors.newFixedThreadPool(<span class="number">1</span>).execute(() -&gt; &#123;  </span><br><span class="line">      myServiceStub.create2(request).getMessage();  </span><br><span class="line">   &#125;);       <span class="keyword">return</span> message;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>create2:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create2</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> &#123;  </span><br><span class="line">    <span class="type">HelloReply</span> <span class="variable">reply</span> <span class="operator">=</span> HelloReply.newBuilder()  </span><br><span class="line">            .setMessage(<span class="string">&quot;Create2 ==&gt; &quot;</span> + request.getName())  </span><br><span class="line">            .build();  </span><br><span class="line">    log.info(<span class="string">&quot;Create2: &#123;&#125;&quot;</span>, reply.getMessage());  </span><br><span class="line">    myMethod(request.getName());  </span><br><span class="line">    myServiceStub.create3(request);</span><br><span class="line">    responseObserver.onNext(reply);  </span><br><span class="line">    responseObserver.onCompleted();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>create3:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create3</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> &#123;  </span><br><span class="line">    <span class="type">HelloReply</span> <span class="variable">reply</span> <span class="operator">=</span> HelloReply.newBuilder()  </span><br><span class="line">            .setMessage(<span class="string">&quot;Create3 ==&gt; &quot;</span> + request.getName())  </span><br><span class="line">            .build();  </span><br><span class="line">    log.info(<span class="string">&quot;Create3: &#123;&#125;&quot;</span>, reply.getMessage());  </span><br><span class="line">    myMethod(request.getName());  </span><br><span class="line">    responseObserver.onNext(reply);  </span><br><span class="line">    responseObserver.onCompleted();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.javaagent.extensions=otel-extensions-custom-context-1.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.traces.exporter=otlp \</span><br><span class="line">-Dotel.logs.exporter=none \</span><br><span class="line">-Dotel.service.name=create2 \</span><br><span class="line">-Dotel.exporter.otlp.protocol=grpc \</span><br><span class="line">-Dotel.propagators=tracecontext,baggage,demo \</span><br><span class="line">-Dotel.exporter.otlp.endpoint=http://127.0.0.1:5317 \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar --spring.application.name=create2 --server.port=9191 --grpc.server.port=9292 --grpc.client.myService.address=static://127.0.0.1:9393</span><br></pre></td></tr></table></figure><p>åªæ˜¯æ¯ä¸ªåº”ç”¨éƒ½éœ€è¦ä½¿ç”¨æˆ‘è¿™è¾¹å•ç‹¬æ‰“çš„ agent åŒ…ä»¥åŠä¸€ä¸ª <code>extension</code>(tel-extensions-custom-context-1.0-SNAPSHOT.jar) æ‰èƒ½ç”Ÿæ•ˆã€‚</p><p>æœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/05/19/4o5mEhjnMbZWL62.png"></p><h1 id="Baggage"><a href="#Baggage" class="headerlink" title="Baggage"></a>Baggage</h1><p>åœ¨è®²å…·ä½“çš„å®ç°ä¹‹å‰éœ€è¦å…ˆäº†è§£å‡ ä¸ª Trace ä¸­çš„æ¦‚å¿µï¼Œåœ¨è¿™é‡Œä¸»è¦ç”¨åˆ°çš„æ˜¯ä¸€ä¸ªç§°ä¸º Baggage çš„å¯¹è±¡ã€‚</p><p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å…¶å®æåˆ°è¿‡å®ƒçš„åŸç†ä»¥åŠä½¿ç”¨åœºæ™¯ï¼š<br><a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/?highlight=%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E6%97%85#Baggage">ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</a></p><p><img src="https://s2.loli.net/2024/05/19/gv2YEoO6LkiGIF9.png"></p><p>Baggage çš„ä¸­æ–‡ç¿»è¯‘æ˜¯ï¼šåŒ…è£¹ğŸ“¦ï¼›ç®€å•æ¥è¯´å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ baggage å¯ä»¥å°†æˆ‘ä»¬æƒ³è¦çš„æ•°æ®å­˜æ”¾åœ¨å…¶ä¸­ï¼Œè¿™æ ·å†æ•´ä¸ª Trace çš„ä»»æ„ä¸€ä¸ª Span ä¸­éƒ½å¯ä»¥è¯»å–åˆ°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line"><span class="comment">// å†™å…¥</span></span><br><span class="line">    Baggage.current().toBuilder().  </span><br><span class="line">          put(<span class="string">&quot;request.name&quot;</span>, name).build()  </span><br><span class="line">          .storeInContext(Context.current()).makeCurrent();</span><br><span class="line">&#125;         </span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–</span></span><br><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> Baggage.current().getEntryValue(<span class="string">&quot;request.name&quot;</span>);  </span><br><span class="line">log.info(<span class="string">&quot;request.name: &#123;&#125;&quot;</span>, value);</span><br></pre></td></tr></table></figure><p>ç†è§£äº†è¿™ä¸ªä¹‹åï¼Œæˆ‘ä»¬è¦å®ç°çš„å°†ä¸Šæ¸¸çš„ä¿¡æ¯ä¼ é€’åˆ°ä¸‹æ¸¸å°±å¯ä»¥é€šè¿‡è¿™ä¸ªç»„ä»¶å®ç°äº†ã€‚</p><p>åªéœ€è¦åœ¨ä¸Šæ¸¸åˆ›å»º span æ—¶å°†å®ƒè‡ªèº«æ•°æ®å†™å…¥åˆ° Baggage ä¸­ï¼Œå†åˆ°ä¸‹æ¸¸ span å–å‡ºæ¥å†™å…¥åˆ° attribute ä¸­å³å¯ã€‚</p><h1 id="ContextCustomizer"><a href="#ContextCustomizer" class="headerlink" title="ContextCustomizer"></a>ContextCustomizer</h1><p>è¿™é‡Œçš„å…³é”®å°±æ˜¯åœ¨å“ªé‡Œå†™å…¥è¿™ä¸ª Baggageï¼Œå› ä¸ºå¯¹ç¬¬ä¸‰æ–¹ç»„ä»¶çš„ Instrumentation çš„å®ç°éƒ½æ˜¯åœ¨ <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation">opentelemetry-java-instrumentation</a>é¡¹ç›®ä¸­ã€‚</p><blockquote><p>javaagent.jar åŒ…ä¹Ÿæ˜¯é€šè¿‡è¯¥é¡¹ç›®æ‰“åŒ…å‡ºæ¥çš„ã€‚</p></blockquote><p>æ‰€ä»¥åœ¨è¯¥é¡¹ç›®çš„ <code>io.opentelemetry.instrumentation.api.instrumenter.Instrumenter#doStart</code> è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å‘ç°ä¸€æ®µé€»è¾‘ï¼š</p><p><img src="https://s2.loli.net/2024/05/20/FYiAnq2G3voIyR4.png"></p><hr><blockquote><p>è¿™ä¸ªå‡½æ•°æ˜¯åœ¨åˆ›å»ºä¸€ä¸ª span çš„æ—¶å€™è°ƒç”¨çš„ï¼Œé€šå¸¸è¿™ä¸ªåˆ›å»ºå‡½æ•°æ˜¯åœ¨è¿™äº›ç¬¬ä¸‰æ–¹åº“çš„æ‹¦æˆªå™¨ä¸­åˆ›å»ºçš„ã€‚</p></blockquote><p><img src="https://s2.loli.net/2024/05/20/b3cxYekiUGaSlO9.png"><br>æ¯”å¦‚è¿™æ˜¯åœ¨ grpc çš„æ‹¦æˆªå™¨ä¸­è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context customizers run before span start, so that they can have access to the parent span  </span></span><br><span class="line"><span class="comment">// context, and so that their additions to the context will be visible to span processors  </span></span><br><span class="line"><span class="keyword">for</span> (ContextCustomizer&lt;? <span class="built_in">super</span> REQUEST&gt; contextCustomizer : contextCustomizers) &#123;  </span><br><span class="line">  context = contextCustomizer.onStart(context, request, attributes);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ContextCustomizer</code> æ˜¯ä¸€ä¸ªæ¥å£åªæä¾›äº†ä¸€ä¸ªå‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ContextCustomizer</span>&lt;REQUEST&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** Allows to customize the operation &#123;<span class="doctag">@link</span> Context&#125;. */</span>  </span><br><span class="line">  Context <span class="title function_">onStart</span><span class="params">(Context parentContext, REQUEST request, Attributes startAttributes)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>Context</code> æ˜¯ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯ä»¥åœ¨è‡ªå®šä¹‰çš„ ContextCustomizer ç»§ç»­å¾€ä¸Šä¸‹æ–‡ä¸­è¿½åŠ ä¿¡æ¯ã€‚</li><li><code>REQUEST</code> æ˜¯ä¸€ä¸ªæ³›å‹ï¼šä¸€èˆ¬æ˜¯å½“å‰ç¬¬ä¸‰æ–¹ç»„ä»¶çš„è¯·æ±‚ä¿¡æ¯ï¼š<ul><li>æ¯”å¦‚æ˜¯ <code>HTTP</code> æ—¶ï¼Œè¿™ä¸ª <code>request</code> å°±æ˜¯ HTTP çš„è¯·æ±‚ä¿¡æ¯ã€‚</li><li>è€Œå¦‚æœæ˜¯ <code>gRPC</code> ï¼Œåˆ™æ˜¯ <code>gRPC</code> çš„è¯·æ±‚ä¿¡æ¯ã€‚</li><li>å…¶ä»–çš„è¯·æ±‚ç±»å‹åŒç†ã€‚</li></ul></li><li><code>startAttributes</code> åˆ™æ˜¯é¢„å…ˆå†™å…¥çš„ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚åœ¨ä¸Šå›¾ä¸­çœ‹åˆ°çš„ä¸€äº› <code>rpc.service/rpc.method</code>ç­‰å­—æ®µã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context customizers run before span start, so that they can have access to the parent span  </span></span><br><span class="line"><span class="comment">// context, and so that their additions to the context will be visible to span processors</span></span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸ªæ¥å£çš„è°ƒç”¨æ³¨é‡Šå¯ä»¥çœ‹å‡ºï¼š<br>è¿™ä¸ªè‡ªå®šä¹‰çš„ context ä¼šåœ¨ span å¼€å§‹ä¹‹å‰è°ƒç”¨ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæ˜¯å¯ä»¥è®¿é—®åˆ°å½“å‰åˆ›å»ºçš„ span çš„çˆ¶ contextï¼ŒåŒæ—¶åœ¨è¿™é‡Œçš„ context ä¸­æ–°å¢çš„æ•°æ®å¯ä»¥åœ¨ <code>SpanProcessor</code> è®¿é—®åˆ°ã€‚</p><h1 id="SpanProcessor"><a href="#SpanProcessor" class="headerlink" title="SpanProcessor"></a>SpanProcessor</h1><p>è€Œ SpanProcessor åˆæ˜¯ä¸€ä¸ªéå¸¸çš„é‡è¦çš„ç»„ä»¶ï¼Œæˆ‘ä»¬æ¥ç€åˆšæ‰çš„ <code>contextCustomizer</code> å¤„å¾€åè·Ÿè¸ªä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">context = contextCustomizer.onStart(context, request, attributes);</span><br><span class="line">---&gt;<span class="type">Span</span> <span class="variable">span</span> <span class="operator">=</span> spanBuilder.setParent(context).startSpan();</span><br><span class="line">---&gt;io.opentelemetry.sdk.trace.SdkSpanBuilder#startSpan</span><br><span class="line">---&gt;io.opentelemetry.sdk.trace.SdkSpan#startSpan</span><br><span class="line">---&gt;spanProcessor.onStart(parentContext, span);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>spanProcessor.onStart</code> è¿™ä¸ªå‡½æ•°ä¼šåœ¨ contextCustomizer ä¹‹åè°ƒç”¨ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/vpxHt34TUbgfShz.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * SpanProcessor is the interface &#123;<span class="doctag">@link</span> SdkTracer&#125; uses to allow synchronous hooks for when a  </span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> Span&#125; is started or when a &#123;<span class="doctag">@code</span> Span&#125; is ended.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//==========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Called when a &#123;<span class="doctag">@link</span> io.opentelemetry.api.trace.Span&#125; is started, if the &#123;<span class="doctag">@link</span>  </span></span><br><span class="line"><span class="comment"> * Span#isRecording()&#125; returns true.  </span></span><br><span class="line"><span class="comment"> * * &lt;p&gt;This method is called synchronously on the execution thread, should not throw or block the  </span></span><br><span class="line"><span class="comment"> * execution thread. * * <span class="doctag">@param</span> parentContext the parent &#123;<span class="doctag">@code</span> Context&#125; of the span that just started.  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> span the &#123;<span class="doctag">@code</span> Span&#125; that just started.  </span></span><br><span class="line"><span class="comment"> */</span><span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(Context parentContext, ReadWriteSpan span)</span>;</span><br></pre></td></tr></table></figure><p>ä»æ³¨é‡Šä¸­å¯ä»¥çŸ¥é“ SpanProcessor æ˜¯ä½œä¸ºä¸€ä¸ª span çš„ç”Ÿå‘½å‘¨æœŸä¸­çš„å…³é”®èŠ‚ç‚¹çš„ hook å‡½æ•°ã€‚</p><p>åœ¨è¿™äº›å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€äº› span çš„æ•°æ®ï¼Œæ¯”å¦‚åœ¨ <code>onStart</code> è¿˜å¯ä»¥å¾€ span ä¸­å†™å…¥ä¸€äº›è‡ªå®šä¹‰çš„ attributeã€‚</p><p>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¿™æ¬¡ä¼šç”¨åˆ°çš„ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯ï¼š</p><p>åœ¨ gRPC æ„å»º Instrument æ—¶è‡ªå®šä¹‰ä¸€ä¸ª <code>GrpcServerContextCustomizer</code> ï¼Œåœ¨è¿™ä¸ªè‡ªå®šä¹‰çš„ <code>ContextCustomizer</code> ä¸­å†™å…¥ä¸€ä¸ª <code>Baggage</code>ã€‚</p><p>ç„¶ååœ¨ <code>io.opentelemetry.sdk.trace.SpanProcessor#onStart</code> æ¥å£ä¸­å–å‡ºè¿™ä¸ª <code>Baggage</code> å†™å…¥åˆ°å½“å‰ span çš„ attribute ä¸­ã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ä¹‹å‰æåˆ°çš„é‚£äº›æ•°æ®ä¸Šæ¸¸ä¿¡æ¯äº†ã€‚<br><img src="https://s2.loli.net/2024/05/19/4o5mEhjnMbZWL62.png"></p><h1 id="ä¸º-gRPC-æ·»åŠ ä¸Šä¸‹æ–‡"><a href="#ä¸º-gRPC-æ·»åŠ ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸º gRPC æ·»åŠ ä¸Šä¸‹æ–‡"></a>ä¸º gRPC æ·»åŠ ä¸Šä¸‹æ–‡</h1><p>å…ˆæ¥çœ‹çœ‹å¦‚ä½•ä¸º gRPC æ·»åŠ  <code>Baggage</code>ï¼š</p><p>æˆ‘ä»¬å…ˆè‡ªå®šä¹‰ä¸€ä¸ª <code>GrpcServerContextCustomizer</code> å®ç°ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcServerContextCustomizer</span> <span class="keyword">implements</span> <span class="title class_">ContextCustomizer</span>&lt;GrpcRequest&gt; &#123;  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String currentServiceName;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARENT_RPC_KEY</span> <span class="operator">=</span> <span class="string">&quot;parent_rpc&quot;</span>;  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CURRENT_RPC_KEY</span> <span class="operator">=</span> <span class="string">&quot;current_rpc&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CURRENT_HTTP_URL_PATH</span> <span class="operator">=</span> <span class="string">&quot;current_http_url_path&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">GrpcServerContextCustomizer</span><span class="params">(String serviceName)</span> &#123;  </span><br><span class="line">    <span class="built_in">this</span>.currentServiceName = serviceName;  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="keyword">public</span> Context <span class="title function_">onStart</span><span class="params">(Context parentContext, GrpcRequest grpcRequest,  </span></span><br><span class="line"><span class="params">      Attributes startAttributeds)</span> &#123;  </span><br><span class="line">    <span class="type">BaggageBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Baggage.fromContext(parentContext).toBuilder();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">currentRpc</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(CURRENT_RPC_KEY);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">fullMethodName</span> <span class="operator">=</span> startAttributeds.get(AttributeKey.stringKey(<span class="string">&quot;rpc.method&quot;</span>));  </span><br><span class="line">    <span class="type">String</span> <span class="variable">rpcService</span> <span class="operator">=</span> startAttributeds.get(AttributeKey.stringKey(<span class="string">&quot;rpc.service&quot;</span>));  </span><br><span class="line">    <span class="comment">// call from grpc  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> rpcService + <span class="string">&quot;:&quot;</span> + fullMethodName;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">baggageInfo</span> <span class="operator">=</span> getBaggageInfo(currentServiceName, method);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">httpUrlPath</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(CURRENT_HTTP_URL_PATH);  </span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(httpUrlPath)) &#123;  </span><br><span class="line">      <span class="comment">// call from http  </span></span><br><span class="line">      <span class="comment">// currentRpc = currentRpc;  currentRpc = create1|GET:/request      // clear current_http_url_path      builder.put(CURRENT_HTTP_URL_PATH, &quot;&quot;);  </span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="type">Baggage</span> <span class="variable">baggage</span> <span class="operator">=</span> builder  </span><br><span class="line">        .put(PARENT_RPC_KEY, currentRpc)  </span><br><span class="line">        .put(CURRENT_RPC_KEY, baggageInfo)  </span><br><span class="line">        .build();  </span><br><span class="line">    <span class="keyword">return</span> parentContext.with(baggage);  </span><br><span class="line">  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getBaggageInfo</span><span class="params">(String serviceName, String method)</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNullOrEmpty(serviceName)) &#123;  </span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">    &#125;    <span class="keyword">return</span> serviceName + <span class="string">&quot;|&quot;</span> + method;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸ªä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬éœ€è¦å…ˆä»ä¸Šä¸‹æ–‡ä¸­è·å– <code>CURRENT_RPC_KEY</code> ï¼Œä»è€Œå¾—çŸ¥å½“å‰çš„ span æ˜¯ä¸æ˜¯ root spanã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å…¶å®æ˜¯æŠŠå½“å‰çš„ span ä¿¡æ¯ä½œä¸ºä¸€ä¸ª <code>PARENT_RPC_KEY</code> å†™å…¥åˆ° Baggage ä¸­ã€‚</p><p>è¿™æ ·åœ¨ <code>SpanProcessor</code> ä¸­ä¾¿å¯ä»¥ç›´æ¥å–å‡º <code>PARENT_RPC_KEY</code> ä½œä¸ºä¸Šæ¸¸çš„ä¿¡æ¯å†™å…¥ span çš„ attribute ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(Context parentContext, ReadWriteSpan span)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">parentRpc</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(<span class="string">&quot;parent_rpc&quot;</span>);  </span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(parentRpc)) &#123;  </span><br><span class="line">        String[] split = parentRpc.split(<span class="string">&quot;\\|&quot;</span>);  </span><br><span class="line">        span.setAttribute(<span class="string">&quot;parent_rpc&quot;</span>, parentRpc);  </span><br><span class="line">        span.setAttribute(<span class="string">&quot;parent_service_name&quot;</span>, split[<span class="number">0</span>]);  </span><br><span class="line">        span.setAttribute(<span class="string">&quot;parent_service_method&quot;</span>, split[<span class="number">1</span>]); </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ Baggage éœ€è¦ä½¿ç”¨ <code>Baggage.fromContext(parentContext)</code> æ‰èƒ½æ‹¿åˆ°åˆšæ‰å†™å…¥ Baggage ä¿¡æ¯ã€‚</p></blockquote><p>ä¹‹åæˆ‘ä»¬æ‰¾åˆ°æ„å»º <a href="https://github.com/crossoverjie/opentelemetry-java-instrumentation/blob/715220c8d5e52001f9af9afbeb00bb87b4db0197/instrumentation/grpc-1.6/library/src/main/java/io/opentelemetry/instrumentation/grpc/v1_6/GrpcTelemetryBuilder.java#L31">gRPCServerInstrumenterBuilder</a> çš„åœ°æ–¹ï¼Œå†™å…¥æˆ‘ä»¬åˆšæ‰è‡ªå®šä¹‰çš„ <code>GrpcServerContextCustomizer</code> å³å¯ã€‚</p><p><img src="https://s2.loli.net/2024/05/20/rwSc8HmvqKL9ZQl.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.addContextCustomizer(<span class="keyword">new</span> <span class="title class_">GrpcServerContextCustomizer</span>(serviceName))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©å†™å…¥åˆ°æ˜¯ <code>serverInstrumenterBuilder</code> è€Œä¸æ˜¯<code>clientInstrumenterBuilder</code>ï¼Œå› ä¸ºåœ¨æœåŠ¡ç«¯çš„å…¥å£å°±çŸ¥é“æ˜¯ä»å“ªä¸ªæ¥å£è¿›æ¥çš„è¯·æ±‚ã€‚</p><h1 id="ä¸º-spring-boot-çš„-http-æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡"><a href="#ä¸º-spring-boot-çš„-http-æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸º spring boot çš„ http æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡"></a>ä¸º spring boot çš„ http æ¥å£æ·»åŠ ä¸Šä¸‹æ–‡</h1><p>å¦‚æœåªå­˜åœ¨ gRPC è°ƒç”¨æ—¶åªæ·»åŠ  <code>gRPC</code> çš„ä¸Šä¸‹æ–‡ä¹Ÿå¤Ÿç”¨äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿä¸æ’é™¤ç”±å¤–éƒ¨æ¥å£æ˜¯é€šè¿‡ HTTP è®¿é—®è¿›æ¥çš„ï¼Œç„¶åå†è°ƒç”¨å†…éƒ¨çš„ <code>gRPC</code> æ¥å£ï¼›è¿™ä¹Ÿæ˜¯éå¸¸å¸¸è§çš„æ¶æ„æ¨¡å¼ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åœ¨ HTTP ä¸­å¢åŠ  <code>ContextCustomizer</code> å°†è‡ªèº«çš„æ•°æ®å†™å…¥åˆ° <code>Baggage</code> ä¸­ã€‚</p><p>å¥½åœ¨ <code>HttpServerRouteBuilder</code> è‡ªèº«æ˜¯å®ç°äº† <code>ContextCustomizer</code> æ¥å£çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å¾€é‡Œé¢å†™å…¥ <code>Baggage</code> æ•°æ®å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ContextCustomizer&lt;REQUEST&gt; <span class="title function_">build</span><span class="params">()</span> &#123;  </span><br><span class="line">  Set&lt;String&gt; knownMethods = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(<span class="built_in">this</span>.knownMethods);  </span><br><span class="line">  <span class="keyword">return</span> (context, request, startAttributes) -&gt; &#123;  </span><br><span class="line">    <span class="keyword">if</span> (HttpRouteState.fromContextOrNull(context) != <span class="literal">null</span>) &#123;  </span><br><span class="line">      <span class="keyword">return</span> context;  </span><br><span class="line">    &#125;    <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> getter.getHttpRequestMethod(request);  </span><br><span class="line">    <span class="keyword">if</span> (method == <span class="literal">null</span> || !knownMethods.contains(method)) &#123;  </span><br><span class="line">      method = <span class="string">&quot;HTTP&quot;</span>;  </span><br><span class="line">    &#125;    <span class="type">String</span> <span class="variable">urlPath</span> <span class="operator">=</span> getter.getUrlPath(request);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">methodPath</span> <span class="operator">=</span> method + <span class="string">&quot;:&quot;</span> + urlPath;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">currentRpc</span> <span class="operator">=</span> Baggage.fromContext(context).getEntryValue(CURRENT_RPC_KEY);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">baggageInfo</span> <span class="operator">=</span> getBaggageInfo(serviceName, methodPath);  </span><br><span class="line">    <span class="type">Baggage</span> <span class="variable">baggage</span> <span class="operator">=</span> Baggage.fromContext(context).toBuilder()  </span><br><span class="line">        .put(PARENT_RPC_KEY, currentRpc)  </span><br><span class="line">        .put(CURRENT_RPC_KEY, baggageInfo)  </span><br><span class="line">        .put(CURRENT_HTTP_URL_PATH, methodPath)  </span><br><span class="line">        .build();   </span><br><span class="line">    <span class="keyword">return</span> context.with(HttpRouteState.create(method, <span class="literal">null</span>, <span class="number">0</span>))  </span><br><span class="line">        .with(baggage);  </span><br><span class="line">  &#125;;&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ–°å¢äº† <code>CURRENT_HTTP_URL_PATH</code> ç”¨äºæ ‡è®°å½“å‰çš„è¯·æ±‚æ¥æºæ˜¯ HTTPï¼Œåœ¨ grpc çš„ <code>ContextCustomizer</code> è§£ææ—¶ä¼šåˆ¤æ–­è¿™ä¸ªå€¼æ˜¯å¦ä¸ºç©ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">httpUrlPath</span> <span class="operator">=</span> Baggage.fromContext(parentContext).getEntryValue(CURRENT_HTTP_URL_PATH);  </span><br><span class="line"><span class="keyword">if</span> (!StringUtils.isNullOrEmpty(httpUrlPath)) &#123;  </span><br><span class="line">  <span class="comment">// call from http  </span></span><br><span class="line">  <span class="comment">// currentRpc = currentRpc;  currentRpc = create1|GET:/request  // clear current_http_url_path  builder.put(CURRENT_HTTP_URL_PATH, &quot;&quot;);  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p><img src="https://s2.loli.net/2024/05/20/ionwTD9EAr3CROL.png"></p><p>è¿™æ ·å°±å¯ä»¥åœ¨ grpc çš„ä¸‹æ¸¸æ¥å£æ‹¿åˆ°å…¥å£çš„ HTTP æ¥å£æ•°æ®äº†ã€‚</p><hr><p>å½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯åœ¨ grpc æ¥å£ä¸­è°ƒç”¨ HTTP çš„æ¥å£çš„åœºæ™¯ï¼Œåªæ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡ä¸­æ²¡æœ‰è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥å°±æ²¡æœ‰é€‚é…è¿™ç±»çš„åœºæ™¯ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><code>ContextCustomizer</code> æ¥å£æ²¡æœ‰æä¾›å¯¹åº”çš„æ‰©å±•ï¼Œä½†æ˜¯ <code>SpanProcessor</code> æ˜¯æä¾›äº†æ‰©å±•æ¥å£çš„ã€‚</p><blockquote><p>åŸæœ¬æ˜¯æƒ³å°½é‡åˆ«ç»´æŠ¤è‡ªå·±çš„ javaagentï¼Œä½†ä¹Ÿå¥½åœ¨ OpenTelemetry æ˜¯æä¾›çš„æ¥å£ï¼Œæ‰€ä»¥ä¹Ÿå¹¶ä¸ä¼šå»ä¿®æ”¹åŸæœ¬çš„ä»£ç ã€‚</p></blockquote><p>æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ª extensions çš„é¡¹ç›®åœ¨å®ç° <code>SpanProcessor</code>ï¼Œè¿™ä¸ªåœ¨ä¹‹å‰çš„ <a href="https://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/">ã€Šå®æˆ˜ï¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª OpenTelemetry Extensionsã€‹</a>æœ‰è¯¦ç»†è®²åˆ°ã€‚</p><p>æ‰€ä»¥æœ€åçš„åº”ç”¨å¯åŠ¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent-2.4.0-SNAPSHOT.jar \</span><br><span class="line">-Dotel.javaagent.extensions=otel-extensions-custom-context-1.0-SNAPSHOT.jar \</span><br></pre></td></tr></table></figure><p>éœ€è¦ä½¿ç”¨æˆ‘ä»¬æ‰‹åŠ¨æ‰“åŒ…çš„ javaagent ä»¥åŠä¸€ä¸ªè‡ªå®šä¹‰æ‰©å±•åŒ…ã€‚</p><p>æ‰“åŒ…æ–¹å¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew assemble</span><br></pre></td></tr></table></figure><blockquote><p><code>opentelemetry-java-instrumentation</code> é¡¹ç›®æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥æ‰“åŒ…è¿‡ç¨‹å¯èƒ½æ¯”è¾ƒä¹…ã€‚</p></blockquote><p>å› ä¸ºè¿™å…¶å®æ˜¯ä¸€äº›å®šåˆ¶éœ€æ±‚ï¼Œæ‰€ä»¥å°±æ²¡æäº¤åˆ°ä¸Šæ¸¸ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œåˆå¹¶ä»£ç æµ‹è¯•ã€‚</p><p>æœ€åå¯ä»¥è¿™ä¸ªåˆ†æ”¯ä¸­æŸ¥çœ‹åˆ°ä¿®æ”¹çš„éƒ¨åˆ†ï¼š<br><a href="https://github.com/crossoverJie/opentelemetry-java-instrumentation/compare/main...add-grpc-context">https://github.com/crossoverJie/opentelemetry-java-instrumentation/compare/main...add-grpc-context</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/05/19/7CnOFegSu4TLbhd.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡&lt;a href=&quot;https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/&quot;&gt;ã€Šä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…ã€‹&lt;/a&gt;ä¸­åœ¨æœ€åæåˆ°åœ¨åšä¸€äº› Trace çš„å®šåˆ¶å¼€å‘ã€‚&lt;/p&gt;
&lt;p&gt;åˆ°ç°åœ¨å·®ä¸å¤šç®—æ˜¯å®Œæˆäº†ï¼Œå¯ä»¥å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬çš„éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/05/19/qex6IFcOnQ591gT.png&quot;&gt;&lt;br&gt;å‡è®¾ç°åœ¨æœ‰ä¸‰ä¸ªæœåŠ¡ï¼šServiceAã€ServiceBã€ServiceC&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>ä» Prometheus åˆ° OpenTelemetryï¼šæŒ‡æ ‡ç›‘æ§çš„æ¼”è¿›ä¸å®è·µ</title>
    <link href="http://crossoverjie.top/2024/06/13/ob/OpenTelemetry-metrics-concept/"/>
    <id>http://crossoverjie.top/2024/06/13/ob/OpenTelemetry-metrics-concept/</id>
    <published>2024-06-13T10:22:48.000Z</published>
    <updated>2024-07-21T14:36:43.951Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡ï¼š<a href="https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/">ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</a>æˆ‘ä»¬è®²è§£äº† Trace çš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µï¼š</p><ul><li>Trace</li><li>Span</li><li>Context</li><li>Baggage ç­‰</li></ul><p>è¿™æ¬¡æˆ‘ä»¬æ¥è®²å¦ä¸€ä¸ªè¯é¢˜ <code>Metrics</code>ã€‚</p><span id="more"></span><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å…³äº metrics æˆ‘æœ€æ—©æ¥è§¦ç›¸å…³æ¦‚å¿µçš„å°±æ˜¯ prometheusï¼Œå®ƒæ˜¯ç¬¬äºŒä¸ªåŠ å…¥ CNCFï¼ˆäº‘åŸç”Ÿï¼‰ç¤¾åŒºçš„é¡¹ç›®ï¼ˆç¬¬ä¸€ä¸ªæ˜¯ kubernetesï¼‰ï¼Œå¯è§åœ¨äº‘åŸç”Ÿé¢†åŸŸ Metrics æŒ‡æ ‡ç›‘æ§ä»è¯ç”Ÿä¹‹åˆå°±æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ã€‚</p><p>ç°å®ä¹Ÿç¡®å®å¦‚æ­¤ï¼Œå¦‚ä»Šåªè¦ä½¿ç”¨åˆ°äº† kubernetes ç›¸å…³çš„é¡¹ç›®ï¼Œå¯¹å…¶ç›‘æ§å°±æ˜¯å¿…ä¸å¯å°‘çš„ã€‚</p><p>å½“ç„¶ä¹Ÿä¸æ­¢æ˜¯äº‘åŸç”Ÿçš„é¡¹ç›®æ‰éœ€è¦ Metrics æŒ‡æ ‡ç›‘æ§ï¼Œæˆ‘ä»¬ä»»ä½•ä¸€ä¸ªä¸šåŠ¡éƒ½æ˜¯éœ€è¦çš„ï¼Œä¸ç„¶æˆ‘ä»¬çš„æœåŠ¡è¿è¡Œå¯¹å¼€å‘è¿ç»´æ¥è¯´éƒ½æ˜¯ä¸€ä¸ªé»‘ç›’ï¼Œæ— æ³•çŸ¥é“æ­¤æ—¶ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µï¼Œå› æ­¤æ‰éœ€è¦æˆ‘ä»¬çš„ä¸šåŠ¡ç³»ç»Ÿå°†ä¸€äº›å…³é”®è¿è¡ŒæŒ‡æ ‡æš´éœ²å‡ºæ¥ã€‚</p><p><img src="https://s2.loli.net/2024/05/12/1QWEAdFHqYzhl4g.png"></p><p>ä¸šåŠ¡æ•°æ®ï¼šæ¯”å¦‚è®¢å•çš„å¢é•¿ç‡ã€é”€å”®é‡‘é¢ç­‰ä¸šåŠ¡æ•°æ®ï¼›åŒæ—¶è¿˜æœ‰åº”ç”¨è‡ªèº«çš„èµ„æºå ç”¨æƒ…å†µï¼š</p><ul><li>QPS</li><li>Latency</li><li>å†…å­˜</li><li>CPU ç­‰ä¿¡æ¯ã€‚</li></ul><p> åœ¨ä½¿ç”¨ OpenTelemetry ä¹‹å‰ï¼Œå› ä¸º prometheus æ˜¯è¿™éƒ¨åˆ†çš„ç»å¯¹æ ‡å‡†ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šå¸¸éƒ½ä¼šä½¿ç”¨ prometheus çš„åŒ…æ¥æš´éœ²è¿™äº›æŒ‡æ ‡ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- The client --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Hotspot JVM metrics--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient_hotspot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æš´éœ²ä¸€ä¸ªè‡ªå®šä¹‰çš„æŒ‡æ ‡ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.prometheus.client.Counter;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">YourClass</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">requests</span> <span class="operator">=</span> Counter.build()</span><br><span class="line">     .name(<span class="string">&quot;requests_total&quot;</span>).help(<span class="string">&quot;Total requests.&quot;</span>).register();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">processRequest</span><span class="params">()</span> &#123;</span><br><span class="line">    requests.inc();</span><br><span class="line">    <span class="comment">// Your code here.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ˜¯æš´éœ²ä¸€ä¸ªå•è°ƒé€’å¢çš„æŒ‡æ ‡ï¼Œprometheus è¿˜æä¾›äº†å…¶ä»–å‡ ç§æŒ‡æ ‡ç±»å‹ï¼š</p></blockquote><ul><li>Counter</li><li>Gauge</li><li>Histogram</li></ul><p>ä¹‹åæˆ‘ä»¬åªéœ€è¦åœ¨ prometheus ä¸­é…ç½®ä¸€äº›æŠ“å–è§„åˆ™å³å¯ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;springboot&#x27;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8080&#x27;</span>] <span class="comment"># Spring Boot ip+port</span></span><br></pre></td></tr></table></figure><blockquote><p>å½“ç„¶å¦‚æœæ˜¯è¿è¡Œåœ¨ kubernetes ç¯å¢ƒï¼Œprometheus ä¹Ÿå¯ä»¥åŸºäºæœåŠ¡å‘ç°é…ç½®ä¸€äº›è§„åˆ™ï¼Œè‡ªåŠ¨æŠ“å–æˆ‘ä»¬çš„ Pod çš„æ•°æ®ï¼Œç”±äºä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹å°±ä¸è¿‡å¤šä»‹ç»ã€‚</p></blockquote><h1 id="åŸºæœ¬ç»„ä»¶"><a href="#åŸºæœ¬ç»„ä»¶" class="headerlink" title="åŸºæœ¬ç»„ä»¶"></a>åŸºæœ¬ç»„ä»¶</h1><p>åœ¨ OpenTelemetry ä¸­è‡ªç„¶ä¹Ÿæä¾›äº† Metrics è¿™ä¸ªç»„ä»¶ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯å®Œå…¨å…¼å®¹ Prometheusï¼Œæ‰€ä»¥æˆ‘ä»¬ç†è§£å’Œä½¿ç”¨èµ·æ¥å¹¶ä¸å¤æ‚ã€‚</p><h2 id="MeterProvider"><a href="#MeterProvider" class="headerlink" title="MeterProvider"></a>MeterProvider</h2><p>ä¸åŒäº prometheus å®¢æˆ·ç«¯ä¸­ç›´æ¥æä¾›äº† Counter å°±å¯ä»¥åˆ›å»ºæŒ‡æ ‡äº†ï¼Œåœ¨ OpenTelemetry ä¸­ä¼šæä¾›ä¸€ä¸ª <code>MeterProvider</code> çš„æ¥å£ï¼Œä½¿ç”¨è¿™ä¸ªæ¥å£å¯ä»¥è·å– Meterï¼Œå†ä½¿ç”¨ Meter æ‰å¯ä»¥åˆ›å»º Counterã€Gaugeã€Histogram ç­‰æ•°æ®ã€‚</p><p>ä¸‹é¢æ¥çœ‹çœ‹å…·ä½“å¦‚ä½•ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¥ Pulsar æºç çš„ä»£ç è¿›è¡Œæ¼”ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InstrumentProvider</span><span class="params">(OpenTelemetry otel)</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (otel == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="comment">// By default, metrics are disabled, unless the OTel java agent is configured.  </span></span><br><span class="line">        <span class="comment">// This allows to enable metrics without any code change.        otel = GlobalOpenTelemetry.get();  </span></span><br><span class="line">    &#125;    <span class="built_in">this</span>.meter = otel.getMeterProvider()  </span><br><span class="line">            .meterBuilder(<span class="string">&quot;org.apache.pulsar.client&quot;</span>)  </span><br><span class="line">            .setInstrumentationVersion(PulsarVersion.getVersion())  </span><br><span class="line">            .build();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">LongCounterBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> meter.counterBuilder(name)  </span><br><span class="line">        .setDescription(description)  </span><br><span class="line">        .setUnit(unit.toString());</span><br></pre></td></tr></table></figure><h2 id="Meter-Exporter"><a href="#Meter-Exporter" class="headerlink" title="Meter Exporter"></a>Meter Exporter</h2><p>Meter Exporter åˆ™æ˜¯ä¸€ä¸ª OpenTelemetry ç‹¬æœ‰çš„æ¦‚å¿µï¼Œä¸æˆ‘ä»¬ä¹‹å‰è®²åˆ°çš„ä¸€æ ·ï¼šOpenTelemetry ä½œä¸ºå‚å•†æ— å…³çš„å¹³å°ï¼Œå…è®¸æˆ‘ä»¬å°†æ•°æ®å†™å…¥åˆ°ä»»ä½•å…¼å®¹çš„äº§å“é‡Œã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨ Metrics æ—¶éœ€è¦æŒ‡å®šä¸€ä¸ª exporterï¼š</p><table><thead><tr><th>Exporter ç±»å‹</th><th>ä½œç”¨</th><th>å¤‡æ³¨</th><th>å‚æ•°</th></tr></thead><tbody><tr><td>OTLP Exporter</td><td>é€šè¿‡ OpenTelemetry Protocolï¼ˆOTLPï¼‰ å‘é€æŒ‡æ ‡æ•°æ®åˆ° collectã€‚</td><td>é»˜è®¤ç”Ÿäº§ç¯å¢ƒä¸­æ¨èä½¿ç”¨ï¼Œéœ€è¦å°†æ•°æ®å‘é€åˆ°æ”¯æŒ OTLP çš„åç«¯ï¼Œå¦‚ OpenTelemetry Collectorã€‚</td><td>-Dotel.metrics.exporter&#x3D;otlp (default)</td></tr><tr><td>Console Exporter</td><td>å°†æŒ‡æ ‡æ•°æ®æ‰“å°åˆ°æ§åˆ¶å°çš„å¯¼å‡ºå™¨ã€‚</td><td>å¼€å‘å’Œè°ƒè¯•ï¼Œå¿«é€ŸæŸ¥çœ‹æŒ‡æ ‡æ•°æ®ã€‚</td><td>-Dotel.metrics.exporter&#x3D;console</td></tr><tr><td>Prometheus Exporter</td><td>å°†æŒ‡æ ‡æ•°æ®ä»¥ Prometheus æŠ“å–çš„æ ¼å¼æš´éœ²ç»™ Prometheus æœåŠ¡ã€‚</td><td>ä¸ Prometheus é›†æˆï¼Œé€‚ç”¨äºéœ€è¦ Prometheus ç›‘æ§çš„åœºæ™¯ï¼Œè¿™ä¸ªå¯ä»¥æ— ç¼å’Œä»¥å¾€ä½¿ç”¨ prometheus çš„åœºæ™¯å…¼å®¹</td><td>-Dotel.metrics.exporter&#x3D;prometheus</td></tr></tbody></table><h2 id="Metric-Instruments"><a href="#Metric-Instruments" class="headerlink" title="Metric Instruments"></a>Metric Instruments</h2><p>ä¸ prometheus ç±»ä¼¼ï¼ŒOpenTelemetry ä¹Ÿæä¾›äº†ä»¥ä¸‹å‡ ç§æŒ‡æ ‡ç±»å‹ï¼š</p><ul><li><strong>Counter</strong>ï¼šå•è°ƒé€’å¢è®¡æ•°å™¨ï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥è®°å½•è®¢å•æ•°ã€æ€»çš„è¯·æ±‚æ•°ã€‚</li><li><strong>UpDownCounter</strong>ï¼šä¸ Counter ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒå¯ä»¥é€’å‡ã€‚</li><li><strong>Gauge</strong>ï¼šç”¨äºè®°å½•éšæ—¶åœ¨å˜åŒ–çš„å€¼ï¼Œæ¯”å¦‚å†…å­˜ä½¿ç”¨é‡ã€CPU ä½¿ç”¨é‡ç­‰ã€‚</li><li><strong>Histogram</strong>ï¼šé€šå¸¸ç”¨äºè®°å½•è¯·æ±‚å»¶è¿Ÿã€å“åº”æ—¶é—´ç­‰ã€‚</li></ul><p>åŒæ—¶æ¯ä¸ªæŒ‡æ ‡è¿˜æœ‰ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š</p><ul><li>Nameï¼šåç§°ï¼Œå¿…å¡«ã€‚</li><li>Kindï¼šç±»å‹ï¼Œå¿…å¡«ã€‚</li><li>Unitï¼šå•ä½ï¼Œå¯é€‰ã€‚</li><li>Descriptionï¼šæè¿°ï¼Œå¯é€‰ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">messageInCounter = meter  </span><br><span class="line">        .counterBuilder(MESSAGE_IN_COUNTER)  </span><br><span class="line">        .setUnit(<span class="string">&quot;&#123;message&#125;&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;The total number of messages received for this topic.&quot;</span>)  </span><br><span class="line">        .buildObserver();</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯ä»¥ Pulsar çš„ä¸ºä¾‹ï¼Œ<code>messageInCounter</code> æ˜¯ä¸€ä¸ªè®°å½•æ€»çš„æ¶ˆæ¯æ¥æ”¶æ•°é‡çš„ Counter ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">subscriptionCounter = meter  </span><br><span class="line">        .upDownCounterBuilder(SUBSCRIPTION_COUNTER)  </span><br><span class="line">        .setUnit(<span class="string">&quot;&#123;subscription&#125;&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;The number of Pulsar subscriptions of the topic served by this broker.&quot;</span>)  </span><br><span class="line">        .buildObserver();</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯è®°å½•ä¸€ä¸ªè®¢é˜…è€…æ•°é‡çš„æŒ‡æ ‡ï¼Œç±»å‹æ˜¯ UpDownCounterï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¢åŠ å‡å°‘çš„æŒ‡æ ‡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Double&gt; latencyHistogramBuckets =  </span><br><span class="line">        Lists.newArrayList(<span class="number">.0005</span>, <span class="number">.001</span>, <span class="number">.0025</span>, <span class="number">.005</span>, <span class="number">.01</span>, <span class="number">.025</span>, <span class="number">.05</span>, <span class="number">.1</span>, <span class="number">.25</span>, <span class="number">.5</span>, <span class="number">1.0</span>, <span class="number">2.5</span>, <span class="number">5.0</span>, <span class="number">10.0</span>, <span class="number">30.0</span>, <span class="number">60.0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">DoubleHistogramBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> meter.histogramBuilder(<span class="string">&quot;pulsar.client.producer.message.send.duration&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;Publish latency experienced by the application, includes client batching time&quot;</span>)  </span><br><span class="line">        .setUnit(Unit.Seconds.toString())  </span><br><span class="line">        .setExplicitBucketBoundariesAdvice(latencyHistogramBuckets);</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªè®°å½• Pulsar producer å‘é€å»¶è¿Ÿçš„æŒ‡æ ‡ï¼Œç±»å‹æ˜¯ <code>Histogram</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">backlogQuotaAge = meter  </span><br><span class="line">        .gaugeBuilder(BACKLOG_QUOTA_AGE)  </span><br><span class="line">        .ofLongs()  </span><br><span class="line">        .setUnit(<span class="string">&quot;s&quot;</span>)  </span><br><span class="line">        .setDescription(<span class="string">&quot;The age of the oldest unacknowledged message (backlog).&quot;</span>)  </span><br><span class="line">        .buildObserver();</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªè®°å½•æœ€å¤§ unack ä¹Ÿå°±æ˜¯ backlog æ—¶é—´çš„æŒ‡æ ‡ï¼Œç±»å‹æ˜¯ <code>Gauge</code>ã€‚</p><h1 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h1><p>åœ¨ä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/">å®æˆ˜ï¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª OpenTelemetry Extensions</a>ä¸­è®²è¿‡å¦‚ä½•å¼€å‘ä¸€ä¸ª OpenTelemetry çš„ extensionï¼Œå…¶å®å½“æ—¶æˆ‘å°±æ˜¯å¼€å‘äº†ä¸€ä¸ªç”¨äºåœ¨ Pulsar å®¢æˆ·ç«¯ä¸­æš´éœ²æŒ‡æ ‡çš„ä¸€ä¸ªæ’ä»¶ã€‚</p><blockquote><p>ä¸è¿‡ç›®å‰ Pulsar ç¤¾åŒºå·²ç»é›†æˆäº†è¯¥åŠŸèƒ½ã€‚</p></blockquote><p>å…¶ä¸­çš„æ ¸å¿ƒä»£ç ä¸ä¸Šé¢è®²åˆ°çš„ç±»ä¼¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerObservers</span><span class="params">()</span> &#123;    </span><br><span class="line">    <span class="type">Meter</span> <span class="variable">meter</span> <span class="operator">=</span> MetricsRegistration.getMeter();    </span><br><span class="line">    </span><br><span class="line">    meter.gaugeBuilder(<span class="string">&quot;pulsar_producer_num_msg_send&quot;</span>)    </span><br><span class="line">            .setDescription(<span class="string">&quot;The number of messages published in the last interval&quot;</span>)    </span><br><span class="line">            .ofLongs()    </span><br><span class="line">            .buildWithCallback(    </span><br><span class="line">                    r -&gt; recordProducerMetrics(r, ProducerStats::getNumMsgsSent));</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recordProducerMetrics</span><span class="params">(ObservableLongMeasurement observableLongMeasurement, Function&lt;ProducerStats, Long&gt; getter)</span> &#123;    </span><br><span class="line">    <span class="keyword">for</span> (Producer producer : CollectionHelper.PRODUCER_COLLECTION.list()) &#123;    </span><br><span class="line">        <span class="type">ProducerStats</span> <span class="variable">stats</span> <span class="operator">=</span> producer.getStats();    </span><br><span class="line">        <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> producer.getTopic();    </span><br><span class="line">        <span class="keyword">if</span> (topic.endsWith(RetryMessageUtil.RETRY_GROUP_TOPIC_SUFFIX)) &#123;    </span><br><span class="line">            <span class="keyword">continue</span>;    </span><br><span class="line">        &#125;        observableLongMeasurement.record(getter.apply(stats),    </span><br><span class="line">                Attributes.of(PRODUCER_NAME, producer.getProducerName(), TOPIC, topic));    </span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure><p>åªæ˜¯è¿™é‡Œä½¿ç”¨äº† <code>buildWithCallback</code> å›è°ƒå‡½æ•°ï¼ŒOpenTelemetry ä¼šæ¯éš” 30s è°ƒç”¨ä¸€æ¬¡è¿™ä¸ªå‡½æ•°ï¼Œé€šå¸¸é€‚ç”¨äº Gauge ç±»å‹çš„æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:opentelemetry-javaagent.jar \  </span><br><span class="line">     -Dotel.javaagent.extensions=ext.jar  \</span><br><span class="line">     -Dotel.metrics.exporter=prometheus \</span><br><span class="line">     -Dotel.exporter.prometheus.port=<span class="number">18180</span> \</span><br><span class="line">     -jar myapp.jar</span><br></pre></td></tr></table></figure><p>é…åˆä¸Š Prometheus çš„ä¸¤ä¸ªå¯åŠ¨å‚æ•°å°±å¯ä»¥åœ¨æœ¬åœ° 18180 ä¸­è·å–åˆ°æŒ‡æ ‡æ•°æ®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:18180/metrics</span><br></pre></td></tr></table></figure><p>å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å‘å¾€ OpenTelemetry-Collector ä¸­ï¼Œå†ç”±å®ƒå‘å¾€ prometheusï¼Œåªæ˜¯è¿™æ ·éœ€è¦é¢å¤–åœ¨ collector ä¸­é…ç½®ä¸€ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">debug:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">otlphttp:</span></span><br><span class="line">    <span class="attr">metrics_endpoint:</span> <span class="string">http://promethus:8480/insert/0/opentelemetry/api/v1/push</span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">exporters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlphttp</span></span><br><span class="line">      <span class="attr">processors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">k8sattributes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">      <span class="attr">receivers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">otlp</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/05/12/4iMpax5Ptod2Nws.png"></p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ Grafana ä¸­é€šè¿‡ prometheus æŸ¥è¯¢åˆ°æ•°æ®äº†ã€‚</p><p>æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰çš„æŒ‡æ ‡æœ€å¥½æ˜¯å‚è€ƒå®˜æ–¹çš„<a href="https://opentelemetry.io/docs/specs/semconv/general/metrics/">è¯­ä¹‰å’Œå‘½åè§„èŒƒ</a>æ¥å®šä¹‰è¿™äº›æŒ‡æ ‡åç§°ã€‚</p><p><img src="https://s2.loli.net/2024/05/12/vCDZY3ygX7MrzGH.png"></p><p>æ¯”å¦‚ OpenTelemetry çš„è§„èŒƒä¸­åç§°æ˜¯ç”¨ <strong>.</strong> æ¥è¿›è¡Œåˆ†éš”çš„ã€‚</p><blockquote><p>åˆ‡æ¢ä¸º OpenTelemetry ä¹‹åè‡ªç„¶å°±ä¸éœ€è¦ä¾èµ– prometheus çš„åŒ…ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ OTel çš„åŒ…ï¼š</p></blockquote><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compileOnly <span class="string">&#x27;io.opentelemetry:opentelemetry-sdk-extension-autoconfigure-spi:1.34.1&#x27;</span>  </span><br><span class="line">compileOnly <span class="string">&#x27;io.opentelemetry.instrumentation:opentelemetry-instrumentation-api:1.32.0&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç›¸å¯¹æ¥è¯´ Metrics çš„ä½¿ç”¨æ¯” Trace ç®€å•çš„å¤šï¼ŒåŒæ—¶ Metrics å…¶å®ä¹Ÿå¯ä»¥å’Œ Trace è¿›è¡Œå…³è”ï¼Œä¹Ÿå°±æ˜¯ <a href="https://opentelemetry.io/docs/specs/otel/metrics/data-model/#exemplars">Exemplars</a>ï¼Œé™äºç¯‡å¹…å°±ä¸åœ¨æœ¬æ–‡å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/apache/pulsar/blob/master/pulsar-client/src/main/java/org/apache/pulsar/client/impl/metrics/InstrumentProvider.java">https://github.com/apache/pulsar/blob/master/pulsar-client/src/main/java/org/apache/pulsar/client/impl/metrics/InstrumentProvider.java</a></li><li><a href="https://opentelemetry.io/docs/specs/semconv/general/metrics/">https://opentelemetry.io/docs/specs/semconv/general/metrics/</a></li><li><a href="https://opentelemetry.io/docs/specs/otel/metrics/data-model/#exemplars">https://opentelemetry.io/docs/specs/otel/metrics/data-model/#exemplars</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡ï¼š&lt;a href=&quot;https://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/&quot;&gt;ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…&lt;/a&gt;æˆ‘ä»¬è®²è§£äº† Trace çš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Trace&lt;/li&gt;
&lt;li&gt;Span&lt;/li&gt;
&lt;li&gt;Context&lt;/li&gt;
&lt;li&gt;Baggage ç­‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™æ¬¡æˆ‘ä»¬æ¥è®²å¦ä¸€ä¸ªè¯é¢˜ &lt;code&gt;Metrics&lt;/code&gt;ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>ä» Dapper åˆ° OpenTelemetryï¼šåˆ†å¸ƒå¼è¿½è¸ªçš„æ¼”è¿›ä¹‹æ—…</title>
    <link href="http://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/"/>
    <id>http://crossoverjie.top/2024/06/06/ob/OpenTelemetry-trace-concept/</id>
    <published>2024-06-05T16:55:16.000Z</published>
    <updated>2024-06-06T13:00:48.174Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¹‹å‰å†™è¿‡ä¸¤ç¯‡æ¯”è¾ƒç³»ç»Ÿçš„å…³äº OpenTelemetry çš„æ–‡ç« ï¼š</p><ul><li><a href="https://juejin.cn/post/7358450927110357026">OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ</a></li><li><a href="https://juejin.cn/post/7360216766373068837">å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯</a></li></ul><p>ä»åŸºæœ¬æ¦‚å¿µåˆ°å¦‚ä½•éƒ¨ç½² demo å®æˆ˜äº†è§£ OpenTelemetryï¼Œä»é‚£ä¸ª demo ä¸­ä¹Ÿå¯ä»¥å¾—çŸ¥æ•´ä¸ª OpenTelemetry ä½“ç³»çš„å¤æ‚æ€§ï¼ŒåŒ…å«äº†å¤ªå¤šçš„ç»„ä»¶å’Œæ¦‚å¿µã€‚</p><p>ä¸ºäº†èƒ½æ›´æ¸…æ™°çš„äº†è§£æ¯ä¸ªå…³é”®ç»„ä»¶çš„ä½œç”¨ä»¥åŠåŸç†ï¼Œæˆ‘æ‰“ç®—åˆ†ä¸ºå‡ æœŸæ¥è®²è§£ OpenTelemetry çš„ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p><ul><li>Trace</li><li>Metrics</li><li>Logs</li></ul><p>é¦–å…ˆä»¥ Trace è®²èµ·ã€‚</p><span id="more"></span><h1 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h1><p>å¼€å§‹ä¹‹å‰è¿˜æ˜¯å…ˆå¤ä¹ ä¸€ä¸‹ Trace çš„å†å²èƒŒæ™¯ã€‚</p><p>å¦‚ä»Šç°ä»£çš„åˆ†å¸ƒå¼è¿½è¸ªçš„èµ·æºæºè‡ªäº Google åœ¨ 2010 å¹´å‘å¸ƒçš„ä¸€ç¯‡è®ºæ–‡ï¼š</p><ul><li><a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/papers/dapper-2010-1.pdf">Dapper, a Large-Scale Distributed Systems Tracing Infrastructure</a></li></ul><p>åœ¨è¿™ç¯‡è®ºæ–‡ä¸­æå‡ºäº†åˆ†å¸ƒå¼è¿½è¸ªçš„å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š</p><ul><li>Trace</li><li>Span<ul><li>Span çš„ä¸€äº›åŸºç¡€æ•°æ®ç»“æ„</li></ul></li><li>å¯è§†åŒ–è¿½è¸ªä»¥åŠå±•ç¤º</li></ul><p>ä¹‹å Twitter å—åˆ°äº† Dapper çš„å¯å‘å¼€æºäº†ç°åœ¨æˆ‘ä»¬ç†ŸçŸ¥çš„ <a href="https://zipkin.io/">Zipkin</a>ï¼ŒåŒ…å«äº†å­˜å‚¨å’Œå¯è§†åŒ– UI å±•ç¤ºæˆ‘ä»¬çš„è¿½è¸ªé“¾è·¯ã€‚</p><p>Uber ä¹Ÿåœ¨ 2015 å¹´å¼€æºäº† <a href="https://www.jaegertracing.io/">Jaeger</a> é¡¹ç›®ï¼Œå®ƒçš„åŠŸèƒ½å’Œ Zipkin ç±»ä¼¼ï¼Œä½†ç›®å‰æˆ‘ä»¬ç”¨çš„è¾ƒå¤šçš„è¿˜æ˜¯ Jaegerï¼›ç°åœ¨å·²ç»æˆä¸º CNCF çš„æ‰˜ç®¡é¡¹ç›®ã€‚</p><p>ä¹‹åé™†ç»­å‡ºç°è¿‡ <strong>OpenTracing</strong> å’Œ <strong>OpenCensus</strong> é¡¹ç›®ï¼Œä»–ä»¬éƒ½ä¼å›¾ç»Ÿä¸€åˆ†å¸ƒå¼è¿½è¸ªè¿™ä¸€é¢†åŸŸã€‚</p><p>ç›´åˆ° <code>OpenTelemetry</code> çš„å‡ºç°æ•´åˆäº†ä»¥ä¸Šä¸¤ä¸ªé¡¹ç›®ï¼Œå¹¶ä¸”é€æ¸æˆä¸ºå¯è§‚æµ‹é¢†åŸŸçš„æ ‡å‡†ã€‚</p><blockquote><p>æ›´å¤šå†å²èƒŒæ™¯å¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://juejin.cn/post/7358450927110357026">OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ</a></p></blockquote><p><img src="https://s2.loli.net/2024/05/05/ljQ6yNhKzn3b1c9.png"></p><p><img src="https://s2.loli.net/2024/05/05/NOEbTamR67x83nS.png"></p><p>è¿™é‡Œæˆ‘ä»¬ç»“åˆ Dapper è®ºæ–‡ä¸­çš„èµ„æ–™è¿›è¡Œåˆ†æï¼Œåœ¨è¿™ä¸ªè°ƒç”¨ä¸­ç”¨æˆ·å‘èµ·äº†ä¸€æ¬¡è¯·æ±‚ï¼Œå†…éƒ¨ç³»ç»Ÿç»å†äº† 4 æ¬¡ RPC è°ƒç”¨ã€‚</p><p>ä»ç¬¬äºŒå¼ å›¾ä¼šçœ‹åˆ°ä¸€äº›å…³é”®ä¿¡æ¯ï¼š</p><ul><li>spanName</li><li>parentId</li><li>spanId</li></ul><p>parentId å¾ˆå¥½ç†è§£ï¼Œä¸»è¦æ˜¯å®šä¹‰è°ƒç”¨çš„ä¸»æ¬¡å…³ç³»ï¼›è¦æ³¨æ„çš„æ˜¯å¹¶è¡Œè°ƒç”¨æ—¶ parentId æ˜¯åŒä¸€ä¸ªã€‚</p><p>spanId åœ¨å¯ä»¥ç†è§£ä¸ºæ¯ä¸€ä¸ªç‹¬ç«‹çš„æ“ä½œï¼Œåœ¨è¿™é‡Œå°±æ˜¯ä¸€æ¬¡ RPC è°ƒç”¨ï¼›åŒç†ä¸€æ¬¡æ•°æ®åº“æ“ä½œã€æ¶ˆæ¯çš„æ”¶å‘éƒ½æ˜¯ä¸€ä¸ª spanã€‚</p><blockquote><p>span çš„æ›´å¤šå†…å®¹åœ¨åæ–‡ç»§ç»­è®²è§£ã€‚</p></blockquote><h1 id="Span"><a href="#Span" class="headerlink" title="Span"></a>Span</h1><p><img src="https://s2.loli.net/2024/05/05/wyzLpbhYkjOUFav.png"><br>å½“æˆ‘ä»¬æŠŠæŸä¸€ä¸ªå…·ä½“çš„ span æ”¾å¤§ä¼šçœ‹åˆ°æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯ï¼Œå…¶ä¸­æœ€å…³é”®çš„å¦‚ä¸‹ï¼š</p><ul><li>traceId</li><li>spanName</li><li>spanId</li><li>parentId</li><li>å¼€å§‹æ—¶é—´</li><li>ç»“æŸæ—¶é—´</li></ul><p>ç”±äºä¸€ä¸ªå®Œæ•´çš„ trace é“¾è·¯ç”± N ä¸ª span ç»„æˆï¼Œæ‰€ä»¥è¿™ä¸ªé“¾è·¯å¿…é¡»å¾—æœ‰ä¸€ä¸ªå”¯ä¸€çš„ traceId å°†è¿™äº› span ä¸²è”èµ·æ¥ã€‚<br>è¿™æ ·æ‰å¯ä»¥åœ¨å¯è§†åŒ–çš„æ—¶å€™æ›´å¥½çš„å±•ç¤ºé“¾è·¯ä¿¡æ¯ã€‚</p><p>ä»¥ä¸Šçš„è¿™äº›å­—æ®µå¾ˆå®¹æ˜“ç†è§£ï¼Œéƒ½æ˜¯ä¸€äº›å¿…é¡»çš„ä¿¡æ¯ã€‚</p><p>åœ¨ Dapper è®ºæ–‡ä¸­ä½¿ç”¨ Annotations æ¥å­˜æ”¾ span çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯åˆšæ‰é‚£äº›å­—æ®µï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å­˜æ”¾ä¸€äº›æ•°æ®ï¼Œæ¯”å¦‚å›¾ä¸­çš„ <code>&quot;foo&quot;</code>ã€‚</p><h2 id="OpenTelemetry-ä¸­çš„-Span"><a href="#OpenTelemetry-ä¸­çš„-Span" class="headerlink" title="OpenTelemetry ä¸­çš„ Span"></a>OpenTelemetry ä¸­çš„ Span</h2><p>OpenTelemetry çš„ trace è‡ªç„¶ä¹Ÿæ˜¯åŸºäº Dapper çš„ï¼Œåªæ˜¯é¢å¤–åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚åœ¨åˆšæ‰é‚£äº›å­—æ®µçš„åŸºç¡€ä¸Šæ–°å¢äº†ä¸€äº›æ¦‚å¿µï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/v1/sys/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;context&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;trace_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7bba9f33312b3dbb8b2c2c62bb7abe2d&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;span_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;086e83747d0e381e&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;parent_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-10-22 16:04:01.209458162 +0000 UTC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;end_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-10-22 16:04:01.209514132 +0000 UTC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status_code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;STATUS_CODE_OK&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status_message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;net.transport&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IP.TCP&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.peer.ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.17.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.peer.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;51820&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.host.ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.177.2.152&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;net.host.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;26040&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/v1/sys/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.server_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mortar-gateway&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.route&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/v1/sys/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.user_agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Consul Health Check&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.scheme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.177.2.152:26040&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;http.flavor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;OK&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-10-22 16:04:01.209512872 +0000 UTC&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä»¥è¿™ä¸ª JSON ä¸ºä¾‹ï¼Œæ–°å¢äº†ï¼š</p><ul><li><input disabled="" type="checkbox"> <code>Span Context</code><ul><li><code>Span</code> çš„ä¸Šä¸‹æ–‡ï¼Œå­˜æ”¾çš„éƒ½æ˜¯ä¸å¯å˜çš„æ•°æ®ï¼Œå› ä¸ºæ¯ä¸ª Span ä¹‹é—´æ˜¯å­˜åœ¨å…³è”å…³ç³»çš„ï¼Œè¿™äº›å…³è”å…³ç³»éƒ½æ˜¯å­˜æ”¾åœ¨ context ä¸­ï¼Œä¸»è¦å°±æ˜¯ trace_id, span_id.</li></ul></li><li><code>Attributes</code>: å¯ä»¥ç†è§£ä¸º Dapper ä¸­çš„ Annotationsï¼Œå­˜æ”¾çš„æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„é”®å€¼å¯¹ï¼Œé€šå¸¸æ˜¯ç”±æˆ‘ä»¬å¸¸ç”¨ç¬¬ä¸‰æ–¹å¼€æº Instrumentation å†…ç½®çš„ä¸€äº›å±æ€§ã€‚</li><li><code>Span Events</code>: Span çš„ä¸€äº›å…³é”®äº‹ä»¶ã€‚</li></ul><p><img src="https://s2.loli.net/2024/05/05/3C49thIJOZTuf82.png"><br>æ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„ Redis å®¢æˆ·ç«¯ lettuceï¼Œå®ƒå°±ä¼šè‡ªå·±è®°å½•ä¸€äº› Attributesã€‚</p><hr><p>å¦‚æœæœ‰å¤šä¸ª span å­˜åœ¨ä¾èµ–å…³ç³»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">       [Span A]  â†â†â†(the root span)</span><br><span class="line">           |</span><br><span class="line">    +------+------+</span><br><span class="line">    |             |</span><br><span class="line">[Span B]      [Span C] â†â†â†(Span C is a `child` of Span A)</span><br><span class="line">    |             |</span><br><span class="line">[Span D]      +---+-------+</span><br><span class="line">              |           |</span><br><span class="line">          [Span E]    [Span F]</span><br></pre></td></tr></table></figure><p>å¤§éƒ¨åˆ†çš„å¯è§†åŒ–å·¥å…·éƒ½æ˜¯ä»¥æ—¶é—´çº¿çš„æ–¹å¼è¿›è¡Œå±•ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“â€“â€“â€“â€“â€“â€“|â€“&gt; time</span><br><span class="line"></span><br><span class="line"> [Span AÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">   [Span BÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">      [Span DÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">    [Span CÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·]</span><br><span class="line">         [Span EÂ·Â·Â·Â·Â·Â·Â·]        [Span FÂ·Â·]</span><br></pre></td></tr></table></figure><p>è¿™äº›å’Œ Dapper ä¸­æè¿°çš„æ¦‚å¿µæ²¡æœ‰æœ¬è´¨åŒºåˆ«ã€‚</p><hr><h3 id="Span-Status"><a href="#Span-Status" class="headerlink" title="Span Status"></a>Span Status</h3><p>Span è¿˜å†…ç½®äº†ä¸€äº› Statusï¼š</p><ul><li><code>Unset</code></li><li><code>Error</code></li><li><code>Ok</code></li></ul><p>é»˜è®¤æƒ…å†µä¸‹æ˜¯ Unsetï¼Œå‡ºç°é”™è¯¯æ—¶åˆ™æ˜¯ Errorï¼Œä¸€åˆ‡æ­£å¸¸æ—¶åˆ™æ˜¯ Okã€‚</p><p><img src="https://s2.loli.net/2024/05/05/glkIuxbFDBcai36.png"><br>é€šè¿‡å¯è§†åŒ–é¡µé¢å¾ˆå®¹æ˜“å¾—çŸ¥æŸä¸ª trace ä¸­ span çš„å¼‚å¸¸æƒ…å†µï¼Œç‚¹è¿›å»åå¯ä»¥çœ‹åˆ°å…·ä½“çš„å¼‚å¸¸ span ä»¥åŠå®ƒçš„é”™è¯¯æ—¥å¿—ã€‚</p><h3 id="Span-Kind"><a href="#Span-Kind" class="headerlink" title="Span Kind"></a>Span Kind</h3><p>æœ€åæ˜¯ Span çš„ç±»å‹ï¼š</p><ul><li>Client</li><li>Server</li><li>Internal</li><li>Producer</li><li>Consumer</li></ul><p><img src="https://s2.loli.net/2024/05/05/rMjV9qsveNEKORW.png"></p><p>Client å’Œ Server éå¸¸å¥½ç†è§£ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª gRPC æ¥å£ï¼Œè°ƒç”¨æ–¹çš„ Span æ˜¯ clientï¼Œè€ŒæœåŠ¡ç«¯çš„ Span è‡ªç„¶å°±æ˜¯ Serverã€‚</p><p>Internal åˆ™æ˜¯å†…éƒ¨ç»„ä»¶è°ƒç”¨äº§ç”Ÿçš„ Spanï¼Œè¿™ç±» Span ç›¸å¯¹ä¼šå°‘ä¸€äº›ã€‚</p><p>Producer å’Œ Consumer ä¸€èˆ¬æŒ‡çš„æ˜¯å‘èµ·å¼‚æ­¥è°ƒç”¨æ—¶çš„ Spanï¼Œæˆ‘ä»¬å¸¸è§çš„å°±æ˜¯å¾€æ¶ˆæ¯é˜Ÿåˆ—é‡Œç”Ÿäº§å’Œæ¶ˆè´¹æ¶ˆæ¯ã€‚</p><p>é€šè¿‡è¿™å‡ ç§ç±»å‹çš„ Span ä¹Ÿå¯ä»¥äº†è§£åˆ°ä»€ä¹ˆæƒ…å†µä¸‹ä¼šåˆ›å»º Spanï¼Œé€šå¸¸æ˜¯ä»¥ä¸‹å‡ ç§åœºæ™¯ï¼š</p><ul><li>RPC è°ƒç”¨</li><li>æ•°æ®åº“ï¼ˆRedisã€MySQLã€Mongo ç­‰ç­‰ï¼‰æ“ä½œ</li><li>ç”Ÿäº§å’Œæ¶ˆè´¹æ¶ˆæ¯</li><li>æœ‰æ„ä¹‰çš„å†…éƒ¨è°ƒç”¨</li></ul><p>é€šå¸¸åœ¨ä¸€ä¸ªå‡½æ•°å†…éƒ¨å†è°ƒç”¨å…¶ä»–çš„æœ¬åœ°å‡½æ•°æ˜¯ä¸ç”¨åˆ›å»º span çš„ï¼Œä¸ç„¶è¿™ä¸ªé“¾è·¯ä¼šéå¸¸çš„é•¿ã€‚</p><h2 id="Annotations"><a href="#Annotations" class="headerlink" title="Annotations"></a>Annotations</h2><p>å½“ç„¶ä¹Ÿæœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚æˆ‘çš„æŸä¸ªå†…éƒ¨å‡½æ•°éå¸¸é‡è¦ï¼Œéœ€è¦å•ç‹¬å…³å¿ƒå®ƒçš„è°ƒç”¨æ—¶é•¿ã€‚</p><p>æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Annotations æ¥å•ç‹¬åˆ›å»ºè‡ªå·±çš„ Spanã€‚</p><blockquote><p>è¿™ä¸ª Annotations å’Œ Dapper ä¸­çš„ä¸æ˜¯åŒä¸€ä¸ªï¼Œåªæ˜¯ Java ä¸­çš„æ³¨è§£ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> &#123;  </span><br><span class="line">    Executors.newFixedThreadPool(<span class="number">1</span>).execute(() -&gt; &#123;  </span><br><span class="line">        myMethod(request.getName());  </span><br><span class="line">    &#125;);    </span><br><span class="line">    </span><br><span class="line">    <span class="type">HelloReply</span> <span class="variable">reply</span> <span class="operator">=</span> HelloReply.newBuilder()  </span><br><span class="line">            .setMessage(<span class="string">&quot;Hello ==&gt; &quot;</span> + request.getName())  </span><br><span class="line">            .build();  </span><br><span class="line">    responseObserver.onNext(reply);  </span><br><span class="line">    responseObserver.onCompleted();  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@SneakyThrows</span>  </span><br><span class="line"><span class="meta">@WithSpan</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myMethod</span><span class="params">(<span class="meta">@SpanAttribute(&quot;request.name&quot;)</span> String name)</span> &#123;  </span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>);  </span><br><span class="line">    log.info(<span class="string">&quot;myMethod:&#123;&#125;&quot;</span>, name);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥è¿™æ®µä»£ç ä¸ºä¾‹ï¼Œè¿™æ˜¯ä¸€ä¸ª gRPC çš„æœåŠ¡ç«¯æ¥å£ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¸­è°ƒç”¨äº†ä¸€ä¸ªå‡½æ•° <code>myMethod</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹å¹¶ä¸ä¼šä¸ºå®ƒå•ç‹¬åˆ›å»ºä¸€ä¸ª Spanã€‚</p><p>ä½†å¦‚æœæˆ‘ä»¬æƒ³å•ç‹¬è®°å½•å®ƒï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>@WithSpan</code> è¿™ä¸ªæ³¨è§£ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨  <code>@SpanAttribute</code> æ¥è‡ªå®šä¹‰ attributeã€‚</p><p>æœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://s2.loli.net/2024/05/05/aBd1ubsS2kxMzGf.png"><br>æ­¤æ—¶å°±ä¼šå•ç‹¬ä¸ºè¿™ä¸ªå‡½æ•°åˆ›å»ºä¸€ä¸ª Spanã€‚</p><blockquote><p>éœ€è¦å•ç‹¬å¼•å…¥ä¸€ä¸ªä¾èµ–:</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentelemetry.instrumentation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentelemetry-instrumentation-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="Context-Propagation"><a href="#Context-Propagation" class="headerlink" title="Context Propagation"></a>Context Propagation</h1><p>ä¸Šä¸‹æ–‡ä¼ æ’­ä¹Ÿæ˜¯ Trace ä¸­éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œåˆšæ‰æåˆ°äº†æ¯ä¸ª Span éƒ½æœ‰è‡ªå·±ä¸å¯å˜çš„ä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆåç»­çš„ Span å¦‚ä½•å’Œä¸Šæ¸¸çš„ Span è¿›è¡Œå…³è”å‘¢ï¼Ÿ</p><p>è¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>åŒä¸€è¿›ç¨‹</li><li>å®è¿›ç¨‹</li></ul><h2 id="åŒä¸€è¿›ç¨‹"><a href="#åŒä¸€è¿›ç¨‹" class="headerlink" title="åŒä¸€è¿›ç¨‹"></a>åŒä¸€è¿›ç¨‹</h2><p>åŒä¸€ä¸ªè¿›ç¨‹ä¹Ÿåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ul><li>å•çº¿ç¨‹</li><li>å¤šçº¿ç¨‹</li></ul><p>å•çº¿ç¨‹çš„æ¯”è¾ƒå¥½å¤„ç†ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠæ•°æ®å†™å…¥ <code>ThreadLocal</code> ä¸­å°±å¯ä»¥åšåˆ°çº¿ç¨‹éš”ç¦»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Context&gt; THREAD_LOCAL_STORAGE = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="meta">@Nullable</span>  </span><br><span class="line"><span class="keyword">public</span> Context <span class="title function_">current</span><span class="params">()</span> &#123;  </span><br><span class="line">  <span class="keyword">return</span> THREAD_LOCAL_STORAGE.get();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç‚¹æˆ‘ä»¬å¯ä»¥é€šè¿‡æºç  <code>io.opentelemetry.context.ThreadLocalContextStorage</code>çœ‹åˆ°å…·ä½“çš„å®ç°è¿‡ç¨‹ã€‚</p><p>è€Œå¦‚æœæ˜¯å¤šçº¿ç¨‹æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Executors.newFixedThreadPool(<span class="number">1</span>).execute(() -&gt; &#123;  </span><br><span class="line">    myMethod(request.getName());  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>åˆ™éœ€è¦å¯¹ä½¿ç”¨çš„çº¿ç¨‹æ± è¿›è¡Œå•ç‹¬å¤„ç†ï¼Œå°†çˆ¶çº¿ç¨‹ä¸­ threadlocal ä¸­çš„æ•°æ®æ‹·è´å‡ºæ¥è¿›è¡Œä¼ é€’ï¼Œæ¯”å¦‚æœ‰é˜¿é‡Œæä¾›çš„ <code>TransmittableThreadLocal</code>ï¼Œå¯ä»¥æä¾›å¯¹çº¿ç¨‹æ± çš„æ”¯æŒã€‚</p><h2 id="è·¨è¿›ç¨‹"><a href="#è·¨è¿›ç¨‹" class="headerlink" title="è·¨è¿›ç¨‹"></a>è·¨è¿›ç¨‹</h2><p>è€Œå¦‚æœæ˜¯å®è¿›ç¨‹çš„åœºæ™¯ï¼Œå°±éœ€è¦å°† context çš„ä¿¡æ¯è¿›è¡Œåºåˆ—åŒ–ä¼ é€’ã€‚</p><p>å¦‚æœæ˜¯ gRPC è°ƒç”¨ä¼šå°†ä¿¡æ¯å­˜æ”¾åˆ° metadata ä¸­ã€‚</p><p>HTTP è°ƒç”¨åˆ™æ˜¯å­˜æ”¾åœ¨ header ä¸­ã€‚</p><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯”å¦‚ Pulsar ä¹Ÿå¯ä»¥å°†æ•°æ®å­˜æ”¾åœ¨æ¶ˆæ¯ä¸­çš„ header ä¸­è¿›è¡Œä¼ é€’ã€‚</p><p>æ•°æ®ä¸€æ—¦è·¨è¿›ç¨‹ä¼ è¾“æˆåŠŸåï¼Œå°±å’Œå•è¿›ç¨‹ä¸€æ ·çš„å¤„ç†æ–¹å¼äº†ã€‚</p><h2 id="Baggage"><a href="#Baggage" class="headerlink" title="Baggage"></a>Baggage</h2><p><img src="https://s2.loli.net/2024/05/05/3c6LNtIbSkpQlRU.png"></p><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦é€šè¿‡å® Span ä¼ é€’ä¿¡æ¯ï¼Œæ¯”å¦‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š<br>æˆ‘ä»¬éœ€è¦åœ¨ serverB ä¸­æ‹¿åˆ° serverA ä¸­æ”¶åˆ°çš„ä¸€ä¸ªè¯·æ±‚å‚æ•°ï¼š <code>http://127.0.0.1:8181/request\?name\=1232</code></p><p><img src="https://s2.loli.net/2024/05/05/hISQNv91KP85WFC.png"></p><p>è¿™ä¸ªæ•°æ®é»˜è®¤ä¼šä½œä¸º span çš„ attribute ï¼Œä½†åªä¼šå­˜åœ¨äºç¬¬ä¸€ä¸ª spanã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨åç»­çš„ span ä¸­ä¹Ÿèƒ½æ‹¿åˆ°è¿™ä¸ªæ•°æ®ï¼Œç”šè‡³æ˜¯å®è¿›ç¨‹ä¹Ÿèƒ½è·å–åˆ°ã€‚</p><p>é‚£å°±éœ€è¦ä½¿ç”¨ <code>Baggage</code> è¿™ä¸ªå¯¹è±¡äº†ã€‚</p><p>å®ƒçš„ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/request&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">request</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> &#123;  </span><br><span class="line"><span class="comment">// å†™å…¥</span></span><br><span class="line">    Baggage.current().toBuilder().  </span><br><span class="line">          put(<span class="string">&quot;request.name&quot;</span>, name).build()  </span><br><span class="line">          .storeInContext(Context.current()).makeCurrent();</span><br><span class="line">&#125;         </span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–</span></span><br><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> Baggage.current().getEntryValue(<span class="string">&quot;request.name&quot;</span>);  </span><br><span class="line">log.info(<span class="string">&quot;request.name: &#123;&#125;&quot;</span>, value);</span><br></pre></td></tr></table></figure><p>åªè¦æ˜¯å±äºåŒä¸€ä¸ª trace çš„è°ƒç”¨å°±å¯ä»¥ç›´æ¥è·å–åˆ°æ•°æ®ã€‚<br><img src="https://s2.loli.net/2024/05/05/Lz1hY8pflRebANx.png"></p><blockquote><p>traceId ä¹Ÿæ˜¯å® Span ä¼ é€’çš„ã€‚</p></blockquote><p>è€Œå®ƒçš„åŸç†ä¹Ÿæ˜¯é€šè¿‡å¾€ context ä¸­å†™å…¥æ•°æ®å®ç°çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Immutable</span>  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaggageContextKey</span> &#123;  </span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> ContextKey&lt;Baggage&gt; KEY = ContextKey.named(<span class="string">&quot;opentelemetry-baggage-key&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">BaggageContextKey</span><span class="params">()</span> &#123;&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/05/05/vIHtBxGATKOg13l.png"><br>è€Œè¿™ä¸ª context æ˜¯é€šè¿‡ä¸€ä¸ª entries æ•°æ®å­˜å‚¨æ•°æ®çš„ï¼Œä¸ç®¡æ˜¯åœ¨å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨çš„è·¨è¿›ç¨‹è°ƒç”¨ï¼ŒOpenTelemetry éƒ½ä¼šå°† context é€šè¿‡ <code>Context Propagation</code> ä¼ é€’å‡ºå»ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>Trace è¿™éƒ¨åˆ†çš„å†…å®¹æˆ‘è§‰å¾—æ¯” Metrics å’Œ Logs æ›´åŠ å¤æ‚ä¸€äº›ï¼Œæ¯•ç«Ÿå¤šäº†ä¸€äº›æ•°æ®ç»“æ„ï¼›ç°åœ¨çš„å†…å®¹ä¹Ÿåªæ˜¯å†°å±±ä¸€è§’ï¼Œç°åœ¨ä¹Ÿåœ¨åš trace çš„ä¸€äº›å®šåˆ¶åŒ–å¼€å‘ï¼Œåç»­æœ‰æ–°çš„è¿›å±•ä¼šæ¥ç€æ›´æ–°ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/papers/dapper-2010-1.pdf">https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/papers/dapper-2010-1.pdf</a></li><li><a href="https://opentelemetry.io/docs/languages/java/automatic/annotations/">https://opentelemetry.io/docs/languages/java/automatic/annotations/</a></li><li><a href="https://opentelemetry.io/docs/specs/otel/overview/#tracing-signal">https://opentelemetry.io/docs/specs/otel/overview/#tracing-signal</a></li><li><a href="https://opentelemetry.io/docs/concepts/context-propagation/">https://opentelemetry.io/docs/concepts/context-propagation/</a></li><li><a href="https://opentelemetry.io/docs/concepts/observability-primer/#distributed-traces">https://opentelemetry.io/docs/concepts/observability-primer/#distributed-traces</a></li><li><a href="https://tech.meituan.com/2023/04/20/traceid-google-dapper-mtrace.html">https://tech.meituan.com/2023/04/20/traceid-google-dapper-mtrace.html</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨ä¹‹å‰å†™è¿‡ä¸¤ç¯‡æ¯”è¾ƒç³»ç»Ÿçš„å…³äº OpenTelemetry çš„æ–‡ç« ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7358450927110357026&quot;&gt;OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7360216766373068837&quot;&gt;å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»åŸºæœ¬æ¦‚å¿µåˆ°å¦‚ä½•éƒ¨ç½² demo å®æˆ˜äº†è§£ OpenTelemetryï¼Œä»é‚£ä¸ª demo ä¸­ä¹Ÿå¯ä»¥å¾—çŸ¥æ•´ä¸ª OpenTelemetry ä½“ç³»çš„å¤æ‚æ€§ï¼ŒåŒ…å«äº†å¤ªå¤šçš„ç»„ä»¶å’Œæ¦‚å¿µã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†èƒ½æ›´æ¸…æ™°çš„äº†è§£æ¯ä¸ªå…³é”®ç»„ä»¶çš„ä½œç”¨ä»¥åŠåŸç†ï¼Œæˆ‘æ‰“ç®—åˆ†ä¸ºå‡ æœŸæ¥è®²è§£ OpenTelemetry çš„ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Trace&lt;/li&gt;
&lt;li&gt;Metrics&lt;/li&gt;
&lt;li&gt;Logs&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é¦–å…ˆä»¥ Trace è®²èµ·ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>ã€è¯‘ã€‘å‡ ä¸ªä½ æˆ–è®¸å¹¶ä¸çŸ¥é“ kubernetes æŠ€å·§</title>
    <link href="http://crossoverjie.top/2024/06/03/ob/Kubernetes-tricks/"/>
    <id>http://crossoverjie.top/2024/06/03/ob/Kubernetes-tricks/</id>
    <published>2024-06-03T10:05:25.000Z</published>
    <updated>2024-06-03T13:10:27.508Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2024/06/03/AoNyHhS4sl96tFx.png"></p><p>åŸæ–‡é“¾æ¥: <a href="https://overcast.blog/13-kubernetes-tricks-you-didnt-know-647de6364472">https://overcast.blog/13-kubernetes-tricks-you-didnt-know-647de6364472</a></p><h1 id="ä½¿ç”¨-PreStop-ä¼˜é›…å…³é—­-Pod"><a href="#ä½¿ç”¨-PreStop-ä¼˜é›…å…³é—­-Pod" class="headerlink" title="ä½¿ç”¨ PreStop ä¼˜é›…å…³é—­ Pod"></a>ä½¿ç”¨ PreStop ä¼˜é›…å…³é—­ Pod</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">graceful-shutdown-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sample-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 30 &amp;&amp; nginx -s quit&quot;</span>]</span><br></pre></td></tr></table></figure><p>PreStop å…è®¸ Pod åœ¨ç»ˆæ­¢å‰æ‰§è¡Œä¸€ä¸ªå‘½ä»¤æˆ–è€…æ˜¯è„šæœ¬ï¼Œä½¿ç”¨å®ƒå°±å¯ä»¥åœ¨åº”ç”¨é€€å‡ºå‰é‡Šæ”¾ä¸€äº›èµ„æºï¼Œç¡®ä¿åº”ç”¨å¯ä»¥ä¼˜é›…é€€å‡ºã€‚</p><p>æ¯”å¦‚å¯ä»¥åœ¨ Nginx çš„ Pod é€€å‡ºå‰å°†å½“å‰çš„è¯·æ±‚æ‰§è¡Œå®Œæ¯•ã€‚</p><span id="more"></span><h1 id="ä½¿ç”¨ä¸´æ—¶å®¹å™¨è°ƒè¯•-Pod"><a href="#ä½¿ç”¨ä¸´æ—¶å®¹å™¨è°ƒè¯•-Pod" class="headerlink" title="ä½¿ç”¨ä¸´æ—¶å®¹å™¨è°ƒè¯• Pod"></a>ä½¿ç”¨ä¸´æ—¶å®¹å™¨è°ƒè¯• Pod</h1><p>ä¸´æ—¶å®¹å™¨å¯ä»¥ä¸ä¿®æ”¹ä¸€ä¸ªè¿è¡Œçš„å®¹å™¨çš„å‰æä¸‹è°ƒè¯•å®¹å™¨ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è°ƒè¯•ä¸€äº›ç”Ÿäº§ç¯å¢ƒçš„ bugï¼Œå¯ä»¥é¿å…é‡å¯åº”ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl alpha debug -it podname --image=busybox --target=containername</span><br></pre></td></tr></table></figure><p>ç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨ï¼Œåªæœ‰åœ¨å½“å‰ç¯å¢ƒä¸‹æ— æ³•æ’æŸ¥é—®é¢˜çš„æ—¶å€™æ‰ä½¿ç”¨ã€‚</p><h1 id="åŸºäºè‡ªå®šä¹‰çš„-Metrics-è‡ªåŠ¨æ‰©å®¹Pod"><a href="#åŸºäºè‡ªå®šä¹‰çš„-Metrics-è‡ªåŠ¨æ‰©å®¹Pod" class="headerlink" title="åŸºäºè‡ªå®šä¹‰çš„  Metrics è‡ªåŠ¨æ‰©å®¹Pod"></a>åŸºäºè‡ªå®šä¹‰çš„  Metrics è‡ªåŠ¨æ‰©å®¹Pod</h1><p>kubernetes æ˜¯æä¾›äº† HPA æœºåˆ¶å¯ä»¥è·Ÿè¿› CPU å†…å­˜ç­‰æ ‡å‡†æ•°æ®è¿›è¡Œè‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬éœ€è¦æ ¹æ®è‡ªå®šä¹‰çš„æ•°æ®è¿›è¡Œæ‰©ç¼©å®¹ã€‚</p><p>æ¯”å¦‚æŸä¸ªæ¥å£çš„å»¶è¿Ÿã€é˜Ÿåˆ—å¤§å°ç­‰ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">custom-metric-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">your-application</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span></span><br><span class="line">    <span class="attr">pods:</span></span><br><span class="line">      <span class="attr">metric:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">your_custom_metric</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">AverageValue</span></span><br><span class="line">        <span class="attr">averageValue:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><h1 id="ç”¨-Init-Containers-é…ç½®å¯åŠ¨è„šæœ¬"><a href="#ç”¨-Init-Containers-é…ç½®å¯åŠ¨è„šæœ¬" class="headerlink" title="ç”¨ Init Containers é…ç½®å¯åŠ¨è„šæœ¬"></a>ç”¨ Init Containers é…ç½®å¯åŠ¨è„šæœ¬</h1><p>åˆå§‹åŒ–å®¹å™¨å¯ä»¥åœ¨åº”ç”¨å®¹å™¨å¯åŠ¨å‰è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥åˆå§‹åŒ–åº”ç”¨éœ€è¦çš„é…ç½®ã€ç­‰å¾…ä¾èµ–çš„æœåŠ¡å¯åŠ¨å®Œæˆç­‰å·¥ä½œï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-myservice</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until nslookup myservice; do echo waiting for myservice; sleep 2; done;&#x27;</span>]</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™ä¸ªåˆå§‹åŒ–å®¹å™¨ä¼šç­‰å¾… myservice å¯ç”¨åæ‰ä¼šå¯åŠ¨åº”ç”¨ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœåˆå§‹åŒ–å®¹å™¨ä¼šé˜»å¡åº”ç”¨å¯åŠ¨ï¼Œæ‰€ä»¥è¦é¿å…åœ¨åˆå§‹åŒ–å®¹å™¨é‡Œæ‰§è¡Œè€—æ—¶æ“ä½œã€‚</p><h1 id="Node-äº²å’Œæ€§è°ƒåº¦"><a href="#Node-äº²å’Œæ€§è°ƒåº¦" class="headerlink" title="Node äº²å’Œæ€§è°ƒåº¦"></a>Node äº²å’Œæ€§è°ƒåº¦</h1><p>å½“æˆ‘ä»¬éœ€è¦å°†æŸäº›åº”ç”¨éƒ¨ç½²åˆ°ç¡¬ä»¶é…ç½®è¾ƒé«˜çš„èŠ‚ç‚¹æ—¶ï¼ˆæ¯”å¦‚éœ€è¦ SSD ç¡¬ç›˜ï¼‰ï¼Œå°±å¯ä»¥ä½¿ç”¨èŠ‚ç‚¹äº²å’Œæ€§æ¥éƒ¨ç½²åº”ç”¨ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">disktype</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ª Pod ä¼šè¢«éƒ¨ç½²åˆ°æœ‰è¿™ä¸ª <code>disktype=ssd</code> æ ‡ç­¾çš„ èŠ‚ç‚¹ä¸Šã€‚</p><h1 id="åŠ¨æ€é…ç½®ï¼šConfigMap-å’Œ-Secrets"><a href="#åŠ¨æ€é…ç½®ï¼šConfigMap-å’Œ-Secrets" class="headerlink" title="åŠ¨æ€é…ç½®ï¼šConfigMap å’Œ Secrets"></a>åŠ¨æ€é…ç½®ï¼šConfigMap å’Œ Secrets</h1><p>ConfigMap å’Œ Secretså¯ä»¥åŠ¨æ€æ³¨å…¥åˆ° Pod ä¸­ï¼Œé¿å…å¯¹è¿™äº›é…ç½®ç¡¬ç¼–ç ã€‚</p><p>ConfigMap é€‚åˆéæ•æ„Ÿçš„æ•°æ®ï¼ŒSecrets é€‚åˆæ•æ„Ÿçš„æ•°æ®ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ConfigMap Example</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;key&quot;: &quot;value&quot;,</span></span><br><span class="line"><span class="string">      &quot;databaseURL&quot;: &quot;http://mydatabase.example.com&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="comment"># Pod Spec using ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">app-config</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·åœ¨åº”ç”¨ä¸­å°±å¯ä»¥é€šè¿‡è¿™è·¯å¾„ <code>/etc/config/config.json</code> è¯»å–æ•°æ®äº†ã€‚</p><blockquote><p>å½“ç„¶ä¹Ÿå¯ä»¥æŠŠè¿™äº›æ•°æ®å†™å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­ã€‚</p></blockquote><p>ä»¥ä¸Šè¿™äº›ä¸ªäººæŠ€å·§ç”¨çš„æœ€å¤šçš„æ˜¯ï¼š</p><ul><li>ä¸´æ—¶å®¹å™¨è°ƒè¯• Podï¼Œç‰¹åˆ«æ˜¯ä¸šåŠ¡å®¹å™¨ç¼ºå°‘ä¸€äº›å‘½ä»¤æ—¶ã€‚</li><li>Init Container ç­‰å¾…ä¾èµ–çš„æœåŠ¡å¯åŠ¨å®Œæˆã€‚</li><li>Node äº²å’Œæ€§è°ƒåº¦ã€‚</li><li>ConfigMap æ˜¯åŸºç¡€æ“ä½œäº†ã€‚</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/06/03/AoNyHhS4sl96tFx.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;åŸæ–‡é“¾æ¥: &lt;a href=&quot;https://overcast.blog/13-kubernetes-tricks-you-didnt-know-647de6364472&quot;&gt;https://overcast.blog/13-kubernetes-tricks-you-didnt-know-647de6364472&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;ä½¿ç”¨-PreStop-ä¼˜é›…å…³é—­-Pod&quot;&gt;&lt;a href=&quot;#ä½¿ç”¨-PreStop-ä¼˜é›…å…³é—­-Pod&quot; class=&quot;headerlink&quot; title=&quot;ä½¿ç”¨ PreStop ä¼˜é›…å…³é—­ Pod&quot;&gt;&lt;/a&gt;ä½¿ç”¨ PreStop ä¼˜é›…å…³é—­ Pod&lt;/h1&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;graceful-shutdown-example&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;sample-container&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;image:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;nginx&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;lifecycle:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attr&quot;&gt;preStop:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;exec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attr&quot;&gt;command:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&amp;quot;/bin/sh&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;-c&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;sleep 30 &amp;amp;&amp;amp; nginx -s quit&amp;quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;PreStop å…è®¸ Pod åœ¨ç»ˆæ­¢å‰æ‰§è¡Œä¸€ä¸ªå‘½ä»¤æˆ–è€…æ˜¯è„šæœ¬ï¼Œä½¿ç”¨å®ƒå°±å¯ä»¥åœ¨åº”ç”¨é€€å‡ºå‰é‡Šæ”¾ä¸€äº›èµ„æºï¼Œç¡®ä¿åº”ç”¨å¯ä»¥ä¼˜é›…é€€å‡ºã€‚&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚å¯ä»¥åœ¨ Nginx çš„ Pod é€€å‡ºå‰å°†å½“å‰çš„è¯·æ±‚æ‰§è¡Œå®Œæ¯•ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¿»è¯‘" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/"/>
    
    <category term="kubernetes" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="http://crossoverjie.top/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>å®æ“ OpenTelemetryï¼šé€šè¿‡ Demo æŒæ¡å¾®æœåŠ¡ç›‘æ§çš„è‰ºæœ¯</title>
    <link href="http://crossoverjie.top/2024/05/26/ob/OTel-demo/"/>
    <id>http://crossoverjie.top/2024/05/26/ob/OTel-demo/</id>
    <published>2024-05-26T02:49:02.000Z</published>
    <updated>2024-05-26T11:35:45.037Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://crossoverjie.top/2024/05/21/ob/OpenTelemetry-getstart/">OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ</a>ä¸­å›é¡¾äº†å¯è§‚æµ‹æ€§çš„å†å²ä»¥åŠä»‹ç»äº†ä¸€äº› OpenTelemetry çš„åŸºç¡€æ¦‚å¿µï¼ŒåŒæ—¶ä¹Ÿä»‹ç»äº† OpenTelemetry ç¤¾åŒºå¸¸ç”¨çš„å¼€æºé¡¹ç›®ã€‚</p><p>åŸºç¡€èƒŒæ™¯çŸ¥è¯†äº†è§£åï¼Œè¿™ç¯‡å°±æ¥ä»‹ç»ä¸€ä¸‹ä½¿ç”¨ OpenTelemetry å¦‚ä½•å®æˆ˜éƒ¨ç½²åº”ç”¨ï¼ŒåŒæ—¶åœ¨ä¸€ä¸ªå¯è§†åŒ–é¡µé¢æŸ¥çœ‹ traceã€metric ç­‰ä¿¡æ¯ã€‚</p><span id="more"></span><h1 id="é¡¹ç›®ä»‹ç»"><a href="#é¡¹ç›®ä»‹ç»" class="headerlink" title="é¡¹ç›®ä»‹ç»"></a>é¡¹ç›®ä»‹ç»</h1><p>æˆ‘ä»¬å‚è€ƒå®˜æ–¹æ–‡æ¡£æ„å»ºå‡ ä¸ª spring boot ã€Golang é¡¹ç›®å†é…åˆ Agent å…¶å®ä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿çš„é›†æˆ OpenTelemetryã€‚</p><p>ä½†æ˜¯è¦å®Œæ•´çš„ä½“éªŒ OpenTelemetry çš„æ‰€æœ‰åŠŸèƒ½ï¼ŒåŒ…å« traceã€logsã€metricsï¼Œè¿˜æœ‰ç¤¾åŒºè¿™ä¹ˆå¤šè¯­è¨€çš„æ”¯æŒå…¶å®è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚</p><p>æˆ‘ä»¬è¿˜éœ€è¦å•ç‹¬éƒ¨ç½² collectorã€å­˜å‚¨çš„ backend service ç­‰ç»„ä»¶ã€åŒ…æ‹¬ trace UI å±•ç¤ºæ‰€éœ€è¦çš„ Jaegerï¼Œmetric æ‰€éœ€è¦çš„ grafana ç­‰ã€‚</p><p>è¿™äº›æ‰€æœ‰ä¸œè¥¿éƒ½è‡ªå·±ä»å¤´å¼„çš„è¯è¿˜æ˜¯æ¯”è¾ƒè´¹æ—¶ï¼Œä¸è¿‡å¥½åœ¨ç¤¾åŒºå·²ç»å°†è¿™äº›æ­¥éª¤éƒ½è€ƒè™‘åˆ°äº†ã€‚</p><p>ç‰¹åœ°ä¸ºå¤§å®¶å†™äº†ä¸€ä¸ª <a href="https://github.com/open-telemetry/opentelemetry-demo">opentelemetry-demo</a>ã€‚</p><p>è¿™ä¸ªé¡¹ç›®æ¨¡æ‹Ÿäº†ä¸€ä¸ªå¾®æœåŠ¡ç‰ˆæœ¬çš„ç”µå­å•†åŸï¼Œä¸»è¦åŒ…å«äº†ä»¥ä¸‹ä¸€äº›é¡¹ç›®ï¼š</p><table><thead><tr><th>Service</th><th>Language</th><th>Description</th></tr></thead><tbody><tr><td><a href="accounting/">accountingservice</a></td><td>Go</td><td>å¤„ç†å’Œè®¡ç®—è®¢å•æ•°æ®</td></tr><tr><td><a href="ad/">adservice</a></td><td>Java</td><td>å¹¿å‘ŠæœåŠ¡</td></tr><tr><td><a href="cart/">cartservice</a></td><td>.NET</td><td>è´­ç‰©è½¦æœåŠ¡ï¼Œä¸»è¦ä¼šä¾èµ– Redis</td></tr><tr><td><a href="checkout/">checkoutservice</a></td><td>Go</td><td>checkout</td></tr><tr><td><a href="currency/">currencyservice</a></td><td>C++</td><td>è´§å¸è½¬æ¢æœåŠ¡ï¼Œæä¾›äº†è¾ƒé«˜çš„ QPS èƒ½åŠ›ã€‚</td></tr><tr><td><a href="email/">emailservice</a></td><td>Ruby</td><td>é‚®ä»¶æœåŠ¡</td></tr><tr><td><a href="fraud-detection/">frauddetectionservice</a></td><td>Kotlin</td><td>é£æ§æœåŠ¡</td></tr><tr><td><a href="frontend/">frontend</a></td><td>JavaScript</td><td>å‰ç«¯åº”ç”¨</td></tr><tr><td><a href="load-generator/">loadgenerator</a></td><td>Python&#x2F;Locust</td><td>æ¨¡æ‹Ÿå‹æµ‹æœåŠ¡</td></tr><tr><td><a href="payment/">paymentservice</a></td><td>JavaScript</td><td>æ”¯ä»˜æœåŠ¡</td></tr><tr><td><a href="product-catalog/">productcatalogservice</a></td><td>Go</td><td>å•†å“æœåŠ¡</td></tr><tr><td><a href="quote/">quoteservice</a></td><td>PHP</td><td>æˆæœ¬æœåŠ¡</td></tr><tr><td><a href="recommendation/">recommendationservice</a></td><td>Python</td><td>æ¨èæœåŠ¡</td></tr><tr><td><a href="shipping/">shippingservice</a></td><td>Rust</td><td>shipping service</td></tr><tr><td>å¯ä»¥å‘ç°åœ¨è¿™ä¸ª demo ä¸­æä¾›äº†è®¸å¤šçš„æœåŠ¡ï¼Œè€Œä¸”åŒ…å«äº†å‡ ä¹æ‰€æœ‰ä¸»æµçš„è¯­è¨€ï¼Œå¯ä»¥å¾ˆå¥½çš„æ¨¡æ‹Ÿæˆ‘ä»¬å®é™…çš„ä½¿ç”¨åœºæ™¯äº†ã€‚</td><td></td><td></td></tr></tbody></table><p><img src="https://s2.loli.net/2024/04/20/NahleoLGbv9tSuE.png"></p><p>é€šè¿‡è¿™å¼ å›¾å¯ä»¥æ›´ç›´è§‚çš„æŸ¥çœ‹å„ä¸ªæœåŠ¡ä¹‹é—´çš„å…³ç³»ã€‚</p><p>æ•´ä½“æ¥è¯´å‰ç«¯æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šé€šè¿‡ <code>front-end-proxy</code> è¿™ä¸ªç»„ä»¶ä»£ç†ï¼Œæœ€ç»ˆå†ç”± front è¿™ä¸ªæœåŠ¡è¿›è¡Œè½¬å‘åˆ°ä¸åŒçš„åç«¯æœåŠ¡ä¸­ã€‚</p><hr><p><img src="https://s2.loli.net/2024/04/20/wLVI1mSzYKjt2Fo.png"><br>é™¤äº†ä¸€ä¸ªé¡¹ç›®çš„æ¶æ„å›¾ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå…³äº OpenTelemetry çš„æ•°æ®æµè½¬å›¾ã€‚</p><p>åœ¨ OpenTelemetry ä¸­æ•°æ®æµè½¬æ˜¯å®ƒçš„ç‰¹ç‚¹ä¹Ÿæ˜¯éå¸¸é‡è¦çš„æ ¸å¿ƒï¼Œè¿™ç‚¹åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è®²è¿‡ï¼Œç”¨æˆ·å¯ä»¥è‡ªç”±å®šåˆ¶æ•°æ®çš„æµè½¬ä»¥åŠä»»æ„çš„å¤„ç†æ•°æ®ï¼Œåœ¨è¿™ä¸ªå›¾ä¸­å°±å°†æ•°æ®æµè½¬å¯è§†åŒ–äº†ã€‚</p><ul><li>å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ OTLP åè®®æˆ–è€…æ˜¯ HTTP å°†æ•°æ®ä¸Šä¼ åˆ° OTel Collector ä¸­ã€‚</li><li>åœ¨ collector ä¸­ä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„ Process pipeline å¤„ç†æ•°æ®ã€‚</li><li>Metric æ•°æ®é€šè¿‡  OTLP HTTP exporter å°†æ•°æ®å¯¼å…¥åˆ° Prometheus ä¸­ã€‚<ul><li><a href="https://github.com/prometheus/prometheus/pull/12571">Prometheus</a> å·²ç»äº 23 å¹´ä¸ƒæœˆä»½æ”¯æŒ OTLP æ ¼å¼çš„ metric æ•°æ®å¯¼å…¥äº†ã€‚</li></ul></li><li>Trace æ•°æ®åˆ™æ˜¯é€šè¿‡ OTLP Exporter å†™å…¥åˆ° Jaeger ä¸­è¿›è¡Œå­˜å‚¨ï¼Œæœ€åé€šè¿‡ Jaeger çš„ UI è¿›è¡ŒæŸ¥è¯¢å±•ç¤ºã€‚</li><li>è€Œå­˜å…¥ Prometheus ä¸­çš„ metric æ•°æ®åˆ™æ˜¯æœ‰ grafana è¿›è¡ŒæŸ¥è¯¢ã€‚</li></ul><blockquote><p>å…³äº collector çš„é…ç½®ä¼šåœ¨åæ–‡è®²è§£ã€‚</p></blockquote><h1 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h1><p>æ¥ä¸‹æ¥ä¾¿æ˜¯å®‰è£… Demo äº†ï¼Œæˆ‘æ›´æ¨èä½¿ç”¨ helm å®‰è£…ã€‚</p><p>è¿™é‡Œçš„ç‰ˆæœ¬è¦æ±‚æ˜¯ï¼š</p><ul><li>Kubernetes 1.24+</li><li>Helm 3.9+</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts</span><br><span class="line">helm repo update</span><br><span class="line">helm install my-otel-demo open-telemetry/opentelemetry-demo</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥å¾ˆç®€å•çš„å°† demo æ‰€æ¶‰åŠåˆ°çš„æ‰€æœ‰ç»„ä»¶å’ŒæœåŠ¡éƒ½å®‰è£…åˆ° default å‘½åç©ºé—´ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm show values open-telemetry/opentelemetry-demo &gt; demo.yaml</span><br></pre></td></tr></table></figure><p>ä¸è¿‡åœ¨å®‰è£…å‰è¿˜æ˜¯å»ºè®®å…ˆå¯¼å‡ºä¸€ä»½ value.yamlï¼Œä¹‹åå¯ä»¥ä½¿ç”¨è¿™ä¸ª yaml å®šåˆ¶éœ€è¦å®‰è£…çš„ç»„ä»¶ã€‚</p><p>åœ¨è¿™ä¸ª yaml ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰å“ªäº›ç»„ä»¶å’ŒæœåŠ¡å¯ä»¥å®šåˆ¶ï¼š<br><img src="https://s2.loli.net/2024/04/20/oe2S1fr3xPcypB4.png"><br>å¯ä»¥çœ‹åˆ°è¿™é‡ŒåŒ…å«äº†æˆ‘ä»¬åˆšæ‰æåˆ°çš„æ‰€æœ‰æœåŠ¡ï¼Œä»¥åŠè¿™äº›æœåŠ¡æ‰€ä¾èµ–çš„ Kafkaã€redisã€Prometheus ç­‰ä¸­é—´ä»¶ï¼Œéƒ½å¯ä»¥è‡ªå·±è¿›è¡Œå®šåˆ¶ä¿®æ”¹ã€‚</p><p><img src="https://s2.loli.net/2024/04/20/VP5GvtszWolSBnf.png"><br>å½“æ‰€æœ‰çš„ Pod éƒ½æˆåŠŸè¿è¡Œä¹‹åè¡¨ç¤ºå®‰è£…æˆåŠŸã€‚</p><blockquote><p>æ­£å¸¸æƒ…å†µä¸‹å®‰è£…ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæœ€å¤§å¯èƒ½çš„é—®é¢˜å°±æ˜¯é•œåƒæ‹‰å–å¤±è´¥ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å…ˆåœ¨æœ¬åœ°æ‰‹åŠ¨ docker pull ä¸‹æ¥é•œåƒåå†ä¸Šä¼ åˆ°ç§æœï¼Œç„¶åä¿®æ”¹ deployment ä¸­çš„é•œåƒåœ°å€å³å¯ã€‚</p></blockquote><h2 id="æš´éœ²æœåŠ¡"><a href="#æš´éœ²æœåŠ¡" class="headerlink" title="æš´éœ²æœåŠ¡"></a>æš´éœ²æœåŠ¡</h2><p>ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ª demo è¿›è¡Œæµ‹è¯•ï¼Œè¿˜éœ€è¦å°† front-proxy çš„æœåŠ¡æš´éœ²å‡ºæ¥å¯ä»¥åœ¨æœ¬åœ°è®¿é—®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl port-forward svc/my-otel-demo-frontendproxy 8080:8080</span><br></pre></td></tr></table></figure><table><thead><tr><th>Component</th><th>Path</th></tr></thead><tbody><tr><td>Shop é¦–é¡µ</td><td><a href="http://localhost:8080/">http://localhost:8080</a></td></tr><tr><td>Grafana</td><td><a href="http://localhost:8080/grafana">http://localhost:8080/grafana</a></td></tr><tr><td>å‹æµ‹é¡µé¢</td><td><a href="http://localhost:8080/loadgen">http://localhost:8080/loadgen</a></td></tr><tr><td>Jaeger UI</td><td><a href="http://localhost:8080/jaeger/ui">http://localhost:8080/jaeger/ui</a></td></tr><tr><td>æ­£å¸¸æƒ…å†µä¸‹å°±å¯ä»¥æ‰“å¼€è¿™äº›é¡µé¢è¿›è¡Œè®¿é—®äº†ã€‚</td><td></td></tr></tbody></table><p>ä¸è¿‡ä½¿ç”¨ port-forward è½¬å‘çš„æ–¹å¼åªæ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼Œä½¿ç”¨ ctrl+c å°±ä¼šåœæ­¢æš´éœ²æœåŠ¡ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦ä¸€ä¸ªç¨³å®šçš„è®¿é—®é“¾æ¥æ—¶ä¾¿å¯ä»¥é…ç½®ä¸€ä¸ª ingressã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">components:</span></span><br><span class="line">  <span class="attr">frontendProxy:</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">annotations:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">otel-demo.my-domain.com</span></span><br><span class="line">          <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨ä¹‹å‰çš„ helm çš„ value.yaml ä¸­é…ç½®å³å¯ï¼Œæœ¬åœ°æµ‹è¯•çš„è¯éœ€è¦å°†è¿™ä¸ª host å’Œ ingress æš´éœ²å‡ºæ¥çš„ IP è¿›è¡Œç»‘å®šæ‰å¯ä»¥ä½¿ç”¨è¿™ä¸ªåŸŸåæœºè¿›è¡Œè®¿é—®ã€‚</p><p>æ›´å¤šå…³äº ingress çš„ä½¿ç”¨å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« ï¼š</p><ul><li><a href="https://crossoverjie.top/2023/09/15/ob/k8s-Ingress/">k8så…¥é—¨åˆ°å®æˆ˜-ä½¿ç”¨Ingress</a></li></ul><p>å½“ç„¶ç®€å•èµ·è§ä¹Ÿå¯ä»¥ç›´æ¥å°† front-proxy çš„ service ç±»å‹æ”¹ä¸º LoadBalancerã€‚ï¼ˆé»˜è®¤æ˜¯ ClusterIP åªå¯ä»¥åœ¨é›†ç¾¤å†…è®¿é—®ï¼‰</p><p>è¿™æ ·å°±å¯ä»¥ç›´æ¥é€šè¿‡è¿™ä¸ª service çš„ IP è¿›è¡Œè®¿é—®äº†ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">components:</span></span><br><span class="line">  <span class="attr">frontendProxy:</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœ demo å®‰è£…å®Œæˆä¹‹åæ˜¯ä¸å¯ä»¥å†æ¬¡ä¿®æ”¹ service çš„ç±»å‹çš„ï¼Œéœ€è¦æ‰‹åŠ¨è¿™ä¸ª service åˆ æ‰ä¹‹åå†æ¬¡æ–°å»ºæ‰å¯ä»¥ã€‚</p></blockquote><p> ä¸´æ—¶æµ‹è¯•ä½¿ç”¨çš„è¯è¿˜æ˜¯æ¨èç›´æ¥ä½¿ç”¨ port-forward è¿›è¡Œè½¬å‘ã€‚</p><h1 id="æŸ¥çœ‹-Trace"><a href="#æŸ¥çœ‹-Trace" class="headerlink" title="æŸ¥çœ‹ Trace"></a>æŸ¥çœ‹ Trace</h1><p>é€šè¿‡ä¹‹å‰çš„é¡¹ç›®æ¶æ„å›¾å¯ä»¥å¾—çŸ¥ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®é¦–é¡µåˆ·æ–°ä¼šç›´æ¥è¯·æ±‚ AdService æ¥è·å–å¹¿å‘Šã€‚</p><p>ä¸ºäº†ç®€å•èµ·è§æˆ‘ä»¬åªæŸ¥è¯¢è¿™ä¸€é“¾è·¯çš„è°ƒç”¨æƒ…å†µï¼š<br><img src="https://s2.loli.net/2024/04/21/t6a4KvOhSne9yfu.png"></p><p>æ‰“å¼€ <a href="http://localhost:8080/jaeger/ui/search">http://localhost:8080/jaeger/ui/search</a> Jeager çš„ UI é¡µé¢ä¾¿å¯ä»¥ç­›é€‰æœåŠ¡ï¼Œä¹‹åç‚¹å‡»æŸ¥æ‰¾ Traces å°±å¯ä»¥åˆ—å‡ºä¸€æ®µæ—¶é—´å†…çš„è®¿é—® traceã€‚</p><p><img src="https://s2.loli.net/2024/04/21/v8nVLxweyCO9NMm.png"><br>å¯ä»¥çœ‹åˆ°è¿™ä¸ªè¯·æ±‚é“¾è·¯æ˜¯ä»å‰ç«¯è®¿é—®åˆ° adService ä¸­çš„ <code>getAds()</code>æ¥å£ï¼Œç„¶ååœ¨è¿™ä¸ªæ¥å£ä¸­å†è®¿é—®äº† <code>getAdsByCategory</code> å‡½æ•°ã€‚<br><img src="https://s2.loli.net/2024/04/21/3UXmHsCSLFguRZK.png"></p><p>æœ€ç»ˆåœ¨æºç ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ç¬¦åˆé“¾è·¯çš„è°ƒç”¨ä»£ç ã€‚</p><blockquote><p>åœ¨åˆšæ‰çš„é“¾è·¯å›¾çš„å³ä¸‹è§’æœ‰ä¸€ä¸ª spanIDï¼Œæ•´ä¸ª trace æ˜¯ç”±è¿™äº›å°çš„ span ç»„æˆï¼Œæ¯ä¸€ä¸ª span ä¹Ÿä¼šæœ‰å”¯ä¸€ spanIDï¼› trace ä¹Ÿä¼šæœ‰ä¸€ä¸ª traceID å°†è¿™äº› span ä¸²è”èµ·æ¥ï¼›æ›´å¤šå…³äº trace çš„å†…å®¹ä¼šåœ¨åé¢çš„æ–‡ç« è¿›è¡Œåˆ†æã€‚</p></blockquote><h2 id="æŸ¥çœ‹-Metrics"><a href="#æŸ¥çœ‹-Metrics" class="headerlink" title="æŸ¥çœ‹ Metrics"></a>æŸ¥çœ‹ Metrics</h2><p>æˆ‘ä»¬å†æ‰“å¼€ grafana ä¾¿å¯ä»¥çœ‹åˆ°åˆšæ‰è®¿é—®çš„ adService çš„å»¶è¿Ÿå’Œæ¥å£çš„ QPS æƒ…å†µï¼š<br><img src="https://s2.loli.net/2024/04/21/29BlRATOnpkCQwS.png"></p><hr><p>åœ¨opentelemetry-collector-data-flow é¢æ¿ä¸­è¿˜å¯ä»¥çœ‹åˆ° OpenTelemetry çš„æ•°æ®æµè½¬ã€‚<br><img src="https://s2.loli.net/2024/04/21/Tbtiv3gzY5xZIH1.png"></p><blockquote><p>æ›´å¤šç›‘æ§ä¿¡æ¯å¯ä»¥æŸ¥çœ‹å…¶å®ƒçš„é¢æ¿ã€‚</p></blockquote><p>è€Œåˆšæ‰é¢æ¿ä¸­çš„æ•°æ®æµè½¬è§„åˆ™åˆ™æ˜¯åœ¨æˆ‘ä»¬çš„ <a href="https://github.com/open-telemetry/opentelemetry-demo/blob/main/src/otelcollector/otelcol-config.yml">collector</a> ä¸­è¿›è¡Œé…ç½®çš„ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">protocols:</span></span><br><span class="line">      <span class="attr">grpc:</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">cors:</span></span><br><span class="line">          <span class="attr">allowed_origins:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;http://*&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;https://*&quot;</span></span><br><span class="line">  <span class="attr">httpcheck/frontendproxy:</span></span><br><span class="line">    <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">endpoint:</span> <span class="string">http://frontendproxy:$&#123;env:ENVOY_PORT&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">debug:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">&quot;jaeger:4317&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">otlphttp/prometheus:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">&quot;http://prometheus:9090/api/v1/otlp&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">opensearch:</span></span><br><span class="line">    <span class="attr">logs_index:</span> <span class="string">otel</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">endpoint:</span> <span class="string">&quot;http://opensearch:9200&quot;</span></span><br><span class="line">      <span class="attr">tls:</span></span><br><span class="line">        <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="attr">batch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">connectors:</span></span><br><span class="line">  <span class="attr">spanmetrics:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">traces:</span></span><br><span class="line">      <span class="attr">receivers:</span> [<span class="string">otlp</span>]</span><br><span class="line">      <span class="attr">processors:</span> [<span class="string">batch</span>]</span><br><span class="line">      <span class="attr">exporters:</span> [<span class="string">otlp</span>, <span class="string">debug</span>, <span class="string">spanmetrics</span>]</span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">receivers:</span> [<span class="string">httpcheck/frontendproxy</span>, <span class="string">otlp</span>, <span class="string">spanmetrics</span>]</span><br><span class="line">      <span class="attr">processors:</span> [<span class="string">batch</span>]</span><br><span class="line">      <span class="attr">exporters:</span> [<span class="string">otlphttp/prometheus</span>, <span class="string">debug</span>]</span><br><span class="line">    <span class="attr">logs:</span></span><br><span class="line">      <span class="attr">receivers:</span> [<span class="string">otlp</span>]</span><br><span class="line">      <span class="attr">processors:</span> [<span class="string">batch</span>]</span><br><span class="line">      <span class="attr">exporters:</span> [<span class="string">opensearch</span>, <span class="string">debug</span>]</span><br></pre></td></tr></table></figure><p>é‡ç‚¹çš„å°±æ˜¯è¿™é‡Œçš„ <code>service.piplines</code>ï¼Œå¯ä»¥è¿›è¡Œä»»æ„çš„ç»„è£…ã€‚</p><p>æ›´å¤šå…³äº collector çš„é…ç½®ä¹Ÿä¼šåœ¨åç»­æ–‡ç« ä¸­ç»§ç»­è®²è§£ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»§ç»­è®¿é—®è¿™ä¸ª demo ç½‘ç«™ï¼Œæ¨¡æ‹ŸåŠ å…¥è´­ç‰©è½¦ã€ä¸‹å•ç­‰è¡Œä¸ºï¼Œå†ç»“åˆ trace å’Œ metric è§‚å¯Ÿç³»ç»Ÿçš„å˜åŒ–ã€‚</p><p>è¿™æ ·ä¸€ä¸ªå®Œæ•´çš„ OpenTelemetry-Demo å°±æ­å»ºå®Œæ¯•äº†ï¼Œæˆ‘ä»¬å®é™…åœ¨ç”Ÿäº§ç¯å¢ƒä½¿æ—¶å®Œå…¨å¯ä»¥å‚è€ƒè¿™ä¸ª demo è¿›è¡Œé…ç½®ï¼Œå¯ä»¥å°‘è¸©å¾ˆå¤šå‘ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-demo/blob/main/src/adservice/Dockerfile">https://github.com/open-telemetry/opentelemetry-demo/blob/main/src/adservice/Dockerfile</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-demo">https://github.com/open-telemetry/opentelemetry-demo</a></li><li><a href="https://github.com/prometheus/prometheus/pull/12571">https://github.com/prometheus/prometheus/pull/12571</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-demo/blob/main/src/otelcollector/otelcol-config.yml">https://github.com/open-telemetry/opentelemetry-demo/blob/main/src/otelcollector/otelcol-config.yml</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç«  &lt;a href=&quot;https://crossoverjie.top/2024/05/21/ob/OpenTelemetry-getstart/&quot;&gt;OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ&lt;/a&gt;ä¸­å›é¡¾äº†å¯è§‚æµ‹æ€§çš„å†å²ä»¥åŠä»‹ç»äº†ä¸€äº› OpenTelemetry çš„åŸºç¡€æ¦‚å¿µï¼ŒåŒæ—¶ä¹Ÿä»‹ç»äº† OpenTelemetry ç¤¾åŒºå¸¸ç”¨çš„å¼€æºé¡¹ç›®ã€‚&lt;/p&gt;
&lt;p&gt;åŸºç¡€èƒŒæ™¯çŸ¥è¯†äº†è§£åï¼Œè¿™ç¯‡å°±æ¥ä»‹ç»ä¸€ä¸‹ä½¿ç”¨ OpenTelemetry å¦‚ä½•å®æˆ˜éƒ¨ç½²åº”ç”¨ï¼ŒåŒæ—¶åœ¨ä¸€ä¸ªå¯è§†åŒ–é¡µé¢æŸ¥çœ‹ traceã€metric ç­‰ä¿¡æ¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetry å®è·µæŒ‡å—ï¼šå†å²ã€æ¶æ„ä¸åŸºæœ¬æ¦‚å¿µ</title>
    <link href="http://crossoverjie.top/2024/05/21/ob/OpenTelemetry-getstart/"/>
    <id>http://crossoverjie.top/2024/05/21/ob/OpenTelemetry-getstart/</id>
    <published>2024-05-21T13:46:00.000Z</published>
    <updated>2024-05-20T13:14:03.156Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ä¹‹å‰é™†ç»­å†™è¿‡ä¸€äº›å’Œ OpenTelemetry ç›¸å…³çš„æ–‡ç« ï¼š</p><ul><li><a href="https://crossoverjie.top/2024/04/07/ob/otel-replace-sw/">å®æˆ˜ï¼šå¦‚ä½•ä¼˜é›…çš„ä» Skywalking åˆ‡æ¢åˆ° OpenTelemetry</a></li><li><a href="https://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/">å®æˆ˜ï¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª OpenTelemetry Extensions</a></li><li><a href="https://juejin.cn/post/7356138322367266854">ä»ä¸€ä¸ª JDK21+OpenTelemetry ä¸å…¼å®¹çš„é—®é¢˜è®²èµ·</a></li></ul><p>è¿™äº›å†…å®¹çš„å‰ææ˜¯æœ€å¥½æœ‰ä¸€äº› OpenTelemetry çš„èƒŒæ™¯çŸ¥è¯†ï¼Œçœ‹èµ·æ¥å°±ä¸ä¼šé‚£ä¹ˆæ¯ç‡¥ï¼Œä¸ºæ­¤è¿™ç¯‡æ–‡ç« å°±æ¥åšä¸€ä¸ªå…¥é—¨ç§‘æ™®ï¼Œæ–¹ä¾¿ä¸€äº›å¯¹ OpenTelemetry ä¸æ˜¯é‚£ä¹ˆç†Ÿçš„æœ‹å‹å¿«é€ŸæŒæ¡ä¸€äº› OpenTelemetry çš„åŸºæœ¬æ¦‚å¿µã€‚</p><span id="more"></span><hr><h2 id="å†å²å‘å±•"><a href="#å†å²å‘å±•" class="headerlink" title="å†å²å‘å±•"></a>å†å²å‘å±•</h2><p>æ—©åœ¨ <code>OpenTelemetry</code> è¯ç”Ÿä¹‹å‰å¯è§‚æµ‹æ€§è¿™ä¸ªæ¦‚å¿µå°±ä¸€ç›´å­˜åœ¨äº†ï¼Œæˆ‘è®°å¾—æˆ‘æœ€æ—©æ¥è§¦åˆ°è¿™ä¸ªæ¦‚å¿µæ˜¯åœ¨ 16 å¹´å½“æ—¶çš„å…¬å¸æ‰€ä½¿ç”¨çš„ä¸€ä¸ªäº§å“ï¼š<a href="https://github.com/pinpoint-apm/pinpoint">pinpoint</a></p><blockquote><p>ç°å¦‚ä»Šè¿™ä¸ªé¡¹ç›®ä¾ç„¶æ¯”è¾ƒæ´»è·ƒã€‚</p></blockquote><p><img src="https://s2.loli.net/2024/04/15/VMLhpCWUGJmqn9z.png"><br>ä¾ç„¶è¿˜è®°å¾—å½“æ—¶é€šè¿‡å®ƒå¯ä»¥ç›´æ¥çœ‹åˆ°é¡¹ç›®è°ƒç”¨çš„æ‹“æ‰‘å›¾ï¼Œåœ¨æ—¶é—´åæ ‡ä¸Šæ¡†å‡ºé«˜å»¶è¿Ÿçš„ç‚¹å°±èƒ½åˆ—å‡ºè¿™äº›è¯·æ±‚ï¼ŒåŒæ—¶è¿˜èƒ½æŸ¥çœ‹æ­¤æ—¶çš„è¿è¡Œæ—¥å¿—ã€‚</p><p>è¿™æ ·å¼ºå¤§çš„åŠŸèƒ½å¯¹äºä¸€ä¸ªåˆšå·¥ä½œä¸€å¹´çš„å°ç™½æ¥è¯´å†²å‡»åŠ›å®å±å¤ªå¤§äº†ä¸€ç‚¹ã€‚</p><p>åæ¥æ‰äº†è§£åˆ° pinpoint å±äº APM è¿™ç±»äº§å“ï¼Œç±»ä¼¼çš„äº§å“è¿˜æœ‰ï¼š</p><ul><li>Apache SkyWalking</li><li>ç¾å›¢çš„ CAT ç­‰</li></ul><p>ä»–ä»¬éƒ½æ˜¯å¯ä»¥ç”¨äºæ€§èƒ½åˆ†æå’Œé“¾è·¯è¿½è¸ªçš„äº§å“ï¼Œåˆ°åæ¥å…¬å¸çš„è¿ç»´å±‚é¢ä¹Ÿæ¥å…¥è¿‡ Zabbixã€open-falcon ä¹‹ç±»çš„äº§å“ï¼š<br><img src="https://s2.loli.net/2024/04/16/RwsCUSM4fxTaBj6.png"></p><p>17ä¹‹åå…¨é¢åˆ‡æ¢åˆ° spring boot æ—¶ï¼Œä¹Ÿç”¨è¿‡ç¤¾åŒºæä¾›çš„ <a href="https://github.com/codecentric/spring-boot-admin">spring-boot-admin</a> é¡¹ç›®ï¼š</p><p><img src="https://s2.loli.net/2024/04/16/Y5vprI1fsVNwjPC.png"><br>è¿™å°±æ˜¯ä¸€ä¸ªç®€å•çš„å¯ä»¥ç›‘æ§ spring boot åº”ç”¨çš„äº§å“ï¼Œç”¨äºå±•ç¤º JVM æŒ‡æ ‡ï¼Œæˆ–è€…è‡ªå·±ä¹Ÿå¯ä»¥å®šä¹‰ä¸€äº›å¥åº·æŒ‡æ ‡ã€‚</p><hr><p>å†ä¹‹åè¿›å…¥äº‘åŸç”Ÿä½“ç³»åå¯è§‚æµ‹æ€§çš„æŠ€æœ¯æ ˆç¨æœ‰å˜åŒ–ã€‚</p><p><img src="https://s2.loli.net/2024/04/16/3MsXIo7lEgnhyUZ.png"></p><p>æ—¥å¿—ä½¿ç”¨ Sidecar ä»£ç†çš„æ–¹å¼é€šè¿‡ Agent å°†æ•°æ®å†™å…¥ ElasticSearch ä¸­ã€‚<br>å…·ä½“æ—¥å¿—é‡‡é›†æ–¹å¼å¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š</p><ul><li><a href="https://juejin.cn/post/7347000319983419411">åœ¨ kubernetes ç¯å¢ƒä¸‹å¦‚ä½•é‡‡é›†æ—¥å¿—</a></li></ul><p>è€Œé“¾è·¯è¿½è¸ªåˆ™æ˜¯ä½¿ç”¨çš„ <code>skywalking</code>ï¼Œåœ¨ trace è¿™ä¸ªé¢†åŸŸ skywalking è¿˜æ˜¯éå¸¸å—å¤§å®¶å–œçˆ±çš„ã€‚</p><p>ä¸è¿‡æœ€è¿‘ä¹Ÿä» skywalking åˆ‡æ¢åˆ°äº†æˆ‘ä»¬æœ¬æ–‡æ‰€è®²åˆ°çš„ OpenTelemetryï¼Œå…·ä½“å¯ä»¥çœ‹ä¹‹å‰çš„æ–‡ç« ï¼š</p><ul><li><a href="https://crossoverjie.top/2024/04/07/ob/otel-replace-sw/">å®æˆ˜ï¼šå¦‚ä½•ä¼˜é›…çš„ä» Skywalking åˆ‡æ¢åˆ° OpenTelemetry</a></li></ul><p>æŒ‡æ ‡é‡‡é›†ä½¿ç”¨çš„æ˜¯è‡ªç„¶ä¹Ÿæ˜¯ Prometheus çš„é‚£ä¸€å¥—æŠ€æœ¯æ ˆï¼Œåªæ˜¯ Prometheus æ¢ä¸ºäº†ä¸å®ƒå®Œå…¨å…¼å®¹çš„ VictoriaMetric ç›®å‰æ˜¯ä¸ºäº†æ›´çœèµ„æºã€‚</p><p>å®¢æˆ·ç«¯ä½¿ç”¨åˆ™æ˜¯ç›´æ¥ä½¿ç”¨ Prometheus çš„åº“è¿›è¡ŒæŒ‡æ ‡æš´éœ²ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>prometheus-metrics-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>prometheus-metrics-instrumentation-jvm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>prometheus-metrics-exporter-httpserver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆé€šè¿‡é…ç½®æŠ“å–ç­–ç•¥ï¼Œç”± VictoriaMetrics çš„ <code>scrape</code> ç¨‹åºæ¥æŠ“å–æŒ‡æ ‡æœ€ç»ˆå†™å…¥åˆ°å®ƒè‡ªå·±çš„å­˜å‚¨ä¸­ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMPodScrape</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-pod-scrape</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">podMetricsEndpoints:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">scheme:</span> <span class="string">http</span>  </span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">&quot;30s&quot;</span>  </span><br><span class="line">      <span class="attr">path:</span> <span class="string">/metrics</span>  </span><br><span class="line">      <span class="attr">relabelConfigs:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]  </span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">keep</span>  </span><br><span class="line">        <span class="comment"># ç«¯å£ç›¸åŒ  </span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">keep_if_equal</span>  </span><br><span class="line">          <span class="attr">source_labels:</span> [ <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>, <span class="string">__meta_kubernetes_pod_container_port_number</span> ]  </span><br><span class="line">        <span class="comment"># è¿‡æ»¤INITå®¹å™¨  </span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">drop</span>  </span><br><span class="line">          <span class="attr">source_labels:</span> [ <span class="string">__meta_kubernetes_pod_container_init</span> ]  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]  </span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.+)</span>  </span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__metrics_path__</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]  </span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span>  </span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__address__</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1:$2</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">labelmap</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]  </span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.*)</span>  </span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]  </span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span>  </span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.*)</span>  </span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span>  </span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span>  </span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span>  </span><br><span class="line">      <span class="attr">vm_scrape_params:</span>  </span><br><span class="line">        <span class="attr">stream_parse:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="attr">namespaceSelector:</span>  </span><br><span class="line">    <span class="attr">any:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><blockquote><p>ä»¥ä¸Šæ˜¯ VM æä¾›çš„ CRD</p></blockquote><h1 id="OpenTelemetry-è¯ç”Ÿ"><a href="#OpenTelemetry-è¯ç”Ÿ" class="headerlink" title="OpenTelemetry è¯ç”Ÿ"></a>OpenTelemetry è¯ç”Ÿ</h1><p>åˆ°æ­¤é“ºå«å®Œæˆï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰å‘ç°åœ¨å¯è§‚æµ‹æ€§ä¸­å…³é”®çš„ä¸‰ä¸ªéƒ¨åˆ†ï¼šæ—¥å¿—ã€æŒ‡æ ‡ã€trace éƒ½æ˜¯ä½¿ç”¨ä¸åŒçš„å¼€æºäº§å“ï¼Œä»è€Œä¼šå¯¼è‡´æŠ€æœ¯æ ˆè¾ƒå¤šï¼Œç»´æŠ¤èµ·æ¥è‡ªç„¶ä¹Ÿæ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚</p><p>è¿™ä¹ˆä¸€ä¸ªè½¯ä»¶é¢†åŸŸçš„æ ¸å¿ƒèƒ½åŠ›è‡ªç„¶éœ€è¦æä¾›ä¸€ä¸ªå®Œæ•´æ–¹æ¡ˆçš„ï¼Œå°†ä»¥ä¸Šçš„ä¸åŒæŠ€æœ¯æ ˆéƒ½æ•´åˆåœ¨ä¸€èµ·ï¼Œæ›´åŠ çš„æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ã€‚</p><p>åœ¨è¿™ä¹‹å‰ä¹Ÿæœ‰ä¸¤ä¸ªç¤¾åŒºæƒ³è¦åšç±»ä¼¼çš„äº‹æƒ…ï¼š</p><ul><li>OpenTracing</li><li>OpenCensus</li></ul><p>ä¸è¿‡ä»–ä»¬å¹¶æ²¡æœ‰ç»Ÿä¸€æ•´ä¸ªå¯è§‚æµ‹é¢†åŸŸï¼Œç›´åˆ° 2019 å¹´ CNCF ç¤¾åŒºå®£å¸ƒæˆç«‹ OpenTelemetryï¼Œå¹¶ä¸”å°†ä¸Šè¿°ä¸¤ä¸ªç¤¾åŒºè¿›è¡Œåˆå¹¶å…±åŒå¼€å‘ OpenTelemetryã€‚</p><blockquote><p>èƒŒé  CNCF äº‘åŸç”Ÿç¤¾åŒºåŠ ä¸Šè®¸å¤šçŸ¥åå‚å•†çš„æ”¯æŒï¼ˆGoogleã€Amazonã€Redhat ç­‰ï¼‰ï¼Œç°åœ¨å·²ç»æ­£å¼æˆä¸º CNCF çš„é¡¶çº§é¡¹ç›®äº†ã€‚</p></blockquote><h1 id="OpenTelemetry-æ¶æ„ä»‹ç»"><a href="#OpenTelemetry-æ¶æ„ä»‹ç»" class="headerlink" title="OpenTelemetry æ¶æ„ä»‹ç»"></a>OpenTelemetry æ¶æ„ä»‹ç»</h1><p><img src="https://s2.loli.net/2024/04/16/LMUtyG2ZqRbwYr8.png"></p><p>ä½†æˆ‘ä»¬æ‰“å¼€ OpenTelemetry ç¤¾åŒºçš„ GitHub é¦–é¡µæ—¶ï¼Œä¼šçœ‹åˆ°æœ‰è®¸å¤šé¡¹ç›®ï¼›ç¬¬ä¸€ååº”åº”è¯¥æ˜¯æ¯”è¾ƒè’™çš„ï¼Œä¸‹é¢æˆ‘ä¼šç€é‡ä»‹ç»ä¸€äº›æ¯”è¾ƒé‡è¦çš„é¡¹ç›®ã€‚</p><p>åœ¨å¼€å§‹ä¹‹å‰è¿˜æ˜¯å…ˆç®€å•ä»‹ç»ä¸‹ OpenTelemetry çš„ä¸€äº›åŸºç¡€ç»„ä»¶å’Œæ¦‚å¿µï¼š<br><img src="https://s2.loli.net/2024/04/16/pHON6Z3eun4IiJv.png"></p><p>æ•´ä¸ª OpenTelemetry ç³»ç»Ÿå…¶å®å¯ä»¥ç®€å•åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>å®¢æˆ·ç«¯</li><li>OTel collector</li><li>æ•°æ®å­˜å‚¨</li></ul><p>ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å¾ˆå¥½ç†è§£ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡åº”ç”¨ï¼›å¦‚æœæ˜¯ Java åº”ç”¨åªéœ€è¦æŒ‚è½½ä¸€ä¸ª agent å°±å¯ä»¥è‡ªåŠ¨é‡‡é›†ç³»ç»Ÿçš„æŒ‡æ ‡ã€é“¾è·¯ä¿¡æ¯ã€æ—¥å¿—ç­‰ä¸Šä¼ åˆ° Collector ä¸­ã€‚</p><p>ä¹Ÿå°±æ˜¯ä¸Šå›¾çš„å·¦è¾¹éƒ¨åˆ†ã€‚</p><p>ä¹‹åå°±æ˜¯éå¸¸å…³é”®çš„ç»„ä»¶ collectorï¼Œå®ƒå¯ä»¥é€šè¿‡ OTLP åè®®æ¥æ”¶åˆšæ‰æåˆ°çš„å®¢æˆ·ç«¯ä¸Šä¼ çš„æ•°æ®ï¼Œç„¶åå†å†…éƒ¨è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆè¾“å‡ºåˆ°åç»­çš„å­˜å‚¨ç³»ç»Ÿä¸­ã€‚</p><h2 id="Collector"><a href="#Collector" class="headerlink" title="Collector"></a>Collector</h2><p><img src="https://s2.loli.net/2024/04/16/l8Jfcak9bsUCwTZ.png"></p><blockquote><p>ä¸Šå›¾æ˜¯ collector çš„æ¶æ„å›¾</p></blockquote><p>ç”±äº OpenTelemetry è®¾è®¡ä¹‹åˆå°±æ˜¯è¦åšåˆ°å‚å•†æ— å…³ï¼Œæ‰€ä»¥å®ƒå°±å¾—åšå‡ºæ›´é«˜å±‚çº§çš„è®¾è®¡ã€‚</p><p>å…³é”®ç‚¹å°±æ˜¯è¿™é‡Œçš„ Receiver å’Œ Exporter éƒ½æ˜¯æ¨¡å—åŒ–çš„è®¾è®¡ï¼Œç¬¬ä¸‰æ–¹å¼€å‘è€…å¯ä»¥åŸºäºå®ƒçš„æ ‡å‡†å¼€å‘ä¸åŒç»„ä»¶ä»è€Œå…¼å®¹ä¸åŒçš„äº§å“ã€‚</p><p>Receiverï¼šç”¨äºæ¥æ”¶å®¢æˆ·ç«¯ä¸ŠæŠ¥çš„æ•°æ®ï¼Œä¸æ­¢æ˜¯è‡ªå·± agent ä¸ŠæŠ¥çš„æ•°æ®ï¼Œä¹Ÿå¯èƒ½ä¼šæ¥è‡ªä¸åŒçš„å‚å•†ï¼Œæ¯”å¦‚ kubernetesã€Kafka ç­‰ã€‚</p><p>Exporterï¼šåŒç†ï¼Œå¯ä»¥å°† receiver æ”¶åˆ°çš„æ•°æ®è¿›è¡Œå¤„ç†ä¹‹åè¾“å‡ºåˆ°ä¸åŒçš„ç»„ä»¶ä¸­ï¼›æ¯”å¦‚ Kafka&#x2F;Pulsar&#x2F;Promethus&#x2F;Jaeger ç­‰ã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/nginxreceiver">Nginx Receiver</a>æ¥æ”¶æ¥ç€ Nginx ä¸ŠæŠ¥çš„æ•°æ®ã€‚</p><p>ä½¿ç”¨ <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/mysqlreceiver">MySQL Receiver</a>æ¥æ”¶æ¥è‡ª MySQL çš„æ•°æ®ã€‚</p><p>å½“ç„¶é€šå¸¸æˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„è¿˜æ˜¯ <a href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/receiver/otlpreceiver">OTLP Receiver</a>ï¼Œè¿™æ˜¯å®˜æ–¹çš„ OTLP åè®®çš„æ¥æ”¶å™¨ï¼Œå¯ä»¥æ¥å—å®˜æ–¹çš„ä¸€äº›æŒ‡æ ‡ï¼Œæ¯”å¦‚æˆ‘ä»¬åªä½¿ç”¨äº† Java Agent è¿›è¡Œæ•°æ®ä¸ŠæŠ¥æ—¶ã€‚<br><img src="https://s2.loli.net/2024/04/16/WP46czTSAdYqKgb.png"><br><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver">https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver</a></p><p>åœ¨è¿™é‡Œæ˜¯å¯ä»¥çœ‹åˆ°ç›®å‰æ”¯æŒçš„æ‰€æœ‰ç¬¬ä¸‰æ–¹çš„ Receiverã€‚</p><hr><p><img src="https://s2.loli.net/2024/04/16/JxyICv8wHb7paZW.png"></p><p>OpenTelemetry æ‰€æ”¯æŒçš„ Exporter ä¹Ÿå¾ˆå¤šï¼Œæ¯”å¦‚ä¸€äº›å¸¸è§çš„å­˜å‚¨ï¼š</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/clickhouseexporter">clickhouse exporter</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/elasticsearchexporter">elasticsearch exporter</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/pulsarexporter">pulsar exporter</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/prometheusexporter">prometheus exporter</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/exporter/otlphttpexporter">otlp http exporter</a></li></ul><p>Exporter çš„ä½¿ç”¨åœºæ™¯å¾ˆå¤šï¼šå¦‚æœæ˜¯æŒ‡æ ‡ç›¸å…³çš„æ•°æ®å¯ä»¥ç›´æ¥å†™å…¥ Prometheusï¼Œå¦‚æœæ˜¯æ—¥å¿—æ•°æ®ä¹Ÿå¯ä»¥ç›´æ¥å†™å…¥ ElasticSearchã€‚</p><p>å¦‚æœè¿˜æœ‰å…¶ä»–çš„ç‰¹æ®Šéœ€æ±‚ï¼ˆåˆ å‡å±æ€§ç­‰ï¼‰åˆ™å¯ä»¥å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‡ªè¡Œå¤„ç†å®Œä¹‹åå†å‘å¾€ collector è¿›è¡Œåç»­çš„å¤„ç†ã€‚</p><p>å¯èƒ½ä½ å·²ç»å‘ç°äº†ï¼Œç”±äº collector éå¸¸çš„çµæ´»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åƒæ­ç§¯æœ¨ä¸€æ ·ç»„è£…æˆ‘ä»¬çš„ receiver å’Œ exporterï¼Œå®ƒä¼šä»¥æˆ‘ä»¬é…ç½®çš„æµæ°´çº¿çš„æ–¹å¼è¿›è¡Œè°ƒç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®ç°ä»»æ„å¯å®šåˆ¶çš„å¤„ç†é€»è¾‘ã€‚</p><p>è€Œè¿™äº›æµæ°´çº¿çš„ç»„è£…å¯¹äºå®¢æˆ·ç«¯æ¥è¯´éƒ½æ˜¯é€æ˜çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ collector çš„æ›´æ”¹å®Œå…¨ä¸ä¼šå½±å“åˆ°ä¸šåŠ¡ï¼›ä¸šåŠ¡åªéœ€è¦æŒ‰ç…§ OTLP çš„æ ¼å¼ä¸ŠæŠ¥æ•°æ®å³å¯ã€‚</p><p>åœ¨ä¹‹å‰çš„ä» Skywalking åˆ‡æ¢åˆ° OpenTelemetry çš„æ–‡ç« ä¸­æœ‰äººé—®ä¸ºä»€ä¹ˆè¦åˆ‡æ¢åˆ° OpenTelemetryï¼Ÿ</p><p>ä»è¿™é‡Œä¹Ÿèƒ½çœ‹å¾—å‡ºæ¥ï¼ŒOpenTelemetry çš„çµæ´»åº¦éå¸¸é«˜ï¼Œå€ŸåŠ©äº Exporter å¯ä»¥ä»»æ„çš„æ›´æ¢åç«¯å­˜å‚¨ï¼Œæˆ–è€…å¢åŠ &#x2F;åˆ å‡ä¸€äº›ä¸éœ€è¦çš„æŒ‡æ ‡æ•°æ®ç­‰ã€‚</p><hr><p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»Ÿä¸€çš„åœ¨è¿™é‡Œè¿›è¡Œæœç´¢ï¼Œå¯ä»¥åˆ—å‡ºæ‰€æœ‰çš„ç¬¬ä¸‰æ–¹é›†æˆçš„ç»„ä»¶ï¼š<br><a href="https://opentelemetry.io/ecosystem/registry/">https://opentelemetry.io/ecosystem/registry/</a></p><p><img src="https://s2.loli.net/2024/04/16/XvOx5i9LImhDTe4.png"></p><h1 id="OpenTelemetry-é¡¹ç›®ä»‹ç»"><a href="#OpenTelemetry-é¡¹ç›®ä»‹ç»" class="headerlink" title="OpenTelemetry é¡¹ç›®ä»‹ç»"></a>OpenTelemetry é¡¹ç›®ä»‹ç»</h1><h2 id="opentelemetry-java"><a href="#opentelemetry-java" class="headerlink" title="opentelemetry-java"></a>opentelemetry-java</h2><p>ä»‹ç»å®ŒåŸºæœ¬çš„æ¦‚å¿µåï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹  OTel ç¤¾åŒºçš„ä¸€äº›ä¸»è¦å¼€æºé¡¹ç›®ã€‚<br><img src="https://s2.loli.net/2024/04/16/t3rWKEuHpTRjL7I.png"></p><p>è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä»¥åˆšæ‰çš„é‚£ä¸ªæ¶æ„å›¾ä»ä½œå¾€å³è®²èµ·ï¼Œä¹Ÿå°±æ˜¯ä¸»è¦åˆ†ä¸ºå®¢æˆ·ç«¯å’Œ collector ç«¯ã€‚</p><p><img src="https://s2.loli.net/2024/04/16/zWAVoHaZORI83js.png"><br>ç›®å‰å®˜æ–¹æ”¯æŒçš„å®¢æˆ·ç«¯è¯­è¨€å·²ç»éå¸¸é½å…¨äº†ï¼Œå¤§éƒ¨åˆ†çš„ç‰ˆæœ¬éƒ½å·²ç»æ˜¯ Stable ç¨³å®šç‰ˆï¼Œæ„å‘³ç€å¯ä»¥è¿›å…¥ç”Ÿäº§ç¯å¢ƒã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä»¥ Java å®¢æˆ·ç«¯ä¸ºä¾‹ï¼š<br><img src="https://s2.loli.net/2024/04/16/Oea2KwgZYVS8qPf.png"><br>å…¶ä¸­æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸‹ opentelemetry-java å’Œ opentelemetry-java-instrumentation è¿™ä¸¤ä¸ªé¡¹ç›®ã€‚</p><p>æˆ‘ä»¬ç”¨çš„æœ€å¤šçš„ä¼šæ˜¯ <code>opentelemetry-java-instrumentation</code>ï¼Œå®ƒä¼šç»™æˆ‘ä»¬æä¾›ä¸€ä¸ª java agent çš„ JAR åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:path/to/opentelemetry-javaagent.jar \</span><br><span class="line">     -jar myapp.jar</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åªéœ€è¦åœ¨ Java åº”ç”¨ä¸­åŠ ä¸Šè¯¥  agent å°±å¯ä»¥å®ç°æ—¥å¿—ã€æŒ‡æ ‡ã€trace çš„è‡ªåŠ¨ä¸ŠæŠ¥ã€‚</p><p>è€Œä¸”å®ƒè¿˜å®ç°äº†ä¸åŒæ¡†æ¶ã€åº“çš„æŒ‡æ ‡é‡‡é›†ä¸ traceã€‚</p><p>åœ¨è¿™é‡Œå¯ä»¥æŸ¥åˆ°æ”¯æŒçš„åº“ä¸æ¡†æ¶åˆ—è¡¨ï¼š<br><img src="https://s2.loli.net/2024/04/17/kMDcrPwxJy4oZYe.png"></p><p><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md#libraries--frameworks">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md#libraries--frameworks</a></p><blockquote><p>æ€»ä¹‹å‡ ä¹å°±æ˜¯ä½ èƒ½æƒ³åˆ°å’Œä¸èƒ½æƒ³åˆ°çš„éƒ½æ”¯æŒäº†ã€‚</p></blockquote><p>è€Œ opentelemetry-java æˆ‘ä»¬ç›´æ¥ä½¿ç”¨çš„å‡ ç‡ä¼šå°ä¸€äº›ï¼Œopentelemetry-java-instrumentation æœ¬èº«ä¹Ÿæ˜¯åŸºäºå®ƒåˆ›å»ºçš„ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ Java ç‰ˆæœ¬çš„æ ¸å¿ƒåŸºç¡€åº“ï¼Œä¸€äº›ç¤¾åŒºæ”¯æŒçš„ç»„ä»¶å°±å¯ä»¥ç§»åŠ¨åˆ° <code>instrumentation</code> è¿™ä¸ªåº“ä¸­ã€‚</p><p>æ¯”å¦‚æˆ‘åœ¨ä¸Šç¯‡æ–‡ç« ï¼š<a href="https://juejin.cn/post/7356138322367266854">ä»ä¸€ä¸ª JDK21+OpenTelemetry ä¸å…¼å®¹çš„é—®é¢˜è®²èµ·</a>ä¸­æ¶‰åŠåˆ°çš„ <code>HostResourceProvider</code> èµ„æºåŠ è½½å°±æ˜¯ä» <code>opentelemetry-java</code> ä¸­ç§»åŠ¨åˆ°äº† <code>opentelemetry-java-instrumentation</code>ã€‚</p><p>å…·ä½“å¯ä»¥å‚è€ƒï¼š<a href="https://github.com/open-telemetry/opentelemetry-java/issues/4701">https://github.com/open-telemetry/opentelemetry-java/issues/4701</a></p><h2 id="collector"><a href="#collector" class="headerlink" title="collector"></a>collector</h2><p><img src="https://s2.loli.net/2024/04/16/2MaF7IwWvg9f1TS.png"></p><p>ä¹‹åå°±æ˜¯ collector çš„ç»„ä»¶äº†ï¼Œå®ƒåŒæ ·çš„ä¹Ÿæœ‰ä¸¤ä¸ªåº“ï¼š<br><strong>OpenTelemetry Collector</strong> å’Œ <strong>OpenTelemetry Collector Contrib</strong></p><p>å…¶å®é€šè¿‡ä»–ä»¬çš„åå­—ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œä»–ä»¬çš„ä½œç”¨ä¸åˆšæ‰çš„ Java åº“ç±»ä¼¼ï¼š</p><ul><li>opentelemetry-collectorï¼šç”±å®˜æ–¹ç¤¾åŒºç»´æŠ¤ï¼Œæä¾›äº†ä¸€äº›æ ¸å¿ƒèƒ½åŠ›ï¼›æ¯”å¦‚åªåŒ…å«äº†æœ€åŸºæœ¬çš„ otlp çš„ receiver å’Œ exporterã€‚</li><li>opentelemetry-collector-contribï¼šåŒ…å«äº†å®˜æ–¹çš„ collectorï¼ŒåŒæ—¶æ›´å¤šçš„ç»´æŠ¤äº†ç¤¾åŒºæä¾›çš„å„ç§ receiver å’Œ exporterï¼›å°±å¦‚ä¸Šæ–‡æåˆ°çš„ï¼Œä¸€äº›ç¤¾åŒºç»„ä»¶ï¼ˆpulsarã€MySQLã€Kafkaï¼‰ç­‰éƒ½ç»´æŠ¤åœ¨è¿™ä¸ªä»“åº“ã€‚</li></ul><p>è€Œæˆ‘ä»¬ç”Ÿäº§ä½¿ç”¨æ—¶é€šå¸¸ä¹Ÿæ˜¯ç›´æ¥ä½¿ç”¨ opentelemetry-collector-contribï¼Œæ¯•ç«Ÿå®ƒæ‰€æ”¯æŒçš„ç¤¾åŒºç»„ä»¶æ›´å¤šã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å› ä¸º OpenTelemetry æƒ³è¦è§£å†³çš„æ˜¯æ•´ä¸ªå¯è§‚æµ‹é¢†åŸŸçš„æ‰€æœ‰éœ€æ±‚ï¼Œæ‰€ä»¥ä»“åº“éå¸¸å¤šï¼Œç¤¾åŒºä¹Ÿå¾ˆå¼€æ”¾ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ç›´æ¥å‚ä¸è´¡çŒ®ï¼Œè¿™ä¹ˆå¤š repo æ€»æœ‰ä¸€ä¸ªé€‚åˆä½ çš„ã€‚</p><p>åç»­ä¼šç»§ç»­è®²è§£å¦‚ä½•å®‰è£…ä»¥åŠé…ç½®æˆ‘ä»¬çš„ OpenTelemetryã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/pinpoint-apm/pinpoint">https://github.com/pinpoint-apm/pinpoint</a></li><li><a href="https://github.com/codecentric/spring-boot-admin">https://github.com/codecentric/spring-boot-admin</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java">https://github.com/open-telemetry/opentelemetry-java</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation">https://github.com/open-telemetry/opentelemetry-java-instrumentation</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java/issues/4701">https://github.com/open-telemetry/opentelemetry-java/issues/4701</a></li></ul><p>#Blog #OpenTelemetry </p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;ä¹‹å‰é™†ç»­å†™è¿‡ä¸€äº›å’Œ OpenTelemetry ç›¸å…³çš„æ–‡ç« ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://crossoverjie.top/2024/04/07/ob/otel-replace-sw/&quot;&gt;å®æˆ˜ï¼šå¦‚ä½•ä¼˜é›…çš„ä» Skywalking åˆ‡æ¢åˆ° OpenTelemetry&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://crossoverjie.top/2024/04/15/ob/how-to-write-otel-extensions/&quot;&gt;å®æˆ˜ï¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª OpenTelemetry Extensions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.cn/post/7356138322367266854&quot;&gt;ä»ä¸€ä¸ª JDK21+OpenTelemetry ä¸å…¼å®¹çš„é—®é¢˜è®²èµ·&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™äº›å†…å®¹çš„å‰ææ˜¯æœ€å¥½æœ‰ä¸€äº› OpenTelemetry çš„èƒŒæ™¯çŸ¥è¯†ï¼Œçœ‹èµ·æ¥å°±ä¸ä¼šé‚£ä¹ˆæ¯ç‡¥ï¼Œä¸ºæ­¤è¿™ç¯‡æ–‡ç« å°±æ¥åšä¸€ä¸ªå…¥é—¨ç§‘æ™®ï¼Œæ–¹ä¾¿ä¸€äº›å¯¹ OpenTelemetry ä¸æ˜¯é‚£ä¹ˆç†Ÿçš„æœ‹å‹å¿«é€ŸæŒæ¡ä¸€äº› OpenTelemetry çš„åŸºæœ¬æ¦‚å¿µã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>ä»ä¸€ä¸ª JDK21+OpenTelemetry ä¸å…¼å®¹çš„é—®é¢˜è®²èµ·</title>
    <link href="http://crossoverjie.top/2024/05/13/ob/jdk21+springboot+OTel+SPI/"/>
    <id>http://crossoverjie.top/2024/05/13/ob/jdk21+springboot+OTel+SPI/</id>
    <published>2024-05-13T15:31:40.000Z</published>
    <updated>2024-05-13T07:57:01.419Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å‰æ®µæ—¶é—´å…¬å¸é¢†å¯¼è®©æˆ‘æ’æŸ¥ä¸€ä¸ªå…³äºåœ¨ JDK21 ç¯å¢ƒä¸­ä½¿ç”¨ Spring Boot é…åˆä¸€ä¸ª JDK18 æ–°å¢çš„ä¸€ä¸ª SPI(<code>java.net.spi.InetAddressResolverProvider</code>) ä¸ç”Ÿæ•ˆçš„é—®é¢˜ã€‚</p><p>ä½†è¿™ä¸ªä¸ç”Ÿæ•ˆçš„å‰ç½®æ¡ä»¶æœ‰ç‚¹å¤šï¼š</p><ul><li>JDK çš„ç‰ˆæœ¬å¾—åœ¨ 18+</li><li>SpringBoot3.x</li><li>è¿˜åœ¨é¢å¤–å†é…åˆä½¿ç”¨ <code>-javaagent:opentelemetry-javaagent.jar</code> ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯ OpenTelemetry æä¾›çš„ agentã€‚</li></ul><p>æ‰ä¼šå¯¼è‡´è‡ªå®šä¹‰çš„ <code>InetAddressResolverProvider</code> æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p><span id="more"></span><hr><p>åœ¨å¤ç°è¿™ä¸ªé—®é¢˜ä¹‹å‰å…ˆç®€å•ä»‹ç»ä¸‹ <code>java.net.spi.InetAddressResolverProvider</code> è¿™ä¸ª SPIï¼›å®ƒæ˜¯åœ¨ JDK18 ä¹‹åæ‰æä¾›çš„ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨ <code>InetAddress</code> çš„å†…ç½®è§£æå™¨æ¥è§£æä¸»æœºåå’Œ IP åœ°å€ï¼Œä½†è¿™ä¸ªè§£æå™¨ä¹‹å‰æ˜¯ä¸å¯ä»¥è‡ªå®šä¹‰çš„ã€‚</p><p>åœ¨æŸäº›åœºæ™¯ä¸‹ä¼šä¸å¤ªæ–¹ä¾¿ï¼Œæ¯”å¦‚æˆ‘ä»¬éœ€è¦è¯·æ±‚ <code>order.service</code> è¿™ä¸ªåŸŸåæ—¶å¸Œæœ›å¯ä»¥è¯·æ±‚åˆ°æŸä¸€ä¸ªå…·ä½“ IP åœ°å€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±é…ç½® host ï¼Œæˆ–è€…ä½¿ç”¨æœåŠ¡å‘ç°æœºåˆ¶æ¥å®ç°ã€‚</p><p>ä½†ç°åœ¨é€šè¿‡ <code>InetAddressResolverProvider</code> å°±å¯ä»¥å®šä¹‰åœ¨è¯·æ±‚è¿™ä¸ªåŸŸåçš„æ—¶å€™è¿”å›ä¸€ä¸ªæˆ‘ä»¬é¢„æœŸçš„ IP åœ°å€ã€‚</p><p>åŒæ—¶ç”±äºå®ƒæ˜¯ä¸€ä¸ª SPIï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç¼–å†™ä¸€ä¸ªç¬¬ä¸‰æ–¹åŒ…ï¼Œä»»ä½•é¡¹ç›®ä¾èµ–å®ƒä¹‹ååœ¨å‘èµ·ç½‘ç»œè¯·æ±‚æ—¶éƒ½ä¼šæŒ‰ç…§æˆ‘ä»¬é¢„æœŸçš„ IP è¿›è¡Œè¯·æ±‚ã€‚</p><h1 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h1><p>è¦ä½¿ç”¨å®ƒä¹Ÿå¾ˆç®€å•ï¼Œä¸»è¦æ˜¯ä¸¤ä¸ªç±»ï¼š</p><ul><li><code>InetAddressResolverProvider</code>ï¼šè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿å®ƒä¹‹åé‡å†™å®ƒçš„ get å‡½æ•°è¿”å›ä¸€ä¸ª <code>InetAddressResolver</code> å¯¹è±¡</li><li><code>InetAddressResolver</code>ï¼šä¸€ä¸ªæ¥å£ï¼Œä¸»è¦æä¾›äº†ä¸¤ä¸ªå‡½æ•°ï¼›ä¸€ä¸ªç”¨äºä¼ å…¥åŸŸåè¿”å› IP åœ°å€ï¼Œå¦ä¸€ä¸ªåä¹‹ï¼šä¼ å…¥ IP åœ°å€è¿”å›åŸŸåã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAddressResolverProvider</span> <span class="keyword">extends</span> <span class="title class_">InetAddressResolverProvider</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InetAddressResolver <span class="title function_">get</span><span class="params">(Configuration configuration)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyAddressResolver</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">name</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;MyAddressResolverProvider Internet Address Resolver Provider&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAddressResolver</span> <span class="keyword">implements</span> <span class="title class_">InetAddressResolver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyAddressResolver</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=====MyAddressResolver&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Stream&lt;InetAddress&gt; <span class="title function_">lookupByName</span><span class="params">(String host, LookupPolicy lookupPolicy)</span></span><br><span class="line">            <span class="keyword">throws</span> UnknownHostException &#123;</span><br><span class="line">        <span class="keyword">if</span> (host.equals(<span class="string">&quot;fedora&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Stream.of(InetAddress.getByAddress(<span class="keyword">new</span> <span class="title class_">byte</span>[] &#123;<span class="number">127</span>, <span class="number">127</span>, <span class="number">10</span>, <span class="number">1</span>&#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Stream.of(InetAddress.getByAddress(<span class="keyword">new</span> <span class="title class_">byte</span>[] &#123;<span class="number">127</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">lookupByAddress</span><span class="params">(<span class="type">byte</span>[] addr)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;++++++&quot;</span> + addr[<span class="number">0</span>] + <span class="string">&quot; &quot;</span> + addr[<span class="number">1</span>] + <span class="string">&quot; &quot;</span> + addr[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + addr[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">return</span>  <span class="string">&quot;fedora&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">```<span class="type">java</span></span><br><span class="line"><span class="variable">addresses</span> <span class="operator">=</span> InetAddress.getAllByName(<span class="string">&quot;fedora&quot;</span>);</span><br><span class="line"><span class="comment">// output: 127 127 10 1</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ç®€å•å®ç°äº†ä¸€ä¸ªå¯¹åŸŸå fedora çš„è§£æï¼Œä¼šç›´æ¥è¿”å› <code>127.127.10.1</code>ã€‚</p><p>å¦‚æœä½¿ç”¨ IP åœ°å€è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InetAddress</span> <span class="variable">byAddress</span> <span class="operator">=</span> InetAddress.getByAddress(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">127</span>, <span class="number">127</span>, <span class="number">10</span>, <span class="number">1</span>&#125;);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;+++++&quot;</span> + byAddress.getHostName());</span><br><span class="line"><span class="comment">// output: fedora</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶è¦è¦ä½¿å¾—è¿™ä¸ª SPI ç”Ÿæ•ˆçš„å‰ææ¡ä»¶æ˜¯æˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼š<br><code>META-INF/services/java.net.spi.InetAddressResolverProvider</code><br>é‡Œé¢çš„å†…å®¹æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰ç±»çš„å…¨é™å®šåç§°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.example.demo.MyAddressResolverProvider</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¸€ä¸ªå®Œæ•´çš„ SPI å°±å®ç°å®Œæˆäº†ã€‚</p><hr><p>æ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬å°†åº”ç”¨æ‰“åŒ…ä¸ºä¸€ä¸ª jar ä¹‹åè¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar target/demo-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p>æ˜¯å¯ä»¥çœ‹åˆ°è¾“å‡ºç»“æœæ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚</p><p>ä¸€æ—¦æˆ‘ä»¬ä½¿ç”¨é…åˆä¸Š spring boot æ‰“åŒ…ä¹‹åï¼Œä¹Ÿå°±æ˜¯åŠ ä¸Šä»¥ä¸‹çš„ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œå…¶å®ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œä¹Ÿèƒ½æŒ‰ç…§é¢„æœŸè¾“å‡ºç»“æœã€‚</p><p>ä½†æˆ‘ä»¬åŠ ä¸Š OpenTelemetry çš„ agent æ—¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java  -javaagent:opentelemetry-javaagent.jar \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p>å°±ä¼šå‘ç°åœ¨æ‰§è¡Œè§£æçš„æ—¶å€™æŠ›å‡ºäº† <code>java.net.UnknownHostException</code>å¼‚å¸¸ã€‚</p><p><img src="https://s2.loli.net/2024/04/08/owZLIF7yzUpSdjn.png"><br>ä»ç»“æœæ¥çœ‹å°±æ˜¯æ²¡æœ‰è¿›å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„è§£æå™¨ã€‚</p><h1 id="SPI-åŸç†"><a href="#SPI-åŸç†" class="headerlink" title="SPI åŸç†"></a>SPI åŸç†</h1><p>åœ¨è®²æ’æŸ¥è¿‡ç¨‹ä¹‹å‰è¿˜æ˜¯è¦å…ˆé¢„ä¹ ä¸‹å…³äº Java SPI çš„åŸç†ä»¥åŠåº”ç”¨åœºæ™¯ã€‚</p><p>ä»¥å‰å†™è¿‡ä¸€ä¸ª http æ¡†æ¶ <a href="https://github.com/TogetherOS/cicada">cicada</a>ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå¯æ‹”æ’ IOC å®¹å™¨çš„åŠŸèƒ½ï¼š</p><blockquote><p>å°±æ˜¯å¯ä»¥è‡ªå®šä¹‰å®ç°è‡ªå·±çš„ IOC å®¹å™¨ï¼Œå°†è‡ªå·±å®ç°çš„ IOC å®¹å™¨æ‰“åŒ…ä¸ºä¸€ä¸ªç¬¬ä¸‰æ–¹åŒ…åŠ å…¥åˆ°ä¾èµ–ä¸­ï¼Œcicada æ¡†æ¶å°±ä¼šè‡ªåŠ¨ä½¿ç”¨è‡ªå®šä¹‰çš„ IOC å®ç°ã€‚</p></blockquote><p>è¦å®ç°è¿™ä¸ªåŠŸèƒ½æœ¬è´¨ä¸Šå°±æ˜¯è¦å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œç„¶åæ ¹æ®ä¾èµ–çš„ä¸åŒå®ç°åˆ›å»ºæ¥å£çš„å®ä¾‹å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CicadaBeanFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register into bean Factory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Object object)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get bean from bean Factory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object <span class="title function_">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get bean by class type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(Class&lt;T&gt; clazz)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * release all beans</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">releaseBean</span><span class="params">()</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–å…·ä½“çš„ç¤ºä¾‹ä»£ç æ—¶å°±åªéœ€è¦ä½¿ç”¨ JDK å†…ç½®çš„ <code>ServiceLoader</code> è¿›è¡ŒåŠ è½½å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CicadaBeanFactory <span class="title function_">getCicadaBeanFactory</span><span class="params">()</span> &#123;  </span><br><span class="line">    ServiceLoader&lt;CicadaBeanFactory&gt; cicadaBeanFactories = ServiceLoader.load(CicadaBeanFactory.class);  </span><br><span class="line">    <span class="keyword">if</span> (cicadaBeanFactories.iterator().hasNext())&#123;  </span><br><span class="line">        <span class="keyword">return</span> cicadaBeanFactories.iterator().next() ;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CicadaDefaultBean</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä¹Ÿéå¸¸çš„ç®€æ´ï¼Œå’Œåˆšæ‰æåˆ°çš„ <code>InetAddressResolverProvider</code> ä¸€æ ·æˆ‘ä»¬éœ€è¦æ–°å¢ä¸€ä¸ª <code>META-INF/services/top.crossoverjie.cicada.base.bean.CicadaBeanFactory</code> æ–‡ä»¶æ¥é…ç½®æˆ‘ä»¬çš„ç±»åç§°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasNextService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextName != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// PREFIX = META-INF/services/</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fullName</span> <span class="operator">=</span> PREFIX + service.getName();</span><br><span class="line">            <span class="keyword">if</span> (loader == <span class="literal">null</span>)</span><br><span class="line">                configs = ClassLoader.getSystemResources(fullName);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                configs = loader.getResources(fullName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">            fail(service, <span class="string">&quot;Error locating configuration files&quot;</span>, x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ((pending == <span class="literal">null</span>) || !pending.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!configs.hasMoreElements()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pending = parse(service, configs.nextElement());</span><br><span class="line">    &#125;</span><br><span class="line">    nextName = pending.next();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ ServiceLoader ç±»ä¸­ä¼šä¼šå»æŸ¥æ‰¾ <code>META-INF/services</code> çš„æ–‡ä»¶ï¼Œç„¶åè§£æå…¶ä¸­çš„å†…å®¹ä»è€Œåå°„ç”Ÿæˆå¯¹åº”çš„æ¥å£å¯¹è±¡ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå…³é”®æ˜¯é€šå¸¸æˆ‘ä»¬çš„ä»£ç éƒ½ä¼šæ‰“åŒ…ä¸ºä¸€ä¸ª JAR åŒ…ï¼Œç±»åŠ è½½å™¨éœ€è¦åŠ è½½è¿™ä¸ª  JAR åŒ…ï¼ŒåŒæ—¶éœ€è¦åœ¨è¿™ä¸ª JAR åŒ…é‡Œæ‰¾åˆ°æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„é‚£ä¸ª spi æ–‡ä»¶ï¼Œå¦‚æœè¿™é‡ŒæŸ¥ä¸åˆ°æ–‡ä»¶é‚£å°±è®¤ä¸ºæ²¡æœ‰å®šä¹‰ SPIã€‚</p><p>è¿™ä¸ªæ˜¯æœ¬æ¬¡é—®é¢˜çš„é‡ç‚¹ï¼Œä¼šåœ¨åæ–‡åˆ†æåŸå› çš„æ—¶å€™ç”¨åˆ°ã€‚</p><h1 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h1><p>å› ä¸ºé—®é¢˜å°±å‡ºç°åœ¨æ˜¯å¦ä½¿ç”¨ opentelemetry-javaagent.jar ä¸Šï¼Œæ‰€ä»¥æˆ‘éœ€è¦çŸ¥é“åœ¨ä½¿ç”¨äº† agent ä¹‹åæœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p><p>ä»åˆšæ‰çš„å¯¹ SPI çš„åŸç†åˆ†æï¼ŒåŠ ä¸Š agent å‡ºç°å¼‚å¸¸ï¼Œè¯´æ˜ç†è®ºä¸Šå°±æ˜¯æ²¡æœ‰è¯»å–åˆ°æˆ‘ä»¬é…ç½®çš„æ–‡ä»¶: <code>java.net.spi.InetAddressResolverProvider</code>ã€‚</p><p>äºæ˜¯æˆ‘ä¾¿å¼€å§‹ debugï¼Œåœ¨ ServiceLoader åŠ è½½ jar åŒ…çš„æ—¶å€™æ˜¯å¯ä»¥çœ‹åˆ°å…·ä½“ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆ <code>classLoader</code> ã€‚</p><p>è¿™æ˜¯ä¸é…ç½® agent çš„æ—¶å€™ä½¿ç”¨çš„ classLoaderï¼š<br><img src="https://s2.loli.net/2024/04/10/kgR1hOzKbnGMJUA.png"><br>ä½¿ç”¨è¿™ä¸ª loader æ˜¯å¯ä»¥é€šè¿‡æ–‡ä»¶è·¯å¾„åœ¨ jar åŒ…ä¸­æŸ¥æ‰¾åˆ°æˆ‘ä»¬é…ç½®çš„æ–‡ä»¶ã€‚</p><p>è€Œé…ç½®ä¸Š agent ä¹‹åä½¿ç”¨çš„ classLoader:<br><img src="https://s2.loli.net/2024/04/10/45sUKGr6xeVPNXA.png"><br>å´æ˜¯ä¸€ä¸ª JarLoaderï¼Œè¿™æ ·æ˜¯æ— æ³•åŠ è½½åˆ°åœ¨ springboot æ ¼å¼ä¸‹çš„é…ç½®æ–‡ä»¶çš„ï¼Œè‡³äºä¸ºä»€ä¹ˆåŠ è½½ä¸åˆ°ï¼Œé‚£å°±è¦æä¸€ä¸‹ maven æ‰“åŒ…åçš„æ–‡ä»¶ç›®å½•å’Œ spring boot æ‰“åŒ…åçš„æ–‡ä»¶ç›®å½•çš„åŒºåˆ«äº†ã€‚</p><p><img src="https://s2.loli.net/2024/04/10/ZtDCc7SvXFHmL9J.png"><br>è¿™é‡Œæˆ‘æˆªå›¾äº†åŒæ ·çš„ä¸€ä»½ä»£ç ä¸åŒçš„æ‰“åŒ…æ–¹å¼ï¼š<br>ä¸Šé¢çš„æ˜¯ä¼ ç»Ÿ mavenï¼Œä¸‹å›¾æ˜¯ spring bootï¼›å…¶å®ä¸»è¦çš„åŒºåˆ«å°±æ˜¯åœ¨ pom ä¸­ä½¿ç”¨äº†ä¸€ä¸ªæ„å»ºæ’ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>æˆ–è€…ä½¿ç”¨ <code>spring-boot</code> å‘½ä»¤å†æ¬¡æ‰“åŒ…çš„æ•ˆæœä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p></blockquote><p>ä¼šå‘ç° spring boot æ‰“åŒ…åä¼šå¤šå‡ºä¸€å±‚ <code>BOOT-INF</code> çš„æ–‡ä»¶å¤¹ï¼Œç„¶åä¼šåœ¨ <code>MANIFIST.MF</code> æ–‡ä»¶ä¸­å®šä¹‰ <code>Main-Class</code> å’Œ <code>Start-Class</code>.</p><hr><p>é€šè¿‡ä¸Šé¢çš„ debug å…¶å®ä¼šå‘ç° JarLoader åªèƒ½åœ¨åŠ è½½ maven æ‰“åŒ…åçš„æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´æ— æ³•è¯†åˆ« BOOT-INF è¿™ä¸ªç›®å½•ã€‚</p><p>æ­£å¸¸æƒ…å†µä¸‹ spring boot ä¸­ä¼šæœ‰ä¸€ä¸ªé¢å¤–çš„ <code>java.nio.file.spi.FileSystemProvider</code> å®ç°:<br><img src="https://s2.loli.net/2024/04/10/iFus4tA1KXEMYkq.png"><br>é€šè¿‡è¿™ä¸ªç±»çš„å®ç°å¯ä»¥ç›´æ¥ä» JAR åŒ…ä¸­åŠ è½½èµ„æºï¼Œæ¯”å¦‚æˆ‘ä»¬è‡ªå®šä¹‰çš„ SPI èµ„æºç­‰ã€‚</p><p>åˆæ­¥åˆ¤æ–­ä½¿ç”¨ <code>opentelemetry-javaagent.jar</code>çš„ agent ä¹‹åï¼Œå®ƒçš„ç±»åŠ è½½å™¨ä¼˜å…ˆäºäº† spring boot ï¼Œä»è€Œå¯¼è‡´åç»­çš„åŠ è½½å¤±è´¥ã€‚</p><h2 id="è¿œç¨‹-debug"><a href="#è¿œç¨‹-debug" class="headerlink" title="è¿œç¨‹ debug"></a>è¿œç¨‹ debug</h2><p>è¿™é‡Œç©¿æ’å‡ ä¸ª debug å°æŠ€å·§ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯è¿œç¨‹ debugï¼Œå› ä¸ºè¿™é‡Œæˆ‘æ˜¯éœ€è¦è°ƒè¯• javaagentï¼Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯æ— æ³•ç›´æ¥ debug çš„ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨åº”ç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -agentlib:jdwp=&quot;transport=dt_socket,server=y,suspend=y,address=5000&quot; -javaagent:opentelemetry-javaagent.jar \</span><br><span class="line">      -jar target/demo-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/04/10/D2z4krNyHAanSlC.png"></p><p>ç„¶ååœ¨ idea ä¸­é…ç½®ä¸€ä¸ª remote å¯åŠ¨ã€‚</p><blockquote><p>æ³¨æ„è¿™é‡Œçš„ç«¯å£å¾—å’Œå‘½ä»¤è¡Œä¸­çš„ä¿æŒä¸€è‡´ã€‚</p></blockquote><p>å½“åº”ç”¨å¯åŠ¨ä¹‹åä¾¿å¯ä»¥åœ¨ idea ä¸­å¯åŠ¨è¿™ä¸ª remote äº†ï¼Œè¿™æ ·ä¾¿å¯ä»¥æ­£å¸¸ debug äº†ã€‚</p><h2 id="æ¡ä»¶æ–­ç‚¹"><a href="#æ¡ä»¶æ–­ç‚¹" class="headerlink" title="æ¡ä»¶æ–­ç‚¹"></a>æ¡ä»¶æ–­ç‚¹</h2><p>ç¬¬äºŒä¸ªæ˜¯æ¡ä»¶æ–­ç‚¹ä¹Ÿéå¸¸æœ‰ç”¨ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦è°ƒè¯•ä¸€ä¸ªå…¬å…±å‡½æ•°ï¼Œè°ƒç”¨çš„åœ°æ–¹éå¸¸å¤šã€‚</p><p>è€Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒæŸä¸€ç±»è¡Œä¸ºçš„è°ƒç”¨ï¼Œæ­¤æ—¶å°±å¯ä»¥å¯¹è¿™ä¸ªå‡½æ•°ä¸­çš„å˜é‡è¿›è¡Œåˆ¤æ–­ï¼Œå½“ä»–ä»¬æ»¡è¶³æŸäº›æ¡ä»¶æ—¶å†è¿›å…¥æ–­ç‚¹ï¼Œè¿™æ ·å¯ä»¥æå¤§çš„æé«˜æˆ‘ä»¬çš„è°ƒè¯•æ•ˆç‡ï¼š<br><img src="https://s2.loli.net/2024/04/10/L9PkNyZprCql6Wd.png"></p><p>é…ç½®ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨æ–­ç‚¹ä¸Šå³é”®å°±å¯ä»¥ç¼–è¾‘æ¡ä»¶äº†ã€‚</p><h1 id="ç¤¾åŒºå’¨è¯¢"><a href="#ç¤¾åŒºå’¨è¯¢" class="headerlink" title="ç¤¾åŒºå’¨è¯¢"></a>ç¤¾åŒºå’¨è¯¢</h1><p>è™½ç„¶æˆ‘æ ¹æ®ç°è±¡åˆæ­¥å¯ä»¥çŒœæµ‹ä¸‹åŸå› ï¼Œä½†ä¾ç„¶ä¸ç¡®å®šå¦‚ä½•è°ƒæ•´æ‰èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œäºæ˜¯ä¾¿å»ç¤¾åŒºæäº†ä¸€ä¸ª <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/10921">issue</a>ã€‚</p><p><img src="https://s2.loli.net/2024/04/10/YHiIOfvxu1EUMpj.png"><br>æœ€ååœ¨ç¤¾åŒºå¤§ä½¬çš„å¸®åŠ©ä¸‹å‘ç°æˆ‘ä»¬éœ€è¦ç¦ç”¨æ‰ OpenTelemetry agent ä¸­çš„ä¸€ä¸ª resource å°±å¯ä»¥äº†ã€‚</p><p><img src="https://s2.loli.net/2024/04/10/EiX3mD9k6cwjMUf.png"><br>è¿™ä¸ª resource æ˜¯ç”± agent è§¦å‘çš„ï¼Œå®ƒä¼˜å…ˆäº spring boot ä¹‹å‰è¿›è¡Œ SPI çš„åŠ è½½ã€‚<br>ç›®çš„æ˜¯ä¸ºäº†ç»™ metric å’Œ trace æ–°å¢ä¸¤ä¸ªå±æ€§ï¼š<br><img src="https://s2.loli.net/2024/04/10/I39iXt4JfdwVn8S.png"></p><p><img src="https://s2.loli.net/2024/04/10/bH3wfUeCk4K9PJ5.png"><br>åŠ è½½çš„æ ¸å¿ƒä»£ç åœ¨è¿™é‡Œï¼Œåªè¦ç¦ç”¨æ‰ä¹‹åå°±ä¸ä¼šå†åŠ è½½äº†ã€‚</p><p>ç¦ç”¨å‰ï¼š<br><img src="https://s2.loli.net/2024/04/10/7ZIo2VaqesFXL53.png"></p><p>ç¦ç”¨åï¼š<br><img src="https://s2.loli.net/2024/04/10/k2yQBPxzMHFENjd.png"></p><p>å½“æˆ‘ä»¬ç¦ç”¨æ‰ä¹‹åå°±ä¸ä¼šå­˜åœ¨è¿™ä¸¤ä¸ªå±æ€§äº†ï¼Œä¸è¿‡æˆ‘ä»¬ç›®å‰å¹¶æ²¡æœ‰ä½¿ç”¨è¿™ä¸¤ä¸ªå±æ€§ï¼Œæ‰€ä»¥ä¸ºäº†ä½¿å¾— SPI ç”Ÿæ•ˆå°±åªæœ‰å…ˆç¦ç”¨æ‰äº†ï¼Œåç»­å†çœ‹çœ‹ç¤¾åŒºè¿˜æœ‰æ²¡æœ‰å…¶ä»–çš„æ–¹æ¡ˆã€‚</p><p>æƒ³è¦å¤ç° debug çš„å¯ä»¥åœ¨è¿™é‡Œå°è¯•ï¼š<br><a href="https://github.com/crossoverJie/demo">https://github.com/crossoverJie/demo</a></p><p>å‚è€ƒè¿æ¥ï¼š</p><ul><li><a href="https://github.com/TogetherOS/cicada">https://github.com/TogetherOS/cicada</a></li><li><a href="https://docs.spring.io/spring-boot/docs/current/maven-plugin/reference/htmlsingle/#packaging.repackage-goal">https://docs.spring.io/spring-boot/docs/current/maven-plugin/reference/htmlsingle/#packaging.repackage-goal</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/10921">https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/10921</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/instrumentation/resources/library/README.md#host">https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/instrumentation/resources/library/README.md#host</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;å‰æ®µæ—¶é—´å…¬å¸é¢†å¯¼è®©æˆ‘æ’æŸ¥ä¸€ä¸ªå…³äºåœ¨ JDK21 ç¯å¢ƒä¸­ä½¿ç”¨ Spring Boot é…åˆä¸€ä¸ª JDK18 æ–°å¢çš„ä¸€ä¸ª SPI(&lt;code&gt;java.net.spi.InetAddressResolverProvider&lt;/code&gt;) ä¸ç”Ÿæ•ˆçš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;ä½†è¿™ä¸ªä¸ç”Ÿæ•ˆçš„å‰ç½®æ¡ä»¶æœ‰ç‚¹å¤šï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;JDK çš„ç‰ˆæœ¬å¾—åœ¨ 18+&lt;/li&gt;
&lt;li&gt;SpringBoot3.x&lt;/li&gt;
&lt;li&gt;è¿˜åœ¨é¢å¤–å†é…åˆä½¿ç”¨ &lt;code&gt;-javaagent:opentelemetry-javaagent.jar&lt;/code&gt; ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯ OpenTelemetry æä¾›çš„ agentã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ‰ä¼šå¯¼è‡´è‡ªå®šä¹‰çš„ &lt;code&gt;InetAddressResolverProvider&lt;/code&gt; æ— æ³•æ­£å¸¸å·¥ä½œã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/categories/OB/OpenTelemetry/"/>
    
    
    <category term="OpenTelemetry" scheme="http://crossoverjie.top/tags/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•å¯¹ kubernetes åº”ç”¨åš e2e(ç«¯åˆ°ç«¯) æµ‹è¯•</title>
    <link href="http://crossoverjie.top/2024/05/05/ob/operator-e2e-test/"/>
    <id>http://crossoverjie.top/2024/05/05/ob/operator-e2e-test/</id>
    <published>2024-05-05T07:18:05.000Z</published>
    <updated>2024-05-05T13:13:35.451Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æœ€è¿‘åœ¨ç»™ <a href="https://github.com/open-telemetry/opentelemetry-operator/pull/2778">opentelemetry-operator</a>æäº¤ä¸€ä¸ªæ ‡ç­¾é€‰æ‹©å™¨çš„åŠŸèƒ½æ—¶ï¼Œå› ä¸ºå½“æ—¶ä¿®æ”¹çš„å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œæ— æ³•æ·»åŠ å•æµ‹å‡½æ•°ï¼Œæ‰€ä»¥ç¤¾åŒºå»ºè®®æˆ‘è¡¥å……ä¸€ä¸ª <code>e2e test</code>.</p><blockquote><p>å› ä¸ºåœ¨å½“å‰çš„ç‰ˆæœ¬ä¸‹ï¼Œåªè¦ç»™ deployment æ‰“ä¸Šäº† <code>instrumentation.opentelemetry.io/inject-java: &quot;true&quot;</code> è¿™ç±»æ³¨è§£å°±ä¼šç»™è¯¥ deployment æ³¨å…¥ agentã€‚<br>ä½†æ²¡åŠæ³•æŒ‡å®šä¸åŒçš„ agent ç‰ˆæœ¬ï¼ˆæˆ–è€…ä¸åŒçš„ç¯å¢ƒå˜é‡ï¼‰ï¼Œæ‰€ä»¥å¸Œæœ›å¯ä»¥æ–°å¢ä¸€ä¸ªé€‰æ‹©å™¨ï¼ŒåŒæ—¶å¯ä»¥é’ˆå¯¹ä¸åŒçš„ deployment ç»´æŠ¤ä¸åŒç‰ˆæœ¬çš„ <code>Instrumentation</code>(æ˜¯ç”¨äºæ§åˆ¶éœ€è¦æ³¨å…¥ deployment çš„èµ„æº)ï¼›è¿™æ ·å°±å¯ä»¥çµæ´»æ§åˆ¶äº†ã€‚</p></blockquote><span id="more"></span><p><img src="https://s2.loli.net/2024/03/26/8QEaeXC9YwJp56m.png"></p><p>åœ¨è¿™ä¹‹å‰æˆ‘å…¶å®ä¹Ÿå¾ˆå°‘åš kubernetes çš„ operator å¼€å‘ï¼Œå¯¹å¦‚ä½•åš kubernetes çš„ e2e æµ‹è¯•ä¹Ÿæ¯”è¾ƒé™Œç”Ÿï¼Œå¥½åœ¨ç¤¾åŒºæä¾›äº†è¯¦ç»†çš„è´¡çŒ®æ–‡æ¡£ã€‚</p><p><img src="https://s2.loli.net/2024/03/26/Fv6SCofEtubZjcH.png"></p><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>ç®€å•æ¥è¯´éœ€è¦ä¸¤ä¸ªå…³é”®ç»„ä»¶ï¼š</p><ul><li><a href="https://kind.sigs.k8s.io/">kind</a>: kubernetes in dockerï¼Œæ˜¯å¯ä»¥åœ¨æœ¬åœ°åˆ©ç”¨ docker å¯åŠ¨ä¸€ä¸ª kubernetes é›†ç¾¤çš„å·¥å…·ï¼Œé€šå¸¸ç”¨äºåœ¨æœ¬åœ°è¿›è¡Œå¼€å‘ã€æµ‹è¯•å…³äº kubernetes ç›¸å…³çš„åŠŸèƒ½ã€‚<ul><li>å®‰è£… kind çš„å‰ææ˜¯æœ¬åœ°å·²ç»å®‰è£…å¥½äº† dockerã€‚</li></ul></li><li><a href="https://kyverno.github.io/chainsaw/latest/">chainsaw</a>: ä¸€ä¸ª e2e æµ‹è¯•æ¡†æ¶ï¼Œæä¾›äº†å£°æ˜å¼çš„æ–¹å¼å®šä¹‰æµ‹è¯•ç”¨ä¾‹ï¼Œä¹Ÿæœ‰ç€ä¸°å¯Œæ–­è¨€åŠŸèƒ½ã€‚</li></ul><p>ä»–ä»¬çš„å®‰è£…éƒ½å¾ˆç®€å•ï¼Œåªè¦æœ¬åœ°å®‰è£…å¥½äº† golangï¼Œç›´æ¥ä½¿ç”¨ go install å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go install sigs.k8s.io/kind@v0.22.0</span><br><span class="line">go install github.com/kyverno/chainsaw@latest</span><br></pre></td></tr></table></figure><h2 id="kind-ä½¿ç”¨"><a href="#kind-ä½¿ç”¨" class="headerlink" title="kind ä½¿ç”¨"></a>kind ä½¿ç”¨</h2><p>åœ¨å¼€å§‹å‰è¿˜æ˜¯å…ˆé¢„ä¹ ä¸‹ kind çš„åŸºæœ¬ä½¿ç”¨ã€‚</p><p>å®‰è£…å¥½ kind ä¹‹åï¼Œä½¿ç”¨ create cluster å‘½ä»¤å¯ä»¥åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ª <code>kubernetes</code> é›†ç¾¤ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kind create cluster -h</span><br><span class="line">Creates a local Kubernetes cluster using Docker container &#x27;nodes&#x27;</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  kind create cluster [flags]</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/03/27/znDfd3m5HeyrXi4.png"><br>ä¹‹ååªéœ€è¦ç­‰å¾…é›†ç¾¤å®‰è£…æˆåŠŸå³å¯ï¼Œå®ƒä¼šåœ¨æˆ‘ä»¬çš„ <code>cat ~/.kube/config</code> æ–‡ä»¶ä¸­è¿½åŠ åˆšæ‰æ–°å»ºé›†ç¾¤çš„è¿æ¥ä¿¡æ¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k config get-contexts</span><br><span class="line">k config use-context xxx</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹å’Œåˆ‡æ¢ä¸åŒçš„é›†ç¾¤äº†ï¼Œè™½è¯´æ˜¯ä¸€ä¸ªæœ¬åœ°æ¨¡æ‹Ÿçš„ kubernetes é›†ç¾¤ï¼Œä½†ä»–çš„æ ¸å¿ƒåŠŸèƒ½å’Œä¸€ä¸ªæ ‡å‡†çš„é›†ç¾¤æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kind delete clusters --all</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å®Œæˆä¹‹åå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤å°†æ‰€æœ‰é›†ç¾¤éƒ½åˆ é™¤æ‰ã€‚</p><h1 id="å‡†å¤‡é›†ç¾¤æ•°æ®"><a href="#å‡†å¤‡é›†ç¾¤æ•°æ®" class="headerlink" title="å‡†å¤‡é›†ç¾¤æ•°æ®"></a>å‡†å¤‡é›†ç¾¤æ•°æ®</h1><p>åœ¨ <code>opentelemetry-operator</code> ä¸­æœ‰ç»™æˆ‘ä»¬å‡†å¤‡å¥½ä¸€ä¸ª make å‘½ä»¤: <code>make prepare-e2e</code> ï¼›ä½¿ç”¨å®ƒä¼šå¸®æˆ‘ä»¬å°† operator çš„æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å¥½ã€‚</p><p>å¤§æ¦‚åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p><ul><li>å®‰è£… chainsaw</li><li>ä¿®æ”¹ controller çš„é•œåƒä¸ºæˆ‘ä»¬æœ¬åœ°æ„å»ºçš„é•œåƒåç§°</li><li>æœ¬åœ° docker é•œåƒæ‰“åŒ…</li><li>å®‰è£… cert-manager</li><li>å®‰è£… Operator éœ€è¦çš„ CRD</li><li>éƒ¨ç½² Operator deployment</li><li>ç­‰å¾… Operator å¯åŠ¨æˆåŠŸ</li></ul><p>ä¸è¿‡è¿™é‡Œçš„å®‰è£…è¿‡ç¨‹å¯èƒ½ä¼šé‡åˆ°é—®é¢˜ï¼ˆæœ¬è´¨ä¸Šéƒ½æ˜¯æˆ‘ä»¬çš„ç½‘ç»œé—®é¢˜ï¼‰ï¼š<br><img src="https://s2.loli.net/2024/03/25/bYWdfOv9B27c8RE.png"><br><img src="https://s2.loli.net/2024/03/25/kH4b7I3UlngzENA.png"><br>è¿™ç§æƒ…å†µå¯ä»¥æƒ³åŠæ³•ï¼ˆç§‘å­¦ä¸Šç½‘ï¼‰æ‰‹åŠ¨å…ˆæŠŠé•œåƒæ‹‰å–åˆ°æœ¬åœ°ï¼Œç„¶å kubernetes å°±ä¼šä»æœ¬åœ°ä»“åº“è·å–åˆ°è¿™ä¸ªé•œåƒã€‚</p><h1 id="e2e-test"><a href="#e2e-test" class="headerlink" title="e2e test"></a>e2e test</h1><p>é€šå¸¸æˆ‘ä»¬éœ€è¦å°†åŒä¸€ç±»çš„æµ‹è¯•åŠŸèƒ½æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œï¼Œæ¯”å¦‚è¿™æ ·ï¼š<br><img src="https://s2.loli.net/2024/03/27/eh8Rk4uFfWTHtna.png"><br>é»˜è®¤æƒ…å†µä¸‹ Chainsaw ä¼šæŸ¥æ‰¾ç›®å½•ä¸‹åä¸º <code>chainsaw-test.yaml</code> ä½œä¸ºå¼•å¯¼æ–‡ä»¶ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">chainsaw.kyverno.io/v1alpha1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Test</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">instrumentation-java</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">steps:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">step-00</span>  </span><br><span class="line">    <span class="attr">try:</span>   </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">command:</span>  </span><br><span class="line">        <span class="attr">entrypoint:</span> <span class="string">kubectl</span>  </span><br><span class="line">        <span class="attr">args:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">annotate</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">namespace</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">$&#123;NAMESPACE&#125;</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">openshift.io/sa.scc.uid-range=1000/1000</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">--overwrite</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">command:</span>  </span><br><span class="line">        <span class="attr">entrypoint:</span> <span class="string">kubectl</span>  </span><br><span class="line">        <span class="attr">args:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">annotate</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">namespace</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">$&#123;NAMESPACE&#125;</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">openshift.io/sa.scc.supplemental-groups=3000/3000</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">--overwrite</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apply:</span>  </span><br><span class="line">        <span class="attr">file:</span> <span class="number">00</span><span class="string">-install-collector.yaml</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apply:</span>  </span><br><span class="line">        <span class="attr">file:</span> <span class="number">00</span><span class="string">-install-instrumentation-select.yaml</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">step-01</span>  </span><br><span class="line">    <span class="attr">try:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apply:</span>  </span><br><span class="line">        <span class="attr">file:</span> <span class="number">01</span><span class="string">-install-app-select.yaml</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">assert:</span>  </span><br><span class="line">        <span class="attr">file:</span> <span class="number">01</span><span class="string">-assert*.yaml</span>  </span><br><span class="line">    <span class="attr">catch:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">podLogs:</span>  </span><br><span class="line">          <span class="attr">selector:</span> <span class="string">app=my-java-select</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tests/e2e-instrumentation/instrumentation-select</span><br><span class="line">â”œâ”€â”€ 00-install-collector.yaml</span><br><span class="line">â”œâ”€â”€ 00-install-instrumentation-select.yaml</span><br><span class="line">â”œâ”€â”€ 01-assert-select.yaml</span><br><span class="line">â”œâ”€â”€ 01-assert-without-select.yaml</span><br><span class="line">â”œâ”€â”€ 01-install-app-select.yaml</span><br><span class="line">â””â”€â”€ chainsaw-test.yaml</span><br></pre></td></tr></table></figure><p>ä»¥æˆ‘è¿™é‡Œçš„è¿™ä»½æ–‡ä»¶ä¸ºä¾‹ï¼Œåœ¨å…¶ä¸­å®šä¹‰äº†å‡ ä¸ªæ­¥éª¤ï¼š</p><ul><li>åˆå§‹åŒ–ç¯å¢ƒä¿¡æ¯ï¼ŒåŒ…å«åˆ›å»º namespace</li><li>å®‰è£…æˆ‘ä»¬æµ‹è¯•æ‰€éœ€è¦çš„èµ„æº<ul><li>00-install-collector.yamlï¼šè¿™é‡Œä¸»è¦æ˜¯å®‰è£…ä¸€ä¸ª OpenTelemetry çš„ collector</li><li>00-install-instrumentation-select.yamlï¼šå®‰è£… Instrumentation æ³¨å…¥èµ„æº</li><li>01-install-app-select.yamlï¼šåº”ç”¨ä¸€ä¸ªæˆ‘ä»¬éœ€è¦æµ‹è¯•çš„ deployment èµ„æº</li><li><code>01-assert*.yaml</code>ï¼šæœ€åå¯¹æœ€ç»ˆç”Ÿæˆçš„ yaml èµ„æºä¸ assert*.yaml çš„è¿›è¡Œæ–­è¨€åŒ¹é…ï¼Œåªæœ‰åŒ¹é…æˆåŠŸåæ‰èƒ½æµ‹è¯•æˆåŠŸã€‚</li></ul></li></ul><blockquote><p>è¿™é‡Œçš„æµ‹è¯•ç›®çš„ä¸»è¦æ˜¯å®Œæˆä¸€ä¸ªå®Œæ•´çš„ Java åº”ç”¨çš„ deployment æ³¨å…¥ OpenTelemetry çš„ agent è¿‡ç¨‹è¿˜æœ‰ä¸€äº›ä¸ OpenTelemetry ç›¸å…³çš„ç¯å¢ƒå˜é‡ã€‚</p></blockquote><p>ä»¥ <code>00-install-instrumentation-select.yaml</code> æ–‡ä»¶ä¸ºä¾‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Instrumentation</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-select</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">matchLabels:</span>  </span><br><span class="line">      <span class="attr">app:</span> <span class="string">my-java-select</span>  </span><br><span class="line">  <span class="attr">env:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_EXPORTER</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">otlp</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">http://localhost:4317</span>  </span><br><span class="line">  <span class="attr">exporter:</span>  </span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">http://localhost:4317</span>  </span><br><span class="line">  <span class="attr">propagators:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="string">jaeger</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="string">b3</span>  </span><br><span class="line">  <span class="attr">sampler:</span>  </span><br><span class="line">    <span class="attr">type:</span> <span class="string">parentbased_traceidratio</span>  </span><br><span class="line">    <span class="attr">argument:</span> <span class="string">&quot;0.25&quot;</span>  </span><br><span class="line">  <span class="attr">java:</span>  </span><br><span class="line">    <span class="attr">env:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_JAVAAGENT_DEBUG</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;true&quot;</span>  </span><br></pre></td></tr></table></figure><p>å®ƒçš„é¢„æœŸæ•ˆæœæ˜¯é€‰æ‹© <code>app: my-java-select</code> çš„ deployment å°†è¿™äº›ç¯å¢ƒå˜é‡éƒ½æ³¨å…¥è¿›å»ï¼ŒåŒæ—¶é»˜è®¤ä¹Ÿä¼šåœ¨ deployment çš„å®¹å™¨ä¸­æŒ‚è½½ä¸€ä¸ª <code>javaagent.jar</code>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /otel-auto-instrumentation-java/</span><br><span class="line">javaagent.jar</span><br></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬çš„ <code>01-assert-select.yaml</code>:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">annotations:</span>  </span><br><span class="line">    <span class="attr">instrumentation.opentelemetry.io/inject-java:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">    <span class="attr">sidecar.opentelemetry.io/inject:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-java-select</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">containers:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">env:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_JAVAAGENT_DEBUG</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;true&quot;</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_TOOL_OPTIONS</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">&#x27; -javaagent:/otel-auto-instrumentation-java/javaagent.jar&#x27;</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_EXPORTER</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">otlp</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">http://localhost:4317</span>    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_SAMPLER</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">parentbased_traceidratio</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_SERVICE_NAME</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">my-java-select</span>   </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_PROPAGATORS</span>  </span><br><span class="line">      <span class="attr">value:</span> <span class="string">jaeger,b3</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_RESOURCE_ATTRIBUTES</span>  </span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="string">--config=env:OTEL_CONFIG</span>  </span><br><span class="line">    <span class="attr">name:</span> <span class="string">otc-container</span>  </span><br><span class="line">  <span class="attr">initContainers:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opentelemetry-auto-instrumentation-java</span>  </span><br><span class="line"><span class="attr">status:</span>  </span><br><span class="line">  <span class="attr">containerStatuses:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span>  </span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span>  </span><br><span class="line">    <span class="attr">started:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="attr">initContainerStatuses:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opentelemetry-auto-instrumentation-java</span>  </span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Running</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå°±æ˜¯æŠŠå®é™…çš„ <code>deployment</code> çš„ yaml å†…å®¹å’Œè¿™ä»½æ–‡ä»¶è¿›è¡Œå¯¹æ¯”ã€‚</p><p>æ‰€ä»¥è¿™ä¸ª e2e æµ‹è¯•å°±æœ‰ç‚¹ç±»ä¼¼äºé›†æˆæµ‹è¯•ï¼Œä¸ä¼šæµ‹è¯•å…·ä½“çš„åŠŸèƒ½å‡½æ•°ï¼Œåªéœ€è¦æœ€ç»ˆç»“æœèƒ½åŒ¹é…å°±å¯ä»¥ã€‚</p><blockquote><p>å½“ç„¶è¿™ä¸ªå’Œå•å…ƒæµ‹è¯•ä¹Ÿæ˜¯ç›¸è¾…ç›¸æˆçš„ï¼Œç¼ºä¸€ä¸å¯ï¼Œä¸èƒ½å®Œå…¨åªä¾èµ– e2e æµ‹è¯•ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ¦‚ç‡åŸå› å¯¼è‡´æœ€ç»ˆç”Ÿæˆçš„èµ„æºç›¸åŒï¼›å•å…ƒæµ‹è¯•å¯ä»¥ä¿è¯å‡½æ•°åŠŸèƒ½ä¸é¢„æœŸç›¸åŒã€‚</p></blockquote><hr><p>éƒ½å‡†å¤‡å¥½ä¹‹åä¾¿å¯ä»¥è¿›è¡Œæµ‹è¯•äº†ï¼Œæµ‹è¯•çš„æ—¶å€™ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chainsaw test --test-dir ./tests/e2e-multi-instrumentation</span><br></pre></td></tr></table></figure><p>è¿™æ ·å®ƒå°±ä¼šéå†è¯¥ç›®å½•ä¸‹çš„ <code>chainsaw-test.yaml</code>æ–‡ä»¶è¿›è¡Œæµ‹è¯•ï¼Œæ‰§è¡Œæˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„é‚£äº›æ­¥éª¤ï¼Œæœ€ç»ˆè¾“å‡ºæµ‹è¯•ç»“æœï¼š</p><p><img src="https://s2.loli.net/2024/03/27/VBwbKLdGjIXODrF.png"></p><p>åŒæ—¶ Chainsaw ä¹Ÿæä¾›äº† Github actionï¼Œå¯ä»¥æ–¹ä¾¿çš„è®©æˆ‘ä»¬å’Œ github CI è¿›è¡Œé›†æˆã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">example:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">permissions:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Chainsaw</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Chainsaw</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">kyverno/action-install-chainsaw@v0.1.0</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">release:</span> <span class="string">v0.0.9</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">install</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">chainsaw</span> <span class="string">version</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ github ä¸­æŸ¥çœ‹æˆ‘ä»¬çš„æµ‹è¯•ç»“æœäº†ï¼š<br><img src="https://s2.loli.net/2024/03/27/MaoL7EBmOZfsHd9.png"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ€åä¸å¾—ä¸æ„Ÿå¹ä½œä¸º CNCF ä¸‹é¢çš„é¡¹ç›® OpenTelemetry çš„å¼€å‘è€…ä½“éªŒçœŸå¥½ï¼Œåªè¦æˆ‘ä»¬è·Ÿç€<a href="https://github.com/open-telemetry/opentelemetry-operator/blob/main/CONTRIBUTING.md">è´¡çŒ®è€…æ–‡æ¡£</a>ä¸€æ­¥æ­¥æ“ä½œéƒ½èƒ½é¡ºåˆ©é€šè¿‡ CI æµ‹è¯•ï¼ŒåŒæ—¶è¿˜èƒ½é¿å…ä¸€äº› Code Review è¿‡ç¨‹ä¸­çš„ä½çº§é”™è¯¯ã€‚</p><p><img src="https://s2.loli.net/2024/03/27/kQGfWAhYHiyNXUq.png"><br>æ¯”å¦‚æˆ‘ç¬¬ä¸€æ¬¡æ PR çš„æ—¶å€™æ²¡æœ‰æ·»åŠ  changlog æ–‡ä»¶ï¼Œåé¢åœ¨è´¡çŒ®è€…æ‰‹å†Œé‡Œå‘ç°åªéœ€è¦æ‰§è¡Œ <code>make chlog-new</code> å°±ä¼šåŸºäºå½“å‰åˆ†æ”¯ä¿¡æ¯å¸®æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ª changelog æ–‡ä»¶æ¨¡æ¿ï¼Œç„¶ååªéœ€è¦å¾€é‡Œé¢å¡«å†™å†…å®¹å³å¯ã€‚</p><p>è¿™äº›å·¥å…·é“¾è®©ä¸åŒå¼€å‘è€…æäº¤çš„ä»£ç å’Œæµç¨‹éƒ½ç¬¦åˆè§„èŒƒï¼ŒåŒæ—¶ä¹Ÿé™ä½äº†è´¡çŒ®éš¾åº¦ã€‚</p><p>ä»¥ä¸Šæ‰€æœ‰çš„ç›¸å…³æºç éƒ½å¯ä»¥åœ¨ <a href="https://github.com/open-telemetry/opentelemetry-operator">https://github.com/open-telemetry/opentelemetry-operator</a> ä¸­è¿›è¡ŒæŸ¥çœ‹ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-operator/pull/2778">https://github.com/open-telemetry/opentelemetry-operator/pull/2778</a></li><li><a href="https://kind.sigs.k8s.io/">https://kind.sigs.k8s.io/</a></li><li><a href="https://kyverno.github.io/chainsaw/latest/">https://kyverno.github.io/chainsaw/latest/</a></li><li><a href="https://github.com/open-telemetry/opentelemetry-operator/blob/main/CONTRIBUTING.md">https://github.com/open-telemetry/opentelemetry-operator/blob/main/CONTRIBUTING.md</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;æœ€è¿‘åœ¨ç»™ &lt;a href=&quot;https://github.com/open-telemetry/opentelemetry-operator/pull/2778&quot;&gt;opentelemetry-operator&lt;/a&gt;æäº¤ä¸€ä¸ªæ ‡ç­¾é€‰æ‹©å™¨çš„åŠŸèƒ½æ—¶ï¼Œå› ä¸ºå½“æ—¶ä¿®æ”¹çš„å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œæ— æ³•æ·»åŠ å•æµ‹å‡½æ•°ï¼Œæ‰€ä»¥ç¤¾åŒºå»ºè®®æˆ‘è¡¥å……ä¸€ä¸ª &lt;code&gt;e2e test&lt;/code&gt;.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å› ä¸ºåœ¨å½“å‰çš„ç‰ˆæœ¬ä¸‹ï¼Œåªè¦ç»™ deployment æ‰“ä¸Šäº† &lt;code&gt;instrumentation.opentelemetry.io/inject-java: &amp;quot;true&amp;quot;&lt;/code&gt; è¿™ç±»æ³¨è§£å°±ä¼šç»™è¯¥ deployment æ³¨å…¥ agentã€‚&lt;br&gt;ä½†æ²¡åŠæ³•æŒ‡å®šä¸åŒçš„ agent ç‰ˆæœ¬ï¼ˆæˆ–è€…ä¸åŒçš„ç¯å¢ƒå˜é‡ï¼‰ï¼Œæ‰€ä»¥å¸Œæœ›å¯ä»¥æ–°å¢ä¸€ä¸ªé€‰æ‹©å™¨ï¼ŒåŒæ—¶å¯ä»¥é’ˆå¯¹ä¸åŒçš„ deployment ç»´æŠ¤ä¸åŒç‰ˆæœ¬çš„ &lt;code&gt;Instrumentation&lt;/code&gt;(æ˜¯ç”¨äºæ§åˆ¶éœ€è¦æ³¨å…¥ deployment çš„èµ„æº)ï¼›è¿™æ ·å°±å¯ä»¥çµæ´»æ§åˆ¶äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="k8s" scheme="http://crossoverjie.top/tags/k8s/"/>
    
    <category term="operator" scheme="http://crossoverjie.top/tags/operator/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ¬¡æ¶ˆæ¯é˜Ÿåˆ—å¼‚å¸¸å †ç§¯çš„æ’æŸ¥</title>
    <link href="http://crossoverjie.top/2024/04/29/ob/pulsar-slow-consume/"/>
    <id>http://crossoverjie.top/2024/04/29/ob/pulsar-slow-consume/</id>
    <published>2024-04-29T07:47:10.000Z</published>
    <updated>2024-04-29T02:24:24.167Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å‰ä¸¤å¤©æ”¶åˆ°ä¸šåŠ¡åé¦ˆæœ‰ä¸€ä¸ª topic çš„åˆ†åŒºæ¶ˆæ¯å †ç§¯äº†ï¼š<br><img src="https://s2.loli.net/2024/03/24/Ckb3MRswVAvjXfn.png"><br>æ ¹æ®ä¹‹å‰çš„ç»éªŒæ¥çœ‹ï¼Œè¦ä¹ˆæ˜¯ä¸šåŠ¡æ¶ˆè´¹é€»è¾‘å‡ºç°é—®é¢˜å¯¼è‡´æ¶ˆè´¹è¿‡æ…¢ï¼Œå½“ç„¶ä¹Ÿæœ‰å°æ¦‚ç‡æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ Bugï¼ˆæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ pulsarï¼‰ã€‚</p><span id="more"></span><h1 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h1><p><img src="https://s2.loli.net/2024/03/24/6TBk2Jo9sWZpRGe.png"><br>é€šè¿‡æ’æŸ¥ï¼Œå‘ç°ç¡®å®æ˜¯åœ¨ä¸€ç‚¹å¤šçš„æ—¶å€™æ¶ˆæ¯å †ç§¯äº†ï¼ˆåé¢æ˜¯ä¿®å¤ä¹‹åå †ç§¯å¼€å§‹ä¸‹é™ï¼‰ã€‚</p><p>äºæ˜¯æˆ‘åœ¨åˆšæ‰å †ç§¯å¤„æŸ¥çœ‹äº†ä¸€æ¡å †ç§¯æ¶ˆæ¯çš„åˆ—è¡¨ï¼š<br><img src="https://s2.loli.net/2024/03/24/UeizjIc3brVfnNy.png"></p><p>è·å–åˆ°å…¶ä¸­ä¸€æ¡æ¶ˆæ¯çš„ <code>messageId</code>.</p><blockquote><p>è¿™é‡Œæœ¬è´¨ä¸Šä½¿ç”¨çš„æ˜¯ pulsar-admin çš„ APIã€‚<br><a href="https://pulsar.apache.org/docs/3.2.x/admin-api-topics/#peek-messages"><code>org.apache.pulsar.client.admin.Topics#peekMessages</code></a></p></blockquote><p><img src="https://s2.loli.net/2024/03/24/IEGwRWphsFf6xk2.png"><br>å†é€šè¿‡è¿™æ¡æ¶ˆæ¯çš„ id ï¼ˆä¸ºäº†æ¼”ç¤ºï¼Œè¿™é‡Œçš„ messageId å¯èƒ½ä¸ä¸€æ ·ï¼‰åœ¨æˆ‘ä»¬çš„ pulsar æ¶ˆæ¯é“¾è·¯ç³»ç»Ÿä¸­æ‰¾åˆ°äº†æ¶ˆæ¯çš„å‘é€é“¾è·¯ï¼š<br><img src="https://s2.loli.net/2024/03/24/CwQRAWXMu8Hxq5y.png"><br>é€šè¿‡è¿™ä¸ªé“¾è·¯ä¼šå‘ç°æ¶ˆæ¯ä¸€ç›´åœ¨æ¨é€ï¼Œä½†å°±æ˜¯æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯çš„ ACK å“åº”ã€‚</p><blockquote><p>ç›¸å…³çš„æ¶ˆæ¯é“¾è·¯åŸ‹ç‚¹å¯ä»¥å‚è€ƒè¿™é‡Œï¼š<a href="https://crossoverjie.top/2023/12/11/ob/Pulsar-Broker-Interceptor/">å¦‚ä½•ç¼–å†™ä¸€ä¸ª Pulsar Broker Interceptor æ’ä»¶</a></p></blockquote><p>ç®€å•æ¥è¯´å°±æ˜¯åœ¨ä»¥ä¸‹å‡ ä¸ª broker æä¾›çš„æ‹¦æˆªå™¨æ¥å£åŠ ä¸ŠåŸ‹ç‚¹æ•°æ®å³å¯ï¼š</p><ul><li>messageProduced</li><li>messageDispatched</li><li>messageAcked</li></ul><p>æ—¢ç„¶çŸ¥é“äº†æ˜¯å®¢æˆ·ç«¯æ²¡æœ‰å“åº” ACKï¼Œé‚£å°±å¾—çŸ¥é“å®¢æˆ·ç«¯æ­¤æ—¶åœ¨å¹²ä»€ä¹ˆã€‚</p><p>é¦–å…ˆæ’æŸ¥äº† JVM å†…å­˜ã€CPU ç­‰ç›‘æ§æƒ…å†µï¼Œå‘ç°ä¸€åˆ‡éƒ½æŒºæ­£å¸¸çš„ï¼Œè¿™æ®µæ—¶é—´æ²¡æœ‰æ˜æ˜¾çš„å°–åˆºã€‚</p><h2 id="Arthas-æ’æŸ¥"><a href="#Arthas-æ’æŸ¥" class="headerlink" title="Arthas æ’æŸ¥"></a>Arthas æ’æŸ¥</h2><p>äºæ˜¯ä¾¿å‡†å¤‡ä½¿ç”¨ arthas æŸ¥çœ‹ä¸‹çº¿ç¨‹çš„è¿è¡Œæƒ…å†µã€‚</p><p>æˆ‘ä»¬è¿›å…¥åˆ°å¯¹åº” Pod çš„å®¹å™¨ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar</span><br></pre></td></tr></table></figure><p>å› ä¸º JVM å†…å­˜éƒ½æ²¡æœ‰å•¥å¼‚å¸¸ï¼Œæ‰€ä»¥å…ˆçœ‹çœ‹ thread çš„è¿è¡Œå †æ ˆï¼Œè€ƒè™‘åˆ°æ˜¯ pulsar æ¶ˆè´¹çº¿ç¨‹å¡ä½äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ ä¸Šçº¿ç¨‹çŠ¶æ€å·²ç»è¿‡æ»¤ä¸‹çº¿ç¨‹çš„åç§°ï¼š<br><img src="https://s2.loli.net/2024/03/24/brPcepjMFKaC9d8.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread --state WAITING | grep pulsar</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±ä¼šåˆ—å‡ºå½“å‰ Java è¿›ç¨‹ä¸­çŠ¶æ€ä¸º WATING å¹¶ä¸”çº¿ç¨‹åç§°ä»¥ pulsar å¼€å¤´çš„çº¿ç¨‹ã€‚</p><blockquote><p>æˆ‘åœ¨ä¹‹å‰çš„æ–‡ç«  <a href="https://crossoverjie.top/2023/08/03/ob/Pulsar-Client/">ä» Pulsar Client çš„åŸç†åˆ°å®ƒçš„ç›‘æ§é¢æ¿</a> ä¸­åˆ†æè¿‡å®¢æˆ·ç«¯çš„åŸç†ã€‚</p></blockquote><p><img src="https://s2.loli.net/2023/08/02/vweWVR8fkJgrSMI.png" alt="20230802224400.png"><br><img src="https://s2.loli.net/2024/03/24/h7KQXueLySHYotW.png"></p><p>å¯ä»¥çŸ¥é“ pulsar å®¢æˆ·ç«¯åœ¨å…¶ä¸­ä½¿ç”¨çš„æ˜¯ <code>pulsar-</code>æ‰“å¤´çš„çº¿ç¨‹åç§°ï¼Œæ‰€ä»¥è¿™æ ·å°±åˆ—å‡ºäº†æˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„çº¿ç¨‹ã€‚</p><p>æˆ‘ä»¬ä»¥å›¾ä¸­åˆ—å‡ºçš„çº¿ç¨‹ Idï¼š320 ä¸ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread 320</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/03/24/cT1Eylp6aXd5QeZ.png"><br>æ­¤æ—¶ä¾¿ä¼šæ‰“å°å½“å‰çº¿ç¨‹çš„å †æ ˆã€‚</p><p>ä»ä¸Šè¿°å †æ ˆä¸­ä¼šå‘ç°çº¿ç¨‹ä¸€ç›´å¤„äº IO æ“ä½œä¸­ï¼Œçœ‹èµ·æ¥æ˜¯åœ¨æ“ä½œæ•°æ®åº“ã€‚</p><p>æˆ‘ä»¬å†å¾€ä¸‹ç¿»ä¸€ç¿»ï¼Œä¼šå‘ç°ä¸Šå±‚è°ƒç”¨çš„ä¸šåŠ¡ä»£ç ï¼š<br><img src="https://s2.loli.net/2024/03/24/BhFGeJ7X6DLbC1s.png"><br>æŸ¥é˜…ä»£ç å¾—çŸ¥è¿™æ˜¯ä¸€ä¸ªæ•°æ®åº“çš„å†™å…¥æ“ä½œï¼Œçœ‹èµ·æ¥æ˜¯åœ¨è¿™ä¸ªç¯èŠ‚æ•°æ®åº“å“åº”è¿‡æ…¢å¯¼è‡´çš„ pulsar çº¿ç¨‹è¢«é˜»å¡äº†ï¼›ä»è€Œå¯¼è‡´æ¶ˆæ¯æ²¡æœ‰åŠæ—¶ ACKã€‚</p><p>ä¸ºäº†æœ€ç»ˆç¡®è®¤æ˜¯å¦ç”±æ•°æ®åº“å¼•èµ·çš„ï¼Œäºæ˜¯ç»§ç»­æŸ¥è¯¢äº†å½“å‰åº”ç”¨çš„æ…¢ SQL æƒ…å†µï¼š<br><img src="https://s2.loli.net/2024/03/24/vcYDGapUVms82Jl.png"></p><p>å‘ç°å…¶ä¸­æœ‰ä¸€ä¸ªæŸ¥è¯¢è¯­å¥è°ƒç”¨é¢‘æ¬¡å’Œå¹³å‡è€—æ—¶éƒ½æ¯”è¾ƒé«˜ï¼Œè€Œä¸”æ­£å¥½è¿™ä¸ªè¡¨ä¹Ÿæ˜¯åˆšæ‰åœ¨å †æ ˆé‡Œæ“ä½œçš„é‚£å¼ è¡¨ã€‚</p><p>ç»è¿‡ä¸šåŠ¡æ’æŸ¥å‘ç°è¿™ä¸ªæ…¢ SQL æ˜¯ç”±ä¸€ä¸ªå®šæ—¶ä»»åŠ¡è§¦å‘çš„ï¼Œè€Œè¿™ä¸ªå®šæ—¶ä»»åŠ¡ç”±äºæŸäº›åŸå› ä¸€ç›´ä¹Ÿæ²¡æœ‰åœæ­¢ï¼Œæ‰€ä»¥ä¸ºäº†å¿«é€Ÿè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆå°è¯•å°†è¿™ä¸ªå®šæ—¶ä»»åŠ¡åœæ‰ã€‚</p><p>æœç„¶åœæ‰æ²¡å¤šä¹…åæ¶ˆæ¯å°±å¼€å§‹å¿«é€Ÿæ¶ˆè´¹äº†ï¼š<br><img src="https://s2.loli.net/2024/03/24/wlDtCeBZL6IjkRM.png"><br>ä»è¿™ä¸ªæ—¶é—´çº¿ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥äº†ï¼Œåœ¨æœåŠ¡ç«¯æ¨é€äº†å¤šæ¬¡ä¹‹åç»ˆäºæ”¶åˆ°äº† ACKã€‚</p><p>ä¿®å¤ä¹‹åä¸šåŠ¡å†å»æ’æŸ¥ä¼˜åŒ–è¿™ä¸ªæ…¢ SQLï¼Œè¿™æ ·è¿™ä¸ªé—®é¢˜å°±å¾—åˆ°æ ¹æœ¬çš„è§£å†³äº†ã€‚</p><h1 id="æ›´å¤šå¥½ç”¨æŠ€å·§"><a href="#æ›´å¤šå¥½ç”¨æŠ€å·§" class="headerlink" title="æ›´å¤šå¥½ç”¨æŠ€å·§"></a>æ›´å¤šå¥½ç”¨æŠ€å·§</h1><p>å½“ç„¶ arthas å¥½ç”¨çš„åŠŸèƒ½è¿˜è¿œä¸æ­¢æ­¤ï¼Œæˆ‘è§‰å¾—è¿˜æœ‰ä»¥ä¸‹åŠŸèƒ½æ¯”è¾ƒå¥½ç”¨ï¼š</p><h2 id="ç«ç„°å›¾"><a href="#ç«ç„°å›¾" class="headerlink" title="ç«ç„°å›¾"></a>ç«ç„°å›¾</h2><p>profileï¼šå¯ä»¥è¾“å‡ºç«ç„°å›¾ï¼Œåœ¨åšæ€§èƒ½åˆ†æçš„æ—¶å€™éå¸¸æœ‰ç”¨ã€‚<br><img src="https://s2.loli.net/2024/03/24/2qsjgQMCRhtxNdm.png"></p><h2 id="åŠ¨æ€ä¿®æ”¹å†…å­˜æ•°æ®"><a href="#åŠ¨æ€ä¿®æ”¹å†…å­˜æ•°æ®" class="headerlink" title="åŠ¨æ€ä¿®æ”¹å†…å­˜æ•°æ®"></a>åŠ¨æ€ä¿®æ”¹å†…å­˜æ•°æ®</h2><p>è¿˜è®°å¾—ä¹‹å‰æˆ‘ä»¬ç¢°åˆ°è¿‡ä¸€ä¸ª pulsar <a href="https://crossoverjie.top/2024/01/09/ob/Pulsar-Delete-Topic/">åˆ é™¤ topic çš„ Bug</a>ï¼Œè™½ç„¶æœ€ç»ˆä¿®å¤äº†é—®é¢˜ï¼Œä½†æ˜¯åœ¨å‘å¸ƒä¿®å¤ç‰ˆæœ¬çš„æ—¶å€™ä¸ºäº†é¿å…å†æ¬¡è§¦å‘è€ç‰ˆæœ¬çš„ bugï¼Œéœ€è¦åœ¨å†…å­˜ä¸­å°†æŸä¸ªå…³é”®å­—æ®µçš„å€¼ä¿®æ”¹æ‰ã€‚</p><p>è€Œä¸”æ˜¯ä¸èƒ½é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹ä¿®æ”¹ï¼Œæ­¤æ—¶ä½¿ç”¨ arthas å°±éå¸¸çš„æ–¹ä¾¿ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://arthas.aliyun.com/arthas-boot.jar &amp;&amp; java -jar arthas-boot.jar 1 -c &quot;vmtool -x 3 --action getInstances --className org.apache.pulsar.broker.ServiceConfiguration  --express &#x27;instances[0].setTopicLevelPoliciesEnabled(false)&#x27;&quot;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>vmtool</code> è¿™ä¸ªå­å‘½ä»¤æ¥è·å–å¯¹è±¡ï¼Œæœ€ç»ˆå†ä½¿ç”¨ <code>express</code> è¡¨è¾¾å¼å°†å…¶ä¸­çš„å€¼æ”¹ä¸ºäº† falseã€‚</p><p>å½“ç„¶è¿™æ˜¯ä¸€ä¸ªé«˜å±æ“ä½œï¼Œä¸åˆ°ä¸‡ä¸å¾—å·²ä¸æ¨èè¿™ä¹ˆä½¿ç”¨ã€‚</p><h2 id="Arthas-Tunnel-amp-Web-Console"><a href="#Arthas-Tunnel-amp-Web-Console" class="headerlink" title="Arthas Tunnel &amp; Web Console"></a>Arthas Tunnel &amp; Web Console</h2><p>è¿™æ˜¯ä¸€ä¸ªæ–¹ä¾¿å¼€å‘è€…é€šè¿‡ç½‘é¡µå°±å¯ä»¥è¿æ¥åˆ° arthas çš„åŠŸèƒ½ï¼Œé¿å…ç›´æ¥ç™»å½•åˆ°æœåŠ¡å™¨è¿›è¡Œæ“ä½œã€‚<br><img src="https://s2.loli.net/2024/03/24/d38vNUbylAhSKxP.png"><br><img src="https://s2.loli.net/2024/03/24/w8RomB4UVOyErvf.png"></p><p>æˆ‘ä»¬åœ¨ç ”æ•ˆæ™®é€šä¹Ÿå†…ç½®äº†è¯¥åŠŸèƒ½ï¼Œè®©å¼€å‘æ’æŸ¥é—®é¢˜æ›´åŠ æ–¹ä¾¿ã€‚</p><h2 id="CPU-ä½¿ç”¨è¿‡å¤š"><a href="#CPU-ä½¿ç”¨è¿‡å¤š" class="headerlink" title="CPU ä½¿ç”¨è¿‡å¤š"></a>CPU ä½¿ç”¨è¿‡å¤š</h2><p>cpu å¼‚å¸¸ä½¿ç”¨æ’æŸ¥ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›‘æ§å¾—çŸ¥ JVM çš„ cpu ä½¿ç”¨æƒ…å†µï¼Œä½†æ˜¯æ²¡æ³•çŸ¥é“å…·ä½“æ˜¯å“ªä¸ªçº¿ç¨‹ä»¥åŠå“ªè¡Œä»£ç é€ æˆçš„ cpu è¿‡é«˜ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -n 3</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/03/24/SGTLjp8uBOHtJea.png"></p><p>ä½¿ç”¨ä»¥ä¸Šå‘½ä»¤å°±å¯ä»¥å°† cpu æ’åå‰ä¸‰çš„çº¿ç¨‹æ‰“å°å‡ºæ¥ï¼Œå¹¶ä¸”åˆ—å‡ºä»–çš„å †æ ˆæƒ…å†µï¼Œè¿™æ ·å¯ä»¥å¾ˆç›´è§‚çš„å¾—çŸ¥ cpu æ¶ˆè€—äº†åœ¨å“ªäº›åœ°æ–¹äº†ã€‚</p><p>å½“ç„¶è¿˜æœ‰ä¸€äº› trace æŸ¥è¯¢ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace demo.MathGame run &#x27;#cost &gt; 10&#x27;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™æ˜¯å°†è°ƒç”¨è¶…è¿‡ 10ms çš„å‡½æ•°æ‰“å°å‡ºæ¥ï¼Œä¸è¿‡å¦‚æœæˆ‘ä»¬æ¥å…¥äº†å¯è§‚æµ‹ç³»ç»Ÿï¼ˆOpenTelemetryã€skywalkingç­‰ï¼‰è¿™ä¸ªåŠŸèƒ½å°±ç”¨ä¸å¤ªä¸Šäº†ã€‚</p><hr><p> è¿˜å¯ä»¥åœ¨è¿è¡Œçš„æ—¶å€™ä¸åœæœºä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Œè¿™ç§åœ¨çº¿ä¸Šæ’æŸ¥ä¸€äº›ç–‘éš¾æ‚ç—‡çš„æ—¶å€™éå¸¸å¥½ç”¨ï¼ˆé€šå¸¸æƒ…å†µä¸‹ debug æ—¥å¿—æ˜¯ä¸æ‰“å°çš„ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ—¥å¿—çº§åˆ«è°ƒæ•´ä¸º debug æ‰“å°å‡ºæ›´åŠ è¯¦ç»†çš„ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[arthas@2062]$ </span><span class="language-bash">logger --name ROOT --level debug</span></span><br><span class="line">update logger level success.</span><br></pre></td></tr></table></figure><hr><p>å¦‚æœæ˜¯åœ¨ kubernetes ç¯å¢ƒä¸­æ‰§è¡Œä¹Ÿæœ‰å¯èƒ½ç¢°åˆ° Java è¿›ç¨‹å¯åŠ¨åæ²¡æœ‰åœ¨ç£ç›˜ä¸­å†™å…¥ PID çš„æƒ…å†µï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java -jar arthas-boot.jar</span>  </span><br><span class="line">[INFO] arthas-boot version: 3.6.7  </span><br><span class="line">[INFO] Can not find java process. Try to pass &lt;pid&gt; in command line.  </span><br><span class="line">Please select an available pid.</span><br></pre></td></tr></table></figure><p>å¯¼è‡´ç›´æ¥è¿è¡Œçš„æ—¶å€™æ— æ³•æ‰¾åˆ° Java è¿›ç¨‹ï¼›æ­¤æ—¶å°±éœ€è¦å…ˆ ps æ‹¿åˆ° PID ä¹‹åå†ä¼ å…¥ PID è¿å…¥ arthasï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java -jar arthas-boot.jar 1</span></span><br></pre></td></tr></table></figure><p>æ›´å¤šå…³äº arthas çš„ç”¨æ³•å¯ä»¥å‚è€ƒå®˜ç½‘ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://pulsar.apache.org/docs/3.2.x/admin-api-topics/#peek-messages">https://pulsar.apache.org/docs/3.2.x/admin-api-topics/#peek-messages</a></li><li><a href="https://crossoverjie.top/2023/12/11/ob/Pulsar-Broker-Interceptor/">https://crossoverjie.top/2023/12/11/ob/Pulsar-Broker-Interceptor/</a></li><li><a href="https://arthas.aliyun.com/">https://arthas.aliyun.com/</a></li><li><a href="https://crossoverjie.top/2024/01/09/ob/Pulsar-Delete-Topic/">https://crossoverjie.top/2024/01/09/ob/Pulsar-Delete-Topic/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;å‰ä¸¤å¤©æ”¶åˆ°ä¸šåŠ¡åé¦ˆæœ‰ä¸€ä¸ª topic çš„åˆ†åŒºæ¶ˆæ¯å †ç§¯äº†ï¼š&lt;br&gt;&lt;img src=&quot;https://s2.loli.net/2024/03/24/Ckb3MRswVAvjXfn.png&quot;&gt;&lt;br&gt;æ ¹æ®ä¹‹å‰çš„ç»éªŒæ¥çœ‹ï¼Œè¦ä¹ˆæ˜¯ä¸šåŠ¡æ¶ˆè´¹é€»è¾‘å‡ºç°é—®é¢˜å¯¼è‡´æ¶ˆè´¹è¿‡æ…¢ï¼Œå½“ç„¶ä¹Ÿæœ‰å°æ¦‚ç‡æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ Bugï¼ˆæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ pulsarï¼‰ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OB" scheme="http://crossoverjie.top/categories/OB/"/>
    
    
    <category term="Pulsar" scheme="http://crossoverjie.top/tags/Pulsar/"/>
    
  </entry>
  
</feed>
